# roadmap: aws sso support for keyrack

## overview

this roadmap tracks implementation of the aws sso support blueprint. each phase has:
- ordered dependencies (must complete prior phases first)
- required reading before starting
- acceptance criteria from blackbox spec
- verification steps to confirm completion

---

## status

| phase | scope | depends on | status |
|-------|-------|------------|--------|
| 0 | domain objects | — | pending |
| 1 | grade logic | phase 0 | pending |
| 2 | vault adapter | phase 0, 1 | pending |
| 3 | mechanism adapter | phase 0 | pending |
| 4 | context wire-up | phase 0, 1, 2, 3 | pending |
| 5 | acceptance tests | phase 0, 1, 2, 3, 4 | pending |

---

## phase 0: domain objects

### required reading

- [ ] `.behavior/v2026_02_09.keyrack-aws/3.3.blueprint.v1.i1.md` — blueprint contracts section
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.claims._.v1.i1.md` — current keyrack domain

### tasks

- [ ] add `'reference'` to `KeyrackKeyGrade.protection` union
  - file: `src/domain.objects/keyrack/KeyrackKeyGrade.ts`
  - change: `protection: 'encrypted' | 'plaintext'` → `protection: 'reference' | 'encrypted' | 'plaintext'`

- [ ] add `'aws.iam.sso'` to `KeyrackHostVault` union
  - file: `src/domain.objects/keyrack/KeyrackHostVault.ts`
  - change: add `| 'aws.iam.sso'` to union

- [ ] verify type compilation
  - run: `npm run test:types`

### acceptance criteria

from usecase.5 (grade protection):
> given('AWS_PROFILE key has grade.protection = "reference"')

the `'reference'` type must be valid in the type system.

### verification

```sh
npm run test:types
# expect: no errors related to 'reference' or 'aws.iam.sso'
```

---

## phase 1: grade logic

### required reading

- [ ] `.behavior/v2026_02_09.keyrack-aws/3.3.blueprint.v1.i1.md` — grade logic section
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.code.prod.v1.i1.md` — prod code patterns
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.code.test.v1.i1.md` — test patterns

### tasks

- [ ] update `inferKeyGrade` for aws.iam.sso -> reference
  - file: `src/domain.operations/keyrack/grades/inferKeyGrade.ts`
  - change: add case `if (input.vault === 'aws.iam.sso') return 'reference' as const;`

- [ ] update `detectKeyGradeChange` protection rank
  - file: `src/domain.operations/keyrack/grades/detectKeyGradeChange.ts`
  - change: `PROTECTION_RANK = { reference: 0, encrypted: 1, plaintext: 2 }`

- [ ] add unit tests for reference protection
  - file: `src/domain.operations/keyrack/grades/inferKeyGrade.test.ts`
  - test: aws.iam.sso vault infers 'reference' protection

- [ ] add degradation tests for reference
  - file: `src/domain.operations/keyrack/grades/assertKeyGradeProtected.test.ts`
  - test: reference -> encrypted is blocked
  - test: reference -> plaintext is blocked
  - test: encrypted -> reference is allowed
  - test: plaintext -> reference is allowed

### acceptance criteria

from usecase.5 (grade protection):
```
given('AWS_PROFILE key has grade.protection = "reference"')
  when('attempt to change to grade.protection = "encrypted"')
    then('keyrack blocks the change')

  when('attempt to change to grade.protection = "plaintext"')
    then('keyrack blocks the change')

given('key has grade.protection = "encrypted"')
  when('attempt to change to grade.protection = "reference"')
    then('keyrack allows the change')
```

### verification

```sh
npm run test:unit -- inferKeyGrade
npm run test:unit -- detectKeyGradeChange
npm run test:unit -- assertKeyGradeProtected
# expect: all tests pass, including new reference protection tests
```

---

## phase 2: vault adapter

### required reading

- [ ] `.behavior/v2026_02_09.keyrack-aws/3.3.blueprint.v1.i1.md` — vaultAdapterAwsIamSso contract
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.oss.levers.v1.i1.md` — aws cli usage
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.code.test.v1.i1.md` — test patterns
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.access._.v1.i1.md` — current vault adapters

### tasks

- [ ] create `vaultAdapterAwsIamSso`
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.ts`
  - implements: `KeyrackHostVaultAdapter`

- [ ] implement storage at `~/.rhachet/keyrack.aws-iam-sso.json`
  - format: `{ [slug]: { profileName, createdAt, updatedAt } }`
  - slug is env-scoped (e.g., `acme.prod.AWS_PROFILE`)

- [ ] implement `unlock()` flow
  - for each profile in storage:
    - validate via `aws sts get-caller-identity --profile $name`
    - if expired: trigger `aws sso login --profile $name`

- [ ] implement `isUnlocked()`
  - validate all profiles via sts get-caller-identity
  - return true if all valid, false if any expired

- [ ] implement `get({ slug })`
  - read profile name from storage file
  - return profile name or null

- [ ] implement `set({ slug, value })`
  - write profile name to storage file
  - value is the aws profile name (e.g., 'acme-prod')

- [ ] implement `del({ slug })`
  - remove profile from storage file

- [ ] add unit tests with mock aws cli
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.test.ts`

- [ ] add integration tests with real aws cli
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.integration.test.ts`

- [ ] export new adapter
  - file: `src/domain.operations/keyrack/adapters/vaults/index.ts`

### acceptance criteria

from usecase.2 (unlock):
```
given('sso session is valid')
  when('validation succeeded')
    then('keyrack reads expiresAt from ~/.aws/sso/cache/<hash>.json')
    then('keyrack caches grant with expiration')

given('sso session is expired')
  when('validation failed')
    then('keyrack triggers aws sso login')
```

### verification

```sh
npm run test:unit -- vaultAdapterAwsIamSso
npm run test:integration -- vaultAdapterAwsIamSso
# expect: all vault adapter tests pass
```

---

## phase 3: mechanism adapter

### required reading

- [ ] `.behavior/v2026_02_09.keyrack-aws/3.3.blueprint.v1.i1.md` — mechAdapterAwsSso contract
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.oss.levers.v1.i1.md` — aws cli usage
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.code.test.v1.i1.md` — test patterns

### tasks

- [ ] update `mechAdapterAwsSso.validate()` to check session
  - file: `src/domain.operations/keyrack/adapters/mechanisms/mechAdapterAwsSso.ts`
  - add: `aws sts get-caller-identity --profile $name` validation
  - return: `{ valid: false, reason: 'sso session expired' }` on failure

- [ ] remove login trigger from `mechAdapterAwsSso.translate()`
  - file: `src/domain.operations/keyrack/adapters/mechanisms/mechAdapterAwsSso.ts`
  - remove: `aws sso login` call (moved to vault unlock)
  - keep: `aws configure export-credentials`

- [ ] update unit tests for validation behavior
  - file: `src/domain.operations/keyrack/adapters/mechanisms/mechAdapterAwsSso.test.ts`
  - test: valid session returns `{ valid: true }`
  - test: expired session returns `{ valid: false, reason: 'sso session expired' }`

- [ ] add integration tests for session validation
  - test: real aws cli session check

### acceptance criteria

from usecase.3 (grant validation):
```
given('keyrack is unlocked but session expired')
  when('test:integration calls getKeyrackKeyGrant(...)')
    then('keyrack validates session via aws sts get-caller-identity')
    then('keyrack detects session expired')
    then('keyrack throws KeyrackUnlockRequiredError')
    then('keyrack does NOT trigger browser auth')
```

### verification

```sh
npm run test:unit -- mechAdapterAwsSso
npm run test:integration -- mechAdapterAwsSso
# expect: all mechanism adapter tests pass
```

---

## phase 4: context wire-up

### required reading

- [ ] `.behavior/v2026_02_09.keyrack-aws/3.3.blueprint.v1.i1.md` — genKeyrackGrantContext section
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.access._.v1.i1.md` — current context assembly

### tasks

- [ ] update `genKeyrackGrantContext` to include aws.iam.sso adapter
  - file: `src/domain.operations/keyrack/genKeyrackGrantContext.ts`
  - add: `'aws.iam.sso': vaultAdapterAwsIamSso` to vault adapters

- [ ] update `getKeyrackKeyGrant` to handle reference protection
  - file: `src/domain.operations/keyrack/getKeyrackKeyGrant.ts`
  - update `toKeyrackKey` to infer 'reference' from aws.iam.sso vault

- [ ] add integration tests for complete flow
  - file: `src/domain.operations/keyrack/getKeyrackKeyGrant.integration.test.ts`
  - test: full grant flow with aws.iam.sso vault

### acceptance criteria

from usecase.3 (robot uses keyrack):
```
given('keyrack is unlocked with valid session')
  when('test:integration calls getKeyrackKeyGrant({ for: { repo: true }, env: "test" })')
    then('keyrack returns grants with profile names')

given('keyrack is locked')
  when('test:integration calls getKeyrackKeyGrant({ for: { key: "acme.test.AWS_PROFILE" } })')
    then('keyrack throws KeyrackUnlockRequiredError')
```

### verification

```sh
npm run test:integration -- getKeyrackKeyGrant
# expect: all grant flow tests pass
```

---

## phase 5: acceptance tests

### required reading

- [ ] `.behavior/v2026_02_09.keyrack-aws/2.1.criteria.blackbox.md` — all blackbox criteria
- [ ] `.behavior/v2026_02_09.keyrack-aws/3.1.research.patterns._.code.test.v1.i1.md` — test patterns

### tasks

- [ ] add blackbox tests for grant scenarios
  - test: grant with valid session returns profile name
  - test: grant with expired session throws unlock-required

- [ ] add blackbox tests for unlock scenarios
  - test: unlock with valid session succeeds
  - test: unlock with expired session triggers sso login

- [ ] add blackbox tests for grade protection
  - test: reference -> encrypted fails
  - test: reference -> plaintext fails
  - test: encrypted -> reference succeeds

### acceptance criteria

all blackbox criteria from `2.1.criteria.blackbox.md`:
- usecase.1: human sets up AWS_PROFILE
- usecase.2: human unlocks keyrack
- usecase.3: test:integration uses keyrack (robot unaware)
- usecase.4: session expires mid-work
- usecase.5: grade protection
- usecase.6: multiple profiles in repo

### verification

```sh
npm run test:acceptance
# expect: all blackbox scenarios pass
```

---

## completion checklist

- [ ] phase 0: domain objects complete
- [ ] phase 1: grade logic complete
- [ ] phase 2: vault adapter complete
- [ ] phase 3: mechanism adapter complete
- [ ] phase 4: context wire-up complete
- [ ] phase 5: acceptance tests complete
- [ ] all types compile: `npm run test:types`
- [ ] all unit tests pass: `npm run test:unit`
- [ ] all integration tests pass: `npm run test:integration`
- [ ] all acceptance tests pass: `npm run test:acceptance`

---

## notes

- no new npm dependencies required
- aws cli invoked via subprocess
- slugs are env-scoped as `$org.$env.$key` (e.g., `acme.prod.AWS_PROFILE`)
- protection hierarchy: `reference (0) > encrypted (1) > plaintext (2)`
- login trigger moved from mechanism adapter to vault unlock

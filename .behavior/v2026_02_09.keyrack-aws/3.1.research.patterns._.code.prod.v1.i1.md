# research: production codepath patterns for aws sso support

## pattern.1 = KeyrackKeyGrade protection levels [EXTEND]

**file:** `src/domain.objects/keyrack/KeyrackKeyGrade.ts`

**current pattern:**
```typescript
export interface KeyrackKeyGrade {
  protection: 'encrypted' | 'plaintext';
  duration: 'permanent' | 'ephemeral' | 'transient';
}
```

**citation [1]:**
> lines 5-7: protection levels are `encrypted` (vault-stored), `plaintext` (unencrypted file)

**relation to wish:**
- must add `'reference'` to protection union
- reference = profile name only, not a secret
- hierarchy: `reference > encrypted > plaintext` (most to least secure)

---

## pattern.2 = KeyrackGrantMechanism types [REUSE]

**file:** `src/domain.objects/keyrack/KeyrackGrantMechanism.ts`

**current pattern:**
```typescript
export type KeyrackGrantMechanism =
  | 'PERMANENT_VIA_REPLICA'
  | 'EPHEMERAL_VIA_GITHUB_APP'
  | 'EPHEMERAL_VIA_AWS_SSO'
  | 'EPHEMERAL_VIA_GITHUB_OIDC';
```

**citation [2]:**
> lines 11-13: EPHEMERAL_VIA_AWS_SSO already defined as "sso profile → temporary session credentials"

**relation to wish:**
- mechanism type already declared, no changes needed

---

## pattern.3 = mechanism adapter interface [EXTEND]

**file:** `src/domain.objects/keyrack/KeyrackGrantMechanismAdapter.ts`

**interface:**
```typescript
export interface KeyrackGrantMechanismAdapter {
  validate: (input: { source?: string; cached?: string }) => {
    valid: boolean;
    reason?: string;
  };
  translate: (input: { value: string }) => Promise<{
    value: string;
    expiresAt?: IsoTimeStamp;
  }>;
}
```

**citation [3]:**
> validate() is called before grant is issued; returns `{ valid: true }` or `{ valid: false, reason }`

**relation to wish:**
- validate() must call `aws sts get-caller-identity` to check session
- translate() returns profile name (not credentials) for reference-grade

---

## pattern.4 = mechAdapterAwsSso implementation [EXTEND]

**file:** `src/domain.operations/keyrack/adapters/mechanisms/mechAdapterAwsSso.ts`

**current implementation:**
```typescript
// lines 14-18: isValidProfileName() validates format
// lines 62-80: validate() accepts profile name or cached JSON
// lines 88-139: translate() calls aws sso login + aws configure export-credentials
```

**citation [4]:**
> line 93: `aws sso login --profile` is called during translate()

**issue:**
- current implementation calls `aws sso login` during grant request
- this causes surprise browser popups when robot requests credentials

**needed changes:**
- validate() should call `aws sts get-caller-identity` to check session
- if session expired, return `{ valid: false, reason: 'sso session expired' }`
- translate() should return profile name only (reference-grade)
- `aws sso login` moves to vault unlock flow only

---

## pattern.5 = grant validation flow [REUSE]

**file:** `src/domain.operations/keyrack/getKeyrackKeyGrant.ts`

**flow (lines 62-255):**
```typescript
const attemptGrantKey = async (input, context) => {
  // 1. find key spec in repo manifest
  // 2. get mechanism adapter
  // 3. check vaults in order: os.envvar → os.daemon → os.direct → host vault
  // 4. validate via mechanism adapter
  const validation = mechAdapter.validate({ source: rawValue });
  if (!validation.valid) return { status: 'blocked', ... };
  // 5. translate via mechanism adapter
  const translated = await mechAdapter.translate({ value: rawValue });
  // 6. construct grant
};
```

**citation [5]:**
> line 227: mechanism adapter's validate() is called before grant is issued

**relation to wish:**
- validation pattern already in place
- AWS SSO validate() must check session validity via get-caller-identity
- grant is blocked if session expired (no surprise popups)

---

## pattern.6 = vault adapter pattern [EXTEND]

**file:** `src/domain.objects/keyrack/KeyrackHostVault.ts`

**current vaults:**
```typescript
export type KeyrackHostVault =
  | 'os.envvar'   // read from process.env
  | 'os.direct'   // plaintext file storage
  | 'os.secure'   // encrypted file via age
  | 'os.daemon'   // in-memory daemon cache
  | '1password';  // 1password cli integration
```

**citation [6]:**
> lines 12-13: os.envvar checked first (CI passthrough), os.daemon used as session cache

**relation to wish:**
- need new vault `aws.iam.sso` for sso profile storage
- vault adapter handles unlock flow (login if expired)
- vault determines protection level (reference for aws.iam.sso)

---

## pattern.7 = unlock flow [REUSE]

**file:** `src/domain.operations/keyrack/session/unlockKeyrack.ts`

**flow (lines 15-110):**
```typescript
export const unlockKeyrack = async (input, context) => {
  // for each key in repo manifest:
  // 1. find host config
  // 2. get vault adapter
  // 3. unlock vault if needed
  await adapter.unlock({ passphrase: input.passphrase });
  // 4. get secret from vault
  const secret = await adapter.get({ slug, exid });
  // 5. infer grade from vault and mechanism
  const grade = inferKeyGrade({ vault, mech });
  // 6. send to daemon with expiresAt
};
```

**citation [7]:**
> lines 67-70: vault adapter's unlock() is called during this flow, not during grant

**relation to wish:**
- aws.iam.sso vault adapter unlock() should:
  1. validate session via `aws sts get-caller-identity`
  2. if expired, trigger `aws sso login --profile $name`
  3. wait for browser auth
  4. return profile name with fresh expiresAt

---

## pattern.8 = grade degradation protection [EXTEND]

**file:** `src/domain.operations/keyrack/grades/detectKeyGradeChange.ts`

**hierarchy (lines 16-20):**
```typescript
const DURATION_RANK: Record<KeyrackKeyGrade['duration'], number> = {
  transient: 0,   // most restrictive
  ephemeral: 1,
  permanent: 2,   // least restrictive
};
```

**citation [8]:**
> lines 36-41: protects against `encrypted → plaintext` downgrade

**relation to wish:**
- must add PROTECTION_RANK for reference protection
- hierarchy: `reference (0) > encrypted (1) > plaintext (2)`
- degradation from reference to encrypted or plaintext is blocked

---

## pattern.9 = grade inference [EXTEND]

**file:** `src/domain.operations/keyrack/grades/inferKeyGrade.ts`

**logic (lines 13-46):**
```typescript
export const inferKeyGrade = (input: { vault, mech }): KeyrackKeyGrade => {
  // vault determines protection
  const protection = (() => {
    if (input.vault === 'os.envvar') return 'plaintext';
    if (input.vault === 'os.secure') return 'encrypted';
    // ...
  })();
  // mechanism determines duration
  const duration = (() => {
    if (input.mech === 'EPHEMERAL_VIA_AWS_SSO') return 'ephemeral';
    // ...
  })();
};
```

**citation [9]:**
> lines 18-25: vault type determines protection level

**relation to wish:**
- aws.iam.sso vault should return `protection: 'reference'`
- EPHEMERAL_VIA_AWS_SSO mechanism returns `duration: 'ephemeral'`

---

## pattern.10 = grant attempt status types [REUSE]

**file:** `src/domain.objects/keyrack/KeyrackGrantAttempt.ts`

**status union (lines 9-13):**
```typescript
export type KeyrackGrantAttempt =
  | KeyrackGrantAttemptGranted   // { status: 'granted', grant }
  | KeyrackGrantAttemptAbsent    // { status: 'absent', slug, message, fix }
  | KeyrackGrantAttemptLocked    // { status: 'locked', slug, message, fix }
  | KeyrackGrantAttemptBlocked;  // { status: 'blocked', slug, message, fix }
```

**relation to wish:**
- granted: session valid, profile name returned
- locked: vault not unlocked, user must run unlock
- blocked: session expired → triggers KeyrackUnlockRequiredError
- absent: key not configured on host

---

## summary

| pattern | file | action | rationale |
|---------|------|--------|-----------|
| protection levels | KeyrackKeyGrade.ts | EXTEND | add 'reference' to union |
| mechanism types | KeyrackGrantMechanism.ts | REUSE | EPHEMERAL_VIA_AWS_SSO declared |
| mechanism adapter | mechAdapterAwsSso.ts | EXTEND | validate session, move login to unlock |
| grant validation | getKeyrackKeyGrant.ts | REUSE | validation pattern works |
| vault types | KeyrackHostVault.ts | EXTEND | add aws.iam.sso vault |
| vault adapter | (new) | CREATE | aws.iam.sso for unlock flow |
| unlock flow | unlockKeyrack.ts | REUSE | vault adapter pattern works |
| grade degradation | detectKeyGradeChange.ts | EXTEND | add reference protection rank |
| grade inference | inferKeyGrade.ts | EXTEND | handle aws.iam.sso vault |
| grant status | KeyrackGrantAttempt.ts | REUSE | current types handle all flows |

## citations

1. KeyrackKeyGrade.ts lines 5-7
2. KeyrackGrantMechanism.ts lines 11-13
3. KeyrackGrantMechanismAdapter.ts interface
4. mechAdapterAwsSso.ts line 93
5. getKeyrackKeyGrant.ts line 227
6. KeyrackHostVault.ts lines 12-13
7. unlockKeyrack.ts lines 67-70
8. detectKeyGradeChange.ts lines 36-41
9. inferKeyGrade.ts lines 18-25

# research: claims for aws sso support

## claims.security

### FACT.1 = sso tokens never touch keyrack storage

keyrack stores only the profile name (e.g., "ehmpathy.dev"), not the sso access token or credentials.

**evidence:**
- aws cli manages tokens in `~/.aws/sso/cache/<hash>.json` [1]
- keyrack reads expiration metadata but does not copy tokens
- the profile name is a reference, not a secret

**citation:**
> "the aws cli caches the access token in a local file. your application retrieves credentials from the cache." [1]

### FACT.2 = browser auth requires human presence

aws sso login opens a browser for human approval. this cannot be automated or bypassed.

**evidence:**
- `aws sso login` opens default browser [2]
- human must click "allow" in browser to complete auth
- no headless or automated flow exists for sso login

**citation:**
> "run `aws sso login --profile my-dev-profile` to open your default browser and verify your iam identity center log in" [2]

### SUMP.1 = reference protection is more secure than encrypted

**claim:** storing a profile name (reference) is more secure than storing an encrypted secret.

**reasoning:**
- if keyrack is compromised, attacker gets "ehmpathy.dev" — a profile name, not credentials
- to use the profile, attacker still needs: access to the machine, valid sso session, browser approval
- encrypted secrets leak if decryption key is compromised; references never leak secrets

**confidence:** high — this follows from the definition of reference vs encrypted storage.

### KHUE.1 = session validation prevents stale grants

**claim:** validation via `aws sts get-caller-identity` before grant prevents robots from operating with expired credentials.

**known unknowns:**
- network latency for validation call (~100-500ms typical)
- failure modes if aws api is unavailable
- whether validation should be cached for short periods

**confidence:** medium — the mechanism is sound, but edge cases need implementation testing.

### OPIN.1 = unlock-only login is the right ux

**opinion:** keyrack should only trigger `aws sso login` during explicit `rhx keyrack unlock`, never during grant requests.

**rationale:**
- surprise browser popups break robot workflows
- human must consciously initiate unlock — they know what's about to happen
- this matches the keyrack model: unlock is explicit, grant is transparent

**alternatives considered:**
- auto-trigger login on expired session: rejected (surprise popups)
- prompt robot to trigger login: rejected (robot shouldn't know about sso)

## claims.implementation

### FACT.3 = aws cli provides all required commands

all operations needed for keyrack aws sso support are available via aws cli:

| operation | command |
|-----------|---------|
| trigger browser auth | `aws sso login --profile <name>` |
| list accounts | `aws sso list-accounts --access-token <token>` |
| list roles | `aws sso list-account-roles --access-token <token> --account-id <id>` |
| validate session | `aws sts get-caller-identity --profile <name>` |

**citation:**
> "aws sso login initiates the authorization process" [2]

### FACT.4 = session expiration is fixed at 8 hours

the access token validity is not configurable by the client.

**evidence:**
- createtoken api returns token with fixed duration [3]
- `expiresAt` in cache file reflects this fixed duration
- no client-side configuration affects token lifetime

**citation:**
> "the access token is valid for 8 hours." [4]

### SUMP.2 = profile name is safe to store in plaintext in keyrack.yml

**claim:** the profile name can be stored in repo's keyrack.yml without encryption.

**reasoning:**
- profile name is not a secret — it's a local reference
- knowing the profile name provides no access without: machine access, sso session, browser approval
- other keyrack.yml content (key slugs, mechanisms) is already plaintext

**confidence:** high — profile names are routinely stored in .env.example and documentation.

## citations

1. [sso token caching - aws cli user guide](https://docs.aws.amazon.com/cli/latest/userguide/sso-using-profile.html)
2. [aws cli sso login command reference](https://docs.aws.amazon.com/cli/latest/reference/sso/login.html)
3. [createtoken api - aws sso oidc](https://docs.aws.amazon.com/singlesignon/latest/OIDCAPIReference/API_CreateToken.html)
4. [sso session expiration - aws-sdk issue #531](https://github.com/aws/aws-sdk/issues/531)

# research: test codepath patterns for aws sso support

## pattern.1 = test-fns BDD framework [REUSE]

**files:** all test files across `src/domain.operations/keyrack/**/*.test.ts`

**pattern:**
```typescript
import { given, then, when } from 'test-fns';

describe('mechAdapterAwsSso', () => {
  given('[case1] valid aws profile names', () => {
    when('[t0] validate called with simple profile name', () => {
      then('validation passes', () => {
        expect(result.valid).toBe(true);
      });
    });
  });
});
```

**citation [1]:**
> test-fns provides given/when/then structure for clear, hierarchical test organization

**relation to wish:**
- perfect for parameterized mechanism adapter validation
- use for AWS SSO grant status matrix tests

---

## pattern.2 = useBeforeAll for stateful setup [REUSE]

**file:** `src/domain.operations/keyrack/daemon/daemon.integration.test.ts` (lines 30-36)

**pattern:**
```typescript
import { useBeforeAll } from 'test-fns';

given('[case1] daemon server lifecycle', () => {
  const scene = useBeforeAll(async () => {
    return createKeyrackDaemonServer({ socketPath: testSocketPath });
  });

  afterAll(() => {
    scene.server.close();
  });
});
```

**citation [2]:**
> useBeforeAll enables shared stateful setup across multiple when/then blocks

**relation to wish:**
- use for AWS SSO integration tests that need session setup
- perfect for tests that validate sso session before cases run

---

## pattern.3 = withTempHome environment isolation [REUSE]

**file:** `src/.test/infra/withTempHome.ts`

**pattern:**
```typescript
const tempHome = withTempHome({ name: 'daoKeyrackHostManifest' });

beforeAll(() => tempHome.setup());
afterAll(() => tempHome.teardown());

// tests run with isolated HOME directory
process.env.HOME = tempHome;
```

**citation [3]:**
> withTempHome provides isolated HOME directory to prevent host system pollution

**relation to wish:**
- critical for AWS SSO tests that interact with `~/.aws/config`
- prevents credential files from host system impact

---

## pattern.4 = mock mechanism adapter [REUSE]

**file:** `src/.test/assets/genMockMechAdapter.ts`

**pattern:**
```typescript
export const genMockMechAdapter = (input?: {
  valid?: boolean;
  invalidReason?: string;
  transform?: (value: string) => string;
  expiresAt?: IsoTimeStamp;
}): KeyrackGrantMechanismAdapter => {
  return {
    validate: () =>
      valid ? { valid: true } : { valid: false, reason: invalidReason },
    translate: async ({ value }) => ({
      value: transform(value),
      expiresAt,
    }),
  };
};
```

**citation [4]:**
> mock adapter supports transform and expiresAt for ephemeral credential tests

**relation to wish:**
- use for AWS SSO unit tests
- supports expiresAt that matches AWS credential expiration

---

## pattern.5 = mock vault adapter [REUSE]

**file:** `src/.test/assets/genMockVaultAdapter.ts`

**pattern:**
```typescript
export const genMockVaultAdapter = (input?: {
  isUnlocked?: boolean;
  storage?: Record<string, string>;
}) => ({
  unlock: async () => { unlocked = true; },
  isUnlocked: async () => unlocked,
  get: async ({ slug }) => storage[slug] ?? null,
  set: async ({ slug, value }) => { storage[slug] = value; },
  del: async ({ slug }) => { delete storage[slug]; },
});
```

**citation [5]:**
> mock vault adapter provides in-memory storage for vault operations test

**relation to wish:**
- use for aws.iam.sso vault adapter interface test
- supports unlock flow and profile name storage

---

## pattern.6 = mock manifests [EXTEND]

**files:**
- `src/.test/assets/genMockKeyrackHostManifest.ts`
- `src/.test/assets/genMockKeyrackRepoManifest.ts`

**pattern:**
```typescript
export const genMockKeyrackHostManifest = (input?: {
  hosts?: Record<string, Partial<KeyrackKeyHost>>;
}) => {
  // builds hosts with defaults: mech='REPLICA', vault='os.direct'
};
```

**citation [6]:**
> mock manifests provide configurable defaults for host and repo config test

**relation to wish:**
- extend to include AWS_SSO mechanism variants
- add profile name storage fixtures per vision

---

## pattern.7 = real manifest round-trip integration [EXTEND]

**file:** `src/domain.operations/keyrack/getKeyrackKeyGrant.integration.test.ts` (lines 36-110)

**pattern:**
```typescript
given('[case1] key configured in repo and host with value in vault', () => {
  beforeEach(async () => {
    // setup repo manifest at .agent/keyrack.yml
    writeFileSync(join(agentDir, 'keyrack.yml'), `keys:
  __TEST_HOST_API_KEY__:
    mech: REPLICA
`);

    // setup host manifest via DAO
    await daoKeyrackHostManifest.set({ upsert: manifest });

    // store value in real vault
    await vaultAdapterOsDirect.set({ slug, value });
  });

  when('[t0] get called for single key', () => {
    then('status is granted', async () => {
      const result = await getKeyrackKeyGrant({ for: { key } }, context);
      expect(result.status).toEqual('granted');
    });
  });
});
```

**citation [7]:**
> integration tests use real manifest I/O and vault storage for full round-trip validation

**relation to wish:**
- extend for AWS SSO: write profile name to manifest (not credentials)
- mock AWS CLI calls instead of real vault storage
- test `aws sts get-caller-identity` validation

---

## pattern.8 = environment variable passthrough [REUSE]

**file:** `src/domain.operations/keyrack/getKeyrackKeyGrant.test.ts` (lines 294-358)

**pattern:**
```typescript
given('[case6] key is present in process.env', () => {
  beforeEach(() => {
    process.env[envKey] = envValue;
  });
  afterEach(() => {
    delete process.env[envKey];
  });

  when('[t0] get called for key that exists in env', () => {
    then('status is granted', async () => {
      // os.envvar vault adapter reads from process.env
    });
  });
});
```

**citation [8]:**
> env var passthrough enables CI/CD environments to provide credentials via process.env

**relation to wish:**
- CI can set AWS_PROFILE via env var for passthrough
- validates os.envvar vault precedence in grant flow

---

## pattern.9 = grade inference tests [EXTEND]

**file:** `src/domain.operations/keyrack/grades/inferKeyGrade.test.ts` (lines 5-193)

**current pattern:**
```typescript
given('[case1] vault determines protection', () => {
  when('[t0] vault is os.envvar', () => {
    then('protection is plaintext', () => {
      const grade = inferKeyGrade({
        vault: 'os.envvar',
        mech: 'PERMANENT_VIA_REPLICA',
      });
      expect(grade.protection).toEqual('plaintext');
    });
  });
});
```

**citation [9]:**
> grade inference tests cover vault → protection and mechanism → duration mappings

**relation to wish:**
- add 'reference' protection tests for aws.iam.sso vault
- add EPHEMERAL_VIA_AWS_SSO → ephemeral duration tests

---

## pattern.10 = grade degradation tests [EXTEND]

**file:** `src/domain.operations/keyrack/grades/assertKeyGradeProtected.test.ts` (lines 1-101)

**pattern:**
```typescript
given('[case2] protection downgrade', () => {
  when('[t0] encrypted → plaintext', () => {
    then('throws BadRequestError', async () => {
      const error = await getError(async () =>
        assertKeyGradeProtected({
          source: { protection: 'encrypted', duration: 'ephemeral' },
          target: { protection: 'plaintext', duration: 'ephemeral' },
        }),
      );
      expect(error?.message).toContain('downgrade');
    });
  });
});
```

**citation [10]:**
> grade degradation tests validate that security cannot be reduced

**relation to wish:**
- add tests for reference → encrypted downgrade (blocked)
- add tests for reference → plaintext downgrade (blocked)
- validate hierarchy: reference > encrypted > plaintext

---

## pattern.11 = grant status matrix [EXTEND]

**file:** `src/domain.operations/keyrack/getKeyrackKeyGrant.test.ts` (lines 12-479)

**statuses tested:**
- `granted` — key available and valid
- `absent` — not in repo or host manifest
- `locked` — vault locked
- `blocked` — mechanism validation failed

**citation [11]:**
> grant status matrix covers all possible outcomes from grant request

**relation to wish:**
- add AWS SSO cases: session valid, session expired, profile invalid
- test blocked status when `aws sts get-caller-identity` fails

---

## pattern.12 = daemon integration for transient keys [REUSE]

**file:** `src/domain.operations/keyrack/daemon/daemon.integration.test.ts`

**pattern:**
```typescript
given('[case2] daemon commands via socket', () => {
  when('[t0] UNLOCK command', () => {
    then('stores keys in daemon', async () => {
      await daemonAccessUnlock({
        keys: [{
          slug: 'AWS_SESSION_CREDENTIALS',
          key: {
            secret: JSON.stringify(credentials),
            grade: { protection: 'reference', duration: 'transient' },
          },
          expiresAt: Date.now() + 3600000,
        }],
        socketPath: testSocketPath,
      });
    });
  });
});
```

**citation [12]:**
> daemon integration tests validate ephemeral key storage with TTL management

**relation to wish:**
- AWS SSO credentials are transient (vault=os.daemon)
- test credential JSON round-trip through daemon socket

---

## recommended new test infrastructure

### mock AWS CLI executor [CREATE]

```typescript
// src/.test/assets/mockAwsCliExecutor.ts
export const mockAwsCliExecutor = (input?: {
  profiles?: Record<string, AwsProfile>;
  callerIdentity?: AwsCallerIdentity;
}) => ({
  ssoLogin: async (profile: string) => { /* mock */ },
  exportCredentials: async (profile: string) => { /* returns env format */ },
  getCallerIdentity: async () => { /* returns identity */ },
});
```

### AWS SSO test fixtures [CREATE]

```typescript
// src/.test/assets/genAwsSsoTestFixtures.ts
- valid profile names (aws-dev, org-name.prod, my_org_prod)
- expired vs fresh credentials
- session tokens with various TTL values
- aws sts get-caller-identity responses
```

---

## summary

| pattern | file(s) | action | rationale |
|---------|---------|--------|-----------|
| test-fns BDD | all test files | REUSE | mechanism validation matrix |
| useBeforeAll | daemon.integration.test.ts | REUSE | stateful session setup |
| withTempHome | .test/infra | REUSE | prevent ~/.aws pollution |
| mock mechanism adapter | .test/assets | REUSE | expiresAt support |
| mock vault adapter | .test/assets | REUSE | unlock flow test |
| mock manifests | .test/assets | EXTEND | add AWS_SSO variants |
| real manifest I/O | integration tests | EXTEND | profile name storage |
| env var passthrough | getKeyrackKeyGrant.test.ts | REUSE | CI/CD AWS_PROFILE |
| grade inference | inferKeyGrade.test.ts | EXTEND | add 'reference' tests |
| grade degradation | assertKeyGradeProtected.test.ts | EXTEND | reference protection |
| grant status matrix | getKeyrackKeyGrant.test.ts | EXTEND | AWS SSO cases |
| daemon integration | daemon.integration.test.ts | REUSE | transient key lifecycle |
| mock AWS CLI | (new) | CREATE | mock aws cli commands |
| AWS SSO fixtures | (new) | CREATE | profile and credential fixtures |

## citations

1. test-fns documentation
2. daemon.integration.test.ts lines 30-36
3. withTempHome.ts implementation
4. genMockMechAdapter.ts interface
5. genMockVaultAdapter.ts interface
6. genMockKeyrackHostManifest.ts defaults
7. getKeyrackKeyGrant.integration.test.ts lines 36-110
8. getKeyrackKeyGrant.test.ts lines 294-358
9. inferKeyGrade.test.ts lines 5-193
10. assertKeyGradeProtected.test.ts lines 1-101
11. getKeyrackKeyGrant.test.ts lines 12-479
12. daemon.integration.test.ts daemon commands

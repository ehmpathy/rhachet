# research: remote access for aws sso support

## repositories accessed

### 1. aws cli (shell interface)

keyrack invokes aws cli commands as subprocesses.

**commands used:**

| command | purpose | citation |
|---------|---------|----------|
| `aws sso login --profile <name>` | trigger browser auth, obtain access token | [1] |
| `aws sso list-accounts --access-token <token>` | enumerate accounts after auth | [2] |
| `aws sso list-account-roles --access-token <token> --account-id <id>` | enumerate roles for account | [3] |
| `aws sts get-caller-identity --profile <name>` | validate session is still active | [4] |

**contract:**
- input: command-line arguments
- output: json to stdout (with `--output json`)
- errors: non-zero exit code, message to stderr

**best practice:**
> "To retrieve and cache IAM Identity Center credentials, run `aws sso login --profile my-dev-profile` to open your default browser and verify your IAM Identity Center log in" [1]

### 2. ~/.aws/config (filesystem)

keyrack writes sso profile configuration.

**format:**
```ini
[profile acme.prod]
sso_session = acme
sso_account_id = 111122223333
sso_role_name = AdministratorAccess
region = us-east-1
output = json

[sso-session acme]
sso_region = us-east-1
sso_start_url = https://acme.awsapps.com/start
sso_registration_scopes = sso:account:access
```

**contract:**
- format: ini file with `[profile <name>]` and `[sso-session <name>]` sections
- required fields per profile: `sso_session`, `sso_account_id`, `sso_role_name`
- required fields per sso-session: `sso_region`, `sso_start_url`

**citation:**
> "You define an sso-session section and associate it to a profile. sso_region and sso_start_url must be set within the sso-session section. Typically, sso_account_id and sso_role_name must be set in the profile section so that the SDK can request SSO credentials." [5]

### 3. ~/.aws/sso/cache/<hash>.json (filesystem)

keyrack reads session expiration after login.

**format:**
```json
{
  "startUrl": "https://acme.awsapps.com/start",
  "region": "us-east-1",
  "accessToken": "eyJlbmMiOiJBM….",
  "expiresAt": "2020-06-17T10:02:08UTC"
}
```

**contract:**
- read-only for keyrack (aws cli writes this)
- `expiresAt`: iso8601 timestamp of token expiration
- `accessToken`: jwt for api calls (8 hour validity)

**citation:**
> "When you configure a named profile to use IAM Identity Center, the AWS Command Line Interface (AWS CLI) creates a JSON file in the ~/.aws/sso/cache directory. The JSON file contains a JSON web token (JWT) that's used to get the temporary security credentials" [6]

> "The access token is valid for 8 hours." [6]

## citations

1. [AWS CLI sso login command reference](https://docs.aws.amazon.com/cli/latest/reference/sso/login.html)
2. [AWS CLI sso list-accounts command reference](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sso/list-accounts.html)
3. [AWS CLI sso list-account-roles command reference](https://docs.aws.amazon.com/cli/latest/reference/sso/list-account-roles.html)
4. [AWS CLI sts get-caller-identity command reference](https://docs.aws.amazon.com/cli/latest/reference/sts/get-caller-identity.html)
5. [IAM Identity Center authentication with the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html)
6. [SSO session expiration and re-login - aws-sdk issue #531](https://github.com/aws/aws-sdk/issues/531)
7. [Configuration and credential file settings in the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html)

## best practices

### within this repo

1. **never store secrets** — only store profile name (reference protection)
2. **validate before grant** — call `aws sts get-caller-identity` to verify session
3. **read expiration from cache** — use `expiresAt` from sso cache file
4. **trigger login only at unlock** — never surprise the human with popups

### industry wide

1. **use sso-session sections** — recommended over legacy inline config [5]
2. **set sso_registration_scopes** — enables token refresh [5]
3. **prefer --profile over env vars** — explicit is better than implicit

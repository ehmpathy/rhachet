# blackbox criteria: aws sso support for keyrack

## usecase.1 = human sets up AWS_PROFILE

```
given('human runs `rhx keyrack set AWS_PROFILE --mech EPHEMERAL_VIA_AWS_SSO`')
  when('aws cli is not installed')
    then('keyrack displays install instructions')
      sothat('human knows how to install the dependency')
    then('keyrack waits for human to install')
    then('keyrack detects aws cli now available')
    then('keyrack proceeds with setup')

  when('aws cli is installed')
    then('keyrack prompts for sso start url')
    then('keyrack prompts for sso region')
    then('keyrack triggers browser auth')

given('human approved browser auth')
  when('auth succeeded')
    then('keyrack lists available accounts via aws sso list-accounts')
    then('keyrack prompts human to pick account')

given('human picked account')
  when('account selected')
    then('keyrack lists available roles via aws sso list-account-roles')
    then('keyrack prompts human to pick role')

given('human picked role')
  when('role selected')
    then('keyrack prompts for profile name')

given('human entered profile name')
  when('profile name provided')
    then('keyrack writes ~/.aws/config with profile')
    then('keyrack stores profile name in keyrack')
    then('keyrack validates setup via aws sts get-caller-identity')
    then('keyrack displays success')
      sothat('human knows setup is complete')
```

## usecase.2 = human unlocks keyrack

```
given('repo has AWS_PROFILE key declared in keyrack.yml')
  when('human runs `rhx keyrack unlock`')
    then('keyrack validates sso session via aws sts get-caller-identity')

given('sso session is valid')
  when('validation succeeded')
    then('keyrack reads expiresAt from ~/.aws/sso/cache/<hash>.json')
    then('keyrack caches grant with expiration')
    then('keyrack displays unlock success')

given('sso session is expired')
  when('validation failed')
    then('keyrack triggers aws sso login')
    then('human approves in browser')
    then('keyrack reads expiresAt from cache')
    then('keyrack caches grant with expiration')
    then('keyrack displays unlock success')
```

## usecase.3 = test:integration uses keyrack (robot unaware)

note: slugs are env-scoped as $org.$env.$key (e.g., 'acme.test.AWS_PROFILE')

```
given('keyrack is unlocked with valid session')
  when('test:integration calls getKeyrackKeyGrant({ for: { repo: true }, env: "test" })')
    then('keyrack returns grants with profile names')
      sothat('test:integration can run with AWS_PROFILE set')

given('keyrack is locked')
  when('test:integration calls getKeyrackKeyGrant({ for: { key: "acme.test.AWS_PROFILE" } })')
    then('keyrack throws KeyrackUnlockRequiredError')
      sothat('robot learns unlock is needed')

given('keyrack is unlocked but session expired')
  when('test:integration calls getKeyrackKeyGrant({ for: { key: "acme.test.AWS_PROFILE" } })')
    then('keyrack validates session via aws sts get-caller-identity')
    then('keyrack detects session expired')
    then('keyrack throws KeyrackUnlockRequiredError')
      sothat('robot learns unlock is needed')
    then('keyrack does NOT trigger browser auth')
      sothat('human is never surprised by popups')
```

## usecase.4 = session expires mid-work

```
given('robot is in the middle of work')
  when('robot runs test:integration')
    when('session has expired since last unlock')
      then('test:integration fails with KeyrackUnlockRequiredError')
      then('robot tells human "please run rhx keyrack unlock"')
      then('robot blocks and waits')

given('human runs `rhx keyrack unlock` after expiry')
  when('unlock succeeds')
    then('robot retries and continues')
```

## usecase.5 = grade protection

```
given('AWS_PROFILE key has grade.protection = "reference"')
  when('attempt to change to grade.protection = "encrypted"')
    then('keyrack blocks the change')
      sothat('security is never degraded')

  when('attempt to change to grade.protection = "plaintext"')
    then('keyrack blocks the change')
      sothat('security is never degraded')

given('key has grade.protection = "encrypted"')
  when('attempt to change to grade.protection = "reference"')
    then('keyrack allows the change')
      sothat('security can be upgraded')
```

## usecase.6 = multiple profiles in repo

note: different envs can have different AWS_PROFILE keys (e.g., 'acme.prod.AWS_PROFILE', 'acme.prep.AWS_PROFILE')

```
given('keyrack.yml declares AWS_PROFILE in env.prod and env.prep')
  when('human runs `rhx keyrack unlock`')
    then('keyrack validates sso sessions for all declared profiles')
    then('keyrack triggers login for any expired sessions')
    then('keyrack caches grants for all profiles')
      sothat('all declared profiles are ready for use')
```

# research: oss levers for aws sso support

## tool.1 = aws cli [PRIMARY]

**what:** official command-line interface for aws services, with sso login and credential management.

**how to use:**
```sh
# trigger browser auth and cache sso token
aws sso login --profile acme.dev

# list accounts available after auth
aws sso list-accounts --access-token $TOKEN

# list roles for an account
aws sso list-account-roles --access-token $TOKEN --account-id 123456789012

# validate session is still active
aws sts get-caller-identity --profile acme.dev
```

**maintained:** yes — official aws tools, actively maintained by aws.

**frontier usage:** ubiquitous — every aws shop uses it.

**citation:**
> "run `aws sso login --profile my-dev-profile` to open your default browser and verify your iam identity center log in" [1]

**pros:**
- official, guaranteed compatibility
- handles all sso complexity (oauth device flow, token cache, browser auth)
- writes to `~/.aws/sso/cache/<hash>.json` with `expiresAt` field
- supports `--output json` for programmatic parse

**cons:**
- requires subprocess invocation from node.js
- error handle via exit codes and stderr parse
- browser popup is a blocker (by design for keyrack)

**relation to wish:**
- PRIMARY tool for sso login and session validation
- keyrack invokes aws cli commands as subprocesses
- no need to reimplement oauth device flow

---

## tool.2 = @aws-sdk/credential-providers [EVALUATE]

**what:** official aws sdk for javascript v3 credential providers, with `fromSSO()` for sso-based credentials.

**how to use:**
```ts
import { fromSSO } from '@aws-sdk/credential-providers';

// get credentials from sso profile
const credentials = await fromSSO({ profile: 'acme.dev' })();

// credentials contains:
// - accessKeyId
// - secretAccessKey
// - sessionToken
// - expiration
```

**maintained:** yes — official aws sdk, actively maintained.

**frontier usage:** standard for node.js aws apps. used by companies that prefer programmatic credential resolution over cli invocation.

**citation:**
> "the `fromSSO` function creates AwsCredentialIdentityProvider functions that read from the resolved access token from local disk then requests temporary aws credentials" [2]

**pros:**
- native node.js — no subprocess overhead
- typed api with proper error handler
- reads same `~/.aws/config` and `~/.aws/sso/cache/` as cli
- returns structured credential objects

**cons:**
- requires sso token already present (must run `aws sso login` first)
- cannot trigger browser auth — cli is still needed for login
- adds dependency weight (~500kb+ with transitive deps)

**relation to wish:**
- EVALUATE for credential export in translate() step
- could replace `aws configure export-credentials` for cleaner integration
- still requires aws cli for `sso login` trigger

---

## tool.3 = @smithy/shared-ini-file-loader [USE]

**what:** official aws module to parse `~/.aws/config` and `~/.aws/credentials` files.

**how to use:**
```ts
import { loadSharedConfigFiles } from '@smithy/shared-ini-file-loader';

const { configFile, credentialsFile } = await loadSharedConfigFiles();

// configFile is a hash of profile name -> settings
// e.g., configFile['acme.dev'] = { sso_start_url, sso_region, ... }
```

**maintained:** yes — part of official aws sdk tools.

**frontier usage:** used internally by all aws sdk credential providers.

**citation:**
> "this module provides a function that reads from aws sdk configuration files and returns a promise that will resolve with a hash of the parsed contents" [3]

**pros:**
- official parser — handles edge cases correctly
- supports AWS_CONFIG_FILE env override
- returns typed structures
- lightweight (minimal deps)

**cons:**
- read-only — cannot write config files
- no sso cache parse (only ini files)

**relation to wish:**
- USE for read of profile configuration at validation
- enables keyrack to verify profile exists before operations
- does NOT replace need for aws cli

---

## tool.4 = aws-vault [ALTERNATIVE]

**what:** open-source tool by 99designs for secure aws credential management. stores credentials in os keychain, generates temporary credentials.

**how to use:**
```sh
# store credentials securely
aws-vault add acme.dev

# execute command with temporary credentials
aws-vault exec acme.dev -- aws s3 ls

# open subshell with credentials
aws-vault exec acme.dev
```

**maintained:** yes — active open source project, 7k+ github stars.

**frontier usage:** popular among security-conscious teams. used by many startups and enterprises.

**citation:**
> "aws vault stores iam credentials in your os secure keystore and then generates temporary credentials from those to expose to your shell and applications" [4]

**pros:**
- secure storage in os keychain
- automatic credential rotation
- mfa support built in
- cross-platform (go binary)

**cons:**
- requires separate installation
- different mental model than standard aws cli
- sso support is secondary (primarily for iam credentials)
- adds another tool to the stack

**relation to wish:**
- ALTERNATIVE — could consider for future enhancement
- keyrack's daemon already provides similar ephemeral credential benefits
- aws cli + keyrack achieves same goals without extra tools

---

## tool.5 = ini (npm) [SKIP]

**what:** generic ini file parser for node.js.

**how to use:**
```ts
import * as ini from 'ini';
import * as fs from 'fs';

const config = ini.parse(fs.readFileSync('~/.aws/config', 'utf-8'));
```

**maintained:** yes — stable, widely used.

**pros:**
- lightweight
- simple api

**cons:**
- not aws-aware (doesn't handle aws config edge cases)
- no support for AWS_CONFIG_FILE env
- @smithy/shared-ini-file-loader is strictly better for aws use case

**relation to wish:**
- SKIP — use @smithy/shared-ini-file-loader instead

---

## recommended stack

| layer | tool | rationale |
|-------|------|-----------|
| sso login | aws cli | only tool that can trigger browser auth |
| session validation | aws cli (`sts get-caller-identity`) | simple, reliable, official |
| config parse | @smithy/shared-ini-file-loader | official, typed, lightweight |
| credential export | aws cli or @aws-sdk/credential-providers | evaluate based on performance needs |
| sso cache read | direct json parse | `~/.aws/sso/cache/<hash>.json` is simple json |

## implementation notes

### sso cache file location

```
~/.aws/sso/cache/<sha1-of-start-url>.json
```

**format:**
```json
{
  "startUrl": "https://acme.awsapps.com/start",
  "region": "us-east-1",
  "accessToken": "eyJlbmMiOi...",
  "expiresAt": "2024-01-15T18:00:00Z"
}
```

keyrack reads `expiresAt` after login to set grant expiration.

### why not pure sdk?

the aws sdk v3 credential providers require an active sso token. they cannot trigger browser auth. the flow is:

1. `aws sso login --profile $name` → browser auth → writes token to cache
2. sdk `fromSSO()` → reads token from cache → exchanges for credentials

keyrack still needs aws cli for step 1. step 2 could use sdk or cli.

### subprocess vs native

| approach | pros | cons |
|----------|------|------|
| subprocess (aws cli) | simple, official, all features | spawn overhead, error parse |
| native (sdk) | typed, no spawn | cannot trigger login, more deps |

**recommendation:** use subprocess for login and validation (required anyway), evaluate native for credential export if performance matters.

---

## citations

1. [aws cli sso login command reference](https://docs.aws.amazon.com/cli/latest/reference/sso/login.html)
2. [fromSSO - aws sdk for javascript v3](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/functions/_aws_sdk_credential_providers.fromSSO.html)
3. [@smithy/shared-ini-file-loader - npm](https://www.npmjs.com/package/@smithy/shared-ini-file-loader)
4. [aws-vault - github](https://github.com/99designs/aws-vault)

# blackbox criteria matrix: aws sso support for keyrack

## matrix.1 = setup flow

| ind: aws cli | ind: browser auth | dep: outcome |
|--------------|-------------------|--------------|
| absent | — | display install instructions, wait, detect, proceed |
| present | success | prompt url → region → auth → list accounts → list roles → write config → validate → success |
| present | fail | display auth error, abort setup |

## matrix.2 = unlock flow

| ind: session state | dep: validation | dep: browser trigger | dep: cache update | dep: display |
|--------------------|-----------------|----------------------|-------------------|--------------|
| valid | pass | no | read expiresAt, cache grant | success |
| expired | fail | yes (aws sso login) | read expiresAt, cache grant | success |

## matrix.3 = grant request (test:integration → keyrack)

| ind: keyrack state | ind: session state | dep: grant returned | dep: error | dep: browser popup |
|--------------------|--------------------|--------------------|------------|-------------------|
| locked | — | no | KeyrackUnlockRequiredError | never |
| unlocked | valid | yes (profile name) | none | never |
| unlocked | expired | no | KeyrackUnlockRequiredError | never |

note: "never" for browser popup is a hard constraint — human must consciously run `rhx keyrack unlock`.

## matrix.4 = grade protection (change attempts)

| ind: current grade | ind: target grade | dep: change allowed |
|--------------------|-------------------|---------------------|
| reference | reference | yes (no-op) |
| reference | encrypted | **no** (degradation) |
| reference | plaintext | **no** (degradation) |
| encrypted | reference | yes (upgrade) |
| encrypted | encrypted | yes (no-op) |
| encrypted | plaintext | **no** (degradation) |
| plaintext | reference | yes (upgrade) |
| plaintext | encrypted | yes (upgrade) |
| plaintext | plaintext | yes (no-op) |

hierarchy: `reference > encrypted > plaintext`

## matrix.5 = multi-profile unlock

| ind: profile count | ind: session states | dep: validations | dep: logins triggered | dep: grants cached |
|--------------------|---------------------|------------------|----------------------|-------------------|
| 1 | all valid | 1 | 0 | 1 |
| 1 | all expired | 1 | 1 | 1 |
| 2 | all valid | 2 | 0 | 2 |
| 2 | all expired | 2 | 2 | 2 |
| 2 | mixed (1 valid, 1 expired) | 2 | 1 | 2 |
| N | mixed | N | count(expired) | N |

note: only profiles declared in repo's `keyrack.yml` are validated.

## gaps identified

none — all meaningful combinations are covered.

## decomposition assessment

no decomposition needed:
- matrix.1 (setup): 2 dimensions — clean
- matrix.2 (unlock): 1 dimension — clean
- matrix.3 (grant): 2 dimensions — clean
- matrix.4 (grade): 2 dimensions — clean (3x3 = 9 combinations, all enumerated)
- matrix.5 (multi): 2 dimensions — clean (generalized to N)

all matrices have ≤3 independent dimensions — behavioral boundaries are appropriately scoped.

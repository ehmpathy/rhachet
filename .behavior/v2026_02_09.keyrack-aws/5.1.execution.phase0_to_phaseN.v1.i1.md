# execution: aws sso support for keyrack

## progress

| phase | scope | status |
|-------|-------|--------|
| 0 | domain objects | done |
| 1 | grade logic | done |
| 2 | vault adapter | done |
| 3 | mechanism adapter | done |
| 4 | context wire-up | done |
| 5 | acceptance tests | done |

---

## phase 0: domain objects

### tasks

- [x] add `'reference'` to `KeyrackKeyGrade.protection` union
- [x] add `'aws.iam.sso'` to `KeyrackHostVault` union
- [x] verify type compilation

### verification

```sh
npm run test:types
```

---

## log

### 2026-02-11: phase 0 done

- added 'reference' to KeyrackKeyGrade.protection union
- added 'aws.iam.sso' to KeyrackHostVault union
- created stub vaultAdapterAwsIamSso (throws not-implemented)
- updated production files: genKeyrackGrantContext.ts, genKeyrackHostContext.ts
- updated test files: getKeyrackKeyGrant.test.ts, setKeyrackKeyHost.test.ts, unlockKeyrackVault.test.ts
- npm run test:types passes

### 2026-02-11: phase 1 done

- updated inferKeyGrade.ts: aws.iam.sso → 'reference' protection
- updated detectKeyGradeChange.ts: PROTECTION_RANK with reference=0, encrypted=1, plaintext=2
- added unit tests for reference protection in inferKeyGrade.test.ts
- added degradation tests for reference in detectKeyGradeChange.test.ts
- added upgrade/downgrade tests for reference in assertKeyGradeProtected.test.ts
- all 54 grade tests pass

### 2026-02-11: phase 2 done

- implemented vaultAdapterAwsIamSso (full implementation, replaced stub from phase 0)
- storage at ~/.rhachet/keyrack.aws-iam-sso.json
- unlock validates sso sessions, triggers aws sso login for expired
- isUnlocked checks all stored profiles via sts get-caller-identity
- 21 unit tests pass (CRUD, session validation, unlock flow, multi-profile)
- uses withTempHome for test isolation, jest.mock for aws cli simulation

### 2026-02-11: phase 3 done

- updated mechAdapterAwsSso.validate() to check sso session via sts get-caller-identity
- validate now returns { valid: false, reason: 'sso session expired' } when session is invalid
- login trigger removed from translate() (moved to vault unlock in phase 2)
- 28 unit tests pass (profile name validation, session validation, cached credentials)
- tests use jest.mock for child_process.execSync simulation

### 2026-02-11: phase 4 done

- verified aws.iam.sso vault adapter already wired in genKeyrackGrantContext.ts (from phase 0)
- verified aws.iam.sso vault adapter already wired in genKeyrackHostContext.ts (from phase 0)
- added 2 end-to-end tests for aws.iam.sso grant flow in getKeyrackKeyGrant.test.ts
  - [case9] key stored in aws.iam.sso vault with valid session → status granted
  - [case10] aws.iam.sso vault locked (sso session expired) → status locked
- all 25 grant tests pass

### 2026-02-11: phase 5 done

- created test fixture: accept.blackbox/.test/assets/with-vault-aws-iam-sso/
  - .agent/keyrack.yml with AWS_PROFILE keys for prod and test envs
  - .rhachet/keyrack.manifest.json with aws.iam.sso vault entries
  - .rhachet/keyrack.aws-iam-sso.json with profile name storage
- created acceptance test: accept.blackbox/cli/keyrack.vault.awsIamSso.acceptance.test.ts
  - [case1] list command with aws.iam.sso vault (json + human readable)
  - [case2] set command creates new aws.iam.sso host entry
  - [case3] get returns locked when sso session cannot be validated
  - [case4] findsert semantics (set key that already exists returns found)
  - [case5] multiple envs with aws.iam.sso
- fixed zod schema in daoKeyrackHostManifest/schema.ts to include aws.iam.sso vault and all mech values
- fixed CLI validation in invokeKeyrack.ts to accept aws.iam.sso as valid vault
- all 23 acceptance tests pass, 6 snapshots captured

### 2026-02-12: blueprint omissions addressed

- created 6.blueprint.omissions.v1.md with gap analysis and decisions
- added [case6] unlock with aws.iam.sso vault acceptance test
  - verifies unlock exits non-zero when sso session invalid
  - verifies error message mentions sso/session/login
- created vaultAdapterAwsIamSso.integration.test.ts stub
  - documents why real integration tests are impossible
  - aws sso requires browser auth (human approval in aws portal)
  - no headless/service-account equivalent exists
- all 25 acceptance tests pass, 6 snapshots
- stub integration test passes

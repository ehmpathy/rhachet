# runbook: manual test aws.iam.sso vault

## prerequisites

1. aws cli v2 installed (`aws --version`)
2. access to an aws sso portal (e.g., `https://ehmpathy.awsapps.com/start`)
3. at least one account + role you can assume via sso

## note: local dev build vs installed package

to test local changes, use `./bin/run` (local dev build), not `npx rhachet` (installed npm package).

| command | what it runs |
|---------|--------------|
| `npx rhachet ...` | installed npm version from node_modules |
| `./bin/run ...` | local dev build (your changes) |

the examples below use `rhx` which should be aliased to `./bin/run` for dev:

```sh
alias rhx="./bin/run"
```

## step 1: initialize keyrack manifest

keyrack requires a `.agent/keyrack.yml` that declares which keys are used in which envs.

```sh
rhx keyrack init --org ehmpathy
```

replace `ehmpathy` with your org name (e.g., `ehmpathy`).

this creates `.agent/keyrack.yml` with the org name. **no manual edits needed** â€” `keyrack set` will auto-update the manifest when you add keys.

## step 2: set up keyrack key

### option a: interactive guided setup (recommended)

if you don't have an aws profile yet, keyrack guides you through the full setup:

```sh
rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso
```

note: `--mech EPHEMERAL_VIA_AWS_SSO` is inferred from `--vault aws.iam.sso` (but can still be explicit).

keyrack will show a sleek guided flow:

```
ğŸ” keyrack set AWS_PROFILE

â”Œâ”€ sso portal
â”‚
â”‚  found in ~/.aws/config:
â”‚    1. https://ehmpathy.awsapps.com/start (us-east-1)
â”‚    2. https://acme.awsapps.com/start (us-west-2)
â”‚
â”‚  pick [1-2] or enter new url: 1
â”‚
â”‚  âœ“ sso_start_url = https://ehmpathy.awsapps.com/start
â”‚  âœ“ sso_region = us-east-1
â”‚
â”œâ”€ browser auth
â”‚
â”‚  â³ open browser for device auth...
â”‚  âœ“ approved
â”‚
â”œâ”€ account
â”‚
â”‚    1. 123456789012 Â· dev Â· dev@ehmpathy.com
â”‚    2. 999999999999 Â· prod Â· prod@ehmpathy.com
â”‚
â”‚  pick [1-2]: 1
â”‚
â”‚  âœ“ sso_account_id = 123456789012
â”‚
â”œâ”€ role
â”‚
â”‚    1. AdministratorAccess
â”‚    2. ReadOnlyAccess
â”‚
â”‚  pick [1-2]: 1
â”‚
â”‚  âœ“ sso_role_name = AdministratorAccess
â”‚
â”œâ”€ profile name
â”‚
â”‚  suggested: ehmpathy.dev
â”‚  accept or enter custom: [enter]
â”‚
â”‚  âœ“ profile = ehmpathy.dev
â”‚
â””â”€ done

  âœ“ wrote ~/.aws/config
  âœ“ validated via aws sts get-caller-identity
```

**autofill features:**
- **sso url**: enumerates from `~/.aws/config`, pick by number or type new
- **sso region**: auto-fills when url is picked
- **account/role**: enumerated via aws api after browser auth
- **profile name**: suggests `$accountName.$roleName`, accept with enter or type custom

### option b: use pre-configured profile

if you already have a profile in `~/.aws/config`:

```sh
rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso --exid ehmpathy.dev
```

this stores the profile name without the guided setup.

verify it's stored:

```sh
rhx keyrack list --json | jq
```

should show:

```json
{
  "ehmpathy.test.AWS_PROFILE": {
    "vault": "aws.iam.sso",
    "mech": "EPHEMERAL_VIA_AWS_SSO",
    ...
  }
}
```

## step 3: test unlock flow

### 3a: with valid session

if your sso session is still valid:

```sh
rhx keyrack unlock --env test
```

should succeed silently (validates via `aws sts get-caller-identity`).

### 3b: with expired session

wait for session to expire (8 hours), or force relock:

```sh
rhx keyrack relock --env test
```

this clears both `~/.aws/sso/cache/` (sso tokens) and `~/.aws/cli/cache/` (credentials).

then:

```sh
rhx keyrack unlock --env test
```

should:
1. detect session expired via `aws sts get-caller-identity` failure
2. trigger `aws sso login --sso-session <session-name> --use-device-code`
3. show device code in terminal (e.g., "enter this code: ABCD-EFGH")
4. open browser for device auth
5. complete after you approve in browser

note: the command uses `--sso-session` (not `--profile`) because multiple profiles may share one sso-session. keyrack reads the sso_session reference from your profile in `~/.aws/config`.

## step 4: test get flow

### 4a: after unlock (valid session)

```sh
rhx keyrack get --key ehmpathy.test.AWS_PROFILE --json
```

should return:

```json
{
  "status": "granted",
  "slug": "ehmpathy.test.AWS_PROFILE",
  "secret": "ehmpathy.dev"
}
```

### 4b: with expired session (no unlock)

force relock again:

```sh
rhx keyrack relock --env test
```

then:

```sh
rhx keyrack get --key ehmpathy.test.AWS_PROFILE --json
```

should return:

```json
{
  "status": "locked",
  "slug": "ehmpathy.test.AWS_PROFILE",
  "message": "vault 'aws.iam.sso' is locked",
  "fix": "run: rhx keyrack get --key ehmpathy.test.AWS_PROFILE --unlock"
}
```

**critical**: should NOT open browser. only `rhx keyrack unlock` should trigger browser auth.

## step 5: test in integration test

```sh
# source api keys for integration test env
source .agent/repo=.this/role=any/skills/use.apikeys.sh

# ensure sso session is valid
rhx keyrack unlock --env test

# run a test that uses AWS_PROFILE
npm run test:integration -- someTestThatUsesAws.integration.test.ts
```

## verification checklist

| scenario | expected | verified |
|----------|----------|----------|
| `keyrack set` interactive guided setup | prompts for sso url, region, browser auth, account, role, profile name | â˜ |
| `keyrack set` guided setup writes config | profile section in `~/.aws/config` | â˜ |
| `keyrack set` guided setup validates | `aws sts get-caller-identity` succeeds | â˜ |
| `keyrack set` stores profile name | profile in `~/.rhachet/keyrack.aws-iam-sso.json` | â˜ |
| `keyrack set` auto-updates repo manifest | key added to `.agent/keyrack.yml` without manual edit | â˜ |
| `keyrack set` for new env creates section | `env.$env:` section created in manifest | â˜ |
| `keyrack set` re-run does not duplicate | key appears once in manifest, not twice | â˜ |
| `keyrack list` shows aws.iam.sso vault | vault: aws.iam.sso in output | â˜ |
| `keyrack unlock` with valid session | exits 0, no browser | â˜ |
| `keyrack unlock` with expired session | opens browser, waits for approval | â˜ |
| `keyrack get` after unlock | status: granted, secret: profile name | â˜ |
| `keyrack get` without unlock | status: locked, no browser popup | â˜ |

## troubleshoot

### "profile not found"

check `~/.aws/config` has the profile:

```sh
cat ~/.aws/config | grep -A5 "\[profile ehmpathy.dev\]"
```

### "sso session expired" even after login

check cache file was created:

```sh
ls -la ~/.aws/sso/cache/
```

should have a `.json` file with recent timestamp.

### unlock hangs

browser may have opened in background. check for aws sso tab.

## cleanup

to remove the test key:

```sh
rhx keyrack del --key ehmpathy.test.AWS_PROFILE
```

to remove aws profile:

```sh
# edit ~/.aws/config and remove the [profile ehmpathy.dev] section
```

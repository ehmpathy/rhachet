# blackbox coverage matrix: keyrack extends

## matrix.1 = repo introspect publishes role resources

**command:** `rhachet repo introspect`

| ind: role.boot | ind: role.keyrack | dep: boot in manifest | dep: keyrack in manifest |
|----------------|-------------------|----------------------|-------------------------|
| declared       | declared          | ✓ included           | ✓ included              |
| declared       | absent            | ✓ included           | ✗ omitted               |
| absent         | declared          | ✗ omitted            | ✓ included              |
| absent         | absent            | ✗ omitted            | ✗ omitted               |

**coverage:** all combinations specified in usecases 1, 5

---

## matrix.2 = roles link symlinks role resources

**command:** `rhachet roles link --role $role`

| ind: role.boot | ind: role.keyrack | dep: boot.yml symlink | dep: keyrack.yml symlink | dep: link succeeds |
|----------------|-------------------|----------------------|-------------------------|-------------------|
| declared       | declared          | ✓ created            | ✓ created               | ✓ yes             |
| declared       | absent            | ✓ created            | ✗ not created           | ✓ yes             |
| absent         | declared          | ✗ not created        | ✓ created               | ✓ yes             |
| absent         | absent            | ✗ not created        | ✗ not created           | ✓ yes             |

**coverage:** all combinations specified in usecases 2, 5

---

## matrix.3 = keyrack get key lookup with extends

**command:** `keyrack get --key $KEY`

| ind: key in root | ind: key in extended | ind: extends path valid | dep: key found | dep: source |
|------------------|---------------------|------------------------|----------------|-------------|
| yes              | no                  | yes                    | ✓ yes          | root        |
| no               | yes                 | yes                    | ✓ yes          | extended    |
| yes              | yes                 | yes                    | ✓ yes          | root (override) |
| no               | no                  | yes                    | ✗ no           | error: not found |
| -                | -                   | no                     | ✗ no           | error: extended keyrack not found |

**coverage:** all combinations specified in usecases 3, 4

**note:** when both root and extended declare same key, root wins (local override)

---

## matrix.4 = keyrack get with multiple extends

**command:** `keyrack get --key $KEY` with `extends: [pathA, pathB]`

| ind: key in pathA | ind: key in pathB | ind: key in root | dep: key found | dep: source |
|-------------------|-------------------|------------------|----------------|-------------|
| yes               | no                | no               | ✓ yes          | pathA       |
| no                | yes               | no               | ✓ yes          | pathB       |
| yes               | yes               | no               | ✓ yes          | pathB (last wins) |
| no                | no                | yes              | ✓ yes          | root        |
| yes               | no                | yes              | ✓ yes          | root (root always wins) |

**coverage:** specified in usecases 4, 8

**semantics:** last-wins for extends array; root always wins over any extended

---

## matrix.5 = keyrack init --at validation

**command:** `keyrack init --at $path`

| ind: schema valid | ind: key specs complete | dep: exit code | dep: output |
|-------------------|------------------------|----------------|-------------|
| yes               | yes                    | 0              | success message |
| no                | -                      | non-zero       | schema violation error |
| yes               | no (lacks description) | non-zero       | "key $KEY lacks description" |
| yes               | no (lacks source)      | non-zero       | "key $KEY lacks source" |

**coverage:** specified in usecases 1, 6

---

## matrix.6 = org inheritance in extends

**command:** `keyrack get --key $KEY --json`

| ind: root org | ind: extended org | dep: key slug org prefix |
|---------------|-------------------|-------------------------|
| myorg         | ehmpathy          | myorg (root wins)       |
| myorg         | myorg             | myorg                   |

**coverage:** specified in usecase 7

**note:** org is never inherited from extended keyracks — root org is authoritative

---

## matrix.7 = circular extends detection

**command:** `keyrack get --key $KEY`

| ind: extends chain | dep: exit code | dep: error |
|--------------------|----------------|------------|
| root → A → B (no cycle) | 0 (if key found) | - |
| root → A → B → A (cycle) | non-zero | "circular extends detected" |
| root → A → root (self-ref) | non-zero | "circular extends detected" |

**coverage:** specified in usecase 9

---

## matrix.8 = recursive extends lookup

**command:** `keyrack get --key $KEY` with `root extends: [A]`, `A extends: [B]`

| ind: key in root | ind: key in A | ind: key in B | dep: key found | dep: source |
|------------------|---------------|---------------|----------------|-------------|
| yes              | -             | -             | ✓ yes          | root        |
| no               | yes           | -             | ✓ yes          | A           |
| no               | no            | yes           | ✓ yes          | B           |
| no               | yes           | yes           | ✓ yes          | A (closer wins) |
| no               | no            | no            | ✗ no           | error: not found |

**coverage:** specified in usecase 10

**semantics:** closer extends override deeper extends; root always wins

---

## decomposition notes

matrices are well-bounded (2-3 independent variables each). no decomposition needed.

# execution: keyrack extends

## phase 1: domain.objects updates

- [x] extend `Role` type with `boot?: { uri: string }` and `keyrack?: { uri: string }`
- [x] extend `RoleManifest` type with `keyrack?: { uri: string }`
- [x] extend `KeyrackRepoManifest` with `extends?: string[]`
- [x] verify: `npm run test:types`

## phase 2: repo introspect

- [x] extend `RoleManifestSerializable` with `boot?: string` and `keyrack?: string`
- [x] serialize boot path if `role.boot?.uri` present
- [x] serialize keyrack path if `role.keyrack?.uri` present
- [x] add acceptance tests for boot + keyrack in rhachet.repo.yml
- [x] verify: `npm run test:acceptance -- repo.introspect.acceptance.test.ts`

## phase 3: roles link

- [x] rename `symlinkReadme.ts` → `symlinkFile.ts`
- [x] update `execRoleLink` imports to use `symlinkFile`
- [x] symlink `boot.yml` if `role.boot?.uri` present
- [x] symlink `keyrack.yml` if `role.keyrack?.uri` present
- [x] create fixture `with-role-keyrack` (merged into with-role-boot-keyrack)
- [x] create fixture `with-role-boot-keyrack`
- [x] add integration tests for boot.yml + keyrack.yml symlinks
- [x] add acceptance tests for boot.yml + keyrack.yml symlinks
- [x] verify: `npm run test:integration -- execRoleLink.integration.test.ts`
- [x] verify: `npm run test:acceptance -- roles.link.acceptance.test.ts`

## phase 4: keyrack extends

- [x] add `extends?: z.array(z.string()).optional()` to keyrack schema
- [x] create `hydrate/` subdirectory in `daoKeyrackRepoManifest/`
- [x] implement `hydrateKeyrackRepoManifest.ts`
- [x] implement `loadManifestHydrated.ts`
- [x] implement `loadManifestExplicit.ts`
- [x] implement merge logic (last-wins, root wins)
- [x] implement circular detection via visited set
- [x] update `daoKeyrackRepoManifest/index.ts` get to use hydrate
- [x] create fixture `with-keyrack-extends`
- [x] create fixture `with-circular-extends`
- [x] create fixture `with-recursive-extends`
- [x] add integration tests for extends parse + merge (case8-12 in index.integration.test.ts)
- [x] add acceptance tests for extends chain lookup
- [x] verify: `npm run test:integration -- daoKeyrackRepoManifest`
- [x] verify: `npm run test:acceptance -- keyrack.extends.acceptance.test.ts`

note: unit tests for hydration functions were skipped since integration tests provide comprehensive coverage of hydration, merge logic, and circular detection. see index.integration.test.ts cases 8-12.

## phase 5: keyrack init --at

- [x] update `keyrack init` to accept `--at $path` option
- [x] create keyrack file at specified path
- [x] add acceptance tests for `--at` flag
- [x] verify: `npm run test:acceptance -- keyrack.init.acceptance.test.ts`

## final

- [x] verify: `npm run test`

note: all tests pass — types, lint, integration (16 keyrack tests, 3 execRoleLink tests), acceptance (40 init tests, 4 extends tests).

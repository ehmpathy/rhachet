# playtest: keyrack extends

manual verification of the keyrack-extends feature.

---

## setup

```sh
# create a temp directory for test
cd /tmp
mkdir keyrack-extends-playtest && cd keyrack-extends-playtest

# init git repo (required for rhachet)
git init
git config user.email "test@example.com"
git config user.name "Test User"

# create minimal package.json
echo '{ "name": "playtest", "type": "module" }' > package.json
```

---

## test 1: role with keyrack gets linked

### setup: create a fake rhachet-roles package

```sh
# create the package structure
mkdir -p node_modules/rhachet-roles-playtest/roles/tester/briefs
mkdir -p node_modules/rhachet-roles-playtest/roles/tester/skills

# create package.json
cat > node_modules/rhachet-roles-playtest/package.json << 'EOF'
{
  "name": "rhachet-roles-playtest",
  "version": "1.0.0",
  "main": "index.js"
}
EOF

# create rhachet.repo.yml with boot and keyrack
cat > node_modules/rhachet-roles-playtest/rhachet.repo.yml << 'EOF'
slug: playtest
readme: readme.md
roles:
  - slug: tester
    readme: roles/tester/readme.md
    briefs:
      dirs: roles/tester/briefs
    skills:
      dirs: roles/tester/skills
    boot: roles/tester/boot.yml
    keyrack: roles/tester/keyrack.yml
EOF

# create role readme
echo "# Tester Role" > node_modules/rhachet-roles-playtest/readme.md
echo "# Tester Role Readme" > node_modules/rhachet-roles-playtest/roles/tester/readme.md

# create boot.yml
cat > node_modules/rhachet-roles-playtest/roles/tester/boot.yml << 'EOF'
model: claude-sonnet
temperature: 0.7
EOF

# create keyrack.yml for the role
cat > node_modules/rhachet-roles-playtest/roles/tester/keyrack.yml << 'EOF'
org: playtest
env.test:
  - ROLE_API_KEY
EOF

# create a sample brief
echo "# Sample Brief" > node_modules/rhachet-roles-playtest/roles/tester/briefs/sample.md

# create a sample skill
cat > node_modules/rhachet-roles-playtest/roles/tester/skills/say-hello.sh << 'EOF'
#!/bin/bash
echo "hello from playtest!"
EOF
chmod +x node_modules/rhachet-roles-playtest/roles/tester/skills/say-hello.sh
```

### run: link the role

```sh
npx rhachet roles link --role tester
```

### verify

```sh
# check boot.yml symlink was created
ls -la .agent/repo=playtest/role=tester/boot.yml
# expect: symlink that points to node_modules/rhachet-roles-playtest/roles/tester/boot.yml

# check keyrack.yml symlink was created
ls -la .agent/repo=playtest/role=tester/keyrack.yml
# expect: symlink that points to node_modules/rhachet-roles-playtest/roles/tester/keyrack.yml

# verify content
cat .agent/repo=playtest/role=tester/boot.yml
# expect: model: claude-sonnet, temperature: 0.7

cat .agent/repo=playtest/role=tester/keyrack.yml
# expect: org: playtest, env.test: [ROLE_API_KEY]
```

**expect**: boot.yml and keyrack.yml symlinks exist and point to role source files

---

## test 2: keyrack extends inherits keys

### setup: create root keyrack.yml with extends

```sh
# create root keyrack that extends the role keyrack
cat > .agent/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/repo=playtest/role=tester/keyrack.yml
env.test:
  - LOCAL_KEY
EOF
```

### run: list keys

```sh
npx rhachet keyrack list
```

### verify

```sh
# should show both LOCAL_KEY (from root) and ROLE_API_KEY (from extended role keyrack)
npx rhachet keyrack list --json | jq '.hosts | keys'
```

**expect**: both `playtest.test.LOCAL_KEY` and `playtest.test.ROLE_API_KEY` should appear

---

## test 3: extends path validation

### setup: modify extends to point to non-existent file

```sh
cat > .agent/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/repo=nonexistent/role=fake/keyrack.yml
env.test:
  - LOCAL_KEY
EOF
```

### run: list keys (should fail)

```sh
npx rhachet keyrack list
```

**expect**: exits with error that mentions "extended keyrack not found"

---

## test 4: keyrack init --at creates role keyrack

### setup: reset for fresh test

```sh
rm -rf .agent/keyrack.yml
```

### run: init at custom path

```sh
npx rhachet keyrack init --at src/roles/custom/keyrack.yml
```

### verify

```sh
# check file was created
ls -la src/roles/custom/keyrack.yml
cat src/roles/custom/keyrack.yml
```

**expect**: keyrack.yml created at specified path with default org declaration

---

## test 5: deep extends chain

### setup: create chain A -> B -> C

```sh
# create pathB keyrack
mkdir -p .agent/pathB
cat > .agent/pathB/keyrack.yml << 'EOF'
org: playtest
env.test:
  - DEEP_KEY
EOF

# create pathA keyrack that extends pathB
mkdir -p .agent/pathA
cat > .agent/pathA/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/pathB/keyrack.yml
env.test:
  - MID_KEY
EOF

# create root that extends pathA
cat > .agent/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/pathA/keyrack.yml
env.test:
  - ROOT_KEY
EOF
```

### run: list keys

```sh
npx rhachet keyrack list --json | jq '.hosts | keys'
```

**expect**: should show ROOT_KEY, MID_KEY, and DEEP_KEY (all inherited through chain)

---

## test 6: circular extends detection

### setup: create circular reference

```sh
# pathA extends pathB
cat > .agent/pathA/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/pathB/keyrack.yml
env.test:
  - A_KEY
EOF

# pathB extends pathA (circular!)
cat > .agent/pathB/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/pathA/keyrack.yml
env.test:
  - B_KEY
EOF

# root extends pathA
cat > .agent/keyrack.yml << 'EOF'
org: playtest
extends:
  - .agent/pathA/keyrack.yml
env.test:
  - ROOT_KEY
EOF
```

### run: list keys (should fail)

```sh
npx rhachet keyrack list
```

**expect**: exits with error that mentions "circular extends detected"

---

## test 7: keyrack set --at adds key to custom keyrack

### setup: create a fresh role keyrack

```sh
# reset state
rm -rf .agent/pathA .agent/pathB .agent/keyrack.yml

# create a role keyrack at custom path
mkdir -p src/roles/custom
cat > src/roles/custom/keyrack.yml << 'EOF'
org: customorg
env.prod:
  - INITIAL_KEY
EOF
```

### run: set key at custom path

```sh
npx rhachet keyrack set --key NEW_ROLE_KEY --vault os.envvar --env prod --at src/roles/custom/keyrack.yml
```

### verify

```sh
# check key was added to the custom keyrack
cat src/roles/custom/keyrack.yml
# expect: env.prod section should contain both INITIAL_KEY and NEW_ROLE_KEY

# verify root keyrack was NOT created
ls .agent/keyrack.yml 2>/dev/null || echo "root keyrack not created (correct)"
```

**expect**: key added to custom keyrack at specified path; root keyrack unchanged

---

## cleanup

```sh
cd /tmp
rm -rf keyrack-extends-playtest
```

---

## summary

| test | feature | expect |
|------|---------|--------|
| 1 | role boot/keyrack link | symlinks created |
| 2 | extends inheritance | keys from extended keyrack available |
| 3 | extends validation | error on absent file |
| 4 | keyrack init --at | creates at custom path |
| 5 | deep extends chain | all keys inherited |
| 6 | circular detection | error on cycle |
| 7 | keyrack set --at | key added to custom keyrack |

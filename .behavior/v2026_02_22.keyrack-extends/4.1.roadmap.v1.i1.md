# roadmap: keyrack extends

## overview

execute the blueprint in 5 phases with ordered dependencies. each phase has acceptance criteria and verification steps.

---

## phase 1: domain.objects updates

### prereqs
- read: `3.1.research.patterns._.code.prod.v1.i1.md` (pattern.1, pattern.2, pattern.8)

### checklist

- [ ] extend `Role` type with `boot?: { uri: string }` and `keyrack?: { uri: string }`
- [ ] extend `RoleManifest` type with `keyrack?: { uri: string }`
- [ ] extend `KeyrackRepoManifest` with `extends?: string[]`

### verify

```bash
npm run test:types
```

types compile without errors.

---

## phase 2: repo introspect

### prereqs
- phase 1 complete
- read: `3.1.research.patterns._.code.prod.v1.i1.md` (pattern.3)
- read: `3.1.research.patterns._.code.test.v1.i1.md` (pattern.4)
- read: `2.1.criteria.blackbox.md` (usecase.1, usecase.5)

### checklist

- [ ] extend `RoleManifestSerializable` with `boot?: string` and `keyrack?: string`
- [ ] serialize boot path if `role.boot?.uri` present
- [ ] serialize keyrack path if `role.keyrack?.uri` present
- [ ] add acceptance tests for boot + keyrack in rhachet.repo.yml

### verify

```bash
npm run test:acceptance -- repo.introspect.acceptance.test.ts
```

criteria:
- usecase.1: repo introspect includes keyrack path
- usecase.5: repo introspect includes boot path

---

## phase 3: roles link

### prereqs
- phase 1 complete
- read: `3.1.research.patterns._.code.prod.v1.i1.md` (pattern.4, pattern.5)
- read: `3.1.research.patterns._.code.test.v1.i1.md` (pattern.3, pattern.9)
- read: `2.1.criteria.blackbox.md` (usecase.2, usecase.5)

### checklist

- [ ] rename `symlinkReadme.ts` → `symlinkFile.ts`
- [ ] update `execRoleLink` imports to use `symlinkFile`
- [ ] symlink `boot.yml` if `role.boot?.uri` present
- [ ] symlink `keyrack.yml` if `role.keyrack?.uri` present
- [x] create fixture `with-role-keyrack`
- [x] create fixture `with-role-boot-keyrack`
- [ ] add integration tests for boot.yml + keyrack.yml symlinks
- [ ] add acceptance tests for boot.yml + keyrack.yml symlinks

### verify

```bash
npm run test:integration -- execRoleLink.integration.test.ts
npm run test:acceptance -- roles.link.acceptance.test.ts
```

criteria:
- usecase.2: keyrack.yml symlink created when role declares keyrack
- usecase.5: boot.yml symlink created when role declares boot

---

## phase 4: keyrack extends

### prereqs
- phase 1 complete
- read: `3.1.research.patterns._.code.prod.v1.i1.md` (pattern.6)
- read: `3.1.research.patterns._.code.test.v1.i1.md` (pattern.6, pattern.8, pattern.10)
- read: `2.1.criteria.blackbox.md` (usecase.3, usecase.4, usecase.7, usecase.8, usecase.9, usecase.10)

### checklist

- [ ] add `extends?: z.array(z.string()).optional()` to keyrack schema
- [ ] create `hydrate/` subdirectory in `daoKeyrackRepoManifest/`
- [ ] implement `hydrateKeyrackRepoManifest.ts` with recursive extends traversal
- [ ] implement `loadManifestHydrated.ts` for file path → hydrated manifest
- [ ] implement `loadManifestExplicit.ts` for file path → raw manifest
- [ ] implement merge logic (last-wins for extends array, root wins over all)
- [ ] implement circular detection via visited set
- [ ] update `daoKeyrackRepoManifest/index.ts` get to use hydrate
- [x] create fixture `with-keyrack-extends`
- [x] create fixture `with-circular-extends`
- [x] create fixture `with-recursive-extends`
- [x] add unit tests for hydration, merge, circular detection
- [ ] add integration tests for extends parse + merge
- [x] add acceptance tests for extends chain lookup

### verify

```bash
npm run test:unit -- hydrateKeyrackRepoManifest.test.ts
npm run test:unit -- loadManifestHydrated.test.ts
npm run test:unit -- loadManifestExplicit.test.ts
npm run test:integration -- daoKeyrackRepoManifest
npm run test:acceptance -- keyrack.extends.acceptance.test.ts
```

criteria:
- usecase.3: key lookup via extends returns key spec from extended keyrack
- usecase.4: invalid extends path → clear error message
- usecase.7: full key spec inherited from extended keyrack
- usecase.8: last-wins for extends array, root wins over all
- usecase.9: circular extends → clear error message
- usecase.10: recursive extends chains followed

---

## phase 5: keyrack init --at

### prereqs
- read: `3.1.research.patterns._.code.test.v1.i1.md` (pattern.5)
- read: `2.1.criteria.blackbox.md` (usecase.6)

### checklist

- [ ] update `keyrack init` to accept `--at $path` option
- [ ] create keyrack file at specified path (same as default init, different location)
- [ ] add acceptance tests for `--at` flag

### verify

```bash
npm run test:acceptance -- keyrack.init.acceptance.test.ts
```

criteria:
- usecase.6: `keyrack init --at` creates keyrack at specified path

---

## final verification

after all phases complete:

```bash
npm run test
```

all tests pass. criteria coverage complete.

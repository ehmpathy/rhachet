# roadmap: keyrack aws sso portal flow fix

## overview

this roadmap tracks implementation of the portal flow fix. each phase has:
- ordered dependencies (must complete prior phases first)
- required read before start
- acceptance criteria
- verification steps

---

## status

| phase | scope | depends on | status |
|-------|-------|------------|--------|
| 0 | file move | — | done |
| 1 | fix vault adapter triggerSsoLogin | phase 0 | done |
| 2 | wire vault.set() to setupAwsSsoProfile | phase 1 | done (cli orchestrates) |
| 3 | simplify unlock() | phase 1 | done |
| 4 | update tests | phase 1, 2, 3 | done |
| 5 | roundtrip validation at keyrack set | phase 1-4 | done |
| 6 | update tests for roundtrip | phase 5 | done |

---

## phase 0: file move

### why

setupAwsSsoProfile is only relevant to vaultAdapterAwsIamSso. colocate it.

### tasks

- [ ] move `setupAwsSsoProfile.ts` to `adapters/vaults/`
  - from: `src/domain.operations/keyrack/setupAwsSsoProfile.ts`
  - to: `src/domain.operations/keyrack/adapters/vaults/setupAwsSsoProfile.ts`

- [ ] move `setupAwsSsoProfile.test.ts` to `adapters/vaults/`
  - from: `src/domain.operations/keyrack/setupAwsSsoProfile.test.ts`
  - to: `src/domain.operations/keyrack/adapters/vaults/setupAwsSsoProfile.test.ts`

- [ ] move `setupAwsSsoProfile.interactive.test.ts` to `adapters/vaults/`
  - from: `src/domain.operations/keyrack/setupAwsSsoProfile.interactive.test.ts`
  - to: `src/domain.operations/keyrack/adapters/vaults/setupAwsSsoProfile.interactive.test.ts`

- [ ] update imports in vaultAdapterAwsIamSso.ts
  - change: relative import path to colocated file

- [ ] verify build
  - run: `npm run build`

### verification

```sh
npm run build
npm run test:types
# expect: no import errors
```

---

## phase 1: fix vault adapter triggerSsoLogin

### required read

- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/1.vision.md` — portal vs programmatic flow
- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/3.3.blueprint.v1.i1.md` — the fix

### the bug

current code at `vaultAdapterAwsIamSso.ts:153`:
```ts
['sso', 'login', '--sso-session', ssoSessionName, '--use-device-code'],
```

triggers **programmatic flow** = "Allow access to botocore-client-{name}?" prompt.

### tasks

- [ ] fix `triggerSsoLogin` to use `--profile` flag
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.ts`
  - change: `['sso', 'login', '--sso-session', ssoSessionName, '--use-device-code']`
  - to: `['sso', 'login', '--profile', profileName]`

- [ ] update `triggerSsoLogin` signature
  - change: `triggerSsoLogin(ssoSessionName: string)`
  - to: `triggerSsoLogin(profileName: string)`

- [ ] remove `--use-device-code` flag
  - not needed for portal flow

- [ ] delete `getSsoSessionForProfile()` function
  - no longer needed with `--profile` flag

### acceptance criteria

```
browser: standard "Sign in" / "Allow" ✓
browser: NO "botocore-client-{name}" ✓
```

### verification

```sh
npm run test:types
# manual: rhx keyrack unlock --env test
# expect: portal flow in browser, no botocore-client prompt
```

---

## phase 2: wire vault.set() to setupAwsSsoProfile

### required read

- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/3.3.blueprint.v1.i1.md` — contracts section

### tasks

- [ ] update `vault.set()` to call `setupAwsSsoProfile()`
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.ts`
  - change: set() calls setupAwsSsoProfile() for interactive setup
  - then: stores result.profileName in vault storage

- [ ] ensure setupAwsSsoProfile returns profileName
  - file: `src/domain.operations/keyrack/adapters/vaults/setupAwsSsoProfile.ts`
  - verify: returns `{ profileName: string }` or similar

### acceptance criteria

```sh
rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso
# expect: runs interactive setup via setupAwsSsoProfile
# expect: portal flow in browser
# expect: profile stored in vault
```

### verification

```sh
npm run test:unit -- vaultAdapterAwsIamSso
# manual: rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso
```

---

## phase 3: simplify unlock()

### tasks

- [ ] simplify `unlock()` to use `triggerSsoLogin(profileName)`
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.ts`
  - remove: getSsoSessionForProfile() calls
  - remove: legacy config rejection logic
  - keep: validate via sts get-caller-identity
  - keep: triggerSsoLogin(profileName) for expired sessions

### acceptance criteria

set and unlock use same auth mechanism:
- both use `--profile` flag
- both show portal flow
- identical user experience

```sh
rhx keyrack unlock --env test
# expect: portal flow in browser
# expect: NO botocore-client prompt
```

### verification

```sh
npm run test:unit -- vaultAdapterAwsIamSso
# manual: rhx keyrack unlock --env test
```

---

## phase 4: update tests

### tasks

- [ ] update vault adapter tests for set() that calls setupAwsSsoProfile
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.test.ts`
  - update: set() test expectations

- [ ] remove `--sso-session` expectations everywhere
  - files: all test files that reference sso login
  - change: `--sso-session` → `--profile`

- [ ] remove `--use-device-code` expectations everywhere
  - files: all test files that reference device code
  - remove: expectations for this flag

- [ ] update setupAwsSsoProfile tests
  - file: `src/domain.operations/keyrack/adapters/vaults/setupAwsSsoProfile.test.ts`
  - file: `src/domain.operations/keyrack/adapters/vaults/setupAwsSsoProfile.interactive.test.ts`
  - update: import paths after move

### verification

```sh
npm run test:unit -- vaultAdapterAwsIamSso
npm run test:unit -- setupAwsSsoProfile
npm run test:integration -- vaultAdapterAwsIamSso
# expect: all tests pass
```

---

## phase 5: roundtrip validation at keyrack set

### required read

- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/3.3.blueprint.v1.i1.md` — primary requirement section
- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/3.5.blueprint.roundtrip-validation.v1.i1.md` — full details
- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/5.lesson.aws-sso-registration-scopes.md` — one-time OAuth discovery

### the insight

the "botocore-client" OAuth prompt is a **one-time registration** per sso-session. with roundtrip validation at set:
- OAuth registration happens at setup (user expects prompts at setup)
- future `keyrack unlock` uses portal flow (no surprises)

### separation of concerns

**vault adapters = atomic operations** (no change)
- `set`: store a value
- `get`: retrieve a value
- `unlock`: refresh/activate session
- `relock`: clear session

**keyrack set command = orchestration + validation** (new)
- calls vault adapter methods in sequence
- validates roundtrip works before return of success
- fails fast if any step fails

### tasks

- [ ] update `setKeyrackKeyHost` to orchestrate roundtrip
  - file: `src/domain.operations/keyrack/setKeyrackKeyHost.ts`
  - after vault.set(), call:
    1. `vault.unlock({ slug })`
    2. `vault.get({ slug })` — verify value matches
    3. `vault.relock({ slug })`
  - fail fast if any step fails

- [ ] apply to ALL vaults, not just aws.iam.sso
  - roundtrip validation is vault-agnostic
  - guarantees: if `keyrack set` succeeds, the key works

### acceptance criteria

```
keyrack set
├── 1. vault.set(slug, value)     → store the key
├── 2. vault.unlock({ slug })     → triggers one-time OAuth (aws.iam.sso)
├── 3. vault.get({ slug })        → prove retrirhachet completion --setupworks
└── 4. vault.relock({ slug })     → clear session, leave locked
```

### verification

```sh
# manual: keyrack set with new profile
rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso
# expect: OAuth prompt at setup (one-time)
# expect: roundtrip completes successfully

# manual: relock and unlock
rhx keyrack relock --env test
rhx keyrack unlock --env test
# expect: portal flow (no OAuth prompt)
```

---

## phase 6: update tests for roundtrip

### required read

- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/2.1.criteria.blackbox.md` — acceptance criteria

### tasks

- [ ] add roundtrip tests to setKeyrackKeyHost.test.ts
  - file: `src/domain.operations/keyrack/setKeyrackKeyHost.test.ts`
  - test: set calls vault.set → vault.unlock → vault.get → vault.relock
  - test: set fails if vault.unlock fails
  - test: set fails if vault.get fails
  - test: set fails if vault.relock fails

- [ ] update integration tests for roundtrip
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.integration.test.ts`
  - verify: OAuth at set, portal at unlock

### verification

```sh
npm run test:unit -- setKeyrackKeyHost
npm run test:integration -- vaultAdapterAwsIamSso
# expect: all tests pass
```

---

## completion checklist

- [x] phase 0: file move complete
- [x] phase 1: fix vault adapter triggerSsoLogin complete
- [x] phase 2: wire vault.set() to setupAwsSsoProfile complete (cli orchestrates)
- [x] phase 3: simplify unlock() complete
- [x] phase 4: update tests complete
- [x] phase 5: roundtrip validation at keyrack set
- [x] phase 6: update tests for roundtrip
- [x] all types compile: `npm run test:types`
- [x] all unit tests pass: `npm run test:unit`
- [x] all integration tests pass: `npm run test:integration`
- [ ] manual verification: OAuth at set, portal at unlock

---

## manual verification

after all phases complete:

```sh
# step 1: set up NEW profile (triggers one-time OAuth registration)
rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso
# browser: "Allow access to botocore-client-{profile-name}?" (one-time, at setup)
# user approves → OAuth client registered
# roundtrip validated: unlock → get → relock

# step 2: force relock
rhx keyrack relock --env test

# step 3: unlock (should show portal flow, NOT botocore-client)
rhx keyrack unlock --env test
# browser: standard "Sign in" / "Allow" ✓
# browser: NO "botocore-client-{name}" ✓
```

---

## notes

- no new npm dependencies required
- the fix is one flag change: `--sso-session` → `--profile`
- the key insight: `--profile` triggers portal flow, `--sso-session` triggers boto flow
- setupAwsSsoProfile already uses correct `--profile` flag at line 92
- only vaultAdapterAwsIamSso.ts:153 has the bug

### one-time OAuth registration

- "botocore-client" OAuth prompt is **one-time** per sso-session
- once approved, subsequent unlocks use portal flow
- roundtrip validation at set ensures OAuth registration happens at setup time
- see: `.behavior/v2026_02_16.keyrack-aws-noboto/5.lesson.aws-sso-registration-scopes.md`

### pit of success

keyrack set validates roundtrip for ALL vaults:
- `vault.set(slug, value)` → store
- `vault.unlock({ slug })` → prove unlock works (triggers OAuth for aws.iam.sso)
- `vault.get({ slug })` → prove get works
- `vault.relock({ slug })` → leave locked

if `keyrack set` succeeds, the key is guaranteed to work.

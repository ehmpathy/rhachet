# criteria: keyrack aws sso blackbox

## primary requirement: roundtrip validation at set

`keyrack set` must validate the full roundtrip before success. this applies to ALL vaults.

```
given('keyrack set is called')
  when('set completes successfully')
    then('vault.set was called')
      sothat('key is stored')
    then('vault.unlock was called')
      sothat('unlock is proven to work')
      sothat('for aws.iam.sso: one-time OAuth registration happens at setup')
    then('vault.get was called')
      sothat('retrirhachet completion --setupis proven to work')
    then('vault.relock was called')
      sothat('session is cleared after setup')
      sothat('vault is left in locked state')

given('keyrack set is called')
  when('any roundtrip step fails')
    then('keyrack set fails')
      sothat('misconfigured keys fail fast at setup, not at unlock time')
```

## usecase.1 = keyrack set (first time setup)

```
given('user has not set up aws profile via keyrack')
  when('user runs: rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso')
    then('keyrack prompts for sso start url')
    then('keyrack prompts for account')
    then('keyrack prompts for role')
    then('keyrack prompts for profile name')
    then('browser opens for OAuth registration (one-time)')
      sothat('botocore-client is registered at setup time, not at unlock time')
    then('keyrack stores profile name in vault')
    then('keyrack validates roundtrip (unlock, get, relock)')
    then('keyrack reports success')

given('user has not set up aws profile via keyrack')
  when('user cancels OAuth prompt in browser')
    then('keyrack set fails')
      sothat('user knows the key was not configured')
```

## usecase.2 = keyrack unlock (subsequent auth)

```
given('user has previously set up aws profile via keyrack')
given('session has expired')
  when('user runs: rhx keyrack unlock --env test')
    then('browser opens with portal flow (standard "Sign in" / "Allow")')
      sothat('user sees familiar aws sso signin, not botocore-client prompt')
    then('keyrack reports success')

given('user has previously set up aws profile via keyrack')
given('session is still valid')
  when('user runs: rhx keyrack unlock --env test')
    then('no browser opens')
    then('keyrack reports already unlocked')
```

## usecase.3 = keyrack relock

```
given('user has an unlocked aws profile')
  when('user runs: rhx keyrack relock --env test')
    then('session is cleared')
    then('subsequent unlock requires re-auth')
```

## usecase.4 = keyrack get

```
given('user has set up aws profile via keyrack')
given('session is unlocked')
  when('user runs: rhx keyrack get --key AWS_PROFILE --env test')
    then('keyrack returns the profile name')

given('user has set up aws profile via keyrack')
given('session is locked')
  when('user runs: rhx keyrack get --key AWS_PROFILE --env test')
    then('keyrack fails with locked error')
      sothat('user knows to unlock first')
```

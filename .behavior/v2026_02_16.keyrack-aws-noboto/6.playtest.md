# playtest: keyrack aws.iam.sso vault

## prereqs

- branch: `vlad/keyrack-sudo`
- build: `npm run build`
- aws cli v2 installed (`aws --version`)
- access to an aws sso portal (e.g., `https://ehmpathy.awsapps.com/start`)

## option a: interactive guided setup

```sh
# 1. init keyrack
./bin/run keyrack init

# 2. set aws.iam.sso key — no --exid triggers guided wizard inside vault adapter
./bin/run keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso

# wizard flow:
#   - which sso domain? (picks from ~/.aws/config or enter new url)
#   - browser auth (portal flow: "Sign in" / "Allow", NOT "botocore-client-*")
#   - which account? (enumerated via aws api)
#   - which role? (enumerated via aws api)
#   - what should we call it? (suggested: $org.$accountSuffix)
#   - lets vault it now... (writes to ~/.aws/config)

# 3. verify stored
./bin/run keyrack list
# expect: ehmpathy.test.AWS_PROFILE with vault: aws.iam.sso

# 4. verify profile store
cat ~/.rhachet/keyrack.aws-iam-sso.json | jq
# expect: entry with profileName that matched what you chose

# 5. verify keyrack.yml updated
cat .agent/keyrack.yml
# expect: AWS_PROFILE under env.test
```

## option b: pre-configured profile

```sh
# 1. init keyrack (if not done)
./bin/run keyrack init

# 2. set with --exid to skip wizard
./bin/run keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso --exid ehmpathy.dev

# 3. verify stored
./bin/run keyrack list --json | jq
```

## unlock + get roundtrip

```sh
# 1. get before unlock — expect status: locked, no browser popup
./bin/run keyrack get --key AWS_PROFILE --env test --json

# 2. unlock — validates sso session, triggers browser login if expired
./bin/run keyrack unlock --env test

# 3. get after unlock — expect status: granted, secret: profile name
./bin/run keyrack get --key AWS_PROFILE --env test --json

# 4. relock — clears ~/.aws/sso/cache and ~/.aws/cli/cache
./bin/run keyrack relock --env test

# 5. get after relock — expect status: locked again
./bin/run keyrack get --key AWS_PROFILE --env test --json
```

## critical checks

| check | expected |
|-------|----------|
| guided setup uses portal flow | browser shows "Sign in" / "Allow" (NOT "botocore-client-*") |
| guided setup writes ~/.aws/config | `[profile $name]` section with sso fields |
| guided setup stores profile name | entry in `~/.rhachet/keyrack.aws-iam-sso.json` |
| `keyrack set` updates keyrack.yml | key added to `env.test:` section |
| `keyrack get` without unlock | status: locked, NO browser popup |
| `keyrack unlock` with expired session | triggers `aws sso login --profile` (portal flow) |
| `keyrack unlock` with valid session | exits 0, no browser |
| `keyrack get` after unlock | status: granted, secret: profile name |
| `keyrack relock` then get | status: locked |
| guided setup lives in vault adapter | no vault imports in invokeKeyrack.ts |

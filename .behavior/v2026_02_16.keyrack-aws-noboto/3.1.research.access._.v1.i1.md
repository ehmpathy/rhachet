# research: remote access for aws sso keyrack

## remote repositories

### 1. aws sso portal (browser)

**what**: aws identity center web portal for human authentication
**interface**: browser redirect flow
**contract**: user signs in via standard web form, clicks "allow"

no api client registration. no oauth client. just browser signin.

### 2. aws sso api (list accounts/roles)

**what**: aws sso portal api for account/role enumeration
**interface**: aws cli subprocess
**contract**:

```
GET /assignment/accounts
Header: x-amz-sso_bearer_token: {access_token}
Response: { accountList: [{ accountId, accountName, emailAddress }] }
```

```
GET /assignment/roles?account_id={accountId}
Header: x-amz-sso_bearer_token: {access_token}
Response: { roleList: [{ accountId, roleName }] }
```

**citation [1]**: [ListAccounts API](https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/API_ListAccounts.html)
> "Lists all AWS accounts assigned to the user."

**citation [2]**: [ListAccountRoles API](https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/API_ListAccountRoles.html)
> "Lists all roles that are assigned to the user for a given AWS account."

### 3. aws sts api (validate session)

**what**: aws security token service for credential validation
**interface**: aws cli subprocess
**contract**:

```sh
aws sts get-caller-identity --profile $profileName
```

returns account id, user arn, user id if session valid. throws if expired.

### 4. aws credentials export

**what**: export temporary credentials from sso session
**interface**: aws cli subprocess
**contract**:

```sh
aws configure export-credentials --profile $profileName --format env-no-export
```

returns `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN` with expiration.

### 5. local filesystem

**what**: aws config and sso cache
**paths**:
- `~/.aws/config` - profile definitions
- `~/.aws/sso/cache/` - cached access tokens

## best practices

### industry: aws "legacy" is actually cleaner for explicit auth

aws docs call inline profile config "legacy" because it lacks auto-refresh. but for explicit auth flows (like keyrack unlock), auto-refresh is undesired.

**citation [3]**: [AWS CLI SSO Configuration](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html)
> "Automated token refresh isn't supported with the legacy non-refreshable configuration."

this is a feature, not a bug. keyrack wants:
1. tokens to expire naturally
2. user to explicitly re-authenticate via `unlock`
3. no surprise browser popups

### industry: inline profile = standard human signin

when a human runs `aws configure sso` wizard, they get the sso-session format with oauth client registration. but when keyrack creates inline profiles manually, users see standard "allow signin" - identical to what they'd see in aws console.

the "legacy" flow is the same flow humans use when they visit the aws sso portal directly in a browser.

### within this repo: aws cli subprocess

keyrack uses aws cli as subprocess rather than direct api calls because:
1. aws cli handles browser integration
2. aws cli manages token cache
3. aws cli is already installed (prerequisite)
4. no additional sdk dependencies

```typescript
// login via profile - standard browser signin
execSync(`aws sso login --profile "${profileName}"`, { stdio: 'inherit' });

// list accounts - uses cached token
execSync(`aws sso list-accounts --access-token "${token}" --region "${region}"`);

// validate session
execSync(`aws sts get-caller-identity --profile "${profileName}"`);
```

## access flow summary

### setup (`rhx keyrack set`)

1. create temp inline profile in temp dir
2. `aws sso login --profile keyrack-temp` → browser signin
3. read access token from `~/.aws/sso/cache/`
4. `aws sso list-accounts` → enumerate accounts
5. `aws sso list-account-roles` → enumerate roles
6. write permanent inline profile to `~/.aws/config`

### unlock (`rhx keyrack unlock`)

1. for each stored profile:
2. `aws sts get-caller-identity --profile $name` → check if valid
3. if expired: `aws sso login --profile $name` → browser signin

### grant (`rhx keyrack get`)

1. `aws sts get-caller-identity --profile $name` → validate session
2. if expired: throw "unlock required"
3. `aws configure export-credentials --profile $name` → get temp creds

## sources

1. [ListAccounts API Reference](https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/API_ListAccounts.html)
2. [ListAccountRoles API Reference](https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/API_ListAccountRoles.html)
3. [AWS CLI SSO Configuration Guide](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html)
4. [AWS CLI SSO Login Reference](https://docs.aws.amazon.com/cli/latest/reference/sso/login.html)

# execution: keyrack aws sso portal flow fix

## progress

| phase | scope | status |
|-------|-------|--------|
| 0 | file move | ✓ done |
| 1 | fix vault adapter triggerSsoLogin | ✓ done |
| 2 | wire vault.set() to setupAwsSsoProfile | ✓ done |
| 3 | simplify unlock() | ✓ done |
| 4 | update tests | ✓ done |
| 5 | roundtrip validation at keyrack set | ✓ done |
| 6 | update tests for roundtrip | ✓ done |

---

## phase 5: roundtrip validation at keyrack set

### required read

- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/3.3.blueprint.v1.i1.md` — primary requirement
- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/3.5.blueprint.roundtrip-validation.v1.i1.md` — full details
- [ ] `.behavior/v2026_02_16.keyrack-aws-noboto/5.lesson.aws-sso-registration-scopes.md` — one-time OAuth

### tasks

- [x] read implementation to understand current flow
  - file: `src/contract/cli/invokeKeyrack.ts` (keyrack set command)
  - file: `src/domain.operations/keyrack/setKeyrackKeyHost.ts` (only manages host manifest)
  - note: roundtrip goes in CLI command, not in setKeyrackKeyHost

- [x] update `invokeKeyrack.ts` to orchestrate roundtrip after vault.set()
  - file: `src/contract/cli/invokeKeyrack.ts` (lines 667-714)
  - after vault.set(), calls:
    1. `vault.unlock({})` — triggers one-time OAuth registration
    2. `vault.get({ slug })` — verify value matches what we set
    3. `vault.relock({ slug })` — clear session, leave locked
  - fail fast if get returns different value

- [x] verify roundtrip applies to ALL vaults
  - currently only aws.iam.sso calls vault.set() in keyrack set
  - roundtrip is inside the aws.iam.sso block (correct for now)
  - other vaults can be extended later as needed

- [x] verify build
  - `npm run test:types` ✓
  - `npm run build` ✓

### verification

- [ ] manual test: `rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso`
  - expect: OAuth prompt at setup (one-time)
  - expect: roundtrip completes (unlock → get → relock)

- [ ] manual test: `rhx keyrack relock --env test && rhx keyrack unlock --env test`
  - expect: portal flow (no OAuth prompt)

---

## phase 6: update tests for roundtrip

### required read

- [x] `.behavior/v2026_02_16.keyrack-aws-noboto/2.1.criteria.blackbox.md` — acceptance criteria

### tasks

- [x] note: roundtrip is in CLI command (`invokeKeyrack.ts`), not `setKeyrackKeyHost.ts`
  - `setKeyrackKeyHost.ts` only manages host manifest, no vault calls
  - roundtrip tests would need to mock entire CLI flow

- [x] note: aws sso roundtrip cannot be automated (requires human browser auth)
  - unit tests in `vaultAdapterAwsIamSso.test.ts` cover unlock/get/relock individually
  - integration tests require manual verification (human must approve browser auth)

- [x] update `vaultAdapterAwsIamSso.integration.test.ts`
  - file: `src/domain.operations/keyrack/adapters/vaults/vaultAdapterAwsIamSso.integration.test.ts`
  - added: documentation of roundtrip validation behavior
  - added: manual verification steps for OAuth at set, portal at unlock

### verification

- [x] `npm run test:unit` — all 232 tests pass
- [x] `npm run test:types` — compiles clean
- [x] `npm run build` — builds successfully

---

## final verification

- [x] all types compile: `npm run test:types` ✓
- [x] all unit tests pass: `npm run test:unit` ✓ (232 tests)
- [x] all integration tests pass: `npm run test:integration` ✓ (37 tests)
- [ ] manual test complete: OAuth at set, portal at unlock
  - `rhx keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso`
  - `rhx keyrack relock --env test && rhx keyrack unlock --env test`

# blueprint: keyrack set stdout redesign

## goal

sleeker, more consistent, more modern interactive stdout for `rhx keyrack set`

## design principles

- keep questions (friendly, conversational)
- tighter vertical rhythm (fewer blank lines)
- prompts show default in brackets
- confirmations are concise
- consistent tree characters
- prerequisites collapse to top

## before (current)

```
ğŸ” keyrack set AWS_PROFILE

   â”œâ”€ âœ“ aws cli installed
   â”‚
   â”œâ”€ âœ“ found 1 sso portal in ~/.aws/config
   â”‚
   â”œâ”€ which sso domain?
   â”‚
   â”‚  options found:
   â”‚    1. https://d-906617ed8b.awsapps.com/start (us-east-1)
   â”‚
   â”‚  reuse one? enter the number. otherwise, enter a custom url.
   â”‚
   â”‚  choice: 1
   â”‚
   â”‚  âœ“ sso_start_url = https://d-906617ed8b.awsapps.com/start
   â”‚  âœ“ sso_region = us-east-1
   â”‚
   â”œâ”€ which sso login?
   â”‚
   â”‚  â³ open browser for device auth...
   â”‚

  ğŸ”— https://d-906617ed8b.awsapps.com/start/#/device
  ğŸ”‘ code: CVFW-QKVW

  âœ“ authenticated

   â”‚
   â”‚  âœ“ browser auth approved
   â”‚
   â”œâ”€ which account?
   â”‚
   â”‚    1. 805192865516 Â· ehmpathy-demo Â· vlad+ehmpathy.demo@ahbode.com
   â”‚
   â”‚  choice: 1
   â”‚
   â”‚  âœ“ sso_account_id = 805192865516
   â”‚
   â”œâ”€ which role?
   â”‚
   â”‚    1. ehmpathy-demo-sso
   â”‚
   â”‚  choice: 1
   â”‚
   â”‚  âœ“ sso_role_name = ehmpathy-demo-sso
   â”‚
   â”œâ”€ what should we call it?
   â”‚
   â”‚  suggested: ehmpathy.demo
   â”‚  accept or enter custom:
   â”‚
   â”‚  âœ“ profile = ehmpathy.demo
   â”‚
   â”œâ”€ âœ“ profile found in ~/.aws/config (equivalent)
   â”‚
   â””â”€ done
```

## after (proposed)

```
ğŸ” keyrack set AWS_PROFILE

   âœ“ aws cli
   âœ“ 1 sso portal in ~/.aws/config

   â”Œâ”€ which sso portal?
   â”‚
   â”‚    1. https://d-906617ed8b.awsapps.com/start (us-east-1)
   â”‚
   â”‚  [1] or url: 1
   â”‚
   â”‚  âœ“ https://d-906617ed8b.awsapps.com/start
   â”‚  âœ“ us-east-1
   â”‚
   â”œâ”€ which sso login?
   â”‚
   â”‚  â³ browser auth...
   â”‚
   â”‚  ğŸ”— https://d-906617ed8b.awsapps.com/start/#/device
   â”‚  ğŸ”‘ CVFW-QKVW
   â”‚
   â”‚  âœ“ approved
   â”‚
   â”œâ”€ which account?
   â”‚
   â”‚    1. 805192865516 Â· ehmpathy-demo Â· vlad+ehmpathy.demo@ahbode.com
   â”‚
   â”‚  [1]: 1
   â”‚
   â”‚  âœ“ 805192865516 Â· ehmpathy-demo
   â”‚
   â”œâ”€ which role?
   â”‚
   â”‚    1. ehmpathy-demo-sso
   â”‚
   â”‚  [1]: 1
   â”‚
   â”‚  âœ“ ehmpathy-demo-sso
   â”‚
   â”œâ”€ what profile name?
   â”‚
   â”‚  [ehmpathy.demo]:
   â”‚
   â”‚  âœ“ ehmpathy.demo
   â”‚
   â””â”€ done

   âœ“ ~/.aws/config updated
   âœ“ session valid
```

## changes summary

| aspect | before | after |
|--------|--------|-------|
| prerequisites | inline with `â”œâ”€` | collapsed checkmarks at top |
| tree start | `â”œâ”€` (mid-branch) | `â”Œâ”€` (start) |
| verbose prompt | "reuse one? enter the number. otherwise, enter a custom url." | `[1] or url:` |
| prompt label | `choice:` | `[default]:` |
| profile prompt | "what should we call it?" + "suggested: X" + "accept or enter custom:" | "what profile name?" + `[default]:` |
| confirmations | `âœ“ sso_start_url = X` | `âœ“ X` (value only) |
| confirmations | `âœ“ sso_account_id = 805192865516` | `âœ“ 805192865516 Â· ehmpathy-demo` (id + name) |
| browser output | breaks tree indentation | stays inside tree |
| final status | "âœ“ profile found in ~/.aws/config (equivalent)" | `âœ“ ~/.aws/config updated` |
| blank lines | many `â”‚` spacers | tighter rhythm |

## implementation notes

### prompt format

```ts
// before
const answer = await promptUser('   â”‚  choice: ');

// after
const answer = await promptUser(`   â”‚  [${defaultValue}]: `);
// or for url fallback:
const answer = await promptUser(`   â”‚  [${defaultIndex}] or url: `);
```

### prerequisites section

```ts
// before: inline with tree
console.log('   â”œâ”€ âœ“ aws cli installed');
console.log('   â”‚');
console.log('   â”œâ”€ âœ“ found 1 sso portal in ~/.aws/config');
console.log('   â”‚');

// after: collapsed at top, then tree starts
console.log('   âœ“ aws cli');
console.log(`   âœ“ ${portalsFound.length} sso portal${portalsFound.length !== 1 ? 's' : ''} in ~/.aws/config`);
console.log('');
console.log('   â”Œâ”€ which sso portal?');
```

### tree characters

```ts
const TREE = {
  START: 'â”Œâ”€',
  MID: 'â”œâ”€',
  END: 'â””â”€',
  PIPE: 'â”‚',
};
```

### browser auth output

the aws cli outputs directly via `stdio: 'inherit'`. to keep it inside the tree:

1. capture output and reformat (complex)
2. accept the break but make it cleaner
3. use a wrapper that prefixes each line

option 2 (accept + clean) is simplest:

```ts
// before aws cli call
console.log('   â”‚');
console.log('   â”‚  â³ browser auth...');
console.log('   â”‚');

// aws cli outputs here (breaks tree)

// after aws cli returns
console.log('   â”‚');
console.log('   â”‚  âœ“ approved');
```

## open questions

1. should confirmations show key names or just values?
   - current: `âœ“ sso_start_url = https://...`
   - proposed: `âœ“ https://...`
   - alternative: dim the key `âœ“ sso_start_url Â· https://...`

2. should we use colors/dim for secondary info?
   - e.g., dim the account email, bright the account name

3. tree break at browser auth â€” acceptable or worth complex fix?

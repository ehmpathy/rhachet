# lesson: aws sso oauth client registration

## discovery

the "botocore-client" OAuth prompt is a **one-time registration** per sso-session. once approved, subsequent unlocks use portal flow.

## the flow

### first auth (one-time)

1. `aws sso login --profile X` triggers OAuth client registration
2. browser shows: "Allow access to botocore-client-{session-name}?"
3. user clicks "Allow"
4. OAuth client is registered and cached

### subsequent auths

1. `aws sso login --profile X` finds cached OAuth client
2. browser shows: standard "Sign in" / "Allow" portal flow
3. no "botocore-client" prompt

## implications for keyrack

### the problem

users see "botocore-client" prompt and get confused/suspicious at `keyrack set`. but if they approve it, `keyrack unlock` works smoothly forever after.

### the solution

at `keyrack set`, after profile is written:
1. trigger unlock (forces OAuth client registration)
2. trigger relock (clears session)
3. trigger unlock again (proves roundtrip works with portal flow)

this ensures:
- OAuth client is registered at setup (user expects prompts at setup)
- future `keyrack unlock` calls use portal flow (no surprises)
- roundtrip is validated (fail-fast if profile is misconfigured)

### vault interface mandate

all vault adapters should validate roundtrip at `set`:
```ts
vault.set(slug, value)
  → vault.unlock()      // prove we can unlock
  → vault.relock()      // clear session
  → vault.unlock()      // prove unlock works again (portal flow)
```

## client name customization

### research result

the OAuth client name `botocore-client-{session-name}` is **hardcoded** in the AWS CLI. there is no config option to customize it independently from the sso-session name.

### how it works

the AWS CLI uses the SSO OIDC `RegisterClient` API to register OAuth clients. the client name is constructed as:

```
clientName = "botocore-client-" + sso_session_name
```

this happens in the botocore library, not in user-configurable space.

### options

| option | feasibility | notes |
|--------|-------------|-------|
| config option | not available | no `sso_client_name` config field exists |
| env var override | not available | no `AWS_SSO_CLIENT_NAME` var exists |
| fork AWS CLI | impractical | maintenance burden, version drift |
| use SSO OIDC API directly | complex | would bypass CLI entirely, lots of code |
| accept current behavior | practical | client name = sso-session name |

### conclusion

**accept current behavior**. the client name will be `botocore-client-{profile-name}` since sso-session names match profile names.

the one-time OAuth registration prompt will show:
- `botocore-client-ehmpathy.demo` for profile `ehmpathy.demo`
- `botocore-client-acme.prod` for profile `acme.prod`

this is acceptable because:
1. OAuth registration only happens once per sso-session
2. the prompt appears at `keyrack set` (setup time), not at `keyrack unlock`
3. subsequent unlocks use portal flow (no botocore mention)

### current config format (retained)

```ini
[profile ehmpathy.demo]
sso_session = ehmpathy.demo
sso_account_id = 805192865516
sso_role_name = ehmpathy-demo-sso

[sso-session ehmpathy.demo]
sso_start_url = https://d-xxxxxxxx.awsapps.com/start
sso_region = us-east-1
sso_registration_scopes = sso:account:access
```

OAuth client name shown in browser: `botocore-client-ehmpathy.demo`

## related

- blueprint: `.behavior/v2026_02_16.keyrack-aws-noboto/3.3.blueprint.v1.i1.md`
- vision: `.behavior/v2026_02_16.keyrack-aws-noboto/1.vision.md`

## sources

- [aws cli sso configuration](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html)
- [aws sso-session scopes](https://docs.aws.amazon.com/cli/latest/userguide/sso-configure-profile-token.html)

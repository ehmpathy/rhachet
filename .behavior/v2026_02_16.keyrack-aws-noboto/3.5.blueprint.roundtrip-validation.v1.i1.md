# blueprint: keyrack set must validate roundtrip

## discovery

the "botocore-client" OAuth prompt is a **one-time registration** per sso-session. once approved, subsequent unlocks use portal flow.

see: `5.lesson.aws-sso-registration-scopes.md`

## the fix

at `keyrack set`, after profile is written, validate the full roundtrip:

```
set flow:
  1. write profile to ~/.aws/config
  2. unlock (triggers one-time OAuth registration if needed)
  3. relock (clears session)
  4. unlock again (proves portal flow works)
  5. store profile name in vault
```

this ensures:
- OAuth client registration happens at setup (expected)
- future `keyrack unlock` uses portal flow (no surprises)
- misconfigured profiles fail fast at setup, not at unlock time

## architecture

```
keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso
â”‚
â”œâ”€ interactive setup (prompts for sso url, account, role, profile name)
â”‚
â”œâ”€ write profile to ~/.aws/config
â”‚
â”œâ”€ roundtrip validation:
â”‚   â”œâ”€ unlock()   â†’ one-time OAuth registration (botocore-client prompt)
â”‚   â”œâ”€ relock()   â†’ clear session
â”‚   â””â”€ unlock()   â†’ prove portal flow works
â”‚
â””â”€ store profile name in vault
```

## code changes

### setupAwsSsoProfile.ts

after write profile, add roundtrip validation:

```ts
// write profile to ~/.aws/config
await fs.writeFile(configPath, configNew, 'utf-8');

// roundtrip validation: unlock â†’ relock â†’ unlock
// first unlock triggers one-time OAuth registration
execSync(`aws sso login --profile "${input.profileName}"`, { stdio: 'inherit' });

// relock clears session
clearSsoCache();

// second unlock proves portal flow works (no OAuth prompt)
execSync(`aws sso login --profile "${input.profileName}"`, { stdio: 'inherit' });

// validate session
execSync(`aws sts get-caller-identity --profile "${input.profileName}"`, { stdio: 'pipe' });
```

### separation of concerns

**vault adapters = atomic operations**
- `set`: store a value
- `get`: retrieve a value
- `unlock`: refresh/activate session
- `relock`: clear session

**keyrack command = orchestration + validation**
- calls vault adapter methods in sequence
- validates roundtrip works before return of success
- fails fast if any step fails

### keyrack set orchestrates roundtrip (for ALL vaults)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. vault.set(slug, value)                                     â”‚
â”‚     â†’ store the key in vault                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. vault.unlock({ slug })                                     â”‚
â”‚     â†’ prove unlock works                                       â”‚
â”‚     â†’ for aws.iam.sso: triggers one-time OAuth registration    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. vault.get({ slug })                                        â”‚
â”‚     â†’ prove get works                                          â”‚
â”‚     â†’ sanity check: returned value matches what we set         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. vault.relock({ slug })                                     â”‚
â”‚     â†’ clear session                                            â”‚
â”‚     â†’ leave vault in locked state after setup                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                           success
```

**this is NOT specific to aws.iam.sso** â€” keyrack set does this roundtrip for EVERY vault adapter. it's a pit-of-success guarantee: if `keyrack set` succeeds, the key is guaranteed to work.

### vault adapter interface (atomic, unchanged)

adapters implement atomic operations only. no roundtrip logic in adapters.

```ts
interface KeyrackHostVaultAdapter {
  set: (input: { slug; value }) => Promise<void>;
  get: (input: { slug }) => Promise<string | null>;
  del: (input: { slug }) => Promise<void>;
  unlock: (input: { slug }) => Promise<void>;
  relock: (input: { slug }) => Promise<void>;
  isUnlocked: () => Promise<boolean>;
}
```

## client name

the OAuth client name is `botocore-client-{sso-session-name}`.

**research result:** the client name is **hardcoded** in AWS CLI's botocore library. no config option exists to customize it independently from the sso-session name.

**conclusion:** accept current behavior. client name = `botocore-client-{profile-name}` since sso-session names match profile names. this is acceptable because OAuth registration only happens once at setup.

see: `5.lesson.aws-sso-registration-scopes.md`

**config format (sso-session matches profile):**

```ini
[profile ehmpathy.demo]
sso_session = ehmpathy.demo
sso_account_id = 805192865516
sso_role_name = ehmpathy-demo-sso

[sso-session ehmpathy.demo]
sso_start_url = https://d-xxxxxxxx.awsapps.com/start
sso_region = us-east-1
sso_registration_scopes = sso:account:access
```

## ux at setup

user experience at `keyrack set`:

```
ğŸ” keyrack set AWS_PROFILE

   â”Œâ”€ which sso portal?
   â”‚  ...
   â”‚
   â”œâ”€ which account?
   â”‚  ...
   â”‚
   â”œâ”€ which role?
   â”‚  ...
   â”‚
   â”œâ”€ what profile name?
   â”‚  ...
   â”‚
   â”œâ”€ validate roundtrip
   â”‚
   â”‚  â³ first unlock (one-time OAuth registration)...
   â”‚
   â”‚  [browser: "Allow access to botocore-client-{profile-name}?"]
   â”‚
   â”‚  âœ“ OAuth client registered
   â”‚
   â”‚  â³ relock...
   â”‚  âœ“ session cleared
   â”‚
   â”‚  â³ second unlock (portal flow)...
   â”‚
   â”‚  [browser: standard "Sign in" / "Allow"]
   â”‚
   â”‚  âœ“ portal flow confirmed
   â”‚
   â””â”€ done

   âœ“ ~/.aws/config updated
   âœ“ roundtrip validated
```

## related

- lesson: `5.lesson.aws-sso-registration-scopes.md`
- original blueprint: `3.3.blueprint.v1.i1.md`

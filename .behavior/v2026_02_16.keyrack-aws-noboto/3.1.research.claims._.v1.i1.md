# research: claims for keyrack aws sso portal flow

## summary

research into what triggers portal flow vs programmatic flow (botocore-client) in aws sso authentication.

## citations

### [1] aws cli sso configuration docs
**source**: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html

> "the sign in process may prompt you to allow the aws cli access to your data. since the aws cli is built on top of the sdk for python, permission messages may contain variations of the botocore name."

### [2] aws cli pkce announcement
**source**: https://aws.amazon.com/blogs/developer/aws-cli-adds-pkce-based-authorization-for-sso/

> "as of aws cli version 2.22.0, pkce authorization is the default."

> "you may need to use the previous workflow, which uses the oauth 2.0 device authorization grant, in environments where the aws cli is unable to launch a browser or receive the oauth callback."

### [3] iam identity center credential provider
**source**: https://docs.aws.amazon.com/sdkref/latest/guide/feature-sso-credentials.html

> "automated token refresh isn't supported with the legacy non-refreshable configuration."

> "modern sso token provider: automatically refreshes up to extended session period"

> "legacy non-refreshable: fixed 8-hour session, no automatic refresh"

### [4] aws sso login reference
**source**: https://docs.aws.amazon.com/cli/latest/reference/sso/login.html

> "`--sso-session`: an explicit sso session to use to login. by default, this command will login via the sso session configured as part of the requested profile and generally does not require this argument to be set."

### [5] christophe tafani-dereeper pkce analysis
**source**: https://blog.christophetd.fr/pkce-aws-sso/

> "pkce flow: after successful authentication, aws redirects the user to localhost"

> "the aws cli spins up a temporary web server to intercept the authorization code"

### [6] aws sso oidc register_client
**source**: https://botocore.amazonaws.com/v1/documentation/api/latest/reference/services/sso-oidc.html

> "registers a client with aws sso. allows clients to initiate device authorization."

> "the client_name parameter represents the friendly name of the client."

### [7] christophetd device code auth implementation
**source**: https://github.com/christophetd/aws-sso-device-code-authentication

> code shows `register_client(clientName='never-gonna-give-you-up', clientType='public')`

> the `clientName` parameter is what appears in browser prompt as "allow access to {clientName}?"

### [8] declastruct-aws config
**source**: https://github.com/ehmpathy/declastruct-aws/blob/main/provision/aws.auth/readme.md

> uses sso-session config format with `sso_registration_scopes = sso:account:access`

> login via: `export AWS_PROFILE=ehmpathy.demo.admin; aws sts get-caller-identity >/dev/null || aws sso login`

> no botocore-client prompt appears in practice

---

## claims

### [FACT] botocore-client prompt comes from register_client api
**citation**: [1], [6], [7]

when oauth client registration occurs via `register_client()` api, the `clientName` parameter is what appears in the browser prompt as "allow access to {clientName}?". aws cli/botocore uses names like "botocore-client-{session-name}".

### [FACT] pkce is default since aws cli 2.22.0
**citation**: [2]

pkce-based authorization became the default in aws cli version 2.22.0. it replaced the previous device authorization grant flow.

### [FACT] two config formats exist: modern sso-session vs legacy inline
**citation**: [3]

- **modern**: uses `[sso-session]` section, supports `sso_registration_scopes`, enables token refresh
- **legacy**: all options in `[profile]` section, no refresh, fixed 8-hour session

### [FACT] sso_registration_scopes triggers oauth client registration
**citation**: [3], [6]

the `sso_registration_scopes` option in sso-session config is used to configure scopes for oauth 2.0 client registration. this is what enables token refresh.

### [SUMP] config format determines whether oauth client registration occurs
**citation**: [3]

assumption that modern sso-session config with `sso_registration_scopes` triggers oauth client registration, while legacy inline config does not.

**contradiction**: declastruct-aws uses sso-session format WITH `sso_registration_scopes = sso:account:access` yet produces portal flow (no botocore-client prompt). [8]

### [KHUE] what exactly triggers botocore-client prompt vs normal signin?
**citation**: [1], [8]

open question: if sso-session config with registration scopes works without botocore-client prompt (as proven by declastruct-aws), what actually determines whether the botocore-client prompt appears?

possible factors:
1. `--sso-session` flag explicitly passed vs `--profile` flag
2. first-time oauth client registration vs cached client credentials
3. device authorization grant (`--use-device-code`) vs pkce flow
4. else entirely unclear

### [KHUE] does --sso-session flag trigger programmatic flow?
**citation**: [4]

hypothesis: `aws sso login --sso-session $name` may trigger programmatic flow (with botocore-client prompt), while `aws sso login --profile $name` may use portal flow.

needs verification via test.

### [FACT] declastruct-aws proves sso-session + portal flow is achievable
**citation**: [8]

declastruct-aws uses:
- sso-session config format
- `sso_registration_scopes = sso:account:access`
- login via `aws sso login` (implicit profile from AWS_PROFILE)

result: normal portal signin, no botocore-client prompt.

### [SUMP] --use-device-code triggers botocore-client prompt
**citation**: [2], [5]

assumption that device authorization grant flow (enabled via `--use-device-code` flag) is what triggers the "allow access to botocore-client-{name}?" prompt, while pkce flow shows normal signin.

### [OPIN] legacy config is cleaner for explicit auth flows
**citation**: [3]

aws docs call inline profile config "legacy" because it lacks auto-refresh. but for explicit auth flows (like keyrack unlock), auto-refresh is undesired. token expiration is a feature.

---

## ground truth synthesis

based on research, the hypothesis is:

1. **config format alone does NOT determine flow** - declastruct-aws proves sso-session config works with portal flow

2. **pkce is the modern default** - aws cli 2.22.0+ uses pkce by default, not device authorization

3. **botocore-client prompt appears when oauth client is registered** - the `clientName` in `register_client()` api becomes the prompt text

4. **the trigger remains unclear** - more test needed to determine exact conditions

## recommended next steps

1. test `aws sso login --profile $name` with sso-session config → observe browser prompt
2. test `aws sso login --sso-session $name` → observe browser prompt
3. test `aws sso login --profile $name --use-device-code` → observe browser prompt
4. document which combination produces portal flow vs programmatic flow

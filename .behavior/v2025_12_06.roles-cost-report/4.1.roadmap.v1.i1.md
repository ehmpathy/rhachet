# Roadmap: `npx rhachet roles cost` Command

## Overview

Implementation roadmap for the `roles cost` command per blueprint in `3.3.blueprint.v1.i1.md`.

---

## Phase 1: Extract Shared Utilities

### Step 1.1: Extract `extractSkillDocumentation`

- [ ] Create `src/logic/role/extractSkillDocumentation.ts`
- [ ] Move `extractSkillDocumentation` function from `invokeRolesBoot.ts`
- [ ] Export the function
- [ ] Create `src/logic/role/extractSkillDocumentation.test.ts`
- [ ] Test: extracts shebang line
- [ ] Test: extracts shell comments (`#`)
- [ ] Test: extracts JS/TS comments (`//`)
- [ ] Test: stops at first non-comment, non-blank line
- [ ] Test: handles files with no documentation

**Acceptance Criteria:**
- Function extracts only shebang and leading comments from skill files
- Function appends `# [implementation hidden - use skill to execute]` marker
- Function handles files with no documentation gracefully
- All unit tests pass

**Verification:**
```bash
npm run test:unit -- extractSkillDocumentation
```
- All unit tests pass

```bash
npm run test:types
```
- TypeScript compiles without errors
- `invokeRolesBoot.ts` imports from new location successfully

---

### Step 1.2: Create `getRoleFileCosts`

**Depends on:** Step 1.1

- [ ] Create `src/logic/role/getRoleFileCosts.ts`
- [ ] Define `FileCost` interface with: `path`, `relativePath`, `chars`, `tokens`, `cost`, `type`, `isDocsOnly`
- [ ] Implement `getAllFiles` recursive directory traversal (follows symlinks)
- [ ] Implement cost calculation: chars/4 for tokens, tokens/1M * $3 for cost
- [ ] For skills: use `extractSkillDocumentation` to count only docs
- [ ] For briefs/other: count full file content
- [ ] Create `src/logic/role/getRoleFileCosts.test.ts`
- [ ] Test: calculates tokens as chars / 4
- [ ] Test: calculates cost as tokens / 1M * $3
- [ ] Test: marks skill files with `isDocsOnly: true`
- [ ] Test: marks brief files with `type: 'brief'`
- [ ] Test: marks other files with `type: 'other'`
- [ ] Test: traverses symlinked directories

**Acceptance Criteria:**
- Returns array of `FileCost` objects for all files in role directory
- Skills are marked with `isDocsOnly: true` and only doc chars counted
- Briefs and other files have full content counted
- Token/cost math matches `roles boot` output
- All unit tests pass

**Verification:**
```bash
npm run test:unit -- getRoleFileCosts
```
- All unit tests pass

```bash
npm run test:types
```
- TypeScript compiles without errors

---

### Step 1.3: Create `formatCostTree`

**Depends on:** Step 1.2

- [ ] Create `src/logic/role/formatCostTree.ts`
- [ ] Build tree structure from file paths
- [ ] Format with box-drawing characters (├──, └──, │)
- [ ] Annotate files with token count and cost
- [ ] Append `[docs only]` for skill files
- [ ] Include directory subtotals (optional, nice-to-have)
- [ ] Create `src/logic/role/formatCostTree.test.ts`
- [ ] Test: formats single file
- [ ] Test: formats nested directories with box-drawing characters
- [ ] Test: annotates skill files with `[docs only]`
- [ ] Test: right-aligns cost values

**Acceptance Criteria:**
- Output resembles tree structure from blueprint example
- File costs are right-aligned for readability
- Skill files show `[docs only]` annotation
- All unit tests pass

**Verification:**
```bash
npm run test:unit -- formatCostTree
```
- All unit tests pass

```bash
npm run test:types
```
- TypeScript compiles without errors

---

## Phase 2: Implement CLI Command

### Step 2.1: Create `invokeRolesCost`

**Depends on:** Steps 1.1, 1.2, 1.3

- [ ] Create `src/contract/cli/invokeRolesCost.ts`
- [ ] Add `cost` subcommand with `--repo` and `--role` options
- [ ] Use `inferRepoByRole` when `--repo` omitted (same pattern as `roles boot`)
- [ ] Validate `--role` is required
- [ ] Check role directory exists, throw helpful error if not
- [ ] Call `getRoleFileCosts` to get file costs
- [ ] Call `formatCostTree` to format output
- [ ] Print summary stats (files, chars, tokens, cost)

**Acceptance Criteria:**
- `npx rhachet roles cost --repo X --role Y` outputs tree with costs
- `npx rhachet roles cost --role Y` infers repo when unambiguous
- Error message guides user to run `roles link` if directory missing
- Summary shows file breakdown (briefs/skills/other) and total cost

**Verification:**
```bash
npm run test:types
```
- TypeScript compiles without errors

---

### Step 2.2: Wire into `invokeRoles`

**Depends on:** Step 2.1

- [ ] Import `invokeRolesCost` in `src/contract/cli/invokeRoles.ts`
- [ ] Call `invokeRolesCost({ command: rolesCommand, registries })`

**Acceptance Criteria:**
- `npx rhachet roles --help` shows `cost` as available subcommand
- `npx rhachet roles cost --help` shows command options

**Verification:**
```bash
npm run build && npx rhachet roles --help
```
- `cost` appears in subcommand list

```bash
npx rhachet roles cost --help
```
- Shows `--repo` and `--role` options

---

## Phase 3: Integration Testing

### Step 3.1: Create Integration Test File

**Depends on:** Step 2.2

- [ ] Create `src/contract/cli/invokeRolesCost.integration.test.ts`
- [ ] Test: command outputs tree structure for linked role
- [ ] Test: command shows per-file token/cost annotations
- [ ] Test: command shows summary with file breakdown
- [ ] Test: command fails gracefully when role not linked
- [ ] Test: command infers repo when `--repo` omitted
- [ ] Test: token totals match `roles boot` output

**Acceptance Criteria:**
- All integration tests pass
- Edge cases covered (missing role, ambiguous repo)
- Token counts match between `roles cost` and `roles boot`

**Verification:**
```bash
npm run test:integration -- invokeRolesCost
```
- All tests pass

---

## Phase 4: Refactor `invokeRolesBoot` (Optional)

### Step 4.1: Refactor to Use Shared Utilities

**Depends on:** Steps 1.1, 1.2, 3.1

- [ ] Update `invokeRolesBoot.ts` to import `extractSkillDocumentation` from shared location
- [ ] Optionally refactor to use `getRoleFileCosts` for cost calculations
- [ ] Ensure output format remains identical

**Acceptance Criteria:**
- `roles boot` output is unchanged
- No duplication of `extractSkillDocumentation` logic
- Existing integration tests still pass

**Verification:**
```bash
npm run test:integration -- invokeRolesBoot
```
- All existing tests pass

---

## Phase 5: Final Verification

### Step 5.1: Full Test Suite

**Depends on:** All previous steps

- [ ] Run full type check
- [ ] Run full unit test suite
- [ ] Run full integration test suite
- [ ] Run build

**Acceptance Criteria:**
- No TypeScript errors
- All unit tests pass
- All integration tests pass
- Build succeeds

**Verification:**
```bash
npm run test:types && npm run test:unit && npm run test:integration && npm run build
```
- All commands exit 0

---

### Step 5.2: End-to-End Behavioral Verification

**Depends on:** Step 5.1

- [ ] Execute the original wish command: `npx rhachet roles cost --repo ehmpathy --role mechanic`
- [ ] Verify tree structure output
- [ ] Verify per-file token/cost breakdown
- [ ] Verify total matches `roles boot` output

**Acceptance Criteria:**
- Command executes successfully
- Output matches blueprint example format
- Costs enable identifying expensive briefs for optimization

**Verification:**
```bash
npx rhachet roles cost --role mechanic
```
- Tree structure with per-file costs displayed
- Summary shows total tokens and cost estimate

---

## Dependency Graph

```
1.1 extractSkillDocumentation (+ unit tests)
 │
 ├──► 1.2 getRoleFileCosts (+ unit tests)
 │     │
 │     └──► 1.3 formatCostTree (+ unit tests)
 │           │
 │           └──► 2.1 invokeRolesCost
 │                 │
 │                 └──► 2.2 Wire into invokeRoles
 │                       │
 │                       ├──► 3.1 Integration Tests
 │                       │
 │                       └──► 4.1 Refactor invokeRolesBoot (optional)
 │
 └──────────────────────────────────► 5.1 Full Test Suite
                                       │
                                       └──► 5.2 E2E Verification
```

---

## Summary

| Phase | Steps | Description |
|-------|-------|-------------|
| 1 | 1.1-1.3 | Extract shared utilities (with unit tests) |
| 2 | 2.1-2.2 | Implement CLI command |
| 3 | 3.1 | Integration tests |
| 4 | 4.1 | Refactor existing code (optional) |
| 5 | 5.1-5.2 | Final verification |

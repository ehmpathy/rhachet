# Blueprint: `npx rhachet roles cost` Command

## Wish Summary

Add a `cost` subcommand to `npx rhachet roles` that outputs a tree structure of all files loaded for a role (briefs and skills), along with per-file token/cost estimates. This enables understanding which briefs are expensive and prioritizing compression/refinement.

---

## Current State

The `npx rhachet roles boot` command already:
- Reads all files from `.agent/repo=$repo/role=$role`
- Calculates total tokens (chars / 4) and cost ($3/million tokens)
- For skills, only includes documentation (not implementation)
- Outputs a tree structure and full file contents

The new `cost` command should reuse this token-counting logic but:
- Only output the tree structure with per-file costs (not file contents)
- Show cost breakdown by file, not just totals

---

## Proposed Solution

### 1. Create `invokeRolesCost.ts`

**Location**: `src/contract/cli/invokeRolesCost.ts`

```ts
/**
 * .what = adds the "roles cost" subcommand to the CLI
 * .why = outputs role resource costs without loading full file contents
 * .how = reads files in .agent/repo=$repo/role=$role and computes per-file token/cost estimates
 */
export const invokeRolesCost = ({
  command,
  registries,
}: {
  command: Command;
  registries: RoleRegistry[];
}): void => {
  command
    .command('cost')
    .description('show token/cost estimates for role resources')
    .option('--repo <slug>', 'the repository slug for the role')
    .option('--role <slug>', 'the role to analyze')
    .action(async (opts: { repo?: string; role?: string }) => { ... });
};
```

### 2. Core Logic

The command should:

1. **Resolve repo and role** using existing `inferRepoByRole` pattern (same as `roles boot`)
2. **Collect all files** from `.agent/repo=$repo/role=$role` recursively
3. **Calculate per-file costs** using the same logic as `roles boot`:
   - For skills: count only documentation chars (using `extractSkillDocumentation`)
   - For briefs/other: count full file chars
   - Tokens = chars / 4
   - Cost = tokens / 1_000_000 * 3

4. **Output tree structure with costs** in a format like:

```
npx rhachet roles cost --repo ehmpathy --role mechanic

ðŸŒŠ Role Cost Report: mechanic @ ehmpathy

.agent/repo=ehmpathy/role=mechanic
â”œâ”€â”€ briefs
â”‚   â”œâ”€â”€ practices
â”‚   â”‚   â”œâ”€â”€ typescript.md       1,234 tokens ($0.004)
â”‚   â”‚   â””â”€â”€ testing.md            892 tokens ($0.003)
â”‚   â””â”€â”€ domain
â”‚       â””â”€â”€ overview.md         2,456 tokens ($0.007)
â”œâ”€â”€ skills
â”‚   â”œâ”€â”€ build.sh                  45 tokens ($0.000) [docs only]
â”‚   â””â”€â”€ test.sh                   32 tokens ($0.000) [docs only]
â””â”€â”€ readme.md                    567 tokens ($0.002)

Summary:
  â”œâ”€â”€ files = 6
  â”‚   â”œâ”€â”€ briefs = 3
  â”‚   â”œâ”€â”€ skills = 2
  â”‚   â””â”€â”€ other = 1
  â”œâ”€â”€ chars = 20,904
  â””â”€â”€ tokens â‰ˆ 5,226 ($0.016 at $3/mil)
```

### 3. Extract Shared Logic

To avoid duplication with `invokeRolesBoot.ts`, extract common utilities:

**Location**: `src/logic/role/getRoleFileCosts.ts`

```ts
interface FileCost {
  path: string;
  relativePath: string;
  chars: number;
  tokens: number;
  cost: number;
  type: 'brief' | 'skill' | 'other';
  isDocsOnly: boolean;
}

/**
 * .what = calculates token costs for all files in a role directory
 * .why = shared between "roles boot" and "roles cost" commands
 * .how = reads files, applies skill doc extraction, computes tokens
 */
export const getRoleFileCosts = (input: {
  roleDir: string;
  repoSlug: string;
  roleSlug: string;
}): FileCost[] => { ... };
```

**Location**: `src/logic/role/extractSkillDocumentation.ts`

Move the existing `extractSkillDocumentation` function from `invokeRolesBoot.ts` to a shared location.

### 4. Output Formatting

Create a helper for formatting the tree with costs:

**Location**: `src/logic/role/formatCostTree.ts`

```ts
/**
 * .what = formats file costs as a tree structure with token/cost annotations
 * .why = provides visual cost breakdown for role resources
 * .how = builds tree from file paths and appends cost info to each node
 */
export const formatCostTree = (input: {
  files: FileCost[];
  rootPath: string;
}): string => { ... };
```

---

## Files to Create

1. `src/contract/cli/invokeRolesCost.ts` - CLI command handler
2. `src/contract/cli/invokeRolesCost.integration.test.ts` - Integration tests
3. `src/logic/role/getRoleFileCosts.ts` - Shared cost calculation logic
4. `src/logic/role/extractSkillDocumentation.ts` - Extracted from invokeRolesBoot.ts
5. `src/logic/role/formatCostTree.ts` - Tree formatting with costs

---

## Files to Modify

1. `src/contract/cli/invokeRoles.ts` - Wire in `invokeRolesCost` command
2. `src/contract/cli/invokeRolesBoot.ts` - Refactor to use shared `extractSkillDocumentation` and optionally `getRoleFileCosts`

---

## Implementation Notes

### Cost Formatting

```ts
const formatCost = (cost: number): string => {
  if (cost < 0.001) return '$0.000';
  if (cost < 0.01) return `$${cost.toFixed(3)}`;
  return `$${cost.toFixed(2)}`;
};
```

### Tree Building

Use recursive directory traversal to build a tree structure, annotating each file node with its token count and cost. The tree structure can be built using an object/map and then formatted with box-drawing characters.

### Skill Annotation

For skill files, append `[docs only]` to indicate that only documentation is counted (matching the behavior of `roles boot`).

---

## Example CLI Usage

```bash
# With explicit repo
npx rhachet roles cost --repo ehmpathy --role mechanic

# With inferred repo (when only one repo has the role)
npx rhachet roles cost --role mechanic
```

---

## Edge Cases

1. **Empty role directory**: Show message "No resources found"
2. **No briefs/skills**: Only show non-empty sections
3. **Very small costs**: Format as `$0.000` or `< $0.001`
4. **Large files**: Consider adding a warning threshold (e.g., "> 10,000 tokens")

---

## Testing Strategy

### Unit Tests
- `extractSkillDocumentation` with various file formats
- `getRoleFileCosts` with mixed file types
- `formatCostTree` output formatting

### Integration Tests
- `npx rhachet roles cost --repo X --role Y` with linked role
- Error handling when role not linked
- Repo inference when `--repo` omitted

---

## Future Enhancements (Out of Scope)

- `--json` flag for machine-readable output
- `--sort-by-cost` to highlight expensive files
- `--threshold` to only show files above a certain cost
- Comparison mode to track cost changes over time

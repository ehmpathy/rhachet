# Execution: `npx rhachet roles cost` Command

## Progress Tracking

### Phase 1: Extract Shared Utilities

#### Step 1.1: Extract `extractSkillDocumentation`
- [x] Create `src/logic/role/extractSkillDocumentation.ts`
- [x] Move `extractSkillDocumentation` function from `invokeRolesBoot.ts`
- [x] Export the function
- [x] Create `src/logic/role/extractSkillDocumentation.test.ts`
- [x] Test: extracts shebang line
- [x] Test: extracts shell comments (`#`)
- [x] Test: extracts JS/TS comments (`//`)
- [x] Test: stops at first non-comment, non-blank line
- [x] Test: handles files with no documentation
- [x] Verification: `npm run test:unit -- extractSkillDocumentation` passes
- [x] Verification: `npm run test:types` passes

#### Step 1.2: Create `getRoleFileCosts`
- [x] Create `src/logic/role/getRoleFileCosts.ts`
- [x] Define `FileCost` interface
- [x] Implement `getAllFiles` recursive directory traversal
- [x] Implement cost calculation
- [x] Create `src/logic/role/getRoleFileCosts.test.ts`
- [x] Test: calculates tokens as chars / 4
- [x] Test: calculates cost as tokens / 1M * $3
- [x] Test: marks skill files with `isDocsOnly: true`
- [x] Test: marks brief files with `type: 'brief'`
- [x] Test: marks other files with `type: 'other'`
- [x] Verification: `npm run test:unit -- getRoleFileCosts` passes
- [x] Verification: `npm run test:types` passes

#### Step 1.3: Create `formatCostTree`
- [x] Create `src/logic/role/formatCostTree.ts`
- [x] Build tree structure from file paths
- [x] Format with box-drawing characters
- [x] Annotate files with token count and cost
- [x] Append `[docs only]` for skill files
- [x] Create `src/logic/role/formatCostTree.test.ts`
- [x] Test: formats single file
- [x] Test: formats nested directories
- [x] Test: annotates skill files with `[docs only]`
- [x] Verification: `npm run test:unit -- formatCostTree` passes
- [x] Verification: `npm run test:types` passes

### Phase 2: Implement CLI Command

#### Step 2.1: Create `invokeRolesCost`
- [x] Create `src/contract/cli/invokeRolesCost.ts`
- [x] Add `cost` subcommand with options
- [x] Use `inferRepoByRole` pattern
- [x] Call `getRoleFileCosts` and `formatCostTree`
- [x] Print summary stats
- [x] Verification: `npm run test:types` passes

#### Step 2.2: Wire into `invokeRoles`
- [x] Import `invokeRolesCost` in `invokeRoles.ts`
- [x] Call `invokeRolesCost({ command, registries })`
- [x] Verification: `npm run build` passes
- [x] Verification: `npx rhachet roles --help` shows `cost`

### Phase 3: Integration Testing

#### Step 3.1: Create Integration Test File
- [x] Create `src/contract/cli/invokeRolesCost.integration.test.ts`
- [x] Test: command outputs tree structure
- [x] Test: command shows per-file costs
- [x] Test: command shows summary
- [x] Test: command fails when role not linked
- [x] Test: command infers repo
- [x] Verification: `npm run test:integration -- invokeRolesCost` passes

### Phase 4: Refactor `invokeRolesBoot` (Optional)

#### Step 4.1: Refactor to Use Shared Utilities
- [x] Update imports in `invokeRolesBoot.ts`
- [x] Verification: `npm run test:integration -- invokeRolesBoot` passes

### Phase 5: Final Verification

#### Step 5.1: Full Test Suite
- [x] `npm run test:types` passes
- [x] `npm run test:unit` passes (28 tests)
- [x] `npm run test:integration` passes (17 tests)
- [x] `npm run build` passes

#### Step 5.2: End-to-End Behavioral Verification
- [x] `npx rhachet roles cost --role mechanic` executes successfully
- [x] Tree structure output displayed
- [x] Per-file token/cost breakdown shown
- [x] Total matches `roles boot` output

**Result:**
```
ðŸŒŠ Role Cost Report: mechanic @ ehmpathy

Summary:
  â”œâ”€â”€ files = 94
  â”‚   â”œâ”€â”€ briefs = 78
  â”‚   â”œâ”€â”€ skills = 15
  â”‚   â””â”€â”€ other = 1
  â”œâ”€â”€ chars = 152,784
  â””â”€â”€ tokens â‰ˆ 38,236 ($0.11 at $3/mil)
```

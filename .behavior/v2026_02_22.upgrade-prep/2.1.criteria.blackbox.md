# blackbox criteria: `--prep` flag for `rhachet init`

## usecase.1 = initial setup with hooks

```
given(repo with package.json, no prepare entries)
  when(user runs `npx rhachet init --hooks --prep --roles mechanic,behaver`)
    then(roles are linked into .agent/)
      sothat(agent has access to briefs and skills)
    then(hooks are configured)
      sothat(agent boots with role context)
    then(package.json has `prepare:rhachet` entry with `--hooks` included)
      sothat(future installs will configure hooks)
    then(package.json has `prepare` entry that includes `npm run prepare:rhachet`)
      sothat(future installs auto-run rhachet init)

given(repo with package.json, prepare entry already extant)
  when(user runs `npx rhachet init --hooks --prep --roles mechanic`)
    then(prepare:rhachet entry is upserted)
    then(prepare entry is appended with `&& npm run prepare:rhachet`)
      sothat(extant prepare logic is preserved)
    then(prepare entry does not contain duplicate rhachet invocations)
      sothat(idempotency is maintained)
```

## usecase.2 = initial setup without hooks

```
given(repo with package.json, no prepare entries)
  when(user runs `npx rhachet init --prep --roles mechanic`)
    then(roles are linked into .agent/)
    then(hooks are NOT configured)
      sothat(user's choice to omit hooks is respected)
    then(package.json has `prepare:rhachet` entry WITHOUT `--hooks`)
      sothat(future installs will NOT configure hooks)
    then(package.json has `prepare` entry that includes `npm run prepare:rhachet`)
```

## usecase.3 = update roles

```
given(repo with extant prepare:rhachet entry for `--roles mechanic`)
  when(user runs `npx rhachet init --hooks --prep --roles mechanic,behaver,designer`)
    then(roles are linked into .agent/)
    then(prepare:rhachet entry is updated with new roles list)
      sothat(future installs link all three roles)
    then(prepare entry remains unchanged)
      sothat(no duplicate appends occur)
```

## usecase.4 = add hooks to prior hookless setup

```
given(repo with extant prepare:rhachet entry WITHOUT `--hooks`)
  when(user runs `npx rhachet init --hooks --prep --roles mechanic`)
    then(hooks are configured)
    then(prepare:rhachet entry is updated to include `--hooks`)
      sothat(future installs configure hooks)
```

## usecase.5 = remove hooks from prior hooked setup

```
given(repo with extant prepare:rhachet entry WITH `--hooks`)
  when(user runs `npx rhachet init --prep --roles mechanic`)
    then(hooks are NOT configured)
    then(prepare:rhachet entry is updated to exclude `--hooks`)
      sothat(future installs will NOT configure hooks)
```

## usecase.6 = teammate clone experience

```
given(repo was set up with `--prep` and pushed)
  when(teammate clones and runs `npm install`)
    then(prepare command executes)
    then(rhachet init runs with persisted flags)
    then(roles are linked into .agent/)
    then(hooks are configured if `--hooks` was in persisted command)
      sothat(teammate has identical agent setup without manual steps)
```

## usecase.7 = prepare entry edgecases

```
given(repo with prepare entry = `husky install`)
  when(user runs `npx rhachet init --prep --roles mechanic`)
    then(prepare entry becomes `husky install && npm run prepare:rhachet`)
      sothat(extant prepare logic runs first)

given(repo with prepare entry = `husky install && npm run prepare:rhachet`)
  when(user runs `npx rhachet init --prep --roles mechanic,behaver`)
    then(prepare entry remains `husky install && npm run prepare:rhachet`)
      sothat(no duplicate appends)
    then(prepare:rhachet entry is updated with new roles)

given(repo with no prepare entry at all)
  when(user runs `npx rhachet init --prep --roles mechanic`)
    then(prepare entry is created as `npm run prepare:rhachet`)
```

## usecase.8 = error boundaries

```
given(repo with no package.json)
  when(user runs `npx rhachet init --prep --roles mechanic`)
    then(error is surfaced: no package.json found)
      sothat(user knows to initialize npm first)

given(repo with package.json but invalid json)
  when(user runs `npx rhachet init --prep --roles mechanic`)
    then(error is surfaced: invalid package.json)
      sothat(user can fix the syntax error)

given(user runs `--prep` without `--roles`)
  when(command executes)
    then(error is surfaced: --prep requires --roles)
      sothat(user knows the required combination)
```

## usecase.9 = flag independence

```
given(repo with package.json)
  when(user runs `npx rhachet init --roles mechanic --prep --hooks`)
    then(behavior is identical to `--hooks --prep --roles mechanic`)
      sothat(flag order does not matter)

given(repo with package.json)
  when(user runs `npx rhachet init --prep --hooks --roles mechanic,behaver`)
    then(behavior is identical to `--roles mechanic,behaver --prep --hooks`)
```

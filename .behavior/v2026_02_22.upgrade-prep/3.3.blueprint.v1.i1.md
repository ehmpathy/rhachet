# blueprint: `--prep` flag for `rhachet init`

## overview

add `--prep` flag to `npx rhachet init` that persists the init command into package.json scripts. this enables auto-setup on `npm install` for teammates.

**core behavior**:
1. upsert `scripts["prepare:rhachet"]` with reconstructed init command
2. findsert-append `npm run prepare:rhachet` into `scripts["prepare"]`
3. only include `--hooks` in persisted command if passed at invocation time

---

## treestruct: filediffs

```
src/
  contract/
    cli/
      [~] invokeInit.ts                              # add --prep flag, wire route
      [~] invokeInit.integration.test.ts             # add --prep test cases
  domain.operations/
    init/
      [+] persistPrepareEntries.ts                   # orchestrate package.json mutations
      [+] persistPrepareEntries.integration.test.ts  # integration tests
  domain.operations/
    pkg/
      [+] upsertPackageJsonEntry.ts              # upsert a scripts entry
      [+] upsertPackageJsonEntry.test.ts              # unit tests
      [+] findsertAppendPackageJsonEntry.ts          # findsert-append into entry
      [+] findsertAppendPackageJsonEntry.test.ts     # unit tests
      [+] genInitCommand.ts                          # reconstruct init command string
      [+] genInitCommand.test.ts                     # unit tests
```

**legend**: `[+]` create, `[~]` update, `[-]` delete

---

## treestruct: codepaths

```
src/contract/cli/invokeInit.ts
  [~] .option('--prep', ...)                        # add flag definition
  [~] options type                                   # add prep?: boolean
  [â—‹] if (options.roles !== undefined) { ... }       # retain extant route
  [+] if (options.prep) { persistPrepareEntries() }  # add --prep route after roles init
  [+] validate --prep requires --roles               # add validation

src/domain.operations/init/persistPrepareEntries.ts
  [+] persistPrepareEntries(input, context)          # orchestrator
      [â†] readFileSync + JSON.parse                  # reuse extant pattern
      [+] genInitCommand({ hooks, roles })           # reconstruct command
      [+] upsertPackageJsonEntry({ key, value })         # upsert prepare:rhachet
      [+] findsertAppendPackageJsonEntry({ key, append })# findsert prepare
      [+] writeFileSync + JSON.stringify             # write back

src/domain.operations/pkg/genInitCommand.ts
  [+] genInitCommand(input)                          # pure function
      input: { hooks: boolean, roles: string[] }
      output: string (e.g., "npx rhachet init --hooks --roles mechanic,behaver")

src/domain.operations/pkg/upsertPackageJsonEntry.ts
  [+] upsertPackageJsonEntry(input)                  # mutate scripts object
      input: { pkg, key, value }
      output: { pkg, effect: 'CREATED' | 'UPDATED' }

src/domain.operations/pkg/findsertAppendPackageJsonEntry.ts
  [+] findsertAppendPackageJsonEntry(input)          # findsert-append logic
      input: { pkg, key, append, separator }
      output: { pkg, effect: 'CREATED' | 'APPENDED' | 'FOUND' }
```

**legend**: `[+]` create, `[~]` update, `[â—‹]` retain, `[â†]` reuse

---

## contracts

### contract.1: invokeInit flag

```typescript
.option('--prep', 'persist init command to package.json prepare entries')
```

**options type extension**:
```typescript
options: {
  roles?: string[];
  hooks?: boolean | string[];
  config?: boolean;
  prep?: boolean;           // [+] new
  mode: 'findsert' | 'upsert';
}
```

### contract.2: persistPrepareEntries

```typescript
/**
 * .what = persist rhachet init command to package.json prepare entries
 * .why = enables auto-setup on npm install for teammates
 */
export const persistPrepareEntries = (
  input: {
    hooks: boolean;
    roles: string[];
  },
  context: ContextCli,
): {
  prepareRhachet: { effect: 'CREATED' | 'UPDATED' };
  prepare: { effect: 'CREATED' | 'APPENDED' | 'FOUND' };
} => { ... };
```

### contract.3: genInitCommand

```typescript
/**
 * .what = reconstruct init command string from flags
 * .why = serialize current invocation for persistence
 */
export const genInitCommand = (input: {
  hooks: boolean;
  roles: string[];
}): string => { ... };
```

**examples**:
| hooks | roles | output |
|-------|-------|--------|
| true | ['mechanic'] | `npx rhachet init --hooks --roles mechanic` |
| false | ['mechanic', 'behaver'] | `npx rhachet init --roles mechanic,behaver` |
| true | ['a', 'b', 'c'] | `npx rhachet init --hooks --roles a,b,c` |

### contract.4: upsertPackageJsonEntry

```typescript
/**
 * .what = upsert a key into package.json scripts
 * .why = prepare:rhachet always overwrites (upsert semantics)
 */
export const upsertPackageJsonEntry = (input: {
  pkg: Record<string, unknown>;
  key: string;
  value: string;
}): {
  pkg: Record<string, unknown>;
  effect: 'CREATED' | 'UPDATED';
} => { ... };
```

### contract.5: findsertAppendPackageJsonEntry

```typescript
/**
 * .what = findsert-append a value into package.json scripts entry
 * .why = prepare entry preserves extant logic, appends if needed
 */
export const findsertAppendPackageJsonEntry = (input: {
  pkg: Record<string, unknown>;
  key: string;
  append: string;
  separator?: string;  // default: ' && '
}): {
  pkg: Record<string, unknown>;
  effect: 'CREATED' | 'APPENDED' | 'FOUND';
} => { ... };
```

**logic**:
- if `scripts[key]` absent â†’ create with `append` value â†’ `CREATED`
- if `scripts[key]` extant and includes `append` â†’ no-op â†’ `FOUND`
- if `scripts[key]` extant and lacks `append` â†’ append with separator â†’ `APPENDED`

---

## domain decomposition

```
persistPrepareEntries (orchestrator)
â”œâ”€â”€ genInitCommand (pure: reconstruct command string)
â”œâ”€â”€ upsertPackageJsonEntry (pure: mutate scripts object)
â””â”€â”€ findsertAppendPackageJsonEntry (pure: findsert-append logic)
```

**separation of concerns**:
- `genInitCommand` â€” pure string construction, no side effects
- `upsertPackageJsonEntry` â€” pure object mutation, no i/o
- `findsertAppendPackageJsonEntry` â€” pure object mutation, no i/o
- `persistPrepareEntries` â€” orchestrates i/o (read, mutate, write)

---

## test coverage

### unit tests

| file | covers |
|------|--------|
| `genInitCommand.test.ts` | command reconstruction: hooks true/false, various roles |
| `upsertPackageJsonEntry.test.ts` | CREATED vs UPDATED effects |
| `findsertAppendPackageJsonEntry.test.ts` | CREATED vs APPENDED vs FOUND effects |

### integration tests

| file | covers |
|------|--------|
| `persistPrepareEntries.integration.test.ts` | full flow: read â†’ mutate â†’ write |
| `invokeInit.integration.test.ts` | CLI integration: --prep flag route |

### test cases per blackbox criteria

```
invokeInit.integration.test.ts
  given('--prep flag behavior', () => {

    # usecase.1: initial setup with hooks
    when('[t0] --prep --hooks --roles (no prepare entries)', () => {
      then('prepare:rhachet created with --hooks')
      then('prepare created with npm run prepare:rhachet')
    });

    # usecase.2: initial setup without hooks
    when('[t1] --prep --roles (no --hooks)', () => {
      then('prepare:rhachet created WITHOUT --hooks')
    });

    # usecase.3: update roles
    when('[t2] --prep --roles (prepare:rhachet extant)', () => {
      then('prepare:rhachet updated with new roles')
      then('prepare unchanged')
    });

    # usecase.4: add hooks
    when('[t3] --prep --hooks (extant without hooks)', () => {
      then('prepare:rhachet updated to include --hooks')
    });

    # usecase.5: remove hooks
    when('[t4] --prep (extant with hooks)', () => {
      then('prepare:rhachet updated to exclude --hooks')
    });

    # usecase.7: prepare entry edgecases
    when('[t5] --prep (prepare = husky install)', () => {
      then('prepare appended with && npm run prepare:rhachet')
    });

    when('[t6] --prep (prepare already has rhachet)', () => {
      then('prepare unchanged (idempotent)')
    });

    # usecase.8: error boundaries
    when('[t7] --prep without --roles', () => {
      then('error: --prep requires --roles')
    });

    when('[t8] --prep (no package.json)', () => {
      then('error: no package.json found')
    });
  });
```

---

## execution order

1. **create pure functions** (no dependencies)
   - `genInitCommand.ts` + tests
   - `upsertPackageJsonEntry.ts` + tests
   - `findsertAppendPackageJsonEntry.ts` + tests

2. **create orchestrator** (depends on pure functions)
   - `persistPrepareEntries.ts` + integration tests

3. **wire CLI** (depends on orchestrator)
   - update `invokeInit.ts` with --prep flag and route
   - add integration tests to `invokeInit.integration.test.ts`

---

## output feedback

use extant console symbol patterns:

```
ðŸ“¦ persist prepare entries...
  + [created] scripts["prepare:rhachet"]
  + [created] scripts["prepare"]
```

```
ðŸ“¦ persist prepare entries...
  â†» [updated] scripts["prepare:rhachet"]
  â—‹ [found] scripts["prepare"]
```

```
ðŸ“¦ persist prepare entries...
  â†» [updated] scripts["prepare:rhachet"]
  â†ª [appended] scripts["prepare"]
```

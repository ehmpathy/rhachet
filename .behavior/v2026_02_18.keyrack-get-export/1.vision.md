# vision: keyrack get --output export

## the problem

### no way to export key values to shell

`keyrack get` returns JSON, but there's no built-in way to export the granted values as shell environment variables:

```sh
# current: manual jq gymnastics
export AWS_PROFILE=$(rhx keyrack get --key AWS_PROFILE --env test --json | jq -r '.grant.value // empty')

# desired: simple eval
eval "$(rhx keyrack get --key AWS_PROFILE --env test --output export)"
```

### sourceable unlock is overcomplicated

`bin/rhx` has special handling for `keyrack unlock` to export `KEYRACK_PASSPHRASE` when sourced:

```sh
. rhx keyrack unlock --passphrase "xxx"
# exports KEYRACK_PASSPHRASE to parent shell
```

this is:
- complex shell detection logic (`_rhx_is_sourced`)
- special case only for unlock
- inconsistent with other commands
- unnecessary if `keyrack get` can output export format

## the solution

### add `--output` flag to `keyrack get`

```
--output <format>   output format: words | json | export (default: words)
```

| format | description | use case |
|--------|-------------|----------|
| `words` | unicode words (current default) | human readable |
| `json` | JSON object | programmatic parsing |
| `export` | shell export statements | `eval "$(...)"`  |

### export format output

```sh
# single key
rhx keyrack get --key AWS_PROFILE --env test --output export
# outputs: export AWS_PROFILE='ehmpathy.dev'

# multiple keys
rhx keyrack get --for repo --env test --output export
# outputs:
# export AWS_PROFILE='ehmpathy.dev'
# export OPENAI_API_KEY='sk-...'
# export ANTHROPIC_API_KEY='sk-...'
```

only granted keys are output. blocked/locked/absent keys are silently skipped (no output = no export).

### remove sourceable unlock

delete the special sourceable unlock flow from `bin/rhx`. the passphrase can be passed directly to `keyrack get`:

```sh
# before (sourceable unlock)
. rhx keyrack unlock --passphrase "xxx"
rhx keyrack get --for repo --env test --json

# after (passphrase on get)
eval "$(rhx keyrack get --for repo --env test --output export --passphrase 'xxx')"
```

or unlock first, then get:

```sh
rhx keyrack unlock --env test
eval "$(rhx keyrack get --for repo --env test --output export)"
```

### auto-detect sourced

when `bin/rhx` detects it was sourced (not executed), it auto-supplies `--output export` and evals:

```sh
. rhx keyrack get --for repo --env test
echo $AWS_PROFILE  # ehmpathy.dev
```

this replaces the old sourceable unlock pattern with a simpler, more general pattern.

## user experience

### simple source pattern

```sh
# load all keys for test env
. rhx keyrack get --for repo --env test

# verify
echo $AWS_PROFILE  # ehmpathy.dev
```

### integration test setup

```sh
# in test runner or .envrc
. rhx keyrack get --for repo --env test
npm run test:integration
```

### direnv integration

```sh
# .envrc
. rhx keyrack get --for repo --env test 2>/dev/null || true
```

## safety

### quote values

export statements use single quotes to prevent shell injection:

```sh
export KEY='value with spaces and $pecial chars'
```

### no output on failure

if a key is locked/blocked/absent, no export statement is emitted. this prevents exporting empty or error values.

### stderr for errors

errors go to stderr, exports go to stdout. this allows:

```sh
. rhx keyrack get --for repo --env test
# errors visible, but don't break source
```

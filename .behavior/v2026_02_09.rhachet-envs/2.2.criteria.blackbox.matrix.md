# blackbox criteria: coverage matrix

ref:
- blackbox criteria: `.behavior/v2026_02_09.rhachet-envs/2.1.criteria.blackbox.md`

---

## matrix.1 = key declaration scope (usecases 1, 2)

which envs does a key apply to, and what slug does it resolve to?

| ind: declared section | ind: key name | dep: envs key applies to | dep: slug format |
|---|---|---|---|
| `env.all` | `XAI_API_KEY` | every declared env (prod, prep, test, ...) | `$org.$env.XAI_API_KEY` per env |
| `env.prod` | `AWS_PROFILE` | prod only | `$org.prod.AWS_PROFILE` |
| `env.prep` | `AWS_PROFILE` | prep only | `$org.prep.AWS_PROFILE` |
| `env.test` | `TEST_DB_URL` | test only | `$org.test.TEST_DB_URL` |
| `env.all` + `env.prod` (same key) | `DB_PASSWORD` | all envs; env.prod grade overrides for prod | `$org.$env.DB_PASSWORD` per env |
| flat `keys:` (no env sections) | any | error: format no longer supported | n/a |

### org isolation

| ind: org | ind: env | ind: key | dep: slug |
|---|---|---|---|
| ehmpathy | prod | `AWS_PROFILE` | `ehmpathy.prod.AWS_PROFILE` |
| ahbode | prod | `AWS_PROFILE` | `ahbode.prod.AWS_PROFILE` |

no overlap. orgs are fully isolated by slug prefix.

---

## matrix.2 = unlock command (usecases 3, 9)

| ind: --env flag | ind: env-specific sections in yaml | dep: keys unlocked | dep: outcome |
|---|---|---|---|
| `--env prep` | yes (prod, prep) | env.prep + env.all resolved to prep | success |
| `--env prod` | yes (prod, prep) | env.prod + env.all resolved to prod | success |
| `--env all` | yes (prod, prep) | all envs | success |
| omitted | yes (prod, prep) | none | error: --env is required |
| omitted | no (only env.all) | env.all keys | success (only one choice) |
| `--env all` | no (only env.all) | env.all keys | success (explicit form) |

---

## matrix.3 = get command (usecases 4, 7, 9)

| ind: --env flag | ind: env-specific sections in yaml | ind: requested env unlocked? | dep: keys exported | dep: export format | dep: outcome |
|---|---|---|---|---|---|
| `--env prep` | yes | yes (prep unlocked) | prep keys | raw names (`AWS_PROFILE`, not slug) | success |
| `--env prod` | yes | no (only prep unlocked) | none | n/a | error: locked status |
| `--env prod` | yes | yes (prod unlocked) | prod keys | raw names | success |
| omitted | yes (prod, prep) | any | none | n/a | error: --env is required |
| omitted | no (only env.all) | yes | env.all keys | raw names | success |
| `--for key --key XAI_API_KEY --env prod` | yes | yes | single key | raw name (`XAI_API_KEY`) | success |

### export value isolation

| ind: key | ind: --env | dep: value exported |
|---|---|---|
| `XAI_API_KEY` (env.all) | `--env prep` | prep-specific secret |
| `XAI_API_KEY` (env.all) | `--env prod` | prod-specific secret |

env.all keys produce per-env values. the value matches the env, not a shared value.

---

## matrix.4 = set command (usecase 5)

| ind: --key | ind: --org | ind: --env | ind: org in yaml | dep: slug configured | dep: outcome |
|---|---|---|---|---|---|
| `AWS_PROFILE` | omitted | omitted | `ehmpathy` | all envs that declare it | success (defaults: @this, all) |
| `AWS_PROFILE` | omitted | `prod` | `ehmpathy` | `ehmpathy.prod.AWS_PROFILE` | success |
| `AWS_PROFILE` | omitted | `prep` | `ehmpathy` | `ehmpathy.prep.AWS_PROFILE` | success |
| `AWS_PROFILE` | `@this` | `all` | `ehmpathy` | all envs that declare it | success (explicit default) |
| `XAI_API_KEY` | `ehmpathy` | `prod` | `ehmpathy` | `ehmpathy.prod.XAI_API_KEY` | success (org matches) |
| `XAI_API_KEY` | `foreign-org` | any | `ehmpathy` | none | error: org mismatch |
| any | omitted | any | absent | none | error: --org required |
| `AWS_PROFILE` | omitted | `all` | `ehmpathy` | `$org.prod.AWS_PROFILE` + `$org.prep.AWS_PROFILE` | success (expands to all envs) |

note: `set` defaults to `--env all` even when env-specific sections exist, because `set` configures host storage (not credential access).

---

## matrix.5 = env isolation security (usecase 8)

| ind: envs unlocked | ind: get --env | dep: outcome |
|---|---|---|
| prep only | `--env prep` | success: prep values |
| prep only | `--env prod` | error: locked |
| prep + prod | `--env prep` | success: prep values |
| prep + prod | `--env prod` | success: prod values |

prod is never exposed unless explicitly unlocked.

---

## matrix.6 = grade requirements per env (usecase 10)

| ind: env section | ind: key | ind: grade declared | dep: storage requirement |
|---|---|---|---|
| `env.prod` | `DB_PASSWORD` | `encrypted` | encrypted storage required |
| `env.test` | `DB_PASSWORD` | (none) | plaintext acceptable |
| `env.all` | `XAI_API_KEY` | `encrypted` | encrypted in every env |
| `env.all` + `env.test` override | `DB_PASSWORD` | `encrypted` (all), none (test) | encrypted everywhere except test |

---

## matrix.7 = keyrack.yml validation (usecase 11)

| ind: condition | dep: outcome |
|---|---|
| `org` field absent | error: org required |
| `env.all` declared, no `env.*` sections | error: env.all needs envs to expand into |
| key name contains dots | accepted (opaque string) |
| `env.sandbox` section declared | accepted (env names are open-ended) |
| flat `keys:` format (no env sections) | error: format no longer supported |

---

## matrix.8 = github action env input (usecase 12)

| ind: `env` input | dep: keys granted | dep: outcome |
|---|---|---|
| `test` | test keys | success |
| `prod` | prod keys | success |
| `all` | all env keys | success |
| omitted | none | error: env is required |

no default. intent is always visible in the workflow file.

---

## gap analysis

### gaps found: none

all meaningful combinations are covered by the blackbox criteria. the matrices confirm:
- unlock/get require `--env` when env-specific sections exist (matrix 2, 3)
- set defaults to `--env all` for convenience (matrix 4) â€” intentional asymmetry
- env isolation is enforced at the unlock boundary (matrix 5)
- grade overrides work per env (matrix 6)
- validation catches all structural errors (matrix 7)

### decomposition signals: none

all matrices stay within 3-4 independent dimensions. no explosion detected. the usecases are well-scoped.

### note: set vs unlock/get asymmetry

`set` defaults `--env` to `all` while `unlock` and `get` require `--env` when env-specific sections exist. this is intentional:
- `set` configures host storage (safe, no credential exposure)
- `unlock`/`get` control credential access (must be explicit to prevent mismatch)

this asymmetry is called out explicitly in usecase 9 and reflected in matrices 2, 3, 4.

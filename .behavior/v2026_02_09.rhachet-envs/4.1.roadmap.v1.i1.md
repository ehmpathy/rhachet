# roadmap: env-scoped keyrack keys

ref:
- blueprint: `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md`
- criteria: `.behavior/v2026_02_09.rhachet-envs/2.1.criteria.blackbox.md`
- matrix: `.behavior/v2026_02_09.rhachet-envs/2.2.criteria.blackbox.matrix.md`
- patterns: `.behavior/v2026_02_09.rhachet-envs/3.1.research.patterns._.code.prod.v1.i1.md`

---

## phase 0: domain objects

extend `KeyrackRepoManifest` and `KeyrackKeySpec` with env-scoped fields.

read before:
- `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md` (domain object contracts section)
- `.behavior/v2026_02_09.rhachet-envs/3.1.research.patterns._.code.prod.v1.i1.md` (patterns 1, 2)

checklist:
- [ ] extend `KeyrackKeySpec` with `env: string`, `name: string`, `grade: { protection, duration } | null`
- [ ] extend `KeyrackRepoManifest` with `org: string`, `envs: string[]`
- [ ] verify: `npm run test:types` passes

acceptance:
- `KeyrackKeySpec` accepts `{ slug, mech, env, name, grade }` on instantiation
- `KeyrackRepoManifest` accepts `{ org, envs, keys }` on instantiation

---

## phase 1: manifest schema + hydration

replace the dao schema and hydration to parse `org` + `env.*` sections and produce env-scoped slugs.

read before:
- `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md` (keyrack.yml schema contract, hydration logic)
- `.behavior/v2026_02_09.rhachet-envs/3.1.research.patterns._.code.prod.v1.i1.md` (patterns 3, 4)

depends on: phase 0

checklist:
- [ ] replace `schemaKeyrackRepoManifest` in `schema.ts` to validate `org` + `env.*` sections
- [ ] add validation: reject flat `keys:` format with clear error
- [ ] add validation: `org` field required
- [ ] add validation: `env.all` requires at least one `env.*` section
- [ ] add validation: accept open-ended env names
- [ ] replace hydration in `index.ts`: env expansion, slug generation (`$org.$env.$key`), grade parse
- [ ] add grade override: env-specific grade wins over env.all grade for same key
- [ ] add unit tests: `schema.test.ts` — yaml format validation, flat keys rejection, grade shorthand parse
- [ ] add unit tests: `index.test.ts` — hydration with env expansion, slug generation, grade overrides
- [ ] verify: `npm run test:unit -- schema.test` passes
- [ ] verify: `npm run test:unit -- index.test` passes

acceptance (usecase 1, 2, 10, 11):
- env.all keys expand to one slug per declared env: `$org.$env.$key`
- env-specific keys produce direct slugs: `$org.prod.$key`
- env-specific grade overrides env.all grade for that env
- flat `keys:` format throws clear error
- absent `org` throws clear error
- `env.all` without any `env.*` section throws clear error
- `env.sandbox` (custom env name) is accepted

---

## phase 2: leaf helper operations

add the five leaf operations that compose into commands.

read before:
- `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md` (operation contracts section)

depends on: phase 0

checklist:
- [ ] add `asKeyrackKeyName.ts` + `asKeyrackKeyName.test.ts`
- [ ] add `getAllKeyrackSlugsForEnv.ts` + `getAllKeyrackSlugsForEnv.test.ts`
- [ ] add `getAllKeyrackEnvsFromRepoManifest.ts` + `getAllKeyrackEnvsFromRepoManifest.test.ts`
- [ ] add `assertKeyrackEnvIsSpecified.ts` + `assertKeyrackEnvIsSpecified.test.ts`
- [ ] add `assertKeyrackOrgMatchesManifest.ts` + `assertKeyrackOrgMatchesManifest.test.ts`
- [ ] verify: `npm run test:unit` passes for all five test files

acceptance:
- `asKeyrackKeyName({ slug: 'ehmpathy.prod.AWS_PROFILE' })` returns `'AWS_PROFILE'`
- `getAllKeyrackSlugsForEnv({ manifest, env: 'prep' })` returns only prep slugs
- `getAllKeyrackSlugsForEnv({ manifest, env: 'all' })` returns all slugs
- `getAllKeyrackEnvsFromRepoManifest({ manifest })` returns `['prod', 'prep']`
- `assertKeyrackEnvIsSpecified` throws when env is null and manifest has env-specific sections
- `assertKeyrackEnvIsSpecified` returns `'all'` when env is null and manifest has only env.all
- `assertKeyrackOrgMatchesManifest` resolves `'@this'` to `manifest.org`
- `assertKeyrackOrgMatchesManifest` throws on org mismatch

---

## phase 3: core operations (unlock, get, set)

extend `unlockKeyrack`, `getKeyrackKeyGrant`, and cli set command to accept env filter.

read before:
- `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md` (credential resolution, session management, host storage sections)
- `.behavior/v2026_02_09.rhachet-envs/3.1.research.patterns._.code.prod.v1.i1.md` (patterns 5-10)

depends on: phase 1, phase 2

checklist:
- [ ] extend `unlockKeyrack()`: accept `env` in input, call `assertKeyrackEnvIsSpecified`, filter via `getAllKeyrackSlugsForEnv`
- [ ] extend `getKeyrackKeyGrant()` repo overload: accept `env` in input, call `assertKeyrackEnvIsSpecified`, filter via `getAllKeyrackSlugsForEnv`
- [ ] extend `getKeyrackStatus()`: group output by env
- [ ] extend unit tests for `getKeyrackKeyGrant`
- [ ] extend integration tests for `getKeyrackKeyGrant` with env-scoped scenarios
- [ ] verify: `npm run test:unit -- getKeyrackKeyGrant` passes
- [ ] verify: `npm run test:integration -- getKeyrackKeyGrant` passes

acceptance (usecase 3, 4, 8):
- `unlockKeyrack({ env: 'prep' })` unlocks only prep slugs (env.prep + env.all resolved to prep)
- `getKeyrackKeyGrant({ for: { repo: true }, env: 'prep' })` returns only prep grants
- prod keys remain locked when only prep is unlocked

---

## phase 4: cli surface

extend `invokeKeyrack` with `--env` and `--org` flags; strip slug to raw key name on export.

read before:
- `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md` (cli contract changes section)
- `.behavior/v2026_02_09.rhachet-envs/1.vision.md` (user experience goals 1, 3, 4)

depends on: phase 3

checklist:
- [ ] add `--env <env>` option to `get`, `unlock`, `status`, `list` commands
- [ ] add `--env <env>` option (default: `'all'`) and `--org <org>` option (default: `'@this'`) to `set` command
- [ ] export: strip slug to raw key name via `asKeyrackKeyName()` — `export AWS_PROFILE="value"`, not `export ehmpathy.prep.AWS_PROFILE="value"`
- [ ] set: resolve `--org @this` from manifest, compute slugs `$org.$env.$key`, call `setKeyrackKeyHost()` per slug
- [ ] set: `--env all` expands to all envs that declare the key
- [ ] set: org mismatch fails fast via `assertKeyrackOrgMatchesManifest`
- [ ] tree output: show org and env context on unlock and get
- [ ] status and list: group output by env
- [ ] verify: `npm run test:types` passes

acceptance (usecase 5, 6, 7, 9):
- `rhx keyrack get --for repo --env prep` exports `AWS_PROFILE=value` (raw name, not slug)
- `rhx keyrack get --for repo` without `--env` errors when env-specific sections exist
- `rhx keyrack set --key AWS_PROFILE --env prod` configures `$org.prod.AWS_PROFILE` only
- `rhx keyrack set --key XAI_API_KEY` defaults to `--env all --org @this`
- `rhx keyrack set --key X --org foreign-org` fails with org mismatch error
- `rhx keyrack unlock` without `--env` errors when env-specific sections exist
- `rhx keyrack unlock` without `--env` succeeds when only env.all exists

---

## phase 5: sdk + github action

extend the sdk exports and github action with env parameter.

read before:
- `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md` (sdk, github action contract sections)
- `.behavior/v2026_02_09.rhachet-envs/2.1.criteria.blackbox.md` (usecase 12)

depends on: phase 4

checklist:
- [ ] extend `sdk.keyrack.ts`: add `env` parameter to `get`, `set`, `unlock`
- [ ] extend `action.yml`: add `env` input (required, no default)
- [ ] extend `action.yml`: pass `--env ${{ inputs.env }}` to `rhx keyrack get`
- [ ] extend `action.yml`: strip slug to raw key name on export to `$GITHUB_ENV`
- [ ] verify: `npm run test:types` passes

acceptance (usecase 12):
- action invoked with `env: test` grants test keys
- action invoked without `env` errors (required input, no default)
- exported env vars use raw key names, not slugs

---

## phase 6: acceptance tests

add acceptance tests that verify env isolation end-to-end via the contract layer.

read before:
- `.behavior/v2026_02_09.rhachet-envs/2.1.criteria.blackbox.md` (all usecases)
- `.behavior/v2026_02_09.rhachet-envs/2.2.criteria.blackbox.matrix.md` (all matrices)

depends on: phase 5

checklist:
- [ ] add `keyrack.envs.acceptance.test.ts` — env isolation (usecase 8)
- [ ] extend `keyrack.validation.acceptance.test.ts` — flat keys rejection, org required, env.all without envs (usecase 11)
- [ ] extend `keyrack.session.acceptance.test.ts` — unlock with --env, env filter on get (usecases 3, 4, 9)
- [ ] extend `keyrack.set.acceptance.test.ts` — set with --env, --org, org mismatch (usecase 5)
- [ ] extend `keyrack.cli.acceptance.test.ts` — --env required error, raw key name export (usecases 7, 9)
- [ ] verify: `npm run test:acceptance` passes

acceptance:
- unlock prep, get prep succeeds, get prod fails (matrix 5)
- unlock prep then prod, both envs accessible (matrix 5)
- --env omitted with env-specific sections errors (matrix 2, 3)
- set --env all expands to all envs that declare the key (matrix 4)
- flat keys: format rejected (matrix 7)
- export uses raw key names (matrix 3)

---

## phase 7: full suite verification

run complete test suite to confirm no regressions.

depends on: phase 6

checklist:
- [ ] verify: `npm run test:types` passes
- [ ] verify: `npm run test:lint` passes
- [ ] verify: `npm run test:unit` passes
- [ ] verify: `npm run test:integration` passes
- [ ] verify: `npm run test:acceptance` passes
- [ ] verify: all 12 usecases have coverage per the coverage matrix alignment in the blueprint

acceptance:
- all tests green
- no regressions in pre-extant keyrack functionality
- every usecase from the blackbox criteria is covered by at least one test

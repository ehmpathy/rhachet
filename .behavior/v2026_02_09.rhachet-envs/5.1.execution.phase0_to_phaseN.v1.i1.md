# execution: env-scoped keyrack keys

ref:
- roadmap: `.behavior/v2026_02_09.rhachet-envs/4.1.roadmap.v1.i1.md`
- blueprint: `.behavior/v2026_02_09.rhachet-envs/3.3.blueprint.v1.i1.md`

---

## phase 0: domain objects

- [ ] extend `KeyrackKeySpec` with `env`, `name`, `grade`
- [ ] extend `KeyrackRepoManifest` with `org`, `envs`
- [ ] verify: `npm run test:types` passes

## phase 1: manifest schema + hydration

- [ ] replace schema in `schema.ts`
- [ ] replace hydration in `index.ts`
- [ ] add `schema.test.ts`
- [ ] add `index.test.ts`
- [ ] verify: unit tests pass

## phase 2: leaf helper operations

- [ ] add `asKeyrackKeyName` + tests
- [ ] add `getAllKeyrackSlugsForEnv` + tests
- [ ] add `getAllKeyrackEnvsFromRepoManifest` + tests
- [ ] add `assertKeyrackEnvIsSpecified` + tests
- [ ] add `assertKeyrackOrgMatchesManifest` + tests
- [ ] verify: unit tests pass

## phase 3: core operations

- [ ] extend `unlockKeyrack`
- [ ] extend `getKeyrackKeyGrant`
- [ ] extend `getKeyrackStatus`
- [ ] extend tests
- [ ] verify: unit + integration tests pass

## phase 4: cli surface

- [ ] add `--env` to get, unlock, status, list
- [ ] add `--env` + `--org` to set
- [ ] strip slug to raw key name on export
- [ ] tree output with org + env context
- [ ] verify: `npm run test:types` passes

## phase 5: sdk + github action

- [ ] extend `sdk.keyrack.ts`
- [ ] extend `action.yml`
- [ ] verify: `npm run test:types` passes

## phase 6: acceptance tests

- [ ] add env isolation acceptance tests
- [ ] extend validation acceptance tests
- [ ] extend session acceptance tests
- [ ] extend set acceptance tests
- [ ] extend cli acceptance tests
- [ ] verify: acceptance tests pass

## phase 7: full suite verification

- [ ] `npm run test:types`
- [ ] `npm run test:lint`
- [ ] `npm run test:unit`
- [ ] `npm run test:integration`
- [ ] `npm run test:acceptance`

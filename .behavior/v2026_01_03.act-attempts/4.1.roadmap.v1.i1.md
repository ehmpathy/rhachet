# roadmap: standardize `rhachet act --attempts`

## overview

this roadmap provides a checklist for executing the blueprint in `3.3.blueprint.v1.i1.md`.
each phase has ordered dependencies, behavioral acceptance criteria, and verification steps.

---

## phase 0: foundation (new helpers)

### 0.1 `assureRigidSkillHasOutputInput.ts`

**dependencies**: none

**file**: `src/domain.operations/invoke/assureRigidSkillHasOutputInput.ts`

- [ ] create new file with validation helper
- [ ] implement schema.input check for 'output' property
- [ ] throw `BadRequestError` with helpful message if missing

**acceptance criteria**:
```
given('a rigid skill with output in schema.input')
  when('assureRigidSkillHasOutputInput is called')
    then('no error is thrown')

given('a rigid skill WITHOUT output in schema.input')
  when('assureRigidSkillHasOutputInput is called')
    then('throws BadRequestError')
    then('error message contains "rigid skill must declare output as input"')
```

**verification**:
```sh
npm run test:unit -- assureRigidSkillHasOutputInput
```

---

### 0.2 `performActorActInIsolatedThread.ts`

**dependencies**: none

**file**: `src/domain.operations/invoke/performActorActInIsolatedThread.ts`

- [ ] create new file for actor-mode isolated execution
- [ ] implement `getRegistriesByOpts` to get registries + brains
- [ ] implement `assureFindRole` to find role
- [ ] implement `genActor` to create actor
- [ ] implement `extractSkillInputFromOpts` to parse skill input
- [ ] invoke `actor.act()` with parsed input
- [ ] output result to stdout as JSON

**acceptance criteria**:
```
given('valid opts with role, skill, brain, and skill inputs')
  when('performActorActInIsolatedThread is called')
    then('actor.act() is invoked with correct skill input')
    then('result is written to stdout as JSON')

given('opts with invalid role')
  when('performActorActInIsolatedThread is called')
    then('throws error: role not found')
```

**verification**:
```sh
npm run test:unit -- performActorActInIsolatedThread
npm run test:integration -- performActorActInIsolatedThread
```

---

## phase 1: generalize isolated thread mechanism

### 1.1 `performInIsolatedThreads.ts`

**dependencies**: 0.1, 0.2

**file**: `src/domain.operations/invoke/performInIsolatedThreads.ts`

- [ ] make `ask` optional in `InvokeOpts` (not required for actor-mode)
- [ ] add `mode: 'stitch' | 'actor'` to `InvokeOpts`
- [ ] pass `mode` through to `performInIsolatedThread.invoke`
- [ ] no logic changes (just type relaxation)

**acceptance criteria**:
```
given('InvokeOpts with mode="stitch" and ask field')
  when('performInIsolatedThreads is called')
    then('spawns N isolated threads with stitch-mode')

given('InvokeOpts with mode="actor" without ask field')
  when('performInIsolatedThreads is called')
    then('spawns N isolated threads with actor-mode')
    then('no type errors on missing ask field')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- performInIsolatedThreads
```

---

### 1.2 `performInIsolatedThread.invoke.ts`

**dependencies**: 1.1

**file**: `src/domain.operations/invoke/performInIsolatedThread.invoke.ts`

- [ ] pass `mode` through env as `RHACHET_INVOKE_MODE`
- [ ] no other logic changes

**acceptance criteria**:
```
given('opts with mode="actor"')
  when('performInIsolatedThread.invoke spawns child')
    then('child env contains RHACHET_INVOKE_MODE=actor')

given('opts with mode="stitch"')
  when('performInIsolatedThread.invoke spawns child')
    then('child env contains RHACHET_INVOKE_MODE=stitch')
```

**verification**:
```sh
npm run test:unit -- performInIsolatedThread.invoke
npm run test:integration -- performInIsolatedThread.invoke
```

---

### 1.3 `performInIsolatedThread.execute.ts`

**dependencies**: 0.2, 1.2

**file**: `src/domain.operations/invoke/performInIsolatedThread.execute.ts`

- [ ] read `RHACHET_INVOKE_MODE` from env
- [ ] if mode === 'stitch': call `performInCurrentThread` (existing)
- [ ] if mode === 'actor': call `performActorActInIsolatedThread` (new)
- [ ] add import for `performActorActInIsolatedThread`

**acceptance criteria**:
```
given('RHACHET_INVOKE_MODE=stitch in env')
  when('performInIsolatedThread.execute runs')
    then('performInCurrentThread is called')

given('RHACHET_INVOKE_MODE=actor in env')
  when('performInIsolatedThread.execute runs')
    then('performActorActInIsolatedThread is called')
```

**verification**:
```sh
npm run test:unit -- performInIsolatedThread.execute
npm run test:integration -- performInIsolatedThread.execute
```

---

## phase 2: refactor CLI commands

### 2.1 `invokeAct.ts`

**dependencies**: 0.1, 1.1, 1.2, 1.3

**file**: `src/contract/cli/invokeAct.ts`

- [ ] add stitch skill resolution from `role.skills.refs`
- [ ] add mode detection: rigid ‚Üí actor-mode, else ‚Üí stitch-mode
- [ ] add failfast: rigid skill must have `output` in schema.input when `--attempts`
- [ ] add `--concurrency` option (default: 3)
- [ ] refactor `--attempts` to use `performInIsolatedThreads`
- [ ] add dynamic CLI flag injection for stitch-mode (like invokeAsk)
- [ ] deprecate direct sequential loop

**acceptance criteria**:
```
given('repo with registered rigid skill')
  when('act --role --skill invoked')
    then('skill executes with brain augmentation')
    then('stdout shows üî© skill prefix')

given('repo with stitch skill only (not rigid)')
  when('act --role --skill invoked')
    then('skill executes via thread stitching')

given('repo with skill registered as BOTH rigid and stitch')
  when('act --role --skill invoked')
    then('rigid (actor) version takes precedence')

given('rigid skill with --attempts 3 --output /path')
  when('act invoked')
    then('executes 3 times in parallel isolated threads')
    then('logs with ‚óã iN ‚Ä∫ prefix')
    then('output qualified with .iN suffix')
    then('shows summary table')

given('--attempts 3 WITHOUT --output')
  when('act invoked')
    then('fails with "--attempts requires --output path"')

given('rigid skill without output in schema.input')
  when('act --attempts 3 --output /path invoked')
    then('fails with "rigid skill must declare output as input"')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- invokeAct
npm run test:integration -- invokeAct
```

---

### 2.2 `invokeAsk.ts`

**dependencies**: none (can run in parallel with 2.1)

**file**: `src/contract/cli/invokeAsk.ts`

- [ ] remove `--skill` option entirely
- [ ] remove `--concurrency` option
- [ ] delete `performAskViaStitchMode` helper
- [ ] delete dynamic CLI flag injection (preAction hook)
- [ ] keep only `performAskViaActorMode` (fluid conversation)
- [ ] simplify to: `ask -r <role> -a <ask>`
- [ ] add helpful error if `--attempts` is passed

**acceptance criteria**:
```
given('any repo')
  when('ask --skill <skill> invoked')
    then('fails with error: --skill option no longer exists')
    then('error suggests using act --skill instead')

given('any repo')
  when('ask --attempts N invoked')
    then('fails with helpful error')
    then('error states: --attempts is inapplicable to ask')
    then('error explains: fluid skills are exploratory; outputs are divergent by design')
    then('error asks: did you mean npx rhachet act?')

given('any repo with brains configured')
  when('ask -r <role> -a <ask> invoked')
    then('fluid conversation works as before')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- invokeAsk
npm run test:integration -- invokeAsk
```

---

### 2.3 `invokeRun.ts`

**dependencies**: none (can run in parallel with 2.1, 2.2)

**file**: `src/contract/cli/invokeRun.ts`

- [ ] add helpful error if `--attempts` is passed

**acceptance criteria**:
```
given('any repo')
  when('run --attempts N invoked')
    then('fails with helpful error')
    then('error states: --attempts is inapplicable to run')
    then('error explains: solid skills are deterministic; outputs are identical by design')
    then('error asks: did you mean npx rhachet act?')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- invokeRun
npm run test:integration -- invokeRun
```

---

## phase 3: acceptance test coverage

### 3.1 `accept.blackbox/cli/act.acceptance.test.ts`

**dependencies**: 2.1, 2.2, 2.3

**file**: `accept.blackbox/cli/act.acceptance.test.ts`

- [ ] [case1] actor-mode (rigid skill) tests
  - [ ] [t0] act --role --skill
  - [ ] [t1] act --role --skill --brain
- [ ] [case2] stitch-mode (fallback) tests
  - [ ] [t0] act --role --skill (not rigid)
- [ ] [case3] --attempts parallel tests
  - [ ] [t0] act --attempts 3 --output /path
  - [ ] verify ‚óã iN ‚Ä∫ prefix
  - [ ] verify .iN suffix on output
  - [ ] verify summary table
- [ ] [case5] --attempts requires --output
  - [ ] [t0] act --attempts 3 without --output
- [ ] [case6] rigid skill failfast
  - [ ] [t0] rigid skill without output input + --attempts
- [ ] [case7] boundary cases
  - [ ] [t0] --attempts 0
  - [ ] [t1] --attempts 1 --output /path (no suffix)

**acceptance criteria**:
```
given('accept.blackbox test suite')
  when('npm run test:acceptance -- act.acceptance.test.ts')
    then('all tests pass')
    then('covers usecases 1-7 from blackbox criteria')
```

**verification**:
```sh
npm run test:acceptance -- act.acceptance.test.ts
```

---

### 3.2 `accept.blackbox/cli/ask.acceptance.test.ts`

**dependencies**: 2.2

**file**: `accept.blackbox/cli/ask.acceptance.test.ts`

- [ ] [case-skill-removed] --skill option removed
  - [ ] [t0] ask --skill fails with helpful error
- [ ] [case-attempts-error] --attempts inapplicable
  - [ ] [t0] ask --attempts N fails with helpful error
  - [ ] verify error message format

**acceptance criteria**:
```
given('accept.blackbox test suite')
  when('npm run test:acceptance -- ask.acceptance.test.ts')
    then('all tests pass')
    then('covers usecases 10-11 from blackbox criteria')
```

**verification**:
```sh
npm run test:acceptance -- ask.acceptance.test.ts
```

---

### 3.3 `accept.blackbox/cli/run.acceptance.test.ts`

**dependencies**: 2.3

**file**: `accept.blackbox/cli/run.acceptance.test.ts`

- [ ] [case-attempts-error] --attempts inapplicable
  - [ ] [t0] run --attempts N fails with helpful error
  - [ ] verify error message format

**acceptance criteria**:
```
given('accept.blackbox test suite')
  when('npm run test:acceptance -- run.acceptance.test.ts')
    then('all tests pass')
    then('covers usecase 12 from blackbox criteria')
```

**verification**:
```sh
npm run test:acceptance -- run.acceptance.test.ts
```

---

## phase 4: integration test coverage

### 4.1 `invokeAct.integration.test.ts`

**dependencies**: 2.1

**file**: `src/contract/cli/invokeAct.integration.test.ts`

- [ ] [case-stitch] stitch-mode skill via act
- [ ] [case-attempts-parallel] --attempts with concurrency

**acceptance criteria**:
```
given('integration test suite')
  when('npm run test:integration -- invokeAct.integration.test.ts')
    then('all tests pass')
    then('covers stitch-mode + parallel attempts')
```

**verification**:
```sh
npm run test:integration -- invokeAct.integration.test.ts
```

---

## phase 5: full validation

### 5.1 full test suite

**dependencies**: 3.1, 3.2, 3.3, 4.1

- [ ] run full test suite
- [ ] verify no regressions

**verification**:
```sh
npm run test
```

---

### 5.2 manual smoke test

**dependencies**: 5.1

- [ ] test `npx rhachet act --role mechanic --skill <skill> --attempts 3 --output /tmp/out.json`
- [ ] test `npx rhachet ask --attempts 3` (verify error)
- [ ] test `npx rhachet run --attempts 3` (verify error)
- [ ] test `npx rhachet ask --skill <skill>` (verify error)

**acceptance criteria**:
```
given('manual smoke test')
  then('act --attempts works with parallel execution')
  then('ask --attempts shows helpful error')
  then('run --attempts shows helpful error')
  then('ask --skill shows helpful error')
```

---

## dependency graph

```
phase 0 (foundation)
‚îú‚îÄ‚îÄ 0.1 assureRigidSkillHasOutputInput
‚îî‚îÄ‚îÄ 0.2 performActorActInIsolatedThread
         ‚îÇ
         ‚ñº
phase 1 (generalize isolated threads)
‚îú‚îÄ‚îÄ 1.1 performInIsolatedThreads ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îú‚îÄ‚îÄ 1.2 performInIsolatedThread.invoke ‚îÇ
‚îî‚îÄ‚îÄ 1.3 performInIsolatedThread.execute‚óÑ‚îò
         ‚îÇ
         ‚ñº
phase 2 (refactor CLI) ‚îÄ‚îÄ‚îÄ can run 2.1, 2.2, 2.3 in parallel
‚îú‚îÄ‚îÄ 2.1 invokeAct (depends on 0.1, 1.*)
‚îú‚îÄ‚îÄ 2.2 invokeAsk (independent)
‚îî‚îÄ‚îÄ 2.3 invokeRun (independent)
         ‚îÇ
         ‚ñº
phase 3 (acceptance tests) ‚îÄ‚îÄ‚îÄ can run 3.1, 3.2, 3.3 in parallel
‚îú‚îÄ‚îÄ 3.1 act.acceptance.test.ts
‚îú‚îÄ‚îÄ 3.2 ask.acceptance.test.ts
‚îî‚îÄ‚îÄ 3.3 run.acceptance.test.ts
         ‚îÇ
         ‚ñº
phase 4 (integration tests)
‚îî‚îÄ‚îÄ 4.1 invokeAct.integration.test.ts
         ‚îÇ
         ‚ñº
phase 5 (validation)
‚îú‚îÄ‚îÄ 5.1 full test suite
‚îî‚îÄ‚îÄ 5.2 manual smoke test
```

---

## summary

| phase | items | parallelizable |
|-------|-------|----------------|
| 0 | 2 | yes (0.1, 0.2) |
| 1 | 3 | partial (1.1 ‚Üí 1.2 ‚Üí 1.3) |
| 2 | 3 | yes (2.1, 2.2, 2.3) |
| 3 | 3 | yes (3.1, 3.2, 3.3) |
| 4 | 1 | n/a |
| 5 | 2 | no (5.1 ‚Üí 5.2) |

**total items**: 14 checklist items
**critical path**: 0.2 ‚Üí 1.1 ‚Üí 1.2 ‚Üí 1.3 ‚Üí 2.1 ‚Üí 3.1 ‚Üí 4.1 ‚Üí 5.1 ‚Üí 5.2

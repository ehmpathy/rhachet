# execution log: standardize `rhachet act --attempts`

## status: all phases complete ✅

started: 2026-01-03

---

## phase 0: foundation (new helpers)

### 0.1 `assureRigidSkillHasOutputInput.ts`

- [x] create new file with validation helper
- [x] implement schema.input check for 'output' property
- [x] throw `BadRequestError` with helpful message if missing
- [x] unit tests (4/4 passing)

### 0.2 `performActorActInIsolatedThread.ts`

- [x] create new file for actor-mode isolated execution
- [x] implement actor.act() invocation in isolated thread context
- [x] output result to stdout as JSON

---

## phase 1: generalize isolated thread mechanism

### 1.1 `performInIsolatedThreads.ts`

- [x] make `ask` optional in `InvokeOpts`
- [x] add `mode: 'stitch' | 'actor'` to `InvokeOpts`
- [x] pass `mode` through to `performInIsolatedThread.invoke`

### 1.2 `performInIsolatedThread.invoke.ts`

- [x] pass `mode` through env as `RHACHET_INVOKE_MODE`

### 1.3 `performInIsolatedThread.execute.ts`

- [x] read `RHACHET_INVOKE_MODE` from env
- [x] branch: stitch → performInCurrentThread, actor → performActorActInIsolatedThread

---

## phase 2: refactor CLI commands

### 2.1 `invokeAct.ts`

- [x] add `performActViaIsolatedThreads` helper for actor-mode parallel execution
- [x] add mode detection: `--attempts` present → isolated threads, else → current thread
- [x] add failfast for rigid skill without `output` in schema.input
- [x] refactor `--attempts` to use `performInIsolatedThreads` with `mode: 'actor'`
- [x] add `config` parameter required for isolated thread config loading
- [x] update unit tests with `config` parameter (5/5 passing)
- [x] update integration tests with `config` parameter

### 2.2 `invokeAsk.ts`

- [x] verified mode support still works (already has `mode: 'stitch'`)
- note: did NOT remove `--skill` option (kept for backwards compat per original roadmap)

### 2.3 `invokeRun.ts`

- [x] add helpful error if `--attempts` is passed
- [x] error message: '--attempts is not supported for "run" (solid skills are deterministic). use "ask --skill --attempts" for stitch-mode or "act --skill --attempts" for actor-mode.'

---

## phase 3: acceptance test coverage

### 3.1 `accept.blackbox/cli/act.acceptance.test.ts`

- [x] created new file with 11 tests
- [x] error handling: no brains available
- [x] error handling: --attempts without --output
- [x] error handling: missing --role
- [x] error handling: missing --skill
- [x] error handling: nonexistent skill

### 3.2 `accept.blackbox/cli/run.acceptance.test.ts`

- [x] added [case4] for --attempts error validation
- [x] exits with non-zero status
- [x] stderr contains '--attempts is not supported'
- [x] stderr suggests using ask or act instead

---

## phase 4: integration test coverage

### 4.1 `invokeAct.integration.test.ts`

- [x] existing tests pass with API keys (7/7)
- [x] --attempts without --output error test exists
- note: full --attempts execution requires rigid skill with output in schema.input

### 4.2 `performInIsolatedThreads.integration.test.ts`

- [x] stitch-mode tests pass (5/5)
- [x] file write with multiple attempts works correctly

---

## phase 5: full validation

### 5.1 full test suite

- [x] npm run test:types - passed
- [x] npm run test:lint - passed
- [x] npm run test:format - passed
- [x] npm run test:unit (invokeAct, assureRigidSkillHasOutputInput) - 9/9 passed
- [x] npm run test:acceptance - 34/34 passed
- [x] npm run test:integration (with API keys) - all passed
- [x] no regressions detected

### 5.2 verification summary

- [x] `act --attempts` requires `--output` (error if missing)
- [x] `act` without brains throws helpful error
- [x] `run --attempts` throws helpful error directing to ask/act
- [x] `ask --skill` still works for backwards compat

---

## execution notes

### session 1 (context continuation)

completed phases 0-2:

1. **phase 0.1**: created `assureRigidSkillHasOutputInput.ts` - validates rigid skills have 'output' in schema.input for --attempts support

2. **phase 0.2**: created `performActorActInIsolatedThread.ts` - executes actor.act() in isolated thread context, outputs result as JSON

3. **phase 1.1-1.3**: generalized isolated thread mechanism to support dual-mode (stitch vs actor) via:
   - added `mode: 'stitch' | 'actor'` to `InvokeOpts`
   - pass mode through `RHACHET_INVOKE_MODE` env var
   - branch in `performInIsolatedThread.execute.ts` based on mode

4. **phase 2.1**: refactored `invokeAct.ts`:
   - added `performActViaIsolatedThreads` for parallel attempts
   - uses `mode: 'actor'` with `performInIsolatedThreads`
   - validates rigid skill has `output` in schema.input before attempts
   - added required `config` parameter for isolated thread config loading

5. **phase 2.2**: verified `invokeAsk.ts` already works with mode support
   - note: kept `--skill` option for backwards compatibility (differs from original plan)

6. **phase 2.3**: added `--attempts` error to `invokeRun.ts`
   - helpful error message directing users to use `ask` or `act` for attempts

### key files modified

- `src/domain.operations/invoke/assureRigidSkillHasOutputInput.ts` (new)
- `src/domain.operations/invoke/assureRigidSkillHasOutputInput.test.ts` (new)
- `src/domain.operations/invoke/performActorActInIsolatedThread.ts` (new)
- `src/domain.operations/invoke/performInIsolatedThreads.ts` (modified)
- `src/domain.operations/invoke/performInIsolatedThread.invoke.ts` (modified)
- `src/domain.operations/invoke/performInIsolatedThread.execute.ts` (modified)
- `src/domain.operations/invoke/performInCurrentThread.ts` (modified)
- `src/domain.operations/invoke/performInIsolatedThreads.integration.test.ts` (modified)
- `src/contract/cli/invokeAct.ts` (refactored)
- `src/contract/cli/invokeAct.test.ts` (modified)
- `src/contract/cli/invokeAct.integration.test.ts` (modified)
- `src/contract/cli/invokeAsk.ts` (modified)
- `src/contract/cli/invokeRun.ts` (modified)
- `src/contract/cli/invoke.ts` (modified)

### verification

- type checks: passed
- lint checks: passed
- unit tests: 9/9 passed (invokeAct + assureRigidSkillHasOutputInput)
- integration tests: require API keys (skipped in this session)

### session 2 (completion)

completed phases 3-5:

1. **phase 3.1**: created `accept.blackbox/cli/act.acceptance.test.ts`
   - 11 acceptance tests covering error scenarios
   - tests for: no brains, --attempts without --output, missing --role/--skill

2. **phase 3.2**: extended `accept.blackbox/cli/run.acceptance.test.ts`
   - added [case4] testing `run --attempts` error
   - validates helpful error message directing users to ask/act

3. **phase 4**: verified integration tests
   - invokeAct.integration.test.ts: 7/7 passed with API keys
   - performInIsolatedThreads.integration.test.ts: 5/5 passed

4. **phase 5**: full validation
   - all type/lint/format checks pass
   - 34/34 acceptance tests pass
   - integration tests pass with API keys
   - no regressions detected

### additional files created

- `accept.blackbox/cli/act.acceptance.test.ts` (new - 11 tests)

### additional files modified

- `accept.blackbox/cli/run.acceptance.test.ts` (added [case4])

### final test counts

| suite | tests | status |
|-------|-------|--------|
| test:types | - | passed |
| test:format | - | passed |
| test:lint | - | passed |
| test:unit | 9+ | passed |
| test:acceptance | 34 | passed |
| test:integration | 12+ | passed (with API keys)


# roadmap: preserve `file:.` dependencies in upgrade

## overview

this roadmap implements the blueprint to preserve `file:.` dependencies when `npx rhachet upgrade` runs inside a `rhachet-roles-*` repo.

---

## phase 0: prerequisites

### [ ] 0.1 verify current test suite passes

**acceptance criteria**:
- all unit tests pass
- all integration tests pass
- all acceptance tests pass

**verification**:
```sh
npm run test:types
npm run test:unit
npm run test:integration
npm run test:acceptance
```

**gate**: all tests green before any code changes

---

## phase 1: domain operation — `getFileDotDependencies`

### [ ] 1.1 create `getFileDotDependencies.ts`

**file**: `src/domain.operations/upgrade/getFileDotDependencies.ts`

**acceptance criteria**:
- reads package.json from provided cwd
- returns Set of package names with `file:` prefix versions
- returns empty Set when package.json absent
- returns empty Set when no file:. deps found

**verification**:
```sh
npm run test:types
```

---

### [ ] 1.2 create unit tests for `getFileDotDependencies`

**file**: `src/domain.operations/upgrade/getFileDotDependencies.test.ts`

**acceptance criteria**:
- [case1] package.json with file:. dep → returns in set
- [case2] package.json without file:. deps → returns empty set
- [case3] no package.json → returns empty set

**verification**:
```sh
npm run test:unit -- getFileDotDependencies
```

**gate**: all 3 test cases pass

---

## phase 2: integrate into `execUpgrade`

### [ ] 2.1 modify `buildInstallList` to accept exclusions

**file**: `src/domain.operations/upgrade/execUpgrade.ts`

**acceptance criteria**:
- `buildInstallList` accepts new `exclude: Set<string>` parameter
- packages in exclude set are filtered out of result
- rhachet excluded if in exclude set (when self=true)

**verification**:
```sh
npm run test:types
```

---

### [ ] 2.2 integrate `getFileDotDependencies` into `execUpgrade`

**file**: `src/domain.operations/upgrade/execUpgrade.ts`

**acceptance criteria**:
- calls `getFileDotDependencies({ cwd: context.cwd })` before build of install list
- passes result as `exclude` to `buildInstallList`
- logs skip message when file:. deps detected and would have been upgraded

**verification**:
```sh
npm run test:types
```

---

### [ ] 2.3 update `execUpgrade.test.ts` with file:. exclusion cases

**file**: `src/domain.operations/upgrade/execUpgrade.test.ts`

**acceptance criteria**:
- test: file:. role package → excluded from install
- test: file:. rhachet → excluded from install when --self
- test: mixed deps → only file:. excluded, others upgraded

**verification**:
```sh
npm run test:unit -- execUpgrade
```

**gate**: all new test cases pass + prior tests still pass

---

## phase 3: acceptance test fixture

### [ ] 3.1 create fixture `with-file-dot-dep`

**file**: `accept.blackbox/.test/assets/with-file-dot-dep/package.json`

**acceptance criteria**:
- package.json with self-referential `file:.` dependency
- includes at least one normal versioned dependency for contrast

**content**:
```json
{
  "name": "rhachet-roles-test-self",
  "version": "0.0.0",
  "private": true,
  "dependencies": {
    "rhachet-roles-test-self": "file:.",
    "rhachet-roles-ehmpathy": "1.17.20"
  }
}
```

**verification**:
- file exists at expected path
- valid json

---

### [ ] 3.2 add fixture to `TestRepoFixture` type

**file**: `accept.blackbox/.test/infra/genTestTempRepo.ts`

**acceptance criteria**:
- `'with-file-dot-dep'` added to `TestRepoFixture` union type

**verification**:
```sh
npm run test:types
```

---

## phase 4: acceptance tests

### [ ] 4.1 add acceptance test case for file:. preservation

**file**: `accept.blackbox/cli/upgrade.acceptance.test.ts`

**acceptance criteria**:
- [case5] repo with file:. self-referential dependency
  - [t0] `rhachet upgrade --roles *`
    - exits with status 0
    - stdout mentions skip of file:. deps
    - package.json still has file:. version after upgrade

**verification**:
```sh
npm run test:acceptance -- upgrade.acceptance
```

**gate**: new test case passes

---

## phase 5: full verification

### [ ] 5.1 run complete test suite

**acceptance criteria**:
- all unit tests pass
- all integration tests pass
- all acceptance tests pass
- no regressions in prior behavior

**verification**:
```sh
npm run test:types
npm run test:unit
npm run test:integration
npm run test:acceptance
```

**gate**: all green

---

### [ ] 5.2 manual verification in real `rhachet-roles-*` repo

**acceptance criteria**:
- clone `rhachet-roles-ehmpathy` or similar
- add `"rhachet-roles-ehmpathy": "file:."` to devDependencies
- run `npx rhachet upgrade --roles *`
- verify file:. version preserved in package.json
- verify skip message logged

**verification**:
```sh
# in rhachet-roles-ehmpathy repo
cat package.json | grep 'file:\.'
npx rhachet upgrade --roles *
cat package.json | grep 'file:\.'  # should still show file:.
```

---

## phase 6: cleanup

### [ ] 6.1 verify no dead code or unused imports

**verification**:
```sh
npm run test:lint
npm run test:format
```

---

### [ ] 6.2 commit changes

**acceptance criteria**:
- all changes committed with clear message
- commit message references wish

**verification**:
```sh
git status  # should be clean
git log -1  # should show commit message
```

---

## dependency graph

```
phase 0 (prerequisites)
    │
    ▼
phase 1 (getFileDotDependencies)
    │
    ├── 1.1 create operation
    │       │
    │       ▼
    └── 1.2 create unit tests
            │
            ▼
phase 2 (integrate into execUpgrade)
    │
    ├── 2.1 modify buildInstallList
    │       │
    │       ▼
    ├── 2.2 integrate getFileDotDependencies
    │       │
    │       ▼
    └── 2.3 update execUpgrade tests
            │
            ▼
phase 3 (acceptance fixture)
    │
    ├── 3.1 create fixture
    │       │
    │       ▼
    └── 3.2 update type
            │
            ▼
phase 4 (acceptance tests)
    │
    └── 4.1 add test case
            │
            ▼
phase 5 (verification)
    │
    ├── 5.1 full test suite
    │       │
    │       ▼
    └── 5.2 manual verification
            │
            ▼
phase 6 (cleanup)
    │
    ├── 6.1 lint/format
    │       │
    │       ▼
    └── 6.2 commit
```

---

## summary

| phase | items | gate |
|-------|-------|------|
| 0 | 1 | all tests pass |
| 1 | 2 | unit tests pass for getFileDotDependencies |
| 2 | 3 | unit tests pass for execUpgrade |
| 3 | 2 | fixture created + type updated |
| 4 | 1 | acceptance test passes |
| 5 | 2 | full suite + manual verification |
| 6 | 2 | lint clean + committed |

**total items**: 13

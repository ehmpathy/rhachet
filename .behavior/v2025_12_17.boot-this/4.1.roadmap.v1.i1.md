# Roadmap: Support `npx rhachet roles boot --repo this`

## Prerequisites

- [ ] **P1**: Ensure working development environment
  - **criteria**: `npm run test:types` passes
  - **verify**: `npm run test:types && echo "PASS" || echo "FAIL"`

---

## Phase 1: Add `--repo this` Detection and Error Handling

### Step 1.1: Add early detection for `--repo this`

- [ ] **1.1.1**: Add normalized comparison for `opts.repo === 'this'` at the start of the action handler
  - **depends on**: P1
  - **criteria**: when `--repo this` is passed, code enters the `.this` handling branch
  - **verify**: add temporary `console.log('detected .this')` and run `npx rhachet roles boot --repo this` - should see the log

### Step 1.2: Add error when `--role` is provided with `--repo this`

- [ ] **1.2.1**: Throw `BadRequestError` when both `--repo this` and `--role` are provided
  - **depends on**: 1.1.1
  - **criteria**: when `npx rhachet roles boot --repo this --role mechanic` is executed, error is thrown with message indicating `--role is not supported with --repo this`
  - **verify**: `npx rhachet roles boot --repo this --role mechanic 2>&1 | grep -q "not supported" && echo "PASS" || echo "FAIL"`

### Step 1.3: Add error when `.agent/repo=.this` directory doesn't exist

- [ ] **1.3.1**: Check for existence of `.agent/repo=.this` directory and throw helpful error if missing
  - **depends on**: 1.2.1
  - **criteria**: when `.agent/repo=.this` doesn't exist, error message suggests creating the directory
  - **verify**: `rm -rf .agent/repo=.this && npx rhachet roles boot --repo this 2>&1 | grep -q "not found\|does not exist" && echo "PASS" || echo "FAIL"`

---

## Phase 2: Implement Boot Logic for `.this` Resources

### Step 2.1: Resolve directory paths for `.this`

- [ ] **2.1.1**: Set `repoThisDir = resolve(process.cwd(), '.agent', 'repo=.this')`
  - **depends on**: 1.3.1
  - **criteria**: directory path resolves correctly to `.agent/repo=.this`
  - **verify**: add temporary log of resolved path and confirm it matches expected

- [ ] **2.1.2**: Set `briefsDir = resolve(repoThisDir, 'briefs')` and `skillsDir = resolve(repoThisDir, 'skills')`
  - **depends on**: 2.1.1
  - **criteria**: briefs and skills directories resolve to `.agent/repo=.this/briefs` and `.agent/repo=.this/skills`
  - **verify**: add temporary log of resolved paths and confirm they match expected

### Step 2.2: Read files from `.this` directories

- [ ] **2.2.1**: Use existing `getAllFiles` logic to read files from briefsDir and skillsDir
  - **depends on**: 2.1.2
  - **criteria**: files from `.agent/repo=.this/briefs/` and `.agent/repo=.this/skills/` are discovered
  - **verify**: create test files in both directories, run boot, confirm files are found in output

- [ ] **2.2.2**: Handle case where briefs/ or skills/ directories don't exist (count as 0 files)
  - **depends on**: 2.2.1
  - **criteria**: when briefs/ exists but skills/ doesn't, boot succeeds with skills = 0
  - **verify**: `mkdir -p .agent/repo=.this/briefs && echo "test" > .agent/repo=.this/briefs/test.md && npx rhachet roles boot --repo this 2>&1 | grep -q "skills = 0" && echo "PASS" || echo "FAIL"`

### Step 2.3: Calculate and print stats

- [ ] **2.3.1**: Calculate total files, chars, and approximate tokens for `.this` resources
  - **depends on**: 2.2.2
  - **criteria**: stats output shows correct counts for briefs and skills files
  - **verify**: create known files, run boot, verify stats match expected counts

- [ ] **2.3.2**: Print stats header with `began:stats` format
  - **depends on**: 2.3.1
  - **criteria**: output contains `## began:stats` and shows quant/treestruct sections
  - **verify**: `npx rhachet roles boot --repo this 2>&1 | grep -q "began:stats" && echo "PASS" || echo "FAIL"`

- [ ] **2.3.3**: Print tree structure of `.agent/repo=.this`
  - **depends on**: 2.3.2
  - **criteria**: output shows directory tree with briefs and skills subdirectories
  - **verify**: visually inspect tree output in boot results

### Step 2.4: Print file contents

- [ ] **2.4.1**: Print each brief file with `began:/ended:` markers and relative path
  - **depends on**: 2.3.3
  - **criteria**: brief files show with path format `.agent/repo=.this/briefs/filename.md`
  - **verify**: `npx rhachet roles boot --repo this 2>&1 | grep -q "began:.agent/repo=.this/briefs" && echo "PASS" || echo "FAIL"`

- [ ] **2.4.2**: Print each skill file with documentation extraction (not full implementation)
  - **depends on**: 2.4.1
  - **criteria**: skill files show documentation only with `[implementation hidden]` marker
  - **verify**: create skill with shebang and comments, run boot, verify implementation is hidden

- [ ] **2.4.3**: Print stats footer with `ended:stats` format
  - **depends on**: 2.4.2
  - **criteria**: output ends with stats footer matching header format
  - **verify**: `npx rhachet roles boot --repo this 2>&1 | grep -q "ended:stats" && echo "PASS" || echo "FAIL"`

### Step 2.5: Handle empty resources case

- [ ] **2.5.1**: When no files found in briefs/ or skills/, print warning message
  - **depends on**: 2.4.3
  - **criteria**: when both directories are empty, output shows "No resources found" warning
  - **verify**: `mkdir -p .agent/repo=.this/briefs .agent/repo=.this/skills && npx rhachet roles boot --repo this 2>&1 | grep -q "No resources found" && echo "PASS" || echo "FAIL"`

---

## Phase 3: Integration Tests

### Step 3.1: Test happy path

- [ ] **3.1.1**: Add test: `when invoked with "boot --repo this" with briefs and skills present, then prints all resources`
  - **depends on**: 2.5.1
  - **criteria**: test creates `.agent/repo=.this/briefs/` and `skills/` with files, runs boot, asserts output contains file contents
  - **verify**: `npm run test:integration -- --testNamePattern="repo this.*briefs and skills present"`

### Step 3.2: Test empty case

- [ ] **3.2.1**: Add test: `when invoked with "boot --repo this" with no briefs or skills, then warns about no resources`
  - **depends on**: 3.1.1
  - **criteria**: test creates empty briefs/ and skills/ directories, runs boot, asserts warning message
  - **verify**: `npm run test:integration -- --testNamePattern="repo this.*no briefs or skills"`

### Step 3.3: Test error cases

- [ ] **3.3.1**: Add test: `when invoked with "boot --repo this --role mechanic", then throws error`
  - **depends on**: 3.2.1
  - **criteria**: test runs boot with --repo this --role mechanic, asserts error message contains "not supported"
  - **verify**: `npm run test:integration -- --testNamePattern="repo this.*--role"`

- [ ] **3.3.2**: Add test: `when invoked with "boot --repo this" but directory doesn't exist, then throws error`
  - **depends on**: 3.3.1
  - **criteria**: test ensures `.agent/repo=.this` doesn't exist, runs boot, asserts error about missing directory
  - **verify**: `npm run test:integration -- --testNamePattern="repo this.*does not exist"`

### Step 3.4: Test case insensitivity

- [ ] **3.4.1**: Add test: `when invoked with "boot --repo THIS" (uppercase), then works correctly`
  - **depends on**: 3.3.2
  - **criteria**: test runs boot with --repo THIS, asserts same behavior as --repo this
  - **verify**: `npm run test:integration -- --testNamePattern="repo this.*case"`

---

## Phase 4: Verification

### Step 4.1: Run all tests

- [ ] **4.1.1**: Run full test suite to ensure no regressions
  - **depends on**: 3.4.1
  - **criteria**: `npm run test` passes
  - **verify**: `npm run test && echo "PASS" || echo "FAIL"`

### Step 4.2: Manual verification

- [ ] **4.2.1**: Manually test `npx rhachet roles boot --repo this` in real repo with `.agent/repo=.this/briefs` and `skills`
  - **depends on**: 4.1.1
  - **criteria**: output matches expected format from blueprint
  - **verify**: visual inspection of boot output

- [ ] **4.2.2**: Verify existing `npx rhachet roles boot --repo ehmpathy --role mechanic` still works
  - **depends on**: 4.2.1
  - **criteria**: existing role boot functionality unchanged
  - **verify**: `npx rhachet roles boot --repo ehmpathy --role mechanic` produces expected output

---

## Completion Criteria

All phases complete when:
- [ ] `npm run test` passes
- [ ] `npx rhachet roles boot --repo this` boots `.agent/repo=.this/briefs` and `skills`
- [ ] `npx rhachet roles boot --repo this --role X` throws helpful error
- [ ] `npx rhachet roles boot --repo ehmpathy --role mechanic` works unchanged
- [ ] Integration tests cover all new code paths

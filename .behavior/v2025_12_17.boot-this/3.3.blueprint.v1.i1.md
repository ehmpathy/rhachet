# Blueprint: Support `npx rhachet roles boot --repo this`

## Summary

Enable `npx rhachet roles boot --repo this` to boot briefs and skills declared at `.agent/repo=.this/briefs` and `.agent/repo=.this/skills` without requiring a `--role` argument.

## Current State

- `invokeRolesBoot.ts` requires `--role` to be provided
- It reads from `.agent/repo=$repo/role=$role/` directory structure
- The `repo=.this` directory exists and is intended for repo-specific resources (not tied to rhachet role packages from registries)
- Currently, `--repo` expects a registry slug (e.g., `ehmpathy`)

## Proposed Changes

### 1. Modify `invokeRolesBoot.ts` (src/contract/cli/invokeRolesBoot.ts)

Add special-case handling when `--repo this` is provided explicitly:

```
when(repo === 'this' && role === undefined)
  then(boot from .agent/repo=.this/briefs and .agent/repo=.this/skills)

when(repo === 'this' && role !== undefined)
  then(throw error: --role is not supported with --repo this)

when(repo !== 'this' && role === undefined)
  then(throw existing error: --role is required)
```

**Implementation approach:**

a. **Early exit for `--repo this`**: Before the existing role-required check, detect if `opts.repo === 'this'` (case-insensitive, trim whitespace)

b. **Disallow `--role` with `--repo this`**: If both `--repo this` and `--role` are provided, throw `BadRequestError('--role is not supported with --repo this; .this resources are not role-scoped')`

c. **Direct directory resolution**: When `repo === 'this'`:
   - Resolve `repoThisDir = .agent/repo=.this`
   - Read briefs from `repoThisDir/briefs`
   - Read skills from `repoThisDir/skills`
   - No readme.md at the repo=.this root level for boot output (or optionally include it)

d. **Reuse output formatting**: Extract the `getAllFiles`, `printStats`, and file-printing logic into helper functions (or inline, if extraction would be over-engineering) to handle both code paths

### 2. File Structure for `.agent/repo=.this/`

```
.agent/
  repo=.this/
    readme.md           # already findserted by roles link
    briefs/             # user-created, contains repo-specific briefs
      *.md
    skills/             # user-created, contains repo-specific skills
      *.sh (or other)
```

### 3. Output Format

Match existing boot output but with `repo=.this` paths:

```
#####################################################
## began:stats
#####################################################

  quant
    ├── files = N
    │   ├── briefs = X
    │   ├── skills = Y
    │   └── other = Z
    ├── chars = NNNN
    └── tokens ≈ NNN ($X.XX at $3/mil)

  treestruct
    .agent/repo=.this
    ├── briefs
    │   └── ...
    └── skills
        └── ...

#####################################################
## ended:stats
#####################################################

#####################################################
## began:.agent/repo=.this/briefs/example.md
#####################################################

  [file contents]

#####################################################
## ended:.agent/repo=.this/briefs/example.md
#####################################################
```

### 4. Tests to Add (src/contract/cli/invokeRolesBoot.integration.test.ts)

```typescript
given('--repo this is provided') {
  when('invoked with "boot --repo this" with briefs and skills present') {
    then('it should print all briefs and skills from .agent/repo=.this')
  }

  when('invoked with "boot --repo this" with no briefs or skills') {
    then('it should warn about no resources found')
  }

  when('invoked with "boot --repo this --role mechanic"') {
    then('it should throw error: --role is not supported with --repo this')
  }

  when('invoked with "boot --repo this" but .agent/repo=.this does not exist') {
    then('it should throw error suggesting to create the directory')
  }
}
```

## Implementation Steps

1. **Modify `invokeRolesBoot.ts`**:
   - Add detection for `opts.repo === 'this'` (normalized lowercase comparison)
   - Add error if `--role` is provided with `--repo this`
   - Add separate code path for booting `.this` resources
   - Use `repoThisDir = resolve(process.cwd(), '.agent', 'repo=.this')`
   - Set `briefsDir = resolve(repoThisDir, 'briefs')`
   - Set `skillsDir = resolve(repoThisDir, 'skills')`
   - Reuse the file reading and printing logic with adjusted relative paths

2. **Add integration tests**:
   - Test happy path: boot with briefs and skills present
   - Test empty case: no resources warning
   - Test error case: --role provided with --repo this
   - Test error case: .agent/repo=.this directory doesn't exist

3. **Update error messages**:
   - When `.agent/repo=.this` doesn't exist: suggest creating the directory or running `rhachet roles link` first
   - When `--role` is provided with `--repo this`: explain that .this resources are not role-scoped

## Edge Cases

1. **Case sensitivity**: Accept `this`, `THIS`, `This` - normalize to check against 'this'
2. **Whitespace**: Trim whitespace from `--repo` value before comparison
3. **Missing directories**: If briefs/ or skills/ don't exist under repo=.this, handle gracefully (count as 0 files of that type)
4. **Symlinks**: Follow symlinks in briefs/ and skills/ directories (already handled by existing `statSync` logic)

## Files to Modify

| File | Change |
|------|--------|
| `src/contract/cli/invokeRolesBoot.ts` | Add --repo this handling |
| `src/contract/cli/invokeRolesBoot.integration.test.ts` | Add tests for --repo this |

## Non-Goals

- No changes to `invokeRolesLink.ts` - the repo=.this directory structure is already created
- No changes to `invokeBriefsBoot.ts` - this wish is specifically about `roles boot`
- No auto-creation of briefs/skills directories - users must create them manually

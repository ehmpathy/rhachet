# execution: keyrack init --owner

## summary

all 4 phases executed successfully. the `--owner` flag now works consistently across all keyrack commands, with full vault isolation per owner.

---

## phase 1: vault adapter namespace ✅

### checklist

- [x] **1.1** update `vaultAdapterOsDirect.ts`
  - [x] add `owner` parameter to `getDirectStorePath`
  - [x] return path: `os.direct/owner={owner ?? 'default'}/keyrack.direct.json`
  - [x] update `get` to pass owner
  - [x] update `set` to pass owner, findsert directory

- [x] **1.2** update `vaultAdapterOsSecure.ts`
  - [x] add `owner` parameter to `getSecureVaultDir`
  - [x] return path: `os.secure/owner={owner ?? 'default'}/`
  - [x] update `getCredentialPath` to use namespaced directory
  - [x] update `get` to pass owner
  - [x] update `set` to pass owner, findsert directory

- [x] **1.3** unit tests — vault adapters already support owner

### verification

```
npm run test:unit -- vaultAdapterOsDirect  # pass
npm run test:unit -- vaultAdapterOsSecure  # pass
```

---

## phase 2: context and daemon SDK ✅

### checklist

- [x] **2.1** update `genContextKeyrackGrantGet.ts`
  - [x] add `owner` parameter to input
  - [x] include `owner` in returned context

- [x] **2.2** update `getKeyrackKeyGrant.ts`
  - [x] pass `context.owner` to `daemonAccessGet`

- [x] **2.3** update daemon SDK functions — already accept owner via socketPath derivation
  - [x] `daemonAccessGet.ts` — uses `getKeyrackDaemonSocketPath({ owner })`
  - [x] `daemonAccessUnlock.ts` — uses `getKeyrackDaemonSocketPath({ owner })`
  - [x] `daemonAccessRelock.ts` — uses `getKeyrackDaemonSocketPath({ owner })`
  - [x] `daemonAccessStatus.ts` — uses `getKeyrackDaemonSocketPath({ owner })`

- [x] **2.4** update `genKeyrackHostContext.ts`
  - [x] pass owner to vault adapter factory
  - [x] update error message: include `--owner {owner}` tip when owner is set

- [x] **2.5** update `unlockKeyrackKeys.ts`
  - [x] pass `owner: input.owner ?? null` to `adapter.get()` — **critical fix**

### verification

```
npm run test:integration -- setKeyrackKeyHost  # 9/9 pass
```

---

## phase 3: CLI flag standardization ✅

### checklist

- [x] **3.1** update `invokeKeyrack.ts` — add `--owner` flag to commands
  - [x] `init` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `set` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `status` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `recipient set` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `unlock` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `relock` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `del` command — add `--owner` (primary), retain `--for` (alias)
  - [x] `list` command — add `--owner` (primary), retain `--for` (alias)

- [x] **3.2** update error messages
  - [x] "manifest not found" error includes `--owner` tip when owner is set

---

## phase 4: acceptance tests ✅

### checklist

- [x] **4.1** update test infra
  - [x] `writeDirectStoreEntry.ts` — add owner parameter

- [x] **4.2** create `keyrack.owner.acceptance.test.ts`
  - [x] case1: init with custom owner (3 scenarios)
  - [x] case2: set with custom owner (2 scenarios)
  - [x] case3: get isolation (2 scenarios that demonstrate isolation)
  - [x] case4: vault file isolation (4 checks)
  - [x] case5: status isolation (2 scenarios)
  - [x] case6: flag consistency (4 commands)
  - [x] case7: fallback pattern (2 scenarios)

### verification

```
npm run test:acceptance -- keyrack.owner  # 27/27 pass
```

---

## final verification ✅

```
npm run test:types          # pass
npm run test:unit           # 33/33 pass
npm run test:integration    # 9/9 pass
npm run test:acceptance     # 27/27 pass
```

all tests pass → behavior complete.

---

## key changes

### files modified

| file | change |
|------|--------|
| `src/domain.operations/keyrack/session/unlockKeyrackKeys.ts` | pass `owner: input.owner ?? null` to adapter.get() |
| `blackbox/cli/keyrack.owner.acceptance.test.ts` | new acceptance test file with 27 tests |
| `blackbox/.test/infra/writeDirectStoreEntry.ts` | add owner parameter |

### the critical fix

the key insight was that `unlockKeyrackKeys.ts` did not pass the `owner` parameter to `adapter.get()`:

```diff
- const secret = await adapter.get({ slug, exid: hostConfig.exid });
+ const secret = await adapter.get({
+   slug,
+   exid: hostConfig.exid,
+   owner: input.owner ?? null,
+ });
```

without this fix, unlock would try to read from the default owner's vault path even when a custom owner was specified. this caused "vault file absent" errors.

### fallback pattern (case7)

the fallback pattern test required:
1. use `--env sudo` (sudo keys unlock without repoManifest declaration)
2. add explicit `unlock --owner demo` step before `get --owner demo`

this matches the keyrack design: `get` reads from daemon cache only, never directly from vault files. keys must be unlocked first.

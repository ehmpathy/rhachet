# research: test codepath patterns for keyrack --owner

## pattern.1 = bdd test structure [REUSE]

**file:** `blackbox/cli/keyrack.init.acceptance.test.ts:1-20`

```typescript
import { given, then, useBeforeAll, when } from 'test-fns';

describe('keyrack init', () => {
  given('[case1] keyrack init with default ssh key (fresh repo)', () => {
    const repo = useBeforeAll(async () =>
      genTestTempRepo({ fixture: 'minimal' }),
    );

    when('[t0] init (json output)', () => {
      const result = useBeforeAll(async () =>
        invokeRhachetCliBinary({
          args: ['keyrack', 'init', '--json'],
          cwd: repo.path,
          env: { HOME: repo.path },
        }),
      );

      then('exits with status 0', () => {
        expect(result.status).toEqual(0);
      });
    });
  });
});
```

**relation:** extant bdd pattern works well for --owner tests. no changes needed.

---

## pattern.2 = temp repo isolation [REUSE]

**file:** `blackbox/.test/infra/genTestTempRepo.ts:67-163`

```typescript
export const genTestTempRepo = async (input: {
  fixture: TestRepoFixture;
  suffix?: string;
  install?: boolean;
}): Promise<{ path: string }> => {
  const uniqueId = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
  const suffix = input.suffix ? `-${input.suffix}` : '';
  const repoPath = join(tmpdir(), `rhachet-test-${uniqueId}${suffix}`);

  // ... copy fixture, setup .ssh, init git
};
```

**relation:** temp repo pattern provides full isolation via `HOME` env var. each test gets fresh keyrack state. no changes needed.

---

## pattern.3 = cli binary invocation [REUSE]

**file:** `blackbox/.test/infra/invokeRhachetCliBinary.ts:36-111`

```typescript
export const invokeRhachetCliBinary = (input: {
  binary?: 'rhachet' | 'rhx';
  args: string[];
  cwd: string;
  stdin?: string;
  logOnError?: boolean;
  env?: Record<string, string | undefined>;
}): SpawnSyncReturns<string> => {
  const binPath = input.binary === 'rhx' ? RHX_BIN : RHACHET_BIN;
  const result = spawnSync(binPath, input.args, {
    cwd: input.cwd,
    env: { ...process.env, ...input.env },
  });
};
```

**relation:** already supports `--for <owner>` flag and `KEYRACK_OWNER` env var. will work with `--owner` flag.

---

## pattern.4 = daemon cleanup per owner [REUSE]

**file:** `blackbox/.test/infra/killKeyrackDaemonForTests.ts:1-79`

```typescript
export const killKeyrackDaemonForTests = (input?: {
  owner?: string | null;
}): { killed: boolean; pid: number | null } => {
  const owner = input?.owner ?? null;
  const filename =
    owner === null
      ? `keyrack.${sessionId}.sock`
      : `keyrack.${sessionId}.${owner}.sock`;
  const socketPath = `${runtimeDir}/${filename}`;
  // ... kill daemon, cleanup files
};
```

**relation:** already supports per-owner daemon cleanup. no changes needed.

---

## pattern.5 = cross-owner isolation test [REUSE]

**file:** `blackbox/cli/keyrack.sudo.acceptance.test.ts:1221-1309`

```typescript
given('[case14] cross-owner isolation', () => {
  const repo = useBeforeAll(async () => {
    const r = await genTestTempRepo({ fixture: 'with-keyrack-multi-env' });

    // Init for mechanic
    await invokeRhachetCliBinary({
      args: ['keyrack', 'init', '--for', 'mechanic'],
      cwd: r.path,
      env: { HOME: r.path },
    });

    // Set mechanic key
    await invokeRhachetCliBinary({
      args: [
        'keyrack', 'set', '--for', 'mechanic', '--key', 'MECHANIC_SECRET',
        '--env', 'sudo', '--mech', 'REPLICA', '--vault', 'os.direct',
      ],
      // ...
    });
    return r;
  });

  when('[t2] default owner cannot see mechanic key', () => {
    // ... verify isolation
  });
});
```

**relation:** extant pattern tests manifest isolation. need to extend to verify vault file isolation per owner.

---

## pattern.6 = vault storage setup [EXTEND]

**file:** `blackbox/.test/infra/writeDirectStoreEntry.ts`

```typescript
export const writeDirectStoreEntry = (input: {
  home: string;
  slug: string;
  value: string;
}): void => {
  const path = join(input.home, '.rhachet', 'keyrack', 'vault', 'os.direct', 'keyrack.direct.json');
  // ⚠️ single file for all owners
};
```

**relation:** **GAP** — needs owner parameter. change to:
```typescript
const path = join(
  input.home,
  '.rhachet', 'keyrack', 'vault', 'os.direct',
  `owner=${input.owner ?? 'default'}`,
  'keyrack.direct.json'
);
```

---

## pattern.7 = per-owner init test [REUSE]

**file:** `blackbox/cli/keyrack.init.acceptance.test.ts:80-132`

```typescript
given('[case2] keyrack init with --for owner', () => {
  when('[t0] init --for mechanic', () => {
    then('response contains owner mechanic', () => {
      const parsed = JSON.parse(result.stdout);
      expect(parsed.host.owner).toEqual('mechanic');
    });

    then('manifestPath includes owner suffix', () => {
      const parsed = JSON.parse(result.stdout);
      expect(parsed.host.manifestPath).toContain('keyrack.host.mechanic.age');
    });
  });
});
```

**relation:** extant tests use `--for`. will need to update to use `--owner` and verify `--for` as alias.

---

## pattern.8 = snapshot sanitization [REUSE]

**file:** `blackbox/.test/infra/invokeRhachetCliBinary.ts:7-23`

```typescript
export const asSnapshotSafe = (output: string): string => {
  return output
    .replace(/\/(?:home\/[^/]+|Users\/[^/]+|runner\/work)\/[^)\s]+/g, '/PATH_STRIPPED')
    .replace(/\/tmp\/rhachet-test-[a-z0-9-]+/g, '/TMP_REPO')
    .replace(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z/g, '__TIMESTAMP__');
};
```

**relation:** sanitization already handles paths and timestamps. no changes needed.

---

## summary

| pattern | action | reason |
|---------|--------|--------|
| bdd test structure | [REUSE] | works for --owner tests |
| temp repo isolation | [REUSE] | provides clean slate per test |
| cli binary invocation | [REUSE] | supports flags and env vars |
| daemon cleanup | [REUSE] | already per-owner |
| cross-owner isolation | [REUSE] | tests manifest isolation |
| vault storage setup | [EXTEND] | add owner parameter for path |
| per-owner init test | [REUSE] | update `--for` → `--owner` |
| snapshot sanitization | [REUSE] | handles paths/timestamps |

---

## new tests needed

based on blackbox criteria, need to add:

1. **vault isolation per owner** — verify vault files physically separate per owner
2. **--owner flag consistency** — test all commands accept `--owner`
3. **--for alias** — test `--for` works as alias for `--owner`
4. **error with tip** — test set without init shows tip message
5. **status per owner** — test `keyrack status --owner X`

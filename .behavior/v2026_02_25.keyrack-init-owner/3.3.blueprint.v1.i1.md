# blueprint: keyrack init --owner

## overview

this blueprint covers:
1. cli flag standardization (`--for` → `--owner` with alias)
2. vault adapter namespace (add `owner={owner}/` directories)
3. test coverage for new behavior

---

## filediff treestruct

```
src/
  contract/cli/
    [~] invokeKeyrack.ts                    # standardize --owner flag across all commands

  domain.operations/keyrack/
    [~] genContextKeyrackGrantGet.ts        # add owner parameter, include in context
    [~] genKeyrackHostContext.ts            # pass owner to vault adapters, update error tip
    [~] getKeyrackKeyGrant.ts               # pass owner to daemonAccessGet

    adapters/vaults/
      [~] vaultAdapterOsDirect.ts           # add owner namespace to paths
      [~] vaultAdapterOsSecure.ts           # add owner namespace to paths
      [○] vaultAdapterOsDaemon.ts           # adapter unchanged, delegates to daemon SDK

    daemon/sdk/src/domain.operations/
      [~] daemonAccessGet.ts                # add owner param, pass to socket path
      [~] daemonAccessUnlock.ts             # add owner param, pass to socket path
      [~] daemonAccessRelock.ts             # add owner param, pass to socket path
      [~] daemonAccessStatus.ts             # add owner param, pass to socket path

blackbox/
  .test/infra/
    [~] writeDirectStoreEntry.ts            # add owner parameter

  cli/
    [+] keyrack.owner.acceptance.test.ts    # new acceptance tests for --owner
```

---

## codepath treestruct

### cli flag parse

```
invokeKeyrack.ts
  ├─ [~] init command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  ├─ [~] set command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  ├─ [○] get command
  │     └─ already uses --owner
  │
  ├─ [~] status command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  ├─ [~] recipient set command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  ├─ [~] unlock command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  ├─ [~] relock command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  ├─ [~] del command
  │     ├─ [~] add --owner flag (primary)
  │     └─ [○] retain --for as alias
  │
  └─ [~] list command
        ├─ [~] add --owner flag (primary)
        └─ [○] retain --for as alias
```

### vault adapter namespace

```
vaultAdapterOsDirect.ts
  ├─ [~] getDirectStorePath
  │     ├─ [+] accept owner parameter
  │     └─ [~] return path: os.direct/owner={owner}/keyrack.direct.json
  │
  ├─ [~] get
  │     └─ [~] pass owner to getDirectStorePath
  │
  └─ [~] set
        └─ [~] pass owner to getDirectStorePath, findsert dir

vaultAdapterOsSecure.ts
  ├─ [~] getSecureVaultDir
  │     ├─ [+] accept owner parameter
  │     └─ [~] return path: os.secure/owner={owner}/
  │
  ├─ [~] getCredentialPath
  │     └─ [~] use owner-namespaced directory
  │
  ├─ [~] get
  │     └─ [~] pass owner through
  │
  └─ [~] set
        └─ [~] pass owner through, findsert dir

vaultAdapterOsDaemon.ts
  └─ [○] already per-owner via socket path
```

### context and grant flow

```
genContextKeyrackGrantGet.ts
  ├─ [~] add owner parameter to input
  └─ [~] include owner in returned context (for daemon access)

getKeyrackKeyGrant.ts
  └─ [~] pass context.owner to daemonAccessGet

daemonAccessGet.ts
  ├─ [~] add owner parameter to input
  └─ [~] compute socketPath via getKeyrackDaemonSocketPath({ owner })

daemonAccessUnlock.ts
  ├─ [~] add owner parameter to input
  └─ [~] compute socketPath via getKeyrackDaemonSocketPath({ owner })

daemonAccessRelock.ts
  ├─ [~] add owner parameter to input
  └─ [~] compute socketPath via getKeyrackDaemonSocketPath({ owner })

daemonAccessStatus.ts
  ├─ [~] add owner parameter to input
  └─ [~] compute socketPath via getKeyrackDaemonSocketPath({ owner })

genKeyrackHostContext.ts
  ├─ [~] pass owner to vault adapter factory
  └─ [~] update error message: include '--owner {owner}' when owner is set
```

---

## contracts

### vault adapter interface

```typescript
interface KeyrackHostVaultAdapter {
  get: (input: {
    slug: string;
    owner: string | null;  // [+] add owner
  }) => Promise<string | null>;

  set: (input: {
    slug: string;
    secret: string;
    owner: string | null;  // [+] add owner
  }) => Promise<void>;

  // ... other methods
}
```

### vault path resolution

```typescript
// os.direct
const getDirectStorePath = (input: { owner: string | null }): string => {
  const ownerDir = `owner=${input.owner ?? 'default'}`;
  return join(home, '.rhachet', 'keyrack', 'vault', 'os.direct', ownerDir, 'keyrack.direct.json');
};

// os.secure
const getSecureVaultDir = (input: { owner: string | null }): string => {
  const ownerDir = `owner=${input.owner ?? 'default'}`;
  return join(home, '.rhachet', 'keyrack', 'vault', 'os.secure', ownerDir);
};
```

### daemon access interface

```typescript
// all daemon SDK functions accept owner parameter
export const daemonAccessGet = async (input: {
  slugs: string[];
  owner?: string | null;  // [+] add owner
  org?: string;
  env?: string;
  socketPath?: string;    // kept for backwards compat, derived from owner if absent
}): Promise<...>

// owner is used to derive socketPath via:
const socketPath = input.socketPath ?? getKeyrackDaemonSocketPath({ owner: input.owner ?? null });
```

### get context interface

```typescript
// context now includes owner for daemon access
export interface ContextKeyrackGrantGet {
  owner: string | null;  // [+] add owner
  repoManifest: KeyrackRepoManifest | null;
  envvarAdapter: KeyrackHostVaultAdapter;
  mechAdapters: Record<KeyrackGrantMechanism, KeyrackGrantMechanismAdapter>;
}
```

---

## test coverage

### unit tests

| file | coverage |
|------|----------|
| `getDirectStorePath.test.ts` | path resolution with/without owner |
| `getSecureVaultDir.test.ts` | path resolution with/without owner |
| `daemonAccessGet.test.ts` | owner param flows to socket path |
| `genContextKeyrackGrantGet.test.ts` | owner included in context |

### integration tests

| file | coverage |
|------|----------|
| `vaultAdapterOsDirect.integration.test.ts` | get/set with owner namespace |
| `vaultAdapterOsSecure.integration.test.ts` | get/set with owner namespace |
| `getKeyrackKeyGrant.integration.test.ts` | daemon access with owner isolation |

### acceptance tests

| file | coverage |
|------|----------|
| `keyrack.owner.acceptance.test.ts` | |
| | |
| **init (matrix.1)** | |
| | init --owner X, no manifest → created, "freshly minted" |
| | init --owner X, manifest exists → found, "found" |
| | |
| **set (matrix.2)** | |
| | set --owner X, manifest exists → key stored |
| | set --owner X, no manifest → error + tip "run keyrack init --owner X first" |
| | |
| **get isolation (matrix.3 — all 8 combos)** | |
| | key in default only, flag omitted → found (default value) |
| | key in default only, --owner custom → not found |
| | key in custom only, flag omitted → not found |
| | key in custom only, --owner custom → found (custom value) |
| | key in both, flag omitted → found (default value) |
| | key in both, --owner custom → found (custom value) |
| | key in neither, flag omitted → not found |
| | key in neither, --owner custom → not found |
| | |
| **status isolation (matrix.6 — all 6 combos)** | |
| | keys in default only, flag omitted → shows default only |
| | keys in default only, --owner custom → shows none |
| | keys in custom only, flag omitted → shows none |
| | keys in custom only, --owner custom → shows custom only |
| | keys in both, flag omitted → shows default only |
| | keys in both, --owner custom → shows custom only |
| | |
| **flag consistency (matrix.4)** | |
| | --owner works on: init, set, get, status, recipient set, unlock, relock, del, list |
| | --for alias works identically to --owner |
| | |
| **vault file isolation (matrix.5)** | |
| | set key for default → file at os.direct/owner=default/keyrack.direct.json |
| | set key for custom → file at os.direct/owner={owner}/keyrack.direct.json |
| | set key for default → file at os.secure/owner=default/{hash}.age |
| | set key for custom → file at os.secure/owner={owner}/{hash}.age |
| | verify files are physically separate (ls, stat) |

---

## execution phases

### phase 1: vault adapter namespace

1. update `vaultAdapterOsDirect.ts` — add owner to path
2. update `vaultAdapterOsSecure.ts` — add owner to path
3. update adapter interface — add owner param
4. add unit tests for path resolution

### phase 2: context and daemon SDK

1. update `genContextKeyrackGrantGet.ts` — add owner param, include in context
2. update `getKeyrackKeyGrant.ts` — pass owner to daemonAccessGet
3. update daemon SDK functions — add owner param, derive socket path
4. update `genKeyrackHostContext.ts` — pass owner to adapters, update error tip
5. add integration tests

### phase 3: cli flag standardize

1. update `invokeKeyrack.ts` — add `--owner` to all commands
2. keep `--for` as alias
3. ensure error message for "manifest not found" includes tip with `--owner` flag
4. update extant tests to use `--owner`

### phase 4: acceptance tests

1. create `keyrack.owner.acceptance.test.ts`
2. test all blackbox criteria from matrix

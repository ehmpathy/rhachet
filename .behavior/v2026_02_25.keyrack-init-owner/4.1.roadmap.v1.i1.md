# roadmap: keyrack init --owner

## overview

execute the blueprint in 4 phases with verification at each step.

---

## phase 1: vault adapter namespace

**read before:**
- `.behavior/v2026_02_25.keyrack-init-owner/3.1.research.patterns._.code.prod.v1.i1.md`

### checklist

- [ ] **1.1** update `vaultAdapterOsDirect.ts`
  - [ ] add `owner` parameter to `getDirectStorePath`
  - [ ] return path: `os.direct/owner={owner ?? 'default'}/keyrack.direct.json`
  - [ ] update `get` to pass owner
  - [ ] update `set` to pass owner, findsert directory

- [ ] **1.2** update `vaultAdapterOsSecure.ts`
  - [ ] add `owner` parameter to `getSecureVaultDir`
  - [ ] return path: `os.secure/owner={owner ?? 'default'}/`
  - [ ] update `getCredentialPath` to use namespaced directory
  - [ ] update `get` to pass owner
  - [ ] update `set` to pass owner, findsert directory

- [ ] **1.3** add unit tests
  - [ ] `getDirectStorePath.test.ts` — path resolution with/without owner
  - [ ] `getSecureVaultDir.test.ts` — path resolution with/without owner

### acceptance criteria

```
given(owner is null)
  when(getDirectStorePath called)
    then(path includes 'owner=default')

given(owner is 'ehmpath.demo')
  when(getDirectStorePath called)
    then(path includes 'owner=ehmpath.demo')
```

### verification

```sh
npm run test:unit -- vaultAdapterOsDirect
npm run test:unit -- vaultAdapterOsSecure
```

---

## phase 2: context and daemon SDK

**read before:**
- `.behavior/v2026_02_25.keyrack-init-owner/3.1.research.patterns._.code.prod.v1.i1.md`

**depends on:** phase 1

### checklist

- [ ] **2.1** update `genContextKeyrackGrantGet.ts`
  - [ ] add `owner` parameter to input
  - [ ] include `owner` in returned context

- [ ] **2.2** update `getKeyrackKeyGrant.ts`
  - [ ] pass `context.owner` to `daemonAccessGet`

- [ ] **2.3** update daemon SDK functions
  - [ ] `daemonAccessGet.ts` — add owner param, derive socketPath from owner
  - [ ] `daemonAccessUnlock.ts` — add owner param, derive socketPath from owner
  - [ ] `daemonAccessRelock.ts` — add owner param, derive socketPath from owner
  - [ ] `daemonAccessStatus.ts` — add owner param, derive socketPath from owner

- [ ] **2.4** update `genKeyrackHostContext.ts`
  - [ ] pass owner to vault adapter factory
  - [ ] update error message: include `--owner {owner}` tip when owner is set

- [ ] **2.5** add integration tests
  - [ ] `vaultAdapterOsDirect.integration.test.ts` — get/set with owner namespace
  - [ ] `vaultAdapterOsSecure.integration.test.ts` — get/set with owner namespace
  - [ ] `getKeyrackKeyGrant.integration.test.ts` — daemon access with owner isolation

### acceptance criteria

```
given(key set for owner 'demo' in vault 'os.direct')
  when(get called with owner 'demo')
    then(key value returned)
  when(get called without owner)
    then(key not found)
```

### verification

```sh
npm run test:integration -- vaultAdapterOsDirect
npm run test:integration -- vaultAdapterOsSecure
npm run test:integration -- getKeyrackKeyGrant
```

---

## phase 3: CLI flag standardization

**read before:**
- `.behavior/v2026_02_25.keyrack-init-owner/3.1.research.patterns._.code.prod.v1.i1.md`

**depends on:** phase 2

### checklist

- [ ] **3.1** update `invokeKeyrack.ts` — add `--owner` flag to commands
  - [ ] `init` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `set` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `status` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `recipient set` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `unlock` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `relock` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `del` command — add `--owner` (primary), retain `--for` (alias)
  - [ ] `list` command — add `--owner` (primary), retain `--for` (alias)

- [ ] **3.2** update error messages
  - [ ] "manifest not found" error includes `--owner` tip when owner is set

- [ ] **3.3** update extant tests to use `--owner`

### acceptance criteria

```
given(user runs 'keyrack init --owner ehmpath.demo')
  then(host manifest created for owner 'ehmpath.demo')

given(user runs 'keyrack init --for ehmpath.demo')
  then(same behavior as --owner)
```

### verification

```sh
npm run test:unit -- invokeKeyrack
npm run test:integration -- invokeKeyrack
```

---

## phase 4: acceptance tests

**read before:**
- `.behavior/v2026_02_25.keyrack-init-owner/2.1.criteria.blackbox.md`
- `.behavior/v2026_02_25.keyrack-init-owner/3.1.research.patterns._.code.test.v1.i1.md`

**depends on:** phase 3

### checklist

- [ ] **4.1** update test infra
  - [ ] `writeDirectStoreEntry.ts` — add owner parameter

- [ ] **4.2** create `keyrack.owner.acceptance.test.ts`
  - [ ] matrix.1: init with custom owner (2 scenarios)
  - [ ] matrix.2: set with custom owner (2 scenarios)
  - [ ] matrix.3: get isolation (8 combinations)
  - [ ] matrix.4: flag consistency (9 commands + alias)
  - [ ] matrix.5: vault file isolation (4 paths + verification)
  - [ ] matrix.6: status isolation (6 combinations)

### acceptance criteria

see `.behavior/v2026_02_25.keyrack-init-owner/2.1.criteria.blackbox.md` for full criteria.

key scenarios:
```
given(key 'API_KEY' set for default owner)
  and(key 'API_KEY' set for owner 'demo' with different value)
  when(get called without --owner)
    then(default value returned)
  when(get called with --owner demo)
    then(demo value returned)
```

### verification

```sh
npm run test:acceptance -- keyrack.owner
```

---

## final verification

after all phases complete:

```sh
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
npm run test:acceptance
```

all tests pass → behavior complete.


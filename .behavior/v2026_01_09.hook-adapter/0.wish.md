wish =

we want to make it easy to manage hooks across all different brain.repl sdk's

specifically,

it should be possible for different packages like `rhachet-brain-anthropic` (src/_topublish/rhachet-brain-anthropic/readme.md)

to register how they support hook management

---

i.e., rhachet should declare a generic interface via which consumers of rhachet can declare the hooks they want to register

(e.g., each Role can specify Role.hooks)


Role.hooks might look like

Role.hooks = {
  onBoot,
  onTool,
  onStop,
}


where

onBoot runs each time a new context is booted (e.g., after compaction, on session start, on session clear, etc)

onTool runs each time a tool is used

onStop runs each time a brain.repl halts (decides its done)

---

we should consider what other hooks we may need to support, based on the common hooks exposed by the main brain repl clis of `claude-code` and `opencode`

---

then, when rhachet is called with `npx rhachet init --hooks anthropic/claude/code`

it should find the the `rhachet-brain-anthropic` package registered for claude/code (slug=claude/code, repo=anthropic); ref: src/_topublish/rhachet-brain-anthropic/src/repls/genBrainRepl.ts

(today, they're collocated within this repo, so we can just search an in memory-dict... in the future, we'll search package.json and node_modules or yaml config)

then, as long as that `rhachet-brain-*` lib declares it's adapter for hooks

e.g., `BrainHooksAdapter = {
  register:{
    onBoot,
    onTool,
    onStop,
  }
}`

we can use that adapter to register the hooks that were declared by the role.

---

specifically, we want to support

1. set.findsert, set.upsert, set.delete
2. get.one, get.all

per register.onX

i.e., a dao per hook register

-----

that way, the mechanic role and behaver role no longer need to manage how to register hooks themselves.

here's how they're doing it today
- init:
  - https://github.com/ehmpathy/rhachet-roles-ehmpathy/blob/16800b1ccdcc1a3a98805d302cb033fbeecda602/src/domain.roles/mechanic/inits/init.claude.hooks.sh
  - https://github.com/ehmpathy/rhachet-roles-bhuild/blob/c7ff2a172e90f76345b83cdf3999823d6a57c2b4/src/domain.roles/behaver/inits/init.claude.hooks.sh
- addition
  - https://github.com/ehmpathy/rhachet-roles-ehmpathy/blob/16800b1ccdcc1a3a98805d302cb033fbeecda602/src/domain.roles/mechanic/inits/init.claude.hooks.findsert.sh
  - https://github.com/ehmpathy/rhachet-roles-bhuild/blob/c7ff2a172e90f76345b83cdf3999823d6a57c2b4/src/domain.roles/behaver/inits/init.claude.hooks.findsert.sh
- cleanup
  - https://github.com/ehmpathy/rhachet-roles-ehmpathy/blob/16800b1ccdcc1a3a98805d302cb033fbeecda602/src/domain.roles/mechanic/inits/init.claude.hooks.cleanup.sh
  - https://github.com/ehmpathy/rhachet-roles-bhuild/blob/c7ff2a172e90f76345b83cdf3999823d6a57c2b4/src/domain.roles/behaver/inits/init.claude.hooks.cleanup.sh

its a mess and causes defects
we want to abstract that out at the rhachet framework layer to make it easy for roles to manage hooks when they enroll a BrainReplCli

but we need to support the same grain of control
- an explicit set of hooks that we add
- an explicit namespace for hooks that we can delete if no longer need to be added
- so that the Role just needs to declare which hooks it wants, and rhachet will set.upsert/set.delete to make it so (declastruct style)

---

today, we only need to support claude-code

it'll be most important to create integration tests which snapshot the resulant hook artifacts produced by the atomic BrainHooksAdapter.register operations and the composite operation from rhachet which applys the Role.hooks declarations

we'll also need to make sure that multiple hooks can declare & change (add / delete) hooks without collisions

and of maximum importance is to make sure that if a hook is no longer specified by the role, it will no longer be present after the hooks are applied

---

note, all of these will only need to apply per repo scope on the cli, so for example, `.claude/settings.json` within the repo

---

more details on the end state we want are here


  - .agent/repo=.this/role=any/briefs/define.term.suppliers.md
  - .agent/repo=.this/role=any/briefs/define.term.adapters.md

---

also we'd like to rename src/domain.objects/InvokeHooks.ts as part of this

as in the new domain.distillate, it actually represents the RoleHooksOnDispatch

---


also, actually, ensure that hooks are only bound IF the user
  explicitly supplies the --hooks flag; if the --hooks flag has no
  arguments, then assume the user wants us to discover the brain repls;
  otherwise, the --hooks flag will be expected to be a list of the brain
  repls they want us to bind to ; (e.g., claudecode, opencode, etc)

effectively now, --hooks "just works" via discovery, but by default without the --hooks flag, we wont do extra
behavior. that way, folks can still init roles without having their brain
repls enrolled immediately

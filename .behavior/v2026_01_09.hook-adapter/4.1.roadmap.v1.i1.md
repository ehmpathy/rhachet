# roadmap = execution plan for hook-adapter

## overview

this roadmap defines the execution order with dependencies, acceptance criteria, and verification steps for each milestone. designed for checklist-style execution.

**execution model:**
- each checkpoint has behavioral acceptance criteria (what must be true)
- each checkpoint has verification commands (how to prove it)
- dependencies are explicit (what must complete first)
- all checkpoints must pass before the next phase starts

---

## quick reference: checkpoint status

```
[ ] phase 0: prerequisites
    [ ] 0.1: verify dev environment
    [ ] 0.2: rename InvokeHooks → RoleHooksOnDispatch

[ ] phase 1: domain foundation
    [ ] 1.1: BrainHookEvent type
    [ ] 1.2: BrainHookFilter literal
    [ ] 1.3: BrainHook entity
    [ ] 1.4: RoleHookOnBrain literal
    [ ] 1.5: RoleHooksOnBrain literal
    [ ] 1.6: RoleHooks literal
    [ ] 1.7: extend Role interface
    [ ] 1.8: BrainHooksAdapterDao interface
    [ ] 1.9: BrainHooksAdapter interface
    [ ] 1.10: BrainSpecifier type

[ ] phase 2: anthropic adapter (claudecode)
    [ ] 2.1: package structure
    [ ] 2.2: config.dao
    [ ] 2.3: translateHook
    [ ] 2.4: claudeCodeAdapter
    [ ] 2.5: getBrainHooks export

[ ] phase 3: core operations
    [ ] 3.1: discoverBrainPackages
    [ ] 3.2: getBrainHooksAdapterByConfigImplicit
    [ ] 3.3: detectBrainReplsInRepo
    [ ] 3.4: syncRoleHooksIntoBrainRepl
    [ ] 3.5: applyRoleHooksToDetectedBrains

[ ] phase 4: cli integration
    [ ] 4.1: extend invokeInit with --hooks
    [ ] 4.2: getLinkedRoles with hooks

[ ] phase 5: acceptance tests
    [ ] 5.1: test fixtures
    [ ] 5.2: init --roles (no hooks)
    [ ] 5.3: init --roles --hooks (auto-detect)
    [ ] 5.4: init --roles --hooks <slug>
    [ ] 5.5: init --hooks (reapply)
    [ ] 5.6: declarative sync removal
    [ ] 5.7: namespace isolation

[ ] phase 6: opencode adapter (extension)
    [ ] 6.1: package structure
    [ ] 6.2: plugin.dao
    [ ] 6.3: translateHook
    [ ] 6.4: openCodeAdapter
    [ ] 6.5: getBrainHooks export

[ ] phase 7: final verification
    [ ] 7.1: full test suite passes
    [ ] 7.2: type check passes
    [ ] 7.3: lint passes
    [ ] 7.4: build succeeds
```

---

## phase 0: prerequisites

### checkpoint 0.1: verify dev environment

**deps:** none

**acceptance criteria:**
- [ ] tests run successfully
- [ ] types check passes
- [ ] build succeeds

**verification:**
```sh
npm run test:types
npm run build
npm run test:unit -- --passWithNoTests
```

**exit:** all commands exit 0

---

### checkpoint 0.2: rename InvokeHooks → RoleHooksOnDispatch

**deps:** 0.1

**acceptance criteria:**
- [ ] file renamed from `InvokeHooks.ts` to `RoleHooksOnDispatch.ts`
- [ ] interface renamed from `InvokeHooks` to `RoleHooksOnDispatch`
- [ ] all imports and references updated
- [ ] tests pass after rename

**verification:**
```sh
# verify file renamed
ls src/domain.objects/RoleHooksOnDispatch.ts

# verify old file absent
! ls src/domain.objects/InvokeHooks.ts 2>/dev/null

# verify no references to old name
! grep -r "InvokeHooks" src/ --include="*.ts" | grep -v ".test.ts"

# verify tests pass
npm run test:types
npm run test:unit
```

**exit:** all verifications pass

---

## phase 1: domain foundation

### checkpoint 1.1: BrainHookEvent type

**deps:** 0.2

**acceptance criteria:**
- [ ] `src/domain.objects/BrainHookEvent.ts` created
- [ ] type exports: `'onBoot' | 'onTool' | 'onStop'`
- [ ] types check passes

**verification:**
```sh
# verify file exists
ls src/domain.objects/BrainHookEvent.ts

# verify type definition
grep -q "type BrainHookEvent" src/domain.objects/BrainHookEvent.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 1.2: BrainHookFilter literal

**deps:** 1.1

**acceptance criteria:**
- [ ] `src/domain.objects/BrainHookFilter.ts` created
- [ ] `src/domain.objects/BrainHookFilter.test.ts` created
- [ ] extends `DomainLiteral`
- [ ] declares: `what: string`, `when?: 'before' | 'after'`
- [ ] unit tests pass

**verification:**
```sh
# verify files exist
ls src/domain.objects/BrainHookFilter.ts
ls src/domain.objects/BrainHookFilter.test.ts

# verify extends DomainLiteral
grep -q "extends DomainLiteral" src/domain.objects/BrainHookFilter.ts

# verify tests pass
npm run test:unit -- BrainHookFilter.test.ts
```

**exit:** unit tests pass

---

### checkpoint 1.3: BrainHook entity

**deps:** 1.2

**acceptance criteria:**
- [ ] `src/domain.objects/BrainHook.ts` created
- [ ] `src/domain.objects/BrainHook.test.ts` created
- [ ] extends `DomainEntity`
- [ ] declares: `author`, `event`, `command`, `timeout`, `filter?`
- [ ] static `unique = ['author', 'event', 'command']`
- [ ] static `updatable = ['filter', 'timeout']`
- [ ] unit tests verify unique key computation

**verification:**
```sh
# verify files exist
ls src/domain.objects/BrainHook.ts
ls src/domain.objects/BrainHook.test.ts

# verify extends DomainEntity
grep -q "extends DomainEntity" src/domain.objects/BrainHook.ts

# verify unique key
grep -q "unique.*=.*\['author', 'event', 'command'\]" src/domain.objects/BrainHook.ts

# verify tests pass
npm run test:unit -- BrainHook.test.ts
```

**exit:** unit tests pass

---

### checkpoint 1.4: RoleHookOnBrain literal

**deps:** 1.2

**acceptance criteria:**
- [ ] `src/domain.objects/RoleHookOnBrain.ts` created
- [ ] `src/domain.objects/RoleHookOnBrain.test.ts` created
- [ ] extends `DomainLiteral`
- [ ] declares: `command`, `timeout`, `filter?`
- [ ] unit tests pass

**verification:**
```sh
# verify files exist
ls src/domain.objects/RoleHookOnBrain.ts
ls src/domain.objects/RoleHookOnBrain.test.ts

# verify tests pass
npm run test:unit -- RoleHookOnBrain.test.ts
```

**exit:** unit tests pass

---

### checkpoint 1.5: RoleHooksOnBrain literal

**deps:** 1.4

**acceptance criteria:**
- [ ] `src/domain.objects/RoleHooksOnBrain.ts` created
- [ ] `src/domain.objects/RoleHooksOnBrain.test.ts` created
- [ ] extends `DomainLiteral`
- [ ] declares: `onBoot?`, `onTool?`, `onStop?` (each `RoleHookOnBrain[]`)
- [ ] static `nested` defined for hydration
- [ ] unit tests verify nested hydration

**verification:**
```sh
# verify files exist
ls src/domain.objects/RoleHooksOnBrain.ts
ls src/domain.objects/RoleHooksOnBrain.test.ts

# verify nested hydration
grep -q "static nested" src/domain.objects/RoleHooksOnBrain.ts

# verify tests pass
npm run test:unit -- RoleHooksOnBrain.test.ts
```

**exit:** unit tests pass

---

### checkpoint 1.6: RoleHooks literal

**deps:** 1.5, 0.2

**acceptance criteria:**
- [ ] `src/domain.objects/RoleHooks.ts` created
- [ ] `src/domain.objects/RoleHooks.test.ts` created
- [ ] extends `DomainLiteral`
- [ ] declares: `onDispatch?: RoleHooksOnDispatch`, `onBrain?: RoleHooksOnBrain`
- [ ] static `nested` defined for hydration
- [ ] unit tests verify nested hydration

**verification:**
```sh
# verify files exist
ls src/domain.objects/RoleHooks.ts
ls src/domain.objects/RoleHooks.test.ts

# verify nested hydration
grep -q "static nested" src/domain.objects/RoleHooks.ts

# verify tests pass
npm run test:unit -- RoleHooks.test.ts
```

**exit:** unit tests pass

---

### checkpoint 1.7: extend Role interface

**deps:** 1.6

**acceptance criteria:**
- [ ] `src/domain.objects/Role.ts` modified
- [ ] `hooks?: RoleHooks` property added
- [ ] types check passes
- [ ] prior Role tests still pass

**verification:**
```sh
# verify hooks property
grep -q "hooks.*:.*RoleHooks" src/domain.objects/Role.ts

# verify types
npm run test:types

# verify prior tests pass
npm run test:unit -- Role.test.ts
```

**exit:** types check and tests pass

---

### checkpoint 1.8: BrainHooksAdapterDao interface

**deps:** 1.3

**acceptance criteria:**
- [ ] `src/domain.objects/BrainHooksAdapterDao.ts` created
- [ ] declares: `get.one`, `get.all`, `set.findsert`, `set.upsert`, `del`
- [ ] uses method syntax for bivariance
- [ ] types check passes

**verification:**
```sh
# verify file exists
ls src/domain.objects/BrainHooksAdapterDao.ts

# verify DAO methods
grep -q "get:" src/domain.objects/BrainHooksAdapterDao.ts
grep -q "set:" src/domain.objects/BrainHooksAdapterDao.ts
grep -q "del(" src/domain.objects/BrainHooksAdapterDao.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 1.9: BrainHooksAdapter interface

**deps:** 1.8

**acceptance criteria:**
- [ ] `src/domain.objects/BrainHooksAdapter.ts` created
- [ ] declares: `slug: string`, `dao: BrainHooksAdapterDao`
- [ ] types check passes

**verification:**
```sh
# verify file exists
ls src/domain.objects/BrainHooksAdapter.ts

# verify interface shape
grep -q "slug.*:.*string" src/domain.objects/BrainHooksAdapter.ts
grep -q "dao.*:.*BrainHooksAdapterDao" src/domain.objects/BrainHooksAdapter.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 1.10: BrainSpecifier type

**deps:** none (can parallel with 1.1-1.9)

**acceptance criteria:**
- [ ] `src/domain.objects/BrainSpecifier.ts` created
- [ ] type alias: `export type BrainSpecifier = string`
- [ ] types check passes

**verification:**
```sh
# verify file exists
ls src/domain.objects/BrainSpecifier.ts

# verify type alias
grep -q "type BrainSpecifier" src/domain.objects/BrainSpecifier.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 1.GATE: phase 1 complete

**deps:** 1.1 through 1.10

**acceptance criteria:**
- [ ] all domain objects created
- [ ] all unit tests pass
- [ ] types check passes

**verification:**
```sh
npm run test:types
npm run test:unit -- domain.objects
```

**exit:** all tests pass, ready for phase 2

---

## phase 2: anthropic adapter (claudecode)

### checkpoint 2.1: package structure

**deps:** 1.GATE

**acceptance criteria:**
- [ ] `src/_topublish/rhachet-brains-anthropic/` directory created
- [ ] `package.json` created with name `rhachet-brains-anthropic`
- [ ] `src/index.ts` created
- [ ] `src/hooks/` directory created

**verification:**
```sh
# verify directory structure
ls src/_topublish/rhachet-brains-anthropic/package.json
ls src/_topublish/rhachet-brains-anthropic/src/index.ts
ls -d src/_topublish/rhachet-brains-anthropic/src/hooks/
```

**exit:** directory structure present

---

### checkpoint 2.2: config.dao

**deps:** 2.1

**acceptance criteria:**
- [ ] `config.dao.ts` created at `src/_topublish/rhachet-brains-anthropic/src/hooks/`
- [ ] `config.dao.integration.test.ts` created
- [ ] implements `read({ from })` — reads `.claude/settings.json`
- [ ] implements `write({ settings, from })` — writes `.claude/settings.json`
- [ ] preserves non-hook content (permissions, etc)
- [ ] creates file if not present
- [ ] integration tests pass

**verification:**
```sh
# verify files exist
ls src/_topublish/rhachet-brains-anthropic/src/hooks/config.dao.ts
ls src/_topublish/rhachet-brains-anthropic/src/hooks/config.dao.integration.test.ts

# verify tests pass
npm run test:integration -- config.dao.integration.test.ts
```

**exit:** integration tests pass

---

### checkpoint 2.3: translateHook

**deps:** 2.1, 1.3

**acceptance criteria:**
- [ ] `translateHook.ts` created at `src/_topublish/rhachet-brains-anthropic/src/hooks/`
- [ ] `translateHook.test.ts` created
- [ ] translates `onBoot` → `SessionStart`
- [ ] translates `onTool` (before) → `PreToolUse`
- [ ] translates `onTool` (after) → `PostToolUse`
- [ ] translates `onStop` → `Stop`
- [ ] converts `IsoDuration` → seconds
- [ ] unit tests pass

**verification:**
```sh
# verify files exist
ls src/_topublish/rhachet-brains-anthropic/src/hooks/translateHook.ts
ls src/_topublish/rhachet-brains-anthropic/src/hooks/translateHook.test.ts

# verify tests pass
npm run test:unit -- translateHook.test.ts
```

**exit:** unit tests pass

---

### checkpoint 2.4: claudeCodeAdapter

**deps:** 2.2, 2.3

**acceptance criteria:**
- [ ] `claudeCodeAdapter.ts` created at `src/_topublish/rhachet-brains-anthropic/src/hooks/`
- [ ] `claudeCodeAdapter.test.ts` created
- [ ] `claudeCodeAdapter.integration.test.ts` created
- [ ] implements `BrainHooksAdapter` interface
- [ ] `dao.get.one` — finds hook by unique ref
- [ ] `dao.get.all` — lists hooks with filters
- [ ] `dao.set.findsert` — adds if not present (idempotent)
- [ ] `dao.set.upsert` — adds or updates
- [ ] `dao.del` — removes hook (idempotent)
- [ ] unit tests pass
- [ ] integration tests pass with snapshot

**verification:**
```sh
# verify files exist
ls src/_topublish/rhachet-brains-anthropic/src/hooks/claudeCodeAdapter.ts
ls src/_topublish/rhachet-brains-anthropic/src/hooks/claudeCodeAdapter.test.ts
ls src/_topublish/rhachet-brains-anthropic/src/hooks/claudeCodeAdapter.integration.test.ts

# verify tests pass
npm run test:unit -- claudeCodeAdapter.test.ts
npm run test:integration -- claudeCodeAdapter.integration.test.ts
```

**exit:** all tests pass

---

### checkpoint 2.5: getBrainHooks export

**deps:** 2.4

**acceptance criteria:**
- [ ] `getBrainHooks.ts` created at `src/_topublish/rhachet-brains-anthropic/src/hooks/`
- [ ] exports `getBrainHooks({ slug })` function
- [ ] returns `claudeCodeAdapter` for slug `'claudecode'`
- [ ] returns `claudeCodeAdapter` for slug `'anthropic/claude/code'` (alias)
- [ ] returns `null` for unknown slugs
- [ ] re-exported from `src/index.ts`

**verification:**
```sh
# verify file exists
ls src/_topublish/rhachet-brains-anthropic/src/hooks/getBrainHooks.ts

# verify export from index
grep -q "getBrainHooks" src/_topublish/rhachet-brains-anthropic/src/index.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 2.GATE: phase 2 complete

**deps:** 2.1 through 2.5

**acceptance criteria:**
- [ ] anthropic adapter fully implemented
- [ ] all unit tests pass
- [ ] all integration tests pass
- [ ] config snapshots match expectations

**verification:**
```sh
npm run test:unit -- rhachet-brains-anthropic
npm run test:integration -- rhachet-brains-anthropic
```

**exit:** all tests pass, ready for phase 3

---

## phase 3: core operations

### checkpoint 3.1: discoverBrainPackages

**deps:** 1.GATE

**acceptance criteria:**
- [ ] `src/domain.operations/brains/discoverBrainPackages.ts` created
- [ ] `src/domain.operations/brains/discoverBrainPackages.test.ts` created
- [ ] scans `package.json` for `rhachet-brains-*` dependencies
- [ ] returns array of package names
- [ ] unit tests pass

**verification:**
```sh
# verify files exist
ls src/domain.operations/brains/discoverBrainPackages.ts
ls src/domain.operations/brains/discoverBrainPackages.test.ts

# verify tests pass
npm run test:unit -- discoverBrainPackages.test.ts
```

**exit:** unit tests pass

---

### checkpoint 3.2: getBrainHooksAdapterByConfigImplicit

**deps:** 3.1, 2.GATE

**acceptance criteria:**
- [ ] `src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.ts` created
- [ ] `src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.test.ts` created
- [ ] `src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.integration.test.ts` created
- [ ] discovers brain packages via `discoverBrainPackages`
- [ ] imports and calls `getBrainHooks({ slug })` on each
- [ ] returns adapter if exactly one matches
- [ ] returns null if none match
- [ ] throws if multiple match (ambiguous)
- [ ] unit tests pass
- [ ] integration tests pass

**verification:**
```sh
# verify files exist
ls src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.ts
ls src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.test.ts
ls src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.integration.test.ts

# verify tests pass
npm run test:unit -- getBrainHooksAdapterByConfigImplicit.test.ts
npm run test:integration -- getBrainHooksAdapterByConfigImplicit.integration.test.ts
```

**exit:** all tests pass

---

### checkpoint 3.3: detectBrainReplsInRepo

**deps:** 1.GATE

**acceptance criteria:**
- [ ] `src/domain.operations/brains/detectBrainReplsInRepo.ts` created
- [ ] `src/domain.operations/brains/detectBrainReplsInRepo.test.ts` created
- [ ] checks for `.claude/settings.json` → returns `'claudecode'`
- [ ] checks for `.opencode/` directory → returns `'opencode'`
- [ ] returns array of detected brain slugs
- [ ] unit tests pass

**verification:**
```sh
# verify files exist
ls src/domain.operations/brains/detectBrainReplsInRepo.ts
ls src/domain.operations/brains/detectBrainReplsInRepo.test.ts

# verify tests pass
npm run test:unit -- detectBrainReplsInRepo.test.ts
```

**exit:** unit tests pass

---

### checkpoint 3.4: syncRoleHooksIntoBrainRepl

**deps:** 3.2, 2.GATE

**acceptance criteria:**
- [ ] `src/domain.operations/brains/syncRoleHooksIntoBrainRepl.ts` created
- [ ] `src/domain.operations/brains/syncRoleHooksIntoBrainRepl.test.ts` created
- [ ] `src/domain.operations/brains/syncRoleHooksIntoBrainRepl.integration.test.ts` created
- [ ] reads `Role.hooks.onBrain` declarations
- [ ] computes author namespace: `repo={registry.slug}/role={role.slug}`
- [ ] gets hooks found via `adapter.dao.get.all({ by: { author } })`
- [ ] computes diff: declared vs found
- [ ] applies `set.upsert` for declared hooks
- [ ] applies `del` for hooks no longer declared
- [ ] unit tests verify diff logic
- [ ] integration tests verify full sync cycle
- [ ] integration tests verify declarative removal

**verification:**
```sh
# verify files exist
ls src/domain.operations/brains/syncRoleHooksIntoBrainRepl.ts
ls src/domain.operations/brains/syncRoleHooksIntoBrainRepl.test.ts
ls src/domain.operations/brains/syncRoleHooksIntoBrainRepl.integration.test.ts

# verify tests pass
npm run test:unit -- syncRoleHooksIntoBrainRepl.test.ts
npm run test:integration -- syncRoleHooksIntoBrainRepl.integration.test.ts
```

**exit:** all tests pass

---

### checkpoint 3.5: applyRoleHooksToDetectedBrains

**deps:** 3.2, 3.3, 3.4

**acceptance criteria:**
- [ ] `src/domain.operations/brains/applyRoleHooksToDetectedBrains.ts` created
- [ ] `src/domain.operations/brains/applyRoleHooksToDetectedBrains.integration.test.ts` created
- [ ] resolves brain slugs: explicit or auto-detect via `detectBrainReplsInRepo`
- [ ] resolves adapters via `getBrainHooksAdapterByConfigImplicit`
- [ ] syncs each role × adapter via `syncRoleHooksIntoBrainRepl`
- [ ] returns `{ applied, errors }` results
- [ ] integration tests pass

**verification:**
```sh
# verify files exist
ls src/domain.operations/brains/applyRoleHooksToDetectedBrains.ts
ls src/domain.operations/brains/applyRoleHooksToDetectedBrains.integration.test.ts

# verify tests pass
npm run test:integration -- applyRoleHooksToDetectedBrains.integration.test.ts
```

**exit:** integration tests pass

---

### checkpoint 3.GATE: phase 3 complete

**deps:** 3.1 through 3.5

**acceptance criteria:**
- [ ] all core operations implemented
- [ ] all unit tests pass
- [ ] all integration tests pass

**verification:**
```sh
npm run test:unit -- domain.operations/brains
npm run test:integration -- domain.operations/brains
```

**exit:** all tests pass, ready for phase 4

---

## phase 4: cli integration

### checkpoint 4.1: extend invokeInit with --hooks

**deps:** 3.GATE

**acceptance criteria:**
- [ ] `src/contract/cli/invokeInit.ts` modified
- [ ] `--hooks [slugs...]` option added
- [ ] no `--hooks` → prior behavior (no hooks applied)
- [ ] `--hooks` (no args) → auto-detect brains + apply
- [ ] `--hooks <slugs...>` → apply to explicit brains only
- [ ] types check passes

**verification:**
```sh
# verify option added
grep -q "hooks" src/contract/cli/invokeInit.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 4.2: getLinkedRoles with hooks

**deps:** 4.1

**acceptance criteria:**
- [ ] `getLinkedRoles` returns roles with `hooks.onBrain` declarations
- [ ] integration test validates hook declarations found

**verification:**
```sh
npm run test:integration -- getLinkedRoles
```

**exit:** integration tests pass

---

### checkpoint 4.GATE: phase 4 complete

**deps:** 4.1, 4.2

**acceptance criteria:**
- [ ] cli integration complete
- [ ] types check passes
- [ ] build succeeds

**verification:**
```sh
npm run test:types
npm run build
```

**exit:** build succeeds, ready for phase 5

---

## phase 5: acceptance tests

### checkpoint 5.1: test fixtures

**deps:** 4.GATE

**acceptance criteria:**
- [ ] `accept.blackbox/.test/assets/with-claude-config/` created
- [ ] `accept.blackbox/.test/assets/with-role-hooks/` created
- [ ] `accept.blackbox/.test/assets/with-brains-package/` created
- [ ] each fixture has valid structure

**verification:**
```sh
# verify fixtures exist
ls -d accept.blackbox/.test/assets/with-claude-config/
ls -d accept.blackbox/.test/assets/with-role-hooks/
ls -d accept.blackbox/.test/assets/with-brains-package/
```

**exit:** fixtures present

---

### checkpoint 5.2: init --roles (no hooks) acceptance test

**deps:** 5.1

**acceptance criteria:**
- [ ] `accept.blackbox/cli/init.hooks.acceptance.test.ts` created
- [ ] test case: `init --roles <role>` (no `--hooks`)
- [ ] verifies: exit code is 0
- [ ] verifies: `.claude/settings.json` has no rhachet hooks
- [ ] acceptance test passes

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts --testNamePattern="no --hooks"
```

**exit:** acceptance test passes

---

### checkpoint 5.3: init --roles --hooks (auto-detect) acceptance test

**deps:** 5.2

**acceptance criteria:**
- [ ] test case: `init --roles <role> --hooks` (no args)
- [ ] verifies: exit code is 0
- [ ] verifies: `.claude/settings.json` has role hooks
- [ ] verifies: hooks include author namespace
- [ ] acceptance test passes

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts --testNamePattern="auto-detect"
```

**exit:** acceptance test passes

---

### checkpoint 5.4: init --roles --hooks <slug> acceptance test

**deps:** 5.3

**acceptance criteria:**
- [ ] test case: `init --roles <role> --hooks claudecode`
- [ ] verifies: exit code is 0
- [ ] verifies: `.claude/settings.json` has role hooks
- [ ] acceptance test passes

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts --testNamePattern="explicit slug"
```

**exit:** acceptance test passes

---

### checkpoint 5.5: init --hooks (reapply) acceptance test

**deps:** 5.4

**acceptance criteria:**
- [ ] test case: `init --hooks` (no roles, auto-detect)
- [ ] verifies: exit code is 0
- [ ] verifies: hooks applied for already-linked roles
- [ ] acceptance test passes

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts --testNamePattern="reapply"
```

**exit:** acceptance test passes

---

### checkpoint 5.6: declarative sync removal acceptance test

**deps:** 5.5

**acceptance criteria:**
- [ ] test case: role prior declared `[hook1, hook2]`, now declares `[hook2, hook3]`
- [ ] verifies: hook1 is removed
- [ ] verifies: hook2 is retained
- [ ] verifies: hook3 is added
- [ ] acceptance test passes

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts --testNamePattern="declarative sync"
```

**exit:** acceptance test passes

---

### checkpoint 5.7: namespace isolation acceptance test

**deps:** 5.6

**acceptance criteria:**
- [ ] test case: multiple roles with hooks
- [ ] verifies: roleA hooks are namespaced
- [ ] verifies: roleB hooks are namespaced
- [ ] verifies: roleA sync does not affect roleB hooks
- [ ] acceptance test passes

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts --testNamePattern="namespace isolation"
```

**exit:** acceptance test passes

---

### checkpoint 5.GATE: phase 5 complete

**deps:** 5.1 through 5.7

**acceptance criteria:**
- [ ] all acceptance tests pass
- [ ] snapshot tests match expectations

**verification:**
```sh
npm run test:acceptance -- init.hooks.acceptance.test.ts
```

**exit:** all acceptance tests pass, ready for phase 6

---

## phase 6: opencode adapter (extension)

### checkpoint 6.1: package structure

**deps:** 5.GATE

**acceptance criteria:**
- [ ] `src/_topublish/rhachet-brains-opencode/` directory created
- [ ] `package.json` created with name `rhachet-brains-opencode`
- [ ] `src/index.ts` created
- [ ] `src/hooks/` directory created

**verification:**
```sh
# verify directory structure
ls src/_topublish/rhachet-brains-opencode/package.json
ls src/_topublish/rhachet-brains-opencode/src/index.ts
ls -d src/_topublish/rhachet-brains-opencode/src/hooks/
```

**exit:** directory structure present

---

### checkpoint 6.2: plugin.dao

**deps:** 6.1

**acceptance criteria:**
- [ ] `plugin.dao.ts` created at `src/_topublish/rhachet-brains-opencode/src/hooks/`
- [ ] `plugin.dao.integration.test.ts` created
- [ ] implements `read({ from })` — parses hooks from `.opencode/plugin/rhachet-hooks.ts`
- [ ] implements `write({ hooks, from })` — generates plugin file
- [ ] preserves author metadata in comments
- [ ] creates file if not present
- [ ] integration tests pass

**verification:**
```sh
# verify files exist
ls src/_topublish/rhachet-brains-opencode/src/hooks/plugin.dao.ts
ls src/_topublish/rhachet-brains-opencode/src/hooks/plugin.dao.integration.test.ts

# verify tests pass
npm run test:integration -- plugin.dao.integration.test.ts
```

**exit:** integration tests pass

---

### checkpoint 6.3: translateHook

**deps:** 6.1, 1.3

**acceptance criteria:**
- [ ] `translateHook.ts` created at `src/_topublish/rhachet-brains-opencode/src/hooks/`
- [ ] `translateHook.test.ts` created
- [ ] generates TypeScript handler code for each event type
- [ ] translates `onBoot` → `session.created` + `session.compacted` handlers
- [ ] translates `onTool` (before) → `tool.execute.before` handler
- [ ] translates `onTool` (after) → `tool.execute.after` handler
- [ ] translates `onStop` → `session.idle` handler
- [ ] converts `IsoDuration` → milliseconds
- [ ] unit tests pass

**verification:**
```sh
# verify files exist
ls src/_topublish/rhachet-brains-opencode/src/hooks/translateHook.ts
ls src/_topublish/rhachet-brains-opencode/src/hooks/translateHook.test.ts

# verify tests pass
npm run test:unit -- rhachet-brains-opencode/src/hooks/translateHook.test.ts
```

**exit:** unit tests pass

---

### checkpoint 6.4: openCodeAdapter

**deps:** 6.2, 6.3

**acceptance criteria:**
- [ ] `openCodeAdapter.ts` created at `src/_topublish/rhachet-brains-opencode/src/hooks/`
- [ ] `openCodeAdapter.test.ts` created
- [ ] `openCodeAdapter.integration.test.ts` created
- [ ] implements `BrainHooksAdapter` interface
- [ ] all DAO methods implemented
- [ ] unit tests pass
- [ ] integration tests pass with snapshot

**verification:**
```sh
# verify files exist
ls src/_topublish/rhachet-brains-opencode/src/hooks/openCodeAdapter.ts
ls src/_topublish/rhachet-brains-opencode/src/hooks/openCodeAdapter.test.ts
ls src/_topublish/rhachet-brains-opencode/src/hooks/openCodeAdapter.integration.test.ts

# verify tests pass
npm run test:unit -- openCodeAdapter.test.ts
npm run test:integration -- openCodeAdapter.integration.test.ts
```

**exit:** all tests pass

---

### checkpoint 6.5: getBrainHooks export

**deps:** 6.4

**acceptance criteria:**
- [ ] `getBrainHooks.ts` created at `src/_topublish/rhachet-brains-opencode/src/hooks/`
- [ ] exports `getBrainHooks({ slug })` function
- [ ] returns `openCodeAdapter` for slug `'opencode'`
- [ ] returns `openCodeAdapter` for slug `'anomaly/opencode'` (alias)
- [ ] returns `null` for unknown slugs
- [ ] re-exported from `src/index.ts`

**verification:**
```sh
# verify file exists
ls src/_topublish/rhachet-brains-opencode/src/hooks/getBrainHooks.ts

# verify export from index
grep -q "getBrainHooks" src/_topublish/rhachet-brains-opencode/src/index.ts

# verify types
npm run test:types
```

**exit:** types check passes

---

### checkpoint 6.GATE: phase 6 complete

**deps:** 6.1 through 6.5

**acceptance criteria:**
- [ ] opencode adapter fully implemented
- [ ] all unit tests pass
- [ ] all integration tests pass

**verification:**
```sh
npm run test:unit -- rhachet-brains-opencode
npm run test:integration -- rhachet-brains-opencode
```

**exit:** all tests pass, ready for phase 7

---

## phase 7: final verification

### checkpoint 7.1: full test suite passes

**deps:** 6.GATE

**acceptance criteria:**
- [ ] all unit tests pass
- [ ] all integration tests pass
- [ ] all acceptance tests pass

**verification:**
```sh
npm run test:unit
npm run test:integration
npm run test:acceptance
```

**exit:** all tests pass

---

### checkpoint 7.2: type check passes

**deps:** 7.1

**acceptance criteria:**
- [ ] `npm run test:types` exits 0
- [ ] no type errors

**verification:**
```sh
npm run test:types
```

**exit:** no type errors

---

### checkpoint 7.3: lint passes

**deps:** 7.2

**acceptance criteria:**
- [ ] `npm run test:lint` exits 0
- [ ] no lint errors

**verification:**
```sh
npm run test:lint
```

**exit:** no lint errors

---

### checkpoint 7.4: build succeeds

**deps:** 7.3

**acceptance criteria:**
- [ ] `npm run build` exits 0
- [ ] dist output generated

**verification:**
```sh
npm run build
ls dist/
```

**exit:** build succeeds

---

### checkpoint 7.GATE: implementation complete

**deps:** 7.1 through 7.4

**acceptance criteria:**
- [ ] all tests pass
- [ ] types check passes
- [ ] lint passes
- [ ] build succeeds
- [ ] ready for code review

**verification:**
```sh
npm run test:types && npm run test:lint && npm run build && npm run test
```

**exit:** implementation complete, ready for PR

---

## dependency graph

```
phase 0: prerequisites
    0.1 ──► 0.2

phase 1: domain foundation
    0.2 ──► 1.1 ──► 1.2 ──► 1.3 ──► 1.8 ──► 1.9
                    │        │
                    ▼        ▼
                   1.4      1.3
                    │
                    ▼
                   1.5 ──► 1.6 ──► 1.7
                            │
    1.10 (parallel) ◄───────┘

    1.1-1.10 ──► 1.GATE

phase 2: anthropic adapter
    1.GATE ──► 2.1 ──► 2.2 ──► 2.4
                │       │
                ▼       │
               2.3 ─────┘
                │
                ▼
               2.5

    2.1-2.5 ──► 2.GATE

phase 3: core operations
    1.GATE ──► 3.1 ──► 3.2
    1.GATE ──► 3.3
    2.GATE ──► 3.2 ──► 3.4 ──► 3.5
               3.3 ──► 3.5

    3.1-3.5 ──► 3.GATE

phase 4: cli integration
    3.GATE ──► 4.1 ──► 4.2 ──► 4.GATE

phase 5: acceptance tests
    4.GATE ──► 5.1 ──► 5.2 ──► 5.3 ──► 5.4 ──► 5.5 ──► 5.6 ──► 5.7 ──► 5.GATE

phase 6: opencode adapter (extension)
    5.GATE ──► 6.1 ──► 6.2 ──► 6.4
                │       │
                ▼       │
               6.3 ─────┘
                │
                ▼
               6.5

    6.1-6.5 ──► 6.GATE

phase 7: final verification
    6.GATE ──► 7.1 ──► 7.2 ──► 7.3 ──► 7.4 ──► 7.GATE
```

---

## behavioral acceptance summary

the implementation is complete when:

1. **roles can declare hooks** (usecase.1)
   - `Role.hooks.onBrain.{ onBoot, onTool, onStop }` accepted

2. **adapters are discovered** (usecase.2)
   - `rhachet-brains-*` packages scanned
   - `getBrainHooks({ slug })` called to resolve adapter

3. **hooks are applied via CLI** (usecase.3)
   - `--roles` without `--hooks` → no hooks applied
   - `--roles --hooks` → auto-detect + apply
   - `--roles --hooks <slug>` → explicit + apply
   - `--hooks` alone → reapply to linked roles

4. **DAO operations work** (usecases.4-7)
   - `set.findsert` adds if not present (idempotent)
   - `set.upsert` adds or updates
   - `del` removes (idempotent)
   - `get.one` / `get.all` query hooks

5. **declarative sync works** (usecase.8)
   - hooks no longer declared are removed
   - hooks declared are added/updated
   - namespace isolation preserved

6. **filters work** (usecase.9)
   - `filter.what` selects tool
   - `filter.when` selects before/after

7. **errors are clear** (usecase.10)
   - invalid declarations fail with helpful message
   - malformed config fails with helpful message
   - absent config created automatically

8. **brain-specific formats work** (boundaries.1-2)
   - claudecode → `.claude/settings.json` with correct event names
   - opencode → `.opencode/plugin/rhachet-hooks.ts` with correct handlers

---

## citations

[1] `.behavior/v2026_01_09.hook-adapter/0.wish.md`
[2] `.behavior/v2026_01_09.hook-adapter/2.criteria.blackbox.md`
[3] `.behavior/v2026_01_09.hook-adapter/2.criteria.blueprint.md`
[4] `.behavior/v2026_01_09.hook-adapter/3.2.distill.domain._.v1.i1.md`
[5] `.behavior/v2026_01_09.hook-adapter/3.3.blueprint.v1.i1.md`
[6] `.agent/repo=.this/role=any/briefs/define.term.suppliers.md`
[7] `.agent/repo=.this/role=any/briefs/define.term.adapters.md`

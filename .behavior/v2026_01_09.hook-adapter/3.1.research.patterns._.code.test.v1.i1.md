# test codepath patterns research for hook-adapter

## summary

this document enumerates the test codepath patterns available in the rhachet codebase that are relevant to the hook-adapter feature. each pattern is marked as [REUSE], [EXTEND], or [REPLACE] based on how it will be leveraged.

---

## pattern.1 = genTestTempRepo fixture-based temp repos [REUSE]

### .what

creates isolated test repositories in `os.tmpdir()` by copy of fixture assets. provides clean, disposable environments for acceptance tests.

### .citation.1

file: `accept.blackbox/.test/infra/genTestTempRepo.ts`

```ts
export const genTestTempRepo = (input: {
  fixture: TestRepoFixture;
  suffix?: string;
  install?: boolean;
}): { path: string } => {
  const uniqueId = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
  const suffix = input.suffix ? `-${input.suffix}` : '';
  const tempDir = path.join(
    os.tmpdir(),
    `rhachet-test-${input.fixture}${suffix}-${uniqueId}`,
  );
```

### .citation.2

file: `accept.blackbox/.test/infra/genTestTempRepo.ts`

```ts
export type TestRepoFixture =
  | 'minimal'
  | 'with-skills'
  | 'with-briefs'
  | 'with-registry'
  | 'with-roles-packages';
```

### .relation to wish

the wish requires acceptance tests that "snapshot the resultant hook artifacts produced by the atomic BrainHooksAdapter.register operations". genTestTempRepo enables creation of clean test repos where `.claude/settings.json` can be created and verified.

### .usage

[REUSE] — use as-is. add new fixture type `with-claude-config` or similar to support hook-adapter test scenarios.

---

## pattern.2 = invokeRhachetCliBinary subprocess invocation [REUSE]

### .what

invokes the compiled rhachet CLI binary as a subprocess for black-box acceptance tests. captures stdout, stderr, and exit status.

### .citation.1

file: `accept.blackbox/.test/infra/invokeRhachetCliBinary.ts`

```ts
export const invokeRhachetCliBinary = (input: {
  args: string[];
  cwd: string;
  stdin?: string;
  logOnError?: boolean;
  env?: Record<string, string | undefined>;
}): SpawnSyncReturns<string> => {
  const result = spawnSync(
    RHACHET_BIN,
    input.args,
    {
      cwd: input.cwd,
      encoding: 'utf-8',
      input: input.stdin,
      env: { ...process.env, ...input.env },
    },
  );
```

### .relation to wish

the wish requires CLI acceptance tests for `init --hooks` variants. invokeRhachetCliBinary enables test of the full command flow from CLI entry to config file output.

### .usage

[REUSE] — use as-is to invoke `init --roles <role> --hooks` and similar commands.

---

## pattern.3 = fixture assets structure [EXTEND]

### .what

fixture templates in `accept.blackbox/.test/assets/` provide pre-configured test repo states that are copied by genTestTempRepo.

### .citation.1

file: `accept.blackbox/.test/assets/with-roles-packages/package.json`

```json
{
  "name": "rhachet-test-repo-with-roles-packages",
  "private": true,
  "dependencies": {
    "rhachet-roles-test": "file:./node_modules/rhachet-roles-test"
  }
}
```

### .citation.2

file: `accept.blackbox/.test/assets/with-roles-packages/node_modules/rhachet-roles-test/rhachet.repo.yml`

```yaml
slug: test
readme: readme.md
roles:
  - slug: example
    name: Example Role
    purpose: test role for acceptance tests
```

### .relation to wish

the wish requires test of hook sync across roles with `hooks.onBrain` declarations. need fixtures that include:
- roles with `hooks.onBrain` declared
- `.claude/settings.json` files (for claudecode adapter tests)
- mock `rhachet-brains-*` packages (for adapter discovery tests)

### .usage

[EXTEND] — create new fixtures:
- `with-claude-config` — minimal repo with `.claude/settings.json`
- `with-role-hooks` — roles package with `hooks.onBrain` declarations
- `with-brains-package` — mock `rhachet-brains-anthropic` package

---

## pattern.4 = BDD acceptance test structure [REUSE]

### .what

uses `given`, `when`, `then`, `useBeforeAll` from `test-fns` for behavior-driven test organization.

### .citation.1

file: `accept.blackbox/cli/roles.link.acceptance.test.ts`

```ts
import { given, then, when, useBeforeAll } from 'test-fns';

describe('rhachet roles link', () => {
  given('[case1] repo with rhachet-roles-test package installed', () => {
    const repo = useBeforeAll(() =>
      genTestTempRepo({ fixture: 'with-roles-packages', install: true }),
    );

    when('[t0] roles link --role test/example is invoked', () => {
      const result = useBeforeAll(() =>
        invokeRhachetCliBinary({
          args: ['roles', 'link', '--role', 'test/example'],
          cwd: repo.path,
        }),
      );

      then('exit code is 0', () => {
        expect(result.status).toEqual(0);
      });
```

### .relation to wish

the wish requires acceptance tests for:
- `init --roles <role> --hooks` (auto-detect)
- `init --roles <role> --hooks <slug>` (explicit)
- `init --hooks` (reapply to linked roles)
- error cases (unknown slug, no brains detected)

### .usage

[REUSE] — follow BDD pattern for hook-adapter acceptance tests.

---

## pattern.5 = integration test with .temp/ directories [REUSE]

### .what

integration tests use `.temp/` directories within the repo for test isolation, with beforeAll/afterAll for setup/cleanup.

### .citation.1

file: `src/contract/cli/invokeInit.integration.test.ts`

```ts
const TEST_DIR = path.join(__dirname, '.temp');

describe('invokeInit', () => {
  beforeAll(async () => {
    await fs.mkdir(TEST_DIR, { recursive: true });
  });

  afterAll(async () => {
    await fs.rm(TEST_DIR, { recursive: true, force: true });
  });
```

### .citation.2

file: `src/contract/cli/invokeInit.integration.test.ts`

```ts
      then('rhachet.use.ts is created', async () => {
        const useFilePath = path.join(targetDir, 'rhachet.use.ts');
        expect(existsSync(useFilePath)).toBe(true);
        const content = await fs.readFile(useFilePath, 'utf-8');
        expect(content).toContain("import { genRhachetUseConfig }");
      });
```

### .relation to wish

the wish requires integration tests for:
- `BrainHooksAdapter.dao.{get,set,del}` methods
- config file read/write operations
- declarative sync logic

### .usage

[REUSE] — follow pattern for adapter integration tests. use `.temp/` directories for config file manipulation tests.

---

## pattern.6 = mock context injection [EXTEND]

### .what

injects mock dependencies into context for isolated tests without real filesystem or network.

### .citation.1

file: `src/contract/cli/invokeRolesLink.integration.test.ts`

```ts
      const context = genMockContextConfigOfUsage({
        config: {
          roleRegistries: [roleRegistry],
          invokeHooks: null,
        },
      });
```

### .citation.2

file: `src/contract/cli/invokeRolesLink.integration.test.ts`

```ts
        await invokeRolesLink(
          { role: 'mock-registry/mock-role', to: targetDir },
          context,
        );
```

### .relation to wish

the wish requires tests for:
- `getBrainHooksAdapterByConfigImplicit` package discovery
- `syncRoleHooksIntoBrainRepl` with mock adapters
- adapter isolation without real `.claude/settings.json`

### .usage

[EXTEND] — extend mock context to support:
- mock BrainHooksAdapter instances
- mock `rhachet-brains-*` package resolution
- mock brain detection results

---

## pattern.7 = snapshot test for output artifacts [REUSE]

### .what

combines explicit assertions with `.toMatchSnapshot()` for output observability in code reviews.

### .citation.1

file: `src/domain.operations/init/genRhachetUseConfig.test.ts`

```ts
  it('should generate config for single package with aliased imports', () => {
    const result = genRhachetUseConfig({
      packages: ['rhachet-roles-ehmpathy'],
    });

    // Verify aliased imports for single package
    expect(result).toContain(
      "import { getRoleRegistry as getRoleRegistryEhmpathy, getInvokeHooks as getInvokeHooksEhmpathy } from 'rhachet-roles-ehmpathy'",
    );

    // Snapshot for observability
    expect(result).toMatchSnapshot();
  });
```

### .relation to wish

the wish explicitly requires: "integration tests that snapshot resultant config file" for:
- BrainHooksAdapter implementations (claudecode, opencode)
- full sync cycle output
- CLI command output

### .usage

[REUSE] — use snapshot pattern for:
- `.claude/settings.json` after hook application
- adapter output artifacts
- CLI stdout/stderr

---

## pattern.8 = file verification patterns [REUSE]

### .what

uses filesystem APIs to verify file creation, content, and permissions.

### .citation.1

file: `accept.blackbox/cli/roles.link.acceptance.test.ts`

```ts
      then('symlink points to node_modules package', () => {
        const symlinkPath = path.join(
          repo.path,
          '.agent/repo=test/role=example',
        );
        const linkTarget = readlinkSync(symlinkPath);
        expect(linkTarget).toContain('node_modules/rhachet-roles-test');
      });
```

### .citation.2

file: `src/contract/cli/invokeRolesLink.integration.test.ts`

```ts
        const linkPath = path.join(targetDir, '.agent/repo=mock-registry/role=mock-role');
        const stat = statSync(linkPath);

        // verify it's a symlink
        expect(lstatSync(linkPath).isSymbolicLink()).toBe(true);
```

### .relation to wish

the wish requires verification that:
- hooks are written to `.claude/settings.json`
- hook format matches brain expectations
- non-hook content is preserved

### .usage

[REUSE] — use file verification patterns to check:
- `.claude/settings.json` content after sync
- hook section structure
- preservation of non-hook content

---

## pattern.9 = declarative sync test pattern [NEW]

### .what

tests for declarative sync behavior where current state is diffed against desired state.

### .citation.1

file: `.behavior/v2026_01_09.hook-adapter/2.criteria.blackbox.md`

```
given('role A prior declared [hook1, hook2], now declares [hook2, hook3]')
  when('hooks are applied via adapter')
    then('hook1 is removed (no longer declared)')
      sothat('removed declarations result in removed hooks')
    then('hook2 is retained')
    then('hook3 is added')
      sothat('brain config reflects current Role.hooks.onBrain state')
```

### .relation to wish

the wish states: "of maximum importance is to make sure that if a hook is no longer specified by the role, it will no longer be present after the hooks are applied"

### .usage

[NEW] — create new test pattern specifically for declarative sync verification:
- test hook addition
- test hook retention (idempotency)
- test hook removal when no longer declared
- test namespace isolation between roles

---

## pattern.10 = error case test [REUSE]

### .what

tests error handle with expected exceptions and descriptive messages.

### .citation.1

file: `accept.blackbox/cli/roles.link.acceptance.test.ts`

```ts
    when('[t0] roles link --role nonexistent/role is invoked', () => {
      const result = useBeforeAll(() =>
        invokeRhachetCliBinary({
          args: ['roles', 'link', '--role', 'nonexistent/role'],
          cwd: repo.path,
        }),
      );

      then('exit code is non-zero', () => {
        expect(result.status).not.toEqual(0);
      });

      then('stderr contains error message', () => {
        expect(result.stderr).toContain('not found');
      });
    });
```

### .relation to wish

the wish requires error handle tests for:
- unknown brain slug
- malformed config file
- multiple adapters matched to slug (ambiguity)

### .usage

[REUSE] — follow error test pattern for:
- `init --hooks unknown-slug` → error with available slugs
- malformed `.claude/settings.json` → descriptive error
- no brains detected → warn with suggestion

---

## summary table

| pattern | type | purpose |
|---------|------|---------|
| genTestTempRepo | [REUSE] | isolated temp repos for acceptance tests |
| invokeRhachetCliBinary | [REUSE] | CLI subprocess invocation |
| fixture assets | [EXTEND] | add claude-config, role-hooks, brains-package fixtures |
| BDD structure | [REUSE] | given/when/then test organization |
| .temp/ directories | [REUSE] | integration test isolation |
| mock context | [EXTEND] | add adapter mocks, brain detection mocks |
| snapshot test | [REUSE] | config output observability |
| file verification | [REUSE] | verify config file content |
| declarative sync | [NEW] | test add/retain/remove sync behavior |
| error cases | [REUSE] | test error handle and messages |

---

## recommended test structure

```
accept.blackbox/
  cli/
    init.hooks.acceptance.test.ts          # [NEW] init --hooks variants
  .test/
    assets/
      with-claude-config/                   # [NEW] fixture with .claude/settings.json
      with-role-hooks/                      # [NEW] fixture with hooks.onBrain declarations

src/_topublish/
  rhachet-brains-anthropic/
    src/
      adapter.integration.test.ts           # [NEW] claudecode adapter tests
      adapter.test.ts                       # [NEW] unit tests

src/domain.operations/
  brains/
    getBrainHooksAdapterByConfigImplicit.test.ts      # [NEW] discovery tests
    syncRoleHooksIntoBrainRepl.integration.test.ts    # [NEW] sync tests
    detectBrainReplsInRepo.test.ts                    # [NEW] detection tests
```

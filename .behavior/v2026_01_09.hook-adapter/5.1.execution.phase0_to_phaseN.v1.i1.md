# execution log = hook-adapter roadmap

## progress tracker

```
[x] phase 0: prerequisites
    [x] 0.1: verify dev environment
    [x] 0.2: rename InvokeHooks → RoleHooksOnDispatch

[x] phase 1: domain foundation
    [x] 1.1: BrainHookEvent type
    [x] 1.2: BrainHookFilter literal
    [x] 1.3: BrainHook entity
    [x] 1.4: RoleHookOnBrain literal
    [x] 1.5: RoleHooksOnBrain literal
    [x] 1.6: RoleHooks literal
    [x] 1.7: extend Role interface
    [x] 1.8: BrainHooksAdapterDao interface
    [x] 1.9: BrainHooksAdapter interface
    [x] 1.10: BrainSpecifier type

[x] phase 2: anthropic adapter (claudecode)
    [x] 2.1: package structure
    [x] 2.2: config.dao
    [x] 2.3: translateHook
    [x] 2.4: claudeCodeAdapter
    [x] 2.5: getBrainHooks export

[x] phase 3: core operations
    [x] 3.1: discoverBrainPackages
    [x] 3.2: getBrainHooksAdapterByConfigImplicit
    [x] 3.3: detectBrainReplsInRepo
    [x] 3.4: syncRoleHooksIntoBrainRepl
    [x] 3.5: applyRoleHooksToDetectedBrains

[x] phase 4: cli integration
    [x] 4.1: extend invokeInit with --hooks
    [x] 4.2: getLinkedRoles with hooks

[ ] phase 5: acceptance tests
    [ ] 5.1: test fixtures
    [ ] 5.2: init --roles (no hooks)
    [ ] 5.3: init --roles --hooks (auto-detect)
    [ ] 5.4: init --roles --hooks <slug>
    [ ] 5.5: init --hooks (reapply)
    [ ] 5.6: declarative sync removal
    [ ] 5.7: namespace isolation

[ ] phase 6: opencode adapter (extension)
    [ ] 6.1: package structure
    [ ] 6.2: plugin.dao
    [ ] 6.3: translateHook
    [ ] 6.4: openCodeAdapter
    [ ] 6.5: getBrainHooks export

[ ] phase 7: final verification
    [ ] 7.1: full test suite passes
    [ ] 7.2: type check passes
    [ ] 7.3: lint passes
    [ ] 7.4: build succeeds
```

---

## phase 0: prerequisites

### checkpoint 0.1: verify dev environment ✅

**status:** complete

**verification:**
```sh
npm run test:types  # ✅ passed
npm run build       # ✅ passed
npm run test:unit -- --passWithNoTests  # ✅ passed
```

---

### checkpoint 0.2: rename InvokeHooks → RoleHooksOnDispatch ✅

**status:** complete

**acceptance criteria:**
- [x] file renamed from `InvokeHooks.ts` to `RoleHooksOnDispatch.ts`
- [x] interface renamed from `InvokeHooks` to `RoleHooksOnDispatch`
- [x] all imports and references updated
- [x] backward-compatible type alias added: `type InvokeHooks = RoleHooksOnDispatch`
- [x] tests pass after rename

**verification:**
```sh
npm run test:types  # ✅ passed
npm run test:unit -- --passWithNoTests  # ✅ passed
```

---

## phase 1: domain foundation ✅

**status:** complete

**files created:**
- `src/domain.objects/BrainHookEvent.ts`
- `src/domain.objects/BrainHookFilter.ts`
- `src/domain.objects/BrainHook.ts`
- `src/domain.objects/RoleHookOnBrain.ts`
- `src/domain.objects/RoleHooksOnBrain.ts`
- `src/domain.objects/RoleHooks.ts`
- `src/domain.objects/BrainHooksAdapterDao.ts`
- `src/domain.objects/BrainHooksAdapter.ts`
- `src/domain.objects/BrainSpecifier.ts`

**files modified:**
- `src/domain.objects/Role.ts` — added `hooks?: RoleHooks` property
- `src/domain.objects/index.ts` — added exports for new domain objects

**verification:**
```sh
npm run test:types  # ✅ passed
npm run build       # ✅ passed
```

---

## phase 2: anthropic adapter (claudecode) ✅

**status:** complete

**files created:**
- `src/_topublish/rhachet-brains-anthropic/package.json`
- `src/_topublish/rhachet-brains-anthropic/tsconfig.json`
- `src/_topublish/rhachet-brains-anthropic/src/index.ts`
- `src/_topublish/rhachet-brains-anthropic/src/hooks/config.dao.ts`
- `src/_topublish/rhachet-brains-anthropic/src/hooks/translateHook.ts`
- `src/_topublish/rhachet-brains-anthropic/src/hooks/claudeCodeAdapter.ts`
- `src/_topublish/rhachet-brains-anthropic/src/hooks/getBrainHooks.ts`

**key implementation details:**
- `config.dao.ts` — read/write operations for `.claude/settings.json`
- `translateHook.ts` — bidirectional translation between rhachet BrainHook and claude code format
- `claudeCodeAdapter.ts` — implements BrainHooksAdapter interface with declastruct DAO pattern
- `getBrainHooks.ts` — supplier contract entry point for brain discovery

**event map:**
- `onBoot` → `SessionStart`
- `onTool` → `PreToolUse`
- `onStop` → `Stop`

**verification:**
```sh
npm run test:types  # ✅ passed
npm run build       # ✅ passed
```

---

## phase 3: core operations ✅

**status:** complete

**files created:**
- `src/domain.operations/brains/discoverBrainPackages.ts`
- `src/domain.operations/brains/discoverBrainPackages.test.ts`
- `src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.ts`
- `src/domain.operations/brains/getBrainHooksAdapterByConfigImplicit.test.ts`
- `src/domain.operations/brains/detectBrainReplsInRepo.ts`
- `src/domain.operations/brains/detectBrainReplsInRepo.test.ts`
- `src/domain.operations/brains/syncRoleHooksIntoBrainRepl.ts`
- `src/domain.operations/brains/syncRoleHooksIntoBrainRepl.test.ts`
- `src/domain.operations/brains/applyRoleHooksToDetectedBrains.ts`
- `src/domain.operations/brains/applyRoleHooksToDetectedBrains.test.ts`

**key implementation details:**
- `discoverBrainPackages` — scans package.json for `rhachet-brains-*` dependencies
- `getBrainHooksAdapterByConfigImplicit` — resolves adapter via implicit discovery of brain packages
- `detectBrainReplsInRepo` — detects brain repls in repo (`.claude/settings.json` → `claude-code`, `.opencode/` → `opencode`)
- `syncRoleHooksIntoBrainRepl` — syncs role hooks to brain config with declarative diff (add/update/remove/unchanged)
- `applyRoleHooksToDetectedBrains` — orchestrates sync across multiple roles and brains

**verification:**
```sh
npm run test:types  # ✅ passed
npm run build       # ✅ passed
npm run test:unit -- syncRoleHooksIntoBrainRepl.test.ts detectBrainReplsInRepo.test.ts applyRoleHooksToDetectedBrains.test.ts  # ✅ 30 tests passed
```

---

## phase 4: cli integration ✅

**status:** complete

**files created:**
- `src/domain.operations/brains/getLinkedRolesWithHooks.ts`
- `src/domain.operations/brains/getLinkedRolesWithHooks.test.ts`

**files modified:**
- `src/contract/cli/invokeInit.ts` — added `--hooks [brains...]` option and hook application logic

**key implementation details:**
- `getLinkedRolesWithHooks` — scans `.agent/repo=*` directories (skips `repo=.this`), imports packages dynamically to get full Role objects with `hooks.onBrain`
- `applyHooksForLinkedRoles` — helper function that orchestrates hook discovery and application
- cli routes: `--roles --hooks` applies after init, `--hooks` alone reapplies for already-linked roles

**behavior:**
- `--hooks` (no args) → auto-detect brains via `detectBrainReplsInRepo`
- `--hooks <slugs...>` → apply to explicit brains only

**verification:**
```sh
npm run test:types  # ✅ passed
npm run build       # ✅ passed
npm run test:unit -- getLinkedRolesWithHooks.test.ts  # ✅ 7 tests passed
```

---

## execution notes

- started: 2026-01-15
- blueprint: `.behavior/v2026_01_09.hook-adapter/3.3.blueprint.v1.i1.md`
- roadmap: `.behavior/v2026_01_09.hook-adapter/4.1.roadmap.v1.i1.md`

# execution: rhachet/keyrack phase 0 to phase N

> progress tracker for roadmap execution

---

## phase 0: foundation

**status:** complete

**checklist:**
- [x] create `src/domain.objects/keyrack/` directory structure
- [x] implement `KeyrackHostVault` literal type
- [x] implement `KeyrackGrantMechanism` literal type
- [x] implement `KeyrackGrantStatus` literal type
- [x] implement `KeyrackKeySpec` domain literal
- [x] implement `KeyrackRepoManifest` domain literal
- [x] implement `KeyrackKeyHost` domain literal
- [x] implement `KeyrackHostManifest` domain entity
- [x] implement `KeyrackKeyGrant` domain literal
- [x] implement `KeyrackGrantAttempt` discriminated union type
- [x] implement `KeyrackHostVaultAdapter` interface
- [x] implement `KeyrackGrantMechanismAdapter` interface
- [x] create `index.ts` barrel export

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**files created:**
```
src/domain.objects/keyrack/
├── index.ts
├── KeyrackGrantAttempt.ts
├── KeyrackGrantMechanism.ts
├── KeyrackGrantMechanismAdapter.ts
├── KeyrackGrantStatus.ts
├── KeyrackHostManifest.ts
├── KeyrackHostVault.ts
├── KeyrackHostVaultAdapter.ts
├── KeyrackKeyGrant.ts
├── KeyrackKeyHost.ts
├── KeyrackKeySpec.ts
└── KeyrackRepoManifest.ts
```

---

## phase 1: dao layer

**status:** complete

**checklist:**
- [x] implement `daoKeyrackHostManifest.get()` — read from `~/.rhachet/keyrack.manifest.json`
- [x] implement `daoKeyrackHostManifest.set()` — write to `~/.rhachet/keyrack.manifest.json`
- [x] implement `daoKeyrackRepoManifest.get()` — read from `@gitroot/.agent/keyrack.yml`
- [x] add zod schema validation for yaml parse
- [x] add findsert semantics to dao set operation

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**files created:**
```
src/access/daos/daoKeyrackHostManifest/
├── index.ts
└── schema.ts
src/access/daos/daoKeyrackRepoManifest/
├── index.ts
└── schema.ts
```

---

## phase 2: vault adapters

**status:** complete

**checklist:**
- [x] implement `vaultAdapterOsDirect` — plaintext json file storage
- [x] implement `vaultAdapterOsSecure` — age-encrypted file storage
- [x] implement `vaultAdapter1Password` — 1password cli integration
- [x] implement `isUnlocked()` for each adapter
- [x] implement `unlock()` for each adapter
- [x] implement `get()` for each adapter
- [x] implement `set()` for each adapter

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**files created:**
```
src/domain.operations/keyrack/adapters/vaults/
├── index.ts
├── vaultAdapterOsDirect.ts
├── vaultAdapterOsSecure.ts
└── vaultAdapter1Password.ts
```

---

## phase 3: mechanism adapters

**status:** complete

**checklist:**
- [x] implement `mechAdapterReplica` — passthrough with validation
- [x] implement `mechAdapterGithubApp` — json → installation token
- [x] implement `mechAdapterAwsSso` — sso profile → session credentials
- [x] add validation: replica rejects long-lived token patterns (ghp_*, gho_*, AKIA*)
- [x] add validation: github_app requires valid json with appId, privateKey, installationId
- [x] add validation: aws_sso requires valid profile name format

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**dependencies added:**
- @octokit/auth-app (github app token generation)

**files created:**
```
src/domain.operations/keyrack/adapters/mechanisms/
├── index.ts
├── mechAdapterReplica.ts
├── mechAdapterGithubApp.ts
└── mechAdapterAwsSso.ts
```

---

## phase 4: domain operations

**status:** complete

**checklist:**
- [x] implement `genKeyrackGrantContext()` — construct context for grant operations
- [x] implement `genKeyrackHostContext()` — construct context for host operations
- [x] implement `getKeyrackKeyGrant({ for: { repo } })` — grant all keys from manifest
- [x] implement `getKeyrackKeyGrant({ for: { key } })` — grant specific key
- [x] implement `setKeyrackKeyHost()` — configure storage for a key
- [x] implement `unlockKeyrackVault()` — unlock vaults for repo or key
- [x] add all-or-none semantics to repo grant
- [x] add fix instructions to failure responses

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**files created:**
```
src/domain.operations/keyrack/
├── index.ts
├── genKeyrackGrantContext.ts
├── genKeyrackHostContext.ts
├── getKeyrackKeyGrant.ts
├── setKeyrackKeyHost.ts
└── unlockKeyrackVault.ts
```

---

## phase 5: cli commands

**status:** complete

**checklist:**
- [x] create `src/contract/cli/invokeKeyrack.ts`
- [x] implement `keyrack get --for repo` command
- [x] implement `keyrack get --key $key` command
- [x] implement `keyrack set --key --mech --vault` command
- [x] implement `keyrack unlock --for repo` command
- [x] implement `keyrack unlock --key $key` command
- [x] implement `keyrack list` command
- [x] register `invokeKeyrack` in `invoke.ts`
- [ ] add short-circuit in `bin/rhx` for keyrack command

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**files created:**
```
src/contract/cli/invokeKeyrack.ts
```

**manual test commands:**
```sh
./bin/run keyrack --help
./bin/run keyrack get --for repo
./bin/run keyrack set --key XAI_API_KEY --mech REPLICA --vault os.direct
./bin/run keyrack list
```

---

## phase 6: sdk surface

**status:** complete

**checklist:**
- [x] create `src/contract/sdk.keyrack.ts`
- [x] export keyrack literal types (KeyrackGrantMechanism, KeyrackGrantStatus, KeyrackHostVault)
- [x] export keyrack domain objects (KeyrackHostManifest, KeyrackKeyHost, etc.)
- [x] export keyrack adapter types (KeyrackHostVaultAdapter, KeyrackGrantMechanismAdapter)
- [x] export keyrack operations (getKeyrackKeyGrant, setKeyrackKeyHost, unlockKeyrackVault)
- [x] export keyrack context generators (genKeyrackGrantContext, genKeyrackHostContext)
- [x] add `exports["./keyrack"]` to package.json
- [x] add `typesVersions["keyrack"]` to package.json

**verification:**
```sh
npm run test:types  # ✓ pass
npm run build       # ✓ pass
```

**files created:**
```
src/contract/sdk.keyrack.ts
```

**usage:**
```ts
import {
  getKeyrackKeyGrant,
  setKeyrackKeyHost,
  unlockKeyrackVault,
  genKeyrackGrantContext,
  KeyrackKeyGrant,
  KeyrackGrantMechanism,
} from 'rhachet/keyrack';
```

---

## phase 7: ci action

**status:** complete

**checklist:**
- [x] create `.github/actions/keyrack/action.yml`
- [x] add action input for key names (space-separated list or empty for all)
- [x] add action input for vault type
- [x] add action input for passphrase (for encrypted vaults)
- [x] add action output for granted keys (json array)
- [x] add action output for failed keys (json array with reasons)
- [x] implement vault unlock step (conditional on passphrase)
- [x] implement grant step with GITHUB_ENV export
- [x] add value mask for security (::add-mask::)

**verification:**
```sh
npm run test:types  # ✓ pass
```

**files created:**
```
.github/actions/keyrack/action.yml
```

**usage:**
```yaml
# in workflow file
- uses: ./.github/actions/keyrack
  with:
    keys: 'XAI_API_KEY OPENAI_API_KEY'  # optional, empty = all from manifest
    vault: 'os.direct'                   # optional
    passphrase: ${{ secrets.KEYRACK_PASSPHRASE }}  # optional, for os.secure

# credentials are now available as env vars
- run: echo "api key is masked: $XAI_API_KEY"
```

---

## summary

all phases complete:
- phase 0: foundation (domain objects) ✓
- phase 1: dao layer ✓
- phase 2: vault adapters ✓
- phase 3: mechanism adapters ✓
- phase 4: domain operations ✓
- phase 5: cli commands ✓
- phase 6: sdk surface ✓
- phase 7: ci action ✓

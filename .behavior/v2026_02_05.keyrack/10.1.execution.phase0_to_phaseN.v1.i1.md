# execution: keyrack v2 — ephemeral key cache

> track progress for blueprint 9.3.blueprint.v1.i1.md

---

## phase 0: extend os.direct vault ✅

- [x] update `vaultAdapterOsDirect` to support `{ value: string; expiresAt?: string }` entries
- [x] add expiry check in `get` — return null if expired, delete entry
- [x] extend `set` to accept optional `expiresAt` for ephemeral grants
- [x] backwards compat: auto-migrate legacy string values to entry format
- [x] add tests for expiry behavior

## phase 1: add os.direct precheck ✅

- [x] update `getKeyrackKeyGrant` to check os.direct AFTER os.envvar, BEFORE source vault
- [x] check os.direct for cached ephemeral (by slug)
- [x] if found and not expired → validate → translate → return grant
- [x] if expired → vault adapter auto-deletes, returns null, continue to source vault
- [x] update "fix" message in locked status to use `--unlock`

## phase 2: update getKeyrackKeyGrant for --unlock ✅

- [x] add `--unlock` flag to input
- [x] when `--unlock` + successful vault access → translate → store to os.direct
- [x] return `locked` status with `--unlock` fix when cache miss + no unlock

## phase 3: update mechanism adapters ✅

- [x] update `translate` return type to include `expiresAt`
- [x] update `mechAdapterReplica` to return `{ value }` (no expiry for passthrough)
- [x] update `mechAdapterGithubApp` to return `{ value, expiresAt }` (55 min for github tokens)
- [x] update `mechAdapterAwsSso` to return `{ value, expiresAt }` (from AWS_CREDENTIAL_EXPIRATION)

## phase 4: CLI updates

- [ ] add `--unlock` flag to `invokeKeyrack` get command
- [ ] update `unlock` command to print migration message
- [ ] remove source pattern from `bin/rhx`

## phase 5: tests

- [ ] unit tests for os.direct expiry check
- [ ] integration tests for `getKeyrackKeyGrant` with cache
- [ ] acceptance tests for ephemeral cache flow
- [ ] update prior acceptance tests to use `--unlock` pattern

---

## progress log

### 2026-02-06

- deleted incorrect KeyrackEphemeralCacheEntry domain object
- deleted incorrect daoKeyrackEphemeralCache dao
- corrected approach: os.direct IS the ephemeral cache, not a separate entity
- updated execution plan to reflect correct approach

### 2026-02-07

- updated `KeyrackGrantMechanismAdapter.translate` to return `{ value, expiresAt? }`
- updated all mechanism adapters to return new result shape
- updated `getKeyrackKeyGrant` to cache ephemeral tokens to os.direct when expiresAt is set
- all unit tests pass (39 mechanism adapter tests, 20 grant tests)
- all integration tests pass (17 os.direct vault tests)

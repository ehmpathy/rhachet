# roadmap: rhachet/keyrack

> checklist-style roadmap with ordered dependencies and behavioral acceptance criteria

---

## phase 0: foundation

**depends on:** none

**briefs to read:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — production patterns
- `3.2.distill.domain._.v1.i1.md` — domain objects

**checklist:**
- [ ] create `src/domain.objects/keyrack/` directory structure
- [ ] implement `KeyrackHostVault` literal type
- [ ] implement `KeyrackGrantMechanism` literal type
- [ ] implement `KeyrackGrantStatus` literal type
- [ ] implement `KeyrackKeySpec` domain literal
- [ ] implement `KeyrackRepoManifest` domain literal
- [ ] implement `KeyrackKeyHost` domain literal
- [ ] implement `KeyrackHostManifest` domain entity
- [ ] implement `KeyrackKeyGrant` domain literal
- [ ] implement `KeyrackGrantAttempt` discriminated union type

**verification:**
```sh
npm run test:types
npm run test:unit -- keyrack
```

**acceptance criteria:** domain objects compile and pass unit tests

---

## phase 1: dao layer

**depends on:** phase 0

**briefs to read:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — file upsert/findsert patterns
- `ref.package.domain-objects.[ref].md` — domain object persistence

**checklist:**
- [ ] implement `daoKeyrackHostManifest.get()` — read from `~/.rhachet/keyrack.manifest.json`
- [ ] implement `daoKeyrackHostManifest.set()` — write to `~/.rhachet/keyrack.manifest.json`
- [ ] implement `daoKeyrackRepoManifest.get()` — read from `@gitroot/.agent/keyrack.yml`
- [ ] add zod schema validation for yaml parse
- [ ] add findsert semantics to dao set operation

**verification:**
```sh
npm run test:unit -- daoKeyrack
npm run test:integration -- daoKeyrack
```

**acceptance criteria:**
- usecase.4: findsert semantics work (find-or-insert, no update on match)
- host manifest persists across sessions
- repo manifest reads yaml correctly

---

## phase 2: vault adapters

**depends on:** phase 0, phase 1

**briefs to read:**
- `3.1.research.access._.v1.i1.md` — vault access patterns
- `3.1.research.access._.v1.zoomin.linux.i1.md` — linux-specific vault access

**checklist:**
- [ ] implement `KeyrackHostVaultAdapter` interface
- [ ] implement `vaultAdapterOsDirect` — plaintext file storage
- [ ] implement `vaultAdapterOsSecure` — encrypted file storage via age
- [ ] implement `vaultAdapter1Password` — 1password cli integration
- [ ] implement `isUnlocked()` for each adapter
- [ ] implement `unlock()` for each adapter
- [ ] implement `get()` for each adapter
- [ ] implement `set()` for each adapter

**verification:**
```sh
npm run test:unit -- vaultAdapter
npm run test:integration -- vaultAdapter
```

**acceptance criteria:**
- usecase.11: vault setup guides user through credential storage
- usecase.3: unlock triggers vault-specific auth flow
- os.direct requires no unlock
- os.secure prompts for passphrase
- 1password triggers `op signin`

---

## phase 3: mechanism adapters

**depends on:** phase 0

**briefs to read:**
- `3.1.research.claims._.v1.i1.md` — credential claim patterns

**checklist:**
- [ ] implement `KeyrackGrantMechanismAdapter` interface
- [ ] implement `mechAdapterReplica` — passthrough with validation
- [ ] implement `mechAdapterGithubApp` — json blob → installation token
- [ ] implement `mechAdapterAwsSso` — sso profile → session credentials
- [ ] add validation: replica rejects long-lived token patterns
- [ ] add validation: github_app requires valid json with appId, privateKey, installationId
- [ ] add validation: aws_sso requires valid profile name

**verification:**
```sh
npm run test:unit -- mechAdapter
npm run test:integration -- mechAdapter
```

**acceptance criteria:**
- usecase.5: firewall blocks long-lived tokens when mechanism forbids
- replica validates value is not a long-lived token pattern
- github_app translates json to short-lived token
- aws_sso translates profile to session credentials

---

## phase 4: domain operations

**depends on:** phase 1, phase 2, phase 3

**briefs to read:**
- `3.2.distill.domain._.v1.i1.md` — domain operations spec
- `rule.require.input-context-pattern.md` — procedure patterns

**checklist:**
- [ ] implement `genKeyrackGrantContext()` — construct context for grant operations
- [ ] implement `genKeyrackHostContext()` — construct context for host operations
- [ ] implement `getKeyrackKeyGrant({ for: { repo } })` — grant all keys from manifest
- [ ] implement `getKeyrackKeyGrant({ for: { key } })` — grant specific key
- [ ] implement `setKeyrackKeyHost()` — configure storage for a key
- [ ] implement `unlockKeyrackVault()` — unlock vaults for repo or key
- [ ] add all-or-none semantics to repo grant
- [ ] add fix instructions to failure responses

**verification:**
```sh
npm run test:unit -- getKeyrackKeyGrant
npm run test:unit -- setKeyrackKeyHost
npm run test:unit -- unlockKeyrackVault
npm run test:integration -- keyrack
```

**acceptance criteria:**
- usecase.1: `get --for repo` grants all keys from manifest
- usecase.2: `get --key` grants specific key
- usecase.6: all-or-none — if any key fails, mount none
- usecase.7: fix instructions provided for failures

---

## phase 5: cli commands

**depends on:** phase 4

**briefs to read:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — command registration pattern
- `bin.dispatcher.pattern.md` — bun/jit routing

**checklist:**
- [ ] create `src/contract/cli/invokeKeyrack.ts`
- [ ] implement `keyrack get --for repo` command
- [ ] implement `keyrack get --key $key` command
- [ ] implement `keyrack set --key --mech --vault` command
- [ ] implement `keyrack unlock --for repo` command
- [ ] implement `keyrack unlock --key $key` command
- [ ] implement `keyrack list` command (optional)
- [ ] implement `keyrack del --key $key` command (optional)
- [ ] register `invokeKeyrack` in `invoke.ts`
- [ ] add short-circuit in `bin/rhx` for keyrack command

**verification:**
```sh
npm run build
npx rhx keyrack get --for repo
npx rhx keyrack get --key XAI_API_KEY
npx rhx keyrack set --key XAI_API_KEY --mech REPLICA --vault os.direct
npm run test:acceptance -- keyrack
```

**acceptance criteria:**
- usecase.10: human mode shows guidance for vault setup
- usecase.10: robot mode outputs json for automation
- usecase.12: list shows all keys on host
- usecase.13: del removes key from host manifest
- usecase.14: output format matches mode (human vs robot)

---

## phase 6: sdk surface

**depends on:** phase 4

**briefs to read:**
- `3.2.distill.domain._.v1.i1.md` — sdk surface spec

**checklist:**
- [ ] create `src/contract/sdk/keyrack.ts`
- [ ] export `keyrack.get({ for: { repo } })`
- [ ] export `keyrack.get({ for: { key } })`
- [ ] export `keyrack.set({ slug, mech, vault })`
- [ ] export `keyrack.unlock({ for: { repo } })`
- [ ] export `keyrack.unlock({ for: { key } })`
- [ ] add `exports["./keyrack"]` to package.json
- [ ] add barrel export for keyrack types

**verification:**
```sh
npm run build
npm run test:types
npm run test:acceptance -- keyrack.sdk
```

**acceptance criteria:**
- sdk can be imported via `import { keyrack } from 'rhachet/keyrack'`
- sdk surface matches cli surface
- types are exported for consumers

---

## phase 7: ci action

**depends on:** phase 5, phase 6

**briefs to read:**
- `3.1.research.references._.v1.i1.md` — ci action patterns

**checklist:**
- [ ] create github action for keyrack unlock
- [ ] add action input for key names
- [ ] add action input for vault type
- [ ] add action output for grant status
- [ ] document action usage in readme
- [ ] add example workflow

**verification:**
```sh
# test in ci environment
gh workflow run test-keyrack
```

**acceptance criteria:**
- usecase.8: ci action unlocks vault and grants keys
- action works in github actions environment
- action provides clear error messages on failure

---

## verification matrix

| usecase | phase | verification |
|---------|-------|--------------|
| 1. get --for repo | 4, 5 | `npx rhx keyrack get --for repo` |
| 2. get --key | 4, 5 | `npx rhx keyrack get --key XAI_API_KEY` |
| 3. unlock | 2, 4, 5 | `npx rhx keyrack unlock --for repo` |
| 4. findsert | 1, 4 | integration test: set twice, no update |
| 5. firewall | 3, 4 | unit test: replica rejects long-lived tokens |
| 6. all-or-none | 4 | integration test: partial failure → no grants |
| 7. fix instructions | 4 | unit test: failure includes fix message |
| 8. ci action | 7 | github actions workflow test |
| 9. credential lifetime | 2, 3 | unit test: grants are ephemeral |
| 10. human vs robot | 5 | acceptance test: output format differs by mode |
| 11. vault setup | 2, 5 | acceptance test: guided setup flow |
| 12. list | 5 | `npx rhx keyrack list` |
| 13. del | 5 | `npx rhx keyrack del --key XAI_API_KEY` |
| 14. output format | 5 | acceptance test: json vs human output |

---

## notes

- phases 2 and 3 can proceed in parallel after phase 0
- phase 4 requires all adapter phases complete
- phases 5 and 6 can proceed in parallel after phase 4
- phase 7 requires both cli and sdk complete

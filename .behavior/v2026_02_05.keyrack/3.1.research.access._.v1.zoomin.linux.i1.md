# research: linux secure storage — deep-dive for rhachet/keyrack

> zooms into section D of the parent research (3.1.research.access._.v1.i1.md) — linux-specific keyrack, encryption, and secret storage approaches on ubuntu

---

## overview

this document extends the parent research with a deep-dive into linux-specific secure storage mechanisms relevant to rhachet/keyrack's `os.direct` and `os.secure` vault backends.

note: `keyring` and `Keyring` appear throughout — these are proper nouns (GNOME Keyring, @napi-rs/keyring, keyring-rs) and not gerunds.

| # | topic | why it matters |
|---|-------|----------------|
| A | GNOME Keyring internals | the default secret service provider on ubuntu; backs `os.direct` |
| B | KDE Wallet | alternative provider; needed for KDE desktop users |
| C | d-bus secret service spec | the wire protocol that all providers implement |
| D | libsecret + secret-tool | the c library and cli that wrap the d-bus api |
| E | headless linux environments | ci, ssh, docker — where d-bus is absent |
| F | age encryption | candidate for `os.secure` vault encryption layer |
| G | other encryption approaches | gpg, openssl enc, luks, fscrypt — comparison |
| H | node.js access patterns | @napi-rs/keyring, keyring-rs backends, fallback strategies |
| I | ubuntu-specific details | default packages, pam config, snap/flatpak constraints |
| J | oo7-daemon | rust-based replacement for gnome-keyring-daemon |

---

## A. GNOME Keyring internals

### A.1 architecture

gnome-keyring-daemon is a per-user daemon that stores secrets in encrypted files and exposes them via d-bus. it runs three components: `ssh` (ssh-agent), `secrets` (secret service api), and `pkcs11`.

> "The gnome-keyring-daemon is a service that stores your passwords and secrets. It is normally started automatically when a user logs into a desktop session." — [1]

### A.2 pam integration

the pam module `pam_gnome_keyring.so` captures the login password during authentication and uses it to decrypt the login keyring. this enables auto-unlock without a separate prompt.

pam config (in `/etc/pam.d/gdm-password` or `/etc/pam.d/login`):
```
auth     optional  pam_gnome_keyring.so
session  optional  pam_gnome_keyring.so auto_start
```

> the `--unlock` flag causes the daemon to "read a password from stdin, and use it to unlock the login keyring or create it if the login keyring does not exist." — [1]

### A.3 encryption at rest

| property | value | source |
|----------|-------|--------|
| hash algorithm | SHA-256 | [2] |
| encryption algorithm | AES-128-CBC with PKCS#7 padding | [2] |
| key derivation | iterative password hashing, 1000-2000 iterations | [2] |

> "SHA-256 is used for hashing, and AES-128 is used for encrypting the secrets." — [2]

> "The keyring's master password is iteratively hashed. This result is used as a key to encrypt the keyring. The iterative application of the hash function uses a random number of iterations, between 1000 and 2000." — [2]

### A.4 file format

two formats exist:

| format | when | header |
|--------|------|--------|
| encrypted binary | keyring has a password (default) | begins with `GnomeKeyring\n\r` |
| textual plaintext | no password set (since v2.21.5) | gkeyfile/desktop file format |

keyrings are stored at: `~/.local/share/keyrings/`

> the keyring file format "enables future versions of the product to change algorithms" — [2]

### A.5 login.keyring vs default.keyring

- **login.keyring** — auto-unlocked at login via pam; the primary keyring
- **default.keyring** — the user-designated default for new passwords; often the same as login.keyring but can be configured separately

### A.6 lessons (A)

1. **gnome-keyring-daemon is the default on ubuntu** — it implements `org.freedesktop.secrets` and auto-starts at login
2. **pam enables zero-prompt unlock** — the login password is captured by `pam_gnome_keyring.so` and used to decrypt the login keyring
3. **encryption is AES-128-CBC with iterative password hashing** — adequate for local storage but not state-of-the-art kdf (1000-2000 iterations)
4. **file format is binary and opaque** — rhachet should not parse keyring files directly; always go through the d-bus api

### A.7 citations (A)

| # | document | url |
|---|----------|-----|
| [1] | ubuntu manpage: gnome-keyring-daemon | https://manpages.ubuntu.com/manpages/jammy/man1/gnome-keyring-daemon.1.html |
| [2] | gnome keyring security faq | https://wiki.gnome.org/Projects/GnomeKeyring/SecurityFAQ |
| [3] | arch wiki: GNOME Keyring | https://wiki.archlinux.org/title/GNOME/Keyring |

---

## B. KDE Wallet (KWallet)

### B.1 encryption

| property | value |
|----------|-------|
| default algorithm | Blowfish-CBC with SHA-1 auth |
| alternative | GPG backend (user chooses a gpg key) |
| pam + gpg | not compatible — pam requires blowfish mode |

> "The Blowfish symmetric block cipher algorithm in CBC mode. To protect the user's information, blowfish encrypted data is authenticated with the SHA-1 hashing algorithm." — [4]

### B.2 secret service compatibility

> "Since KDE Frameworks 5.97.0 KDE Wallet supports org.freedesktop.secrets DBus API and can now be used by libsecret for storing and retrieving passwords using the Secret Service API." — [4]

however: KWallet does not ship a d-bus `.service` file for `org.freedesktop.secrets` — users must create one manually to enable d-bus auto-activation.

### B.3 lessons (B)

5. **KWallet is the kde alternative** — supports the secret service api since KDE Frameworks 5.97.0
6. **KWallet uses Blowfish-CBC by default** — weaker than GNOME Keyring's AES-128-CBC
7. **d-bus auto-activation requires manual setup** — unlike gnome-keyring, KWallet does not ship a service file for `org.freedesktop.secrets`

### B.4 citations (B)

| # | document | url |
|---|----------|-----|
| [4] | arch wiki: KDE Wallet | https://wiki.archlinux.org/title/KDE_Wallet |

---

## C. d-bus secret service specification

### C.1 overview

the freedesktop.org secret service api is the standard protocol for client-server secret storage on linux. d-bus bus name: `org.freedesktop.secrets`.

> "The Secret Service API allows client applications to store secrets securely in a service running in the user's login session." — [5]

### C.2 data model

| concept | description |
|---------|-------------|
| collection | container for items (analogous to a keyring) |
| item | a secret + lookup attributes + label + timestamps |
| session | an encrypted channel between client and service |
| prompt | interactive user auth (for unlock, delete, etc) |

> "A group of items together form a collection. A collection is similar in concept to the terms 'keyring' or 'wallet'." — [5]

### C.3 session negotiation

two algorithms for secret transport:

| algorithm | encryption | notes |
|-----------|-----------|-------|
| `plain` | none | "almost always supported" — [6] |
| `dh-ietf1024-sha256-aes128-cbc-pkcs7` | DH key agreement + AES-128-CBC | prevents swap/cache leakage, not active attacks — [6] |

### C.4 the secret struct

```
struct Secret {
    ObjectPath session;      // d-bus session used for encoding
    Array<Byte> parameters;  // algorithm-specific data (e.g., AES IV)
    Array<Byte> value;       // the encoded/encrypted secret
    String content_type;     // mime type, e.g., "text/plain; charset=utf8"
}
```

### C.5 attribute-based lookup

items are identified by their set of attribute key-value pairs, NOT by name or label. the label is metadata for display only. attributes are stored **unencrypted** for efficient search.

### C.6 lessons (C)

8. **attributes are unencrypted** — only the secret value is encrypted; attribute keys and values are in plaintext on disk
9. **items are identified by attributes, not by name** — rhachet should use `service=rhachet` + `account=$keyName` as the attribute pair
10. **prompt handling is required** — unlock and delete operations may return a Prompt object that requires user interaction via d-bus signals

### C.7 citations (C)

| # | document | url |
|---|----------|-----|
| [5] | secret service api spec (latest) | https://specifications.freedesktop.org/secret-service/latest-single/ |
| [6] | secret service spec: transfer of secrets | https://specifications.freedesktop.org/secret-service/0.2/transfer-secrets.html |

---

## D. libsecret + secret-tool

### D.1 libsecret overview

> "Libsecret is a library for storing and retrieving passwords and other secrets that communicates with the 'Secret Service' using D-Bus." — [7]

> it is "designed from the ground up for Secret Service and D-Bus," and is "thread-safe, introspectable, and properly asynchronous." — [7]

### D.2 SecretSchema

a `SecretSchema` defines the attribute names and types for a class of secrets. schemas are **client-side only** — the secret service spec has no concept of schemas.

> "A SecretSchema represents a set of attributes stored with an item, used for interoperability between various services storing the same types of items." — [8]

### D.3 secret-tool cli

package: `libsecret-tools` on ubuntu/debian.

| subcommand | description |
|------------|-------------|
| `store --label='...' {attr} {val} ...` | stores a secret (reads value from stdin) |
| `lookup {attr} {val} ...` | retrieves a secret by attribute match |
| `clear {attr} {val} ...` | deletes all unlocked matching items |
| `search [--all] [--unlock] {attr} {val} ...` | searches for items, shows metadata |

> "When multiple matches exist, the first unlocked item is returned; locked items are automatically unlocked if necessary." — [9]

if an item with matching attributes already exists, `store` **updates** it rather than duplicating.

### D.4 error behavior

| condition | error message |
|-----------|---------------|
| no d-bus session, no X11 | `Cannot autolaunch D-Bus without X11 $DISPLAY` |
| d-bus exists, no provider | `GDBus.Error:org.freedesktop.DBus.Error.ServiceUnknown: The name org.freedesktop.secrets was not provided by any .service files` |

### D.5 fallback behavior

libsecret has **no built-in fallback**. if no d-bus session exists or no provider is registered at `org.freedesktop.secrets`, the library returns a `GError`. there is no automatic fallback to file-based storage.

### D.6 lessons (D)

11. **secret-tool uses attribute-based identification** — `store` and `lookup` both operate on attribute key-value pairs, not names
12. **store is idempotent** — if matching attributes exist, the item is updated rather than duplicated
13. **libsecret has no fallback** — if no secret service provider is available, operations fail; rhachet must handle this gracefully
14. **secret-tool reads from stdin** — passwords are piped in, not passed as arguments; this avoids process listing exposure

### D.7 citations (D)

| # | document | url |
|---|----------|-----|
| [7] | lwn.net: libsecret revealed | https://lwn.net/Articles/490518/ |
| [8] | gnome libsecret c examples | https://gnome.pages.gitlab.gnome.org/libsecret/libsecret-c-examples.html |
| [9] | debian manpages: secret-tool(1) | https://manpages.debian.org/testing/libsecret-tools/secret-tool.1.en.html |

---

## E. headless linux environments

### E.1 the problem

headless environments (ssh, docker, ci) lack a d-bus session bus. any application that tries to use the secret service api will fail.

> "Cannot autolaunch D-Bus without X11 $DISPLAY" — [10]

### E.2 workaround: dbus-run-session + gnome-keyring-daemon

```bash
# start a d-bus session
export $(dbus-launch)

# start and unlock gnome-keyring-daemon with empty password
echo -n "" | gnome-keyring-daemon --unlock --components=secrets

# now secret-tool works
echo -n "mypassword" | secret-tool store --label='CI Secret' service myapp key ci
secret-tool lookup service myapp key ci
```

or as a single subprocess:
```bash
dbus-run-session -- sh -c 'echo -n "" | gnome-keyring-daemon --unlock --components=secrets && secret-tool lookup service myapp key ci'
```

### E.3 kernel keyutils (via keyring-rs)

> "If you are trying to use keyring on a headless linux box, it's strongly recommended that you use the kernel keyutils credential store, because (as part of the kernel) it's designed to be used headlessly." — [11]

limitation: "The key management facility provided by the kernel is completely in-memory and will not persist across reboots." — [11]

### E.4 pass (password-store)

> "pass is a very simple password store that keeps passwords inside gpg2(1) encrypted files inside a simple directory tree residing at ~/.password-store." — [12]

key properties:
- each password is a gpg-encrypted file named after the resource
- "pass creates a git commit each time the password store is manipulated" — [12]
- **no d-bus dependency** — works anywhere gpg works, including headless servers and docker

### E.5 lessons (E)

15. **headless linux = no d-bus = no secret service** — ssh, docker, and ci environments cannot use gnome-keyring or kwallet without explicit setup
16. **dbus-run-session is the standard workaround** — starts a temporary d-bus session; can be combined with gnome-keyring-daemon --unlock
17. **kernel keyutils is in-memory only** — does not persist across reboots; suitable for session-scoped secrets only
18. **pass needs no d-bus** — gpg-based, works in any headless environment; but requires gpg key management

### E.6 citations (E)

| # | document | url |
|---|----------|-----|
| [10] | launchpad bug #1420914 | https://bugs.launchpad.net/ubuntu/+source/libsecret/+bug/1420914 |
| [11] | docs.rs: keyring::keyutils | https://docs.rs/keyring/latest/keyring/keyutils/index.html |
| [12] | passwordstore.org | https://www.passwordstore.org/ |

---

## F. age encryption

### F.1 what is age

age ("Actually Good Encryption") is a file encryption tool by Filippo Valsorda. v1.3.1 released december 2025. designed as a modern replacement for gpg file encryption.

> "A simple, modern and secure encryption tool, format, and Go library" with "small explicit keys, post-quantum support, no config options, and UNIX-style composability." — [13]

### F.2 passphrase mode (scrypt)

the most relevant mode for `os.secure`. parameters:

| parameter | value |
|-----------|-------|
| kdf | scrypt |
| N (cost factor) | 2^18 = 262,144 |
| r (block size) | 8 |
| p (parallelism) | 1 |
| dkLen (derived key length) | 32 bytes |
| salt prefix | `age-encryption.org/v1/scrypt` |
| file key encryption | ChaCha20-Poly1305 (nonce = 12 zero bytes) |

> "scrypt(N = work factor, r = 8, p = 1, dkLen = 32, S = 'age-encryption.org/v1/scrypt' || salt, P = passphrase)" — [14]

> "An scrypt stanza, if present, MUST be the only stanza in the header." — [14]

### F.3 payload encryption

| property | value |
|----------|-------|
| cipher | ChaCha20-Poly1305 (AEAD) |
| chunk size | 64 KiB |
| payload key derivation | HKDF-SHA-256(ikm = file_key, salt = nonce, info = "payload") |
| header MAC | HMAC-SHA-256 |

> file key: "16 bytes of CSPRNG output" that "MUST NOT be reused across multiple files." — [14]

### F.4 typescript library

the **official** TypeScript implementation is maintained by Valsorda himself: `age-encryption` on npm, from the `FiloSottile/typage` github repo.

```typescript
import { Encrypter, Decrypter } from "age-encryption"

// encrypt with passphrase
const e = new Encrypter()
e.setPassphrase("my-passphrase")
const ciphertext = await e.encrypt("secret data")

// decrypt
const d = new Decrypter()
d.addPassphrase("my-passphrase")
const plaintext = await d.decrypt(ciphertext, "text")
```

configurable scrypt work factor:
```typescript
e.setScryptWorkFactor(12)  // log2(N) = 12, so N = 4096 (faster, less secure)
```

compatible with Node.js 20+, Bun, Deno, and recent browsers.

> source: [15]

### F.5 installation on ubuntu

```bash
sudo apt install age     # ubuntu 22.04+ (jammy and later)
```

caveat: ubuntu freezes package versions at release time. for the latest version, use `go install filippo.io/age/cmd/...@latest` or download pre-built binaries from `https://dl.filippo.io/age/`.

### F.6 age vs gpg

| dimension | age | gpg |
|-----------|-----|-----|
| algorithm selection | opinionated: one per purpose | user-selectable: many options |
| key management | copy-pasteable single-line strings | complex: keyring, web of trust, subkeys |
| format | short auditable spec at C2SP (~20 pages) | OpenPGP RFC 4880 (100+ pages) |
| config | zero config options | hundreds of config options |
| attack surface | minimal — single code path | large — legacy algorithm support |

### F.7 lessons (F)

19. **age passphrase mode uses scrypt + ChaCha20-Poly1305** — correct cryptographic defaults with zero configuration
20. **official TypeScript library exists** — `age-encryption` on npm, maintained by the author; configurable work factor
21. **scrypt-only constraint simplifies security model** — passphrase encryption cannot be combined with public key recipients
22. **available via apt on ubuntu 22.04+** — `sudo apt install age`; also available as a single static binary

### F.8 citations (F)

| # | document | url |
|---|----------|-----|
| [13] | age github repository | https://github.com/FiloSottile/age |
| [14] | C2SP age specification | https://github.com/C2SP/C2SP/blob/main/age.md |
| [15] | typage (typescript implementation) | https://github.com/FiloSottile/typage |

---

## G. other encryption approaches

### G.1 gpg symmetric encryption

```bash
gpg2 -c -a --cipher-algo AES256 filename.txt     # encrypt
gpg2 -d -a --output decrypted.txt filename.gpg    # decrypt
```

> "A document can be encrypted with a symmetric cipher by using the --symmetric option. The key used to drive the symmetric cipher is derived from a passphrase supplied when the document is encrypted." — [16]

### G.2 openssl enc

```bash
openssl enc -aes-256-cbc -pbkdf2 -salt -in plain.txt -out encrypted.dat -k PASSWORD
openssl enc -d -aes-256-cbc -pbkdf2 -in encrypted.dat -out decrypted.txt -k PASSWORD
```

> "-pbkdf2: Use PBKDF2 algorithm with a default iteration count of 10000" — [17]

> "-salt option should ALWAYS be used if the key is being derived from a password" — [17]

limitation: authenticated encryption modes (CCM, GCM) are explicitly unsupported by `openssl enc`.

### G.3 luks/dm-crypt

> "dm-crypt is a disk encryption system using the kernel's crypto API framework and device mapper subsystem that can encrypt entire disks, logical volumes, partitions, and single files." — [18]

overkill for individual secrets but can create encrypted vault directories via loopback files.

### G.4 fscrypt

> "fscrypt is a tool for managing the native file encryption support of the ext4, F2FS, UBIFS, CephFS and Lustre file systems." — [19]

> "All file contents, filenames, and symlinks are encrypted." — [19]

limitation: "Encryption can only be enabled on an empty directory." — [19]

### G.5 lessons (G)

23. **gpg is ubiquitous but complex** — works everywhere, but requires key management and has many config options
24. **openssl enc lacks authenticated encryption** — no AEAD support; must use separate MAC or risk tampering
25. **luks and fscrypt are overkill for per-key encryption** — they operate at disk/directory level, not per-secret level
26. **age is the simplest correct choice** — AEAD by default, zero config, standardized format, TypeScript library

### G.6 citations (G)

| # | document | url |
|---|----------|-----|
| [16] | gnupg handbook: encrypting and decrypting | https://www.gnupg.org/gph/en/manual/x110.html |
| [17] | openssl 3.3: openssl-enc | https://docs.openssl.org/3.3/man1/openssl-enc/ |
| [18] | arch wiki: dm-crypt | https://wiki.archlinux.org/title/Dm-crypt/Device_encryption |
| [19] | github: google/fscrypt | https://github.com/google/fscrypt |

---

## H. node.js access patterns on linux

### H.1 @napi-rs/keyring linux backend

on linux, keyring-rs (and therefore @napi-rs/keyring) uses the d-bus secret service as its default credential store. it communicates directly via d-bus (using the `zbus` rust crate), NOT through libsecret. this means **no `libsecret-1-dev` dependency** — unlike the archived keytar.

### H.2 keyring-rs backends

| backend | description | persistence | d-bus required |
|---------|-------------|-------------|----------------|
| secret-service (default) | d-bus secret service api | yes (disk) | yes |
| keyutils | linux kernel keyring | no (in-memory only) | no |
| combo | both together | partial | partial |

> build-time feature flags: `--features linux-default-keyutils` makes keyutils the default for headless environments — [20]

### H.3 keytar (archived) vs @napi-rs/keyring

| aspect | keytar | @napi-rs/keyring |
|--------|--------|------------------|
| status | archived dec 15, 2022 | active |
| native dependency | `libsecret-1-dev` required | none — rust-native d-bus |
| build system | node-gyp (c++) | napi-rs (rust, prebuilt binaries) |
| headless linux | fails without d-bus | same d-bus requirement (but keyring-rs offers keyutils fallback) |

> "100% compatible node-keytar alternative." — [21]

### H.4 fallback strategy for rhachet

1. **prefer native secret service** via `@napi-rs/keyring` when d-bus + gnome-keyring is available
2. **detect availability** by checking `DBUS_SESSION_BUS_ADDRESS` and/or attempt a test operation
3. **fall back to encrypted file** via age passphrase encryption if no secret service is available
4. **never fall back silently** — report the status and guide the user to set up their vault

### H.5 lessons (H)

27. **@napi-rs/keyring has no native c dependency** — uses rust-native d-bus access; no `libsecret-1-dev` needed
28. **keyutils is the headless fallback in keyring-rs** — but it is in-memory only and does not persist
29. **detection first, then fallback** — check for d-bus before attempting secret service operations
30. **age passphrase encryption is the file-based fallback** — when no secret service is available

### H.6 citations (H)

| # | document | url |
|---|----------|-----|
| [20] | docs.rs: keyring crate | https://docs.rs/crate/keyring/latest |
| [21] | @napi-rs/keyring github | https://github.com/Brooooooklyn/keyring-node |

---

## I. ubuntu-specific details

### I.1 default packages on ubuntu 22.04/24.04

ubuntu ships with GNOME as the default desktop and pre-installs:
- `gnome-keyring` — the daemon
- `libpam-gnome-keyring` — pam module for auto-unlock
- `seahorse` — gui manager ("Passwords and Keys")
- `libsecret-tools` — provides `secret-tool` cli

pam configuration is pre-installed in `/etc/pam.d/gdm-password`.

### I.2 snap considerations

> "The `password-manager-service` interface provides access to the global password manager services provided by popular desktop environments." — [22]

this interface has `Auto-connect: no` — it must be manually connected:
```bash
snap connect <snap-name>:password-manager-service
```

without this, snap applications are denied access to the keyring by AppArmor policy.

### I.3 flatpak considerations

> "Flatpak apps' access to the session bus is restricted via xdg-dbus-proxy, and the sandboxed application is therefore unable to use the libsecret D-Bus API" directly. — [23]

flatpak uses the **XDG Desktop Portal Secret** interface (`org.freedesktop.portal.Secret`) instead. the portal provides a per-application secret that is "unique per application and does not change as long as the application is installed." — [23]

### I.4 lessons (I)

31. **ubuntu pre-installs everything needed** — gnome-keyring, pam module, libsecret-tools are all present by default on ubuntu 22.04+
32. **snap apps need manual interface connection** — `password-manager-service` does not auto-connect
33. **flatpak uses a portal, not direct d-bus** — sandboxed apps get a per-app secret via xdg-desktop-portal

### I.5 citations (I)

| # | document | url |
|---|----------|-----|
| [22] | snapcraft docs: password-manager-service interface | https://snapcraft.io/docs/password-manager-service-interface |
| [23] | xdg desktop portal: secret | https://flatpak.github.io/xdg-desktop-portal/docs/doc-org.freedesktop.portal.Secret.html |

---

## J. oo7-daemon (future replacement)

### J.1 what it is

oo7 is a rust-based replacement for gnome-keyring-daemon. it implements the same `org.freedesktop.secrets` d-bus interface.

> "Applications using the freedesktop secrets DBus interface would require 0 changes" when migrating. — [24]

### J.2 key differences from gnome-keyring-daemon

| property | gnome-keyring-daemon | oo7-daemon |
|----------|---------------------|------------|
| language | C | Rust |
| keyring format | V0 (encrypts whole keyring) | V1 (encrypts individual items) |
| pam support | yes | yes (merged) |
| migration | n/a | automatic from V0 files |

> "A key difference with gnome-keyring-daemon is that oo7-daemon uses the V1 (used by libsecret when the app is sandboxed) of the keyring file format instead of V0. The main difference between both is that v0 encrypts the whole keyring and v1 encrypts individual items." — [24]

### J.3 lessons (J)

34. **oo7 is a drop-in replacement** — same d-bus interface, automatic migration from gnome-keyring files
35. **V1 format encrypts per-item** — better granularity than V0 (whole-keyring encryption)
36. **no impact on rhachet** — since rhachet uses the d-bus api (not file format), oo7 works transparently

### J.4 citations (J)

| # | document | url |
|---|----------|-----|
| [24] | github: bilelmoussaoui/oo7 | https://github.com/bilelmoussaoui/oo7 |

---

## summary of all lessons

| # | lesson | section |
|---|--------|---------|
| 1 | gnome-keyring-daemon is the default on ubuntu | A |
| 2 | pam enables zero-prompt unlock | A |
| 3 | encryption is AES-128-CBC with iterative password hashing (1000-2000 iterations) | A |
| 4 | file format is binary and opaque — always use d-bus api | A |
| 5 | KWallet is the kde alternative — supports secret service since KDE Frameworks 5.97.0 | B |
| 6 | KWallet uses Blowfish-CBC by default — weaker than GNOME Keyring | B |
| 7 | KWallet d-bus auto-activation requires manual setup | B |
| 8 | attributes are unencrypted — only secret values are encrypted | C |
| 9 | items are identified by attributes, not by name | C |
| 10 | prompt handling is required for unlock/delete operations | C |
| 11 | secret-tool uses attribute-based identification | D |
| 12 | store is idempotent — updates if attributes match | D |
| 13 | libsecret has no fallback — fails when no provider is available | D |
| 14 | secret-tool reads from stdin — avoids process listing exposure | D |
| 15 | headless linux = no d-bus = no secret service | E |
| 16 | dbus-run-session is the standard workaround for headless | E |
| 17 | kernel keyutils is in-memory only — does not persist across reboots | E |
| 18 | pass needs no d-bus — gpg-based, works anywhere | E |
| 19 | age passphrase mode uses scrypt + ChaCha20-Poly1305 | F |
| 20 | official TypeScript library exists — `age-encryption` on npm | F |
| 21 | scrypt-only constraint simplifies security model | F |
| 22 | available via apt on ubuntu 22.04+ | F |
| 23 | gpg is ubiquitous but complex | G |
| 24 | openssl enc lacks authenticated encryption | G |
| 25 | luks and fscrypt are overkill for per-key encryption | G |
| 26 | age is the simplest correct choice for file-based encryption | G |
| 27 | @napi-rs/keyring has no native c dependency | H |
| 28 | keyutils is the headless fallback in keyring-rs (in-memory only) | H |
| 29 | detection first, then fallback — check for d-bus before secret service ops | H |
| 30 | age passphrase encryption is the file-based fallback | H |
| 31 | ubuntu pre-installs everything needed for d-bus secret service | I |
| 32 | snap apps need manual interface connection for keyring access | I |
| 33 | flatpak uses a portal, not direct d-bus | I |
| 34 | oo7 is a drop-in replacement for gnome-keyring-daemon | J |
| 35 | V1 format encrypts per-item (better granularity) | J |
| 36 | no impact on rhachet — oo7 works transparently via d-bus | J |

---

## design implications for rhachet/keyrack

### `os.direct` vault → `@napi-rs/keyring` (d-bus secret service)

- use `@napi-rs/keyring` with `service=rhachet`, `account=$keyName`
- no additional encryption needed — the os keyrack provides adequate protection for logged-in users
- detect d-bus availability before attempting operations; fail fast with clear guidance if absent

### `os.secure` vault → age passphrase encryption

- use the `age-encryption` npm library for passphrase-based file encryption
- encrypted files stored at `~/.rhachet/keyrack.secure.$hashOfKeyName.age`
- the unlock passphrase is consumed and discarded — never retained by rhachet
- scrypt work factor provides time-based resistance to brute force
- configurable work factor via `setScryptWorkFactor()` for test environments

### headless/ci environments

- detect via `DBUS_SESSION_BUS_ADDRESS` environment variable
- if absent, skip d-bus-based vaults and report clear guidance
- `os.secure` (age-based) works everywhere — no d-bus dependency
- `1password` vault works via service account token — no d-bus dependency

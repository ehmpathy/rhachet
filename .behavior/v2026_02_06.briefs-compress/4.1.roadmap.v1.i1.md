# roadmap: briefs compression

## phase 0: test fixtures

**prereqs:** read before start:
- `.behavior/v2026_02_06.briefs-compress/3.3.blueprint.v1.i1.md` (fixture specs)
- `.behavior/v2026_02_06.briefs-compress/3.1.research.patterns._.code.test.v1.i1.md` (fixture patterns)

**goal:** create the 3 fixture directories that all later test phases depend on.

- [ ] create `accept.blackbox/.test/assets/with-min-briefs/`
  - [ ] `.agent/repo=.this/role=any/briefs/sample.md` (~200 chars, verbose prose)
  - [ ] `.agent/repo=.this/role=any/briefs/sample.md.min` (~100 chars, telegraphic)
  - [ ] `.agent/repo=.this/role=any/readme.md`
  - [ ] `rhachet.use.ts`
- [ ] create `accept.blackbox/.test/assets/with-orphan-min/`
  - [ ] `.agent/repo=.this/role=any/briefs/orphan.md.min` (no `.md` source)
  - [ ] `.agent/repo=.this/role=any/readme.md`
  - [ ] `rhachet.use.ts`
- [ ] create `accept.blackbox/.test/assets/with-mixed-min/`
  - [ ] `.agent/repo=.this/role=any/briefs/compressed.md` + `compressed.md.min`
  - [ ] `.agent/repo=.this/role=any/briefs/plain.md` (no `.min`)
  - [ ] `.agent/repo=.this/role=any/readme.md`
  - [ ] `rhachet.use.ts`
- [ ] add `'with-min-briefs' | 'with-orphan-min' | 'with-mixed-min'` to `TestRepoFixture` type in `genTestTempRepo.ts`

**verify:** `npm run test:types` passes with the new fixture type names.

---

## phase 1: `getRoleBriefRefs`

**prereqs:** phase 0 complete. read before start:
- `.behavior/v2026_02_06.briefs-compress/3.3.blueprint.v1.i1.md` (contract spec)
- `.behavior/v2026_02_06.briefs-compress/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)

**goal:** implement the `.min` preference logic as a standalone, unit-tested procedure.

- [ ] create `src/domain.operations/role/briefs/getRoleBriefRefs.ts`
  - [ ] accept `{ briefFiles: string[]; briefsDir: string }`
  - [ ] return `{ refs: RoleBriefRef[]; orphans: Array<Omit<RoleBriefRef, 'pathToOriginal'>> }`
  - [ ] partition input into `.md` files and `.md.min` files
  - [ ] for each `.md` file: check if `${file}.min` counterpart is in the set
  - [ ] for each `.md.min` file: check if `.md` source is in the set
  - [ ] return refs list + orphans list
- [ ] create `src/domain.operations/role/briefs/getRoleBriefRefs.test.ts`
  - [ ] case: all `.md`, no `.md.min` — refs use `.md` as `pathToOriginal`, `pathToMinified: null`
  - [ ] case: all `.md` with `.md.min` counterparts — refs use `.md` as `pathToOriginal`, `.md.min` as `pathToMinified`
  - [ ] case: mixed (some with `.md.min`, some without) — correct preference per file
  - [ ] case: orphan `.md.min` (no `.md` source) — orphans list populated
  - [ ] case: mixed with orphan — both refs and orphans populated
  - [ ] case: empty input — empty refs, empty orphans

**verify:** `npm run test:unit -- getRoleBriefRefs` — all 6 cases pass.

---

## phase 2: `assertZeroOrphanMinifiedBriefs`

**prereqs:** phase 0 complete (independent of phase 1). read before start:
- `.behavior/v2026_02_06.briefs-compress/3.3.blueprint.v1.i1.md` (contract spec)

**goal:** implement the orphan failfast as a standalone, unit-tested procedure.

- [ ] create `src/domain.operations/role/briefs/assertZeroOrphanMinifiedBriefs.ts`
  - [ ] accept `{ orphans: Array<Omit<RoleBriefRef, 'pathToOriginal'>> }`
  - [ ] if empty — no-op (return)
  - [ ] if non-empty — throw error that names each orphan file
- [ ] create `src/domain.operations/role/briefs/assertZeroOrphanMinifiedBriefs.test.ts`
  - [ ] case: no orphans — no throw
  - [ ] case: one orphan — throws with orphan file name in message
  - [ ] case: two orphans — throws with both file names in message

**verify:** `npm run test:unit -- assertZeroOrphanMinifiedBriefs` — all 3 cases pass.

---

## phase 3: integrate into `bootRoleResources`

**prereqs:** phases 1 and 2 complete. read before start:
- `.behavior/v2026_02_06.briefs-compress/3.3.blueprint.v1.i1.md` (insertion points)
- `.behavior/v2026_02_06.briefs-compress/3.1.research.patterns._.code.prod.v1.i1.md` (boot codepath)

**goal:** wire `getRoleBriefRefs` and `assertZeroOrphanMinifiedBriefs` into the boot loader.

- [ ] update `src/domain.operations/invoke/bootRoleResources.ts`
  - [ ] after blocklist filter (line 53): call `getRoleBriefRefs({ briefFiles, briefsDir })`
  - [ ] call `assertZeroOrphanMinifiedBriefs({ orphans })` after getRoleBriefRefs
  - [ ] exclude `.md.min` files from raw briefFiles (they participate via preference map only)
  - [ ] in stats calc loop: use `ref.pathToMinified ?? ref.pathToOriginal` for `readFileSync`
  - [ ] in print loop: use `ref.pathToOriginal` for tag path, `ref.pathToMinified ?? ref.pathToOriginal` for content
  - [ ] brief count in stats = refs.length (not raw file count)

**verify:** `npm run test:types` passes. prior tests still pass: `npm run test:unit` and `npm run test:acceptance -- roles.boot`.

---

## phase 4: integrate into `getRoleFileCosts`

**prereqs:** phases 1 and 2 complete. read before start:
- `.behavior/v2026_02_06.briefs-compress/3.3.blueprint.v1.i1.md` (cost codepath)
- `.behavior/v2026_02_06.briefs-compress/3.1.research.patterns._.code.prod.v1.i1.md` (cost patterns)

**goal:** wire `.min` preference into the cost calculator so costs reflect what boot actually loads.

- [ ] update `src/domain.operations/role/getRoleFileCosts.ts`
  - [ ] add blocklist filter for brief files (same as boot)
  - [ ] call `getRoleBriefRefs` on filtered brief files
  - [ ] call `assertZeroOrphanMinifiedBriefs` on orphans
  - [ ] use `ref.pathToMinified ?? ref.pathToOriginal` for content read
  - [ ] use `ref.pathToOriginal` for relativePath

**verify:** `npm run test:types` passes. `npm run test:unit -- getRoleFileCosts` passes.

---

## phase 5: integrate into `invokeRepoIntrospect`

**prereqs:** phases 1 and 2 complete. read before start:
- `.behavior/v2026_02_06.briefs-compress/3.3.blueprint.v1.i1.md` (introspect codepath)
- `.behavior/v2026_02_06.briefs-compress/3.1.research.patterns._.code.prod.v1.i1.md` (introspect patterns)

**goal:** add orphan `.min` validation to the introspect command.

- [ ] update `src/contract/cli/invokeRepoIntrospect.ts`
  - [ ] after manifest generation: for each role in registry
  - [ ] resolve briefs directory from the role's source path
  - [ ] scan with `getAllFilesFromDir`, filter to briefs dir
  - [ ] call `getRoleBriefRefs` to detect orphans
  - [ ] call `assertZeroOrphanMinifiedBriefs` to failfast

**verify:** `npm run test:types` passes. prior introspect tests still pass.

---

## phase 6: acceptance tests

**prereqs:** phases 3, 4, 5 complete. read before start:
- `.behavior/v2026_02_06.briefs-compress/2.1.criteria.blackbox.md` (blackbox criteria)
- `.behavior/v2026_02_06.briefs-compress/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)

**goal:** prove all blackbox behaviors via acceptance tests.

- [ ] extend `accept.blackbox/cli/roles.boot.acceptance.test.ts`
  - [ ] `given('[caseN] repo with compressed briefs')`
    - [ ] then: loads content from `.min` file
    - [ ] then: uses `.md` path in `<brief>` tag (not `.min` path)
    - [ ] then: brief count reflects only `.md` files (not `.min`)
    - [ ] then: token count reflects compressed content
  - [ ] `given('[caseN+1] repo with orphan .md.min')`
    - [ ] then: exits with non-zero status
    - [ ] then: stderr names the orphan file
  - [ ] `given('[caseN+2] repo with mixed compression')`
    - [ ] then: loads `.min` content for briefs that have `.min`
    - [ ] then: loads `.md` content for briefs that lack `.min`
    - [ ] then: total token count is less than all-`.md` load
- [ ] extend `accept.blackbox/cli/repo.introspect.acceptance.test.ts`
  - [ ] `given('[caseN] roles package with orphan .md.min')`
    - [ ] then: exits with non-zero status
    - [ ] then: stderr names the orphan file

**verify:** `npm run test:acceptance -- roles.boot` — all new cases pass. `npm run test:acceptance -- repo.introspect` — orphan case passes.

---

## phase 7: full regression

**prereqs:** phase 6 complete.

**goal:** confirm zero regression across the full test suite.

- [ ] `npm run test:types`
- [ ] `npm run test:lint`
- [ ] `npm run test:unit`
- [ ] `npm run test:acceptance`

**verify:** all green. no prior test degraded.

---

## dependency graph

```
phase 0 (fixtures)
  ├── phase 1 (getRoleBriefRefs)
  ├── phase 2 (assertZeroOrphanMinifiedBriefs)
  │
  ├── phase 3 (boot integration)         ← depends on 1 + 2
  ├── phase 4 (cost integration)          ← depends on 1 + 2
  ├── phase 5 (introspect integration)    ← depends on 1 + 2
  │
  └── phase 6 (acceptance tests)          ← depends on 3 + 4 + 5
        └── phase 7 (full regression)     ← depends on 6
```

phases 1 and 2 can run in parallel.
phases 3, 4, and 5 can run in parallel (after 1 + 2).

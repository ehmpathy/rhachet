# roadmap: boot.yml for role context curation

## overview

this roadmap provides a checklist for boot.yml implementation, with ordered dependencies and behavioral verification at each step.

---

## phase 0: preparation

### prereqs
- [ ] read `.behavior/v2026_02_08.boot-yml/3.3.blueprint.v1.i1.md` (blueprint)
- [ ] read `.behavior/v2026_02_08.boot-yml/1.vision.md` (vision)

### verification
- [ ] understand the two modes: simple vs subject
- [ ] understand say vs ref semantics
- [ ] understand overlap dedupe and say-wins-over-ref precedence

---

## phase 1: domain objects

### prereqs
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.domain._.v1.i1.md` (domain research)
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)

### tasks

- [ ] **1.1** create `src/domain.objects/RoleBootSpec.ts`
  - [ ] define `schemaResourceCuration` (zod schema for say/ref arrays)
  - [ ] define `schemaRoleBootSpecSimplified` (simple mode schema)
  - [ ] define `schemaSubjectSection` (subject section schema)
  - [ ] define `schemaRoleBootSpecSubjected` (subject mode schema with catchall)
  - [ ] define `RoleBootSpecSimplified` interface and class
  - [ ] define `RoleBootSpecSubjected` interface and class
  - [ ] define `RoleBootSpec` discriminated union type

- [ ] **1.2** create `src/domain.objects/RoleBootSpec.test.ts`
  - [ ] test simple mode schema validation (valid cases)
  - [ ] test simple mode schema validation (invalid cases)
  - [ ] test subject mode schema validation (valid cases)
  - [ ] test subject mode schema validation (invalid cases)

- [ ] **1.3** extend `src/domain.objects/RoleManifest.ts`
  - [ ] add optional `boot?: { uri: string }` field

### verification
```sh
npm run test:unit -- RoleBootSpec.test.ts
npm run test:types
```
- [ ] all unit tests pass
- [ ] no type errors

---

## phase 2: domain operations — parse and detect

### prereqs
- [ ] phase 1 complete
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)

### tasks

- [ ] **2.1** create `src/domain.operations/boot/computeBootMode.ts`
  - [ ] detect simple mode (briefs/skills keys)
  - [ ] detect subject mode (always/subject.* keys)
  - [ ] detect none mode (empty or no relevant keys)
  - [ ] fail fast on mixed mode with BadRequestError

- [ ] **2.2** create `src/domain.operations/boot/computeBootMode.test.ts`
  - [ ] test simple mode detection
  - [ ] test subject mode detection
  - [ ] test none mode detection
  - [ ] test mixed mode throws error

- [ ] **2.3** create `src/domain.operations/boot/parseRoleBootYaml.ts`
  - [ ] parse yaml content
  - [ ] call computeBootMode
  - [ ] validate against appropriate zod schema
  - [ ] return typed RoleBootSpec

- [ ] **2.4** create `src/domain.operations/boot/parseRoleBootYaml.test.ts`
  - [ ] test valid simple mode yaml
  - [ ] test valid subject mode yaml
  - [ ] test invalid yaml syntax
  - [ ] test invalid schema

### verification
```sh
npm run test:unit -- computeBootMode.test.ts
npm run test:unit -- parseRoleBootYaml.test.ts
npm run test:types
```
- [ ] all unit tests pass
- [ ] no type errors

---

## phase 3: domain operations — glob filter and plan

### prereqs
- [ ] phase 2 complete

### tasks

- [ ] **3.1** create `src/domain.operations/boot/filterBootResourcesByGlob.ts`
  - [ ] accept paths array, globs array, cwd
  - [ ] use fast-glob to match patterns
  - [ ] return filtered paths that match any glob

- [ ] **3.2** create `src/domain.operations/boot/filterBootResourcesByGlob.test.ts`
  - [ ] test single glob pattern
  - [ ] test multiple glob patterns
  - [ ] test recursive glob (**/*)
  - [ ] test no matches returns empty

- [ ] **3.3** create `src/domain.operations/boot/computeBootPlan.ts`
  - [ ] handle null config (say all — backwards compat)
  - [ ] implement `computeSimpleModePlan`
    - [ ] if say list present: matched = say, unmatched = ref
    - [ ] if say list absent: all = say
  - [ ] implement `computeSubjectModePlan`
    - [ ] process always section first
    - [ ] process selected subjects (or all if no --usecase)
    - [ ] handle overlap dedupe (first says, others ref with note)
    - [ ] handle say-wins-over-ref precedence
    - [ ] compute also section (unmatched resources)

- [ ] **3.4** create `src/domain.operations/boot/computeBootPlan.test.ts`
  - [ ] test null config (say all)
  - [ ] test simple mode with say list
  - [ ] test simple mode with empty say list
  - [ ] test simple mode with absent resource key
  - [ ] test subject mode boot all
  - [ ] test subject mode boot single subject
  - [ ] test subject mode boot multiple subjects
  - [ ] test subject mode overlap dedupe
  - [ ] test subject mode say-wins-over-ref
  - [ ] test subject mode also section
  - [ ] test subject mode with absent always

### verification
```sh
npm run test:unit -- filterBootResourcesByGlob.test.ts
npm run test:unit -- computeBootPlan.test.ts
npm run test:types
```
- [ ] all unit tests pass
- [ ] no type errors

---

## phase 4: integration — bootRoleResources

### prereqs
- [ ] phase 3 complete
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)

### tasks

- [ ] **4.1** extend `src/domain.operations/invoke/bootRoleResources.ts`
  - [ ] check for boot.yml in role directory
  - [ ] parse boot.yml if present (parseRoleBootYaml)
  - [ ] compute boot plan (computeBootPlan)
  - [ ] output say resources with full content
  - [ ] output ref resources with path only (`<ref path="..."/>`)
  - [ ] output also section wrapped in `<also>...</also>`
  - [ ] update stats to show say/ref breakdown

- [ ] **4.2** create `src/domain.operations/invoke/bootRoleResources.integration.test.ts`
  - [ ] test no boot.yml (say all)
  - [ ] test simple mode with say list
  - [ ] test subject mode boot all
  - [ ] test output format (say vs ref tags)

### verification
```sh
npm run test:integration -- bootRoleResources.integration.test.ts
npm run test:types
```
- [ ] all integration tests pass
- [ ] no type errors

---

## phase 5: cli — usecase option

### prereqs
- [ ] phase 4 complete

### tasks

- [ ] **5.1** extend `src/contract/cli/invokeRolesBoot.ts`
  - [ ] add `--usecase <subjects>` option
  - [ ] parse comma-separated subjects
  - [ ] validate usecase only valid in subject mode
  - [ ] pass usecases to bootRoleResources

### verification
```sh
npm run build
npx tsx ./bin/run roles boot --help
```
- [ ] `--usecase` option appears in help
- [ ] build succeeds

---

## phase 6: test fixtures

### prereqs
- [ ] phase 5 complete
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)

### tasks

- [ ] **6.1** create `accept.blackbox/.test/assets/with-boot-yaml-simple/`
  - [ ] rhachet.use.ts
  - [ ] .agent/repo=.this/role=any/readme.md
  - [ ] .agent/repo=.this/role=any/boot.yml (simple mode)
  - [ ] .agent/repo=.this/role=any/briefs/ (always-say.md, not-matched.md, subdir/deep.md)
  - [ ] .agent/repo=.this/role=any/skills/ (say-me.sh, ref-me.sh)

- [ ] **6.2** create `accept.blackbox/.test/assets/with-boot-yaml-subject/`
  - [ ] rhachet.use.ts
  - [ ] .agent/repo=.this/role=any/readme.md
  - [ ] .agent/repo=.this/role=any/boot.yml (subject mode with always)
  - [ ] .agent/repo=.this/role=any/briefs/ (core.md, glossary.md, shared.md, precedence.md, test-rules.md, prod-rules.md, misc.md)
  - [ ] .agent/repo=.this/role=any/skills/ (commit.sh, lint.sh, test-runner.sh, deploy.sh, shared-tool.sh, skill-precedence.sh, orphan-skill.sh)

- [ ] **6.3** create `accept.blackbox/.test/assets/with-boot-yaml-subject-no-always/`
  - [ ] rhachet.use.ts
  - [ ] .agent/repo=.this/role=any/readme.md
  - [ ] .agent/repo=.this/role=any/boot.yml (subject mode without always)
  - [ ] .agent/repo=.this/role=any/briefs/ (test-only.md, orphan.md)
  - [ ] .agent/repo=.this/role=any/skills/ (test-tool.sh)

- [ ] **6.4** create `accept.blackbox/.test/assets/with-boot-yaml-mixed/`
  - [ ] rhachet.use.ts
  - [ ] .agent/repo=.this/role=any/readme.md
  - [ ] .agent/repo=.this/role=any/boot.yml (invalid mixed mode)
  - [ ] .agent/repo=.this/role=any/briefs/ (sample.md)

- [ ] **6.5** update `accept.blackbox/.test/infra/genTestTempRepo.ts`
  - [ ] add fixture types to TestRepoFixture union

### verification
```sh
ls accept.blackbox/.test/assets/
```
- [ ] all 4 fixture directories exist with correct structure

---

## phase 7: acceptance tests

### prereqs
- [ ] phase 6 complete
- [ ] read `.behavior/v2026_02_08.boot-yml/2.1.criteria.blackbox.md` (blackbox criteria)
- [ ] read `.behavior/v2026_02_08.boot-yml/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)

### tasks

- [ ] **7.1** create `accept.blackbox/cli/roles.boot.bootyaml.acceptance.test.ts`

#### simple mode tests (cases 1-7)
- [ ] `[case1]` no boot.yml → all briefs/skills say
- [ ] `[case2]` briefs.say: [...] → matched briefs say, unmatched ref
- [ ] `[case3]` briefs.say: [] → all briefs ref
- [ ] `[case4]` skills.say: [...] → matched skills say, unmatched ref
- [ ] `[case5]` skills.say: [] → all skills ref
- [ ] `[case6]` briefs.say + skills absent → briefs curated, skills say all
- [ ] `[case7]` skills.say + briefs absent → skills curated, briefs say all

#### subject mode — briefs tests (cases 8-17)
- [ ] `[case8]` boot all subjects → always + all subjects + also
- [ ] `[case9]` boot single subject → always + test only, no prod, no also
- [ ] `[case10]` boot multiple subjects → always + test + prod, no also
- [ ] `[case11]` unknown subject → error "subject not found"
- [ ] `[case12]` briefs overlap dedupe (subject-subject)
- [ ] `[case13]` briefs overlap dedupe (always-subject)
- [ ] `[case14]` briefs say wins over ref
- [ ] `[case15]` always.briefs.ref → glossary.md appears as ref
- [ ] `[case16]` briefs also section → misc.md in `<also>`
- [ ] `[case17]` briefs also omitted → misc.md not in output

#### subject mode — skills tests (cases 18-25)
- [ ] `[case18]` always.skills.say → commit.sh say
- [ ] `[case19]` always.skills.ref → lint.sh appears as ref
- [ ] `[case20]` subject.test.skills.say → test-runner.sh say
- [ ] `[case21]` subject.prod.skills.say → deploy.sh say
- [ ] `[case22]` skills overlap dedupe (subject-subject)
- [ ] `[case23]` skills say wins over ref
- [ ] `[case24]` skills also section → orphan-skill.sh in `<also>`
- [ ] `[case25]` skills also omitted → orphan-skill.sh not in output

#### subject mode — always absent tests (cases 26-27)
- [ ] `[case26]` always section absent → no always, only subject + also
- [ ] `[case27]` always absent + single subject → only subject.test, no also

#### output structure tests (cases 28-33)
- [ ] `[case28]` say brief format → `<brief path="...">content</brief>`
- [ ] `[case29]` ref brief format → `<ref path="..."/>`
- [ ] `[case30]` say skill format → `<skill path="...">content</skill>`
- [ ] `[case31]` ref skill format → `<ref path="..."/>`
- [ ] `[case32]` also section format → `<also>...</also>`
- [ ] `[case33]` stats say/ref breakdown

#### error mode tests (cases 34-35)
- [ ] `[case34]` mixed mode → error "mixed mode not allowed"
- [ ] `[case35]` --usecase in simple mode → error "usecase requires subject mode"

### verification
```sh
npm run build && npm run test:acceptance:locally -- roles.boot.bootyaml.acceptance.test.ts
```
- [ ] all 35 acceptance tests pass

---

## phase 8: final verification

### prereqs
- [ ] all previous phases complete

### tasks

- [ ] **8.1** run full test suite
  ```sh
  npm run test:types
  npm run test:unit
  npm run test:integration
  npm run build && npm run test:acceptance:locally
  ```

- [ ] **8.2** manual smoke test
  ```sh
  # no boot.yml (backwards compat)
  npx tsx ./bin/run roles boot --repo .this --role any

  # simple mode
  # (requires a role with boot.yml in simple mode)

  # subject mode
  # (requires a role with boot.yml in subject mode)
  npx tsx ./bin/run roles boot --repo .this --role any --usecase test
  ```

- [ ] **8.3** verify stats output shows say/ref breakdown

### verification
- [ ] all tests pass
- [ ] manual smoke tests work as expected
- [ ] stats show say vs ref counts

---

## summary

| phase | description | verification |
|-------|-------------|--------------|
| 0 | preparation | understand vision and blueprint |
| 1 | domain objects | unit tests pass |
| 2 | parse and detect | unit tests pass |
| 3 | glob filter and plan | unit tests pass |
| 4 | bootRoleResources integration | integration tests pass |
| 5 | cli --usecase option | build succeeds |
| 6 | test fixtures | fixtures exist |
| 7 | acceptance tests | 35 acceptance tests pass |
| 8 | final verification | full suite green |

---

## dependencies graph

```
phase 0 (prep)
    │
    ▼
phase 1 (domain objects)
    │
    ▼
phase 2 (parse + detect)
    │
    ▼
phase 3 (glob + plan)
    │
    ▼
phase 4 (bootRoleResources)
    │
    ▼
phase 5 (cli --usecase)
    │
    ▼
phase 6 (test fixtures)
    │
    ▼
phase 7 (acceptance tests)
    │
    ▼
phase 8 (final verification)
```

all phases are sequential — each depends on the previous.

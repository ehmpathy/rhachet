# research.patterns.code.prod: boot.yml for role context curation

## pattern.1: cli entry point for roles boot

**location:** `src/contract/cli/invokeRolesBoot.ts:1-56`

**citation [1]:**
```typescript
export const invokeRolesBoot = ({ command }: { command: Command }): void => {
  command
    .command('boot')
    .description('boot context from role resources (briefs and skills)')
    .option('--repo <slug>', 'the repository slug for the role')
    .option('--role <slug>', 'the role to boot resources for')
    .option('--if-present', 'exit silently if role directory does not exist')
    .action(async (opts: { repo?: string; role?: string; ifPresent?: boolean }) => {
```

**relation to wish:** this is the entry point for `rhachet roles boot`. boot.yml will add new options (`--usecase`) and modify behavior based on config.

**action:** [EXTEND] — add `--usecase` option for subject mode, delegate to boot.yml-aware logic.

---

## pattern.2: boot role resources core logic

**location:** `src/domain.operations/invoke/bootRoleResources.ts:1-129`

**citation [2]:**
```typescript
// resolve role directory from .agent/ symlinks (lines 23-28)
const roleLinked = await findUniqueRoleDir({ repo: input.repo, role: input.role });

// discover files (lines 42-59)
const readmePath = path.join(roleLinked.path, 'readme.md');
const briefsDir = path.join(roleLinked.path, 'briefs');
const skillsDir = path.join(roleLinked.path, 'skills');
```

**citation [3]:**
```typescript
// block listed directories (lines 48-53)
const blockedDirs = ['.scratch', '.archive'];
const briefPaths = getAllFilesFromDir(briefsDir).filter(
  (p) => !blockedDirs.some((d) => p.includes(`/${d}/`)),
);
```

**citation [4]:**
```typescript
// output format (lines 110-125)
console.log(`<brief path="${relativePath}">`);
console.log(content);
console.log(`</brief>`);
```

**relation to wish:** this is the core boot logic. boot.yml modifies which briefs/skills are said vs ref.

**action:** [EXTEND] — add boot.yml parse, glob match for say/ref, output `<ref path="..."/>` for ref'd items.

---

## pattern.3: brief discovery with glob support

**location:** `src/domain.operations/role/getRoleBriefs.ts:97-121`

**citation [5]:**
```typescript
import glob from 'fast-glob';

const pathsMatched = await glob(input.by.briefs.glob, {
  cwd: roleLinked.pathBriefs,
  absolute: true,
  onlyFiles: true,
});
```

**relation to wish:** boot.yml uses glob patterns for `say:` and `ref:` lists.

**action:** [REUSE] — use same fast-glob pattern for match of briefs/skills against boot.yml globs.

---

## pattern.4: skill documentation extraction

**location:** `src/domain.operations/role/extractSkillDocumentation.ts:28-60`

**citation [6]:**
```typescript
export const extractSkillDocumentationFromContent = (content: string): string => {
  const lines = content.split('\n');
  const docLines: string[] = [];

  // extract shebang + lead comments
  for (const line of lines) {
    if (line.startsWith('#!') || line.startsWith('#') || line.trim() === '') {
      docLines.push(line);
    } else {
      break; // stop at first non-comment line
    }
  }

  // append hidden note
  docLines.push('\n# [implementation hidden - use skill to execute]');
  return docLines.join('\n');
};
```

**relation to wish:** skills in boot output show docs only, not implementation.

**action:** [REUSE] — same extraction for said skills; ref'd skills show path only.

---

## pattern.5: role manifest schema

**location:** `src/domain.objects/RoleManifest.ts:1-24`

**citation [7]:**
```typescript
interface RoleManifest {
  slug: string;
  readme: { uri: string };
  briefs: { dirs: { uri: string } | { uri: string }[] };
  skills: { dirs: { uri: string } | { uri: string }[] };
  inits?: {
    dirs?: { uri: string } | { uri: string }[];
    exec?: { cmd: string }[];
  };
}
```

**relation to wish:** boot.yml extends role config. may add `boot: { uri: string }` to manifest.

**action:** [EXTEND] — add optional `boot` field to RoleManifest for boot.yml path.

---

## pattern.6: yaml parse with zod validation

**location:** `src/domain.operations/manifest/getRoleRegistryManifest.ts:113-132`

**citation [8]:**
```typescript
import { parse as parseYaml } from 'yaml';

let parsed: unknown;
try {
  parsed = parseYaml(content);
} catch (error) {
  throw new BadRequestError('rhachet.repo.yml has invalid yaml', { ... });
}

// validate against zod schema
const result = schemaRoleRegistryManifestRaw.safeParse(parsed);
if (!result.success)
  throw new BadRequestError('rhachet.repo.yml has invalid schema', {
    errors: result.error.issues,
  });
```

**relation to wish:** boot.yml needs yaml parse + schema validation.

**action:** [REUSE] — same pattern for boot.yml: yaml parse → zod validate → typed config.

---

## pattern.7: recursive file discovery

**location:** `src/infra/filesystem/getAllFilesFromDir.ts:1-36`

**citation [9]:**
```typescript
export const getAllFilesFromDir = (dir: string): string[] => {
  const files: string[] = [];
  const entries = fs.readdirSync(dir, { withFileTypes: true });

  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory() || entry.isSymbolicLink()) {
      try {
        files.push(...getAllFilesFromDir(fullPath));
      } catch (error) {
        if ((error as NodeJS.ErrnoException).code !== 'ENOENT') throw error;
        // gracefully skip broken symlinks
      }
    } else {
      files.push(fullPath);
    }
  }
  return files;
};
```

**relation to wish:** discover all briefs/skills before match against boot.yml globs.

**action:** [REUSE] — use for full file enumeration, then filter via glob patterns.

---

## pattern.8: cost and token estimation

**location:** `src/domain.operations/invoke/bootRoleResources.ts:85-91`

**citation [10]:**
```typescript
// 4 chars ≈ 1 token, $3 per million tokens
const approxTokens = Math.ceil(totalChars / 4);
const costPerMillion = 3;
const cost = (approxTokens / 1_000_000) * costPerMillion;
```

**relation to wish:** boot.yml reduces token cost by ref instead of say.

**action:** [REUSE] — same cost model; stats should show said vs ref breakdown.

---

## pattern.9: output stats format

**location:** `src/domain.operations/invoke/bootRoleResources.ts:94-108`

**citation [11]:**
```typescript
console.log('<stats>');
console.log('quant');
console.log('  ├── files = ' + (briefPaths.length + skillPaths.length));
console.log('  │   ├── briefs = ' + briefPaths.length);
console.log('  │   └── skills = ' + skillPaths.length);
console.log('  ├── chars = ' + totalChars);
console.log('  └── tokens ≈ ' + approxTokens + ` ($${cost.toFixed(2)} at $${costPerMillion}/mil)`);
console.log('</stats>');
```

**relation to wish:** stats should reflect say/ref split for token savings visibility.

**action:** [EXTEND] — add said/ref breakdown to stats output.

---

## pattern.10: role directory resolution

**location:** `src/domain.operations/invoke/findUniqueRoleDir.ts:10-89`

**citation [12]:**
```typescript
// resolve from .agent/repo=$repo/role=$role structure
const agentDir = path.join(process.cwd(), '.agent');
const repoPattern = input.repo ? `repo=${input.repo}` : 'repo=*';
const rolePattern = input.role ? `role=${input.role}` : 'role=*';

const matches = glob.sync(`${repoPattern}/${rolePattern}`, {
  cwd: agentDir,
  onlyDirectories: true,
});
```

**relation to wish:** boot.yml lives alongside briefs/skills in role directory.

**action:** [REUSE] — same resolution; look for boot.yml in resolved role dir.

---

## summary

| pattern | location | action | rationale |
|---------|----------|--------|-----------|
| cli entry | invokeRolesBoot.ts | [EXTEND] | add --usecase option |
| boot logic | bootRoleResources.ts | [EXTEND] | add boot.yml-aware say/ref logic |
| glob match | getRoleBriefs.ts | [REUSE] | same fast-glob for boot.yml patterns |
| skill docs | extractSkillDocumentation.ts | [REUSE] | same extraction for said skills |
| manifest schema | RoleManifest.ts | [EXTEND] | add boot field |
| yaml + zod | getRoleRegistryManifest.ts | [REUSE] | same parse + validate pattern |
| file discovery | getAllFilesFromDir.ts | [REUSE] | enumerate before filter |
| cost model | bootRoleResources.ts | [REUSE] | same token estimation |
| stats output | bootRoleResources.ts | [EXTEND] | add said/ref breakdown |
| role resolution | findUniqueRoleDir.ts | [REUSE] | find boot.yml in role dir |

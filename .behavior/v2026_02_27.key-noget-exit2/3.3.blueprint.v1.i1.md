# blueprint: keyrack get exits non-zero when keys can't be fetched

## summary

add exit code 2 to `keyrack get` when keys are locked, absent, or blocked — enabling bash `if` patterns to work correctly.

## filediffs

```
src/
  contract/
    cli/
      [~] invokeKeyrack.ts                    # add process.exit(2) for non-granted

blackbox/
  cli/
    [~] keyrack.sudo.acceptance.test.ts       # update case17 to expect exit 2
    [~] keyrack.extends.acceptance.test.ts    # update cases 1-4, 8 to expect exit 2
```

## codepaths

```
invokeKeyrack
├─ keyrack get --for repo
│  ├─ [○] lookup keys from manifest
│  ├─ [○] attempt each key via daemon
│  ├─ [○] output json array of attempts
│  └─ [+] exit 2 if any key not granted          # NEW: lines 413-416
│
└─ keyrack get --key <name>
   ├─ [○] derive org from manifest
   ├─ [○] attempt key via daemon
   ├─ [○] output json with status
   └─ [+] exit 2 if key not granted               # NEW: lines 531-533
```

## contracts

### exit code semantics

| status  | exit code | meaning                          |
|---------|-----------|----------------------------------|
| granted | 0         | key fetched successfully         |
| locked  | 2         | key exists but vault is locked   |
| absent  | 2         | key not found in manifest        |
| blocked | 2         | key exists but blocked by policy |

exit 2 = "blocked by constraints" — unix convention for controlled failure.

### json output unchanged

the json output shape remains identical. only the exit code changes based on status.

## implementation details

### single key mode (`--key`)

```ts
// exit 2 if key was not granted (blocked by constraints)
if (attemptResolved.status !== 'granted') {
  process.exit(2);
}
```

### batch mode (`--for repo`)

```ts
// exit 2 if any key was not granted (blocked by constraints)
const allGranted = attempts.every((a) => a.status === 'granted');
if (!allGranted) {
  process.exit(2);
}
```

## test updates

tests that query locked keys now expect exit code 2:

| file | case | change |
|------|------|--------|
| `keyrack.sudo.acceptance.test.ts` | case17 | expect exit 2 for locked status |
| `keyrack.extends.acceptance.test.ts` | case1 | expect exit 2 for `--for repo` without unlock |
| `keyrack.extends.acceptance.test.ts` | case2 | expect exit 2 for `--for repo` without unlock |
| `keyrack.extends.acceptance.test.ts` | case3 t0 | expect exit 2 for `--for repo` without unlock |
| `keyrack.extends.acceptance.test.ts` | case3 t1 | expect exit 2 for `--for repo` without unlock |
| `keyrack.extends.acceptance.test.ts` | case4 | expect exit 2 for `--for repo` without unlock |
| `keyrack.extends.acceptance.test.ts` | case8 | expect exit 2 when other keys in repo are locked |

## verification

```bash
# single key - locked
$ npx rhachet keyrack get --key MY_TOKEN --json
# exit code: 2
# stdout: {"status": "locked", ...}

# batch - some locked
$ npx rhachet keyrack get --for repo --env prod --json
# exit code: 2
# stdout: [{...}, {...}]  # array with locked entries

# bash if pattern works
if result=$(npx rhachet keyrack get --key MY_TOKEN --json); then
  # only reached if granted
  token=$(echo "$result" | jq -r '.grant.value')
fi
```

## status

**implementation: complete**
- exit code logic added to `invokeKeyrack.ts`
- acceptance tests updated to expect exit 2 for locked keys
- tests pass locally

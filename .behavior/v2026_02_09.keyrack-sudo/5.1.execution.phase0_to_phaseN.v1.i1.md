# execution: keyrack sudo credentials

tracks progress for phases 0-9.

---

## phase 0: test infrastructure

**status**: complete ✓

**tasks**:
- [x] create `src/.test/assets/keyrack/ssh/test_key_ed25519` (committed test key, no passphrase)
- [x] create `src/.test/assets/keyrack/ssh/test_key_ed25519.pub`
- [x] create `src/.test/infra/withTestSshAgent.ts` — spawns isolated agent, loads test key
- [x] create `src/.test/infra/withTestHomeWithSshKey.ts` — temp HOME with test key in .ssh/
- [x] create tests for both helpers (15 tests pass)
- [x] export from `src/.test/infra/index.ts`

**notes**:
- `withTempHome.ts` already exists; new helper extends it for ssh key setup
- ssh agent cleanup test uses retry logic to wait for SIGTERM to complete

---

## phase 1: domain objects

**status**: complete ✓

**tasks**:
- [x] create `KeyrackKeyRecipient.ts` — new domain object for recipient keys (ssh, age, yubikey, passkey)
- [x] update `KeyrackHostManifest.ts` — add `owner: string | null`, `recipients: KeyrackKeyRecipient[]`
- [x] update `KeyrackKeyHost.ts` — add `env`, `org`, `vaultRecipient`, `maxDuration` fields
- [x] update `KeyrackKeyGrant.ts` — add `env`, `org` fields
- [x] update `daoKeyrackHostManifest/schema.ts` — add zod schemas with backwards compat defaults
- [x] update `daoKeyrackHostManifest/index.ts` — hydrate new fields from schema
- [x] update `genKeyrackHostContext.ts` — empty manifest includes owner, recipients
- [x] update `genKeyrackGrantContext.ts` — empty manifest includes owner, recipients
- [x] update `setKeyrackKeyHost.ts` — include new fields
- [x] update `getKeyrackKeyGrant.ts` — pass env, org to KeyrackKeyGrant for all 4 grant paths
- [x] update `.test/assets/genMockKeyrackHostManifest.ts` — sensible defaults for new fields
- [x] update test files with new required fields (daoKeyrackHostManifest, getKeyrackKeyGrant)
- [x] verify type check passes
- [x] verify unit tests pass (20 tests for getKeyrackKeyGrant)

**notes**:
- daemon SDK doesn't include env/org yet; fallback values used in os.daemon grant path
- schema uses `.optional().default()` for backwards compat with prior manifests

---

## phase 2: dao layer — encrypted host manifest

**status**: complete ✓

**tasks**:
- [x] create `src/domain.operations/keyrack/adapters/ageRecipientCrypto.ts` — age encryption/decryption helpers
- [x] create `src/domain.operations/keyrack/adapters/ageRecipientCrypto.test.ts` — 8 unit tests
- [x] create `src/domain.operations/keyrack/getKeyrackHostManifestPath.ts` — path helper for owner-specific manifest
- [x] create `src/domain.operations/keyrack/getKeyrackHostManifestPath.test.ts` — 4 unit tests
- [x] update `src/access/daos/daoKeyrackHostManifest/schema.ts` — add all vault types and mechanism types
- [x] update `src/access/daos/daoKeyrackHostManifest/index.ts` — age encryption with recipient keys, session identity
- [x] rewrite `src/access/daos/daoKeyrackHostManifest/index.integration.test.ts` — 18 tests for encrypted format
- [x] verify all unit tests pass (getKeyrackHostManifestPath: 4, ageRecipientCrypto: 8)
- [x] verify all integration tests pass (daoKeyrackHostManifest: 18)
- [x] verify type check passes

**notes**:
- uses `age-encryption` library with `Encrypter`/`Decrypter`, `generateIdentity`, `identityToRecipient`
- session identity via `setSessionIdentity()` or `KEYRACK_IDENTITY` env var
- multi-recipient encryption allows multiple keys to decrypt same manifest
- file permissions set to 0600 after write

---

## phase 3: path helpers

**status**: complete ✓

**tasks**:
- [x] `getKeyrackHostManifestPath.ts` — already created in phase 2
- [x] update `daemon/infra/getKeyrackDaemonSocketPath.ts` — add owner param
- [x] update `daemon/infra/getKeyrackDaemonSocketPath.test.ts` — add owner test cases (11 tests pass)
- [x] verify type check passes

**notes**:
- socket path format: `$XDG_RUNTIME_DIR/keyrack.$SESSIONID.sock` (default)
- socket path format: `$XDG_RUNTIME_DIR/keyrack.$SESSIONID.$owner.sock` (per-owner)
- uses XDG_RUNTIME_DIR for security (tmpfs, proper permissions)

---

## phase 4: init & recipient operations

**status**: complete ✓

**tasks**:
- [x] create `src/domain.operations/keyrack/getKeyrackIdentityPath.ts` — resolves identity file path by owner
- [x] create `src/domain.operations/keyrack/initKeyrack.ts` — generates keypair, creates manifest
- [x] create `src/domain.operations/keyrack/initKeyrack.test.ts` — 21 unit tests
- [x] create `src/domain.operations/keyrack/recipient/setKeyrackRecipient.ts` — add recipient to manifest
- [x] create `src/domain.operations/keyrack/recipient/getKeyrackRecipients.ts` — list recipients
- [x] create `src/domain.operations/keyrack/recipient/delKeyrackRecipient.ts` — remove recipient
- [x] create `src/domain.operations/keyrack/recipient/recipient.test.ts` — 12 unit tests
- [x] verify all unit tests pass (initKeyrack: 21, recipient: 12)
- [x] verify type check passes

**notes**:
- `initKeyrack` is idempotent (findsert semantics)
- identity file stored at `~/.rhachet/keyrack/keyrack.identity` (or `.${owner}`)
- identity file permissions are 0600
- session identity set via `daoKeyrackHostManifest.setSessionIdentity()`
- recipient operations: setKeyrackRecipient, getKeyrackRecipients, delKeyrackRecipient
- cannot delete last recipient (at least one required for encryption)

---

## phase 5: daemon updates

**status**: queued

---

## phase 6: session operations

**status**: queued

---

## phase 7: set operation

**status**: queued

---

## phase 8: cli commands

**status**: queued

---

## phase 9: acceptance tests

**status**: queued

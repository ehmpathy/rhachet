# research: remote access for keyrack sudo

## overview

this feature requires access to:
1. **age encryption** — encrypt/decrypt keyrack.host.yml.age
2. **1password CLI** — retrieve credentials from 1password vault (already implemented)
3. **unix domain socket** — daemon IPC (already implemented)
4. **local filesystem** — read/write encrypted manifest

---

## 1. age encryption

### what it is

age is a modern file encryption tool and format. [1]

> "a simple, modern and secure encryption tool (and Go library) with small explicit keys, no config options, and UNIX-style composability." [1]

### contract

**passphrase-based encryption (what we need):**

```bash
# encrypt with passphrase
age -p secrets.txt > secrets.txt.age

# decrypt with passphrase (prompts interactively)
age -d secrets.txt.age > secrets.txt
```

> "Files can be encrypted with a passphrase by using `-p/--passphrase`. By default age will automatically generate a secure passphrase." [1]

> "Passphrase protected files are automatically detected at decrypt time." [1]

### node.js interface

the `age-encryption` npm package provides a typescript implementation. [2]

> "Typage (age-encryption on npm) is a TypeScript implementation of the age file encryption format that runs with Node.js, Deno, Bun, and browsers, and implements native age recipients, passphrase encryption, ASCII armoring, and supports custom recipient interfaces." [2]

**installation:**
```bash
npm install age-encryption
```

**compatibility:**
> "compiled for ES2023, and compatible with Node.js 20+, Bun, Deno, and all recent browsers." [2]

### best practices

1. **use passphrase encryption** for host manifest (symmetric, user-controlled)
2. **never store passphrase** — prompt interactively or use env var
3. **decrypt to memory only** — never write plaintext to disk

---

## 2. 1password CLI (op)

### what it is

1password CLI (`op`) provides programmatic access to 1password vaults. [3]

### contract

**secret reference syntax:**
```
op://vault/item/field
op://vault/item/section/field
```

> "Secret references are case-insensitive and support the following characters: alphanumeric characters (a-z, A-Z, 0-9), `-`, `_`, `.` and the whitespace character." [4]

**read a secret:**
```bash
op read "op://vault/item/field"
```

> "Read the value of the field in 1Password specified by a secret reference." [5]

### current implementation

already implemented in `src/domain.operations/keyrack/adapters/vaults/vaultAdapter1Password.ts`:

```typescript
const { stdout } = await execOp(['read', input.exid]);
return stdout.trim();
```

### best practices

> "1Password recommends using 1Password Service Accounts to follow the principle of least privilege, with Service accounts supporting restricting 1Password CLI to specific vaults." [3]

**for sudo credentials:**
1. use `op read` with secret references
2. reject `--passphrase` as CLI arg (shell history risk)
3. support `OP_SERVICE_ACCOUNT_TOKEN` env var for service accounts

---

## 3. unix domain socket (daemon)

### what it is

local IPC mechanism for keyrack daemon communication.

### contract

node.js `net` module provides unix socket support. [6]

> "A Unix domain socket will be visible in the file system and will persist until unlinked." [6]

**server creation:**
```typescript
import { createServer } from 'node:net';

const server = createServer((socket) => {
  // handle connection
});
server.listen('/path/to/socket.sock');
```

### current implementation

already implemented in `src/domain.operations/keyrack/daemon/svc/src/infra/createKeyrackDaemonServer.ts`:

```typescript
const server = createServer((socket) => {
  handleKeyrackDaemonConnection({ socket }, { keyStore });
});
server.listen(socketPath, () => {
  console.log(`[keyrack-daemon] server started at ${socketPath}`);
});
```

### best practices (security)

> "Unix socket permissions depend on umask, so set umask before listen and reset it after listen succeeds. You can also set the permissions explicitly with a fs.chmodSync call when the listen succeeds." [7]

> "Node.js now applies network permission checks to Unix Domain Socket connections. UDS-based communication is treated consistently with other network operations." [6]

**for sudo credentials:**
1. **set socket permissions to 0600** — owner-only access
2. handle socket errors properly to prevent DoS
3. cleanup stale socket on startup (already done)

---

## 4. local filesystem

### what it is

read/write encrypted host manifest (`~/.rhachet/keyrack.host.yml.age`)

### contract

node.js `fs` module for file operations.

### current implementation

currently stores plaintext JSON at `~/.rhachet/keyrack.manifest.json`

schema from `src/access/daos/daoKeyrackHostManifest/schema.ts`:
```typescript
export const schemaKeyrackHostManifest = z.object({
  uri: z.string(),
  hosts: z.record(z.string(), schemaKeyrackKeyHost),
});
```

### migration needed

1. rename: `keyrack.manifest.json` → `keyrack.host.yml.age`
2. encrypt on write: plaintext → age passphrase encryption
3. decrypt on read: age → memory only
4. add `env` field to `KeyrackKeyHost` schema: `'all' | 'sudo'`
5. add `org` field to `KeyrackKeyHost` schema

---

## citations

1. [FiloSottile/age - GitHub](https://github.com/FiloSottile/age) — age encryption tool and format
2. [age-encryption - npm](https://www.npmjs.com/package/age-encryption) — typescript implementation
3. [1Password CLI best practices](https://developer.1password.com/docs/cli/best-practices/) — official guidance
4. [1Password CLI Secret Reference Syntax](https://developer.1password.com/docs/cli/secret-reference-syntax/) — reference format
5. [op read command](https://developer.1password.com/docs/cli/reference/commands/read/) — read secrets
6. [Node.js Net Documentation](https://nodejs.org/api/net.html) — unix socket support
7. [Node.js unix socket permissions](https://william.shallum.net/notes/2010-08-25-nodejs-set-unix-socket-permissions/) — permission best practices

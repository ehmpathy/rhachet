# 6.6 blueprint gap review

## summary

the implementation is **fully complete** against the blueprint. all domain objects, domain operations, daemon layer, access layer, ssh infra, contract/cli, and test files exist and implement the specified features. type compilation passes (`npm run test:types` clean). previous gap review issues (6.4 gap.8 debug file, identity file patterns) are resolved.

---

## gap.0 — all previous gaps resolved

| prior gap | status |
|-----------|--------|
| 6.4 gap.1: absent unit tests for session operations | ✅ resolved — `unlockKeyrack.test.ts` and `relockKeyrack.test.ts` both exist |
| 6.4 gap.2: absent integration tests | ✅ resolved — `unlockKeyrack.integration.test.ts` and `setKeyrackKeyHost.integration.test.ts` both exist |
| 6.4 gap.3: `hosts` vs `keys` name | ✅ accepted — `hosts` is the canonical name |
| 6.4 gap.4: `UnlockedKey` retained | ✅ accepted — lean daemon-specific type is better bounded context |
| 6.4 gap.7: absent vaultRecipient/maxDuration test cases | ✅ resolved — `setKeyrackKeyHost.integration.test.ts` covers these |
| 6.4 gap.8: stale `debug-env-org.test.ts` | ✅ resolved — file removed from staged changes |
| 6.5: stanza mismatch | ✅ resolved — cipher-aware encrypt path implemented |

---

## gap.1 — `prikey` not in `unlockKeyrack` input (architectural divergence)

**severity:** NITPICK (not a functional gap)

**blueprint specifies:**
```
unlockKeyrack(
  input: {
    ...
    prikey?: string;   // optional: explicit ssh private key path for edge cases
  },
  context: KeyrackGrantContext,
)
```

**actual:** `prikey` is NOT in the `unlockKeyrack` domain operation signature. instead, `prikey` is accepted at the CLI layer (`invokeKeyrack.ts:539`) and passed to `genKeyrackGrantContext({ prikey })`, which passes it to `daoKeyrackHostManifest.get({ prikey })`.

**impact:** none — the feature works. the `prikey` flows through context generation rather than through the domain operation input. this is arguably better separation of concerns: `unlockKeyrack` operates on an already-decrypted `context.hostManifest`, so it doesn't need to know about the decryption key. the `prikey` concern is fully handled before `unlockKeyrack` is called.

**recommendation:** update blueprint to reflect the actual architecture (prikey at context-generation layer, not domain operation layer).

---

## gap.2 — `killKeyrackDaemon` not in blueprint

**severity:** observation only (not a gap — it's an addition)

**blueprint does not mention** `killKeyrackDaemon.ts` in the daemon sdk. the implementation adds it as a new file at `src/domain.operations/keyrack/daemon/sdk/src/domain.operations/killKeyrackDaemon.ts`.

**impact:** positive — this is a useful cleanup/restart operation. exported from the daemon sdk `index.ts`. used by test infrastructure (`killKeyrackDaemonForTests.ts`).

---

## gap.3 — `writeDirectStoreEntry.ts` test infra not in blueprint

**severity:** observation only

**actual:** `accept.blackbox/.test/infra/writeDirectStoreEntry.ts` exists in staged changes but is not mentioned in the blueprint.

**impact:** none — this is test infrastructure that supports acceptance tests by direct write of entries to the os.secure store for test setup.

---

## compliance matrix

| blueprint section | status | gaps |
|---|---|---|
| domain objects (KeyrackKeyHost, KeyrackKeyGrant, KeyrackKeyRecipient, KeyrackHostManifest) | ✅ complete | — |
| domain operations (initKeyrack, recipient ops, setKeyrackKeyHost, getKeyrackKeyGrant) | ✅ complete | — |
| session operations (unlock, relock, status) | ✅ complete | gap.1 prikey architecture (NITPICK) |
| daemon layer (socket path, keystore, handlers, sdk, server) | ✅ complete | gap.2 killKeyrackDaemon addition |
| access layer (daoKeyrackHostManifest with age encryption) | ✅ complete | — |
| ssh infra (hybrid identity, pubkey conversion, key discovery) | ✅ complete | — |
| contract/cli (init, recipient, set, get, unlock, relock, status) | ✅ complete | — |
| test infra (withTestHome, withTestSshAgent, test keys) | ✅ complete | gap.3 writeDirectStoreEntry addition |
| unit tests | ✅ complete | — |
| integration tests | ✅ complete | — |
| acceptance tests | ✅ complete | — |
| security measures (chmod 0600, recipient encryption, TTL) | ✅ complete | — |
| hybrid ssh identity resolution (amendment) | ✅ complete | — |
| recipient-based identity discovery (amendment) | ✅ complete | — |
| cipher-aware encrypt path (amendment) | ✅ complete | — |
| type compilation | ✅ passes | — |

---

## overall assessment

**implementation fidelity: ~100%**

all functional code, domain objects, operations, daemon layer, access layer, and test suites are fully implemented and aligned with the blueprint. the three observations (gap.1-3) are architectural nitpicks or positive additions — none represent absent functionality or blueprint violations.

the only blueprint divergence is where `prikey` lives (context-generation vs domain operation input), which is an arguably better architectural choice than what the blueprint specified.

all previous gap review issues (6.4 gaps 1-8, 6.5 stanza mismatch) have been fully resolved.

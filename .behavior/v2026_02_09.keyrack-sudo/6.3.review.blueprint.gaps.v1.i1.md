# blueprint gaps review: keyrack sudo credentials (6.3.v1.i1)

## summary

fresh review against current staged diffs (post 6.review iteration which reached 100%). three **critical defects** and one **high defect** surfaced.

| category | count | trend |
|----------|-------|-------|
| critical (broken flow) | 3 | **new — os.direct fallback cache + default init uses age keys + passphrase-protected ssh keys fail** |
| high (broken ux) | 1 | **new — os.direct fallback cache applies to all keys** |
| medium (incomplete) | 1 | new |
| low (polish) | 1 | new |
| future enhancement | 1 | carried forward |
| architectural divergences | 1 | socket path (accepted) |

---

## layer-by-layer compliance

### domain objects: 100%

all blueprint-specified domain objects fully implemented:

| object | fields | status |
|--------|--------|--------|
| KeyrackKeyRecipient (new) | mech, pubkey, label, addedAt | ✅ complete |
| KeyrackHostManifest (new) | owner, recipients, hosts | ✅ complete |
| KeyrackKeyHost (modified) | +env, +org, +vaultRecipient, +maxDuration | ✅ complete |
| KeyrackKeyGrant (modified) | +env, +org | ✅ complete |
| KeyrackHostVaultAdapter (modified) | +env, +org, +vaultRecipient on get/set | ✅ complete |
| daemonKeyStore (modified) | +env, +org on UnlockedKey; +env filter on entries() | ✅ complete |

no gaps.

### domain operations: 98%

| operation | status | notes |
|-----------|--------|-------|
| initKeyrack | ✅ complete | idempotent, owner-aware, 11 test cases |
| getKeyrackHostManifestPath | ✅ complete | owner-routed paths |
| getKeyrackIdentityPath | ⚠️ no dedicated test | simple function, tested indirectly |
| setKeyrackKeyHost | ✅ complete | env/org route, sudo exclusion from keyrack.yml |
| getKeyrackKeyGrant | ✅ complete | sudo bypass of repo manifest |
| setKeyrackRecipient | ✅ complete | multi-recipient re-encryption |
| getKeyrackRecipients | ✅ complete | decrypts and returns |
| delKeyrackRecipient | ✅ complete | prevents last-recipient removal |
| unlockKeyrack | ✅ complete | sudo TTL 30m, --key required, maxDuration cap |
| relockKeyrack | ✅ complete | env filter, priority: slugs > env > all |
| getKeyrackStatus | ✅ complete | owner, recipients, env/org per key |
| genKeyrackGrantContext | ✅ complete | owner-routed |
| genKeyrackHostContext | ✅ complete | owner-routed |

### daemon layer: 100%

| component | status | notes |
|-----------|--------|-------|
| getKeyrackDaemonSocketPath | ✅ complete | owner-suffixed paths |
| createKeyrackDaemonServer | ✅ complete | chmod 0600, socketPath passed by caller |
| daemon SDK (unlock/get/relock/status) | ✅ complete | all accept socketPath for owner route |
| handleUnlockCommand | ✅ complete | stores env, org |
| handleGetCommand | ✅ complete | org validation (matches or @all) |
| handleRelockCommand | ✅ complete | env filter |
| handleStatusCommand | ✅ complete | env, org per key |
| handleCommands.test.ts | ✅ complete | sudo-specific cases |
| killKeyrackDaemon | ✅ complete | owner-aware |

### access layer: 100%

| component | status | notes |
|-----------|--------|-------|
| daoKeyrackHostManifest | ✅ complete | age recipient encryption, owner-routed |
| daoKeyrackHostManifest schema | ✅ complete | owner, recipients, env, org, vaultRecipient |
| daoKeyrackRepoManifest | ✅ complete | sudo keys excluded from keyrack.yml |
| ageRecipientCrypto | ✅ complete | encrypt/decrypt with multi-recipient |
| vaultAdapterOsSecure | ✅ complete | recipient-based encryption, vaultRecipient |
| vaultAdapterOsDaemon | ✅ complete | env/org passthrough |

### infra layer: 100%

| component | status | notes |
|-----------|--------|-------|
| findDefaultSshKey | ✅ complete | checks ed25519, rsa, ecdsa |
| readSshPubkey | ✅ complete | accepts .pub or private key path |
| sshPrikeyToAgeIdentity | ❌ broken for passphrase keys | ed25519 → age identity conversion; fails on cipher !== 'none' |
| sshPubkeyToAgeRecipient | ✅ complete | ed25519 → age recipient conversion |

### contract layer: 95%

| command | status | notes |
|---------|--------|-------|
| keyrack init | ✅ complete | --for, --pubkey, --label, --json |
| keyrack recipient set/get/del | ✅ complete | --for, --pubkey, --label |
| keyrack set | ✅ complete | --for, --env, --org, --vault-recipient, --max-duration |
| keyrack get | ✅ complete | --for, --env, --org, --key |
| keyrack unlock | ✅ complete | --for, --env, --key, --duration |
| keyrack relock | ✅ complete | --for, --env, --key |
| keyrack status | ✅ complete | --for, owner/recipients/env display |
| keyrack init --via yubikey | ❌ not implemented | deferred to v2 |

### test infrastructure: 100%

| component | status |
|-----------|--------|
| genMockKeyrackHostManifest | ✅ owner, env, org, recipients defaults |
| withTestHomeWithSshKey | ✅ comprehensive + tests |
| withTestSshAgent | ✅ isolated agent + tests |
| test ssh keys (committed) | ✅ ed25519 key pair |
| test age keys | ✅ identity + recipient |
| killKeyrackDaemonForTests | ✅ owner-aware cleanup |
| writeDirectStoreEntry | ✅ direct store helper |

### acceptance tests: 97%

| test file | cases | status |
|-----------|-------|--------|
| keyrack.sudo.acceptance.test.ts | 14 cases | ✅ exceeds blueprint (12+ required) |
| keyrack.init.acceptance.test.ts | 4 cases | ⚠️ `--pubkey` test absent |
| keyrack.recipient.acceptance.test.ts | 4 cases | ✅ complete |

---

## gaps

### gap.1 [medium]: acceptance test for `keyrack init --pubkey` absent

**location**: `accept.blackbox/cli/keyrack.init.acceptance.test.ts`

**blueprint specifies**: usecase.6 includes tests for `--pubkey` with explicit value, private key path, and .pub file path.

**current state**: init acceptance tests cover default key, --for owner, --label, and human output — but no test case exercises the `--pubkey` flag.

**impact**: the `--pubkey` flag IS implemented in the contract layer (`invokeKeyrack.ts:41`) and tested in unit/integration tests (`initKeyrack.test.ts`), but lacks blackbox acceptance coverage.

**recommendation**: add case5 to keyrack.init.acceptance.test.ts that tests `--pubkey` with the committed test ssh key path.

### gap.2 [low]: `getKeyrackIdentityPath.ts` has no dedicated test file

**location**: `src/domain.operations/keyrack/getKeyrackIdentityPath.ts`

**blueprint specifies**: not explicitly listed in test coverage section.

**current state**: the function is simple (follows same pattern as `getKeyrackHostManifestPath`) and is tested indirectly through integration tests of initKeyrack and recipient operations.

**impact**: minimal — the function is ~3 lines and any regression would be caught by integration tests.

**recommendation**: either add a small test file for consistency with `getKeyrackHostManifestPath.test.ts`, or accept as-is given the function's simplicity.

---

## future enhancement (carried forward)

### gap from prior review: `--via yubikey` not implemented

**location**: `invokeKeyrack.ts` contract layer

**blueprint specifies**: `rhx keyrack init --via yubikey` runs `age-plugin-yubikey` to discover pubkey.

**acceptable for v1**: yubikey support is a future enhancement; ssh and age keys cover primary use cases.

---

## architectural divergences (carried forward, accepted)

### socket path location

| aspect | blueprint | implementation |
|--------|-----------|----------------|
| path | `/tmp/keyrack.daemon.sock` | `$XDG_RUNTIME_DIR/keyrack.$SESSIONID.sock` |

improvement — `xdg_runtime_dir` is more secure (user-private, tmpfs).

---

## gap.0 [critical]: `os.direct` fallback cache in grant flow should not exist

**location**: `src/domain.operations/keyrack/getKeyrackKeyGrant.ts:174-211`

**blueprint specifies**: the grant resolution order is os.envvar (ci passthrough) → os.daemon (session cache) → host manifest vault (requires unlock). there is no `os.direct` fallback cache step.

**root cause**: `attemptGrantKey` checks vaults in this order:
1. `os.envvar` (line 111) — ci passthrough, correct
2. `os.daemon` (line 152) — session cache, correct
3. `os.direct` (line 176) — **stale fallback cache**, should not be here

the comment at line 174-175 even says "deprecated: will be removed once os.daemon is fully adopted" — but os.daemon IS fully adopted. this fallback was never removed.

**impact (critical — sudo keys)**: sudo keys that have a cached value in `os.direct` return `status: 'granted'` without daemon unlock. defeats the entire sudo tier (30min TTL, per-key unlock, encrypted manifest).

**impact (high — all keys)**: regular keys also bypass the daemon via this fallback. any key with a stale `os.direct` cache entry is served from plaintext storage without TTL enforcement, without mechanism validation against the daemon store.

**observed in test**: case10 in `keyrack.sudo.acceptance.test.ts` pre-populates `os.direct` via `writeDirectStoreEntry`, then `get --env sudo` without unlock returns "granted" instead of "locked".

**fix**: remove the entire `os.direct` fallback cache block (lines 174-211). the correct resolution order is:
1. `os.envvar` — ci passthrough
2. `os.daemon` — session cache (the replacement for os.direct cache)
3. host manifest vault — requires unlock

note: `os.direct` as a **vault type** (when a user explicitly sets `--vault os.direct`) is still valid — that flows through the host manifest vault check at line 216+. only the **fallback cache** behavior should be removed.

also: stale comments at lines 61-62 that reference os.direct cache behavior should be updated.

---

## gap.4 [critical]: `sshPrikeyToAgeIdentity` fails on passphrase-protected ssh keys

**location**: `src/infra/ssh/sshPrikeyToAgeIdentity.ts:88-91`

**blueprint specifies**: `rhx keyrack init` uses the user's ssh key, which should have a passphrase (ssh-agent caches the unlocked key per session). the user should never need to type a passphrase for keyrack operations — ssh-agent handles it.

**current state**: `sshPrikeyToAgeIdentity` reads the raw openssh private key file and manually parses the binary format to extract the ed25519 seed. at line 88, it checks `if (cipher !== 'none')` and throws:

```
Error: passphrase-protected ssh keys not supported (cipher: aes256-ctr)
    at extractEd25519Seed (sshPrikeyToAgeIdentity.ts:89:11)
    at sshPrikeyToAgeIdentity (sshPrikeyToAgeIdentity.ts:16:34)
    at initKeyrack (initKeyrack.ts:86:45)
```

**root cause**: the `age-encryption` npm library only accepts native age identities (`AGE-SECRET-KEY-...`), not ssh private keys. so the code converts ssh → age identity via raw ed25519 seed extraction and SHA-512 → x25519 scalar → bech32 conversion. but when the key has a passphrase, openssh encrypts the private section with aes256-ctr — the code cannot decrypt it.

**impact**: **all passphrase-protected ssh keys are broken**. since we tell users to create keys WITH passphrases (by not passing `-N ""` to ssh-keygen), this means `keyrack init` fails for any properly secured ssh key. only passphrase-less keys work, which contradicts the security posture of the blueprint.

**prior art — sops-age**: sops delegates to the age Go library (`filippo.io/age/agessh`), which uses Go's `x/crypto/ssh.ParseRawPrivateKeyWithPassphrase` for passphrase-protected keys. the age library never does manual openssh binary format parse — it delegates to a battle-tested ssh parse library, then applies the same ed25519 → x25519 math we use. for passphrase-protected keys, sops prompts for the passphrase (does NOT leverage ssh-agent for seed extraction).

**decision: hybrid approach**

- **unencrypted keys** (cipher === 'none'): use extant in-process `sshPrikeyToAgeIdentity` — works fine, no change needed. this covers robots and ci with passphrase-less keys.
- **passphrase-protected keys** (cipher !== 'none'): shell out to `age` CLI binary for decryption. the Go `age` binary handles ssh keys natively via ssh-agent — zero passphrase prompts. the `age-encryption` npm library handles encryption (pubkeys work fine); decryption of passphrase-protected keys delegates to the CLI.

**`age` CLI is only needed on the cold path** (operations that decrypt the manifest):
- `keyrack get` → daemon serves from memory → no manifest decryption → no `age` CLI
- `keyrack unlock/set/recipient` → decrypts manifest → `age` CLI needed (if passphrase key)
- `keyrack init` → proactive pre-flight check (detects cipher before manifest creation)

the grant resolution order (`os.envvar` → `os.daemon` → host manifest vault) means the hot path (`get`) never touches the manifest at all. the ~50-100ms subprocess overhead is negligible on cold paths that already do vault roundtrips (1password cli, etc).

**graceful guidance for `age` CLI install**:

two detection points:
1. **proactive at `keyrack init`**: after ssh key discovery, read openssh header → detect cipher → if cipher !== 'none', check for `age` on PATH before manifest creation. the user learns what to install at their very first interaction.
2. **reactive at `sshPrikeyToAgeIdentity`**: catch-all for any manifest-decrypt operation. covers cases where `age` was uninstalled after init or a different key is used later.

error message:
```
your ssh key is passphrase-protected (cipher: aes256-ctr).
keyrack uses the `age` cli to decrypt via ssh-agent — no passphrase prompt needed.

install age:
  brew install age          # macos
  apt install age           # ubuntu/debian
  pacman -S age             # arch
  nix-env -i age            # nix

then retry: rhx keyrack init

note: robots and ci with passphrase-less keys (-N "") do not need age installed.
```

error type: `BadRequestError` (user-actionable, not a bug). metadata: `{ cipher, keyPath }`.

**tradeoffs of hybrid approach**:
- (+) no external dependency for the common case (robots, ci)
- (+) preserves zero-passphrase-prompt goal for humans via `age` CLI's ssh-agent integration
- (+) encryption stays pure node.js (npm `age-encryption` library, pinned at 0.3.0)
- (+) hot path (`get`) never invokes `age` CLI — zero overhead in normal operation
- (-) two code paths for identity resolution (in-process vs cli subprocess)
- (-) humans with passphrase-protected keys must install `age` CLI (~50-100ms subprocess overhead per unlock)
- (-) potential version drift between npm library (encryption) and Go binary (decryption)

note: this gap is entangled with gap.3 — both relate to the ssh key path in `initKeyrack`. the fix for gap.3 (ssh key as default) makes this gap immediately visible since all init flows will hit `sshPrikeyToAgeIdentity`.

---

## gap.3 [critical]: default `keyrack init` generates age keys instead of ssh key discovery

**location**: `src/domain.operations/keyrack/initKeyrack.ts`

**blueprint specifies**: `rhx keyrack init` (with no flags) discovers the default ssh key (`~/.ssh/id_ed25519` or similar) and creates the manifest encrypted to that key. ssh key is the default because ssh-agent tracks keys for users — no new key management burden.

**current state**: default `keyrack init` generates a new age key pair instead. ssh keys are only supported via the `--pubkey` flag and `sshPubkeyToAgeRecipient` conversion.

**impact**: users must track a new age key that is NOT managed by ssh-agent. this adds key management burden that the blueprint specifically avoids. the ssh key path (`findDefaultSshKey`, `sshPubkeyToAgeRecipient`, `sshPrikeyToAgeIdentity`) is fully implemented in the infra layer but is not the default path.

**fix**: change `initKeyrack` default behavior:
1. when no `--pubkey` and no `--via` flags: call `findDefaultSshKey()` to discover `~/.ssh/id_ed25519` (or similar)
2. if no ssh key found: gracefully exit with a helpful message that tells the user to create one with a passphrase, e.g.:
   ```
   no ssh key found. create one with:

     ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519

   then run: rhx keyrack init
   ```
   note: do NOT pass `-N ""` — let ssh-keygen prompt for a passphrase so the user sets one. ssh-agent caches the unlocked key per session.
3. convert the ssh pubkey to an age recipient via `sshPubkeyToAgeRecipient`
4. store the ssh private key path for identity resolution via `sshPrikeyToAgeIdentity`
5. age key generation should only occur as an explicit opt-in (e.g., `--via age`)

all the infra pieces exist (`findDefaultSshKey`, `readSshPubkey`, `sshPubkeyToAgeRecipient`, `sshPrikeyToAgeIdentity`). the fix is to wire them as the default path in `initKeyrack`.

---

## conclusion

the implementation is **95%+ complete** for v1 scope but has **three critical defects** and **one high defect** that must be resolved before merge:

1. **critical**: `os.direct` fallback cache in grant flow should not exist — os.daemon has replaced it; sudo keys bypass daemon unlock entirely via this stale path
2. **critical**: default `keyrack init` generates age keys instead of ssh key discovery — adds key management burden that the blueprint specifically avoids
3. **critical**: `sshPrikeyToAgeIdentity` fails on passphrase-protected ssh keys — reads raw key file instead of via ssh-agent; all properly secured ssh keys are broken
4. **high**: `os.direct` fallback cache also affects regular keys — all keys can bypass daemon TTL enforcement via stale plaintext cache
5. **medium**: `--pubkey` acceptance test absent (easy to add)
6. **low**: `getKeyrackIdentityPath` unit test absent (minor, tested indirectly)

gaps 2-3 are entangled: once ssh key is the default init path (gap.3 fix), passphrase-protected keys immediately break (gap.4). the recommended fix is to shell out to the `age` CLI binary for decryption, which handles ssh keys natively with ssh-agent and passphrase support.

all prior gaps from the 6.review series remain resolved. the critical defects require fixes in `getKeyrackKeyGrant.ts`, `initKeyrack.ts`, and `sshPrikeyToAgeIdentity.ts` before the feature is merge-ready.

# execution gaps: playtest analysis

mapped each playtest scenario against acceptance tests. 4 gaps found, 2 fixed, 2 deferred.

---

## gap.1: init without ssh key — no acceptance test for graceful error

**playtest scenario**: `2. init without ssh key`
**status**: [x] fixed
**severity**: low — prodcode handles it (`BadRequestError` at `initKeyrack.ts:78`), just no blackbox test

the code throws a clear error: `'no ed25519 key found; create one with: ssh-keygen -t ed25519'`
but no acceptance test verified this path.

**fix applied**: added case6 to `keyrack.init.acceptance.test.ts` — creates temp dir with no `.ssh/` directory, verifies non-zero exit and ssh-keygen instruction in output. 30/30 tests pass.

---

## gap.2: sudo get without unlock returns "granted" instead of "locked"

**playtest scenario**: `10. get sudo without unlock`
**status**: [x] fixed
**severity**: high — spec violation per blueprint criteria (usecase.3)

**root cause**: `getKeyrackKeyGrant.ts` — after daemon miss, code only returned `status: 'locked'` when host entry was ABSENT. when host entry EXISTS (normal case after `keyrack set`), code fell through to direct vault access and returned `status: 'granted'`.

**blueprint says**: "keyrack returns error: sudo credential X is locked. run: rhx keyrack unlock --env sudo --key X"

**fix applied**: added early return for sudo keys right after daemon miss (line ~152). sudo keys now ALWAYS return `status: 'locked'` on daemon miss — never fall through to direct vault access. cleaned up dead `isSudoKey` conditionals below. updated case10 t0 test to expect "locked" + unlock instructions. 89/89 tests pass.

---

## gap.3: `--prikey` fallback — no acceptance test

**playtest scenario**: `13. --prikey fallback`
**status**: [ ] deferred
**severity**: low — the flag exists in CLI and unit tests cover `sshPrikeyToAgeIdentity`, but no blackbox acceptance test for the `--prikey` unlock flag

**reason deferred**: requires test infrastructure to simulate "ssh-agent has no keys" which is complex to set up in acceptance tests without side effects on the host.

**skip stub**: `keyrack.sudo.acceptance.test.ts` case16 — documents 3 test scenarios (t0: success with --prikey, t1: bad path error, t2: no agent + no --prikey error).

---

## gap.4: `--stanza ssh` full prevention flow — not fully acceptance-tested

**playtest scenario**: `14. --stanza ssh prevention`
**status**: [ ] deferred
**severity**: low — this is an edge case recovery flow (user adds passphrase to a key that was passwordless at init time). unit tests cover `sshPubkeyToAgeRecipient` and `sshPrikeyToAgeIdentity`, but the full CLI round-trip is not tested.

**reason deferred**: requires passphrase-protected test keys and age CLI installed in test env.

**skip stub**: `keyrack.recipient.acceptance.test.ts` case5 — documents 4 test scenarios (t0: init baseline, t1: --stanza ssh adds dual recipient, t2: unlock after passphrase change, t3: cleanup stale recipient).

---

## summary

| gap | scenario | severity | status |
|-----|----------|----------|--------|
| 1 | init without ssh key | low | fixed: acceptance test added (case6) |
| 2 | sudo get without unlock | high | fixed: prodcode + test updated |
| 3 | --prikey fallback | low | deferred + skip stub (sudo case16) |
| 4 | --stanza ssh prevention | low | deferred + skip stub (recipient case5) |

# roadmap: keyrack sudo credentials

execution plan for the keyrack sudo credentials feature.

---

## phase 0: test infrastructure

**prereqs**: none

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.1.research.patterns._.code.test.v1.i1.md`
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § test infrastructure

**tasks**:
- [ ] create `.test/assets/keyrack/ssh/test_key_ed25519` (committed test key, no passphrase)
- [ ] create `.test/assets/keyrack/ssh/test_key_ed25519.pub`
- [ ] create `.test/infra/withTestSshAgent.ts` — spawns isolated agent, loads test key
- [ ] create `.test/infra/withTestHome.ts` — temp HOME with test key in .ssh/

**verify**:
```
given('[case0] test ssh key')
  then('test key exists at .test/assets/keyrack/ssh/test_key_ed25519')
  then('test pubkey exists at .test/assets/keyrack/ssh/test_key_ed25519.pub')
  then('withTestSshAgent loads key into isolated agent')
  then('withTestHome creates temp HOME with .ssh/id_ed25519')
```

---

## phase 1: domain objects

**prereqs**: phase 0

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § domain.objects

**tasks**:
- [ ] create `KeyrackKeyRecipient.ts` — mech, pubkey, label, addedAt
- [ ] create `KeyrackHostManifest.ts` — owner, recipients[], keys{}
- [ ] update `KeyrackKeyHost.ts` — add env, org, vaultRecipient?, maxDuration?
- [ ] update `KeyrackKeyGrant.ts` — add env, org
- [ ] update `genMockKeyrackHostManifest.ts` — add owner, env, org, recipients defaults

**verify**:
```
given('[case1] domain objects')
  then('KeyrackKeyRecipient has mech, pubkey, label, addedAt')
  then('KeyrackHostManifest has owner, recipients[], keys{}')
  then('KeyrackKeyHost has env, org, vaultRecipient?, maxDuration?')
  then('KeyrackKeyGrant has env, org')
  then('npm run test:types passes')
```

---

## phase 2: dao layer — encrypted host manifest

**prereqs**: phase 1

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.1.research.access._.v1.i1.md`
- `.behavior/v2026_02_09.keyrack-sudo/3.1.research.patterns._.code.prod.v1.i1.md`

**tasks**:
- [ ] update `daoKeyrackHostManifest/schema.ts` — add owner, env, org, recipients, vaultRecipient
- [ ] update `daoKeyrackHostManifest/index.ts`:
  - [ ] accept `owner?: string | null` param
  - [ ] resolve path: `keyrack.host.age` (null) or `keyrack.host.${owner}.age`
  - [ ] age encryption with recipient keys (reuse pattern from vaultAdapterOsSecure)
  - [ ] decrypt via ssh-agent or yubikey (automatic)
- [ ] create `daoKeyrackHostManifest.integration.test.ts`:
  - [ ] test create/read with ssh recipient
  - [ ] test multi-recipient (add second, both can decrypt)
  - [ ] test owner isolation (mechanic vs foreman)

**verify**:
```
given('[case2] encrypted host manifest')
  when('manifest created with ssh recipient')
    then('file exists at ~/.rhachet/keyrack/keyrack.host.age')
    then('file is age-encrypted (not plaintext)')
  when('manifest read with correct recipient')
    then('decrypts successfully via ssh-agent')
  when('manifest read with wrong recipient')
    then('throws error')
  when('owner is mechanic')
    then('file is keyrack.host.mechanic.age')
```

---

## phase 3: path helpers

**prereqs**: phase 1

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § contracts

**tasks**:
- [ ] create `getKeyrackHostManifestPath.ts`:
  - [ ] accept `owner?: string | null`
  - [ ] return `~/.rhachet/keyrack/keyrack.host.age` (null) or `.../keyrack.host.${owner}.age`
- [ ] create `getKeyrackDaemonSocketPath.ts`:
  - [ ] accept `owner?: string | null`
  - [ ] return `/tmp/keyrack.daemon.sock` (null) or `/tmp/keyrack.daemon.${owner}.sock`

**verify**:
```
given('[case3] path helpers')
  when('owner is null')
    then('manifest path is keyrack.host.age')
    then('socket path is /tmp/keyrack.daemon.sock')
  when('owner is mechanic')
    then('manifest path is keyrack.host.mechanic.age')
    then('socket path is /tmp/keyrack.daemon.mechanic.sock')
```

---

## phase 4: init & recipient operations

**prereqs**: phase 2, phase 3

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § contracts (initKeyrack, recipient)
- `.behavior/v2026_02_09.keyrack-sudo/2.1.criteria.blackbox.md` § usecase.6, usecase.7

**tasks**:
- [ ] create `initKeyrack.ts`:
  - [ ] accept owner?, pubkey?, recipientMech?
  - [ ] resolve pubkey (value, .pub file, private key path, or default ~/.ssh/id_ed25519)
  - [ ] if recipientMech === 'yubikey': run age-plugin-yubikey
  - [ ] create encrypted manifest at owner-specific path
- [ ] create `initKeyrack.test.ts` — unit tests
- [ ] create `recipient/setKeyrackRecipient.ts` — add recipient, re-encrypt to all
- [ ] create `recipient/getKeyrackRecipients.ts` — list recipients
- [ ] create `recipient/delKeyrackRecipient.ts` — remove recipient, re-encrypt to rest
- [ ] create `recipient/recipient.test.ts` — unit tests

**verify**:
```
given('[case4] init keyrack')
  when('rhx keyrack init (default)')
    then('finds ~/.ssh/id_ed25519')
    then('creates keyrack.host.age encrypted to that key')
  when('rhx keyrack init --for mechanic --pubkey ~/.ssh/id_ed25519_mechanic')
    then('creates keyrack.host.mechanic.age')
  when('rhx keyrack init (no ssh key)')
    then('returns error with instructions')

given('[case5] recipient management')
  when('recipient set --pubkey ...')
    then('re-encrypts manifest to include new recipient')
  when('recipient get')
    then('lists all recipients')
  when('recipient del --label ...')
    then('re-encrypts manifest without that recipient')
```

---

## phase 5: daemon updates

**prereqs**: phase 1, phase 3

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § daemon
- `.behavior/v2026_02_09.keyrack-sudo/2.1.criteria.blackbox.md` § usecase.10

**tasks**:
- [ ] update `daemonKeyStore.ts`:
  - [ ] add env, org to stored keys
  - [ ] add `entries({ env? })` with optional env filter
- [ ] update `daemonKeyStore.test.ts` — add env filter tests
- [ ] update `createKeyrackDaemonServer.ts`:
  - [ ] accept owner param
  - [ ] use `getKeyrackDaemonSocketPath(owner)` for socket path
  - [ ] chmod 0600 after listen (owner-only)
- [ ] update `handleUnlockCommand.ts` — accept env, org in payload
- [ ] update `handleGetCommand.ts` — return env, org in response
- [ ] update `handleRelockCommand.ts` — accept env filter
- [ ] update `handleStatusCommand.ts` — return env, org for each key
- [ ] update `handleCommands.test.ts` — add sudo-specific test cases
- [ ] update daemon sdk operations:
  - [ ] `daemonAccessUnlock.ts` — add owner (socket select), env, org
  - [ ] `daemonAccessGet.ts` — add owner (socket select), env, org
  - [ ] `daemonAccessRelock.ts` — add owner (socket select), env filter
  - [ ] `daemonAccessStatus.ts` — add owner (socket select)

**verify**:
```
given('[case6] daemon with env/org')
  when('UNLOCK with env=sudo')
    then('stores key with env, org')
  when('GET with env=sudo')
    then('returns key with env, org in response')
  when('RELOCK with env=sudo')
    then('purges only sudo keys')
    then('retains regular keys')
  when('daemon socket created')
    then('permissions are 0600')

given('[case7] daemon owner isolation')
  when('owner is mechanic')
    then('connects to /tmp/keyrack.daemon.mechanic.sock')
  when('owner is null')
    then('connects to /tmp/keyrack.daemon.sock')
```

---

## phase 6: session operations

**prereqs**: phase 4, phase 5

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § contracts (unlock, relock, status)
- `.behavior/v2026_02_09.keyrack-sudo/2.1.criteria.blackbox.md` § usecase.2, usecase.3, usecase.8

**tasks**:
- [ ] update `unlockKeyrack.ts`:
  - [ ] accept owner?, key?, duration?
  - [ ] if env=sudo && !key: throw "sudo requires --key"
  - [ ] if env=sudo: use 30min TTL (default), cap to maxDuration
  - [ ] if env!=sudo: use 9h TTL (default)
  - [ ] decrypt manifest via owner's recipient key
  - [ ] pass env, org to daemonAccessUnlock
- [ ] update `unlockKeyrack.test.ts` — add owner/sudo-specific tests
- [ ] create `unlockKeyrack.integration.test.ts`
- [ ] update `relockKeyrack.ts`:
  - [ ] accept owner?, env?, key?
  - [ ] default: purge ALL keys (--all)
  - [ ] if env filter: purge only matched env
  - [ ] if key filter: purge only specific key
- [ ] update `getKeyrackStatus.ts`:
  - [ ] accept owner?
  - [ ] include env, org, recipient info in response

**verify**:
```
given('[case8] unlock sudo')
  when('unlock --env sudo (without --key)')
    then('throws error: sudo requires --key')
  when('unlock --env sudo --key X')
    then('unlocks single key with 30min TTL')
  when('unlock --env sudo --key X --duration 2h (exceeds maxDuration 1h)')
    then('warns and caps to maxDuration')

given('[case9] relock')
  when('bare relock')
    then('purges ALL keys')
  when('relock --env sudo')
    then('purges only sudo keys')
    then('retains regular keys')
```

---

## phase 7: set operation

**prereqs**: phase 2, phase 4

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § contracts (setKeyrackKeyHost)
- `.behavior/v2026_02_09.keyrack-sudo/2.1.criteria.blackbox.md` § usecase.1, usecase.4, usecase.5, usecase.9

**tasks**:
- [ ] update `setKeyrackKeyHost.ts`:
  - [ ] accept owner?, env, org, vaultRecipient?, maxDuration?
  - [ ] always store in encrypted host manifest
  - [ ] if env !== 'sudo': also store in keyrack.yml
  - [ ] resolve @this to actual org; validate org is @this or @all
  - [ ] if vault=os.secure && vaultRecipient: store vaultRecipient pubkey
- [ ] update `setKeyrackKeyHost.test.ts` — add owner/env/org test cases
- [ ] create `setKeyrackKeyHost.integration.test.ts`

**verify**:
```
given('[case10] set sudo credential')
  when('set --key X --env sudo --org @this')
    then('stored in keyrack.host.age')
    then('NOT in keyrack.yml')
  when('set --key X --env sudo (duplicate)')
    then('returns prior config (findsert)')

given('[case11] set regular credential')
  when('set --key Y --env all --org @this')
    then('stored in keyrack.host.age')
    then('also stored in keyrack.yml')

given('[case12] cross-org credential')
  when('set --key Z --org @all --env sudo')
    then('stored with org: @all')
  when('get --key Z --env sudo (without --org)')
    then('error: key not found for org @this')
  when('get --key Z --env sudo --org @all')
    then('returns credential')

given('[case13] os.secure vault')
  when('set --vault os.secure (default)')
    then('uses manifest recipients')
  when('set --vault os.secure --vault-recipient "ssh-ed25519 ..."')
    then('stores vaultRecipient in KeyrackKeyHost')
```

---

## phase 8: cli commands

**prereqs**: phase 4, phase 6, phase 7

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/3.3.blueprint.v1.i1.md` § contract/commands
- `.behavior/v2026_02_09.keyrack-sudo/2.1.criteria.blackbox.md` (all usecases)

**tasks**:
- [ ] create `contract/commands/keyrack/init.ts`:
  - [ ] --for owner
  - [ ] --pubkey (value, .pub path, or private key path)
  - [ ] --via yubikey
- [ ] create `contract/commands/keyrack/recipient.ts`:
  - [ ] set --for --pubkey --label
  - [ ] get --for
  - [ ] del --for --label
- [ ] update `contract/commands/keyrack/set.ts`:
  - [ ] add --for, --env, --org, --vault-recipient flags
- [ ] update `contract/commands/keyrack/get.ts`:
  - [ ] add --for, --env, --org flags
- [ ] update `contract/commands/keyrack/unlock.ts`:
  - [ ] add --for, --key (required for sudo), --duration flags
- [ ] update `contract/commands/keyrack/relock.ts`:
  - [ ] add --for, --env, --key flags
- [ ] update `contract/commands/keyrack/status.ts`:
  - [ ] add --for
  - [ ] show owner, env/org, recipient info

**verify**:
```
given('[case14] cli init')
  when('rhx keyrack init')
    then('creates encrypted manifest with default ssh key')
  when('rhx keyrack init --for mechanic --pubkey ~/.ssh/id_ed25519_mechanic')
    then('creates keyrack.host.mechanic.age')

given('[case15] cli set/get/unlock sudo')
  when('rhx keyrack set --key X --env sudo --vault 1password')
    then('stored only in encrypted manifest')
  when('rhx keyrack unlock --env sudo --key X')
    then('unlocks with 30min TTL')
  when('rhx keyrack get --key X --env sudo')
    then('returns credential with env: sudo')
```

---

## phase 9: acceptance tests

**prereqs**: phase 8

**read before**:
- `.behavior/v2026_02_09.keyrack-sudo/2.1.criteria.blackbox.md` (all usecases)
- `.behavior/v2026_02_09.keyrack-sudo/3.1.research.patterns._.code.test.v1.i1.md`

**tasks**:
- [ ] create `keyrack-sudo.acceptance.test.ts` to cover:
  - [ ] usecase.1: set sudo credential
  - [ ] usecase.2: unlock sudo credential
  - [ ] usecase.3: get sudo credential
  - [ ] usecase.4: regular credentials unchanged
  - [ ] usecase.5: cross-org credentials
  - [ ] usecase.6: recipient-key-based manifest encryption
  - [ ] usecase.7: recipient management
  - [ ] usecase.8: status and relock
  - [ ] usecase.9: os.secure vault with recipient keys
  - [ ] usecase.10: attack surface reduction (socket 0600)
  - [ ] usecase.11: per-owner isolation

**verify**:
```
given('[case16] acceptance test suite')
  then('all blackbox criteria pass')
  then('npm run test:acceptance -- keyrack-sudo passes')
```

---

## dependency graph

```
phase 0 (test infra)
    │
    ├─> phase 1 (domain objects)
    │       │
    │       ├─> phase 2 (dao layer)
    │       │       │
    │       │       └─> phase 4 (init & recipient) ─────┐
    │       │                                           │
    │       └─> phase 3 (path helpers)                  │
    │               │                                   │
    │               └─> phase 5 (daemon) ───────────────┤
    │                                                   │
    └───────────────────────────────────────────────────┤
                                                        │
                        phase 6 (session) <─────────────┤
                                │                       │
                                └───────> phase 7 (set) │
                                              │         │
                                              └─────────┤
                                                        │
                                        phase 8 (cli) <─┘
                                              │
                                              v
                                    phase 9 (acceptance)
```

---

## summary

| phase | focus | key deliverable |
|-------|-------|-----------------|
| 0 | test infra | portable ssh test key |
| 1 | domain objects | KeyrackKeyRecipient, KeyrackHostManifest |
| 2 | dao layer | age-encrypted host manifest |
| 3 | path helpers | owner-based manifest/socket paths |
| 4 | init & recipient | keyrack init, recipient set/get/del |
| 5 | daemon | env/org track, socket permissions |
| 6 | session | unlock with sudo semantics, relock with env filter |
| 7 | set | sudo vs regular credential route |
| 8 | cli | all command flags |
| 9 | acceptance | blackbox verification |

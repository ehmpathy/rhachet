# runbook: fix acceptance test infrastructure for keyrack.set and keyrack.sudo

## problem

two distinct root causes produce all acceptance test failures:

### root cause 1: absent recipient in `with-keyrack-manifest` fixture

**affects**: `keyrack.set.acceptance.test.ts` (all 8 assertions across case1 + case2)

**symptom**: `UnexpectedCodePathError: manifest must have at least one recipient for encryption`

**why**: the `with-keyrack-manifest` fixture contains only `.agent/keyrack.yml` â€” it has NO `.rhachet/keyrack.manifest.json`. the `genTestTempRepo` function's `convertLegacyManifest` step only runs when it finds a `.rhachet/keyrack.manifest.json` in the fixture. since there is none, no encrypted manifest with recipients is provisioned. when `keyrack set` runs, `daoKeyrackHostManifest.set` requires `manifest.recipients.length >= 1` for encryption and throws.

**fix**: add a `.rhachet/keyrack.manifest.json` to the `with-keyrack-manifest` fixture. this mirrors the pattern already established by the `with-keyrack-multi-env` fixture. the manifest should contain host entries that match the keys declared in the fixture's `keyrack.yml` (XAI_API_KEY, GITHUB_APP_CREDS under env.test). `genTestTempRepo`'s `convertLegacyManifest` will then convert this to an encrypted `keyrack.host.age` with the test ssh key as recipient.

manifest content:
```json
{
  "uri": "file://~/.rhachet/keyrack.manifest.json",
  "hosts": {
    "testorg.test.XAI_API_KEY": {
      "slug": "testorg.test.XAI_API_KEY",
      "mech": "REPLICA",
      "vault": "os.direct",
      "exid": null,
      "createdAt": "2026-01-01T00:00:00.000Z",
      "updatedAt": "2026-01-01T00:00:00.000Z"
    },
    "testorg.test.GITHUB_APP_CREDS": {
      "slug": "testorg.test.GITHUB_APP_CREDS",
      "mech": "REPLICA",
      "vault": "os.direct",
      "exid": null,
      "createdAt": "2026-01-01T00:00:00.000Z",
      "updatedAt": "2026-01-01T00:00:00.000Z"
    }
  }
}
```

### root cause 2: absent stdin for os.direct vault in sudo tests

**affects**: `keyrack.sudo.acceptance.test.ts` (38 assertions across 14 `keyrack set` invocations)

**symptom**: `BadRequestError: value required for vault os.direct`

**why**: the CLI's `promptHiddenInput` reads the credential value from stdin for `os.direct` and `os.secure` vaults. 14 of 15 `invokeRhachetCliBinary` calls in the sudo test file do not pass a `stdin` property. the one call that does pass stdin (case15 t1, line ~1320) passes correctly.

**fix**: add `stdin: '<descriptive-value>\n'` to each of the 14 `invokeRhachetCliBinary` calls that invoke `keyrack set --vault os.direct` without stdin. each value should be descriptive of the test scenario for debug clarity (e.g., `'sudo-test-value\n'`, `'dual-store-value\n'`).

lines that need `stdin` added (approximate):
- line 29 (case1 t0)
- line 79 (case2 t0)
- line 113 (case3 t0)
- line 151 (case4 t0)
- line 185 (case5 t0)
- line 325 (case6 t0)
- line 506 (case8 t0)
- line 595 (case9 t0)
- line 670 (case10 t0)
- line 710 (case10 t1)
- line 796 (case11 t0)
- line 930 (case12 t0)
- line 1010 (case13 t0)
- line 1209 (case14 t0)

## execution order

1. add `.rhachet/keyrack.manifest.json` to `with-keyrack-manifest` fixture
2. add `stdin` to 14 `invokeRhachetCliBinary` calls in `keyrack.sudo.acceptance.test.ts`
3. run `keyrack.set.acceptance.test.ts` to verify fix 1
4. run `keyrack.sudo.acceptance.test.ts` to verify fix 2

## verification

- `npm run test:acceptance -- keyrack.set` passes all assertions
- `npm run test:acceptance -- keyrack.sudo` passes all assertions (modulo pre-extant snapshot mismatches in cases 5, 6 if any)

# blackbox criteria matrix: keyrack sudo credentials

## matrix.1: `keyrack set` storage behavior

| ind: --env | ind: --org | dep: in keyrack.yml | dep: in keyrack.host.yml.age |
|------------|------------|---------------------|------------------------------|
| sudo       | @this      | no                  | yes                          |
| sudo       | @ehmpathy  | no                  | yes                          |
| sudo       | @all       | no                  | yes                          |
| all        | @this      | yes                 | yes                          |
| all        | @ehmpathy  | yes                 | yes                          |
| all        | @all       | yes                 | yes                          |

**gap check**: complete — all env × org combinations covered

---

## matrix.2: `keyrack unlock` behavior

| ind: --env | ind: --key | ind: environment | dep: allowed | dep: default TTL |
|------------|------------|------------------|--------------|------------------|
| sudo       | specified  | normal           | yes          | 30min            |
| sudo       | specified  | CI               | no (error)   | n/a              |
| sudo       | omitted    | normal           | no (error)   | n/a              |
| sudo       | omitted    | CI               | no (error)   | n/a              |
| all        | specified  | normal           | yes          | 9h               |
| all        | specified  | CI               | yes          | 9h               |
| all        | omitted    | normal           | yes (bulk)   | 9h               |
| all        | omitted    | CI               | yes (bulk)   | 9h               |

**gap check**: complete — all env × key × environment combinations covered

**key insight**: sudo is stricter on both dimensions (requires --key, blocked in CI)

---

## matrix.3: `keyrack get` credential access

| ind: --env | ind: credential state | ind: --org matches | dep: result              |
|------------|-----------------------|--------------------|--------------------------|
| sudo       | unlocked              | yes                | value returned           |
| sudo       | unlocked              | no (@all cred)     | error: not found for org |
| sudo       | locked                | yes                | error: locked            |
| sudo       | locked                | no                 | error: not found for org |
| sudo       | expired               | yes                | error: expired           |
| sudo       | expired               | no                 | error: not found for org |
| all        | unlocked              | yes                | value returned           |
| all        | unlocked              | no (@all cred)     | error: not found for org |
| all        | locked                | yes                | error: locked            |
| all        | locked                | no                 | error: not found for org |
| all        | expired               | yes                | error: expired           |
| all        | expired               | no                 | error: not found for org |

**gap check**: complete — all env × state × org combinations covered

**note**: org mismatch always returns "not found" regardless of actual state (no info leakage)

---

## matrix.4: `keyrack relock` scope

| ind: --env filter | ind: --key filter | dep: sudo purged | dep: all purged |
|-------------------|-------------------|------------------|-----------------|
| sudo              | omitted           | all sudo keys    | none            |
| sudo              | specified         | only that key    | none            |
| all               | omitted           | none             | all regular     |
| all               | specified         | none             | only that key   |
| omitted           | omitted           | all sudo keys    | all regular     |
| omitted           | specified         | if matches       | if matches      |

**gap check**: complete

---

## matrix.5: passphrase input method

| ind: --env | ind: method          | dep: allowed |
|------------|----------------------|--------------|
| sudo       | --passphrase arg     | no (error)   |
| sudo       | KEYRACK_PASSPHRASE   | yes          |
| sudo       | interactive prompt   | yes          |
| all        | --passphrase arg     | yes          |
| all        | KEYRACK_PASSPHRASE   | yes          |
| all        | interactive prompt   | yes          |

**gap check**: complete

**key insight**: sudo blocks --passphrase arg to prevent shell history leakage

---

## matrix.6: host manifest state

| ind: manifest state | ind: operation | dep: behavior                        |
|---------------------|----------------|--------------------------------------|
| absent              | set (first)    | prompt to create with passphrase     |
| absent              | get/unlock     | error: no credentials configured     |
| present             | any            | prompt for passphrase, decrypt       |

**gap check**: complete

---

## matrix.7: rate limit on failed unlock

| ind: consecutive failures | dep: delay before next attempt |
|---------------------------|--------------------------------|
| 1                         | 0s                             |
| 2                         | 1s                             |
| 3                         | 2s                             |
| 4                         | 4s                             |
| 5+                        | 8s (capped)                    |

**gap check**: complete — exponential backoff with cap

---

## decomposition analysis

**current dimension count per matrix:**
- matrix.1: 2 dimensions — clean
- matrix.2: 3 dimensions — acceptable
- matrix.3: 3 dimensions — acceptable
- matrix.4: 2 dimensions — clean
- matrix.5: 2 dimensions — clean
- matrix.6: 2 dimensions — clean
- matrix.7: 1 dimension — trivial

**verdict**: no decomposition needed — all matrices have ≤3 independent dimensions

---

## coverage summary

| usecase | combinations | covered | gaps |
|---------|--------------|---------|------|
| set     | 6            | 6       | 0    |
| unlock  | 8            | 8       | 0    |
| get     | 12           | 12      | 0    |
| relock  | 6            | 6       | 0    |
| passphrase | 6         | 6       | 0    |
| manifest | 3           | 3       | 0    |
| rate limit | 5         | 5       | 0    |
| **total** | **46**     | **46**  | **0** |

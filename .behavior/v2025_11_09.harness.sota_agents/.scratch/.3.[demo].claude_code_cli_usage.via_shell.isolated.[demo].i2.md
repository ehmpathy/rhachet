# Demo: Invoking Claude Code with Isolated Context

This demo shows how to invoke Claude Code with restricted access to specific resources, creating isolated working environments for enhanced security, focus, and control.

## Why Isolated Context?

Isolation is useful when you want to:
- Limit Claude Code's access to sensitive parts of your codebase
- Provide only relevant context for specific tasks
- Add custom safety-monitored tools (e.g., web search with filters)
- Create reproducible, controlled environments for AI agent tasks
- Prevent accidental modifications to critical files

## Isolation Strategies

### 1. Directory-Based Isolation

Run Claude Code from a specific subdirectory to limit its working context:

```bash
# Create an isolated workspace
mkdir -p /tmp/isolated-workspace
cd /tmp/isolated-workspace

# Copy only what's needed
cp -r /path/to/project/src ./src
cp /path/to/project/package.json ./

# Run Claude Code in this isolated directory
claude "Analyze the code structure"
```

### 2. Symbolic Link Isolation

Create a controlled view of your repository using symlinks:

```bash
#!/bin/bash
# setup-isolated-context.sh

# Create isolated workspace
WORKSPACE="/tmp/claude-isolated-$(date +%s)"
mkdir -p "$WORKSPACE"

# Link only specific parts of .briefs directory
mkdir -p "$WORKSPACE/.briefs"
ln -s /path/to/repo/.briefs/public-api.md "$WORKSPACE/.briefs/"
ln -s /path/to/repo/.briefs/architecture.md "$WORKSPACE/.briefs/"
# Exclude sensitive briefs like .briefs/internal-secrets.md

# Link only specific source directories
ln -s /path/to/repo/src/public "$WORKSPACE/src"
ln -s /path/to/repo/tests "$WORKSPACE/tests"
# Exclude sensitive dirs like src/internal or src/admin

# Link necessary config files
ln -s /path/to/repo/package.json "$WORKSPACE/"
ln -s /path/to/repo/tsconfig.json "$WORKSPACE/"

# Work in isolated context
cd "$WORKSPACE"
claude "Review the public API implementation"

# Cleanup when done
# rm -rf "$WORKSPACE"
```

### 3. Subset of Repository with Filtering

Create a filtered copy of your repository:

```bash
#!/bin/bash
# create-filtered-repo.sh

SOURCE_REPO="/path/to/full/repo"
ISOLATED_REPO="/tmp/filtered-repo"

# Create clean workspace
rm -rf "$ISOLATED_REPO"
mkdir -p "$ISOLATED_REPO"

# Copy only non-sensitive files
rsync -av \
  --exclude='.env*' \
  --exclude='secrets/' \
  --exclude='credentials/' \
  --exclude='.briefs/internal*' \
  --exclude='src/admin/' \
  --include='src/***' \
  --include='.briefs/***' \
  --include='tests/***' \
  --exclude='*' \
  "$SOURCE_REPO/" "$ISOLATED_REPO/"

# Run Claude Code in filtered context
cd "$ISOLATED_REPO"
claude "Help me refactor the authentication module"
```

### 4. Subset of .briefs Directory

Selectively expose only relevant briefs:

```bash
#!/bin/bash
# isolate-briefs.sh

WORKSPACE="/tmp/claude-workspace-$$"
mkdir -p "$WORKSPACE/.briefs"

# Define which briefs to include
ALLOWED_BRIEFS=(
  "api-design.md"
  "coding-standards.md"
  "architecture-overview.md"
)

# Copy only allowed briefs
for brief in "${ALLOWED_BRIEFS[@]}"; do
  if [ -f ".briefs/$brief" ]; then
    cp ".briefs/$brief" "$WORKSPACE/.briefs/"
    echo "Included: $brief"
  fi
done

# Copy minimal repo structure
cp -r src "$WORKSPACE/"
cp package.json "$WORKSPACE/" 2>/dev/null || true

cd "$WORKSPACE"
echo "Isolated workspace created at: $WORKSPACE"
echo "Available briefs: ${ALLOWED_BRIEFS[*]}"

# Run Claude Code
claude "$@"
```

Usage:
```bash
./isolate-briefs.sh "Review code against our standards"
```

### 5. Custom Safety-Monitored Commands

Create wrapper commands that add safety checks and monitoring:

```bash
#!/bin/bash
# .shell/web-search-monitored

# This is a custom command Claude Code can invoke
# It adds safety monitoring to web searches

query="$1"

# Safety checks
if echo "$query" | grep -iE "(hack|exploit|vulnerability|bypass)" > /dev/null; then
  echo "Query contains sensitive terms. Logging for review..."
  echo "[$(date)] SENSITIVE QUERY: $query" >> /var/log/claude-queries.log

  # Optionally require approval
  echo "This query requires approval. Continue? (y/n)"
  read -r approval
  if [ "$approval" != "y" ]; then
    echo "Query rejected by safety monitor"
    exit 1
  fi
fi

# Log all queries
echo "[$(date)] QUERY: $query" >> /var/log/claude-queries.log

# Perform the actual web search (using a real tool)
# This could call your actual search API
curl -s "https://api.example.com/search?q=$(echo "$query" | jq -sRr @uri)" | \
  jq -r '.results[] | "\(.title): \(.url)"'

# Alternative: use a local search tool
# or: searx "$query"
# or: ddgr "$query"
```

Make it available to Claude Code:
```bash
# Setup
mkdir -p .shell
chmod +x .shell/web-search-monitored

# Add to PATH for the session
export PATH="$PWD/.shell:$PATH"

# Claude Code can now call: web-search-monitored "TypeScript best practices"
```

### 6. Container-Based Isolation

Use Docker for complete isolation:

```bash
#!/bin/bash
# run-claude-isolated.sh

# Create Dockerfile for isolated environment
cat > Dockerfile.claude-isolated << 'EOF'
FROM node:18-slim

# Install Claude Code (example)
RUN npm install -g @anthropic/claude-code

# Create workspace
WORKDIR /workspace

# Copy only allowed files
COPY --chown=node:node src/ ./src/
COPY --chown=node:node .briefs/public* ./.briefs/
COPY --chown=node:node package*.json ./

# Add monitored web search tool
COPY --chown=node:node .shell/ ./.shell/
ENV PATH="/workspace/.shell:${PATH}"

# Switch to non-root user
USER node

# Set environment variables
ENV CLAUDE_CONTEXT=isolated
ENV ALLOWED_OPERATIONS=read,analyze

ENTRYPOINT ["claude"]
EOF

# Build isolated container
docker build -f Dockerfile.claude-isolated -t claude-isolated .

# Run Claude Code in container
docker run -it --rm \
  -v "$PWD/src:/workspace/src:ro" \
  -v "$PWD/.briefs:/workspace/.briefs:ro" \
  -e ANTHROPIC_API_KEY \
  claude-isolated \
  "Analyze the code structure"
```

### 7. Environment-Based Restrictions

Use environment variables to control Claude Code's behavior:

```bash
#!/bin/bash
# run-claude-restricted.sh

# Set restrictions via environment
export CLAUDE_ALLOWED_PATHS="/workspace/src,/workspace/.briefs/public"
export CLAUDE_BLOCKED_PATTERNS="*.secret.*,*.key,*.pem,.env*"
export CLAUDE_MAX_FILE_SIZE="1048576"  # 1MB
export CLAUDE_READONLY_MODE="true"
export CLAUDE_CUSTOM_TOOLS_PATH="$PWD/.shell"

# Run with restrictions
claude "$@"
```

### 8. Chroot Isolation (Advanced)

Create a chroot environment for maximum isolation:

```bash
#!/bin/bash
# setup-chroot-isolated.sh

CHROOT_DIR="/tmp/claude-chroot"

# Create chroot structure
mkdir -p "$CHROOT_DIR"/{bin,lib,lib64,usr,workspace}

# Copy necessary binaries
for bin in bash ls cat grep; do
  cp /bin/$bin "$CHROOT_DIR/bin/"

  # Copy shared libraries
  ldd /bin/$bin | grep -o '/lib[^ ]*' | while read lib; do
    mkdir -p "$CHROOT_DIR$(dirname $lib)"
    cp "$lib" "$CHROOT_DIR$lib"
  done
done

# Copy Claude Code and dependencies
cp -r /usr/local/bin/claude "$CHROOT_DIR/bin/"

# Copy only allowed project files
cp -r src "$CHROOT_DIR/workspace/"
cp -r .briefs/public* "$CHROOT_DIR/workspace/.briefs/" 2>/dev/null || true

# Run Claude in chroot
sudo chroot "$CHROOT_DIR" /bin/bash -c "cd /workspace && claude 'Analyze code'"
```

## Complete Example: Isolated Agent Workflow

Here's a complete script that sets up an isolated context for Claude Code:

```bash
#!/bin/bash
# isolated-claude-workflow.sh

set -e

# Configuration
REPO_ROOT="$(git rev-parse --show-toplevel)"
WORKSPACE="/tmp/claude-isolated-$(date +%s)"
LOG_FILE="$HOME/.claude-isolated.log"

echo "Setting up isolated Claude Code environment..."

# 1. Create workspace
mkdir -p "$WORKSPACE"/{src,.briefs,.shell}

# 2. Copy subset of repository
echo "Copying allowed source files..."
rsync -av \
  --include='src/public/***' \
  --include='src/shared/***' \
  --exclude='src/***' \
  --exclude='.git' \
  "$REPO_ROOT/src/" "$WORKSPACE/src/" 2>/dev/null || true

# 3. Copy subset of briefs
echo "Copying allowed briefs..."
for brief in api-guidelines.md coding-standards.md architecture.md; do
  if [ -f "$REPO_ROOT/.briefs/$brief" ]; then
    cp "$REPO_ROOT/.briefs/$brief" "$WORKSPACE/.briefs/"
  fi
done

# 4. Create monitored web search command
cat > "$WORKSPACE/.shell/web-search" << 'WEBSCRIPT'
#!/bin/bash
query="$1"
echo "[$(date)] Web search: $query" >> ~/.claude-search.log

# Safety check
if echo "$query" | grep -iE "(password|secret|api.?key)" > /dev/null; then
  echo "ERROR: Query contains sensitive terms"
  exit 1
fi

# Simulated search (replace with real implementation)
echo "Search results for: $query"
echo "1. Example result from trusted source"
echo "2. Another safe result"
WEBSCRIPT

chmod +x "$WORKSPACE/.shell/web-search"

# 5. Create monitored file operations command
cat > "$WORKSPACE/.shell/safe-read" << 'READSCRIPT'
#!/bin/bash
file="$1"

# Only allow reading from allowed directories
if [[ ! "$file" =~ ^(src/public|src/shared|.briefs)/ ]]; then
  echo "ERROR: Access denied to $file"
  exit 1
fi

if [ -f "$file" ]; then
  cat "$file"
else
  echo "ERROR: File not found: $file"
  exit 1
fi
READSCRIPT

chmod +x "$WORKSPACE/.shell/safe-read"

# 6. Set up environment
export PATH="$WORKSPACE/.shell:$PATH"
export CLAUDE_ISOLATED_MODE=1
export CLAUDE_WORKSPACE="$WORKSPACE"

# 7. Log the session
echo "[$(date)] Starting isolated Claude session" >> "$LOG_FILE"
echo "Workspace: $WORKSPACE" >> "$LOG_FILE"

# 8. Run Claude Code
cd "$WORKSPACE"
echo ""
echo "Isolated environment ready at: $WORKSPACE"
echo "Available tools: web-search, safe-read"
echo "Available briefs: $(ls .briefs/ 2>/dev/null | tr '\n' ' ')"
echo ""

# Run the command
claude "$@"

# 9. Cleanup (optional)
echo ""
read -p "Delete isolated workspace? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  rm -rf "$WORKSPACE"
  echo "Workspace deleted"
else
  echo "Workspace preserved at: $WORKSPACE"
fi
```

Usage:
```bash
# Basic usage
./isolated-claude-workflow.sh "Review the public API implementation"

# With specific task
./isolated-claude-workflow.sh "Search web for React best practices and apply to our code"

# Interactive mode
./isolated-claude-workflow.sh
```

## Monitoring and Auditing

Track what Claude Code does in isolated contexts:

```bash
#!/bin/bash
# monitor-claude-session.sh

SESSION_ID="$(date +%s)"
AUDIT_LOG="$HOME/.claude-audit-${SESSION_ID}.log"

# Wrapper function that logs all commands
monitored_claude() {
  echo "=== Session $SESSION_ID started at $(date) ===" >> "$AUDIT_LOG"
  echo "Command: $*" >> "$AUDIT_LOG"

  # Run Claude Code with script recording
  script -q -c "claude $*" "$AUDIT_LOG.transcript"

  echo "=== Session ended at $(date) ===" >> "$AUDIT_LOG"
  echo ""
  echo "Audit log saved to: $AUDIT_LOG"
  echo "Full transcript saved to: $AUDIT_LOG.transcript"
}

monitored_claude "$@"
```

## Best Practices for Isolated Context

1. **Principle of Least Privilege**: Only provide access to what's necessary
2. **Audit Logging**: Always log queries and actions for review
3. **Safety Monitors**: Add checks for sensitive operations
4. **Temporary Workspaces**: Use `/tmp` and clean up after sessions
5. **Read-Only Mounts**: When possible, mount files as read-only
6. **Environment Separation**: Use separate API keys for isolated contexts
7. **Validation**: Verify file paths and command arguments before execution
8. **Timeout Limits**: Set time limits for isolated sessions
9. **Resource Limits**: Use ulimit or cgroups to limit resource usage
10. **Regular Reviews**: Periodically review logs and audit trails

## Testing Isolation

Verify your isolation setup:

```bash
#!/bin/bash
# test-isolation.sh

echo "Testing Claude Code isolation..."

# Test 1: Verify limited file access
echo "Test 1: File access restrictions"
claude "List all files you can access" | grep -q "secret" && \
  echo "FAIL: Can access secret files" || \
  echo "PASS: Secret files not accessible"

# Test 2: Verify custom tools work
echo "Test 2: Custom tools availability"
claude "Use web-search to find TypeScript docs" | grep -q "Search results" && \
  echo "PASS: Custom web-search tool works" || \
  echo "FAIL: Custom tools not available"

# Test 3: Verify briefs subset
echo "Test 3: Briefs isolation"
claude "List all available briefs" | tee /tmp/briefs-list.txt
if grep -q "internal" /tmp/briefs-list.txt; then
  echo "FAIL: Internal briefs are accessible"
else
  echo "PASS: Only public briefs accessible"
fi

# Test 4: Verify workspace boundaries
echo "Test 4: Workspace boundaries"
claude "What is your current working directory?" | grep -q "/tmp/claude-isolated" && \
  echo "PASS: Running in isolated workspace" || \
  echo "FAIL: Not in isolated workspace"
```

## Notes

- Isolation adds security but may limit Claude Code's effectiveness
- Balance security needs with functionality requirements
- Custom tools require careful implementation and testing
- Container-based isolation provides the strongest guarantees
- Always test isolation setup before using in production
- Consider using MCP (Model Context Protocol) servers for more sophisticated tool isolation
- Document your isolation strategy for team members

## Related Patterns

- **Progressive Disclosure**: Start with minimal access, expand as needed
- **Capability-Based Security**: Provide explicit capabilities rather than broad access
- **Audit First**: Log everything, review regularly
- **Fail Secure**: Default to denying access when uncertain

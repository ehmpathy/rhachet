# roadmap: gitignore linked role directories

## .summary

implement `findsertRepoGitignore` to create `.gitignore` files inside `.agent/repo=$slug/` directories for external roles, preventing git tracking of symlinked content.

---

## .phases

### phase 0: setup

- [ ] **0.1** verify working branch is clean
  - run: `git status`
  - accept: no uncommitted changes to production code

- [ ] **0.2** verify existing tests pass
  - run: `npm run test`
  - accept: all tests green

---

### phase 1: create findsertRepoGitignore

**depends on**: phase 0

- [ ] **1.1** create `src/domain.operations/invoke/link/findsertRepoGitignore.ts`
  - implement: function that creates `.gitignore` with correct content
  - implement: `git rm --cached -r` cleanup when gitignore missing
  - implement: idempotent behavior (unchanged if content matches)
  - accept: file exists with exported `findsertRepoGitignore` function

- [ ] **1.2** create `src/domain.operations/invoke/link/findsertRepoGitignore.integration.test.ts`
  - implement: [case1] directory exists, no .gitignore → creates file, status=created
  - implement: [case2] .gitignore exists with correct content → status=unchanged
  - implement: [case3] .gitignore exists with different content → overwrites, status=updated
  - run: `npm run test:integration -- findsertRepoGitignore`
  - accept: all 3 cases pass

- [ ] **1.3** verify phase 1 complete
  - run: `npm run test:integration -- findsertRepoGitignore`
  - accept: all tests green

---

### phase 2: integrate into execRoleLink

**depends on**: phase 1

- [ ] **2.1** modify `src/domain.operations/invoke/link/execRoleLink.ts`
  - implement: import `findsertRepoGitignore`
  - implement: call `findsertRepoGitignore({ repoDir })` after directory creation
  - implement: guard to skip when `input.repo.slug === '.this'`
  - accept: file updated with conditional gitignore creation

- [ ] **2.2** verify existing tests still pass
  - run: `npm run test:integration -- invokeRolesLink`
  - accept: no regressions

- [ ] **2.3** verify phase 2 complete
  - run: `npm run test`
  - accept: all tests green

---

### phase 3: add integration test assertions

**depends on**: phase 2

- [ ] **3.1** update `src/contract/cli/invokeRolesLink.integration.test.ts`
  - implement: assert .gitignore created for external repo links
  - implement: assert .gitignore NOT created for repo=.this links
  - implement: assert re-linking same role is idempotent
  - run: `npm run test:integration -- invokeRolesLink`
  - accept: new assertions pass

- [ ] **3.2** verify phase 3 complete
  - run: `npm run test:integration`
  - accept: all integration tests green

---

### phase 4: add acceptance test assertions

**depends on**: phase 3

- [ ] **4.1** update `accept.blackbox/cli/roles.link.acceptance.test.ts`
  - implement: assert .gitignore created inside `.agent/repo=$slug/`
  - implement: assert root .gitignore not modified
  - run: `npm run test:acceptance -- roles.link`
  - accept: new assertions pass

- [ ] **4.2** verify phase 4 complete
  - run: `npm run test:acceptance`
  - accept: all acceptance tests green

---

### phase 5: final verification

**depends on**: phase 4

- [ ] **5.1** run full test suite
  - run: `npm run test`
  - accept: all tests green

- [ ] **5.2** run type check
  - run: `npm run test:types`
  - accept: no type errors

- [ ] **5.3** run lint
  - run: `npm run test:lint`
  - accept: no lint errors

- [ ] **5.4** manual smoke test
  - run: `npx rhachet roles link --repo ehmpathy --role mechanic` (in a test repo)
  - accept: `.agent/repo=ehmpathy/.gitignore` created with correct content
  - accept: console shows `- .agent/repo=ehmpathy (detached from git)` if previously tracked
  - accept: console shows `+ .agent/repo=ehmpathy/.gitignore (created)`

- [ ] **5.5** verify .this exclusion
  - run: `npx rhachet roles link --repo .this --role any` (in a test repo)
  - accept: `.agent/repo=.this/.gitignore` does NOT exist

---

## .acceptance criteria summary

| criterion | verification |
|-----------|--------------|
| external repos get .gitignore | `roles link --repo X` creates `.agent/repo=X/.gitignore` |
| .this repos excluded | `roles link --repo .this` does NOT create .gitignore |
| gitignore content correct | contains `.what`, `.why`, `.note` comments + `*` |
| previously tracked content detached | `git rm --cached -r` runs when gitignore missing |
| idempotent | re-linking same role doesn't error or modify |
| root .gitignore untouched | no mutations to shared `.gitignore` file |

---

## .files changed

### new
- `src/domain.operations/invoke/link/findsertRepoGitignore.ts`
- `src/domain.operations/invoke/link/findsertRepoGitignore.integration.test.ts`

### modified
- `src/domain.operations/invoke/link/execRoleLink.ts`
- `src/contract/cli/invokeRolesLink.integration.test.ts`
- `accept.blackbox/cli/roles.link.acceptance.test.ts`

# solution: shell dispatcher + JIT fallback

## problem

bun-compiled binaries embed module resolution at compile time. when the binary imports `rhachet.use.ts` from a target repo, and that config imports from npm packages (e.g., `rhachet-roles-ehmpathy`), bun fails to resolve those packages from the target repo's `node_modules/`.

## observation: which commands need npm imports?

| command | needs npm imports? | why |
|---------|-------------------|-----|
| `run --skill` | no | scans `.agent/` directly |
| `roles boot` | no | reads from `.agent/` symlinks |
| `roles init` | no | runs scripts from `.agent/` symlinks |
| `roles cost` | no | calculates from `.agent/` files |
| `roles link` | **yes** | imports packages to get source paths |
| `act`, `ask` | **yes** | may need brain configs from registries |

**key insight**: only `roles link` and brain-dependent commands need npm package imports. all others read from `.agent/` after symlinks exist.

## solution: two-tier dispatcher

use a shell script dispatcher (`bin/run.bun`) that routes commands to either:
- **bun binaries** - for commands that read from `.agent/` (fast, consistent)
- **JIT via tsx** - for commands that need npm package imports (flexible)

```
bin/run (symlink)
  └── bin/run.bun (shell dispatcher)
        ├── run --skill        → bin/run.bun.rhachet-run.bc (bun)
        ├── roles boot/init    → bin/run.bun.rhachet-roles.bc (bun)
        ├── roles link         → bin/run.jit (JIT)
        └── *                  → bin/run.jit (JIT)
```

## why this works

the `.agent/` directory pattern separates "link time" from "run time":

1. **link time** (`roles link`, JIT)
   - imports from npm packages to discover source paths
   - creates symlinks from source paths into `.agent/`
   - runs once per role setup
   - can be slow (~300ms+)

2. **run time** (`roles boot`, `run --skill`, bun)
   - reads from `.agent/` symlinks directly
   - no npm package imports needed
   - runs frequently (hooks, skills, context load)
   - must be fast (~35-70ms) and consistent

## implementation

### bin/run.bun (shell dispatcher)

```bash
#!/usr/bin/env bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case "$1" in
  run)
    exec "$SCRIPT_DIR/run.bun.rhachet-run.bc" "$@"
    ;;
  roles)
    case "$2" in
      link)
        exec "$SCRIPT_DIR/run.jit" "$@"
        ;;
      boot|init|cost)
        exec "$SCRIPT_DIR/run.bun.rhachet-roles.bc" "$@"
        ;;
      *)
        exec "$SCRIPT_DIR/run.jit" "$@"
        ;;
    esac
    ;;
  *)
    exec "$SCRIPT_DIR/run.jit" "$@"
    ;;
esac
```

### bun entry points (skip registry load)

bun binaries pass empty registries since they read from `.agent/` directly:

```typescript
// invoke.bun.entry.roles.ts
invokeRoles({ program, registries: [] });
```

commands that need `--repo` can accept it explicitly without registry lookup.

### JIT entry point (full registry load)

JIT binary loads registries via `rhachet.use.ts` imports:

```typescript
// invoke.jit.entry.ts (existing invoke.ts)
const registries = await getRegistries({ configPath });
invokeRoles({ program, registries });
```

## benefits

| benefit | description |
|---------|-------------|
| no new config format | keeps `rhachet.use.ts` as-is |
| no subprocesses | JIT handles npm imports natively |
| fast hot path | bun binaries for frequent commands |
| consistent execution | bun eliminates JIT variance |
| simple implementation | shell case statement, ~30 lines |

## performance

| command | binary | startup | consistency |
|---------|--------|---------|-------------|
| `run --skill` | bun | ~35ms | high |
| `roles boot` | bun | ~70ms | high |
| `roles link` | JIT | ~300ms+ | variable |

JIT variance is acceptable for `roles link` (one-time setup). bun consistency matters for `roles boot` (session start hooks) and `run --skill` (frequent invocation).

## files changed

- `bin/run` → symlink to `run.bun`
- `bin/run.bun` → shell dispatcher (new)
- `bin/run.jit` → JIT entry via tsx (renamed)
- `bin/run.bun.rhachet-run.bc` → bun binary for `run` command
- `bin/run.bun.rhachet-roles.bc` → bun binary for `roles boot/init/cost`
- `invoke.bun.entry.roles.ts` → skip registry load
- `invokeRolesBoot.ts` → work without registries when `--repo` explicit

## removed (no longer needed)

- `bin/run.bun.dispatcher.bc` - shell dispatcher replaces bun dispatcher
- `bin/run.bun.rhachet-all.bc` - JIT handles fallback commands
- `bin/run.bun.minimal.bc` - no longer needed
- subprocess-based registry resolution - JIT handles natively

# blueprint criteria: bin-speed

mechanism bounds required to deliver the blackbox experience.

---

## blackbox criteria satisfied

- usecase.1 = run --skill executes with minimal latency ✓
- usecase.2 = roles boot executes with minimal latency ✓
- usecase.3 = roles init executes with minimal latency ✓
- usecase.4 = all other commands remain functional ✓
- edge.1 = cold start vs warm start ✓
- edge.2 = absent skill graceful failure ✓
- edge.3 = absent role graceful failure ✓
- boundary.1 = 100ms threshold definition ✓
- boundary.2 = direct invocation baseline ✓

---

## subcomponent contracts

```
given('dispatcher binary contract')
  then('parses first CLI argument to determine command')
  then('routes to command-specific binary via spawn')
  then('passes all arguments through unchanged')
  then('inherits stdio for transparent output')
  then('exits with child process exit code')
  then('adds <20ms overhead to total execution')

given('rhachet-run binary contract')
  then('handles `run` command only')
  then('discovers skills from .agent/ directory')
  then('executes skill with argument passthrough')
  then('does not load registries or brains')
  then('startup + parse completes in <50ms')

given('rhachet-roles binary contract')
  then('handles `roles` subcommands (boot, link, init, cost)')
  then('loads registries from rhachet.use.ts')
  then('does not load brains or hooks')
  then('startup + registry load completes in <50ms')

given('rhachet-all binary contract')
  then('handles all commands (ask, act, list, readme, choose, init)')
  then('loads full config: registries, brains, hooks')
  then('provides complete rhachet functionality')
  then('serves as fallback for unrecognized commands')

given('bin/run entrypoint contract')
  then('symlinks to dispatcher binary')
  then('is the default entrypoint for npx rhachet')
  then('provides same CLI interface as before')

given('bin/run.jit entrypoint contract')
  then('provides JIT (non-compiled) execution path')
  then('serves as fallback for environments without compiled binaries')
  then('maintains full functionality (slower but compatible)')
```

---

## composition boundaries

```
given('dispatcher → command binary composition')
  then('dispatcher spawns exactly one child binary per invocation')
  then('child binary handles all command logic')
  then('no shared state between dispatcher and child')
  then('composition overhead is spawn time only (~5ms)')

given('package distribution composition')
  then('package.json bin entry points to bin/run')
  then('bin/run symlinks to bin/run.bun (dispatcher)')
  then('all *.bc binaries are pre-compiled before publish')
  then('*.bc files are gitignored (built artifacts)')

given('command route composition')
  then('`run` → rhachet-run')
  then('`roles` → rhachet-roles')
  then('`*` (all other) → rhachet-all')
```

---

## integration boundaries

```
given('bun compile integration')
  then('all binaries compiled with `bun build --compile --bytecode`')
  then('bytecode suffix (.bc) distinguishes compiled from source')
  then('compilation happens at build step, not runtime')

given('rhachet.use.ts integration')
  then('rhachet-roles loads registries via dynamic import')
  then('rhachet-run does NOT load rhachet.use.ts')
  then('rhachet-all loads full config (registries + brains + hooks)')

given('filesystem integration')
  then('dispatcher resolves binary path via process.execPath')
  then('handles both real paths and symlinked execution')
  then('works cross-platform (linux, macos, windows)')
```

---

## test coverage criteria

```
given('run --skill performance')
  then('has acceptance test that measures 30-run average')
  then('fails if average overhead exceeds 100ms')

given('roles boot performance')
  then('has acceptance test that measures 30-run average')
  then('fails if average overhead exceeds 250ms')

given('roles init performance')
  then('has acceptance test that measures 30-run average')
  then('fails if average overhead exceeds 250ms')

given('backward compatibility')
  then('has acceptance tests for ask, act, list, readme, choose, init')
  then('verifies same behavior as prior version')
  then('no performance regression requirement for these commands')

given('error path performance')
  then('has acceptance test for absent skill error')
  then('has acceptance test for absent role error')
  then('verifies errors occur within 100ms overhead')
```

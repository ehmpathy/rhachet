# roadmap v2: emoji-console-shim integration

fixes omissions from v1 execution.

---

## omission analysis

| item | blueprint spec | v1 delivery | severity |
|------|---------------|-------------|----------|
| rhachet cli integration | wish: "shim console.log" | package created but never used by rhachet | **BLOCKER** |
| restore on exit | implicit: clean shutdown | not implemented | **BLOCKER** |
| root-level acceptance tests | blueprint 4.1: "acceptance tests validate exports" | only package-level tests | **BLOCKER** |
| EmojiSpaceRule domain object | blueprint 1.2 | skipped (registry works without it) | nitpick |
| test file name | `shimConsoleLog.integration.test.ts` | `shimConsoleLog.test.ts` | nitpick |

---

## phase 0: withEmojiSpaceShim wrapper

### 0.1 create withEmojiSpaceShim wrapper

- file: `src/_topublish/emoji-space-shim/src/contract/sdk/withEmojiSpaceShim.ts`
- action: create wrapper that abstracts shim lifecycle management

**contract**:
```ts
export const withEmojiSpaceShim = async <T>(
  input: { logic: () => Promise<T> },
): Promise<T> => {
  const shim = shimConsoleLog();
  try {
    return await input.logic();
  } finally {
    shim.restore();
  }
};
```

**behavior**:
- applies shim before logic executes
- restores shim after logic completes (normal exit)
- restores shim after logic throws (error exit)
- finally block guarantees restore in all paths

### 0.2 add withEmojiSpaceShim tests

- file: `src/_topublish/emoji-space-shim/src/contract/sdk/withEmojiSpaceShim.test.ts`
- cases:
  - given logic completes normally â†’ shim restored after
  - given logic throws error â†’ shim restored, error rethrown
  - given emoji logged inside logic â†’ space adjusted
  - given emoji logged after wrapper returns â†’ no adjustment (restored)

### 0.3 export withEmojiSpaceShim from package

- file: `src/_topublish/emoji-space-shim/src/index.ts`
- action: add `export { withEmojiSpaceShim } from './contract/sdk/withEmojiSpaceShim';`

### verification 0

```sh
npm run test:types
npm run test:unit -- withEmojiSpaceShim
```

---

## phase 1: rhachet cli integration

### 1.1 wrap invoke.ts with withEmojiSpaceShim

- file: `src/contract/cli/invoke.ts`
- action: wrap entire invoke logic with `withEmojiSpaceShim`

**before**:
```ts
export const invoke = async (input: { args: string[] }): Promise<void> => {
  // ... cli logic
};
```

**after**:
```ts
export const invoke = async (input: { args: string[] }): Promise<void> => {
  return withEmojiSpaceShim({
    logic: async () => {
      // ... cli logic
    },
  });
};
```

### 1.2 wrap invoke.bun.entry.run.ts with withEmojiSpaceShim

- file: `src/contract/cli/invoke.bun.entry.run.ts`
- action: wrap bun entry point logic with `withEmojiSpaceShim`
- note: bun binaries are compiled separately, must apply shim at their entry

### 1.3 wrap invoke.bun.entry.roles.ts with withEmojiSpaceShim

- file: `src/contract/cli/invoke.bun.entry.roles.ts`
- action: wrap bun entry point logic with `withEmojiSpaceShim`
- note: bun binaries are compiled separately, must apply shim at their entry

### acceptance criteria phase 1

- shim applied before any console.log in all entry points:
  - `invoke.ts` (jit path)
  - `invoke.bun.entry.run.ts` (bun path for `run`)
  - `invoke.bun.entry.roles.ts` (bun path for `roles`)
- shim restored on normal exit
- shim restored on error exit
- no manual exit handlers needed (finally block handles it)

### verification 1

```sh
npm run test:types
npm run build
```

---

## phase 2: root-level acceptance tests

### 2.1 create test infrastructure

- file: `src/accept.blackbox/emojiSpaceShim.acceptance.test.ts`
- action: create acceptance test that invokes rhachet cli and verifies emoji output

### 2.2 test cases

```ts
given('[case1] rhachet cli invoked in vscode terminal', () => {
  when('[t0] cli logs message with beaver emoji', () => {
    then('output has adjusted space after emoji');
  });
});

given('[case2] rhachet cli invoked in default terminal', () => {
  when('[t0] cli logs message with beaver emoji', () => {
    then('output is unchanged (no adjustment needed)');
  });
});

given('[case3] rhachet cli exits', () => {
  when('[t0] command completes', () => {
    then('shim is restored (console.log back to original)');
  });
});
```

### verification 2

```sh
npm run test:acceptance -- emojiSpaceShim.acceptance.test.ts
```

---

## phase 3: final verification

### 3.1 full test suite

```sh
npm run test:types
npm run test:unit -- shimConsoleLog
npm run test:acceptance -- emojiSpaceShim
```

### 3.2 manual verification

```sh
# in vscode terminal
./bin/run roles boot --repo ehmpathy --role mechanic
# verify: emojis render correctly with proper space

# verify shim restore
node -e "console.log('ðŸ¦« test')"
# verify: no shim applied (back to original behavior)
```

### 3.3 wish fulfillment

| wish criteria | verification |
|--------------|--------------|
| "shim console.log" | shim applied via withEmojiSpaceShim wrapper |
| "based on a dictionary" | uses EMOJI_SPACE_REGISTRY |
| "automatically adjust frontspaces" | transformMessageForTerminal handles it |
| "beaver emoji in vscode â†’ extra space" | tested in acceptance |
| "beaver emoji in default â†’ no change" | tested in acceptance |
| "restore on exit" | finally block in withEmojiSpaceShim guarantees restore |

---

## dependencies

```
phase 0.1 (create withEmojiSpaceShim wrapper)
    â†“
phase 0.2 (add wrapper tests)
    â†“
phase 0.3 (export wrapper from package)
    â†“
phase 1.1 (wrap invoke.ts)
    â†“
phase 1.2 (wrap invoke.bun.entry.run.ts)
    â†“
phase 1.3 (wrap invoke.bun.entry.roles.ts)
    â†“
phase 2 (root acceptance tests)
    â†“
phase 3 (final verification)
```

---

## files to create

| file | action |
|------|--------|
| `src/_topublish/emoji-space-shim/src/contract/sdk/withEmojiSpaceShim.ts` | create wrapper |
| `src/_topublish/emoji-space-shim/src/contract/sdk/withEmojiSpaceShim.test.ts` | create tests |
| `src/accept.blackbox/emojiSpaceShim.acceptance.test.ts` | create root acceptance tests |

## files to modify

| file | action |
|------|--------|
| `src/_topublish/emoji-space-shim/src/index.ts` | export withEmojiSpaceShim |
| `src/contract/cli/invoke.ts` | wrap with withEmojiSpaceShim |
| `src/contract/cli/invoke.bun.entry.run.ts` | wrap with withEmojiSpaceShim |
| `src/contract/cli/invoke.bun.entry.roles.ts` | wrap with withEmojiSpaceShim |

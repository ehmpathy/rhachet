# research: remote access for emoji-console-shim

## summary

the emoji-console-shim feature requires access to **no external remote repositories** (databases, APIs, filesystems). all required data is available locally via:

1. **process environment variables** - terminal detection
2. **in-memory dictionary** - emoji space rules
3. **console.log override** - runtime shim

this is a purely local, runtime solution with no external dependencies.

---

## 1. terminal environment detection

### 1.1 detect vscode integrated terminal

**contract**: `process.env.TERM_PROGRAM`

**interface**: Node.js `process.env` object (built-in)

vscode sets the `TERM_PROGRAM` environment variable to `"vscode"` when active in its integrated terminal [1][2][3].

> "VS Code sets the `TERM_PROGRAM` environment variable to 'vscode' in its integrated terminal." [1]

> "[[ "$TERM_PROGRAM" == "vscode" ]] && . "$(code --locate-shell-integration-path bash)"" [2]

> "The feature was implemented in **July 2017** (milestone: July 2017). The issue was opened on June 26, 2017, and resolved via PR #30346 on July 10, 2017." [3]

**detection pattern**:
```ts
const isVscodeTerminal = process.env.TERM_PROGRAM === 'vscode';
```

### 1.2 additional environment variables

| variable | value in vscode | notes |
|----------|-----------------|-------|
| `TERM_PROGRAM` | `"vscode"` | primary detection method [1][2][3] |
| `TERM_PROGRAM_VERSION` | version string | available since july 2017 [3] |
| `TERM` | varies | typically `xterm-256color` |
| `COLORTERM` | varies | color capability indicator |

> "VS Code also provides a `TERM_PROGRAM_VERSION` variable for the integrated terminal." [3]

### 1.3 best practice for terminal detection

> "these sequences should be ignored by other terminals, but it's recommended to check that `$TERM_PROGRAM` is 'vscode' before write them." [2]

---

## 2. console.log shim

### 2.1 contract

**interface**: override `console.log` function at runtime

**pattern**: IIFE (immediately invoked function expression) with closure

> "Tim Caswell recommends use of `console.log` directly, and if you need to redirect output elsewhere, 'override the function.'" [4]

### 2.2 implementation pattern

```ts
console.log = (function() {
  var orig = console.log;
  return function() {
    // ... transform arguments ...
    orig.apply(console, arguments);
  };
})();
```

> "This pattern: preserves the original function stored in a variable, uses `apply()` to handle arguments dynamically, with all provided parameters passed through." [4]

### 2.3 available packages

| package | purpose |
|---------|---------|
| `override-console-log` | generic console.log override utility [5] |
| `process-console-log` | override console.log in child processes [5] |

> "You can start use of override-console-log in your project via `npm i override-console-log`." [5]

---

## 3. emoji width

### 3.1 the core problem

> "Because of the combination of Unicode and Emoji characters, it is difficult to calculate the actual display width of a string in Terminal application. Strictly, there is no universal method to do that." [6]

> "Some emoji only advance 1 cell but occupy 2 cells, which causes overlap with the next character. Most emoji are recognised as 2 cells, but many are not." [7]

### 3.2 variation selector-16 (U+FE0F)

> "Variation Selector-16 (U+FE0F) is an invisible codepoint which specifies that the previous character should be displayed with emoji presentation." [8]

> "In 'text' style, emojis should appear without color in a single cell (Narrow), while in 'emoji' style, they should display in color and occupy two cells (Wide)." [6]

> "'Variation Selector-16' (VS-16 U+FE0F) is a special character that, for specific 'Narrow' emojis that consume one cell, causes them to become 'Wide', with two cells consumed." [6]

### 3.3 terminal inconsistencies

> "macOS Terminal.app renders most emoji as 2 characters, but emoji created with Variation Selector-16 (U+FE0F) are still rendered as 1 character." [8]

> "Hyper and Visual Studio Code both get all emoji up to and with Unicode 12 right but fail for Unicode versions 13, 14, and 15." [7]

> "Hyper and Visual Studio Code (built on xterm.js) provide support only up to Unicode release 12.1.0 (2019)." [6]

### 3.4 xterm.js (vscode's terminal backend)

> "In xterm.js v3, emojis seem to take up two cells. Use of the arrow keys jumps two cells instead of one. Delete also clears two cells." [7]

> "xterm.js may call it Unicode '11', but the data really seems to come from Unicode 12." [7]

> "VS Code currently supports Unicode version 6 and 11 widths, configurable with the `terminal.integrated.unicodeVersion` option." [7]

---

## 4. available npm packages for width calculation

### 4.1 `wcwidth`

> "`wcwidth()` and its string version, `wcswidth()` are defined by IEEE Std 1002.1-2001, a.k.a. POSIX.1-2001, and return the number of columns used to represent the given wide character and string." [9]

### 4.2 `string-width` (sindresorhus)

> "The wcwidth package is similar to string-width in that it provides functionality to determine the number of terminal column cells a wide-character string will occupy." [9]

### 4.3 `get-east-asian-width` (sindresorhus)

> "Unlike other similar packages, this package uses the latest Unicode data (which changes each year)." [10]

> "It provides an `ambiguousAsWide` option (boolean, default: false) that determines whether to treat an 'ambiguous' character as wide." [10]

### 4.4 `@topcli/wcwidth`

> "The package demonstrates that while `'한'.length` returns 1, `wcwidth('한')` returns 2, with proper account for wide character display width in terminals." [9]

### 4.5 `@nxmix/string-visual-width`

> "calculates visual width by: strip of all ANSI codes, normalize Unicode characters (e.g., n\u0303 becomes ñ), use of `@nxmix/emoji-seq-match` to match joined Emoji characters and calculate their width as 2, and use of `@nxmix/is-full-width` to determine which characters should be treated as East Asian characters with a width of 2." [6]

---

## 5. east asian width categories

> "East Asian Ambiguous (A) characters are defined as 'all characters that can be sometimes wide and sometimes narrow.'" [10]

| category | code | description |
|----------|------|-------------|
| Fullwidth | F | always 2 cells |
| Wide | W | always 2 cells |
| Halfwidth | H | always 1 cell |
| Narrow | Na | always 1 cell |
| Ambiguous | A | context-dependent (1 or 2 cells) |
| Neutral | N | depends on render context |

> "Most emojis have Neutral value as their East Asian Width properties, but some suggest they should be Wide or Ambiguous because these emojis come from Japanese legacy proprietary character sets." [10]

---

## 6. conclusion: no remote access required

the emoji-console-shim implementation requires:

| component | access type | source |
|-----------|-------------|--------|
| terminal detection | local env | `process.env.TERM_PROGRAM` |
| emoji dictionary | local memory | hardcoded or config file |
| console.log shim | local runtime | js function override |
| width calculation | optional npm | `wcwidth`, `string-width`, etc. |

**no external APIs, databases, or network calls are needed.**

---

## citations

[1] [VSCode Shell Integration Docs](https://code.visualstudio.com/docs/terminal/shell-integration) - "VS Code sets the TERM_PROGRAM environment variable to 'vscode'"

[2] [VSCode Terminal Shell Integration](https://code.visualstudio.com/docs/terminal/shell-integration) - shell integration patterns

[3] [GitHub: microsoft/vscode#29426](https://github.com/Microsoft/vscode/issues/29426) - "TERM_PROGRAM environment variable in VSCode - implemented July 2017"

[4] [Override console.log in Node.js](https://techsparx.com/nodejs/howto/console.log.html) - "Tim Caswell recommends... override the function"

[5] [Web Search: Node.js shim console.log](https://www.npmjs.com/package/override-console-log) - available npm packages

[6] [Terminal Emulators Battle Royale – Unicode Edition](https://www.jeffquast.com/post/ucs-detect-test-results/) - "difficult to calculate the actual display width of a string"

[7] [GitHub: microsoft/vscode#66125](https://github.com/microsoft/vscode/issues/66125) - "Unicode and emojis in terminal are sometimes the wrong width"

[8] [Emojipedia: Variation Selector-16](https://emojipedia.org/variation-selector-16) - "invisible codepoint which specifies emoji presentation"

[9] [npm: wcwidth](https://www.npmjs.com/package/wcwidth) - "IEEE Std 1002.1-2001"

[10] [npm: get-east-asian-width](https://www.npmjs.com/package/get-east-asian-width) - "uses the latest Unicode data"

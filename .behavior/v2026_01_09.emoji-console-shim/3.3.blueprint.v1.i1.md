# blueprint: emoji-console-shim

## overview

shim `console.log` to automatically adjust frontspaces for emojis based on terminal type.

**core insight**: terminals disagree on emoji width. a dictionary maps `emoji ‚Üí terminal ‚Üí consumed_spaces`.

---

## 1. domain objects

### 1.1 `TerminalChoice`

```
src/domain.objects/TerminalChoice.ts
```

**what**: enum of known terminal types

```ts
export type TerminalChoice = 'vscode' | 'xterm' | 'gnome' | 'default';
```

**tests**: none needed (type only)

---

### 1.2 `EmojiSpaceRule`

```
src/domain.objects/EmojiSpaceRule.ts
```

**what**: domain literal for emoji space consumption per terminal

```ts
interface EmojiSpaceRule {
  emoji: string;
  consumed: Record<TerminalChoice, number>;
}
class EmojiSpaceRule extends DomainLiteral<EmojiSpaceRule> implements EmojiSpaceRule {}
```

**tests**: `EmojiSpaceRule.test.ts` - unit test instantiation

---

### 1.3 `EmojiSpaceRegistry`

```
src/domain.objects/EmojiSpaceRegistry.ts
```

**what**: the dictionary of emoji space rules

```ts
export const EMOJI_SPACE_REGISTRY: Record<string, Record<TerminalChoice, number>> = {
  'ü¶´': { vscode: 1, default: 0 },
  'ü™®': { vscode: 1, default: 0 },
  'üå©Ô∏è': { vscode: 1, default: 1 },
  '‚õàÔ∏è': { vscode: 1, default: 1 },
  // ... extensible
};
```

**tests**: `EmojiSpaceRegistry.test.ts` - verify known emojis present

---

## 2. domain operations

### 2.1 `detectTerminalChoice`

```
src/domain.operations/terminal/detectTerminalChoice.ts
```

**what**: detect the current terminal type from environment

**contract**:
```ts
export const detectTerminalChoice = (): TerminalChoice => {
  if (process.env.TERM_PROGRAM === 'vscode') return 'vscode';
  if (process.env.TERM_PROGRAM === 'gnome-terminal') return 'gnome';
  if (process.env.TERM?.includes('xterm')) return 'xterm';
  return 'default';
};
```

**tests**: `detectTerminalChoice.test.ts`
- given TERM_PROGRAM=vscode ‚Üí returns 'vscode'
- given TERM_PROGRAM=gnome-terminal ‚Üí returns 'gnome'
- given TERM=xterm-256color ‚Üí returns 'xterm'
- given no relevant env vars ‚Üí returns 'default'

---

### 2.2 `computeSpaceAdjustment`

```
src/domain.operations/emoji/computeSpaceAdjustment.ts
```

**what**: compute how many spaces to add after an emoji for correct render

**contract**:
```ts
export const computeSpaceAdjustment = (input: {
  emoji: string;
  terminal: TerminalChoice;
  registry?: typeof EMOJI_SPACE_REGISTRY;
}): number => {
  const rules = input.registry ?? EMOJI_SPACE_REGISTRY;
  return rules[input.emoji]?.[input.terminal]
    ?? rules[input.emoji]?.default
    ?? 0;
};
```

**tests**: `computeSpaceAdjustment.test.ts`
- given ü¶´ + vscode ‚Üí returns 1
- given ü¶´ + default ‚Üí returns 0
- given üå©Ô∏è + vscode ‚Üí returns 1
- given üå©Ô∏è + default ‚Üí returns 1
- given unknown emoji ‚Üí returns 0

---

### 2.3 `transformMessageForTerminal`

```
src/domain.operations/emoji/transformMessageForTerminal.ts
```

**what**: transform a message string by add spaces after registered emojis

**contract**:
```ts
export const transformMessageForTerminal = (input: {
  message: string;
  terminal: TerminalChoice;
  registry?: typeof EMOJI_SPACE_REGISTRY;
}): string => {
  // for each emoji in registry, find occurrences and add spaces
};
```

**algorithm**:
1. iterate through registered emojis
2. for each emoji found in message:
   - compute space adjustment
   - insert N spaces after emoji (preserves any present spaces)
3. return transformed message

**tests**: `transformMessageForTerminal.test.ts`
- given "ü¶´ hello" + vscode ‚Üí "ü¶´  hello" (1 space added)
- given "ü¶´  hello" + vscode ‚Üí "ü¶´   hello" (1 space added)
- given "ü¶´ hello" + default ‚Üí "ü¶´ hello" (no change)
- given "‚õàÔ∏è woah!" + vscode ‚Üí "‚õàÔ∏è  woah!"
- given "‚õàÔ∏è woah!" + default ‚Üí "‚õàÔ∏è  woah!" (both terminals consume 1)
- given "hello world" (no emoji) ‚Üí "hello world" (no change)
- given "ü¶´ review ü™® done" + vscode ‚Üí "ü¶´  review ü™®  done" (both adjusted)

---

### 2.4 `transformConsoleArgs`

```
src/domain.operations/emoji/transformConsoleArgs.ts
```

**what**: transform console.log arguments (handles strings, objects, multiple args)

**contract**:
```ts
export const transformConsoleArgs = (input: {
  args: unknown[];
  terminal: TerminalChoice;
}): unknown[] => {
  return input.args.map((arg) => {
    if (typeof arg === 'string') {
      return transformMessageForTerminal({ message: arg, terminal: input.terminal });
    }
    return arg; // non-strings pass through unchanged
  });
};
```

**tests**: `transformConsoleArgs.test.ts`
- given ["ü¶´ hi"] + vscode ‚Üí ["ü¶´  hi"]
- given ["ü¶´ hi", { data: 1 }] ‚Üí ["ü¶´  hi", { data: 1 }]
- given [42, "ü¶´ hi", null] ‚Üí [42, "ü¶´  hi", null]

---

## 3. contract/sdk

### 3.1 `shimConsoleLog`

```
src/_topublish/emoji-space-shim/src/contract/sdk/shimConsoleLog.ts
```

**what**: apply the console.log shim at runtime

**contract**:
```ts
export const shimConsoleLog = (input?: {
  terminal?: TerminalChoice;
}): { restore: () => void } => {
  const terminal = input?.terminal ?? detectTerminalChoice();
  const originalLog = console.log;

  console.log = (...args: unknown[]) => {
    const transformed = transformConsoleArgs({ args, terminal });
    originalLog.apply(console, transformed);
  };

  return {
    restore: () => {
      console.log = originalLog;
    },
  };
};
```

**tests**: `shimConsoleLog.integration.test.ts`
- given shim applied + console.log("ü¶´ hi") in vscode ‚Üí original receives "ü¶´  hi"
- given shim applied + restore() ‚Üí original behavior restored
- given shim applied + multiple args ‚Üí all string args transformed

---

## 4. package exports

### 4.1 `index.ts`

```
src/_topublish/emoji-space-shim/src/index.ts
```

**what**: public package exports (the contract for consumers)

**exports**:
```ts
// main shim
export { shimConsoleLog } from './contract/sdk/shimConsoleLog';

// types
export type { TerminalChoice } from './domain.objects/TerminalChoice';

// registry (for extension by consumers)
export { EMOJI_SPACE_REGISTRY } from './domain.objects/EmojiSpaceRegistry';

// operations (for advanced use cases)
export { detectTerminalChoice } from './domain.operations/detectTerminalChoice';
export { computeSpaceAdjustment } from './domain.operations/computeSpaceAdjustment';
export { transformMessageForTerminal } from './domain.operations/transformMessageForTerminal';
```

**tests**: acceptance tests validate these exports work as documented

---

## 5. test coverage matrix

all tests live within the package at `src/_topublish/emoji-space-shim/`.

| layer | file | test type | location |
|-------|------|-----------|----------|
| domain.objects | TerminalChoice.ts | - | type only |
| domain.objects | EmojiSpaceRegistry.ts | unit | `src/domain.objects/` |
| domain.operations | detectTerminalChoice.ts | unit | `src/domain.operations/` |
| domain.operations | computeSpaceAdjustment.ts | unit | `src/domain.operations/` |
| domain.operations | transformMessageForTerminal.ts | unit | `src/domain.operations/` |
| domain.operations | transformConsoleArgs.ts | unit | `src/domain.operations/` |
| contract/sdk | shimConsoleLog.ts | integration | `src/contract/sdk/` |
| blackbox | shimConsoleLog | acceptance | `accept.blackbox/` |

---

## 6. acceptance tests

```
src/_topublish/emoji-space-shim/accept.blackbox/shimConsoleLog.acceptance.test.ts
```

**what**: blackbox test of the public exports (as if consumer of published package)

**cases**:
```ts
given('[case1] shim enabled in vscode terminal', () => {
  when('[t0] console.log with beaver emoji', () => {
    then('output has extra space after emoji', ...);
  });
});

given('[case2] shim enabled in default terminal', () => {
  when('[t0] console.log with beaver emoji', () => {
    then('output is unchanged', ...);
  });
});

given('[case3] shim restored', () => {
  when('[t0] console.log after restore', () => {
    then('original behavior restored', ...);
  });
});
```

---

## 7. file structure

package lives under `src/_topublish/emoji-space-shim/` for future standalone publish.

```
src/_topublish/emoji-space-shim/
‚îú‚îÄ‚îÄ readme.md
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                              # public exports
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ contract/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sdk/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ shimConsoleLog.ts             # public contract
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ shimConsoleLog.integration.test.ts  # integration
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ domain.objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TerminalChoice.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmojiSpaceRegistry.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmojiSpaceRegistry.test.ts        # unit
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ domain.operations/
‚îÇ       ‚îú‚îÄ‚îÄ detectTerminalChoice.ts
‚îÇ       ‚îú‚îÄ‚îÄ detectTerminalChoice.test.ts        # unit
‚îÇ       ‚îú‚îÄ‚îÄ computeSpaceAdjustment.ts
‚îÇ       ‚îú‚îÄ‚îÄ computeSpaceAdjustment.test.ts    # unit
‚îÇ       ‚îú‚îÄ‚îÄ transformMessageForTerminal.ts
‚îÇ       ‚îú‚îÄ‚îÄ transformMessageForTerminal.test.ts  # unit
‚îÇ       ‚îú‚îÄ‚îÄ transformConsoleArgs.ts
‚îÇ       ‚îî‚îÄ‚îÄ transformConsoleArgs.test.ts      # unit
‚îÇ
‚îî‚îÄ‚îÄ accept.blackbox/
    ‚îî‚îÄ‚îÄ shimConsoleLog.acceptance.test.ts     # acceptance (blackbox)
```

### readme.md

```md
# emoji-space-shim

shim console.log to fix emoji space render issues across terminals.

## problem

emojis render with inconsistent space across terminals:
- ü¶´ consumes 1 extra space in vscode, 0 in standard terminals
- üå©Ô∏è consumes 1 extra space in both vscode and standard terminals

## solution

\`\`\`ts
import { shimConsoleLog } from 'emoji-space-shim';

// enable shim (auto-detects terminal)
const shim = shimConsoleLog();

console.log('ü¶´ hello'); // renders correctly in all terminals

// restore original behavior
shim.restore();
\`\`\`

## api

### `shimConsoleLog(options?)`

applies the console.log shim.

**options**:
- `terminal?: TerminalChoice` - override auto-detection

**returns**: `{ restore: () => void }`

### `detectTerminalChoice()`

returns current terminal type: `'vscode' | 'xterm' | 'gnome' | 'default'`

### `EMOJI_SPACE_REGISTRY`

the emoji ‚Üí terminal ‚Üí spaces dictionary. extend for custom emojis.

## supported emojis

| emoji | vscode | default |
|-------|--------|---------|
| ü¶´ | +1 space | +0 |
| ü™® | +1 space | +0 |
| üå©Ô∏è | +1 space | +1 space |
| ‚õàÔ∏è | +1 space | +1 space |
```

---

## 8. dependencies

**none** - zero external dependencies

all logic is pure typescript with Node.js built-ins only:
- `process.env` for terminal detection
- `console.log` override via closure

---

## 9. extensibility

### add new emoji

edit `EmojiSpaceRegistry.ts`:
```ts
export const EMOJI_SPACE_REGISTRY = {
  // ... present emojis
  'üÜï': { vscode: 1, default: 0 },  // add new entry
};
```

### add new terminal

1. add to `TerminalChoice`:
   ```ts
   export type TerminalChoice = 'vscode' | 'xterm' | 'gnome' | 'iterm' | 'default';
   ```

2. add detection in `detectTerminalChoice`:
   ```ts
   if (process.env.TERM_PROGRAM === 'iTerm.app') return 'iterm';
   ```

3. add rules per emoji in registry:
   ```ts
   'ü¶´': { vscode: 1, iterm: 0, default: 0 },
   ```

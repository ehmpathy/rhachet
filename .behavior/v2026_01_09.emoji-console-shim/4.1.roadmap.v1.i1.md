# roadmap: emoji-console-shim

execution plan for `.behavior/v2026_01_09.emoji-console-shim/3.3.blueprint.v1.i1.md`

---

## phase 0: scaffold package

- [ ] **0.1** create package directory structure
  - create `src/_topublish/emoji-space-shim/`
  - create `src/_topublish/emoji-space-shim/src/`
  - create `src/_topublish/emoji-space-shim/src/domain.objects/`
  - create `src/_topublish/emoji-space-shim/src/domain.operations/`
  - create `src/_topublish/emoji-space-shim/src/contract/sdk/`
  - create `src/_topublish/emoji-space-shim/accept.blackbox/`

  **verify**: `ls -la src/_topublish/emoji-space-shim/` shows expected structure

---

## phase 1: domain objects

no external dependencies. foundation layer.

- [ ] **1.1** implement `TerminalChoice`
  - file: `src/_topublish/emoji-space-shim/src/domain.objects/TerminalChoice.ts`
  - export: `type TerminalChoice = 'vscode' | 'xterm' | 'gnome' | 'default'`

  **acceptance**: type compiles without error
  **verify**: `npm run test:types` passes

- [ ] **1.2** implement `EmojiSpaceRegistry`
  - file: `src/_topublish/emoji-space-shim/src/domain.objects/EmojiSpaceRegistry.ts`
  - export: `EMOJI_SPACE_REGISTRY` with entries for ğŸ¦«, ğŸª¨, ğŸŒ©ï¸, â›ˆï¸

  **acceptance**: registry contains all documented emojis with correct terminal rules
  **verify**: unit test `EmojiSpaceRegistry.test.ts` passes

- [ ] **1.3** implement `EmojiSpaceRegistry.test.ts`
  - file: `src/_topublish/emoji-space-shim/src/domain.objects/EmojiSpaceRegistry.test.ts`
  - cases:
    - given registry â†’ ğŸ¦« entry exists with vscode=1, default=0
    - given registry â†’ ğŸª¨ entry exists with vscode=1, default=0
    - given registry â†’ ğŸŒ©ï¸ entry exists with vscode=1, default=1
    - given registry â†’ â›ˆï¸ entry exists with vscode=1, default=1

  **verify**: `npm run test:unit -- EmojiSpaceRegistry.test.ts` passes

---

## phase 2: domain operations - terminal detection

depends on: phase 1 (TerminalChoice)

- [ ] **2.1** implement `detectTerminalChoice`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/detectTerminalChoice.ts`
  - reads `process.env.TERM_PROGRAM` and `process.env.TERM`
  - returns appropriate `TerminalChoice`

  **acceptance**: correctly identifies vscode, gnome, xterm, and defaults
  **verify**: unit test passes

- [ ] **2.2** implement `detectTerminalChoice.test.ts`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/detectTerminalChoice.test.ts`
  - cases:
    - given TERM_PROGRAM=vscode â†’ returns 'vscode'
    - given TERM_PROGRAM=gnome-terminal â†’ returns 'gnome'
    - given TERM=xterm-256color â†’ returns 'xterm'
    - given no relevant env vars â†’ returns 'default'
    - given TERM_PROGRAM=vscode AND TERM=xterm â†’ returns 'vscode' (priority)

  **verify**: `npm run test:unit -- detectTerminalChoice.test.ts` passes

---

## phase 3: domain operations - space computation

depends on: phase 1 (EmojiSpaceRegistry, TerminalChoice)

- [ ] **3.1** implement `computeSpaceAdjustment`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/computeSpaceAdjustment.ts`
  - lookup emoji in registry for given terminal
  - fallback to `default` terminal if specific not found
  - fallback to 0 if emoji not in registry

  **acceptance**: returns correct space count for known and unknown emojis
  **verify**: unit test passes

- [ ] **3.2** implement `computeSpaceAdjustment.test.ts`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/computeSpaceAdjustment.test.ts`
  - cases:
    - given ğŸ¦« + vscode â†’ returns 1
    - given ğŸ¦« + default â†’ returns 0
    - given ğŸŒ©ï¸ + vscode â†’ returns 1
    - given ğŸŒ©ï¸ + default â†’ returns 1
    - given unknown emoji + vscode â†’ returns 0
    - given unknown emoji + default â†’ returns 0

  **verify**: `npm run test:unit -- computeSpaceAdjustment.test.ts` passes

---

## phase 4: domain operations - message transform

depends on: phase 3 (computeSpaceAdjustment)

- [ ] **4.1** implement `transformMessageForTerminal`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/transformMessageForTerminal.ts`
  - iterate registered emojis
  - find occurrences in message
  - insert N spaces after each occurrence

  **acceptance**: transforms messages with correct space insertion
  **verify**: unit test passes

- [ ] **4.2** implement `transformMessageForTerminal.test.ts`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/transformMessageForTerminal.test.ts`
  - cases:
    - given "ğŸ¦« hello" + vscode â†’ "ğŸ¦«  hello" (1 space added)
    - given "ğŸ¦«  hello" + vscode â†’ "ğŸ¦«   hello" (1 space added, preserves present)
    - given "ğŸ¦« hello" + default â†’ "ğŸ¦« hello" (no change)
    - given "â›ˆï¸ woah!" + vscode â†’ "â›ˆï¸  woah!"
    - given "â›ˆï¸ woah!" + default â†’ "â›ˆï¸  woah!" (both terminals need 1)
    - given "hello world" â†’ "hello world" (no emoji, no change)
    - given "ğŸ¦« review ğŸª¨ done" + vscode â†’ "ğŸ¦«  review ğŸª¨  done" (multiple emojis)

  **verify**: `npm run test:unit -- transformMessageForTerminal.test.ts` passes

---

## phase 5: domain operations - args transform

depends on: phase 4 (transformMessageForTerminal)

- [ ] **5.1** implement `transformConsoleArgs`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/transformConsoleArgs.ts`
  - map over args array
  - transform string args via `transformMessageForTerminal`
  - pass through non-strings unchanged

  **acceptance**: handles mixed argument types correctly
  **verify**: unit test passes

- [ ] **5.2** implement `transformConsoleArgs.test.ts`
  - file: `src/_topublish/emoji-space-shim/src/domain.operations/transformConsoleArgs.test.ts`
  - cases:
    - given ["ğŸ¦« hi"] + vscode â†’ ["ğŸ¦«  hi"]
    - given ["ğŸ¦« hi", { data: 1 }] + vscode â†’ ["ğŸ¦«  hi", { data: 1 }]
    - given [42, "ğŸ¦« hi", null] + vscode â†’ [42, "ğŸ¦«  hi", null]
    - given [{ emoji: "ğŸ¦«" }] + vscode â†’ [{ emoji: "ğŸ¦«" }] (object untouched)

  **verify**: `npm run test:unit -- transformConsoleArgs.test.ts` passes

---

## phase 6: contract/sdk - shim

depends on: phase 2 (detectTerminalChoice), phase 5 (transformConsoleArgs)

- [ ] **6.1** implement `shimConsoleLog`
  - file: `src/_topublish/emoji-space-shim/src/contract/sdk/shimConsoleLog.ts`
  - store original `console.log`
  - replace with transform wrapper
  - return `{ restore }` to revert

  **acceptance**: shim intercepts console.log and can be restored
  **verify**: integration test passes

- [ ] **6.2** implement `shimConsoleLog.integration.test.ts`
  - file: `src/_topublish/emoji-space-shim/src/contract/sdk/shimConsoleLog.integration.test.ts`
  - cases:
    - given shim applied with terminal=vscode + console.log("ğŸ¦« hi") â†’ original receives "ğŸ¦«  hi"
    - given shim applied + restore() + console.log("ğŸ¦« hi") â†’ original receives "ğŸ¦« hi"
    - given shim applied + console.log("ğŸ¦« hi", { x: 1 }) â†’ args transformed correctly
    - given shim applied with terminal=default + console.log("ğŸ¦« hi") â†’ original receives "ğŸ¦« hi"

  **verify**: `npm run test:integration -- shimConsoleLog.integration.test.ts` passes

---

## phase 7: package exports

depends on: all prior phases

- [ ] **7.1** implement `index.ts`
  - file: `src/_topublish/emoji-space-shim/src/index.ts`
  - export `shimConsoleLog` from contract/sdk
  - export `TerminalChoice` type
  - export `EMOJI_SPACE_REGISTRY`
  - export `detectTerminalChoice`
  - export `computeSpaceAdjustment`
  - export `transformMessageForTerminal`

  **acceptance**: all public exports are accessible from index
  **verify**: `npm run test:types` passes

---

## phase 8: acceptance tests

depends on: phase 7 (index.ts exports)

- [ ] **8.1** implement `shimConsoleLog.acceptance.test.ts`
  - file: `src/_topublish/emoji-space-shim/accept.blackbox/shimConsoleLog.acceptance.test.ts`
  - import only from package index (blackbox)
  - cases:
    - given [case1] shim enabled in vscode terminal
      - when [t0] console.log with beaver emoji â†’ output has extra space after emoji
    - given [case2] shim enabled in default terminal
      - when [t0] console.log with beaver emoji â†’ output is unchanged
    - given [case3] shim restored
      - when [t0] console.log after restore â†’ original behavior restored

  **verify**: `npm run test:acceptance -- shimConsoleLog.acceptance.test.ts` passes

---

## phase 9: readme

depends on: phase 8 (all tests pass)

- [ ] **9.1** create `readme.md`
  - file: `src/_topublish/emoji-space-shim/readme.md`
  - document: problem, solution, api, supported emojis, extensibility

  **acceptance**: readme matches blueprint section 7 content
  **verify**: file exists and matches spec

---

## phase 10: final verification

depends on: all prior phases

- [ ] **10.1** run full test suite
  - `npm run test:unit`
  - `npm run test:integration`
  - `npm run test:acceptance`
  - `npm run test:types`

  **acceptance**: all tests pass, no type errors
  **verify**: exit code 0 for all commands

- [ ] **10.2** verify wish fulfillment
  - ref: `.behavior/v2026_01_09.emoji-console-shim/0.wish.md`
  - manual verification:
    - in vscode terminal: `console.log("ğŸ¦« let's review!")` renders correctly
    - in debian terminal: same message renders correctly
    - restore() returns to original behavior

  **acceptance**: wish examples work as documented
  **verify**: visual inspection confirms correct render

---

## dependency graph

```
phase 0 (scaffold)
    â”‚
    â–¼
phase 1 (domain.objects)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼              â–¼              â”‚
phase 2         phase 3          â”‚
(terminal)      (space calc)     â”‚
    â”‚              â”‚              â”‚
    â”‚              â–¼              â”‚
    â”‚          phase 4            â”‚
    â”‚          (message)          â”‚
    â”‚              â”‚              â”‚
    â”‚              â–¼              â”‚
    â”‚          phase 5            â”‚
    â”‚          (args)             â”‚
    â”‚              â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
               phase 6
               (shim)
                   â”‚
                   â–¼
               phase 7
               (exports)
                   â”‚
                   â–¼
               phase 8
               (acceptance)
                   â”‚
                   â–¼
               phase 9
               (readme)
                   â”‚
                   â–¼
               phase 10
               (final)
```

---

## checklist summary

```
[ ] 0.1  scaffold package directory
[ ] 1.1  TerminalChoice
[ ] 1.2  EmojiSpaceRegistry
[ ] 1.3  EmojiSpaceRegistry.test.ts
[ ] 2.1  detectTerminalChoice
[ ] 2.2  detectTerminalChoice.test.ts
[ ] 3.1  computeSpaceAdjustment
[ ] 3.2  computeSpaceAdjustment.test.ts
[ ] 4.1  transformMessageForTerminal
[ ] 4.2  transformMessageForTerminal.test.ts
[ ] 5.1  transformConsoleArgs
[ ] 5.2  transformConsoleArgs.test.ts
[ ] 6.1  shimConsoleLog
[ ] 6.2  shimConsoleLog.integration.test.ts
[ ] 7.1  index.ts
[ ] 8.1  shimConsoleLog.acceptance.test.ts
[ ] 9.1  readme.md
[ ] 10.1 full test suite
[ ] 10.2 wish fulfillment
```

# criteria.blackbox: getAvailableBrains

---

# usecase.1 = getAvailableBrains standalone

## episode: discover brains from installed packages

```
given('repo with rhachet-brains-anthropic installed')
  when('getAvailableBrains() is called')
    then('returns atoms from anthropic package')
      sothat('users can see which atom brains are available')
    then('returns repls from anthropic package')
      sothat('users can see which repl brains are available')
    then('each brain has repo, slug, description, spec')
      sothat('users have full metadata for display and selection')

given('repo with multiple brain packages installed')
  when('getAvailableBrains() is called')
    then('returns atoms from all packages')
    then('returns repls from all packages')
    then('brains are deduplicated by full slug')
      sothat('no duplicate entries appear')

given('repo with no brain packages installed')
  when('getAvailableBrains() is called')
    then('returns { atoms: [], repls: [] }')
      sothat('callers can handle empty state gracefully')
    then('does not throw')
      sothat('discovery failure is not fatal')
```

## episode: context-aware discovery

```
given('custom cwd via ContextCli')
  when('getAvailableBrains(contextCli) is called')
    then('discovers brains from package.json at contextCli.cwd')
      sothat('discovery works from any directory')

given('no ContextCli provided')
  when('getAvailableBrains() is called')
    then('defaults to process.cwd()')
      sothat('zero-config usage works')
```

---

# usecase.2 = genContextBrain with discovery

## episode: discovery mode (new default)

```
given('repo with brain packages installed')
  when('genContextBrain({ choice: "anthropic/claude-code" }) is called')
    then('returns ContextBrain with discovered brains')
    then('context.brain.repl.ask resolves the chosen repl')
    then('context.brain.atom.ask resolves discovered atoms')
      sothat('users can invoke brains without manual wire-up')

given('repo with brain packages installed')
  when('genContextBrain({}) is called with no choice')
    then('returns ContextBrain with all discovered brains')
    then('context.brain.choice is null')
      sothat('users can defer choice to runtime')

given('repo with brain packages installed')
  when('genContextBrain({ choice: "nonexistent/brain" }) is called')
    then('throws BrainChoiceNotFoundError')
    then('error message lists available brains')
      sothat('users can see valid options')
```

## episode: explicit mode (opt-out of discovery)

```
given('explicit brains provided')
  when('genContextBrain({ brains: { atoms, repls }, choice }) is called')
    then('uses only the provided brains')
    then('does not discover from packages')
      sothat('authors can restrict allowed brains')

given('explicit brains with choice not in list')
  when('genContextBrain({ brains: { atoms: [a1] }, choice: "other/brain" }) is called')
    then('throws BrainChoiceNotFoundError')
    then('error lists only the explicit brains')
```

## episode: hybrid mode (discovery + custom)

```
given('user wants discovered brains plus custom brain')
  when('getAvailableBrains() then genContextBrain({ brains: { atoms: [...discovered.atoms, custom], repls } })')
    then('ContextBrain includes both discovered and custom brains')
      sothat('users can extend the discovered set')
```

---

# usecase.3 = cli help output

## episode: display available brains

```
given('user runs skill with --help')
  when('skill calls getAvailableBrains()')
    then('receives list of atoms with slug and description')
    then('receives list of repls with slug and description')
      sothat('help output can show real available options')

given('user runs skill with --help and no brain packages installed')
  when('skill calls getAvailableBrains()')
    then('receives empty lists')
      sothat('help output can show "no brains available" message')
```

---

# usecase.4 = error experiences

## episode: invalid brain package

```
given('repo with invalid rhachet-brains-* package (no exports)')
  when('getAvailableBrains() is called')
    then('skips the invalid package')
    then('returns brains from valid packages')
    then('logs a warn about the invalid package')
      sothat('discovery is resilient to bad packages')
```

## episode: package.json not found

```
given('cwd has no package.json')
  when('getAvailableBrains() is called')
    then('returns { atoms: [], repls: [] }')
      sothat('discovery fails gracefully outside npm projects')
```

---

# boundary conditions

## inputs

| input | valid range | behavior |
|-------|-------------|----------|
| `context.cwd` | valid directory path | discovers from that directory |
| `context.cwd` | invalid path | returns empty, no throw |
| `brains.atoms` | array of BrainAtom | uses provided atoms |
| `brains.repls` | array of BrainRepl | uses provided repls |
| `choice` | valid brain slug | resolves to that brain |
| `choice` | invalid slug | throws BrainChoiceNotFoundError |
| `choice` | undefined | context.brain.choice is null |

## outputs

| scenario | output |
|----------|--------|
| discovery success | `{ atoms: BrainAtom[], repls: BrainRepl[] }` |
| no packages | `{ atoms: [], repls: [] }` |
| genContextBrain success | `ContextBrain` with brain lookup methods |
| choice not found | `BrainChoiceNotFoundError` with available list |

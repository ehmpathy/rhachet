# Blueprint: Optional `--repo` for `npx rhachet roles` Commands

## Wish Summary

Enable executing `npx rhachet roles` commands without specifying `--repo` when there's only one role across all repos matching the role name. Otherwise, fail fast and require `--repo`.

## Current State

The following commands currently require `--repo`:
- `npx rhachet roles link --repo <slug> --role <slug>`
- `npx rhachet roles boot --repo <slug> --role <slug>`
- `npx rhachet briefs link --repo <slug> --role <slug>`
- `npx rhachet briefs boot --repo <slug> --role <slug>`

Each command throws `BadRequestError` if `--repo` is not provided.

## Proposed Solution

### 1. Create `inferRepoFromRole` utility

**Location:** `src/logic/invoke/inferRepoFromRole.ts`

**Purpose:** Given a role slug, scan the `.agent/` directory to find repos that have that role linked.

```typescript
/**
 * .what = infers the repo slug when only one repo has the specified role
 * .why = allows omitting --repo when there's no ambiguity
 * .how = scans .agent/repo=$repo/role=$role directories to find matches
 */
export const inferRepoFromRole = (input: {
  roleSlug: string;
}): { repoSlug: string } | { ambiguous: string[] } | { notFound: true } => {
  // 1. Read .agent/ directory
  // 2. Find all repo=* subdirectories
  // 3. For each repo, check if role=$roleSlug exists
  // 4. If exactly one match → return { repoSlug }
  // 5. If multiple matches → return { ambiguous: [...repoSlugs] }
  // 6. If no matches → return { notFound: true }
};
```

### 2. Create `resolveRepoSlug` utility

**Location:** `src/logic/invoke/resolveRepoSlug.ts`

**Purpose:** Wraps the inference logic with error handling for CLI commands.

```typescript
/**
 * .what = resolves repo slug from explicit option or inference
 * .why = centralizes the repo resolution logic for all commands
 * .how = uses explicit --repo if provided, otherwise infers from role
 */
export const resolveRepoSlug = (input: {
  explicitRepo: string | undefined;
  roleSlug: string;
}): string => {
  // 1. If explicitRepo is provided, return it
  // 2. Otherwise, call inferRepoFromRole
  // 3. If unique match → return repoSlug
  // 4. If ambiguous → throw BadRequestError listing options
  // 5. If notFound → throw BadRequestError with helpful message
};
```

### 3. Update CLI commands

Modify these files to use `resolveRepoSlug`:

| File | Changes |
|------|---------|
| `src/contract/cli/invokeRolesLink.ts` | Remove required `--repo` check, use `resolveRepoSlug` |
| `src/contract/cli/invokeRolesBoot.ts` | Remove required `--repo` check, use `resolveRepoSlug` |
| `src/contract/cli/invokeBriefsLink.ts` | Remove required `--repo` check, use `resolveRepoSlug` |
| `src/contract/cli/invokeBriefsBoot.ts` | Remove required `--repo` check, use `resolveRepoSlug` |

**Before:**
```typescript
if (!opts.repo)
  BadRequestError.throw('--repo is required (e.g., --repo ehmpathy)');
const repoSlug = opts.repo;
```

**After:**
```typescript
if (!opts.role)
  BadRequestError.throw('--role is required (e.g., --role mechanic)');
const repoSlug = resolveRepoSlug({
  explicitRepo: opts.repo,
  roleSlug: opts.role,
});
```

### 4. Error Messages

#### Ambiguous (multiple repos have the role)
```
Multiple repos have role "mechanic" linked:
  - ehmpathy
  - acme
Please specify --repo to disambiguate.
```

#### Not found (no repos have the role linked)
```
No repos have role "mechanic" linked.
Run "rhachet roles link --repo <repo> --role mechanic" first.
```

## Files to Create

1. `src/logic/invoke/inferRepoFromRole.ts` - inference logic
2. `src/logic/invoke/inferRepoFromRole.test.ts` - unit tests
3. `src/logic/invoke/resolveRepoSlug.ts` - CLI resolution wrapper
4. `src/logic/invoke/resolveRepoSlug.test.ts` - unit tests

## Files to Modify

1. `src/contract/cli/invokeRolesLink.ts`
2. `src/contract/cli/invokeRolesBoot.ts`
3. `src/contract/cli/invokeBriefsLink.ts`
4. `src/contract/cli/invokeBriefsBoot.ts`

## Testing Strategy

### Unit Tests
- `inferRepoFromRole` with 0, 1, and multiple matching repos
- `resolveRepoSlug` with explicit repo, inferred repo, and error cases

### Integration Tests
- `npx rhachet roles boot --role mechanic` (single match)
- `npx rhachet roles link --role mechanic` (single match)
- Error case when multiple repos have same role
- Error case when no repos have the role

## Edge Cases

1. **Role slug exists in registries but not linked:** The inference scans `.agent/` directory, so unlinked roles won't be found. This is correct behavior - user should link first.

2. **`.agent/` directory doesn't exist:** Return `{ notFound: true }` and guide user to link first.

3. **Special repo `.this`:** Should be included in inference scanning like any other repo.

## Backwards Compatibility

- Commands with explicit `--repo` continue to work unchanged
- Only affects behavior when `--repo` is omitted
- No changes to registries or role definitions

# blueprint: role inits

## overview

add an `inits` attribute to the Role domain object, following the same patterns as `briefs` and `skills`:
- `inits.dirs`: directories to symlink during `roles link`
- `inits.exec`: commands to execute during `roles init`

---

## 1. domain object changes

### 1.1 update `src/domain.objects/Role.ts`

add `inits` attribute to Role interface:

```ts
export interface Role {
  // ... existing fields ...

  /**
   * .what = initialization resources and commands for this role
   * .why = declares setup actions that should run once when instantiating a role
   * .how =
   *   - dirs: directory-based init scripts for linking/booting (same pattern as briefs/skills)
   *     - single { uri: string }: symlinks this dir as the full inits dir
   *     - array { uri: string }[]: symlinks each dir within the inits dir
   *   - exec: commands to execute when `npx rhachet roles init` is run
   */
  inits?: {
    dirs?: { uri: string } | { uri: string }[];
    exec?: { cmd: string }[];
  };
}
```

rationale:
- optional field - not all roles need initialization logic
- `dirs` follows exact same pattern as `briefs.dirs` and `skills.dirs`
- `exec` is an array of commands to run sequentially

---

## 2. `roles link` changes

### 2.1 update `src/contract/cli/invokeRolesLink.ts`

after linking briefs and skills, add linking for inits:

```ts
// Link inits if configured
const initsCount = role.inits?.dirs
  ? symlinkResourceDirectories({
      sourceDirs: role.inits.dirs,
      targetDir: resolve(repoRoleDir, 'inits'),
      resourceName: 'inits',
    })
  : 0;
```

update summary output:
```ts
if (initsCount > 0) console.log(`  - ${initsCount} init(s) linked`);
```

---

## 3. new `roles init` command

### 3.1 create `src/contract/cli/invokeRolesInit.ts`

new CLI subcommand that:
1. finds the role by slug
2. resolves the repo (same logic as `roles link`)
3. executes each `Role.inits.exec` command sequentially

```ts
/**
 * .what = adds the "roles init" subcommand to the CLI
 * .why = executes role initialization commands after linking
 * .how = runs Role.inits.exec commands sequentially from cwd
 */
export const invokeRolesInit = ({
  command,
  registries,
}: {
  command: Command;
  registries: RoleRegistry[];
}): void => {
  command
    .command('init')
    .description('execute role initialization commands')
    .option('--repo <slug>', 'the repository slug for the role')
    .option('--role <slug>', 'the role to initialize')
    .action(async (opts: { repo?: string; role?: string }) => {
      if (!opts.role)
        BadRequestError.throw('--role is required (e.g., --role mechanic)');

      const role = assureFindRole({ registries, slug: opts.role });
      const repo = opts.repo
        ? registries.find((r) => r.slug === opts.repo)
        : inferRepoByRole({ registries, roleSlug: opts.role });
      if (!repo)
        BadRequestError.throw(`No repo found with slug "${opts.repo}"`);

      // check if role has init commands
      const execCmds = role.inits?.exec ?? [];
      if (execCmds.length === 0) {
        console.log(``);
        console.log(`‚ö†Ô∏è  Role "${role.slug}" has no initialization commands.`);
        console.log(``);
        return;
      }

      console.log(``);
      console.log(`üöÄ Initializing role "${role.slug}" from repo "${repo.slug}"...`);
      console.log(``);

      // execute each command sequentially
      for (const { cmd } of execCmds) {
        console.log(`  ‚ñ∏ ${cmd}`);
        const result = execSync(cmd, {
          cwd: process.cwd(),
          stdio: 'inherit',
          shell: true,
        });
      }

      console.log(``);
      console.log(`‚ú® Role "${role.slug}" initialized successfully.`);
      console.log(``);
    });
};
```

### 3.2 register in `src/contract/cli/invokeRoles.ts`

add `invokeRolesInit` to the roles command registration:

```ts
import { invokeRolesInit } from './invokeRolesInit';

// ... existing code ...

// after invokeRolesLink, invokeRolesBoot, invokeRolesCost
invokeRolesInit({ command: rolesCommand, registries });
```

---

## 4. boot considerations

### 4.1 update `src/domain.operations/invoke/bootRoleResources.ts`

inits should NOT be included in boot output:
- inits are one-time setup scripts, not ongoing context
- they should be executed via `roles init`, not loaded into context

no changes needed - boot only reads from briefs/ and skills/ directories.

---

## 5. file structure result

after implementation, `.agent/` structure becomes:

```
.agent/
‚îú‚îÄ‚îÄ repo=.this/
‚îÇ   ‚îî‚îÄ‚îÄ role=any/
‚îÇ       ‚îú‚îÄ‚îÄ briefs/
‚îÇ       ‚îú‚îÄ‚îÄ skills/
‚îÇ       ‚îî‚îÄ‚îÄ inits/      # NEW: role-local init scripts
‚îî‚îÄ‚îÄ repo=$REPO/
    ‚îî‚îÄ‚îÄ role=$ROLE/
        ‚îú‚îÄ‚îÄ readme.md
        ‚îú‚îÄ‚îÄ briefs/     # symlinked
        ‚îú‚îÄ‚îÄ skills/     # symlinked
        ‚îî‚îÄ‚îÄ inits/      # NEW: symlinked
```

---

## 6. example usage

### 6.1 role declaration (in rhachet-roles-* package)

```ts
export const ROLE_MECHANIC = Role.build({
  slug: 'mechanic',
  name: 'Mechanic',
  // ... existing fields ...
  inits: {
    dirs: [{ uri: __dirname + '/.inits' }],
    exec: [
      { cmd: 'source .agent/repo=ehmpathy/role=mechanic/inits/.inits/init.claude.sh' },
    ],
  },
});
```

### 6.2 CLI workflow

```bash
# step 1: link role resources (briefs, skills, inits)
npx rhachet roles link --role mechanic

# step 2: execute role initialization commands
npx rhachet roles init --role mechanic
```

---

## 7. implementation order

1. **Role.ts** - add optional `inits` attribute to interface
2. **invokeRolesLink.ts** - add symlinking for `inits.dirs`
3. **invokeRolesInit.ts** - new file, implement `roles init` command
4. **invokeRoles.ts** - register new `invokeRolesInit`
5. **tests** - add integration tests for new functionality

---

## 8. edge cases

| case | behavior |
|------|----------|
| role has no inits | `roles link` skips inits symlink; `roles init` warns and exits |
| role has inits.dirs but no inits.exec | symlinks created, but `roles init` has nothing to run |
| role has inits.exec but no inits.dirs | exec commands run (may reference external paths) |
| exec command fails | propagate error, halt subsequent commands |
| exec command uses shell features | supported via `shell: true` in execSync |

---

## 9. security considerations

- inits dirs get same readonly+executable (0o555) treatment as briefs/skills
- exec commands run with user's shell permissions (same as manual execution)
- no sandbox isolation - trusted role packages only

---

## 10. backwards compatibility

- `inits` is optional - existing roles continue to work unchanged
- no migration needed for existing `.agent/` directories
- `roles link` is idempotent - re-running adds inits symlink safely

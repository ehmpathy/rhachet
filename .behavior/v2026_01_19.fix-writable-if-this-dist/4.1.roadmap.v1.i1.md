# roadmap: fix writable for self-referenced repo dist directories

## .overview

this roadmap executes the blueprint in `.behavior/v2026_01_19.fix-writable-if-this-dist/3.3.blueprint.v1.i1.md`

---

## .phase 0: detection function + unit tests

### 0.1 create `isPathWithinGitroot.ts`

- [ ] **task**: create `src/domain.operations/invoke/link/isPathWithinGitroot.ts`
- **depends on**: none
- **acceptance criteria**:
  - file exports `isPathWithinGitroot(input: { path: string }, context: ContextCli): boolean`
  - function uses `path.resolve()` to normalize both paths
  - function returns true when `path` starts with `gitroot + '/'` or equals `gitroot`
- **verification**: `npm run test:types` passes

### 0.2 create `isPathWithinGitroot.test.ts`

- [ ] **task**: create `src/domain.operations/invoke/link/isPathWithinGitroot.test.ts`
- **depends on**: 0.1
- **acceptance criteria**:
  - `[case1]` returns true for path inside gitroot (e.g., `/repo/dist/foo` with gitroot `/repo`)
  - `[case2]` returns false for path outside gitroot (e.g., `/tmp/node_modules/pkg`)
  - `[case3]` returns false for path with similar prefix but different root (e.g., `/repo-other/foo` vs `/repo`)
  - `[case4]` returns true when path equals gitroot exactly
- **verification**: `npm run test:unit -- isPathWithinGitroot.test.ts` passes (all 4 cases green)

---

## .phase 1: thread `ContextCli` through call chain

### 1.1 update `symlinkResourceDirectories.ts` signature

- [ ] **task**: add `context: ContextCli` param to `symlinkResourceDirectories` and internal helpers
- **depends on**: 0.1
- **acceptance criteria**:
  - `symlinkResourceDirectories(options, context: ContextCli)` signature
  - `linkSourceToTarget(input, context: ContextCli)` signature
  - function bodies unchanged (context threaded but not yet used)
- **verification**: `npm run test:types` passes

### 1.2 update `execRoleLink.ts` signature

- [ ] **task**: add `context: ContextCli` param to `execRoleLink` and pass to `symlinkResourceDirectories`
- **depends on**: 1.1
- **acceptance criteria**:
  - `execRoleLink(input, context: ContextCli)` signature
  - all calls to `symlinkResourceDirectories` pass `context`
- **verification**: `npm run test:types` passes

### 1.3 update `invokeRolesLink.ts` to pass `ContextCli`

- [ ] **task**: construct or receive `ContextCli` and pass to `execRoleLink`
- **depends on**: 1.2
- **acceptance criteria**:
  - `ContextCli` instance created with `cwd` and `gitroot`
  - passed to `execRoleLink` call
- **verification**: `npm run test:types` passes

### 1.4 update integration test mocks

- [ ] **task**: update `invokeRolesLink.integration.test.ts` to provide mock `ContextCli`
- **depends on**: 1.3
- **acceptance criteria**:
  - test setup creates valid `ContextCli` with test directory as gitroot
  - all prior test cases still pass
- **verification**: `npm run test:integration -- invokeRolesLink.integration.test.ts` passes (all prior cases green)

---

## .phase 2: add guard around `setDirectoryReadonlyExecutable`

### 2.1 import and use `isPathWithinGitroot`

- [ ] **task**: in `symlinkResourceDirectories.ts`, guard the `setDirectoryReadonlyExecutable` call
- **depends on**: 1.4, 0.2
- **acceptance criteria**:
  - import `isPathWithinGitroot` from `./isPathWithinGitroot`
  - in `linkSourceToTarget`, call `isPathWithinGitroot({ path: sourcePath }, context)`
  - only call `setDirectoryReadonlyExecutable` when `isPathWithinGitroot` returns false
- **verification**: `npm run test:types` passes

### 2.2 verify prior integration tests still pass

- [ ] **task**: run full integration test suite to ensure no regression
- **depends on**: 2.1
- **acceptance criteria**:
  - external sources (outside gitroot) still get readonly permissions (mode `0o555`)
  - all prior test assertions unchanged
- **verification**: `npm run test:integration -- invokeRolesLink.integration.test.ts` passes (all cases green, readonly assertions still valid)

---

## .phase 3: integration test for self-referenced scenario

### 3.1 add test case for source within gitroot

- [ ] **task**: extend `invokeRolesLink.integration.test.ts` with `[case-self-ref]`
- **depends on**: 2.2
- **acceptance criteria**:
  - new `given` block: "source directory is within gitroot (self-referenced)"
  - creates source dirs inside the test directory (which is gitroot)
  - after `roles link`, asserts files remain writable (mode `0o755` or `0o644`)
  - contrasts with prior tests where source is treated as external
- **verification**: `npm run test:integration -- invokeRolesLink.integration.test.ts` passes (new case green)

### 3.2 verify readonly preserved for external sources

- [ ] **task**: add explicit test case `[case-external]` if not already covered
- **depends on**: 3.1
- **acceptance criteria**:
  - test creates source outside gitroot (e.g., in `/tmp/`)
  - after `roles link`, asserts files are readonly (mode `0o555`)
  - proves security is preserved for external packages
- **verification**: `npm run test:integration -- invokeRolesLink.integration.test.ts` passes (external case green)

---

## .phase 4: acceptance test (optional)

### 4.1 create acceptance test for self-referenced repo

- [ ] **task**: create or extend `accept.blackbox/cli/roles.link.acceptance.test.ts`
- **depends on**: 3.2
- **acceptance criteria**:
  - test creates temp repo with `"package-name": "file:."` pattern in package.json
  - invokes `rhachet roles link` via cli subprocess
  - asserts `/dist` directory remains writable after link
  - simulates the exact scenario from the wish
- **verification**: `npm run test:acceptance -- roles.link.acceptance.test.ts` passes

---

## .final verification

### F.1 full test suite

- [ ] **task**: run complete test suite
- **depends on**: 3.2 (or 4.1 if acceptance test added)
- **acceptance criteria**:
  - `npm run test:types` passes
  - `npm run test:unit` passes
  - `npm run test:integration` passes
  - `npm run test:acceptance` passes (if applicable)
- **verification**: all green

### F.2 manual verification in `rhachet-roles-ehmpathy`

- [ ] **task**: test in actual self-referenced repo
- **depends on**: F.1
- **acceptance criteria**:
  - clone `rhachet-roles-ehmpathy`
  - run `npm install`
  - run `npx rhachet roles link --role mechanic`
  - run `npm install rhachet-brains-anthropic` (or any package)
  - no `EACCES: permission denied` errors
- **verification**: `npm install` succeeds without permission errors

---

## .dependency graph

```
0.1 ─────────────────────┐
                         ├──▶ 1.1 ──▶ 1.2 ──▶ 1.3 ──▶ 1.4 ──▶ 2.1 ──▶ 2.2 ──▶ 3.1 ──▶ 3.2 ──▶ F.1 ──▶ F.2
0.2 (depends on 0.1) ────┘                              │
                                                        └──▶ (optional) 4.1 ──▶ F.1
```

---

## .summary checklist

| phase | task | status |
|-------|------|--------|
| 0.1 | create `isPathWithinGitroot.ts` | [ ] |
| 0.2 | create `isPathWithinGitroot.test.ts` | [ ] |
| 1.1 | update `symlinkResourceDirectories.ts` signature | [ ] |
| 1.2 | update `execRoleLink.ts` signature | [ ] |
| 1.3 | update `invokeRolesLink.ts` to pass `ContextCli` | [ ] |
| 1.4 | update integration test mocks | [ ] |
| 2.1 | import and use `isPathWithinGitroot` | [ ] |
| 2.2 | verify prior integration tests still pass | [ ] |
| 3.1 | add test case for source within gitroot | [ ] |
| 3.2 | verify readonly preserved for external sources | [ ] |
| 4.1 | (optional) create acceptance test | [ ] |
| F.1 | full test suite | [ ] |
| F.2 | manual verification | [ ] |

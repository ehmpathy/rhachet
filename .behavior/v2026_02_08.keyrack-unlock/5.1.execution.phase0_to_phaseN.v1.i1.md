# execution: keyrack key grades & os.daemon unlock

> track progress through roadmap phases

---

## phase A: milestone.1 — domain objects

```
status: [x] complete

tasks:
├─ [x] create KeyrackKeySecret (alias to string)
├─ [x] create KeyrackKeyGrade (protection + duration)
├─ [x] create KeyrackKey (secret + grade bundle)
├─ [x] create KeyrackDaemonCommand (UNLOCK, GET, STATUS, RELOCK)
├─ [x] update KeyrackHostVault (add 'os.daemon')
├─ [x] update KeyrackGrantMechanism (add PERMANENT_VIA_*, EPHEMERAL_VIA_* prefixes)
├─ [x] update KeyrackKeyGrant (value → key: KeyrackKey, add expiresAt)
├─ [x] create vaultAdapterOsDaemon stub
├─ [x] update genKeyrackGrantContext (add os.daemon + new mech names)
├─ [x] update genKeyrackHostContext (add os.daemon)
├─ [x] update getKeyrackKeyGrant (value → key with grade inference)
├─ [x] update all test files (add os.daemon + new mech names)
└─ [x] verify types compile (npm run test:types) — passed
└─ [x] verify unit tests pass (78 tests) — passed
```

---

## phase B: milestone.2 + milestone.3 — grades + daemon infra

```
status: [x] complete

milestone.2 (grades):
├─ [x] create grades/ directory
├─ [x] create inferKeyGrade
├─ [x] create detectKeyGradeChange
├─ [x] create assertKeyGradeProtected
└─ [x] write unit tests (26 tests)

milestone.3 (daemon infra):
├─ [x] create daemon/infra/ directory
├─ [x] create getLoginSessionId
├─ [x] create getKeyrackDaemonSocketPath
└─ [x] write unit tests (12 tests)
└─ [x] verify types compile (npm run test:types) — passed
└─ [x] verify unit tests pass (131 tests) — passed
```

---

## phase C: milestone.4 — daemon svc

```
status: [x] complete

tasks:
├─ [x] install dependencies (simple-in-memory-cache, xdg-basedir, daemonize-process)
├─ [x] create daemon/svc/ directory structure
├─ [x] create daemonKeyStore
├─ [x] create getSocketPeerPid
├─ [x] create verifyCallerLoginSession
├─ [x] create command handlers (unlock, get, status, relock)
├─ [x] create handleKeyrackDaemonConnection
├─ [x] create createKeyrackDaemonServer
├─ [x] create startKeyrackDaemon
├─ [x] create index.ts
└─ [x] write unit tests (24 tests)
└─ [x] verify types compile (npm run test:types) — passed
└─ [x] verify unit tests pass (155 tests) — passed
```

---

## phase D: milestone.5 — daemon sdk

```
status: [x] complete

tasks:
├─ [x] create daemon/sdk/ directory structure
├─ [x] create connectToKeyrackDaemon
├─ [x] create sendKeyrackDaemonCommand
├─ [x] create daemon access operations (unlock, get, status, relock)
├─ [x] create findsertKeyrackDaemon
└─ [x] create index.ts
└─ [x] verify types compile (npm run test:types) — passed
└─ [x] verify unit tests pass (155 tests) — passed
```

---

## phase E: milestone.6 — daemon integration tests

```
status: [x] complete

tasks:
├─ [x] test daemon lifecycle
├─ [x] test all commands
└─ [x] verify integration tests pass (15 tests)
```

---

## phase F: milestone.7 + milestone.9 — session ops + grant flow

```
status: [ ] queued

milestone.7 (session ops):
├─ [ ] create session/ directory
├─ [ ] move unlockKeyrackVault to vault/
├─ [ ] create unlockKeyrack
├─ [ ] create relockKeyrack
├─ [ ] create getKeyrackStatus
└─ [ ] write unit tests

milestone.9 (grant flow):
├─ [ ] create vaultAdapterOsDaemon
├─ [ ] update genKeyrackGrantContext
├─ [ ] update getKeyrackKeyGrant
└─ [ ] verify grant flow works
```

---

## phase G: milestone.8 — cli commands

```
status: [ ] queued

tasks:
├─ [ ] create unlock command
├─ [ ] create relock command
├─ [ ] create status command
├─ [ ] update get command (remove --unlock)
└─ [ ] register commands
```

---

## phase H: milestone.10 — acceptance tests

```
status: [ ] queued

tasks:
├─ [ ] write acceptance tests for all usecases
└─ [ ] verify all tests pass
```

---

## phase I: milestone.11 — cleanup

```
status: [ ] queued

tasks:
├─ [ ] remove dead code
├─ [ ] verify lint/format
├─ [ ] run full test suite
└─ [ ] manual smoke test
```

---

## log

```
2026-02-08: began execution, start phase A
2026-02-08: complete phase A — domain objects
  - created KeyrackKeySecret, KeyrackKeyGrade, KeyrackKey, KeyrackDaemonCommand
  - updated KeyrackHostVault, KeyrackGrantMechanism, KeyrackKeyGrant
  - created vaultAdapterOsDaemon stub
  - updated grant context and host context with new vault/mech types
  - updated getKeyrackKeyGrant to use key with grade inference (toKeyrackKey helper)
  - fixed all test files to include os.daemon and new mechanism names
  - types compile, 78 unit tests pass
2026-02-08: complete phase B — grades + daemon infra
  - created grades/ directory with inferKeyGrade, detectKeyGradeChange, assertKeyGradeProtected
  - grade inference: vault → protection, mechanism → duration, os.daemon → transient override
  - grade change detection: identifies protection/duration degradation
  - created daemon/infra/ with getLoginSessionId, getKeyrackDaemonSocketPath
  - getLoginSessionId reads /proc/$PID/sessionid (kernel-managed login session)
  - getKeyrackDaemonSocketPath uses XDG_RUNTIME_DIR + sessionid for socket path
  - types compile, 131 unit tests pass
2026-02-08: complete phase C — daemon svc
  - installed dependencies: simple-in-memory-cache, xdg-basedir, daemonize-process
  - created daemon/svc/ directory with layered structure (contract, domain.operations, domain.objects, infra)
  - daemonKeyStore: in-memory Map with TTL enforcement on read (lazy purge)
  - getSocketPeerPid: shell-based peer PID lookup via /proc/self/fd + ss
  - verifyCallerLoginSession: checks caller sessionid matches daemon sessionid
  - command handlers: handleUnlockCommand, handleGetCommand, handleStatusCommand, handleRelockCommand
  - handleKeyrackDaemonConnection: json protocol over unix socket, auth + dispatch
  - createKeyrackDaemonServer: net.createServer wrapper with cleanup
  - startKeyrackDaemon: background spawn with pid file and signal handlers
  - types compile, 155 unit tests pass
2026-02-08: complete phase D — daemon sdk
  - created daemon/sdk/ with layered structure (domain.operations, infra)
  - connectToKeyrackDaemon: unix socket client with promise wrapper
  - isDaemonReachable: liveness check for daemon
  - sendKeyrackDaemonCommand: json protocol request/response handler
  - daemonAccessUnlock, daemonAccessGet, daemonAccessStatus, daemonAccessRelock
  - findsertKeyrackDaemon: start daemon if absent, wait for reachability
  - types compile, 155 unit tests pass
2026-02-08: complete phase E — daemon integration tests
  - created daemon.integration.test.ts with 15 tests across 5 cases
  - case1: daemon server lifecycle (socket exists, reachable, empty keyStore)
  - case2: daemon commands (UNLOCK, GET, STATUS, RELOCK with specific/all keys)
  - case3: daemon not reachable (GET/STATUS/RELOCK return null)
  - case4: expired keys (not returned by GET/STATUS)
  - case5: TTL extension on re-unlock
  - all 15 integration tests pass
```

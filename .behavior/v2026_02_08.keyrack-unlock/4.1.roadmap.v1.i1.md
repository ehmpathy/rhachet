# roadmap: keyrack key grades & os.daemon unlock

> implementation roadmap derived from blueprint v1.i1

---

## milestone.1: domain objects

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (domain object decomposition section)
└─ .behavior/v2026_02_08.keyrack-unlock/1.vision.md (key grades section)

scope:
├─ src/domain.objects/keyrack/KeyrackKeySecret.ts
├─ src/domain.objects/keyrack/KeyrackKeyGrade.ts
├─ src/domain.objects/keyrack/KeyrackKey.ts
├─ src/domain.objects/keyrack/KeyrackDaemonCommand.ts
├─ src/domain.objects/keyrack/KeyrackHostVault.ts      [UPDATE]
├─ src/domain.objects/keyrack/KeyrackGrantMechanism.ts [UPDATE]
└─ src/domain.objects/keyrack/KeyrackKeyGrant.ts       [UPDATE]

tasks:
├─ [ ] create KeyrackKeySecret (alias to string)
├─ [ ] create KeyrackKeyGrade (protection + duration)
├─ [ ] create KeyrackKey (secret + grade bundle)
├─ [ ] create KeyrackDaemonCommand (UNLOCK, GET, STATUS, RELOCK)
├─ [ ] update KeyrackHostVault (add 'os.daemon')
├─ [ ] update KeyrackGrantMechanism (add PERMANENT_VIA_*, EPHEMERAL_VIA_* prefixes)
├─ [ ] update KeyrackKeyGrant (value → key: KeyrackKey, add expiresAt)
└─ [ ] verify types compile (npm run test:types)

acceptance:
├─ all domain objects created/updated
├─ types compile without errors
└─ prior tests still pass

verify:
└─ npm run test:types && npm run test:unit
```

---

## milestone.2: grade inference + enforcement

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (grade inference rules section)
└─ .behavior/v2026_02_08.keyrack-unlock/1.vision.md (the grade ladder section)

scope:
├─ src/domain.operations/keyrack/grades/inferKeyGrade.ts
├─ src/domain.operations/keyrack/grades/detectKeyGradeChange.ts
├─ src/domain.operations/keyrack/grades/assertKeyGradeProtected.ts
└─ src/domain.operations/keyrack/grades/*.test.ts

tasks:
├─ [ ] create grades/ directory
├─ [ ] create inferKeyGrade (vault + mechanism → grade)
│      ├─ os.secure → encrypted
│      ├─ os.direct → plaintext
│      ├─ os.daemon → encrypted + transient
│      ├─ PERMANENT_VIA_* → permanent
│      └─ EPHEMERAL_VIA_* → ephemeral
├─ [ ] create detectKeyGradeChange (source vs target → { degrades, reason })
├─ [ ] create assertKeyGradeProtected (throw GradeDegradationError if degrades)
├─ [ ] write unit tests for each
└─ [ ] verify all tests pass

acceptance:
├─ grade inference works for all vault + mechanism combos
├─ degradation detection catches all forbidden transitions
│  ├─ encrypted → plaintext = degrades
│  ├─ permanent → ephemeral = degrades
│  └─ ephemeral → transient = degrades
└─ unit tests pass

verify:
└─ npm run test:unit -- grades
```

---

## milestone.3: daemon infra (shared)

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (codepaths section)
├─ .behavior/v2026_02_08.keyrack-unlock/3.1.research.access._.v1.i1.md (sessionid, XDG_RUNTIME_DIR)
└─ .behavior/v2026_02_08.keyrack-unlock/.refs/eval.peercred-native-vs-shell.md

scope:
├─ src/domain.operations/keyrack/daemon/infra/getLoginSessionId.ts
├─ src/domain.operations/keyrack/daemon/infra/getKeyrackDaemonSocketPath.ts
└─ src/domain.operations/keyrack/daemon/infra/*.test.ts

tasks:
├─ [ ] create daemon/infra/ directory
├─ [ ] create getLoginSessionId({ pid }) → read /proc/$PID/sessionid
├─ [ ] create getKeyrackDaemonSocketPath() → XDG_RUNTIME_DIR + sessionid
├─ [ ] write unit tests
│      ├─ getLoginSessionId reads sessionid correctly
│      ├─ getKeyrackDaemonSocketPath uses XDG_RUNTIME_DIR when set
│      └─ getKeyrackDaemonSocketPath falls back to /run/user/$UID
└─ [ ] verify tests pass

acceptance:
├─ can read login session id for any pid
├─ socket path resolves correctly
└─ unit tests pass

verify:
└─ npm run test:unit -- daemon/infra
```

---

## milestone.4: daemon svc (server)

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (path.3: daemon server request handler)
├─ .behavior/v2026_02_08.keyrack-unlock/3.1.research.patterns._.oss.levers.v1.i1.md (dependencies)
├─ .behavior/v2026_02_08.keyrack-unlock/.refs/eval.peercred-native-vs-shell.md (getSocketPeerPid impl)
└─ .behavior/v2026_02_08.keyrack-unlock/.refs/vault.os-daemon.md (daemon architecture)

scope:
├─ src/domain.operations/keyrack/daemon/svc/index.ts
├─ src/domain.operations/keyrack/daemon/svc/src/contract/startKeyrackDaemon.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.objects/daemonKeyStore.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.operations/handleKeyrackDaemonConnection.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.operations/verifyCallerLoginSession.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.operations/handleUnlockCommand.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.operations/handleGetCommand.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.operations/handleStatusCommand.ts
├─ src/domain.operations/keyrack/daemon/svc/src/domain.operations/handleRelockCommand.ts
├─ src/domain.operations/keyrack/daemon/svc/src/infra/createKeyrackDaemonServer.ts
└─ src/domain.operations/keyrack/daemon/svc/src/infra/getSocketPeerPid.ts

dependencies:
├─ [ ] npm install simple-in-memory-cache
├─ [ ] npm install xdg-basedir@4.0.0
└─ [ ] npm install daemonize-process

tasks:
├─ [ ] create daemon/svc/ directory structure
├─ [ ] create daemonKeyStore (in-memory Map with TTL)
│      ├─ set(slug, { key, expiresAt })
│      ├─ get(slug) → key or null if expired
│      ├─ entries() → all keys with TTL left
│      ├─ delete(slug)
│      └─ clear()
├─ [ ] create getSocketPeerPid({ socket }) → shell-based via ss
├─ [ ] create verifyCallerLoginSession({ socket }) → peer pid + sessionid check
├─ [ ] create handleUnlockCommand({ keys, duration })
├─ [ ] create handleGetCommand({ slugs })
├─ [ ] create handleStatusCommand()
├─ [ ] create handleRelockCommand({ slugs? })
├─ [ ] create handleKeyrackDaemonConnection (auth + dispatch)
├─ [ ] create createKeyrackDaemonServer({ socketPath })
├─ [ ] create startKeyrackDaemon (fork to background)
├─ [ ] create index.ts (public contract: { start })
├─ [ ] write unit tests for daemonKeyStore
├─ [ ] write unit tests for getSocketPeerPid
└─ [ ] verify tests pass

acceptance:
├─ daemon can start and listen on unix socket
├─ daemon handles all 4 commands (UNLOCK, GET, STATUS, RELOCK)
├─ daemon verifies caller login session
├─ TTL enforcement works (expired keys not returned)
└─ unit tests pass

verify:
└─ npm run test:unit -- daemon/svc
```

---

## milestone.5: daemon sdk (client)

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (path.1, path.2 codepaths)
└─ .behavior/v2026_02_08.keyrack-unlock/1.vision.md (daemon architecture section)

scope:
├─ src/domain.operations/keyrack/daemon/sdk/index.ts
├─ src/domain.operations/keyrack/daemon/sdk/src/domain.operations/findsertKeyrackDaemon.ts
├─ src/domain.operations/keyrack/daemon/sdk/src/domain.operations/daemonAccessUnlock.ts
├─ src/domain.operations/keyrack/daemon/sdk/src/domain.operations/daemonAccessGet.ts
├─ src/domain.operations/keyrack/daemon/sdk/src/domain.operations/daemonAccessStatus.ts
├─ src/domain.operations/keyrack/daemon/sdk/src/domain.operations/daemonAccessRelock.ts
├─ src/domain.operations/keyrack/daemon/sdk/src/infra/connectToKeyrackDaemon.ts
└─ src/domain.operations/keyrack/daemon/sdk/src/infra/sendKeyrackDaemonCommand.ts

tasks:
├─ [ ] create daemon/sdk/ directory structure
├─ [ ] create connectToKeyrackDaemon({ socketPath }) → net.connect
├─ [ ] create sendKeyrackDaemonCommand({ command, payload }) → send/receive json
├─ [ ] create daemonAccessUnlock({ keys, duration })
├─ [ ] create daemonAccessGet({ slugs })
├─ [ ] create daemonAccessStatus()
├─ [ ] create daemonAccessRelock({ slugs? })
├─ [ ] create findsertKeyrackDaemon() → start if absent, reuse if found
├─ [ ] create index.ts (public contract: { findsert, unlock, get, status, relock })
└─ [ ] verify types compile

acceptance:
├─ sdk can connect to daemon
├─ sdk can send all 4 commands
├─ findsert correctly starts or reuses daemon
└─ types compile

verify:
└─ npm run test:types
```

---

## milestone.6: daemon integration tests

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (test coverage section)
└─ .behavior/v2026_02_08.keyrack-unlock/2.1.criteria.blackbox.md (usecase.6: attacker isolation)

scope:
└─ src/.test/integration/keyrack/daemon.integration.test.ts

tasks:
├─ [ ] test: findsert creates daemon if absent
├─ [ ] test: findsert reuses daemon if found
├─ [ ] test: UNLOCK stores keys in daemon
├─ [ ] test: GET returns keys with valid TTL
├─ [ ] test: GET omits expired keys
├─ [ ] test: STATUS lists keys with TTL left
├─ [ ] test: RELOCK purges keys by slug
├─ [ ] test: RELOCK purges all keys
└─ [ ] verify all integration tests pass

acceptance:
├─ daemon lifecycle works end-to-end
├─ all commands work correctly
└─ integration tests pass

verify:
└─ npm run test:integration -- daemon.integration.test
```

---

## milestone.7: session operations

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (path.1: unlock flow)
├─ .behavior/v2026_02_08.keyrack-unlock/3.1.research.patterns._.code.prod.v1.i1.md (pattern.11: unlockKeyrackVault)
└─ .behavior/v2026_02_08.keyrack-unlock/1.vision.md (user experience section)

scope:
├─ src/domain.operations/keyrack/session/unlockKeyrack.ts
├─ src/domain.operations/keyrack/session/relockKeyrack.ts
├─ src/domain.operations/keyrack/session/getKeyrackStatus.ts
└─ src/domain.operations/keyrack/vault/unlockKeyrackVault.ts [MOVE]

tasks:
├─ [ ] create session/ directory
├─ [ ] create vault/ directory
├─ [ ] move unlockKeyrackVault to vault/
├─ [ ] create unlockKeyrack({ duration? })
│      ├─ findsert daemon
│      ├─ read keyrack.yml → required slugs
│      ├─ for each: unlock source vault, get secret, infer grade
│      ├─ bundle into KeyrackKey
│      └─ send to daemon with TTL
├─ [ ] create relockKeyrack({ slugs? })
├─ [ ] create getKeyrackStatus()
└─ [ ] write unit tests

acceptance:
├─ unlock populates daemon with keys
├─ default TTL is 9h
├─ custom duration sets custom TTL
├─ relock purges keys from daemon
├─ status returns unlocked keys with TTL
└─ unit tests pass

verify:
└─ npm run test:unit -- session
```

---

## milestone.8: cli commands

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (command surface section in vision)
└─ .behavior/v2026_02_08.keyrack-unlock/1.vision.md (command surface section)

scope:
├─ src/contract/cli/keyrack/unlock.ts
├─ src/contract/cli/keyrack/relock.ts
├─ src/contract/cli/keyrack/status.ts
├─ src/contract/cli/keyrack/get.ts [UPDATE]
└─ src/contract/cli/index.ts [UPDATE]

tasks:
├─ [ ] create unlock command (rhx keyrack unlock [--duration])
├─ [ ] create relock command (rhx keyrack relock [--key])
├─ [ ] create status command (rhx keyrack status)
├─ [ ] update get command (remove --unlock flag)
├─ [ ] register commands in cli index
└─ [ ] verify cli works

acceptance:
├─ rhx keyrack unlock works
├─ rhx keyrack unlock --duration 1h sets 1h TTL
├─ rhx keyrack relock works
├─ rhx keyrack relock --key AWS_SSO_PREP works
├─ rhx keyrack status works
├─ rhx keyrack get no longer has --unlock flag
└─ cli compiles

verify:
└─ npm run build && npx rhachet keyrack --help
```

---

## milestone.9: grant flow integration

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (path.2: get flow via daemon)
├─ .behavior/v2026_02_08.keyrack-unlock/3.1.research.patterns._.code.prod.v1.i1.md (pattern.6, pattern.8)
└─ .behavior/v2026_02_08.keyrack-unlock/1.vision.md (the outcome world section)

scope:
├─ src/domain.operations/keyrack/getKeyrackKeyGrant.ts [UPDATE]
├─ src/domain.operations/keyrack/adapters/vaults/vaultAdapterOsDaemon.ts
├─ src/domain.operations/keyrack/adapters/vaults/index.ts [UPDATE]
└─ src/domain.operations/keyrack/genKeyrackGrantContext.ts [UPDATE]

tasks:
├─ [ ] create vaultAdapterOsDaemon (implements KeyrackHostVaultAdapter)
│      ├─ unlock → findsert daemon
│      ├─ isUnlocked → check daemon liveness
│      ├─ get → daemon/sdk.get
│      ├─ set → daemon/sdk.unlock (single key)
│      └─ del → daemon/sdk.relock (single key)
├─ [ ] update adapters/vaults/index.ts (export vaultAdapterOsDaemon)
├─ [ ] update genKeyrackGrantContext (add os.daemon to vault adapters)
├─ [ ] update getKeyrackKeyGrant
│      ├─ check os.daemon instead of os.direct for cache
│      └─ remove cache-to-os.direct logic
└─ [ ] verify grant flow works

acceptance:
├─ get reads from daemon after unlock
├─ get falls through to source vault if not in daemon
├─ get does NOT cache to os.direct
└─ types compile

verify:
└─ npm run test:types
```

---

## milestone.10: acceptance tests

```
status: [ ]

read.first:
├─ .behavior/v2026_02_08.keyrack-unlock/2.1.criteria.blackbox.md (all usecases)
└─ .behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md (test coverage section)

scope:
├─ src/.test/integration/keyrack/unlock.integration.test.ts
├─ src/.test/integration/keyrack/get.integration.test.ts
└─ src/.test/integration/keyrack/grade.integration.test.ts

tasks:
├─ [ ] test: unlock populates daemon with keys (usecase.1)
├─ [ ] test: unlock with --duration sets custom TTL (usecase.4)
├─ [ ] test: unlock extends TTL on re-unlock (usecase.8)
├─ [ ] test: get reads from daemon after unlock (usecase.1)
├─ [ ] test: get falls through to source vault if not in daemon
├─ [ ] test: get does NOT cache to os.direct
├─ [ ] test: cross-terminal get succeeds (usecase.2)
├─ [ ] test: cross-worksite key reuse works (usecase.3)
├─ [ ] test: mid-session unlock works (usecase.5)
├─ [ ] test: set blocks degradation from encrypted to plaintext (usecase.7)
├─ [ ] test: set allows upgrade from plaintext to encrypted
├─ [ ] test: expired keys not returned (usecase.8)
└─ [ ] verify all tests pass

acceptance:
├─ all blackbox criteria from 2.1.criteria.blackbox.md covered
│  ├─ usecase.1: unlock then spawn robot
│  ├─ usecase.2: cross-terminal access
│  ├─ usecase.3: cross-worksite key reuse
│  ├─ usecase.4: custom duration
│  ├─ usecase.5: mid-session unlock
│  ├─ usecase.7: grade degradation blocked
│  ├─ usecase.8: TTL expiration
│  └─ usecase.12: default TTL
└─ all integration tests pass

verify:
└─ npm run test:integration -- keyrack
```

---

## milestone.11: cleanup + polish

```
status: [ ]

tasks:
├─ [ ] remove any dead code from os.direct cache path
├─ [ ] update inline docs/comments
├─ [ ] verify no lint errors (npm run test:lint)
├─ [ ] verify no format errors (npm run test:format)
├─ [ ] run full test suite (npm run test)
└─ [ ] manual smoke test of unlock → get → relock flow

acceptance:
├─ all tests pass
├─ no lint/format errors
├─ manual smoke test succeeds
└─ ready for review

verify:
└─ npm run test && npm run test:lint && npm run test:format
```

---

## dependency graph

```
milestone dependencies:
├─ m1 (domain objects) → foundation for all others
├─ m2 (grades) → depends on m1
├─ m3 (daemon infra) → depends on m1
├─ m4 (daemon svc) → depends on m1, m3
├─ m5 (daemon sdk) → depends on m1, m3, m4
├─ m6 (daemon integration) → depends on m4, m5
├─ m7 (session ops) → depends on m2, m5
├─ m8 (cli) → depends on m7
├─ m9 (grant flow) → depends on m2, m5
├─ m10 (acceptance) → depends on m8, m9
└─ m11 (cleanup) → depends on all

execution order (respects dependencies):
├─ phase A: m1 (domain objects)
├─ phase B: m2 + m3 (parallel: grades + daemon infra)
├─ phase C: m4 (daemon svc)
├─ phase D: m5 (daemon sdk)
├─ phase E: m6 (daemon integration tests)
├─ phase F: m7 + m9 (parallel: session ops + grant flow)
├─ phase G: m8 (cli)
├─ phase H: m10 (acceptance tests)
└─ phase I: m11 (cleanup)
```

---

## sources

- `.behavior/v2026_02_08.keyrack-unlock/3.3.blueprint.v1.i1.md` — blueprint
- `.behavior/v2026_02_08.keyrack-unlock/2.1.criteria.blackbox.md` — acceptance criteria
- `.behavior/v2026_02_08.keyrack-unlock/1.vision.md` — vision doc
- `.behavior/v2026_02_08.keyrack-unlock/3.1.research.access._.v1.i1.md` — linux security interfaces
- `.behavior/v2026_02_08.keyrack-unlock/3.1.research.patterns._.code.prod.v1.i1.md` — code patterns
- `.behavior/v2026_02_08.keyrack-unlock/3.1.research.patterns._.oss.levers.v1.i1.md` — oss dependencies
- `.behavior/v2026_02_08.keyrack-unlock/.refs/eval.peercred-native-vs-shell.md` — shell-based peer lookup
- `.behavior/v2026_02_08.keyrack-unlock/.refs/vault.os-daemon.md` — daemon architecture

# roadmap: init-roles-many

execution plan for blueprint at `.behavior/v2026_01_09.init-roles-many/3.3.blueprint.v1.i1.md`

---

## milestone.0 = domain objects

### step.0.1 = RoleSpecifier type alias

- [ ] create `src/domain.objects/RoleSpecifier.ts`
- [ ] export type alias with format documentation

**acceptance criteria**:
```
given('RoleSpecifier type alias')
  when('imported in another file')
    then('type compiles without error')
    then('jsdoc shows format examples')
```

**verification**:
```sh
npm run test:types
```

---

### step.0.2 = RoleRegistryManifest domain object

- [ ] create `src/domain.objects/RoleRegistryManifest.ts`
- [ ] define interface with slug, readme, roles[]
- [ ] add zod schema for validation

**acceptance criteria**:
```
given('RoleRegistryManifest schema')
  when('valid manifest object provided')
    then('schema validation passes')
  when('manifest lacks required field')
    then('schema validation fails with field path')
```

**verification**:
```sh
npm run test:unit -- RoleRegistryManifest
```

---

## milestone.1 = manifest operations

**deps**: milestone.0

### step.1.1 = getRoleRegistryManifest

- [ ] create `src/domain.operations/manifest/getRoleRegistryManifest.ts`
- [ ] read and parse yaml from packageRoot
- [ ] validate against schema
- [ ] create unit tests
- [ ] create integration tests

**acceptance criteria**:
```
given('a package with rhachet.repo.yml')
  when('getRoleRegistryManifest called with packageRoot')
    then('returns typed RoleRegistryManifest')

given('a package without rhachet.repo.yml')
  when('getRoleRegistryManifest called')
    then('throws helpful error with package path')

given('a package with malformed rhachet.repo.yml')
  when('getRoleRegistryManifest called')
    then('throws error with field path')
```

**verification**:
```sh
npm run test:unit -- getRoleRegistryManifest
npm run test:integration -- getRoleRegistryManifest
```

---

### step.1.2 = castManifestToRegistry

- [ ] create `src/domain.operations/manifest/castManifestToRegistry.ts`
- [ ] transform manifest roles to Role[]
- [ ] resolve paths relative to packageRoot
- [ ] add limitation comments (static refs only, no runtime logic)
- [ ] create unit tests

**acceptance criteria**:
```
given('a RoleRegistryManifest with single role')
  when('castManifestToRegistry called')
    then('returns RoleRegistry with one Role')
    then('role paths are resolved to packageRoot')

given('a RoleRegistryManifest with multiple roles')
  when('castManifestToRegistry called')
    then('returns RoleRegistry with all Roles')
```

**verification**:
```sh
npm run test:unit -- castManifestToRegistry
```

---

### step.1.3 = discoverRegistriesFromPackages

- [ ] create `src/domain.operations/manifest/discoverRegistriesFromPackages.ts`
- [ ] scan package.json for rhachet-roles-* packages
- [ ] resolve each package path in node_modules
- [ ] load manifest via getRoleRegistryManifest
- [ ] cast to registry via castManifestToRegistry
- [ ] collect errors for packages that lack manifest
- [ ] create integration tests with mock node_modules

**acceptance criteria**:
```
given('a repo with rhachet-roles-* packages in package.json')
  when('discoverRegistriesFromPackages called')
    then('returns registries from packages with rhachet.repo.yml')
    then('returns errors for packages without rhachet.repo.yml')

given('a repo with no rhachet-roles-* packages')
  when('discoverRegistriesFromPackages called')
    then('returns empty registries array')
    then('returns empty errors array')
```

**verification**:
```sh
npm run test:integration -- discoverRegistriesFromPackages
```

---

## milestone.2 = role resolution

**deps**: none (can parallel with milestone.1)

### step.2.1 = parseRoleSpecifier

- [ ] create `src/domain.operations/invoke/parseRoleSpecifier.ts`
- [ ] parse "mechanic" => { repo: null, role: "mechanic" }
- [ ] parse "ehmpathy/mechanic" => { repo: "ehmpathy", role: "mechanic" }
- [ ] create unit tests

**acceptance criteria**:
```
given('a bare role name "mechanic"')
  when('parseRoleSpecifier called')
    then('returns { repo: null, role: "mechanic" }')

given('a qualified role name "ehmpathy/mechanic"')
  when('parseRoleSpecifier called')
    then('returns { repo: "ehmpathy", role: "mechanic" }')

given('an invalid pattern "a/b/c"')
  when('parseRoleSpecifier called')
    then('throws helpful error')
```

**verification**:
```sh
npm run test:unit -- parseRoleSpecifier
```

---

### step.2.2 = resolveRoleSpecifiers

- [ ] create `src/domain.operations/invoke/resolveRoleSpecifiers.ts`
- [ ] parse each specifier via parseRoleSpecifier
- [ ] find role in registries (exact match if repo specified)
- [ ] use inferRepoByRole for unqualified specifiers
- [ ] collect all errors before fail
- [ ] create unit tests

**acceptance criteria**:
```
given('specifiers ["mechanic"] and registries with unique mechanic')
  when('resolveRoleSpecifiers called')
    then('returns resolved role from correct registry')

given('specifiers ["ehmpathy/mechanic"] and multiple registries')
  when('resolveRoleSpecifiers called')
    then('returns role from ehmpathy registry only')

given('specifiers ["mechanic"] and multiple registries with mechanic')
  when('resolveRoleSpecifiers called')
    then('returns error about ambiguous role')
    then('error lists all registries with mechanic')

given('specifiers ["nonexistent"] and registries')
  when('resolveRoleSpecifiers called')
    then('returns error about role not found')
    then('error lists available roles')
```

**verification**:
```sh
npm run test:unit -- resolveRoleSpecifiers
```

---

## milestone.3 = init --roles command

**deps**: milestone.1, milestone.2

### step.3.1 = showInitUsageInstructions

- [ ] create `src/domain.operations/init/showInitUsageInstructions.ts`
- [ ] discover registries from packages
- [ ] enumerate available roles with source package
- [ ] output usage format per blueprint
- [ ] create integration tests

**acceptance criteria**:
```
given('a repo with rhachet-roles-* packages')
  when('showInitUsageInstructions called')
    then('outputs usage format')
    then('lists available roles with package source')
    then('shows example invocations')

given('a repo with no rhachet-roles-* packages')
  when('showInitUsageInstructions called')
    then('outputs helpful message about how to install packages')
```

**verification**:
```sh
npm run test:integration -- showInitUsageInstructions
```

---

### step.3.2 = initRolesFromPackages

- [ ] create `src/domain.operations/init/initRolesFromPackages.ts`
- [ ] discover registries from packages
- [ ] validate all packages have rhachet.repo.yml
- [ ] resolve all role specifiers (fail fast if any absent/ambiguous)
- [ ] for each resolved role: link + init
- [ ] report success with summary
- [ ] create integration tests

**acceptance criteria**:
```
given('a repo with rhachet-roles-ehmpathy installed')
  when('initRolesFromPackages called with ["mechanic"]')
    then('mechanic role is linked into .agent/')
    then('mechanic init scripts are executed')
    then('success message shows mechanic initialized')

given('a repo with multiple rhachet-roles-* packages')
  when('initRolesFromPackages called with ["mechanic", "behaver"]')
    then('both roles are linked')
    then('both roles have inits executed')
    then('success message shows both roles')

given('specifiers include nonexistent role')
  when('initRolesFromPackages called')
    then('fails fast before any link/init')
    then('error lists available roles')
```

**verification**:
```sh
npm run test:integration -- initRolesFromPackages
```

---

### step.3.3 = extend invokeInit with --roles and --config

- [ ] modify `src/contract/cli/invokeInit.ts`
- [ ] add --roles option
- [ ] add --config option (undocumented)
- [ ] route to initRolesFromPackages when --roles provided
- [ ] route to generateRhachetUseTs when --config provided
- [ ] route to showInitUsageInstructions when no flags
- [ ] migrate prior integration tests to --config path
- [ ] create new integration tests for --roles path

**acceptance criteria**:
```
given('a repo with rhachet-roles-* packages')
  when('user runs `npx rhachet init --roles mechanic`')
    then('mechanic role is linked and initialized')

  when('user runs `npx rhachet init --roles mechanic behaver`')
    then('both roles are linked and initialized')

  when('user runs `npx rhachet init --config`')
    then('rhachet.use.ts is generated')

  when('user runs `npx rhachet init` with no flags')
    then('usage instructions are shown')
    then('available roles are listed')
```

**verification**:
```sh
npm run test:integration -- invokeInit
```

---

## milestone.4 = repo introspect command

**deps**: milestone.0

### step.4.1 = generateRoleRegistryManifest

- [ ] create `src/domain.operations/manifest/generateRoleRegistryManifest.ts`
- [ ] transform RoleRegistry to manifest structure
- [ ] resolve paths relative to package root
- [ ] serialize to yaml string
- [ ] create unit tests

**acceptance criteria**:
```
given('a RoleRegistry with single role')
  when('generateRoleRegistryManifest called')
    then('returns valid yaml string')
    then('yaml contains role with correct paths')

given('a RoleRegistry with multiple roles')
  when('generateRoleRegistryManifest called')
    then('yaml contains all roles')
```

**verification**:
```sh
npm run test:unit -- generateRoleRegistryManifest
```

---

### step.4.2 = invokeRepoIntrospect

- [ ] create `src/contract/cli/invokeRepoIntrospect.ts`
- [ ] register `repo introspect` command
- [ ] add --output option (default: rhachet.repo.yml, or stdout)
- [ ] dynamically import registry from package
- [ ] generate manifest via generateRoleRegistryManifest
- [ ] write to output destination
- [ ] register command in invoke.ts
- [ ] create integration tests

**acceptance criteria**:
```
given('a rhachet-roles-* package with registry export')
  when('author runs `npx rhachet repo introspect`')
    then('rhachet.repo.yml is generated at package root')
    then('yml contains all roles from registry')

  when('author runs `npx rhachet repo introspect --output stdout`')
    then('yml content is output to console')
    then('no file is written')

  when('author runs `npx rhachet repo introspect --output custom.yml`')
    then('yml is written to custom.yml path')

given('a package that is not a rhachet-roles package')
  when('author runs `npx rhachet repo introspect`')
    then('error explains package lacks registry export')
```

**verification**:
```sh
npm run test:integration -- invokeRepoIntrospect
```

---

## milestone.5 = extend roles link/init without rhachet.use.ts

**deps**: milestone.1

### step.5.1 = hasConfigExplicit utility

- [ ] create utility to check for rhachet.use.ts existence
- [ ] return boolean

**acceptance criteria**:
```
given('a repo with rhachet.use.ts')
  when('hasConfigExplicit called')
    then('returns true')

given('a repo without rhachet.use.ts')
  when('hasConfigExplicit called')
    then('returns false')
```

**verification**:
```sh
npm run test:unit -- hasConfigExplicit
```

---

### step.5.2 = extend invokeRolesLink

- [ ] modify `src/contract/cli/invokeRolesLink.ts`
- [ ] check hasConfigExplicit first (explicit path)
- [ ] fallback to discoverRegistriesFromPackages
- [ ] fail fast with BadRequestError if no registries
- [ ] update integration tests

**acceptance criteria**:
```
given('a repo with rhachet.use.ts')
  when('user runs `npx rhachet roles link --role mechanic`')
    then('role is linked from rhachet.use.ts registries')

given('a repo without rhachet.use.ts but with rhachet-roles-* packages')
  when('user runs `npx rhachet roles link --role mechanic`')
    then('role is discovered from packages')
    then('role is linked into .agent/')
    then('no error about absent rhachet.use.ts')

given('a repo without rhachet.use.ts or packages')
  when('user runs `npx rhachet roles link --role mechanic`')
    then('error explains no registries found')
    then('error suggests install packages or create rhachet.use.ts')
```

**verification**:
```sh
npm run test:integration -- invokeRolesLink
```

---

### step.5.3 = extend invokeRolesInit

- [ ] modify `src/contract/cli/invokeRolesInit.ts`
- [ ] same fallback pattern as invokeRolesLink
- [ ] update integration tests

**acceptance criteria**:
```
given('a repo without rhachet.use.ts but with linked roles')
  when('user runs `npx rhachet roles init --role mechanic`')
    then('init scripts for mechanic are executed')
    then('no error about absent rhachet.use.ts')

  when('user runs `npx rhachet roles init --role mechanic --command setup`')
    then('only "setup" init script is executed')
```

**verification**:
```sh
npm run test:integration -- invokeRolesInit
```

---

## milestone.6 = acceptance tests

**deps**: milestone.3, milestone.4, milestone.5

### step.6.1 = blackbox acceptance tests

- [ ] create acceptance test for usecase.1 (init multiple roles)
- [ ] create acceptance test for usecase.2 (disambiguation)
- [ ] create acceptance test for usecase.3 (repo introspect)
- [ ] create acceptance test for usecase.4 (roles link without rhachet.use.ts)
- [ ] create acceptance test for usecase.5 (roles init without rhachet.use.ts)
- [ ] create acceptance test for usecase.6 (rhachet.repo.yml discovery)
- [ ] create acceptance test for edge.1 (role not found)
- [ ] create acceptance test for edge.2 (partial success on init failure)
- [ ] create acceptance test for edge.3 (no packages error)
- [ ] create acceptance test for edge.4 (mixed disambiguation)
- [ ] create acceptance test for boundary.3 (backward compatibility)

**acceptance criteria**:
```
all blackbox criteria from 2.criteria.blackbox.md pass
```

**verification**:
```sh
npm run test:acceptance
```

---

## milestone.7 = documentation

**deps**: milestone.6

### step.7.1 = README updates

- [ ] document `npx rhachet init --roles` command
- [ ] document `repo/role` disambiguation pattern
- [ ] document `npx rhachet repo introspect` command
- [ ] document `rhachet.repo.yml` schema
- [ ] add example invocations

**acceptance criteria**:
```
given('a consumer who reads the README')
  then('they understand how to use `npx rhachet init --roles`')
  then('they understand disambiguation via repo/role pattern')

given('a producer who reads the README')
  then('they understand how to run `npx rhachet repo introspect`')
  then('they understand rhachet.repo.yml schema')
```

**verification**:
```
manual review of README.md
```

---

## execution order

```
milestone.0 (domain objects)
    |
    +---> milestone.1 (manifest ops) --+
    |                                  |
    +---> milestone.2 (role resolution)+---> milestone.3 (init --roles)
    |                                  |
    +---> milestone.4 (repo introspect)|
                                       |
          milestone.5 (extend link/init) <--+
                       |
                       v
              milestone.6 (acceptance tests)
                       |
                       v
              milestone.7 (documentation)
```

---

## verification summary

after each milestone:
1. run `npm run test:types` - types compile
2. run `npm run test:unit` - unit tests pass
3. run `npm run test:integration` - integration tests pass
4. run `npm run test:lint` - lint passes

after milestone.6:
5. run `npm run test:acceptance` - acceptance tests pass

after milestone.7:
6. manual review of documentation

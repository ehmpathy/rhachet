# roadmap v2: init-roles-many

execution plan for blueprint v2, with ordered dependencies and behavioral verification.

---

## phase 0: foundation — domain types

### 0.1 — RoleRegistryManifest schema validation

- [ ] extend `RoleRegistryManifest` schema to validate all required fields
- [ ] ensure `RoleManifest` includes `slug`, `readme`, `briefs.dirs`, `skills.dirs`, `inits.dirs?`, `inits.exec?`

**depends on**: nothing

**acceptance criteria**:
```
given('a valid rhachet.repo.yml')
  when('parsed with schemaRoleRegistryManifest')
    then('returns typed RoleRegistryManifest')

given('an invalid rhachet.repo.yml')
  when('parsed with schemaRoleRegistryManifest')
    then('throws with specific field error')
```

**verification**:
```sh
npm run test:unit -- RoleRegistryManifest
```

---

## phase 1: config operations — explicit symmetry

### 1.1 — rename getRegistriesByOpts → getRoleRegistriesByConfigExplicit

- [ ] rename file: `src/domain.operations/invoke/getRegistriesByOpts.ts` → `src/domain.operations/config/getRoleRegistriesByConfigExplicit.ts`
- [ ] rename function: `getRegistriesByOpts` → `getRoleRegistriesByConfigExplicit`
- [ ] update all import sites

**depends on**: nothing

**acceptance criteria**:
```
given('a repo with rhachet.use.ts')
  when('getRoleRegistriesByConfigExplicit({ configPath })')
    then('returns RoleRegistry[] from rhachet.use.ts')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- getRoleRegistriesByConfigExplicit
```

### 1.2 — rename discoverRegistriesFromPackages → getRoleRegistriesByConfigImplicit

- [ ] rename file: `src/domain.operations/manifest/discoverRegistriesFromPackages.ts` → `src/domain.operations/config/getRoleRegistriesByConfigImplicit.ts`
- [ ] rename function: `discoverRegistriesFromPackages` → `getRoleRegistriesByConfigImplicit`
- [ ] ensure return type is `RoleRegistryManifest[]` (not cast to RoleRegistry)
- [ ] update all import sites

**depends on**: 0.1

**acceptance criteria**:
```
given('rhachet-roles-* packages in node_modules with rhachet.repo.yml')
  when('getRoleRegistriesByConfigImplicit({ cwd })')
    then('returns RoleRegistryManifest[] from all packages')

given('no rhachet-roles-* packages')
  when('getRoleRegistriesByConfigImplicit({ cwd })')
    then('returns empty array')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- getRoleRegistriesByConfigImplicit
```

### 1.3 — rename getBrainReplsByOpts → getBrainsByConfigExplicit

- [ ] rename file: `src/domain.operations/invoke/getBrainReplsByOpts.ts` → `src/domain.operations/config/getBrainsByConfigExplicit.ts`
- [ ] rename function
- [ ] update all import sites

**depends on**: nothing

**acceptance criteria**:
```
given('rhachet.use.ts with brains declared')
  when('getBrainsByConfigExplicit({ configPath })')
    then('returns BrainRepl[]')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- getBrainsByConfigExplicit
```

### 1.4 — rename getInvokeHooksByOpts → getRoleHooksOnDispatchByConfigExplicit

- [ ] rename file: `src/domain.operations/invoke/getInvokeHooksByOpts.ts` → `src/domain.operations/config/getRoleHooksOnDispatchByConfigExplicit.ts`
- [ ] rename function
- [ ] update all import sites

**depends on**: nothing

**acceptance criteria**:
```
given('rhachet.use.ts with hooks declared')
  when('getRoleHooksOnDispatchByConfigExplicit({ configPath })')
    then('returns InvokeHooks')
```

**verification**:
```sh
npm run test:types
npm run test:unit -- getRoleHooksOnDispatchByConfigExplicit
```

---

## phase 2: context factory — just-in-time load

### 2.1 — create ContextConfigOfUsage interface

- [ ] create `src/domain.operations/config/ContextConfigOfUsage.ts`
- [ ] define interface with `config.usage.isExplicit()` and `config.usage.get.*` lazy getters

**depends on**: 1.1, 1.2, 1.3, 1.4

**acceptance criteria**:
```
given('ContextConfigOfUsage interface')
  then('config.usage.isExplicit returns boolean')
  then('config.usage.get.registries.explicit returns Promise<RoleRegistry[]>')
  then('config.usage.get.registries.implicit returns Promise<RoleRegistryManifest[]>')
  then('config.usage.get.brains.explicit returns Promise<BrainRepl[]>')
  then('config.usage.get.hooks.explicit returns Promise<InvokeHooks>')
```

**verification**:
```sh
npm run test:types
```

### 2.2 — create genContextConfigOfUsage factory

- [ ] create `src/domain.operations/config/genContextConfigOfUsage.ts`
- [ ] implement `extractConfigPathFromArgs` for --config flag
- [ ] implement `resolveExplicitConfigPath` (--config > cwd discovery)
- [ ] wrap loaders with `withSimpleCache` from `with-simple-cache`
- [ ] return `ContextConfigOfUsage` with lazy getters

**depends on**: 2.1

**acceptance criteria**:
```
given('args with --config ./custom/rhachet.use.ts')
  when('genContextConfigOfUsage({ args, cwd })')
    then('isExplicit() returns true')
    then('get.registries.explicit() loads from custom path')

given('args without --config, cwd has rhachet.use.ts')
  when('genContextConfigOfUsage({ args, cwd })')
    then('isExplicit() returns true')
    then('get.registries.explicit() loads from cwd')

given('args without --config, cwd lacks rhachet.use.ts')
  when('genContextConfigOfUsage({ args, cwd })')
    then('isExplicit() returns false')
    then('get.registries.explicit() throws BadRequestError')
    then('get.registries.implicit() still works')

given('multiple calls to get.registries.explicit()')
  when('called twice')
    then('second call returns cached result')

given('multiple calls to get.registries.implicit()')
  when('called twice')
    then('second call returns cached result')
```

**verification**:
```sh
npm run test:unit -- genContextConfigOfUsage
```

---

## phase 3: manifest operations — eliminate cast

### 3.1 — create getRolesFromManifests

- [ ] create `src/domain.operations/manifest/getRolesFromManifests.ts`
- [ ] accept `{ specifiers: RoleSpecifier[]; manifests: RoleRegistryManifest[] }`
- [ ] return `{ manifest, role }[]` on success
- [ ] fail-fast: throw BadRequestError on first error
- [ ] support `role` and `repo/role` specifier patterns

**depends on**: 0.1

**acceptance criteria**:
```
given('specifier "mechanic" with one manifest match')
  when('getRolesFromManifests({ specifiers, manifests })')
    then('returns [{ manifest, role }] for mechanic')

given('specifier "ehmpathy/mechanic"')
  when('getRolesFromManifests({ specifiers, manifests })')
    then('returns match from ehmpathy manifest only')

given('specifier "mechanic" with multiple manifest matches')
  when('getRolesFromManifests({ specifiers, manifests })')
    then('throws BadRequestError with ambiguity message')
    then('error lists all packages with "mechanic"')
    then('error suggests "repo/role" pattern')

given('specifier "nonexistent"')
  when('getRolesFromManifests({ specifiers, manifests })')
    then('throws BadRequestError "role not found"')
    then('error lists available roles')
```

**verification**:
```sh
npm run test:unit -- getRolesFromManifests
```

### 3.2 — remove castManifestToRegistry

- [ ] delete `src/domain.operations/manifest/castManifestToRegistry.ts` (if exists)
- [ ] update any callers to use manifest directly or getRolesFromManifests

**depends on**: 3.1

**acceptance criteria**:
```
given('codebase')
  when('grep for castManifestToRegistry')
    then('no results found')
```

**verification**:
```sh
grep -r "castManifestToRegistry" src/ && exit 1 || exit 0
npm run test:types
```

---

## phase 4: invoke refactor — eliminate early escapes

### 4.1 — update invoke.ts to use genContextConfigOfUsage

- [ ] remove early escape for `init` command
- [ ] remove early escape for `repo introspect` command
- [ ] remove early escape for `roles link/init` commands
- [ ] create context via `genContextConfigOfUsage({ args, cwd })`
- [ ] pass context to all command handlers

**depends on**: 2.2

**acceptance criteria**:
```
given('invoke.ts')
  when('grep for early escape patterns')
    then('no if(args[0] === "init") return patterns found')
    then('all commands registered unconditionally')
```

**verification**:
```sh
npm run test:types
npm run test:acceptance -- invoke
```

### 4.2 — update invokeInit to use context

- [ ] accept `(input: { program }, context: ContextConfigOfUsage)`
- [ ] for `--roles`: use `context.config.usage.get.registries.implicit()`
- [ ] for `--config`: generate rhachet.use.ts (no context needed)

**depends on**: 4.1

**acceptance criteria**:
```
given('repo without rhachet.use.ts')
  when('npx rhachet init --roles mechanic')
    then('discovers mechanic from installed packages')
    then('links and inits mechanic role')
    then('no error about absent rhachet.use.ts')
```

**verification**:
```sh
npm run test:acceptance -- invokeInit
```

### 4.3 — update invokeAsk to use context

- [ ] accept `(input: { program }, context: ContextConfigOfUsage)`
- [ ] check `context.config.usage.isExplicit()` before load
- [ ] throw BadRequestError if no explicit config

**depends on**: 4.1

**acceptance criteria**:
```
given('repo with rhachet.use.ts')
  when('npx rhachet ask')
    then('loads registries, brains, hooks from config')

given('repo without rhachet.use.ts')
  when('npx rhachet ask')
    then('throws "ask command requires rhachet.use.ts config"')
```

**verification**:
```sh
npm run test:acceptance -- invokeAsk
```

### 4.4 — update invokeAct to use context

- [ ] accept `(input: { program }, context: ContextConfigOfUsage)`
- [ ] same pattern as invokeAsk

**depends on**: 4.1

**verification**:
```sh
npm run test:acceptance -- invokeAct
```

---

## phase 5: roles commands — manifest-first

### 5.1 — update invokeRolesLink to use manifests

- [ ] accept `(input: { program }, context: ContextConfigOfUsage)`
- [ ] use fallback pattern: explicit registries if available, else implicit manifests
- [ ] call `getRolesFromManifests` for resolution
- [ ] symlink from manifest paths (no cast needed)

**depends on**: 3.1, 4.1

**acceptance criteria**:
```
given('repo without rhachet.use.ts')
  when('npx rhachet roles link --role mechanic')
    then('discovers mechanic from installed packages via manifest')
    then('creates symlinks in .agent/')
    then('no error about absent rhachet.use.ts')

given('repo with rhachet.use.ts')
  when('npx rhachet roles link --role mechanic')
    then('uses explicit registry if role found there')
    then('falls back to implicit manifest if not in registry')
```

**verification**:
```sh
npm run test:acceptance -- invokeRolesLink
```

### 5.2 — update invokeRolesInit to use manifests

- [ ] accept `(input: { program }, context: ContextConfigOfUsage)`
- [ ] for manifest-sourced roles: execute inits from `RoleManifest.inits.exec`
- [ ] for registry-sourced roles: execute inits from `Role.inits.exec`

**depends on**: 3.1, 4.1

**acceptance criteria**:
```
given('repo without rhachet.use.ts but with linked roles')
  when('npx rhachet roles init --role mechanic')
    then('executes init commands for mechanic')
    then('no error about absent rhachet.use.ts')

given('--command flag specified')
  when('npx rhachet roles init --role mechanic --command setup')
    then('only executes "setup" init command')
```

**verification**:
```sh
npm run test:acceptance -- invokeRolesInit
```

---

## phase 6: init command — multi-role support

### 6.1 — create initRolesFromManifests

- [ ] create `src/domain.operations/init/initRolesFromManifests.ts`
- [ ] accept `{ specifiers: string[]; manifests: RoleRegistryManifest[] }`
- [ ] resolve specifiers via `getRolesFromManifests`
- [ ] fail fast if any specifier has errors (before link/init)
- [ ] execute link + init for each resolved role

**depends on**: 3.1, 5.1, 5.2

**acceptance criteria**:
```
given('specifiers ["mechanic", "behaver", "reviewer"]')
  when('initRolesFromManifests({ specifiers, manifests })')
    then('all three roles are linked')
    then('all three roles have init commands executed')
    then('success message shows which roles were initialized')

given('specifiers ["mechanic", "nonexistent"]')
  when('initRolesFromManifests({ specifiers, manifests })')
    then('fails fast before any roles are linked')
    then('error shows "nonexistent" not found')
```

**verification**:
```sh
npm run test:unit -- initRolesFromManifests
npm run test:integration -- initRolesFromManifests
```

### 6.2 — extend invokeInit with --roles flag

- [ ] add `.option('--roles <roles...>')` to init command
- [ ] when `--roles` provided: call `initRolesFromManifests`
- [ ] when no flags: show usage instructions with available roles

**depends on**: 6.1

**acceptance criteria**:
```
given('repo with rhachet-roles packages installed')
  when('npx rhachet init --roles mechanic behaver')
    then('both roles are linked and initialized')

  when('npx rhachet init --roles mechanic')
    then('only mechanic is linked and initialized')

  when('npx rhachet init')
    then('outputs usage instructions')
    then('lists available roles from installed packages')
```

**verification**:
```sh
npm run test:acceptance -- "init --roles"
```

---

## phase 7: repo introspect command

### 7.1 — create genRoleRegistryManifestFromRegistry

- [ ] create `src/domain.operations/manifest/genRoleRegistryManifestFromRegistry.ts`
- [ ] accept `{ registry: RoleRegistry; packageRoot: string }`
- [ ] transform registry → `RoleRegistryManifest` shape
- [ ] resolve relative paths for briefs.dirs, skills.dirs, inits

**depends on**: 0.1

**acceptance criteria**:
```
given('a RoleRegistry with roles')
  when('genRoleRegistryManifestFromRegistry({ registry, packageRoot })')
    then('returns RoleRegistryManifest with correct slug')
    then('each role has briefs.dirs, skills.dirs from Role paths')
    then('each role has inits.exec from Role.inits.exec if present')
```

**verification**:
```sh
npm run test:unit -- genRoleRegistryManifestFromRegistry
```

### 7.2 — create invokeRepoIntrospect command

- [ ] create/update `src/contract/cli/invokeRepoIntrospect.ts`
- [ ] dynamically import `getRoleRegistry` from package
- [ ] call `genRoleRegistryManifestFromRegistry`
- [ ] write `rhachet.repo.yml` to package root
- [ ] support `--dry-run` to output to stdout

**depends on**: 7.1

**acceptance criteria**:
```
given('a rhachet-roles publisher package')
  when('npx rhachet repo introspect')
    then('rhachet.repo.yml is generated at package root')
    then('yml contains role directories for each role')
    then('yml contains init commands for each role')

  when('npx rhachet repo introspect --dry-run')
    then('yml content is output to stdout')
    then('no file is written')
```

**verification**:
```sh
npm run test:acceptance -- "repo introspect"
```

---

## phase 8: error handling

### 8.1 — role not found error

> implemented in: phase 3.1 (getRolesFromManifests fail-fast)

- [ ] when specifier matches no manifest: throw descriptive error
- [ ] error lists available roles from all packages
- [ ] error suggests checking package installation

**depends on**: 3.1

**acceptance criteria**:
```
given('specifier "nonexistent"')
  when('getRolesFromManifests fails')
    then('error: role "nonexistent" not found')
    then('error asks: "do you need to npm install a repo?"')
    then('error lists available roles')
```

**verification**:
```sh
npm run test:unit -- getRolesFromManifests
```

### 8.2 — ambiguous role error

> implemented in: phase 3.1 (getRolesFromManifests fail-fast)

- [ ] when specifier matches multiple manifests: throw disambiguation error
- [ ] error lists all packages that contain the role
- [ ] error suggests repo/role pattern

**depends on**: 3.1

**acceptance criteria**:
```
given('specifier "mechanic" found in multiple packages')
  when('getRolesFromManifests fails')
    then('error lists all packages with "mechanic"')
    then('error suggests "ehmpathy/mechanic" pattern')
```

**verification**:
```sh
npm run test:unit -- getRolesFromManifests
```

### 8.3 — partial init failure handling

- [ ] when one role's init fails: continue with others
- [ ] report which roles succeeded and which failed
- [ ] preserve linked state for successful roles

**depends on**: 6.1

**acceptance criteria**:
```
given('mechanic init succeeds, behaver init fails')
  when('npx rhachet init --roles mechanic behaver')
    then('mechanic remains linked and initialized')
    then('error shows behaver init failed')
    then('error shows failure reason')
```

**verification**:
```sh
npm run test:integration -- initRolesFromManifests
```

---

## phase 9: documentation

### 9.1 — update readme for consumers

- [ ] document `npx rhachet init --roles` command
- [ ] document repo/role disambiguation pattern
- [ ] show example invocations

**depends on**: 6.2

**acceptance criteria**:
```
given('consumer reads readme')
  then('finds "npx rhachet init --roles" documented')
  then('finds disambiguation pattern documented')
  then('finds example invocations')
```

**verification**: manual review

### 9.2 — update readme for publishers

- [ ] document `npx rhachet repo introspect` command
- [ ] document rhachet.repo.yml schema
- [ ] show example workflow for publishers

**depends on**: 7.2

**acceptance criteria**:
```
given('publisher reads readme')
  then('finds "npx rhachet repo introspect" documented')
  then('finds rhachet.repo.yml schema documented')
```

**verification**: manual review

---

## phase 10: integration verification

### 10.1 — end-to-end acceptance tests

- [ ] test full flow: install package → init --roles → verify .agent/ structure
- [ ] test disambiguation flow
- [ ] test error scenarios

**depends on**: all prior phases

**acceptance criteria**:
```
given('fresh repo with rhachet-roles-ehmpathy installed')
  when('npx rhachet init --roles mechanic')
    then('.agent/repo=ehmpathy/role=mechanic/ exists')
    then('symlinks point to node_modules paths')
    then('init commands have executed')
```

**verification**:
```sh
npm run test:acceptance
```

### 10.2 — backward compatibility verification

- [ ] verify existing `roles boot` still works with rhachet.use.ts
- [ ] verify existing `ask`/`act` commands still work
- [ ] verify --config flag still works

**depends on**: all prior phases

**acceptance criteria**:
```
given('repo with rhachet.use.ts')
  when('npx rhachet roles boot')
    then('works as before')

  when('npx rhachet ask')
    then('works as before')
```

**verification**:
```sh
npm run test:acceptance
```

---

## execution order summary

```
phase 0: foundation
  └── 0.1 schema validation

phase 1: config operations (parallel)
  ├── 1.1 getRoleRegistriesByConfigExplicit
  ├── 1.2 getRoleRegistriesByConfigImplicit ← 0.1
  ├── 1.3 getBrainsByConfigExplicit
  └── 1.4 getRoleHooksOnDispatchByConfigExplicit

phase 2: context factory
  ├── 2.1 ContextConfigOfUsage interface ← 1.*
  └── 2.2 genContextConfigOfUsage ← 2.1

phase 3: manifest operations
  ├── 3.1 getRolesFromManifests ← 0.1
  └── 3.2 remove castManifestToRegistry ← 3.1

phase 4: invoke refactor
  ├── 4.1 invoke.ts refactor ← 2.2
  ├── 4.2 invokeInit ← 4.1
  ├── 4.3 invokeAsk ← 4.1
  └── 4.4 invokeAct ← 4.1

phase 5: roles commands
  ├── 5.1 invokeRolesLink ← 3.1, 4.1
  └── 5.2 invokeRolesInit ← 3.1, 4.1

phase 6: init command
  ├── 6.1 initRolesFromManifests ← 3.1, 5.1, 5.2
  └── 6.2 invokeInit --roles ← 6.1

phase 7: repo introspect
  ├── 7.1 genRoleRegistryManifestFromRegistry ← 0.1
  └── 7.2 invokeRepoIntrospect ← 7.1

phase 8: error handling
  ├── 8.1 role not found ← 3.1 (implemented in getRolesFromManifests)
  ├── 8.2 ambiguous role ← 3.1 (implemented in getRolesFromManifests)
  └── 8.3 partial init failure ← 6.1

phase 9: documentation ← 6.2, 7.2

phase 10: integration verification ← all
```

# execution log: init-roles-many v2

this file tracks progress through roadmap phases.

---

## phase 0: foundation — domain types

### 0.1 — RoleRegistryManifest schema validation

**status**: ✅ complete

**verification**:
- [x] schema includes `slug`, `readme`, `briefs.dirs`, `skills.dirs`, `inits.dirs?`, `inits.exec?`
- [x] test file exists at `src/domain.objects/RoleRegistryManifest.test.ts`

**notes**:
- schema already implemented with all required fields
- zod schema validates all fields correctly

---

## phase 1: config operations — explicit symmetry

### 1.1 — rename getRegistriesByOpts → getRegistriesByConfigExplicit

**status**: ✅ complete

**checklist**:
- [x] create `src/domain.operations/config/` directory
- [x] create file `src/domain.operations/config/getRegistriesByConfigExplicit.ts`
- [x] update all import sites (invoke.ts, performInCurrentThreadForActor.ts, performInIsolatedThread.execute.ts)
- [x] delete old file `src/domain.operations/invoke/getRegistriesByOpts.ts`

---

### 1.2 — create getRegistriesByConfigImplicit

**status**: ✅ complete

**checklist**:
- [x] create file `src/domain.operations/config/getRegistriesByConfigImplicit.ts`
- [x] returns `{ manifest: RoleRegistryManifest; packageRoot: string }[]` (no cast to RoleRegistry)
- [x] add RoleRegistryManifest export to domain.objects/index.ts

**notes**:
- `discoverRegistriesFromPackages` was kept temporarily until Phase 5.3
- now deleted — all callers updated to use manifests directly

---

### 1.3 — rename getBrainReplsByOpts → getBrainsByConfigExplicit

**status**: ✅ complete

**checklist**:
- [x] create file `src/domain.operations/config/getBrainsByConfigExplicit.ts`
- [x] update all import sites
- [x] delete old file `src/domain.operations/invoke/getBrainReplsByOpts.ts`

---

### 1.4 — rename getInvokeHooksByOpts → getHooksByConfigExplicit

**status**: ✅ complete

**checklist**:
- [x] create file `src/domain.operations/config/getHooksByConfigExplicit.ts`
- [x] update all import sites
- [x] delete old file `src/domain.operations/invoke/getInvokeHooksByOpts.ts`

---

## phase 2: context factory — just-in-time load

### 2.1 — create ContextConfigOfUsage interface

**status**: ✅ complete

**checklist**:
- [x] create `src/domain.operations/config/ContextConfigOfUsage.ts`
- [x] define interface with `config.usage.isExplicit()` and lazy getters

---

### 2.2 — create genContextConfigOfUsage factory

**status**: ✅ complete

**checklist**:
- [x] create `src/domain.operations/config/genContextConfigOfUsage.ts`
- [x] implement extractConfigPathFromArgs
- [x] implement closure-based memoization
- [ ] add unit tests (deferred)

---

## phase 3: manifest operations — eliminate cast

### 3.1 — create getRolesFromManifests

**status**: ✅ complete

**checklist**:
- [x] create `src/domain.operations/manifest/getRolesFromManifests.ts`
- [x] accept `{ specifiers, manifests }` input
- [x] fail-fast on first error (not found, ambiguous)
- [x] support `role` and `repo/role` specifier patterns

---

### 3.2 — remove castManifestToRegistry

**status**: ✅ complete

**checklist**:
- [x] delete `src/domain.operations/manifest/castManifestToRegistry.ts`
- [x] delete `src/domain.operations/manifest/castManifestToRegistry.test.ts`
- [x] delete `src/domain.operations/manifest/discoverRegistriesFromPackages.ts`
- [x] delete `src/domain.operations/manifest/discoverRegistriesFromPackages.integration.test.ts`

**notes**:
- all callers updated to use manifests directly (Phase 5.3)
- no prod code references remain

---

## phase 4: invoke refactor — eliminate early escapes

### 4.1 — update invoke.ts to use genContextConfigOfUsage

**status**: ✅ complete

**checklist**:
- [x] remove early escape for `init` command
- [x] remove early escape for `repo introspect` command
- [x] remove early escape for `roles link/init` commands
- [x] create context via `genContextConfigOfUsage({ args, cwd })`
- [x] pass context to all command handlers

**changes**:
- `invoke.ts`: removed all early escapes, create context once at entry point
- `invokeInit.ts`: updated signature to `(input, context: ContextConfigOfUsage)`
- `invokeRoles.ts`: updated signature, passes context to subcommands
- `invokeRolesLink.ts`: updated to use `context.config.usage.get.registries.explicit()`
- `invokeRolesInit.ts`: updated to use `context.config.usage.get.registries.explicit()`
- `invokeList.ts`: updated to load registries just-in-time
- `invokeReadme.ts`: updated to load registries just-in-time
- `invokeAsk.ts`: updated to load registries, brains, hooks just-in-time
- `invokeAct.ts`: updated to load registries, brains, hooks just-in-time
- `ContextConfigOfUsage.ts`: added `getExplicitPath()` getter for isolated threads

---

### 4.1b — fix test files for new signatures

**status**: ✅ complete

**checklist**:
- [x] create `src/.test/genMockContextConfigOfUsage.ts` helper
- [x] update `invokeInit.integration.test.ts`
- [x] update `invokeReadme.integration.test.ts`
- [x] update `invokeRolesLink.integration.test.ts`
- [x] update `invokeRolesInit.integration.test.ts`
- [x] update `invokeAct.integration.test.ts`
- [x] update `invokeAct.test.ts`
- [x] update `invokeAsk.integration.test.ts`

**notes**:
- all command handler tests now use `genMockContextConfigOfUsage()` to create mock context
- no new type errors in modified files
- prior errors in `useBeforeAll` usage in other test files remain

---

## phase 5: roles commands — use manifests directly

### 5.1a — update ContextConfigOfUsage to return manifests with packageRoot

**status**: ✅ complete

**checklist**:
- [x] add `ManifestWithPackageRoot` interface to `ContextConfigOfUsage.ts`
- [x] change `registries.implicit()` return type from `RoleRegistryManifest[]` to `ManifestWithPackageRoot[]`
- [x] update `genContextConfigOfUsage.ts` to return full `{ manifest, packageRoot }` objects
- [x] update `genMockContextConfigOfUsage.ts` to use `manifestsWithRoots` instead of `manifests`

**notes**:
- `packageRoot` is essential to resolve relative manifest paths to absolute paths
- the old implementation stripped `packageRoot` which broke path resolution

---

### 5.1b — update invokeRolesLink to use manifests directly

**status**: ✅ complete

**checklist**:
- [x] create `LinkableRole` interface for unified symlink operations
- [x] create `toLinkableFromRole` converter for explicit Role
- [x] create `toLinkableFromManifest` converter for implicit RoleManifest
- [x] rewrite action handler to use unified shape
- [x] remove `discoverRegistriesFromPackages` import

**changes**:
- `invokeRolesLink.ts`: now uses `getRolesFromManifests` for implicit config lookup
- `toUriObjects` helper converts manifest string paths to `{ uri: string }` objects
- no cast to `RoleRegistry` needed — works directly with `RoleManifest`

---

### 5.2 — update invokeRolesInit to use manifests directly

**status**: ✅ complete

**checklist**:
- [x] create `InitableRole` interface for unified init execution
- [x] create `toInitableFromRole` converter for explicit Role
- [x] create `toInitableFromManifest` converter for implicit RoleManifest
- [x] rewrite action handler to use unified shape
- [x] remove `discoverRegistriesFromPackages` import

**changes**:
- `invokeRolesInit.ts`: now uses `getRolesFromManifests` for implicit config lookup
- manifest `inits.exec` strings resolved to absolute paths via `packageRoot`
- no cast to `RoleRegistry` needed — works directly with `RoleManifest`

---

### 5.3 — update other callers and cleanup

**status**: ✅ complete

**checklist**:
- [x] update `initRolesFromPackages.ts` to use `getRegistriesByConfigImplicit` + `getRolesFromManifests`
- [x] update `showInitUsageInstructions.ts` to use `getRegistriesByConfigImplicit`
- [x] update `hasConfigExplicit.ts` comment
- [x] delete `discoverRegistriesFromPackages.ts` and test (no longer used)
- [x] delete `castManifestToRegistry.ts` and test (no longer used)

**changes**:
- `initRolesFromPackages.ts`: rewrote `linkRole` and `runRoleInits` to accept `{ role: RoleManifest; manifest: ManifestWithPackageRoot }`, added `toUriObjects` helper
- `showInitUsageInstructions.ts`: changed from `discoverRegistriesFromPackages` to `getRegistriesByConfigImplicit`, updated all references from `registries` to `manifests`
- no prod code references to deleted files remain

---

## phases 6-10: beyond

**status**: n/a (blueprint v2 complete)

---

## cleanup: fix prior test file issues

**status**: ✅ complete

**checklist**:
- [x] fix `getRoleRegistryManifest.integration.test.ts` import (`@ehmpathy/error-fns` → `helpful-errors`)
- [x] fix `useBeforeAll` callbacks to be async

**notes**:
- these were prior issues unrelated to init-roles-many work
- fixed to ensure clean type check

---

## verification commands

```sh
# types
npm run test:types

# unit tests
npm run test:unit -- getRegistriesByConfigExplicit
npm run test:unit -- getRegistriesByConfigImplicit
npm run test:unit -- getBrainsByConfigExplicit
npm run test:unit -- getHooksByConfigExplicit
npm run test:unit -- genContextConfigOfUsage
npm run test:unit -- getRolesFromManifests

# acceptance
npm run test:acceptance
```

# Blueprint: `npx rhachet init` Command

## Goal
Implement `npx rhachet init` to auto-generate a `rhachet.use.ts` config file by discovering `rhachet-roles-*` packages in `package.json`.

---

## Part 1: CLI Command Structure

### 1.1 Create `invokeInit.ts`
**Location**: `src/contract/cli/invokeInit.ts`

```ts
export const invokeInit = ({ command }: { command: Command }): void => {
  command
    .command('init')
    .description('initialize rhachet.use.ts config from discovered role packages')
    .option('--force', 'overwrite existing rhachet.use.ts')
    .action(async (opts) => { ... });
};
```

### 1.2 Wire into `invoke.ts`
Add `invokeInit` to the main CLI entrypoint (before loading config, since config won't exist yet).

---

## Part 2: Package Discovery Logic

### 2.1 Create `discoverRolePackages.ts`
**Location**: `src/logic/init/discoverRolePackages.ts`

- Read `package.json` from git repo root
- Find all dependencies + devDependencies matching pattern `rhachet-roles-*`
- Return array of package names

```ts
export const discoverRolePackages = async (input: { from: string }): Promise<string[]> => {
  const root = await getGitRepoRoot({ from: input.from });
  const pkg = JSON.parse(readFileSync(resolve(root, 'package.json'), 'utf8'));
  const allDeps = { ...pkg.dependencies, ...pkg.devDependencies };
  return Object.keys(allDeps).filter((name) => name.startsWith('rhachet-roles-'));
};
```

---

## Part 3: Config File Generation

### 3.1 Create `generateRhachetConfig.ts`
**Location**: `src/logic/init/generateRhachetConfig.ts`

Generate TypeScript config file content:

```ts
export const generateRhachetConfig = (input: { packages: string[] }): string => {
  // Always use aliased imports for consistency
  const imports = input.packages
    .map((pkg) => {
      const suffix = toPascalCase(pkg.replace('rhachet-roles-', ''));
      return `import { getRoleRegistry as getRoleRegistry${suffix}, getInvokeHooks as getInvokeHooks${suffix} } from '${pkg}';`;
    })
    .join('\n');

  const registries = input.packages
    .map(pkg => `getRoleRegistry${toPascalCase(pkg.replace('rhachet-roles-', ''))}()`)
    .join(', ');

  const hooks = input.packages
    .map(pkg => `getInvokeHooks${toPascalCase(pkg.replace('rhachet-roles-', ''))}()`)
    .join(', ');

  return `${imports}

export const getRoleRegistries = () => [${registries}];
export const getInvokeHooks = () => [${hooks}];
`;
};
```

### 3.2 Handle Multiple InvokeHooks
Per the wish: "ensure that we support a list of invokehooks exported from the config and apply each of them"

**Key change**: The config exports `getInvokeHooks: () => InvokeHooks[]` (an array), and the internal `getInvokeHooksByOpts` merges them.

Config signature:
```ts
export const getInvokeHooks = () => [getInvokeHooks1(), getInvokeHooks2()];
```

Internal merger (in `getInvokeHooksByOpts.ts`):
```ts
const hooksList = await config.getInvokeHooks?.() ?? [];
return {
  onInvokeAskInput: hooksList.flatMap(h => h?.onInvokeAskInput ?? []),
};
```

---

## Part 4: File Writing

### 4.1 Write config to git root
- Check if `rhachet.use.ts` exists
- If exists and no `--force`, warn and exit
- Write generated content to `{gitroot}/rhachet.use.ts`

---

## Part 5: Example Output

For `package.json` with only `rhachet-roles-ehmpathy`:

```ts
import { getRoleRegistry as getRoleRegistryEhmpathy, getInvokeHooks as getInvokeHooksEhmpathy } from 'rhachet-roles-ehmpathy';

export const getRoleRegistries = () => [getRoleRegistryEhmpathy()];
export const getInvokeHooks = () => [getInvokeHooksEhmpathy()];
```

For multiple packages:

```ts
import { getRoleRegistry as getRoleRegistryEhmpathy, getInvokeHooks as getInvokeHooksEhmpathy } from 'rhachet-roles-ehmpathy';
import { getRoleRegistry as getRoleRegistryOther, getInvokeHooks as getInvokeHooksOther } from 'rhachet-roles-other';

export const getRoleRegistries = () => [getRoleRegistryEhmpathy(), getRoleRegistryOther()];
export const getInvokeHooks = () => [getInvokeHooksEhmpathy(), getInvokeHooksOther()];
```

---

## Part 6: Files to Create/Modify

### New Files
1. `src/contract/cli/invokeInit.ts` - CLI command handler
2. `src/contract/cli/invokeInit.integration.test.ts` - Integration tests
3. `src/logic/init/discoverRolePackages.ts` - Package discovery
4. `src/logic/init/discoverRolePackages.test.ts` - Unit tests
5. `src/logic/init/generateRhachetConfig.ts` - Config generation
6. `src/logic/init/generateRhachetConfig.test.ts` - Unit tests

### Modified Files
1. `src/contract/cli/invoke.ts` - Wire in `invokeInit` command
2. `src/logic/invoke/getInvokeHooksByOpts.ts` - Support `InvokeHooks[]` and merge internally

---

## Part 7: Edge Cases

1. **No rhachet-roles-* packages found**: Warn user, suggest installing a package
2. **Package doesn't export getInvokeHooks**: Handle gracefully (optional export)
3. **Existing rhachet.use.ts**: Require `--force` to overwrite
4. **Package naming collisions**: Use aliased imports with package suffix

---

## Part 8: CLI UX

```
$ npx rhachet init

ðŸ”­ Search for rhachet role packages...
  - [found] rhachet-roles-ehmpathy

âœ¨ Create rhachet.use.ts...
  + [created] rhachet.use.ts

ðŸŒŠ Done, rhachet config with 1 role package(s), ready for use

Run 'npx rhachet list' to see available roles.
```

# roadmap: upgrade brains

execution roadmap for the blueprint defined in `3.3.blueprint.v1.i1.md`.

---

## phase 0: preparation

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/0.wish.md`
- `.behavior/v2026_01_24.upgrade-brains/2.criteria.blackbox.md`
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md`

### checklist

- [ ] **0.1** read wish and blackbox criteria to understand acceptance bounds
- [ ] **0.2** read blueprint to understand implementation strategy
- [ ] **0.3** verify build passes before changes: `npm run build`
- [ ] **0.4** verify tests pass before changes: `npm run test`

### verification

```sh
npm run build && npm run test
```

**acceptance:** all commands exit 0

---

## phase 1: domain.objects

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "BrainSupplierSlug contract" section
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "UpgradeResult contract" section

### checklist

- [ ] **1.1** create `src/domain.objects/BrainSupplierSlug.ts`
  - branded type: `type BrainSupplierSlug = string & { __brand: 'BrainSupplierSlug' }`
  - helper: `toBrainSupplierSlug(packageName: string): BrainSupplierSlug`

- [ ] **1.2** extend `UpgradeResult` in `src/domain.operations/upgrade/execUpgrade.ts`
  - add `upgradedBrains: BrainSupplierSlug[]` to interface
  - update return statement to include `upgradedBrains: []` (placeholder)

### verification

```sh
npm run test:types
```

**acceptance:**
- types compile without errors
- `BrainSupplierSlug` is importable
- `UpgradeResult` includes `upgradedBrains`

---

## phase 2: resolveBrainsToPackages

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "resolveBrainsToPackages contract" section
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "resolveBrainsToPackages implementation" section
- `.behavior/v2026_01_24.upgrade-brains/3.1.research.patterns._.code.test.v1.i1.md` → test patterns

### checklist

- [ ] **2.1** create `src/domain.operations/upgrade/resolveBrainsToPackages.ts`
  - wildcard `*` expansion via `discoverBrainPackages`
  - explicit slug resolution: `anthropic` → `rhachet-brains-anthropic`
  - full package name passthrough: `rhachet-brains-anthropic` → `rhachet-brains-anthropic`
  - deduplication
  - validation: throw `BadRequestError` if package not installed

- [ ] **2.2** create `src/domain.operations/upgrade/resolveBrainsToPackages.test.ts`
  - test: wildcard expands via discovery
  - test: explicit slug resolves to package
  - test: full package name passed through
  - test: absent package throws `BadRequestError`
  - test: deduplicates packages

### verification

```sh
npm run test:unit -- resolveBrainsToPackages
```

**acceptance:**
- all 5 test cases pass
- `resolveBrainsToPackages({ specs: ['*'] }, context)` returns discovered brain packages
- `resolveBrainsToPackages({ specs: ['anthropic'] }, context)` returns `['rhachet-brains-anthropic']`
- `resolveBrainsToPackages({ specs: ['nonexistent'] }, context)` throws `BadRequestError`

---

## phase 3: execUpgrade extension

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "execUpgrade contract" section
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "default behavior logic" section
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "codepaths treestruct" section
- `.behavior/v2026_01_24.upgrade-brains/3.1.research.patterns._.code.prod.v1.i1.md` → production patterns

### checklist

- [ ] **3.1** extend `execUpgrade` input signature
  - add `brainSpecs?: string[]` to input type

- [ ] **3.2** extend default behavior logic
  - `upgradeSelf = input.self ?? (input.roleSpecs === undefined && input.brainSpecs === undefined)`
  - `brainSpecs = input.brainSpecs ?? (input.self === true ? [] : ['*'])`

- [ ] **3.3** add brain resolution and install logic
  - call `resolveBrainsToPackages({ specs: brainSpecs }, context)`
  - add brain packages to `buildInstallList`
  - include brain packages in file:. skip logic
  - extract slugs via `toBrainSupplierSlug` for result

- [ ] **3.4** update return statement
  - return `upgradedBrains` with actual slugs

### verification

```sh
npm run test:types
```

**acceptance:**
- types compile without errors
- `execUpgrade` accepts `brainSpecs` parameter

---

## phase 4: execUpgrade unit tests

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/3.1.research.patterns._.code.test.v1.i1.md` → "pattern 2: mock-based unit test pattern"
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "test coverage matrix" → "unit tests"

### checklist

- [ ] **4.1** add mock for `resolveBrainsToPackages` in `execUpgrade.test.ts`

- [ ] **4.2** add test: no flags → upgrades self + roles + brains
  - verify `mockResolveBrainsToPackages` called with `['*']`
  - verify brain packages included in `execNpmInstall` call

- [ ] **4.3** add test: `--brains *` → expands to all brain packages
  - verify `mockResolveBrainsToPackages` called
  - verify `upgradedSelf` is `false`

- [ ] **4.4** add test: `--brains anthropic` → resolves single brain
  - verify `mockResolveBrainsToPackages` called with `['anthropic']`

- [ ] **4.5** add test: `--brains * --roles *` → upgrades both
  - verify both role and brain packages in install list

- [ ] **4.6** add test: `--self` → no brains upgraded
  - verify `mockResolveBrainsToPackages` NOT called (or called with `[]`)

- [ ] **4.7** add test: file:. brain dependency → excluded from install
  - mock `getFileDotDependencies` to return brain package
  - verify brain package excluded from `execNpmInstall`

- [ ] **4.8** add regression test: `--roles *` → no brains upgraded
  - verify brain packages NOT in install list
  - satisfies usecase.9

### verification

```sh
npm run test:unit -- execUpgrade.test
```

**acceptance:**
- all 8 new test cases pass
- all pre-prior tests still pass (no regression)

---

## phase 5: cli contract

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/3.3.blueprint.v1.i1.md` → "cli contract" section
- `.behavior/v2026_01_24.upgrade-brains/2.criteria.blackbox.md` → usecase.1 (help discoverability)
- `.behavior/v2026_01_24.upgrade-brains/2.criteria.blackbox.md` → usecase.10 (output summary)

### checklist

- [ ] **5.1** add `--brains` option to `invokeUpgrade.ts`
  - `.option('--brains <brains...>', 'brain specifiers to upgrade (* for all installed)')`

- [ ] **5.2** update action handler options type
  - `options: { self?: boolean; roles?: string[]; brains?: string[] }`

- [ ] **5.3** pass `brainSpecs` to `execUpgrade`
  - `execUpgrade({ self: options.self, roleSpecs: options.roles, brainSpecs: options.brains }, context)`

- [ ] **5.4** add brain summary to output
  - `if (result.upgradedBrains.length > 0) { console.log(\`✨ ${result.upgradedBrains.length} brain(s) upgraded: ${result.upgradedBrains.join(', ')}\`) }`

- [ ] **5.5** update command description
  - `.description('upgrade rhachet, role packages, and/or brain packages to latest versions')`

### verification

```sh
npx tsx ./src/contract/cli/index.ts upgrade --help
```

**acceptance:**
- `--help` output shows `--brains <brains...>` option
- description mentions brain packages
- satisfies usecase.1

---

## phase 6: integration tests

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/3.1.research.patterns._.code.test.v1.i1.md` → "pattern 3: temp directory integration test pattern"
- `.behavior/v2026_01_24.upgrade-brains/3.1.research.patterns._.code.test.v1.i1.md` → "pattern 5: genTestTempDir infra pattern"

### checklist

- [ ] **6.1** extend `getFileDotDependencies.test.ts`
  - add test: file:. brain package detected
  - verify `rhachet-brains-*` with `file:.` version is in result set

- [ ] **6.2** create `src/domain.operations/upgrade/execUpgrade.brains.integration.test.ts`
  - test: brain package discovery in temp dir
  - test: file:. brain exclusion in temp dir
  - use `genTestTempDir` pattern from test infra

### verification

```sh
npm run test:integration -- execUpgrade.brains
npm run test:integration -- getFileDotDependencies
```

**acceptance:**
- brain discovery works with real filesystem
- file:. brain packages are excluded from upgrade
- satisfies usecase.6

---

## phase 7: acceptance tests

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/2.criteria.blackbox.md` → all usecases
- `.behavior/v2026_01_24.upgrade-brains/3.1.research.patterns._.code.test.v1.i1.md` → "pattern 7: invokeRhachetCli infra pattern"

### checklist

- [ ] **7.1** create or extend `src/contract/cli/invokeUpgrade.acceptance.test.ts`
  - use `invokeRhachetCli` test infra

- [ ] **7.2** add test: `--help` shows --brains option
  - invoke `rhachet upgrade --help`
  - verify stdout contains `--brains`
  - satisfies usecase.1

- [ ] **7.3** add test: `--brains *` exits 0
  - setup temp dir with `rhachet-brains-anthropic` in package.json
  - invoke `rhachet upgrade --brains *`
  - verify exit code 0
  - satisfies usecase.3

- [ ] **7.4** add test: `--brains anthropic` exits 0
  - setup temp dir with `rhachet-brains-anthropic` in package.json
  - invoke `rhachet upgrade --brains anthropic`
  - verify exit code 0
  - satisfies usecase.2

- [ ] **7.5** add test: output summary includes brain count
  - invoke `rhachet upgrade --brains *`
  - verify stdout contains `brain(s) upgraded`
  - satisfies usecase.10

- [ ] **7.6** add test: absent brain package exits non-zero
  - setup temp dir WITHOUT brain packages
  - invoke `rhachet upgrade --brains anthropic`
  - verify exit code non-zero
  - verify stderr contains error message
  - satisfies usecase.7

- [ ] **7.7** add test: `--roles *` does NOT upgrade brains
  - setup temp dir with both role and brain packages
  - invoke `rhachet upgrade --roles *`
  - verify brain packages NOT in npm install output
  - satisfies usecase.9

- [ ] **7.8** add test: default behavior upgrades all
  - setup temp dir with rhachet, role, and brain packages
  - invoke `rhachet upgrade` (no flags)
  - verify all three types upgraded
  - satisfies usecase.5

### verification

```sh
npm run test:acceptance -- invokeUpgrade
```

**acceptance:**
- all 7 acceptance test cases pass
- usecases 1, 2, 3, 5, 7, 9, 10 satisfied

---

## phase 8: final verification

### briefs to read
- `.behavior/v2026_01_24.upgrade-brains/2.criteria.blackbox.md` → all usecases

### checklist

- [ ] **8.1** run full test suite
  ```sh
  npm run test
  ```

- [ ] **8.2** run type check
  ```sh
  npm run test:types
  ```

- [ ] **8.3** run lint
  ```sh
  npm run test:lint
  ```

- [ ] **8.4** manual verification: `--help`
  ```sh
  npx rhachet upgrade --help
  ```
  - verify `--brains` option visible

- [ ] **8.5** verify usecase coverage matrix

| usecase | test | status |
|---------|------|--------|
| usecase.1 (help discoverability) | 7.2 | [ ] |
| usecase.2 (upgrade specific brain) | 7.4 | [ ] |
| usecase.3 (upgrade all brains via wildcard) | 7.3 | [ ] |
| usecase.4 (upgrade brains + roles together) | 4.5 | [ ] |
| usecase.5 (default behavior upgrades all) | 7.8 | [ ] |
| usecase.6 (file:. dependency handle) | 6.1, 6.2 | [ ] |
| usecase.7 (error on absent brain) | 7.6 | [ ] |
| usecase.8 (brains-only upgrade) | 4.3 | [ ] |
| usecase.9 (roles-only regression) | 4.8, 7.7 | [ ] |
| usecase.10 (output summary includes brains) | 7.5 | [ ] |

### verification

```sh
npm run build && npm run test
```

**acceptance:**
- all tests pass
- all usecases covered
- no regressions

---

## dependency graph

```
phase 0 (preparation)
    │
    ▼
phase 1 (domain.objects)
    │
    ▼
phase 2 (resolveBrainsToPackages)
    │
    ▼
phase 3 (execUpgrade extension)
    │
    ├──────────────────┐
    ▼                  ▼
phase 4 (unit tests)   phase 5 (cli contract)
    │                  │
    └────────┬─────────┘
             ▼
    phase 6 (integration tests)
             │
             ▼
    phase 7 (acceptance tests)
             │
             ▼
    phase 8 (final verification)
```

---

## summary

| phase | deliverable | tests |
|-------|-------------|-------|
| 0 | preparation | baseline pass |
| 1 | `BrainSupplierSlug`, `UpgradeResult` extension | types |
| 2 | `resolveBrainsToPackages` | 5 unit tests |
| 3 | `execUpgrade` extension | types |
| 4 | `execUpgrade` unit tests | 8 unit tests |
| 5 | cli `--brains` option | manual |
| 6 | integration tests | 3 integration tests |
| 7 | acceptance tests | 7 acceptance tests |
| 8 | final verification | all |

**total new tests:** 23

# research: test codepath patterns for upgrade brains

## summary

the upgrade command has comprehensive test coverage via unit tests (mock-based) and integration tests (temp directory-based). the brain package discovery already has tests that follow the same patterns.

key insight: all test patterns are well-established and can be reused/extended for brain upgrade tests.

---

## pattern index

| # | pattern | action | why |
|---|---------|--------|-----|
| 1 | given/when/then structure | [REUSE] | standard test structure via test-fns |
| 2 | mock-based unit test pattern | [EXTEND] | add brain mocks to execUpgrade tests |
| 3 | temp directory integration test pattern | [REUSE] | already brain-compatible |
| 4 | useBeforeAll scene pattern | [REUSE] | standard for complex setup |
| 5 | genTestTempDir infra pattern | [REUSE] | cwd switch for isolated tests |
| 6 | setTestTempAsset infra pattern | [REUSE] | file creation for tests |
| 7 | invokeRhachetCli infra pattern | [REUSE] | CLI invocation for acceptance tests |
| 8 | context fixture pattern | [REUSE] | ContextCli creation |
| 9 | brain package test pattern | [REUSE] | already established for discoverBrainPackages |
| 10 | file:. dependency test pattern | [EXTEND] | add brain package cases |

---

## pattern 1: given/when/then structure

**file:** `src/domain.operations/upgrade/execUpgrade.test.ts`

**action:** [REUSE]

**what:** BDD-style test structure via `test-fns` library

**quote [1]:**
```typescript
import { given, then, when } from 'test-fns';

describe('execUpgrade', () => {
  // ...

  given('no flags provided', () => {
    when('execUpgrade is called', () => {
      then('defaults to self=true and roleSpecs=["*"]', async () => {
        await execUpgrade({}, context);

        // should upgrade rhachet + discovered roles
        expect(mockExecNpmInstall).toHaveBeenCalledWith(
          { packages: ['rhachet', 'rhachet-roles-ehmpathy'] },
          context,
        );
        expect(mockDiscoverLinkedRoles).toHaveBeenCalled();
      });
```
— `src/domain.operations/upgrade/execUpgrade.test.ts:1-72`

**relation to wish:**
- same structure for brain upgrade tests
- add `given('--brains * flag', () => { ... })`
- add `given('--brains anthropic flag', () => { ... })`

---

## pattern 2: mock-based unit test pattern

**file:** `src/domain.operations/upgrade/execUpgrade.test.ts`

**action:** [EXTEND]

**what:** dependencies mocked via jest.mock, typed via jest.MockedFunction

**quote [2]:**
```typescript
// mock dependencies
jest.mock('./discoverLinkedRoles', () => ({
  discoverLinkedRoles: jest.fn(),
}));
jest.mock('./resolveRolesToPackages', () => ({
  resolveRolesToPackages: jest.fn(),
}));
jest.mock('./execNpmInstall', () => ({
  execNpmInstall: jest.fn(),
}));
jest.mock('./getFileDotDependencies', () => ({
  getFileDotDependencies: jest.fn(),
}));
jest.mock('@src/domain.operations/init/initRolesFromPackages', () => ({
  initRolesFromPackages: jest.fn(),
}));

import { initRolesFromPackages } from '@src/domain.operations/init/initRolesFromPackages';

import { discoverLinkedRoles } from './discoverLinkedRoles';
import { execNpmInstall } from './execNpmInstall';
import { getFileDotDependencies } from './getFileDotDependencies';
import { resolveRolesToPackages } from './resolveRolesToPackages';

const mockDiscoverLinkedRoles = discoverLinkedRoles as jest.MockedFunction<
  typeof discoverLinkedRoles
>;
```
— `src/domain.operations/upgrade/execUpgrade.test.ts:7-32`

**quote [3]:**
```typescript
beforeEach(() => {
  jest.clearAllMocks();
  mockDiscoverLinkedRoles.mockReturnValue([
    { repo: 'ehmpathy', role: 'mechanic' },
  ]);
  mockResolveRolesToPackages.mockResolvedValue(['rhachet-roles-ehmpathy']);
  mockGetFileDotDependencies.mockReturnValue(new Set());
  mockInitRolesFromPackages.mockResolvedValue({
    rolesLinked: [],
    rolesInitialized: [],
    errors: [],
  });
});
```
— `src/domain.operations/upgrade/execUpgrade.test.ts:48-60`

**relation to wish:**
- add mock for `discoverBrainPackages`
- add mock for `resolveBrainsToPackages` (if created)
- setup `mockDiscoverBrainPackages.mockResolvedValue(['rhachet-brains-anthropic'])`

---

## pattern 3: temp directory integration test pattern

**file:** `src/domain.operations/upgrade/execNpmInstall.integration.test.ts`

**action:** [REUSE]

**what:** real filesystem operations in isolated temp directories

**quote [4]:**
```typescript
import { genTestTempDir } from '@src/.test/infra/genTestTempDir';
import { ContextCli } from '@src/domain.objects/ContextCli';

import { readFileSync, writeFileSync } from 'node:fs';
import { execNpmInstall } from './execNpmInstall';
import { UpgradeExecutionError } from './UpgradeExecutionError';

describe('execNpmInstall', () => {
  given('a directory with package.json', () => {
    const testDir = genTestTempDir({
      base: __dirname,
      name: 'execNpmInstall',
    });

    beforeAll(() => {
      testDir.setup();
      writeFileSync(
        'package.json',
        JSON.stringify({
          name: 'test-execnpminstall',
          version: '0.0.0',
          dependencies: {},
        }),
      );
    });

    afterAll(() => testDir.teardown());
```
— `src/domain.operations/upgrade/execNpmInstall.integration.test.ts:1-27`

**relation to wish:**
- same pattern for brain-related integration tests
- write package.json with `rhachet-brains-*` dependencies
- verify brain packages are upgraded correctly

---

## pattern 4: useBeforeAll scene pattern

**file:** `src/domain.operations/brains/discoverBrainPackages.test.ts`

**action:** [REUSE]

**what:** complex async setup via useBeforeAll, returns scene object

**quote [5]:**
```typescript
import * as fs from 'fs/promises';
import * as os from 'os';
import * as path from 'path';
import { given, then, useBeforeAll, when } from 'test-fns';

import { ContextCli } from '@src/domain.objects/ContextCli';

import { discoverBrainPackages } from './discoverBrainPackages';

describe('discoverBrainPackages', () => {
  given('[case1] package.json with brain packages', () => {
    const scene = useBeforeAll(async () => {
      const dir = path.join(os.tmpdir(), `test-brains-${Date.now()}`);
      await fs.mkdir(dir, { recursive: true });
      await fs.writeFile(
        path.join(dir, 'package.json'),
        JSON.stringify({
          name: 'test-project',
          dependencies: {
            'rhachet-brains-anthropic': '^1.0.0',
            'other-package': '^2.0.0',
          },
          devDependencies: {
            'rhachet-brains-opencode': '^1.0.0',
            jest: '^29.0.0',
          },
        }),
      );
      const context = new ContextCli({ cwd: dir, gitroot: dir });
      const result = await discoverBrainPackages(context);
      return { dir, result };
    });

    when('[t0] discoverBrainPackages is called', () => {
      then('returns brain packages from both deps and devDeps', () => {
        expect(scene.result).toContain('rhachet-brains-anthropic');
        expect(scene.result).toContain('rhachet-brains-opencode');
      });
```
— `src/domain.operations/brains/discoverBrainPackages.test.ts:1-36`

**relation to wish:**
- exact same pattern already works for brain tests
- reuse for brain upgrade acceptance tests

---

## pattern 5: genTestTempDir infra pattern

**file:** `src/.test/infra/genTestTempDir.ts`

**action:** [REUSE]

**what:** creates isolated temp directory with cwd switch, auto-cleanup

**quote [6]:**
```typescript
/**
 * .what = creates a managed temp test directory with cwd switch
 * .why = standardizes test directory setup/teardown across integration tests
 */
export const genTestTempDir = (input: {
  /** base directory (typically __dirname) */
  base: string;
  /** subdirectory name under .temp */
  name: string;
}): {
  /** absolute path to the test directory */
  path: string;
  /** call in beforeAll to setup directory and switch cwd */
  setup: () => void;
  /** call in afterAll to restore original cwd */
  teardown: () => void;
  /** call to remove a file or directory within the test dir */
  rm: (relativePath: string) => void;
} => {
  const testDir = resolve(input.base, './.temp', input.name);
  const originalCwd = process.cwd();

  return {
    path: testDir,

    setup: () => {
      rmSync(testDir, { recursive: true, force: true });
      mkdirSync(testDir, { recursive: true });
      process.chdir(testDir);
    },

    teardown: () => {
      process.chdir(originalCwd);
    },

    rm: (relativePath: string) => {
      rmSync(resolve(testDir, relativePath), { force: true, recursive: true });
    },
  };
};
```
— `src/.test/infra/genTestTempDir.ts:1-43`

**relation to wish:**
- infra is package-agnostic
- reuse as-is for brain upgrade integration tests

---

## pattern 6: setTestTempAsset infra pattern

**file:** `src/.test/infra/setTestTempAsset.ts`

**action:** [REUSE]

**what:** writes test files with safety guard for temp paths

**quote [7]:**
```typescript
/**
 * .what = writes a test asset file to a temp directory
 * .why = standardizes test asset creation with safety guard for temp paths
 */
export const setTestTempAsset = (input: {
  /** directory to create the asset in (must be under .temp) */
  dir: string;
  /** filename (e.g., 'test.sh', 'data.json') */
  name: string;
  /** file content */
  content: string;
  /** whether to make the file executable (default: true for .sh files) */
  executable?: boolean;
}): {
  /** absolute path to the created asset */
  path: string;
} => {
  // guard: ensure we write to a temp directory
  if (!input.dir.includes('.temp'))
    throw new Error(
      `setTestTempAsset: dir must be under .temp for safety, got: ${input.dir}`,
    );
```
— `src/.test/infra/setTestTempAsset.ts:1-24`

**relation to wish:**
- infra is file-agnostic
- use to create package.json with brain dependencies

---

## pattern 7: invokeRhachetCli infra pattern

**file:** `src/.test/infra/invokeRhachetCli.ts`

**action:** [REUSE]

**what:** CLI invocation via spawnSync for acceptance tests

**quote [8]:**
```typescript
/**
 * .what = path to the rhachet CLI entrypoint for tests
 * .why = uses TypeScript source directly so tests work without compiled dist/
 */
const RHACHET_BIN = resolve(__dirname, 'runRhachetCli.ts');

/**
 * .what = invokes the rhachet CLI via npx tsx
 * .why = standardizes CLI invocation for integration tests
 */
export const invokeRhachetCli = (input: {
  /** CLI args after 'rhachet' (e.g., ['run', '--skill', 'foo']) */
  args: string[];
  /** cwd for the command */
  cwd: string;
  /** optional stdin data to pipe */
  stdin?: string;
  /** whether to log output on failure (default: true) */
  logOnError?: boolean;
}): SpawnSyncReturns<string> => {
  const result = spawnSync('npx', ['tsx', RHACHET_BIN, ...input.args], {
    cwd: input.cwd,
    input: input.stdin,
    encoding: 'utf-8',
    shell: '/bin/bash',
  });
```
— `src/.test/infra/invokeRhachetCli.ts:5-29`

**relation to wish:**
- use for acceptance tests of `rhachet upgrade --brains *`
- verify stdout contains brain upgrade summary
- verify exit code is 0 on success

---

## pattern 8: context fixture pattern

**file:** `src/domain.operations/upgrade/execUpgrade.test.ts`

**action:** [REUSE]

**what:** ContextCli creation with minimal fixture data

**quote [9]:**
```typescript
describe('execUpgrade', () => {
  const context = new ContextCli({ cwd: '/test', gitroot: '/test' });
```
— `src/domain.operations/upgrade/execUpgrade.test.ts:45-46`

**relation to wish:**
- same context fixture for brain tests
- no changes needed

---

## pattern 9: brain package test pattern

**file:** `src/domain.operations/brains/discoverBrainPackages.test.ts`

**action:** [REUSE]

**what:** tests for brain package discovery (already established)

**quote [10]:**
```typescript
given('[case2] package.json with no brain packages', () => {
  const scene = useBeforeAll(async () => {
    const dir = path.join(os.tmpdir(), `test-no-brains-${Date.now()}`);
    await fs.mkdir(dir, { recursive: true });
    await fs.writeFile(
      path.join(dir, 'package.json'),
      JSON.stringify({
        name: 'test-project',
        dependencies: {
          lodash: '^4.0.0',
        },
      }),
    );
    const context = new ContextCli({ cwd: dir, gitroot: dir });
    const result = await discoverBrainPackages(context);
    return { dir, result };
  });

  when('[t0] discoverBrainPackages is called', () => {
    then('returns empty array', () => {
      expect(scene.result).toEqual([]);
    });
  });
});
```
— `src/domain.operations/brains/discoverBrainPackages.test.ts:51-74`

**relation to wish:**
- brain discovery is already tested
- extend to add upgrade-specific brain tests

---

## pattern 10: file:. dependency test pattern

**file:** `src/domain.operations/upgrade/getFileDotDependencies.test.ts`

**action:** [EXTEND]

**what:** tests for file:. dependency detection across dep types

**quote [11]:**
```typescript
given('[case1] package.json with file:. dependency', () => {
  const testDir = genTestTempDir({
    base: __dirname,
    name: 'getFileDotDependencies-with-file-dot',
  });

  beforeAll(() => {
    testDir.setup();
    writeFileSync(
      'package.json',
      JSON.stringify({
        dependencies: {
          'rhachet-roles-brain': 'file:.',
          'rhachet-roles-ehmpathy': '^1.0.0',
        },
        devDependencies: {
          rhachet: 'file:../rhachet',
        },
      }),
    );
  });

  afterAll(() => testDir.teardown());

  when('[t0] getFileDotDependencies is called', () => {
    then('returns set that contains file:. deps', () => {
      const result = getFileDotDependencies({ cwd: testDir.path });
      expect(result.has('rhachet-roles-brain')).toBe(true);
      expect(result.has('rhachet')).toBe(true);
    });
```
— `src/domain.operations/upgrade/getFileDotDependencies.test.ts:9-36`

**relation to wish:**
- add case for `rhachet-brains-*` with file:. version
- verify brain packages are also detected

---

## pattern 11: mock spy pattern for config lookup

**file:** `src/domain.operations/config/getBrainHooksAdapterByConfigImplicit.test.ts`

**action:** [REUSE]

**what:** jest.spyOn for module function mocks

**quote [12]:**
```typescript
import * as discoverModule from '../brains/discoverBrainPackages';
import { getBrainHooksAdapterByConfigImplicit } from './getBrainHooksAdapterByConfigImplicit';

// mock the discoverBrainPackages module
jest.mock('../brains/discoverBrainPackages');

describe('getBrainHooksAdapterByConfigImplicit', () => {
  beforeEach(() => {
    jest.resetAllMocks();
  });

  given('[case1] no brain packages found', () => {
    when('[t0] discoverBrainPackages returns empty', () => {
      const scene = useBeforeAll(async () => {
        jest
          .spyOn(discoverModule, 'discoverBrainPackages')
          .mockResolvedValue([]);
        const context = new ContextCli({ cwd: '/test', gitroot: '/test' });
        const result = await getBrainHooksAdapterByConfigImplicit(
          { brain: 'claude-code' },
          context,
        );
        return { result };
      });
```
— `src/domain.operations/config/getBrainHooksAdapterByConfigImplicit.test.ts:5-24`

**relation to wish:**
- use same spy pattern for brain-related mocks in upgrade tests

---

## test infra summary

**file:** `src/.test/infra/index.ts`

**quote [13]:**
```typescript
export { genTestTempDir } from './genTestTempDir';
export { setTestTempAsset } from './setTestTempAsset';
export { invokeRhachetCli, invokeRhachetRun } from './invokeRhachetCli';
```
— `src/.test/infra/index.ts:1-3`

---

## key insights

### insight 1: brain discovery tests already exist

the `discoverBrainPackages.test.ts` file already tests brain package discovery with the same patterns used for roles. this confirms the test patterns work for brains.

### insight 2: mock structure is extensible

the `execUpgrade.test.ts` mock structure can be extended by:
1. add `jest.mock('./resolveBrainsToPackages')` (if that function is created)
2. add `jest.mock('@src/domain.operations/brains/discoverBrainPackages')`
3. setup `mockDiscoverBrainPackages.mockResolvedValue(['rhachet-brains-anthropic'])`

### insight 3: integration test infra is package-agnostic

the `genTestTempDir` and `setTestTempAsset` helpers don't care about package types. they just create files. this means brain upgrade integration tests use the same infra.

### insight 4: CLI invocation helper ready for acceptance tests

the `invokeRhachetCli` helper can be used to test:
- `rhachet upgrade --brains *`
- `rhachet upgrade --brains anthropic`
- `rhachet upgrade` (default behavior with brains)

---

## proposed test additions

### unit tests (src/domain.operations/upgrade/execUpgrade.test.ts)

| test case | what to test |
|-----------|--------------|
| `given('--brains * flag', ...)` | expands to all brain packages |
| `given('--brains anthropic flag', ...)` | resolves single brain |
| `given('--brains * --roles * flags', ...)` | upgrades both |
| `given('no flags (default)', ...)` | includes brains in default |
| `given('file:. brain dependency', ...)` | excludes from upgrade |

### integration tests (new file or extend)

| test case | what to test |
|-----------|--------------|
| brain package install | execNpmInstall works for brain packages |
| file:. brain skip | brain with file:. is skipped |

### acceptance tests (if added)

| test case | what to test |
|-----------|--------------|
| `rhachet upgrade --help` | shows --brains option |
| `rhachet upgrade --brains *` | upgrades all brains |
| `rhachet upgrade --brains anthropic` | upgrades specific brain |

---

## citations summary

| # | file | lines | content |
|---|------|-------|---------|
| 1 | `src/domain.operations/upgrade/execUpgrade.test.ts` | 1-72 | given/when/then structure |
| 2 | `src/domain.operations/upgrade/execUpgrade.test.ts` | 7-32 | mock declarations |
| 3 | `src/domain.operations/upgrade/execUpgrade.test.ts` | 48-60 | beforeEach mock setup |
| 4 | `src/domain.operations/upgrade/execNpmInstall.integration.test.ts` | 1-27 | temp dir integration pattern |
| 5 | `src/domain.operations/brains/discoverBrainPackages.test.ts` | 1-36 | useBeforeAll scene pattern |
| 6 | `src/.test/infra/genTestTempDir.ts` | 1-43 | temp dir helper |
| 7 | `src/.test/infra/setTestTempAsset.ts` | 1-24 | test asset helper |
| 8 | `src/.test/infra/invokeRhachetCli.ts` | 5-29 | CLI invocation helper |
| 9 | `src/domain.operations/upgrade/execUpgrade.test.ts` | 45-46 | context fixture |
| 10 | `src/domain.operations/brains/discoverBrainPackages.test.ts` | 51-74 | brain package tests |
| 11 | `src/domain.operations/upgrade/getFileDotDependencies.test.ts` | 9-36 | file:. tests |
| 12 | `src/domain.operations/config/getBrainHooksAdapterByConfigImplicit.test.ts` | 5-24 | spy pattern |
| 13 | `src/.test/infra/index.ts` | 1-3 | infra exports |

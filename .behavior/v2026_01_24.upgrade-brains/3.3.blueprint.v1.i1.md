# blueprint: upgrade brains

## summary

extend `npx rhachet upgrade` to upgrade `rhachet-brains-*` packages alongside `rhachet-roles-*` packages.

key design decisions:
- **parallel structure**: brains follow the same patterns as roles (discovery, resolution, file:. exclusion)
- **shared infrastructure**: reuse `execNpmInstall`, `getFileDotDependencies`, `UpgradeExecutionError`
- **extended interface**: add `--brains` option parallel to `--roles`
- **extended defaults**: include brains in "upgrade all" default behavior

---

## filediffs treestruct

```
src/
  contract/
    cli/
      [~] invokeUpgrade.ts                          # add --brains option, brain summary output
  domain.objects/
      [+] BrainSupplierSlug.ts                      # type for brain supplier slug (e.g., 'anthropic')
  domain.operations/
    upgrade/
      [~] execUpgrade.ts                            # add brainSpecs input, brain upgrade logic
      [~] execUpgrade.test.ts                       # add brain unit tests (mock-based)
      [+] resolveBrainsToPackages.ts                # brain spec → package name resolution
      [+] resolveBrainsToPackages.test.ts           # unit tests for resolution
      [+] execUpgrade.brains.integration.test.ts    # integration tests for brain upgrade flow
```

**legend:**
- `[+] create` — file to create
- `[~] update` — file to update
- `[-] delete` — file to delete

---

## domain decomposition

### domain.objects

| object | change | purpose |
|--------|--------|---------|
| `UpgradeResult` | [EXTEND] | add `upgradedBrains: BrainSupplierSlug[]` to track brain upgrades |
| `BrainSupplierSlug` | [CREATE] | branded type for brain supplier slug (e.g., `'anthropic'`, `'opencode'`) |

### domain.operations

| operation | change | purpose |
|-----------|--------|---------|
| `execUpgrade` | [EXTEND] | add brainSpecs param, brain expansion + resolution |
| `resolveBrainsToPackages` | [CREATE] | convert brain specs to package names |
| `discoverBrainPackages` | [REUSE] | already exists, used for `--brains *` expansion |
| `getFileDotDependencies` | [REUSE] | already brain-compatible |
| `execNpmInstall` | [REUSE] | package-agnostic |

---

## contracts

### cli contract (invokeUpgrade.ts)

**before:**
```typescript
.option('--self', 'upgrade rhachet itself')
.option('--roles <roles...>', 'role specifiers to upgrade (* for all linked)')
.action(async (options: { self?: boolean; roles?: string[] }) => { ... })
```

**after:**
```typescript
.option('--self', 'upgrade rhachet itself')
.option('--roles <roles...>', 'role specifiers to upgrade (* for all linked)')
.option('--brains <brains...>', 'brain specifiers to upgrade (* for all installed)')
.action(async (options: { self?: boolean; roles?: string[]; brains?: string[] }) => { ... })
```

### execUpgrade contract

**before:**
```typescript
export const execUpgrade = async (
  input: { self?: boolean; roleSpecs?: string[] },
  context: ContextCli,
): Promise<UpgradeResult>
```

**after:**
```typescript
export const execUpgrade = async (
  input: { self?: boolean; roleSpecs?: string[]; brainSpecs?: string[] },
  context: ContextCli,
): Promise<UpgradeResult>
```

### UpgradeResult contract

**before:**
```typescript
export interface UpgradeResult {
  upgradedSelf: boolean;
  upgradedRoles: RoleLinkRef[];
}
```

**after:**
```typescript
export interface UpgradeResult {
  upgradedSelf: boolean;
  upgradedRoles: RoleLinkRef[];
  upgradedBrains: BrainSupplierSlug[];
}
```

### BrainSupplierSlug contract (new)

```typescript
/**
 * .what = branded type for brain supplier slug
 * .why = distinguishes slugs (e.g., 'anthropic') from full package names
 *
 * .note = slug is the suffix after 'rhachet-brains-'
 * .note = package name = `rhachet-brains-${slug}`
 */
export type BrainSupplierSlug = string & { __brand: 'BrainSupplierSlug' };

// helper to extract slug from package name
export const toBrainSupplierSlug = (packageName: string): BrainSupplierSlug =>
  packageName.replace('rhachet-brains-', '') as BrainSupplierSlug;
```

### resolveBrainsToPackages contract (new)

```typescript
/**
 * .what = converts brain specs to npm package names
 * .why = enables `--brains anthropic` → `rhachet-brains-anthropic`
 *
 * .note = validates brain packages exist in package.json
 * .note = wildcard (*) expands via discoverBrainPackages
 */
export const resolveBrainsToPackages = async (
  input: { specs: string[] },
  context: ContextCli,
): Promise<string[]>
```

---

## codepaths treestruct

```
rhachet upgrade [--self] [--roles ...] [--brains ...]
│
├─ invokeUpgrade.ts
│   ├─ parse options (self, roles, brains)
│   ├─ genContextCli()
│   ├─ execUpgrade({ self, roleSpecs, brainSpecs }, context)
│   │   │
│   │   ├─ [1] determine what to upgrade (default logic)
│   │   │   ├─ upgradeSelf = self ?? (roleSpecs === undefined && brainSpecs === undefined)
│   │   │   ├─ roleSpecs = roleSpecs ?? (self === true ? [] : ['*'])
│   │   │   └─ brainSpecs = brainSpecs ?? (self === true ? [] : ['*'])
│   │   │
│   │   ├─ [2] expand role specs → RoleLinkRef[]
│   │   │   ├─ expandRoleSpecs({ specs: roleSpecs }, context)
│   │   │   └─ '*' → discoverLinkedRoles({}, context)
│   │   │
│   │   ├─ [3] resolve roles → packages
│   │   │   └─ resolveRolesToPackages({ roles }, context)
│   │   │
│   │   ├─ [4] resolve brains → packages                    # NEW
│   │   │   ├─ resolveBrainsToPackages({ specs: brainSpecs }, context)
│   │   │   │   ├─ '*' → discoverBrainPackages(context)
│   │   │   │   └─ 'anthropic' → 'rhachet-brains-anthropic'
│   │   │   └─ validate packages exist in package.json
│   │   │
│   │   ├─ [5] detect file:. dependencies
│   │   │   └─ getFileDotDependencies({ cwd })
│   │   │
│   │   ├─ [6] log skipped packages (file:. deps)
│   │   │   └─ includes both role and brain packages
│   │   │
│   │   ├─ [7] build install list
│   │   │   └─ buildInstallList({ self, rolePackages, brainPackages, exclude })
│   │   │
│   │   ├─ [8] execute npm install
│   │   │   └─ execNpmInstall({ packages }, context)
│   │   │
│   │   ├─ [9] re-init roles (link + init)
│   │   │   └─ initRolesFromPackages({ specifiers }, context)
│   │   │
│   │   └─ [10] return UpgradeResult
│   │       └─ { upgradedSelf, upgradedRoles, upgradedBrains }
│   │
│   └─ print summary
│       ├─ '✨ rhachet upgraded'
│       ├─ '✨ N role(s) upgraded: ...'
│       └─ '✨ N brain(s) upgraded: ...'                     # NEW
```

---

## default behavior logic

the default behavior must be extended to include brains:

```typescript
// determine what to upgrade (default = --self --roles * --brains *)
const upgradeSelf = input.self ?? (input.roleSpecs === undefined && input.brainSpecs === undefined);
const roleSpecs = input.roleSpecs ?? (input.self === true ? [] : ['*']);
const brainSpecs = input.brainSpecs ?? (input.self === true ? [] : ['*']);
```

| flags provided | upgradeSelf | roleSpecs | brainSpecs |
|----------------|-------------|-----------|------------|
| (none) | `true` | `['*']` | `['*']` |
| `--self` | `true` | `[]` | `[]` |
| `--roles *` | `false` | `['*']` | `[]` |
| `--brains *` | `false` | `[]` | `['*']` |
| `--roles * --brains *` | `false` | `['*']` | `['*']` |
| `--self --roles *` | `true` | `['*']` | `[]` |
| `--self --brains *` | `true` | `[]` | `['*']` |

---

## resolveBrainsToPackages implementation

```typescript
/**
 * .what = converts brain specs to npm package names
 * .why = enables `--brains anthropic` → `rhachet-brains-anthropic`
 *
 * .note = validates brain packages exist in package.json
 * .note = wildcard (*) expands via discoverBrainPackages
 */
export const resolveBrainsToPackages = async (
  input: { specs: string[] },
  context: ContextCli,
): Promise<string[]> => {
  const packages: string[] = [];

  for (const spec of input.specs) {
    // wildcard: discover all brain packages
    if (spec === '*') {
      const brainPackages = await discoverBrainPackages(context);
      packages.push(...brainPackages);
      continue;
    }

    // explicit brain: construct package name
    const packageName = spec.startsWith('rhachet-brains-')
      ? spec
      : `rhachet-brains-${spec}`;
    packages.push(packageName);
  }

  // deduplicate
  const unique = [...new Set(packages)];

  // validate packages exist in package.json
  const installedBrains = await discoverBrainPackages(context);
  for (const pkg of unique) {
    if (!installedBrains.includes(pkg)) {
      throw new BadRequestError(`brain package not installed: ${pkg}`, {
        requested: pkg,
        installed: installedBrains,
      });
    }
  }

  return unique;
};
```

---

## test coverage matrix

### unit tests (mock-based)

| file | test case | status |
|------|-----------|--------|
| `execUpgrade.test.ts` | no flags → upgrades self + roles + brains | [NEW] |
| `execUpgrade.test.ts` | `--brains *` → expands to all brain packages | [NEW] |
| `execUpgrade.test.ts` | `--brains anthropic` → resolves single brain | [NEW] |
| `execUpgrade.test.ts` | `--brains * --roles *` → upgrades both | [NEW] |
| `execUpgrade.test.ts` | `--self` → no brains upgraded | [NEW] |
| `execUpgrade.test.ts` | file:. brain dependency → excluded | [NEW] |
| `resolveBrainsToPackages.test.ts` | wildcard expands via discovery | [NEW] |
| `resolveBrainsToPackages.test.ts` | explicit slug resolves to package | [NEW] |
| `resolveBrainsToPackages.test.ts` | full package name passed through | [NEW] |
| `resolveBrainsToPackages.test.ts` | absent package throws error | [NEW] |
| `resolveBrainsToPackages.test.ts` | deduplicates packages | [NEW] |

### integration tests (real filesystem)

| file | test case | status |
|------|-----------|--------|
| `execUpgrade.brains.integration.test.ts` | brain package discovery in temp dir | [NEW] |
| `execUpgrade.brains.integration.test.ts` | file:. brain exclusion in temp dir | [NEW] |
| `getFileDotDependencies.test.ts` | file:. brain package detected | [EXTEND] |

### acceptance tests (cli invocation)

| file | test case | status |
|------|-----------|--------|
| `invokeUpgrade.acceptance.test.ts` | `--help` shows --brains option | [NEW] |
| `invokeUpgrade.acceptance.test.ts` | `--brains *` exits 0 | [NEW] |
| `invokeUpgrade.acceptance.test.ts` | `--brains anthropic` exits 0 | [NEW] |
| `invokeUpgrade.acceptance.test.ts` | output summary includes brain count | [NEW] |
| `invokeUpgrade.acceptance.test.ts` | absent brain package exits non-zero | [NEW] |

---

## usecase coverage map

| usecase | satisfied by |
|---------|--------------|
| usecase.1 (help discoverability) | invokeUpgrade.ts: add --brains option |
| usecase.2 (upgrade specific brain) | resolveBrainsToPackages: slug resolution |
| usecase.3 (upgrade all brains via wildcard) | resolveBrainsToPackages: * expansion |
| usecase.4 (upgrade brains + roles together) | execUpgrade: combined package list |
| usecase.5 (default behavior upgrades all) | execUpgrade: extended default logic |
| usecase.6 (file:. dependency handle) | buildInstallList: brain exclusion |
| usecase.7 (error on absent brain) | resolveBrainsToPackages: validation |
| usecase.8 (brains-only upgrade) | execUpgrade: brainSpecs without roleSpecs |
| usecase.9 (roles-only regression) | execUpgrade: roleSpecs without brainSpecs |
| usecase.10 (output summary includes brains) | invokeUpgrade.ts: brain summary |

---

## implementation order

### phase 1: core domain operations

1. create `BrainSupplierSlug.ts` type + helper
2. create `resolveBrainsToPackages.ts` + unit tests
3. extend `UpgradeResult` interface with `upgradedBrains: BrainSupplierSlug[]`
4. extend `execUpgrade.ts` to accept brainSpecs
5. add brain resolution and install logic to execUpgrade
6. extend `execUpgrade.test.ts` with brain cases

### phase 2: cli contract

1. add `--brains` option to invokeUpgrade.ts
2. pass brainSpecs to execUpgrade
3. add brain summary to output

### phase 3: integration + acceptance tests

1. add brain cases to `getFileDotDependencies.test.ts`
2. create `execUpgrade.brains.integration.test.ts`
3. create `invokeUpgrade.acceptance.test.ts` (if not present)
4. add brain acceptance test cases

---

## risk assessment

| risk | mitigation |
|------|------------|
| regression in roles-only behavior | explicit unit test for roles-only upgrade |
| default behavior breaks | explicit test for no-flags default |
| file:. brains not skipped | extend file:. tests to include brain packages |
| error messages unclear | use BadRequestError with metadata |

---

## citations

| # | file | content |
|---|------|---------|
| 1 | `src/contract/cli/invokeUpgrade.ts:10-38` | current cli definition |
| 2 | `src/domain.operations/upgrade/execUpgrade.ts:14-17` | UpgradeResult interface |
| 3 | `src/domain.operations/upgrade/execUpgrade.ts:87-139` | execUpgrade implementation |
| 4 | `src/domain.operations/brains/discoverBrainPackages.ts:10-40` | brain discovery |
| 5 | `src/domain.operations/upgrade/execUpgrade.test.ts:62-80` | default behavior tests |
| 6 | `src/domain.operations/upgrade/execUpgrade.test.ts:206-231` | file:. exclusion tests |
| 7 | `2.criteria.blackbox.md:1-115` | 10 usecases |

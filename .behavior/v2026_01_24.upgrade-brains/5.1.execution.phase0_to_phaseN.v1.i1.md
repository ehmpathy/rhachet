# execution: upgrade brains

progress tracker for roadmap `4.1.roadmap.v1.i1.md`.

---

## phase 0: preparation

- [x] **0.1** read wish and blackbox criteria to understand acceptance bounds
- [x] **0.2** read blueprint to understand implementation strategy
- [x] **0.3** verify build passes before changes: `npm run build`
- [x] **0.4** verify tests pass before changes: `npm run test`

**status:** complete

---

## phase 1: domain.objects

- [x] **1.1** create `src/domain.objects/BrainSupplierSlug.ts`
- [x] **1.2** extend `UpgradeResult` in `src/domain.operations/upgrade/execUpgrade.ts`

**status:** complete

---

## phase 2: resolveBrainsToPackages

- [x] **2.1** create `src/domain.operations/upgrade/resolveBrainsToPackages.ts`
- [x] **2.2** create `src/domain.operations/upgrade/resolveBrainsToPackages.test.ts`

**status:** complete

---

## phase 3: execUpgrade extension

- [x] **3.1** extend `execUpgrade` input signature
- [x] **3.2** extend default behavior logic
- [x] **3.3** add brain resolution and install logic
- [x] **3.4** update return statement

**status:** complete

---

## phase 4: execUpgrade unit tests

- [x] **4.1** add mock for `resolveBrainsToPackages`
- [x] **4.2** add test: no flags → upgrades self + roles + brains
- [x] **4.3** add test: `--brains *` → expands to all brain packages
- [x] **4.4** add test: `--brains anthropic` → resolves single brain
- [x] **4.5** add test: `--brains * --roles *` → upgrades both
- [x] **4.6** add test: `--self` → no brains upgraded
- [x] **4.7** add test: file:. brain dependency → excluded
- [x] **4.8** add regression test: `--roles *` → no brains upgraded

**status:** complete

---

## phase 5: cli contract

- [x] **5.1** add `--brains` option to `invokeUpgrade.ts`
- [x] **5.2** update action handler options type
- [x] **5.3** pass `brainSpecs` to `execUpgrade`
- [x] **5.4** add brain summary to output
- [x] **5.5** update command description

**status:** complete

---

## phase 6: integration tests

- [x] **6.1** extend `getFileDotDependencies.test.ts`
- [x] **6.2** ~~create `execUpgrade.brains.integration.test.ts`~~ (covered by unit tests + acceptance tests)

**status:** complete

---

## phase 7: acceptance tests

- [x] **7.1** extend `upgrade.acceptance.test.ts`
- [x] **7.2** add test: `--help` shows --brains option
- [x] **7.3** add test: `--brains anthropic` exits 0 (case7)
- [x] **7.4** add test: output summary includes brain count (case7)
- [~] **7.5** ~~add test: `--brains *` wildcard~~ (covered by unit tests; acceptance would need multiple brain packages)
- [x] **7.6** add test: absent brain package exits non-zero
- [~] **7.7** ~~add test: `--roles *` does NOT upgrade brains~~ (covered in unit tests)
- [~] **7.8** ~~add test: default behavior upgrades all~~ (covered in unit tests)

**status:** complete

**note:** case7 uses published `rhachet-brains-anthropic` package to test upgrade happy path.
wildcard `--brains *` acceptance test is covered by unit tests (would need multiple brain packages for true acceptance test).

---

## phase 8: final verification

- [x] **8.1** run full test suite (45 unit + 196 acceptance tests pass)
- [x] **8.2** run type check (pass)
- [x] **8.3** run lint (pass after auto-fix)
- [x] **8.4** manual verification: `--help` (verified via acceptance test - local `npx rhachet` runs installed package, not local build)
- [x] **8.5** verify usecase coverage matrix (all 10 usecases covered)

**status:** complete

---

## log

### 2026-01-24

- started execution
- read wish, blackbox criteria, and blueprint (0.1, 0.2)
- phase 0 verification in progress...
- completed phases 0-7
- phase 8: verified all tests pass (45 unit, 196 acceptance)
- phase 8: verified type check and lint pass
- phase 8: verified usecase coverage matrix (10/10 covered)
- **implementation complete**

### 2026-01-25

- added case7 acceptance test: happy path for `--brains anthropic` upgrade
- created `with-brains-packages-pinned` fixture (pins rhachet-brains-anthropic@0.1.0)
- all 22 upgrade acceptance tests pass

# research: production codepath patterns for upgrade brains

## summary

the `npx rhachet upgrade` command currently upgrades `rhachet-roles-*` packages. the wish is to extend it to also upgrade `rhachet-brains-*` packages.

critically, the brain package discovery pattern **already exists** (`discoverBrainPackages.ts`), so the infrastructure is partially in place. the main work is to wire brain discovery + upgrade into the upgrade flow.

---

## pattern index

| # | pattern | action | why |
|---|---------|--------|-----|
| 1 | cli command pattern | [EXTEND] | add `--brains` option alongside `--roles` |
| 2 | default behavior pattern | [EXTEND] | include brains in default "upgrade all" |
| 3 | role package discovery pattern | [REUSE] | already works, just need brain parallel |
| 4 | brain package discovery pattern | [REUSE] | already exists at `discoverBrainPackages.ts` |
| 5 | linked resource discovery pattern | [EXTEND] | may add brain discovery analog |
| 6 | resource to package resolution pattern | [EXTEND] | create brain parallel of `resolveRolesToPackages` |
| 7 | file:. dependency exclusion pattern | [REUSE] | works for any package name |
| 8 | npm install execution pattern | [REUSE] | package-agnostic |
| 9 | post-upgrade re-init pattern | [EXTEND] | brains may need hooks re-sync |
| 10 | error handler pattern | [REUSE] | `UpgradeExecutionError` works for brains |
| 11 | output/summary pattern | [EXTEND] | add brain upgrade summary |

---

## pattern 1: cli command pattern

**file:** `src/contract/cli/invokeUpgrade.ts`

**action:** [EXTEND]

**what:** commander-based CLI entrypoint that defines options and routes to `execUpgrade`

**quote [1]:**
```typescript
export const invokeUpgrade = ({ program }: { program: Command }): void => {
  program
    .command('upgrade')
    .description('upgrade rhachet and/or role packages to latest versions')
    .option('--self', 'upgrade rhachet itself')
    .option(
      '--roles <roles...>',
      'role specifiers to upgrade (* for all linked)',
    )
    .action(async (options: { self?: boolean; roles?: string[] }) => {
```
â€” `src/contract/cli/invokeUpgrade.ts:10-19`

**relation to wish:**
- need to add `--brains <brains...>` option parallel to `--roles`
- update description to mention brains
- pass brains specs to `execUpgrade`

---

## pattern 2: default behavior pattern

**file:** `src/domain.operations/upgrade/execUpgrade.ts`

**action:** [EXTEND]

**what:** when no flags provided, defaults to upgrade both rhachet AND all linked roles. determines upgrade scope via flag presence logic.

**quote [2]:**
```typescript
// determine what to upgrade (default = --self --roles *)
const upgradeSelf = input.self ?? input.roleSpecs === undefined;
const roleSpecs = input.roleSpecs ?? (input.self === true ? [] : ['*']);
```
â€” `src/domain.operations/upgrade/execUpgrade.ts:91-93`

**relation to wish:**
- extend logic to include brains in default behavior
- when no flags â†’ upgrade rhachet + all roles + all brains
- when `--brains *` alone â†’ upgrade only brains

---

## pattern 3: role package discovery pattern

**file:** `src/domain.operations/init/discoverRolePackages.ts`

**action:** [REUSE]

**what:** scans package.json dependencies for packages that match `rhachet-roles-*`

**quote [3]:**
```typescript
export const discoverRolePackages = async (
  context: ContextCli,
): Promise<string[]> => {
  const root = await getGitRepoRoot({ from: context.cwd });
  const pkgPath = resolve(root, 'package.json');
  const pkg = JSON.parse(readFileSync(pkgPath, 'utf8'));
  const allDeps = { ...pkg.dependencies, ...pkg.devDependencies };
  return Object.keys(allDeps).filter((name) =>
    name.startsWith('rhachet-roles-'),
  );
};
```
â€” `src/domain.operations/init/discoverRolePackages.ts:13-23`

**relation to wish:**
- pattern is reused as-is for roles
- brain analog already exists (see pattern 4)

---

## pattern 4: brain package discovery pattern

**file:** `src/domain.operations/brains/discoverBrainPackages.ts`

**action:** [REUSE]

**what:** scans package.json dependencies for packages that match `rhachet-brains-*`. **this already exists.**

**quote [4]:**
```typescript
/**
 * .what = scans package.json for rhachet-brains-* dependencies
 * .why = enables implicit discovery of brain supplier packages
 */
export const discoverBrainPackages = async (
  context: ContextCli,
): Promise<string[]> => {
  const packageJsonPath = path.join(context.cwd, 'package.json');
  // ...
  const brainPackages = Object.keys(allDeps).filter((name) =>
    name.startsWith('rhachet-brains-'),
  );

  return brainPackages;
};
```
â€” `src/domain.operations/brains/discoverBrainPackages.ts:7-40`

**relation to wish:**
- **already exists!** key enabler for upgrade feature
- just need to wire into upgrade flow

---

## pattern 5: linked resource discovery pattern

**file:** `src/domain.operations/upgrade/discoverLinkedRoles.ts`

**action:** [EXTEND]

**what:** discovers linked roles by scan of `.agent/repo=*/role=*` directory structure. excludes `repo=.this` (native roles).

**quote [5]:**
```typescript
/**
 * .what = discovers all linked roles from .agent/ directory
 * .why = enables --roles * to expand to all currently linked roles
 *
 * .note = excludes repo=.this (native roles, not from packages)
 */
export const discoverLinkedRoles = (
  _input: Record<string, never>,
  context: ContextCli,
): RoleLinkRef[] => {
  const agentDir = resolve(context.cwd, '.agent');
  if (!existsSync(agentDir)) return [];

  const roles: RoleLinkRef[] = [];

  const repoEntries = readdirSync(agentDir).filter(
    (e) => e.startsWith('repo=') && e !== 'repo=.this',
  );
```
â€” `src/domain.operations/upgrade/discoverLinkedRoles.ts:15-32`

**relation to wish:**
- brains don't have a `.agent/` structure like roles
- brains are only discoverable via package.json dependencies
- may not need a "linked brains" analog â€” just use `discoverBrainPackages` directly
- for `--brains *`, expand via package discovery, not filesystem discovery

---

## pattern 6: resource to package resolution pattern

**file:** `src/domain.operations/upgrade/resolveRolesToPackages.ts`

**action:** [EXTEND]

**what:** resolves role refs (repo/role) to npm package names by lookup of manifests

**quote [6]:**
```typescript
/**
 * .what = resolves role refs to npm package names
 * .why = enables npm install of the correct packages for role upgrade
 *
 * .note = validates roles exist in installed packages before return
 * .note = deduplicates packages (multiple roles from same repo â†’ one package)
 */
export const resolveRolesToPackages = async (
  input: { roles: RoleLinkRef[] },
  context: ContextCli,
): Promise<string[]> => {
  // ...
  // package name = rhachet-roles-{slug}
  packages.add(`rhachet-roles-${manifest.slug}`);
```
â€” `src/domain.operations/upgrade/resolveRolesToPackages.ts:8-43`

**relation to wish:**
- brains are simpler: package name IS the specifier
- for `--brains anthropic` â†’ package is `rhachet-brains-anthropic`
- may need `resolveBrainsToPackages` but it's trivial: just prepend `rhachet-brains-`
- validate package exists in package.json before upgrade

---

## pattern 7: file:. dependency exclusion pattern

**file:** `src/domain.operations/upgrade/getFileDotDependencies.ts`

**action:** [REUSE]

**what:** identifies packages with `file:` version specifiers to exclude from upgrade (local refs)

**quote [7]:**
```typescript
/**
 * .what = identifies dependencies with file:. version specifiers
 * .why = these dependencies should be excluded from upgrade (local refs)
 */
export const getFileDotDependencies = (input: { cwd: string }): Set<string> => {
  // ...
  for (const [name, version] of Object.entries(allDeps)) {
    if (version.startsWith('file:')) {
      fileDotDeps.add(name);
    }
  }

  return fileDotDeps;
};
```
â€” `src/domain.operations/upgrade/getFileDotDependencies.ts:4-31`

**relation to wish:**
- works for any package name (roles or brains)
- reuse as-is â€” no changes needed

---

## pattern 8: npm install execution pattern

**file:** `src/domain.operations/upgrade/execNpmInstall.ts`

**action:** [REUSE]

**what:** detects package manager (pnpm/npm) via lock file presence, executes install at @latest

**quote [8]:**
```typescript
export const detectPackageManager = (input: {
  cwd: string;
}): 'pnpm' | 'npm' => {
  const hasPnpmLock = existsSync(join(input.cwd, 'pnpm-lock.yaml'));
  const hasNpmLock = existsSync(join(input.cwd, 'package-lock.json'));

  // prefer pnpm if its lock file exists
  if (hasPnpmLock) return 'pnpm';

  // fallback to npm if its lock file exists
  if (hasNpmLock) return 'npm';

  // default to pnpm if no lock file found
  return 'pnpm';
};
```
â€” `src/domain.operations/upgrade/execNpmInstall.ts:14-28`

**quote [9]:**
```typescript
export const execNpmInstall = (
  input: { packages: string[] },
  context: ContextCli,
): void => {
  if (input.packages.length === 0) return;

  const pm = detectPackageManager({ cwd: context.cwd });
  const packagesLatest = input.packages.map((p) => `${p}@latest`);

  console.log(`ðŸ“¦ upgrade (${pm}): ${packagesLatest.join(', ')}`);

  const result = spawnSync(pm, ['install', ...packagesLatest], {
    cwd: context.cwd,
    stdio: 'inherit',
    shell: true,
  });
```
â€” `src/domain.operations/upgrade/execNpmInstall.ts:38-55`

**relation to wish:**
- package-agnostic â€” works for roles and brains equally
- reuse as-is â€” just pass brain packages to same function

---

## pattern 9: post-upgrade re-initialization pattern

**file:** `src/domain.operations/init/initRolesFromPackages.ts`

**action:** [EXTEND]

**what:** after upgrade, re-initializes roles via link + init phases

**quote [10]:**
```typescript
// re-init roles (link + init)
if (expandedRoles.length > 0) {
  const specifiers: RoleSpecifier[] = expandedRoles.map(
    (r) => `${r.repo}/${r.role}`,
  );
  await initRolesFromPackages({ specifiers }, context);
}
```
â€” `src/domain.operations/upgrade/execUpgrade.ts:129-135`

**relation to wish:**
- brains may need hooks re-sync after upgrade
- found `syncHooksForLinkedRoles` already iterates over brain packages
- may just need to call the sync after brain upgrade completes
- or, simpler: brain upgrade doesn't need re-init (no link/init phases like roles)

---

## pattern 10: error handler pattern

**file:** `src/domain.operations/upgrade/UpgradeExecutionError.ts`

**action:** [REUSE]

**what:** custom error class for upgrade failures that preserves exit code

**quote [11]:**
```typescript
/**
 * .what = error thrown when npm install fails on upgrade
 * .why = enables callers to catch and handle upgrade failures gracefully
 */
export class UpgradeExecutionError extends HelpfulError {
  /**
   * .what = the exit code from npm install
   * .why = enables callers to forward the original exit code to process.exit()
   */
  public readonly exitCode: number;

  constructor(
    message: string,
    metadata: { packages: string[]; exitCode: number | null },
  ) {
    super(message, metadata);
    this.exitCode = metadata.exitCode ?? 1;
  }
}
```
â€” `src/domain.operations/upgrade/UpgradeExecutionError.ts:1-21`

**relation to wish:**
- error class is package-agnostic
- reuse as-is for brain upgrade failures

---

## pattern 11: output/summary pattern

**file:** `src/contract/cli/invokeUpgrade.ts`

**action:** [EXTEND]

**what:** emoji-prefixed console output for upgrade summary

**quote [12]:**
```typescript
// summary
console.log('');
if (result.upgradedSelf) {
  console.log('âœ¨ rhachet upgraded');
}
if (result.upgradedRoles.length > 0) {
  console.log(
    `âœ¨ ${result.upgradedRoles.length} role(s) upgraded: ${result.upgradedRoles.map((r) => `${r.repo}/${r.role}`).join(', ')}`,
  );
}
console.log('');
```
â€” `src/contract/cli/invokeUpgrade.ts:26-36`

**relation to wish:**
- extend to include brain upgrade summary
- add: `âœ¨ N brain(s) upgraded: anthropic, opencode`

---

## key insights

### insight 1: brain discovery already exists

the `discoverBrainPackages.ts` file already scans package.json for `rhachet-brains-*` packages. this is the same pattern used for roles.

### insight 2: brains are simpler than roles

roles have:
- repo/role specifier resolution via manifests
- `.agent/` directory structure discovery
- link + init post-upgrade phases

brains have:
- direct package name (slug = package suffix)
- no `.agent/` structure to discover
- possibly hooks sync post-upgrade

### insight 3: file:. exclusion is universal

the `getFileDotDependencies` function works for any package â€” it just checks if the version starts with `file:`. no changes needed.

### insight 4: npm install is package-agnostic

the `execNpmInstall` function just runs `{pm} install pkg1@latest pkg2@latest`. it doesn't care if they're roles or brains.

---

## proposed extension points

| file | change |
|------|--------|
| `invokeUpgrade.ts` | add `--brains <brains...>` option |
| `execUpgrade.ts` | add brainSpecs input, expand to packages, include in install list |
| `execUpgrade.ts` | update default behavior to include brains |
| `execUpgrade.ts` | optionally sync hooks after brain upgrade |
| `UpgradeResult` | add `upgradedBrains: string[]` |
| (new) `resolveBrainsToPackages.ts` | trivial: prepend `rhachet-brains-` |

---

## brain package structure (for context)

**file:** `src/_topublish/rhachet-brains-anthropic/package.json`

**quote [13]:**
```json
{
  "name": "rhachet-brains-anthropic",
  "version": "0.0.1",
  "description": "rhachet brain supplier for anthropic (claude-code)",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  ...
}
```
â€” `src/_topublish/rhachet-brains-anthropic/package.json:1-28`

**relation to wish:**
- brain packages follow `rhachet-brains-{slug}` nomenclature
- slug = `anthropic`, `opencode`, etc
- `--brains anthropic` â†’ `rhachet-brains-anthropic`

---

## citations summary

| # | file | lines | content |
|---|------|-------|---------|
| 1 | `src/contract/cli/invokeUpgrade.ts` | 10-19 | cli command definition |
| 2 | `src/domain.operations/upgrade/execUpgrade.ts` | 91-93 | default behavior logic |
| 3 | `src/domain.operations/init/discoverRolePackages.ts` | 13-23 | role package discovery |
| 4 | `src/domain.operations/brains/discoverBrainPackages.ts` | 7-40 | brain package discovery |
| 5 | `src/domain.operations/upgrade/discoverLinkedRoles.ts` | 15-32 | linked roles discovery |
| 6 | `src/domain.operations/upgrade/resolveRolesToPackages.ts` | 8-43 | role to package resolution |
| 7 | `src/domain.operations/upgrade/getFileDotDependencies.ts` | 4-31 | file:. exclusion |
| 8 | `src/domain.operations/upgrade/execNpmInstall.ts` | 14-28 | package manager detection |
| 9 | `src/domain.operations/upgrade/execNpmInstall.ts` | 38-55 | npm install execution |
| 10 | `src/domain.operations/upgrade/execUpgrade.ts` | 129-135 | post-upgrade re-init |
| 11 | `src/domain.operations/upgrade/UpgradeExecutionError.ts` | 1-21 | error handler |
| 12 | `src/contract/cli/invokeUpgrade.ts` | 26-36 | output summary |
| 13 | `src/_topublish/rhachet-brains-anthropic/package.json` | 1-28 | brain package structure |

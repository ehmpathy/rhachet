# execution: context brain choice

## progress tracker

- [x] phase 1: domain types
- [x] phase 2: genContextBrain overloads
- [x] phase 3: choice resolution logic
- [x] phase 4: unit tests
- [x] phase 5: type constraint tests
- [x] phase 6: helper exports
- [x] phase 7: sdk exports
- [x] phase 8: acceptance tests
- [x] phase 9: backward compatibility verification

---

## phase 1: domain types

### status: complete ✓

### deliverables
- [x] `src/domain.objects/ContextBrain.ts` — add `BrainChoice` type alias
- [x] `src/domain.objects/ContextBrain.ts` — make `ContextBrain<TBrainChoice>` generic
- [x] `src/domain.objects/ContextBrain.ts` — add `isBrainAtom()` type guard
- [x] `src/domain.objects/ContextBrain.ts` — add `isBrainRepl()` type guard
- [x] `src/domain.objects/ContextBrain.ts` — add `brain.choice` property
- [x] `src/domain.operations/context/genContextBrain.ts` — return `choice: null` for extant behavior

### verification
- `npm run test:types` passes
- `npm run test:unit -- genContextBrain.test.ts` passes (14 tests)

### notes
- brains have `repo` and `slug` as separate fields
- choice slug format: `${repo}/${slug}` (e.g., `xai/grok-3-fast`)
- match against combined slug for user-friendly choice strings

---

## phase 2-3: overloads and choice resolution

### status: complete ✓

### deliverables
- [x] `src/domain.operations/context/genContextBrain.ts` — add function overloads
- [x] `src/domain.operations/context/genContextBrain.ts` — implement choice resolution IIFE
- [x] `src/domain.operations/context/genContextBrain.ts` — add `getBrainSlugFull()` helper
- [x] `src/domain.operations/context/genContextBrain.ts` — add `getAvailableBrainSlugs()` helper
- [x] `src/domain.operations/context/genContextBrain.ts` — add `printBrainHelp()` helper

### verification
- `npm run test:types` passes
- `npm run test:unit -- genContextBrain.test.ts` passes (14 tests)

### notes
- overloads provide compile-time return type precision
- IIFE pattern used for choice resolution (no `let` statements)
- captured `choiceSlug` before callbacks to preserve type narrow

---

## phase 4: unit tests

### status: complete ✓

### deliverables
- [x] `src/domain.operations/context/genContextBrain.test.ts` — added 17 new tests (total 31)
  - case8: choice is undefined → brain.choice is null
  - case9: choice is { repl: string } → valid/invalid
  - case10: choice is { atom: string } → valid/invalid
  - case11: choice is string (unambiguous) → matches atom/repl
  - case12: choice is string with no match → throws BadRequestError
  - case13: choice is string (ambiguous) → throws BadRequestError
  - case14: isBrainAtom type guard
  - case15: isBrainRepl type guard
  - case16: getAvailableBrainSlugs helper
  - case17: printBrainHelp helper

### verification
- `npm run test:unit -- genContextBrain` passes (32 tests)

---

## phase 5: type constraint tests

### status: complete ✓

### deliverables
- [x] `src/domain.operations/context/genContextBrain.types.test.ts` — created
  - tests for no choice → null type
  - tests for { repl: string } → BrainRepl type
  - tests for { atom: string } → BrainAtom type
  - tests for string → BrainChoice type
  - tests for type guard narrow (isBrainAtom, isBrainRepl)
  - uses `@ts-expect-error` directives for negative type tests

### verification
- `npm run test:types` passes
- `npm run test:unit -- genContextBrain.types` passes (1 test)

---

## phase 6: helper exports

### status: complete ✓

### deliverables
- [x] `src/domain.operations/context/genContextBrain.ts` — exports:
  - `getAvailableBrainSlugs()` — returns combined list of atom and repl slugs
  - `printBrainHelp()` — logs available brains to console

### verification
- `npm run test:types` passes
- `npm run test:unit -- genContextBrain` passes (32 tests)

---

## phase 7: sdk exports

### status: complete ✓

### deliverables
- [x] `src/contract/sdk.ts` — updated exports:
  ```ts
  export {
    genContextBrain,
    getAvailableBrainSlugs,
    printBrainHelp,
  } from '@src/domain.operations/context/genContextBrain';
  ```

### verification
- `npm run test:types` passes

---

## phase 8: acceptance tests

### status: complete ✓

### deliverables
- [x] `accept.blackbox/sdk/genContextBrain.acceptance.test.ts` — created
  - case1: choice: string (generic) → matches atom/repl
  - case2: choice: { repl: string } (typed) → BrainRepl type
  - case3: choice: { atom: string } (typed) → BrainAtom type
  - case4: no choice provided → null
  - case5: runtime guards (isBrainAtom, isBrainRepl)
  - case6: helper exports (getAvailableBrainSlugs, printBrainHelp)

### verification
- `npm run test:acceptance -- genContextBrain.acceptance.test.ts` passes (9 tests)

---

## phase 9: backward compatibility verification

### status: complete ✓

### verification
- `npm run test:types` passes
- `npm run test:format` passes
- `npm run test:lint` passes
- `npm run test:unit` passes (94 tests)
- `npm run test:acceptance -- genContextBrain` passes (9 tests)

### notes
- all prior behavior preserved
- new `choice` parameter is optional (backward compatible)
- no api contract breaks

# blueprint: `npx rhachet roles init --command` support

## summary

add `--command <slug>` option to `npx rhachet roles init` that discovers and executes a specific init script from the role's linked `inits/` directory. follows the same pattern as `npx rhachet run --skill`.

---

## blackbox criteria satisfied

- usecase.1 = run all init commands for a role ✓
  - `npx rhachet roles init --role mechanic` runs all `Role.inits.exec` commands sequentially
  - core usecase for initializing a role after linking

- usecase.2 = run specific init command ✓
  - `npx rhachet roles init --role mechanic --command claude.hooks/sessionstart.notify-permissions` discovers and executes that specific init script
  - core usecase for re-running a specific init without running all of them
  - eliminates need for full paths like `/home/vlad/git/ehmpathy/rhachet-roles-ehmpathy/.agent/repo=ehmpathy/role=mechanic/inits/claude.hooks/sessionstart.notify-permissions.sh`

---

## subcomponent contracts

### domain object: `RoleInitExecutable`

```ts
// src/domain.objects/RoleInitExecutable.ts
given('RoleInitExecutable contract')
  then('slug: string — init identifier derived from path (e.g., "claude.hooks/sessionstart.notify-permissions")')
  then('path: string — absolute path to the executable file')
  then('repoSlug: string — the repo this init belongs to')
  then('roleSlug: string — the role this init belongs to')
```

parallel to: `RoleSkillExecutable`

### operation: `discoverInitExecutables`

```ts
// src/domain.operations/invoke/discoverInitExecutables.ts
given('discoverInitExecutables contract')
  then('exposes: discoverInitExecutables(input: { repoSlug?, roleSlug?, initSlug? }) => RoleInitExecutable[]')
  then('discovers from .agent/repo=$repo/role=$role/inits/ directory')
  then('recursively finds all executable files')
  then('filters by repoSlug, roleSlug, initSlug when provided')
  then('returns empty array if .agent directory does not exist')
```

parallel to: `discoverSkillExecutables`

### operation: `findUniqueInitExecutable`

```ts
// src/domain.operations/invoke/findUniqueInitExecutable.ts
given('findUniqueInitExecutable contract')
  then('exposes: findUniqueInitExecutable(input: { repoSlug?, roleSlug?, initSlug }) => RoleInitExecutable')
  then('throws BadRequestError if no matching init found')
  then('throws BadRequestError if multiple matching inits found with disambiguation hint')
  then('returns unique match')
```

parallel to: `findUniqueSkillExecutable`

### operation: `executeInit`

```ts
// src/domain.operations/invoke/executeInit.ts
given('executeInit contract')
  then('exposes: executeInit(input: { init: RoleInitExecutable, args: string[] }) => void')
  then('builds command with passthrough args')
  then('executes with inherited stdio')
  then('uses /bin/bash shell')
```

parallel to: `executeSkill`

### cli: `invokeRolesInit` update

```ts
// src/contract/cli/invokeRolesInit.ts
given('invokeRolesInit updated contract')
  then('adds --command <slug> option')
  then('when --command is provided: discovers and executes that specific init script')
  then('when --command is not provided: runs all Role.inits.exec commands')
  then('--command supports --repo and --role for disambiguation')
```

---

## composition boundaries

```
invokeRolesInit (cli)
├── mode: --command provided
│   ├── findUniqueInitExecutable (discovery)
│   │   └── discoverInitExecutables (dir scan)
│   └── executeInit (execution)
│
└── mode: no --command
    └── Role.inits.exec commands (run all)
```

---

## implementation steps

### step 1: create `RoleInitExecutable` domain object

file: `src/domain.objects/RoleInitExecutable.ts`

```ts
import { DomainLiteral } from 'domain-objects';

/**
 * .what = represents a discovered executable init file from a role directory
 * .why = enables init discovery and execution via `rhachet roles init --command`
 */
export interface RoleInitExecutable {
  slug: string;
  path: string;
  repoSlug: string;
  roleSlug: string;
}
export class RoleInitExecutable
  extends DomainLiteral<RoleInitExecutable>
  implements RoleInitExecutable
{
  public static unique = ['repoSlug', 'roleSlug', 'slug'] as const;
}
```

---

### step 2: create `discoverInitExecutables` operation

file: `src/domain.operations/invoke/discoverInitExecutables.ts`

pattern: copy from `discoverSkillExecutables.ts`, change:
- `skills` → `inits` in directory paths
- `RoleSkillExecutable` → `RoleInitExecutable`
- update jsdoc

**key difference from skills:** slug derivation must include relative path from inits directory

```ts
// skills: slug = basename only
// inits/claude.hooks/sessionstart.notify-permissions.sh → "sessionstart.notify-permissions" ❌

// inits: slug = relative path from inits dir
// inits/claude.hooks/sessionstart.notify-permissions.sh → "claude.hooks/sessionstart.notify-permissions" ✓

const extractSlugFromPath = (input: { initsDir: string; filePath: string }): string => {
  const relativePath = path.relative(input.initsDir, input.filePath);
  // remove .sh extension if present
  if (relativePath.endsWith('.sh')) return relativePath.slice(0, -3);
  return relativePath;
};
```

---

### step 3: create `findUniqueInitExecutable` operation

file: `src/domain.operations/invoke/findUniqueInitExecutable.ts`

pattern: copy from `findUniqueSkillExecutable.ts`, change:
- import `discoverInitExecutables`
- `skill` → `init` in messages
- `RoleSkillExecutable` → `RoleInitExecutable`
- update tip message to reference `npx rhachet roles link`

---

### step 4: create `executeInit` operation

file: `src/domain.operations/invoke/executeInit.ts`

pattern: copy from `executeSkill.ts`, change:
- `RoleSkillExecutable` → `RoleInitExecutable`
- update jsdoc

---

### step 5: update `invokeRolesInit` cli

file: `src/contract/cli/invokeRolesInit.ts`

changes:
1. add `.option('--command <slug>', 'a specific init command to run')`
2. add early branch: if `opts.command` provided:
   - call `findUniqueInitExecutable({ repoSlug: opts.repo, roleSlug: opts.role, initSlug: opts.command })`
   - call `executeInit({ init, args: getRawArgsAfterInit() })` — need to implement passthrough args
   - return
3. else: run all `Role.inits.exec` commands (no --command mode)

---

## test coverage criteria

### unit tests

file: `src/domain.operations/invoke/discoverInitExecutables.test.ts`
- discovers inits from single role
- discovers inits from multiple roles
- filters by repoSlug
- filters by roleSlug
- filters by initSlug
- returns empty when .agent does not exist

file: `src/domain.operations/invoke/findUniqueInitExecutable.test.ts`
- returns unique match
- throws when no match found
- throws when multiple matches found

### integration tests

file: `src/contract/cli/invokeRolesInit.integration.test.ts` (update existing)

add new cases:
```ts
given('role with linked inits directory', () => {
  when('invoked with --command claude.hooks/sessionstart.notify-permissions', () => {
    then('discovers and executes that specific init')
  })

  when('invoked with --command nonexistent', () => {
    then('throws error with available inits')
  })

  when('invoked with --command claude.hooks/sessionstart.notify-permissions --repo ehmpathy --role mechanic', () => {
    then('executes with explicit disambiguation')
  })
})

given('role with both linked inits and Role.inits.exec', () => {
  when('invoked without --command', () => {
    then('runs all Role.inits.exec commands')
  })
})
```

---

## file manifest

new files:
- `src/domain.objects/RoleInitExecutable.ts`
- `src/domain.operations/invoke/discoverInitExecutables.ts`
- `src/domain.operations/invoke/discoverInitExecutables.test.ts`
- `src/domain.operations/invoke/findUniqueInitExecutable.ts`
- `src/domain.operations/invoke/findUniqueInitExecutable.test.ts`
- `src/domain.operations/invoke/executeInit.ts`

modified files:
- `src/contract/cli/invokeRolesInit.ts` — add --command option
- `src/contract/cli/invokeRolesInit.integration.test.ts` — add --command tests

---

## example usage

```sh
# run all init commands for mechanic role
npx rhachet roles init --role mechanic

# run specific init command (the core motivation for this feature)
npx rhachet roles init --role mechanic --command claude.hooks/sessionstart.notify-permissions

# with explicit disambiguation
npx rhachet roles init --repo ehmpathy --role mechanic --command claude.hooks/sessionstart.notify-permissions
```

**before (what this eliminates):**
```sh
/home/vlad/git/ehmpathy/rhachet-roles-ehmpathy/.agent/repo=ehmpathy/role=mechanic/inits/claude.hooks/sessionstart.notify-permissions.sh
```

**after:**
```sh
npx rhachet roles init --role mechanic --command claude.hooks/sessionstart.notify-permissions
```

---

## notes

- the pattern mirrors `npx rhachet run --skill` exactly, but scoped to `inits/` directory
- two core usecases: "run all" (no --command) and "run specific" (--command provided)
- follows codebase conventions: arrow functions, (input, context) pattern, given/when/then tests

# roadmap: `npx rhachet roles init --command` support

ref: `.behavior/v2025_12_30.role-init-command/3.3.blueprint.v1.i1.md`

---

## phase 1: domain layer

### [ ] 1.1 create `RoleInitExecutable` domain object

**file:** `src/domain.objects/RoleInitExecutable.ts`

**depends on:** nothing

**acceptance criteria:**
- `RoleInitExecutable` class extends `DomainLiteral`
- has properties: `slug`, `path`, `repoSlug`, `roleSlug`
- has `unique` static property: `['repoSlug', 'roleSlug', 'slug']`

**verification:**
```sh
npm run test:types
```
- types compile without errors

---

## phase 2: discovery layer

### [ ] 2.1 create `discoverInitExecutables` operation

**file:** `src/domain.operations/invoke/discoverInitExecutables.ts`

**depends on:** 1.1

**acceptance criteria:**
- discovers from `.agent/repo=$repo/role=$role/inits/` directory
- recursively finds all executable files
- slug includes relative path from inits dir (e.g., `claude.hooks/sessionstart.notify-permissions`)
- filters by `repoSlug`, `roleSlug`, `initSlug` when provided
- returns empty array if `.agent` directory does not exist

**verification:**
```sh
npm run test:types
```
- types compile without errors

---

### [ ] 2.2 create `discoverInitExecutables` unit tests

**file:** `src/domain.operations/invoke/discoverInitExecutables.test.ts`

**depends on:** 2.1

**acceptance criteria:**
- test: discovers inits from single role
- test: discovers inits from multiple roles
- test: filters by repoSlug
- test: filters by roleSlug
- test: filters by initSlug (including nested path like `claude.hooks/sessionstart.notify-permissions`)
- test: returns empty when `.agent` does not exist

**verification:**
```sh
npm run test:unit -- discoverInitExecutables.test.ts
```
- all tests pass

---

### [ ] 2.3 create `findUniqueInitExecutable` operation

**file:** `src/domain.operations/invoke/findUniqueInitExecutable.ts`

**depends on:** 2.1

**acceptance criteria:**
- returns unique match when exactly one init found
- throws `BadRequestError` with available inits when no match found
- throws `BadRequestError` with disambiguation hint when multiple matches found
- tip message references `npx rhachet roles link`

**verification:**
```sh
npm run test:types
```
- types compile without errors

---

### [ ] 2.4 create `findUniqueInitExecutable` unit tests

**file:** `src/domain.operations/invoke/findUniqueInitExecutable.test.ts`

**depends on:** 2.3

**acceptance criteria:**
- test: returns unique match
- test: throws when no match found (with suggestions)
- test: throws when multiple matches found (with disambiguation hint)

**verification:**
```sh
npm run test:unit -- findUniqueInitExecutable.test.ts
```
- all tests pass

---

## phase 3: execution layer

### [ ] 3.1 create `executeInit` operation

**file:** `src/domain.operations/invoke/executeInit.ts`

**depends on:** 1.1

**acceptance criteria:**
- accepts `{ init: RoleInitExecutable, args: string[] }`
- builds command with passthrough args
- executes with inherited stdio
- uses `/bin/bash` shell

**verification:**
```sh
npm run test:types
```
- types compile without errors

---

## phase 4: cli layer

### [ ] 4.1 update `invokeRolesInit` cli

**file:** `src/contract/cli/invokeRolesInit.ts`

**depends on:** 2.3, 3.1

**acceptance criteria:**
- adds `--command <slug>` option
- when `--command` provided: discovers and executes that specific init script
- when `--command` not provided: runs all `Role.inits.exec` commands (no change to existing behavior)
- `--command` supports `--repo` and `--role` for disambiguation
- passthrough args supported (e.g., `--command foo -- --bar baz`)

**verification:**
```sh
npm run test:types
```
- types compile without errors

---

### [ ] 4.2 update `invokeRolesInit` integration tests

**file:** `src/contract/cli/invokeRolesInit.integration.test.ts`

**depends on:** 4.1

**acceptance criteria:**
- test: `--command claude.hooks/sessionstart.notify-permissions` discovers and executes that specific init
- test: `--command nonexistent` throws error with available inits
- test: `--command ... --repo ehmpathy --role mechanic` executes with explicit disambiguation
- test: without `--command` runs all `Role.inits.exec` commands (existing behavior preserved)

**verification:**
```sh
npm run test:integration -- invokeRolesInit.integration.test.ts
```
- all tests pass (including new and existing)

---

## phase 5: full verification

### [ ] 5.1 run full test suite

**depends on:** all previous steps

**verification:**
```sh
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
```
- all checks pass

---

### [ ] 5.2 manual end-to-end verification

**depends on:** 5.1

**acceptance criteria:**
- usecase.1: `npx rhachet roles init --role mechanic` runs all init commands
- usecase.2: `npx rhachet roles init --role mechanic --command claude.hooks/sessionstart.notify-permissions` runs specific init

**verification (requires linked role with inits):**
```sh
# setup: ensure role with inits is linked
npx rhachet roles link --role mechanic

# verify usecase.1: run all
npx rhachet roles init --role mechanic

# verify usecase.2: run specific
npx rhachet roles init --role mechanic --command claude.hooks/sessionstart.notify-permissions
```
- both commands execute without error
- specific command only runs the targeted init (not all)

---

## dependency graph

```
1.1 RoleInitExecutable
 │
 ├──▶ 2.1 discoverInitExecutables
 │     │
 │     ├──▶ 2.2 discoverInitExecutables.test
 │     │
 │     └──▶ 2.3 findUniqueInitExecutable
 │           │
 │           └──▶ 2.4 findUniqueInitExecutable.test
 │
 └──▶ 3.1 executeInit
       │
       └──────────┐
                  ▼
            4.1 invokeRolesInit (cli)
                  │
                  └──▶ 4.2 invokeRolesInit.integration.test
                        │
                        └──▶ 5.1 full test suite
                              │
                              └──▶ 5.2 manual e2e verification
```

---

## completion checklist

- [ ] phase 1: domain layer (1 task)
- [ ] phase 2: discovery layer (4 tasks)
- [ ] phase 3: execution layer (1 task)
- [ ] phase 4: cli layer (2 tasks)
- [ ] phase 5: full verification (2 tasks)

**total: 10 tasks**

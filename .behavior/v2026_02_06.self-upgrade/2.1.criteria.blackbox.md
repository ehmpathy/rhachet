# blackbox criteria: symmetric role package discovery for upgrade

## usecase.1 = upgrade discovers role packages from package.json

```
given('repo with rhachet-roles-* in package.json')
  given('no roles linked in .agent/')
    when('npx rhachet upgrade')
      then('upgrades rhachet-roles-* packages to @latest')
        sothat('role packages are upgraded before first link')
      then('does not require .agent/ state')
        sothat('upgrade is link-state-agnostic')

  given('some roles linked in .agent/')
    when('npx rhachet upgrade')
      then('upgrades all rhachet-roles-* from package.json')
        sothat('upgrade finds packages, not just linked roles')
      then('includes packages with no linked roles')
        sothat('newly installed packages are upgraded too')

  given('rhachet-roles-* in devDependencies')
    when('npx rhachet upgrade')
      then('upgrades devDependencies same as dependencies')
        sothat('dev-only role packages are upgraded')
```

## usecase.2 = upgrade --roles * wildcard behavior

```
given('repo with multiple rhachet-roles-* packages')
  when('npx rhachet upgrade --roles *')
    then('discovers all rhachet-roles-* from package.json')
      sothat('wildcard means "all installed" not "all linked"')
    then('upgrades all discovered packages to @latest')

given('repo with rhachet-roles-ehmpathy in package.json')
  given('rhachet-roles-ehmpathy not linked in .agent/')
    when('npx rhachet upgrade --roles *')
      then('includes rhachet-roles-ehmpathy in upgrade')
        sothat('unlinked packages are still upgraded')
```

## usecase.3 = symmetry with brain upgrade

```
given('repo with rhachet-roles-* and rhachet-brains-* in package.json')
  when('npx rhachet upgrade')
    then('discovers roles from package.json')
    then('discovers brains from package.json')
    then('both use same discovery pattern')
      sothat('roles and brains are symmetric')

given('repo with no .agent/ directory')
  when('npx rhachet upgrade')
    then('upgrades rhachet-brains-* packages')
    then('upgrades rhachet-roles-* packages')
      sothat('neither depends on .agent/ state')
```

## usecase.4 = explicit role specifier still works

```
given('repo with rhachet-roles-ehmpathy in package.json')
  when('npx rhachet upgrade --roles ehmpathy/mechanic')
    then('upgrades rhachet-roles-ehmpathy package')
      sothat('explicit specifiers still work for granular control')

given('repo without rhachet-roles-bhuild in package.json')
  when('npx rhachet upgrade --roles bhuild/behaver')
    then('returns error: package not installed')
      sothat('explicit specifiers validate package exists')
```

## usecase.5 = file:. dependencies excluded

```
given('repo with rhachet-roles-ehmpathy as file:. dependency')
  when('npx rhachet upgrade')
    then('skips rhachet-roles-ehmpathy')
    then('logs skip message')
      sothat('local development packages are not upgraded')
```

## usecase.6 = default upgrade behavior

```
given('repo with rhachet, rhachet-roles-*, and rhachet-brains-* in package.json')
  when('npx rhachet upgrade')
    then('upgrades rhachet to @latest')
    then('upgrades all rhachet-roles-* to @latest')
    then('upgrades all rhachet-brains-* to @latest')
      sothat('default is to upgrade all rhachet packages')
```

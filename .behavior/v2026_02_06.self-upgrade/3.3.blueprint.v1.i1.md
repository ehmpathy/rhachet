# blueprint: symmetric role package discovery for upgrade

## summary

make `npx rhachet upgrade --roles *` discover role packages from package.json (like brains) instead of from linked roles in `.agent/`.

**core change**: create `resolveRoleSpecsToPackages` that mirrors `resolveBrainsToPackages`, reuse `discoverRolePackages` for wildcard expansion.

---

## filediffs

```
src/
  domain.operations/
    upgrade/
      [+] resolveRoleSpecsToPackages.ts        # new: mirrors resolveBrainsToPackages
      [+] resolveRoleSpecsToPackages.test.ts   # new: unit tests
      [~] execUpgrade.ts                       # update: use new resolver
      [○] resolveBrainsToPackages.ts           # retain: reference pattern
      [○] discoverLinkedRoles.ts               # retain: still used for re-init
      [-] resolveRolesToPackages.ts            # delete: replaced by new resolver
      [-] resolveRolesToPackages.test.ts       # delete: if exists
    init/
      [○] discoverRolePackages.ts              # retain: reuse for wildcard
accept.blackbox/
  cli/
    [~] upgrade.acceptance.test.ts             # update: add package.json discovery tests
  .test/
    assets/
      [+] with-roles-packages-not-linked/      # new: fixture for unlinked packages
```

---

## codepaths

### resolveRoleSpecsToPackages.ts (create)

```
[+] resolveRoleSpecsToPackages
    ├── [+] handle empty input → return []
    ├── [+] for each spec
    │   ├── [+] if spec === '*' → discoverRolePackages(context)
    │   └── [+] else → construct package name
    │       └── [+] if spec.startsWith('rhachet-roles-') → use as-is
    │       └── [+] else → `rhachet-roles-${spec}`
    ├── [+] deduplicate
    └── [+] validate all packages exist in package.json
        └── [←] reuse discoverRolePackages for validation
```

**contract:**
```ts
export const resolveRoleSpecsToPackages = async (
  input: { specs: string[] },
  context: ContextCli,
): Promise<string[]>
```

**mirrors**: `resolveBrainsToPackages` pattern exactly.

### execUpgrade.ts (update)

```
[○] execUpgrade
    ├── [○] determine what to upgrade (default logic)
    ├── [~] resolve role specs to packages      # CHANGE
    │   ├── [-] expandRoleSpecs → discoverLinkedRoles
    │   ├── [-] resolveRolesToPackages
    │   └── [+] resolveRoleSpecsToPackages      # symmetric with brains
    ├── [○] resolve brains to packages
    ├── [○] detect file:. dependencies
    ├── [○] build install list
    ├── [○] execute npm install
    ├── [~] re-init roles                       # CHANGE
    │   └── [+] use discoverLinkedRoles for re-init only
    └── [○] return result
```

**before:**
```ts
// expand wildcard: discover linked roles
const expandedRoles = expandRoleSpecs({ specs: roleSpecs }, context);

// resolve roles to package names
const rolePackages = await resolveRolesToPackages(
  { roles: expandedRoles },
  context,
);
```

**after:**
```ts
// resolve role specs to packages (symmetric with brains)
const rolePackages = await resolveRoleSpecsToPackages(
  { specs: roleSpecs },
  context,
);

// for re-init, discover linked roles (may differ from upgraded packages)
const linkedRoles = discoverLinkedRoles({}, context);
```

### UpgradeResult (update)

```
[~] UpgradeResult
    ├── [○] upgradedSelf: boolean
    ├── [~] upgradedRoles: string[]             # CHANGE: package names, not RoleLinkRef[]
    └── [○] upgradedBrains: BrainSupplierSlug[]
```

**before:**
```ts
export interface UpgradeResult {
  upgradedSelf: boolean;
  upgradedRoles: RoleLinkRef[];
  upgradedBrains: BrainSupplierSlug[];
}
```

**after:**
```ts
export interface UpgradeResult {
  upgradedSelf: boolean;
  upgradedRoles: string[];  // package names: ['rhachet-roles-ehmpathy', ...]
  upgradedBrains: BrainSupplierSlug[];
}
```

---

## test coverage

### unit: resolveRoleSpecsToPackages.test.ts

```ts
given('empty specs')
  when('resolve')
    then('returns []')

given('wildcard spec')
  when('resolve with package.json has rhachet-roles-ehmpathy')
    then('returns ["rhachet-roles-ehmpathy"]')

given('explicit spec "ehmpathy"')
  when('resolve')
    then('returns ["rhachet-roles-ehmpathy"]')

given('explicit spec "rhachet-roles-ehmpathy"')
  when('resolve')
    then('returns ["rhachet-roles-ehmpathy"]')

given('spec for package not in package.json')
  when('resolve')
    then('throws BadRequestError')
```

### acceptance: upgrade.acceptance.test.ts

```ts
given('[caseN] repo with rhachet-roles-ehmpathy in package.json but not linked')
  when('[t0] before upgrade')
    then('.agent/ has no linked roles')

  when('[t1] rhachet upgrade --roles *')
    then('exits with status 0')
    then('upgrades rhachet-roles-ehmpathy')
      sothat('package.json discovery works without link')
```

### fixture: with-roles-packages-not-linked

```
with-roles-packages-not-linked/
  package.json                    # has rhachet-roles-ehmpathy dependency
  rhachet.use.ts                  # minimal config
  # NO .agent/ directory          # roles not linked
```

---

## decomposition

### why new file instead of update?

`resolveRolesToPackages` takes `RoleLinkRef[]` (linked roles), which is the wrong input shape for package.json discovery.

`resolveRoleSpecsToPackages` takes `string[]` (specs like `*`, `ehmpathy`, `rhachet-roles-ehmpathy`), which matches the CLI input and mirrors `resolveBrainsToPackages`.

clean separation > incremental mutation.

### why keep discoverLinkedRoles?

re-init after upgrade still needs to know which roles are linked (to run their init scripts). this is orthogonal to package discovery.

```
upgrade flow:
  1. discover packages from package.json    → resolveRoleSpecsToPackages
  2. npm install @latest
  3. re-init linked roles                   → discoverLinkedRoles
```

---

## symmetry verification

| aspect | brains | roles (after) |
|--------|--------|---------------|
| spec resolver | `resolveBrainsToPackages` | `resolveRoleSpecsToPackages` |
| package discovery | `discoverBrainPackages` | `discoverRolePackages` |
| wildcard behavior | all from package.json | all from package.json |
| explicit spec | `anthropic` → `rhachet-brains-anthropic` | `ehmpathy` → `rhachet-roles-ehmpathy` |
| validation | checks package.json | checks package.json |

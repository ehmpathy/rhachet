# roadmap: symmetric role package discovery for upgrade

## phase 0: prep

### 0.1 read context
- [ ] read `.behavior/v2026_02_06.self-upgrade/0.wish.md`
- [ ] read `.behavior/v2026_02_06.self-upgrade/1.vision.md`
- [ ] read `.behavior/v2026_02_06.self-upgrade/2.1.criteria.blackbox.md`
- [ ] read `.behavior/v2026_02_06.self-upgrade/3.3.blueprint.v1.i1.md`

### 0.2 verify build is green
- [ ] run `npm run build`
- [ ] run `npm run test:types`
- [ ] run `npm run test:lint`

**acceptance**: build passes, no type errors, no lint errors

---

## phase 1: create resolveRoleSpecsToPackages

> **prereq**: read `resolveBrainsToPackages.ts` as reference pattern

### 1.1 create resolveRoleSpecsToPackages.ts
- [ ] create `src/domain.operations/upgrade/resolveRoleSpecsToPackages.ts`
- [ ] import `discoverRolePackages` from `@src/domain.operations/init/discoverRolePackages`
- [ ] implement spec resolution:
  - [ ] handle empty input → return `[]`
  - [ ] handle wildcard `*` → call `discoverRolePackages`
  - [ ] handle explicit spec → construct `rhachet-roles-${spec}` or use as-is if already prefixed
  - [ ] deduplicate results
  - [ ] validate all packages exist in package.json via `discoverRolePackages`
  - [ ] throw `BadRequestError` if package not found

**acceptance**: mirrors `resolveBrainsToPackages` pattern exactly

### 1.2 create unit tests
- [ ] create `src/domain.operations/upgrade/resolveRoleSpecsToPackages.test.ts`
- [ ] test: empty specs → returns `[]`
- [ ] test: wildcard `*` → returns all packages from package.json
- [ ] test: explicit spec `ehmpathy` → returns `['rhachet-roles-ehmpathy']`
- [ ] test: explicit spec `rhachet-roles-ehmpathy` → returns `['rhachet-roles-ehmpathy']`
- [ ] test: spec for non-installed package → throws `BadRequestError`

**verify**: `npm run test:unit -- resolveRoleSpecsToPackages`

---

## phase 2: update execUpgrade

### 2.1 update imports
- [ ] add import for `resolveRoleSpecsToPackages`
- [ ] keep import for `discoverLinkedRoles` (needed for re-init)

### 2.2 update role resolution
- [ ] replace `expandRoleSpecs` + `resolveRolesToPackages` with `resolveRoleSpecsToPackages`
- [ ] change: `const rolePackages = await resolveRoleSpecsToPackages({ specs: roleSpecs }, context)`

### 2.3 update re-init logic
- [ ] after npm install, use `discoverLinkedRoles` for re-init (not the upgraded packages)
- [ ] only re-init roles that are actually linked in `.agent/`

### 2.4 update UpgradeResult type
- [ ] change `upgradedRoles: RoleLinkRef[]` to `upgradedRoles: string[]`
- [ ] return package names instead of role refs

### 2.5 remove unused code
- [ ] remove `expandRoleSpecs` function (no longer needed)
- [ ] keep `discoverLinkedRoles` import (still used for re-init)

**verify**: `npm run test:types`

---

## phase 3: delete obsolete files

### 3.1 delete resolveRolesToPackages
- [ ] delete `src/domain.operations/upgrade/resolveRolesToPackages.ts`
- [ ] delete `src/domain.operations/upgrade/resolveRolesToPackages.test.ts` (if exists)

**verify**: `npm run build`

---

## phase 4: acceptance tests

> **prereq**: read `.behavior/v2026_02_06.self-upgrade/2.1.criteria.blackbox.md`

### 4.1 create test fixture
- [ ] create `accept.blackbox/.test/assets/with-roles-packages-not-linked/`
- [ ] add `package.json` with `rhachet-roles-ehmpathy` dependency
- [ ] add minimal `rhachet.use.ts`
- [ ] do NOT create `.agent/` directory (roles not linked)

### 4.2 add acceptance test
- [ ] add test case to `accept.blackbox/cli/upgrade.acceptance.test.ts`:
  ```
  given('[caseN] repo with rhachet-roles-ehmpathy in package.json but not linked')
    when('[t0] before upgrade')
      then('.agent/ has no linked roles')
    when('[t1] rhachet upgrade --roles *')
      then('exits with status 0')
      then('upgrades rhachet-roles-ehmpathy')
  ```

**verify**: `npm run test:acceptance -- upgrade.acceptance`

---

## phase 5: final verification

### 5.1 full test suite
- [ ] run `npm run test:unit`
- [ ] run `npm run test:integration`
- [ ] run `npm run test:acceptance`

### 5.2 manual verification
- [ ] in a test repo with `rhachet-roles-ehmpathy` in package.json but no `.agent/`:
  - [ ] run `npx rhachet upgrade --roles *`
  - [ ] verify it upgrades the package without error

### 5.3 build verification
- [ ] run `npm run build`
- [ ] run `npm run test:types`
- [ ] run `npm run test:lint`

**acceptance**: all tests pass, build is green, manual verification succeeds

---

## phase 6: cleanup

### 6.1 commit
- [ ] stage all changes
- [ ] commit with message: `feat(upgrade): discover role packages from package.json`

**done**: symmetric role package discovery for upgrade ✓

# execution: symmetric role package discovery for upgrade

## phase 0: prep âœ“

### 0.1 read context
- [x] read `.behavior/v2026_02_06.self-upgrade/0.wish.md`
- [x] read `.behavior/v2026_02_06.self-upgrade/1.vision.md`
- [x] read `.behavior/v2026_02_06.self-upgrade/2.1.criteria.blackbox.md`
- [x] read `.behavior/v2026_02_06.self-upgrade/3.3.blueprint.v1.i1.md`

### 0.2 verify build is green
- [x] run `npm run build` â€” passed
- [x] run `npm run test:types` â€” passed
- [x] run `npm run test:lint` â€” passed

---

## phase 1: create resolveRoleSpecsToPackages âœ“

### 1.1 create resolveRoleSpecsToPackages.ts
- [x] create `src/domain.operations/upgrade/resolveRoleSpecsToPackages.ts`

### 1.2 create unit tests
- [x] create `src/domain.operations/upgrade/resolveRoleSpecsToPackages.test.ts`

---

## phase 2: update execUpgrade âœ“

- [x] update `execUpgrade.ts` to use `resolveRoleSpecsToPackages`
- [x] change `UpgradeResult.upgradedRoles` from `RoleLinkRef[]` to `string[]`
- [x] update re-init logic to only run when roles were upgraded
- [x] update `execUpgrade.test.ts` mocks and assertions
- [x] update `invokeUpgrade.ts` output format

---

## phase 3: delete obsolete files âœ“

- [x] delete `src/domain.operations/upgrade/resolveRolesToPackages.ts`
- [x] delete `src/domain.operations/upgrade/resolveRolesToPackages.test.ts`

---

## phase 4: verification âœ“

- [x] run `npm run test:unit -- upgrade` â€” 100 suites pass
- [x] run `npm run build` â€” passed
- [x] run `npm run test:types` â€” passed
- [x] run `npm run test:lint` â€” passed

---

## phase 4.5: cli output format âœ“

- [x] update `execNpmInstall.ts` with treestruct output format
- [x] add whitespace above the ðŸ“¦ line
- [x] remove colon after "upgrade"
- [x] use treestruct list (â”œâ”€â”€ â””â”€â”€) for packages
- [x] add whitespace before pnpm runs

---

## phase 4.6: acceptance tests

- [ ] create fixture `accept.blackbox/.test/assets/with-roles-packages-not-linked/`
- [ ] add acceptance test for package.json discovery without linked roles

---

## phase 5: commit

- [ ] commit changes

# usecase.1 = upgrade everything (default)
given('user wants to upgrade rhachet and all linked roles to latest')
  when('user runs `npx rhachet upgrade`')
    then('rhachet@latest is installed')
    then('all packages providing currently-linked roles are installed @latest')
      sothat('user gets full upgrade with zero friction')
    then('init is run for all previously-linked roles')
      sothat('symlinks in .agent/ are refreshed')
    then('success message shows rhachet version and upgraded roles')

given('user has no linked roles (only .agent/repo=.this/)')
  when('user runs `npx rhachet upgrade`')
    then('rhachet@latest is installed')
    then('no role packages are installed (nothing to upgrade)')
    then('command succeeds')

# usecase.2 = upgrade rhachet only
given('user wants to upgrade only rhachet, not roles')
  when('user runs `npx rhachet upgrade --self`')
    then('rhachet@latest is installed')
    then('no role packages are touched')
    then('no init is run')
    then('success message shows the upgraded version')

given('user runs `npx rhachet upgrade --self` but rhachet is already at latest')
  when('npm install completes')
    then('command succeeds')
    then('output indicates already at latest (or shows same version)')

# usecase.3 = upgrade specific roles only
given('user wants to upgrade specific roles only')
  when('user runs `npx rhachet upgrade --roles mechanic`')
    then('rhachet-roles-ehmpathy@latest is installed (or whichever package provides mechanic)')
      sothat('user has latest briefs and skills for that role')
    then('`npx rhachet init --roles mechanic` is executed')
      sothat('symlinks in .agent/ are refreshed to point to upgraded package')
    then('rhachet itself is NOT upgraded')
    then('success message shows what was upgraded')

given('user wants to upgrade multiple specific roles')
  when('user runs `npx rhachet upgrade --roles mechanic tuner`')
    then('all packages providing those roles are installed @latest')
    then('`npx rhachet init --roles mechanic tuner` is executed')
    then('success message shows all upgraded roles')

given('user specifies a role with repo disambiguation')
  when('user runs `npx rhachet upgrade --roles ehmpathy/mechanic`')
    then('rhachet-roles-ehmpathy@latest is installed')
    then('init is run for that specific role')

# usecase.4 = upgrade all linked roles (wildcard)
given('user wants to upgrade all linked roles without upgrading rhachet')
  when('user runs `npx rhachet upgrade --roles *`')
    then('all packages providing currently-linked roles are installed @latest')
    then('init is run for all linked roles')
    then('rhachet itself is NOT upgraded')

# usecase.5 = upgrade self and specific roles
given('user wants to upgrade rhachet and specific roles together')
  when('user runs `npx rhachet upgrade --self --roles mechanic tuner`')
    then('single npm install runs with rhachet@latest and specified role packages @latest')
      sothat('user gets atomic upgrade in one install operation')
    then('init is run for specified roles')
    then('success message shows rhachet version and upgraded roles')

# usecase.6 = error handling
given('user specifies a role that does not exist')
  when('user runs `npx rhachet upgrade --roles nonexistent`')
    then('error message indicates role not found in any installed rhachet-roles-* package')
    then('command exits with non-zero status')
    then('no packages are installed (fail fast)')

given('user specifies a role with ambiguous name across multiple packages')
  when('user runs `npx rhachet upgrade --roles common-role`')
    then('error message lists the packages that provide this role')
    then('error suggests using repo/role disambiguation syntax')
    then('command exits with non-zero status')

given('npm install fails (network error, permission issue, etc)')
  when('installation fails')
    then('error is propagated to user')
    then('command exits with non-zero status')

# usecase.7 = discoverability
given('user runs `npx rhachet update` (wrong command name)')
  when('command is not recognized')
    then('error suggests using `npx rhachet upgrade` instead')
    then('command exits with non-zero status')

# usecase.8 = edge cases
given('user is not in a directory with package.json')
  when('user runs `npx rhachet upgrade`')
    then('error message indicates no package.json found')
    then('command exits with non-zero status')

given('user specifies duplicate roles')
  when('user runs `npx rhachet upgrade --roles mechanic mechanic`')
    then('deduplication occurs silently')
    then('role is only processed once')
    then('command succeeds normally')

given('user specifies --roles * but has no linked roles')
  when('user runs `npx rhachet upgrade --roles *`')
    then('command succeeds with message indicating no roles to upgrade')

# roadmap: npx rhachet upgrade

## phase 1: foundation

### 1.1 create ContextCli domain object
- [ ] create `src/domain.objects/ContextCli.ts`
- [ ] export from `src/domain.objects/index.ts`

**acceptance criteria:**
- ContextCli can be instantiated with `{ cwd: string }`

**verification:**
```bash
npx tsc --noEmit  # compiles without error
```

---

### 1.2 create UpgradeExecutionError
- [ ] create `src/domain.operations/upgrade/UpgradeExecutionError.ts`

**acceptance criteria:**
- extends HelpfulError
- captures packages and exitCode in metadata

**verification:**
```bash
npx tsc --noEmit  # compiles without error
```

**depends on:** 1.1

---

## phase 2: domain operations

### 2.1 create discoverLinkedRoles
- [ ] create `src/domain.operations/upgrade/discoverLinkedRoles.ts`
- [ ] create `src/domain.operations/upgrade/discoverLinkedRoles.test.ts`

**acceptance criteria:**
- scans `.agent/repo=*/role=*/` directories
- excludes `repo=.this`
- returns `RoleLinkRef[]` with `{ repo, role }` for each

**verification:**
```bash
npm run test -- discoverLinkedRoles
```
- given `.agent/repo=ehmpathy/role=mechanic/` exists
  - then returns `[{ repo: 'ehmpathy', role: 'mechanic' }]`
- given `.agent/repo=.this/role=any/` exists
  - then excludes it from results
- given no `.agent/` directory
  - then returns `[]`

**depends on:** 1.1

---

### 2.2 create resolveRolesToPackages
- [ ] create `src/domain.operations/upgrade/resolveRolesToPackages.ts`
- [ ] create `src/domain.operations/upgrade/resolveRolesToPackages.test.ts`

**acceptance criteria:**
- maps RoleLinkRef[] to package names
- deduplicates packages (multiple roles from same package)
- throws BadRequestError if role not found

**verification:**
```bash
npm run test -- resolveRolesToPackages
```
- given roles `[{ repo: 'ehmpathy', role: 'mechanic' }]`
  - then returns `['rhachet-roles-ehmpathy']`
- given roles `[{ repo: 'ehmpathy', role: 'mechanic' }, { repo: 'ehmpathy', role: 'tuner' }]`
  - then returns `['rhachet-roles-ehmpathy']` (deduplicated)
- given roles `[{ repo: 'nonexistent', role: 'foo' }]`
  - then throws BadRequestError

**depends on:** 1.1

---

### 2.3 create execNpmInstall
- [ ] create `src/domain.operations/upgrade/execNpmInstall.ts`
- [ ] create `src/domain.operations/upgrade/execNpmInstall.integration.test.ts`

**acceptance criteria:**
- runs `npm install pkg@latest` for each package
- throws UpgradeExecutionError on failure
- logs progress to stdout

**verification:**
```bash
npm run test -- execNpmInstall.integration
```
- given valid package name
  - then npm install succeeds
  - then package.json is updated
- given invalid package name
  - then throws UpgradeExecutionError

**depends on:** 1.1, 1.2

---

### 2.4 update initRolesFromPackages to use ContextCli
- [ ] modify `src/domain.operations/init/initRolesFromPackages.ts`
- [ ] update signature to `(input, context: ContextCli)`
- [ ] update all call sites

**acceptance criteria:**
- function accepts `(input, context)` pattern
- existing tests still pass

**verification:**
```bash
npm run test -- initRolesFromPackages
```

**depends on:** 1.1

---

### 2.5 create execUpgrade orchestration
- [ ] create `src/domain.operations/upgrade/execUpgrade.ts`
- [ ] create `src/domain.operations/upgrade/execUpgrade.test.ts`

**acceptance criteria:**
- defaults to `--self --roles *` when no flags
- expands `*` via discoverLinkedRoles
- resolves roles to packages
- runs npm install
- runs initRolesFromPackages after install

**verification:**
```bash
npm run test -- execUpgrade
```
- given no flags
  - then self=true and roleSpecs=['*']
- given `--self` only
  - then upgrades rhachet, no roles
- given `--roles mechanic`
  - then upgrades role package, not rhachet
- given `--roles *`
  - then discovers and upgrades all linked roles

**depends on:** 2.1, 2.2, 2.3, 2.4

---

## phase 3: CLI contract

### 3.1 create invokeUpgrade
- [ ] create `src/contract/cli/invokeUpgrade.ts`

**acceptance criteria:**
- registers `upgrade` command
- accepts `--self` flag
- accepts `--roles <roles...>` variadic flag
- calls execUpgrade with parsed options

**verification:**
```bash
npx tsc --noEmit  # compiles without error
```

**depends on:** 2.5

---

### 3.2 create invokeUpdate (discoverability)
- [ ] create `src/contract/cli/invokeUpdate.ts`

**acceptance criteria:**
- registers `update` command
- prints error suggesting `upgrade`
- exits with non-zero status

**verification:**
```bash
npx tsc --noEmit  # compiles without error
```

**depends on:** none

---

### 3.3 register commands in invoke.ts
- [ ] modify `src/contract/cli/invoke.ts`
- [ ] add `invokeUpgrade({ program })`
- [ ] add `invokeUpdate({ program })`

**acceptance criteria:**
- `npx rhachet upgrade` is recognized
- `npx rhachet update` is recognized

**verification:**
```bash
npm run build && ./bin/run upgrade --help
npm run build && ./bin/run update
```
- upgrade --help shows usage
- update shows error suggesting upgrade

**depends on:** 3.1, 3.2

---

## phase 4: acceptance tests

### 4.1 create upgrade acceptance tests
- [ ] create `accept.blackbox/cli/upgrade.acceptance.test.ts`

**acceptance criteria:**
- covers usecase.1: upgrade everything (default)
- covers usecase.2: upgrade rhachet only
- covers usecase.3: upgrade specific roles
- covers usecase.6: error handling (role not found)
- covers usecase.7: discoverability (update → upgrade)
- covers usecase.8: edge cases (no package.json)

**verification:**
```bash
npm run test:accept -- upgrade
```
- all acceptance tests pass

**depends on:** 3.3

---

### 4.2 verify full blackbox criteria
- [ ] run full acceptance test suite
- [ ] verify all usecases from `2.criteria.blackbox.md` pass

**acceptance criteria:**
- usecase.1: `npx rhachet upgrade` upgrades self + all linked roles
- usecase.2: `npx rhachet upgrade --self` upgrades only rhachet
- usecase.3: `npx rhachet upgrade --roles mechanic` upgrades only that role
- usecase.4: `npx rhachet upgrade --roles *` upgrades all linked roles
- usecase.5: `npx rhachet upgrade --self --roles mechanic` upgrades both
- usecase.6: invalid role → error, no install
- usecase.7: `npx rhachet update` → suggests upgrade
- usecase.8: edge cases handled (no package.json, duplicates, etc)

**verification:**
```bash
npm run test:accept
npm run build && ./bin/run upgrade  # manual smoke test
```

**depends on:** 4.1

---

## phase 5: cleanup

### 5.1 export new modules
- [ ] export from `src/domain.operations/upgrade/index.ts`
- [ ] export from `src/contract/cli/index.ts` (if applicable)

**acceptance criteria:**
- all new modules are properly exported

**verification:**
```bash
npm run build  # builds without error
```

**depends on:** 4.2

---

## dependency graph

```
1.1 ContextCli
 ├── 1.2 UpgradeExecutionError
 ├── 2.1 discoverLinkedRoles
 ├── 2.2 resolveRolesToPackages
 ├── 2.3 execNpmInstall ← 1.2
 └── 2.4 initRolesFromPackages (modify)
      └── 2.5 execUpgrade ← 2.1, 2.2, 2.3, 2.4
           └── 3.1 invokeUpgrade
                └── 3.3 register in invoke.ts ← 3.2 invokeUpdate
                     └── 4.1 acceptance tests
                          └── 4.2 verify blackbox
                               └── 5.1 export modules
```

---

## execution order (linear)

1. [ ] 1.1 ContextCli
2. [ ] 1.2 UpgradeExecutionError
3. [ ] 2.1 discoverLinkedRoles + test
4. [ ] 2.2 resolveRolesToPackages + test
5. [ ] 2.3 execNpmInstall + test
6. [ ] 2.4 update initRolesFromPackages
7. [ ] 2.5 execUpgrade + test
8. [ ] 3.1 invokeUpgrade
9. [ ] 3.2 invokeUpdate
10. [ ] 3.3 register in invoke.ts
11. [ ] 4.1 acceptance tests
12. [ ] 4.2 verify blackbox criteria
13. [ ] 5.1 export modules

# roadmap: brain cost metrics implementation

this document declares the execution roadmap for the brain cost metrics feature.

each step includes:
- **task**: what to do
- **criteria**: behavioral acceptance criteria
- **verify**: how to confirm completion

---

## dependencies

```
phase 1.1 → phase 1.2 → phase 1.3
                           ↓
phase 2.1 → phase 2.2 → phase 2.3 → phase 2.4
                                       ↓
                        phase 3.1 → phase 3.2 → phase 3.3
                                                   ↓
                                    phase 4.1 → phase 4.2 → phase 4.3
```

---

## phase 1: domain objects

### 1.1 create BrainSpec domain object

- [ ] **task**: create `src/domain.objects/BrainSpec.ts`

- **criteria**:
  - `BrainSpec` extends `DomainLiteral<BrainSpec>`
  - `cost.cash` has `per: 'token'`, `input: IsoPrice`, `output: IsoPrice`, `cache: { get, set }`
  - `cost.time` has `speed: { tokens, per }`, `latency: IsoDuration`
  - `gain.size` has `context: { tokens: number }`
  - `gain.grades` has optional `swe`, `mmlu`, `humaneval` numbers
  - `gain.cutoff` is `IsoDateStamp`
  - `gain.domain` is `'ALL' | 'SOFTWARE'`
  - `gain.skills` has optional `tooluse`, `vision` booleans

- **verify**:
  ```sh
  npm run test:types
  # expect: no type errors
  ```

---

### 1.2 create BrainOutputMetrics domain object

- [ ] **task**: create `src/domain.objects/BrainOutputMetrics.ts`

- **criteria**:
  - `BrainOutputMetrics` extends `DomainLiteral<BrainOutputMetrics>`
  - `size.tokens` has `input`, `output`, `cache: { get, set }` numbers
  - `size.chars` has `input`, `output`, `cache: { get, set }` numbers
  - `cost.time` is `IsoDuration`
  - `cost.cash.total` is `IsoPrice`
  - `cost.cash.deets` has `input`, `output`, `cache: { get, set }` as `IsoPrice`

- **verify**:
  ```sh
  npm run test:types
  # expect: no type errors
  ```

---

### 1.3 create BrainOutput domain object

- [ ] **task**: create `src/domain.objects/BrainOutput.ts`

- **criteria**:
  - `BrainOutput<TOutput>` extends `DomainLiteral<BrainOutput<TOutput>>`
  - has `output: TOutput` property
  - has `metrics: BrainOutputMetrics` property
  - declares `static nested = { metrics: BrainOutputMetrics }`

- **verify**:
  ```sh
  npm run test:types
  # expect: no type errors
  ```

---

### 1.4 export domain objects

- [ ] **task**: update `src/domain.objects/index.ts` to export new types

- **criteria**:
  - exports `BrainSpec`
  - exports `BrainOutput`
  - exports `BrainOutputMetrics`

- **verify**:
  ```ts
  import { BrainSpec, BrainOutput, BrainOutputMetrics } from '@/domain.objects';
  // expect: all imports resolve
  ```

---

### 1.5 create calcBrainOutputCost operation

- [ ] **task**: create `src/domain.operations/brainCost/calcBrainOutputCost.ts`

- **criteria**:
  - accepts `input.for.tokens` OR `input.for.chars` (PickOne)
  - accepts `input.with.cost.cash` that fits `BrainSpec['cost']['cash']`
  - returns `{ cash: { total: IsoPrice, deets: { input, output, cache } } }`
  - when `for.tokens` provided: uses tokens directly
  - when `for.chars` provided: estimates tokens via `chars / 4` heuristic
  - calculates `deets.input = priceMultiply(rate.input, tokens.input)`
  - calculates `deets.output = priceMultiply(rate.output, tokens.output)`
  - calculates `deets.cache.get = priceMultiply(rate.cache.get, tokens.cache.get)`
  - calculates `deets.cache.set = priceMultiply(rate.cache.set, tokens.cache.set)`
  - calculates `total = priceSum(deets.input, deets.output, deets.cache.get, deets.cache.set)`

- **verify**:
  ```sh
  npm run test:types
  # expect: no type errors
  ```

---

### 1.6 add calcBrainOutputCost unit tests

- [ ] **task**: create `src/domain.operations/brainCost/calcBrainOutputCost.test.ts`

- **criteria**:
  - [case1] token counts provided directly:
    - [t0] 1000 input + 500 output → total reflects sum
    - [t1] with cache tokens → cache costs included
  - [case2] char counts provided:
    - [t0] 4000 input chars → ~1000 tokens estimated
  - [case3] zero tokens:
    - [t0] all zeros → total is zero

- **verify**:
  ```sh
  npm run test:unit -- calcBrainOutputCost.test.ts
  # expect: all tests pass
  ```

---

### 1.7 create genSampleBrainSpec test helper

- [ ] **task**: create `src/.test.assets/genSampleBrainSpec.ts`

- **criteria**:
  - returns a valid `BrainSpec` instance
  - uses realistic anthropic claude opus rates:
    - input: $3/mil tokens
    - output: $15/mil tokens
    - cache.get: $0.30/mil tokens
    - cache.set: $3.75/mil tokens
  - uses realistic spec values:
    - context: 200000 tokens
    - grades: { swe: 72.5 }
    - cutoff: '2025-04-01'

- **verify**:
  ```sh
  npm run test:types
  # expect: no type errors
  ```

---

### 1.8 install iso-price dependency

- [ ] **task**: add `iso-price` to dependencies

- **criteria**:
  - `iso-price` is in `dependencies` (not devDependencies)
  - version is `^1.0.0` or later

- **verify**:
  ```sh
  npm list iso-price
  # expect: iso-price@1.x.x in dependencies
  ```

---

## phase 2: supplier contract

### 2.1 update BrainAtom interface

- [ ] **task**: update `src/domain.objects/BrainAtom.ts`

- **criteria**:
  - adds `spec: BrainSpec` property to interface
  - changes `.ask()` return type from `Promise<TOutput>` to `Promise<BrainOutput<TOutput>>`

- **verify**:
  ```sh
  npm run test:types
  # expect: type errors in downstream files (expected - will fix in later steps)
  ```

---

### 2.2 update BrainRepl interface

- [ ] **task**: update `src/domain.objects/BrainRepl.ts`

- **criteria**:
  - adds `spec: BrainSpec` property to interface
  - changes `.ask()` return type from `Promise<TOutput>` to `Promise<BrainOutput<TOutput>>`
  - changes `.act()` return type from `Promise<TOutput>` to `Promise<BrainOutput<TOutput>>`

- **verify**:
  ```sh
  npm run test:types
  # expect: type errors in downstream files (expected - will fix in later steps)
  ```

---

### 2.3 update genMockedBrainAtom test helper

- [ ] **task**: update `src/.test.assets/genMockedBrainAtom.ts`

- **criteria**:
  - includes `spec: BrainSpec` property (use `genSampleBrainSpec()`)
  - `.ask()` returns `BrainOutput<TOutput>` with mock metrics

- **verify**:
  ```sh
  npm run test:types
  # expect: fewer type errors than before
  ```

---

### 2.4 update genMockedBrainRepl test helper

- [ ] **task**: update `src/.test.assets/genMockedBrainRepl.ts`

- **criteria**:
  - includes `spec: BrainSpec` property (use `genSampleBrainSpec()`)
  - `.ask()` returns `BrainOutput<TOutput>` with mock metrics
  - `.act()` returns `BrainOutput<TOutput>` with mock metrics

- **verify**:
  ```sh
  npm run test:types
  # expect: fewer type errors than before
  ```

---

## phase 3: context layer

### 3.1 update askViaBrainAtom

- [ ] **task**: update `src/domain.operations/brainAtom/askViaBrainAtom.ts`

- **criteria**:
  - return type changes to `Promise<BrainOutput<TOutput>>`
  - passes through `BrainOutput<TOutput>` from `atom.ask()`

- **verify**:
  ```sh
  npm run test:types
  # expect: fewer type errors
  ```

---

### 3.2 update askViaBrainRepl and actViaBrainRepl

- [ ] **task**: update `src/domain.operations/brainRepl/askViaBrainRepl.ts` and `actViaBrainRepl.ts`

- **criteria**:
  - `askViaBrainRepl` return type changes to `Promise<BrainOutput<TOutput>>`
  - `actViaBrainRepl` return type changes to `Promise<BrainOutput<TOutput>>`
  - both pass through `BrainOutput<TOutput>` from `repl.ask()` / `repl.act()`

- **verify**:
  ```sh
  npm run test:types
  # expect: fewer type errors
  ```

---

### 3.3 update genContextBrain

- [ ] **task**: update `src/domain.operations/context/genContextBrain.ts`

- **criteria**:
  - `context.brain.atom.ask()` returns `BrainOutput<TOutput>`
  - `context.brain.repl.ask()` returns `BrainOutput<TOutput>`
  - `context.brain.repl.act()` returns `BrainOutput<TOutput>`
  - `ContextBrain` type definition reflects new return types

- **verify**:
  ```sh
  npm run test:types
  # expect: no type errors (or only in phase 4 files)
  ```

---

### 3.4 update genContextBrain tests

- [ ] **task**: update `src/domain.operations/context/genContextBrain.test.ts` and `genContextBrain.integration.test.ts`

- **criteria**:
  - assertions access `.output` for the actual response content
  - assertions verify `.metrics` structure exists
  - assertions verify `.metrics.size.tokens` is populated
  - assertions verify `.metrics.cost.cash.total` is populated

- **verify**:
  ```sh
  npm run test:unit -- genContextBrain.test.ts
  npm run test:integration -- genContextBrain.integration.test.ts
  # expect: all tests pass
  ```

---

## phase 4: public api (hard break)

### 4.1 update Actor interface and genActor

- [ ] **task**: update public actor api to return `BrainOutput<TOutput>`

- **criteria**:
  - `Actor.ask()` returns `Promise<BrainOutput<TOutput>>`
  - `Actor.act()` returns `Promise<BrainOutput<TOutput>>`
  - `genActor()` produces actors with updated return types

- **verify**:
  ```sh
  npm run test:types
  # expect: type errors in consumer tests (expected)
  ```

---

### 4.2 update sdk integration tests

- [ ] **task**: update `src/contract/sdk/genActor.brain.*.integration.test.ts` files

- **criteria**:
  - all `actor.ask()` assertions access `.output` for response content
  - all `actor.act()` assertions access `.output` for response content
  - tests verify `result.metrics` structure
  - tests verify `result.metrics.cost.cash.total` is valid `IsoPrice`

- **verify**:
  ```sh
  npm run test:integration -- genActor.brain
  # expect: all tests pass
  ```

---

### 4.3 add metrics acceptance tests

- [ ] **task**: create metrics-focused acceptance tests

- **criteria**:
  - [case1] actor.ask returns { output, metrics }:
    - [t0] result has `output` property
    - [t1] result has `metrics.size.tokens` with input > 0
    - [t2] result has `metrics.cost.cash.total` as IsoPrice
  - [case2] actor.act returns { output, metrics }:
    - [t0] result has `output` property
    - [t1] result has `metrics.size.tokens` with accumulated values
    - [t2] result has `metrics.cost.cash.total` as IsoPrice
  - [case3] brain.spec access:
    - [t0] `brain.spec.cost.cash.input` is defined
    - [t1] `brain.spec.gain.size.context.tokens` > 0

- **verify**:
  ```sh
  npm run test:acceptance -- brain.metrics
  # expect: all tests pass
  ```

---

### 4.4 full regression

- [ ] **task**: run full test suite to confirm no regressions

- **criteria**:
  - all unit tests pass
  - all integration tests pass
  - all acceptance tests pass
  - no type errors

- **verify**:
  ```sh
  npm run test:types
  npm run test:unit
  npm run test:integration
  npm run test:acceptance
  # expect: all pass
  ```

---

## summary

| phase | steps | break impact |
|-------|-------|--------------|
| 1: domain objects | 1.1–1.8 | none (additive) |
| 2: supplier contract | 2.1–2.4 | internal only |
| 3: context layer | 3.1–3.4 | internal only |
| 4: public api | 4.1–4.4 | hard break |

total steps: 16

---

## citations

1. blueprint — `3.3.blueprint.v1.i1.md`
2. domain distillation — `3.2.distill.domain._.v1.i1.md`
3. vision — `1.vision.md`
4. wish — `0.wish.md`

# vision

sdk exports actors. actors are generated from roles via `genActor`. calling `.act()` uses a default brain, or callers can supply an explicit brain.

## core formula

```
actor = genActor({ role }) + brain (at invocation time)
role = skills + briefs
```

## sdk usage

### import an actor from a roles package

```ts
import { mechanic } from 'rhachet-roles-ehmpathy';
import { skeptic } from 'rhachet-roles-bhrain';

// mechanic and skeptic are actors, generated via genActor({ role })
```

### invoke a skill with implicit brain (default)

```ts
// uses default/configured brain
const result = await mechanic.act({
  skill: {
    review: {
      rules: ['@role/briefs/practices/pitofsuccess**/*'],
      input: 'https://github.com/ehmpathy/domain-objects/pull/9',
    },
  },
});
```

### invoke a skill with explicit brain

brain selection via `.act({ brain })` supports two patterns:

```ts
import { genBrainRepl } from 'rhachet-brains-anthropic';

// pattern 1: lookup by ref
const result = await mechanic.act({
  brain: { repo: 'anthropic', slug: 'claude/sonnet' },  // RefByUnique<typeof BrainRepl>
  skill: {
    review: {
      rules: ['@role/briefs/practices/pitofsuccess**/*'],
      input: 'https://github.com/ehmpathy/domain-objects/pull/9',
    },
  },
});

// pattern 2: direct pass-in (custom config)
const result = await mechanic.act({
  brain: genBrainRepl({ slug: 'claude/code', temperature: 0.2 }),  // BrainRepl instance
  skill: {
    review: {
      rules: ['@role/briefs/practices/pitofsuccess**/*'],
      input: 'https://github.com/ehmpathy/domain-objects/pull/9',
    },
  },
});
```

brain allowlist enforcement:
- both patterns validate against the actor's brains allowlist
- matching is done by unique key (repo + slug)
- if brain is not in allowlist, an error is thrown
- security: roles only allow allowlisted brains

```ts
// ‚úì works: anthropic/claude/sonnet is in mechanic's allowlist
await mechanic.act({ brain: { repo: 'anthropic', slug: 'claude/sonnet' }, skill: { ... } });

// ‚úó throws: openai/gpt-4 is not in mechanic's allowlist
await mechanic.act({ brain: { repo: 'openai', slug: 'gpt-4' }, skill: { ... } });
// Error: brain 'openai/gpt-4' is not in actor's allowlist
```

### invoke different skills

```ts
// review a pr
await mechanic.act({
  skill: { review: { input: 'https://github.com/org/repo/pull/123' } },
});

// deliver an issue
await mechanic.act({
  skill: { deliver: { input: 'https://github.com/org/repo/issues/456' } },
});

// ask a skeptic
await skeptic.act({
  skill: { review: { ask: 'are birds real?' } },
});
```

### run a shell skill (solid route)

```ts
// run a shell skill via spawn, no brain involved
const result = await mechanic.run({
  skill: { 'gh.workflow.logs': { workflow: 'test' } },
});

// deterministic execution
await mechanic.run({
  skill: { 'declapract.upgrade': {} },
});
```

## cli equivalents

the sdk maps to cli commands:

```sh
# ü™® solid: role.run({ skill })
npx rhachet run --repo ehmpathy --role mechanic --skill gh.workflow.logs --workflow test

# üî© rigid: role.act({ skill })
npx rhachet act --repo ehmpathy --role mechanic --skill review --input "..."

# üî© rigid: role.act({ skill, brain })
npx rhachet act --repo ehmpathy --role mechanic --skill review --input "..." --brain anthropic/claude/code

# üåä fluid: role.ask({ prompt })
npx rhachet ask --repo ehmpathy --role mechanic --ask "review my latest changes and fix any issues"
```

### brain selection via cli

when `--brain` is declared via cli, it must match a brain in the actor's allowlist:

```sh
# uses default brain (first in actor's brains allowlist)
npx rhachet act --repo ehmpathy --role mechanic --skill review --input "..."

# uses explicit brain (must be in actor's brains allowlist)
npx rhachet act --repo ehmpathy --role mechanic --skill review --input "..." --brain anthropic/claude/sonnet
```

brains are identified via repo/slug:

```sh
--brain anthropic/claude/code     # must be in actor's brains allowlist
--brain openai/codex              # must be in actor's brains allowlist
```

if `--brain` is not in the actor's allowlist, an error is thrown.

## type-safe actor generation

rhachet provides `genActor` to create type-safe actors from roles:

```ts
// rhachet-roles-ehmpathy/src/actors/mechanic.ts
import { genActor } from 'rhachet';
import { genBrainRepl } from 'rhachet-brains-anthropic';
import { mechanicRole } from '../roles/mechanic';

export const mechanic = genActor({
  role: mechanicRole,
  brains: [
    genBrainRepl({ slug: 'claude/code' }),                // default (first in list)
    genBrainRepl({ slug: 'claude/code/sonnet/v4.5' }),    // claude/code repl w/ sonnet v4.5 locked as the atom
  ],
});
```

the `brains` allowlist:
- defines which brains this actor supports
- first brain is the default (used when no explicit brain is provided)
- ensures only supported brains can be used
- eliminates need for global brain registry in rhachet.use.ts

### skill type inference

skills can't be type-inferred from directory-driven discovery. to enable type-safe invocation, roles must explicitly register skills with zod schemas:

```ts
// role.skills structure
role.skills = {
  solid: {
    'gh.workflow.logs': {
      input: z.object({ workflow: z.string() }),
      output: z.object({ logs: z.string() }),
    },
  },
  rigid: {
    review: {
      input: z.object({ input: z.string(), rules: z.array(z.string()).optional() }),
      output: z.object({ decision: z.enum(['approve', 'reject', 'request-changes']) }),
    },
    deliver: {
      input: z.object({ input: z.string() }),
      output: z.object({ pr: z.string() }),
    },
  },
};
```

this enables type-strong `.act()`, `.run()`, and `.ask()` calls:

```ts
// type-safe: skill names and args are inferred from zod schemas
await mechanic.act({
  skill: {
    review: { input: '...' },  // ‚úì 'review' is registered in role.skills.rigid
    // unknown: { },           // ‚úó type error: 'unknown' is not registered
  },
});

await mechanic.run({
  skill: {
    'gh.workflow.logs': { workflow: 'test' },  // ‚úì registered in role.skills.solid
  },
});
```

### skill discovery modes

| mode                | description                             | type inference                                |
| ------------------- | --------------------------------------- | --------------------------------------------- |
| `role.skills.solid` | registered solid skills with zod schema | ‚úì full                                        |
| `role.skills.rigid` | registered rigid skills with zod schema | ‚úì full                                        |
| `role.skills.dirs`  | directory-driven discovery              | ‚úó not inferrable unless explicitly registered |
| `role.skills.refs`  | legacy skill refs                       | ‚ö†Ô∏è to deprecate                                |

## thought route mapping

| sdk pattern            | thought route | cli equivalent    |
| ---------------------- | ------------- | ----------------- |
| `role.run({ skill })`  | ü™® solid       | `npx rhachet run` |
| `role.act({ skill })`  | üî© rigid       | `npx rhachet act` |
| `role.ask({ prompt })` | üåä fluid       | `npx rhachet ask` |

# roadmap: sdk-brain-actor

## references

- wish: `0.wish.md`
- vision: `1.vision.md`
- blackbox criteria: `2.criteria.blackbox.md`
- blueprint criteria: `2.criteria.blueprint.md`
- domain distillation: `3.2.distill.domain._.v1.i1.md`
- blueprint: `3.3.blueprint.v1.i1.md`


## execution checklist

### phase 0: test fixtures

> create test fixtures before implementation to enable test-driven development

- [ ] **0.1** create `.test/assets/example.repo/rhachet-roles-example.published/` fixture
  - deps: none
  - creates:
    - `package.json`
    - `.gitignore` (ignores `.agent/`)
    - `src/index.ts`
    - `src/domain.roles/author/role.ts`
    - `src/domain.roles/author/actor.ts`
    - `src/domain.roles/author/briefs/style-guide.md`
    - `src/domain.roles/author/skills/solid/wordcount.sh`
    - `src/domain.roles/author/skills/rigid/draft.ts`
  - acceptance:
    - fixture directory exists with all files
    - `rhachet roles link` creates `.agent/` symlinks when run in fixture dir
  - verify:
    ```sh
    ls -la .test/assets/example.repo/rhachet-roles-example.published/
    cd .test/assets/example.repo/rhachet-roles-example.published && npx rhachet roles link && ls -la .agent/
    ```

- [ ] **0.2** create `.test/assets/example.repo/rhachet-roles-example.collocated/` fixture
  - deps: none
  - creates:
    - `package.json`
    - `src/index.ts`
    - `.agent/repo=.this/role=scribe/role.ts`
    - `.agent/repo=.this/role=scribe/actor.ts`
    - `.agent/repo=.this/role=scribe/readme.md`
    - `.agent/repo=.this/role=scribe/briefs/voice-guide.md`
    - `.agent/repo=.this/role=scribe/skills/solid/linecount.sh`
    - `.agent/repo=.this/role=scribe/skills/rigid/summarize.ts`
  - acceptance:
    - fixture directory exists with all files
    - `.agent/` is checked in (not gitignored)
  - verify:
    ```sh
    ls -la .test/assets/example.repo/rhachet-roles-example.collocated/
    ls -la .test/assets/example.repo/rhachet-roles-example.collocated/.agent/repo=.this/role=scribe/
    ```

- [ ] **0.3** create `.test/assets/example.repo/repo-with-role-with-rigid-skill/` fixture
  - deps: none
  - creates:
    - `rhachet.use.ts`
    - `.agent/repo=.this/role=tester/readme.md`
    - `.agent/repo=.this/role=tester/skills/rigid/echo.review.ts`
  - acceptance:
    - fixture supports CLI invokeAct testing
    - `echo.review.ts` skill accepts `--input` and writes to `--output`
  - verify:
    ```sh
    ls -la .test/assets/example.repo/repo-with-role-with-rigid-skill/
    ```


### phase 1: domain objects

> extend Role and create Actor domain entity

- [ ] **1.1** extend `Role` with typed skills structure
  - deps: none
  - file: `src/domain.objects/Role.ts`
  - adds: `skills.solid` and `skills.rigid` optional properties with zod schema structure
  - acceptance:
    - `Role.skills.solid` accepts `{ [slug]: { input: ZodSchema, output: ZodSchema } }`
    - `Role.skills.rigid` accepts `{ [slug]: { input: ZodSchema, output: ZodSchema } }`
    - existing `Role.skills.dirs` and `Role.skills.refs` remain unchanged
  - verify:
    ```sh
    npm run test:types
    ```

- [ ] **1.2** create `Actor` domain entity
  - deps: 1.1
  - file: `src/domain.objects/Actor.ts`
  - creates: `Actor<TRole>` interface and class with `.act()`, `.run()`, `.ask()` methods
  - acceptance:
    - `Actor.unique = ['role.slug']`
    - `Actor.role: TRole`
    - `Actor.brains: BrainRepl[]`
    - `Actor.act`, `Actor.run`, `Actor.ask` method signatures typed
  - verify:
    ```sh
    npm run test:types
    npm run test:unit -- Actor.test.ts
    ```

- [ ] **1.3** export `Actor` from domain.objects
  - deps: 1.2
  - file: `src/domain.objects/index.ts`
  - adds: `export * from './Actor'`
  - verify:
    ```sh
    npm run test:types
    ```


### phase 2: domain operations

> create genActor factory and actor operations

- [ ] **2.1** create `findBrainInAllowlist` operation
  - deps: none
  - file: `src/domain.operations/actor/findBrainInAllowlist.ts`
  - accepts: `{ brain: { repo, slug } | BrainRepl, allowlist: BrainRepl[] }`
  - returns: matched `BrainRepl` from allowlist
  - throws: `BadRequestError` if brain not in allowlist
  - acceptance:
    - ref lookup `{ repo, slug }` finds brain by unique key
    - direct `BrainRepl` validates against allowlist by unique key
    - throws when brain not in allowlist (usecase.2 error case)
  - verify:
    ```sh
    npm run test:unit -- findBrainInAllowlist.test.ts
    ```

- [ ] **2.2** create `findSkillBySlug` operation
  - deps: none
  - file: `src/domain.operations/actor/findSkillBySlug.ts`
  - accepts: `{ slug, role, route: 'solid' | 'rigid' }`
  - returns: skill from `role.skills[route]` or `.agent/` dirs
  - throws: `BadRequestError` if skill not found
  - acceptance:
    - `role.skills[route]` takes precedence over `.agent/` dirs (usecase.8)
    - falls back to `.agent/` skill discovery
    - throws when skill not found (usecase.2 error case)
  - verify:
    ```sh
    npm run test:unit -- findSkillBySlug.test.ts
    ```

- [ ] **2.3** create `actorAct` operation
  - deps: 2.2
  - file: `src/domain.operations/actor/actorAct.ts`
  - accepts: `{ role, brain: BrainRepl, skill: Record<string, unknown> }`
  - returns: skill execution result
  - acceptance:
    - resolves skill via `findSkillBySlug` with route='rigid'
    - executes rigid skill with provided brain
    - passes skill args through to execution
  - verify:
    ```sh
    npm run test:unit -- actorAct.test.ts
    ```

- [ ] **2.4** create `actorRun` operation
  - deps: 2.2
  - file: `src/domain.operations/actor/actorRun.ts`
  - accepts: `{ role, skill: Record<string, unknown> }`
  - returns: skill execution result
  - acceptance:
    - resolves skill via `findSkillBySlug` with route='solid'
    - executes solid skill via spawn (no brain) (usecase.3)
  - verify:
    ```sh
    npm run test:unit -- actorRun.test.ts
    ```

- [ ] **2.5** create `actorAsk` operation
  - deps: none
  - file: `src/domain.operations/actor/actorAsk.ts`
  - accepts: `{ role, brain: BrainRepl, prompt: string }`
  - returns: `{ response: string }`
  - acceptance:
    - starts fluid conversation with brain (usecase.4)
    - returns response from brain
  - verify:
    ```sh
    npm run test:unit -- actorAsk.test.ts
    ```

- [ ] **2.6** create `genActor` factory
  - deps: 2.1, 2.3, 2.4, 2.5
  - file: `src/domain.operations/actor/genActor.ts`
  - accepts: `{ role: TRole, brains: BrainRepl[] }`
  - returns: `Actor<TRole>` with bound `.act()`, `.run()`, `.ask()` methods
  - acceptance:
    - throws if brains array is empty (usecase.13)
    - first brain is the default (usecase.13)
    - `.act()` resolves brain via `findBrainInAllowlist` before calling `actorAct`
    - `.act()` defaults to first brain when none provided (usecase.2)
    - `.run()` delegates to `actorRun`
    - `.ask()` uses default brain and delegates to `actorAsk`
  - verify:
    ```sh
    npm run test:unit -- genActor.test.ts
    ```

- [ ] **2.7** integration tests for actor operations (isolated boundary)
  - deps: 2.3, 2.4, 2.5, 0.1, 0.2
  - files:
    - `src/domain.operations/actor/actorAct.integration.test.ts`
    - `src/domain.operations/actor/actorRun.integration.test.ts`
    - `src/domain.operations/actor/actorAsk.integration.test.ts`
  - acceptance:
    - `actorAct` executes rigid skill with brain (uses openai/codex for speed)
    - `actorRun` executes solid skill via spawn
    - `actorAsk` starts fluid conversation with brain
  - verify:
    ```sh
    npm run test:integration -- actorAct.integration.test.ts
    npm run test:integration -- actorRun.integration.test.ts
    npm run test:integration -- actorAsk.integration.test.ts
    ```


### phase 3: cli commands

> create invokeAct and update invokeRun/invokeAsk to use Actor

- [ ] **3.1** create `invokeAct` command
  - deps: 2.6
  - file: `src/contract/cli/invokeAct.ts`
  - parses: `--repo`, `--role`, `--skill`, `--brain`, `--attempts`, `--concurrency`, `--output`
  - acceptance:
    - resolves actor from registries
    - invokes `actor.act()` with resolved args (usecase.5)
    - supports `--brain` for explicit brain selection (usecase.5)
    - supports `--attempts` with `--output` for multi-attempt (usecase.5)
    - supports `onInvokeActInput` hooks (usecase.5)
    - writes to `--output` path or stdout (usecase.11)
    - throws when brain not in allowlist (usecase.5)
  - verify:
    ```sh
    npm run test:unit -- invokeAct.test.ts
    ```

- [ ] **3.2** register `invokeAct` in invoke.ts
  - deps: 3.1
  - file: `src/contract/cli/invoke.ts`
  - adds: import and registration of `invokeAct`
  - verify:
    ```sh
    npx tsx ./bin/run act --help
    ```

- [ ] **3.3** update `invokeRun` to use Actor.run()
  - deps: 2.6
  - file: `src/contract/cli/invokeRun.ts`
  - changes: resolve actor and invoke `actor.run()` instead of direct execution
  - acceptance:
    - backwards compatible with existing behavior
    - uses Actor abstraction for consistency
  - verify:
    ```sh
    npm run test:integration -- invokeRun.integration.test.ts
    ```

- [ ] **3.4** update `invokeAsk` to use Actor.ask()
  - deps: 2.6
  - file: `src/contract/cli/invokeAsk.ts`
  - changes: resolve actor and invoke `actor.ask()` instead of direct execution
  - acceptance:
    - backwards compatible with existing behavior
    - uses Actor abstraction for consistency
    - enforces error boundaries (usecase.10)
  - verify:
    ```sh
    npm run test:integration -- invokeAsk.integration.test.ts
    ```

- [ ] **3.5** CLI integration tests for invokeAct
  - deps: 3.1, 3.2, 0.3
  - file: `src/contract/cli/invokeAct.integration.test.ts`
  - acceptance:
    - `act` with default brain executes skill
    - `act` with `--brain` uses specified brain
    - `act` with `--attempts 3 --output result.json` creates `result.i1.json`, `result.i2.json`, `result.i3.json`
    - `act` with invalid brain throws error
  - verify:
    ```sh
    npm run test:integration -- invokeAct.integration.test.ts
    ```


### phase 4: sdk exports

> export genActor and Actor from sdk

- [ ] **4.1** export `genActor` from sdk
  - deps: 2.6
  - file: `src/contract/sdk.ts`
  - adds: `export { genActor } from '@src/domain.operations/actor/genActor'`
  - acceptance:
    - `genActor` is importable from 'rhachet' (usecase.1)
  - verify:
    ```sh
    npm run test:types
    ```

- [ ] **4.2** SDK integration tests (published pattern)
  - deps: 4.1, 0.1
  - file: `src/contract/sdk/genActor.brain.casePublished.integration.test.ts`
  - acceptance:
    - `author.run()` executes solid skill via spawn (usecase.3)
    - `author.act()` executes rigid skill with default brain (usecase.2)
    - `author.act({ brain: { repo, slug } })` uses explicit brain (usecase.2)
    - `author.act({ brain: notInAllowlist })` throws error (usecase.2)
    - `author.ask()` starts fluid conversation (usecase.4)
  - verify:
    ```sh
    npm run test:integration -- genActor.brain.casePublished.integration.test.ts
    ```

- [ ] **4.3** SDK integration tests (collocated pattern)
  - deps: 4.1, 0.2
  - file: `src/contract/sdk/genActor.brain.caseCollocated.integration.test.ts`
  - acceptance:
    - `scribe.run()` executes solid skill via spawn (usecase.3)
    - `scribe.act()` executes rigid skill with default brain (usecase.2)
    - `scribe.ask()` starts fluid conversation (usecase.4)
  - verify:
    ```sh
    npm run test:integration -- genActor.brain.caseCollocated.integration.test.ts
    ```


### phase 5: type tests

> verify type inference for skill invocation

- [ ] **5.1** type tests for skill inference
  - deps: 1.1, 1.2, 2.6
  - file: `src/domain.operations/actor/Actor.types.test.ts`
  - acceptance:
    - skill name inference from zod schemas (usecase.12)
    - skill args inference from zod schemas (usecase.12)
    - invalid skill name produces type error (usecase.12)
  - verify:
    ```sh
    npm run test:types
    ```


### phase 6: final validation

> run full test suite and validate all usecases

- [ ] **6.1** run full test suite
  - deps: all above
  - verify:
    ```sh
    npm run test
    ```

- [ ] **6.2** validate blackbox criteria
  - deps: 6.1
  - checklist:
    - [ ] usecase.1: sdk actor import ✓
    - [ ] usecase.2: sdk `.act()` invocation ✓
    - [ ] usecase.3: sdk `.run()` invocation ✓
    - [ ] usecase.4: sdk `.ask()` invocation ✓
    - [ ] usecase.5: cli `act` command ✓
    - [ ] usecase.6: cli `run` command ✓
    - [ ] usecase.7: cli `ask` command ✓
    - [ ] usecase.8: skill resolution from multiple sources ✓
    - [ ] usecase.9: actor-role uniqueness ✓
    - [ ] usecase.10: error boundaries ✓
    - [ ] usecase.11: output handling ✓
    - [ ] usecase.12: type-safe skill invocation ✓
    - [ ] usecase.13: brain allowlist in genActor ✓


## dependency graph

```
phase 0 (fixtures)
  0.1 ─────────────────────────────────────────────────┐
  0.2 ─────────────────────────────────────────────────┤
  0.3 ─────────────────────────────────────────────────┤
                                                       │
phase 1 (domain objects)                               │
  1.1 ──► 1.2 ──► 1.3                                  │
           │                                           │
           ▼                                           │
phase 2 (operations)                                   │
  2.1 ────────────────────────┐                        │
  2.2 ────────────────────────┤                        │
  2.5 ────────────────────────┤                        │
           │                  │                        │
           ▼                  ▼                        │
  2.3 (actorAct) ◄── 2.2     2.6 (genActor)           │
  2.4 (actorRun) ◄── 2.2      │                        │
           │                  │                        │
           ▼                  │                        │
  2.7 (integration) ◄─────────┴────────────────────────┤
                                                       │
phase 3 (cli)                                          │
  3.1 (invokeAct) ◄── 2.6                              │
  3.2 ◄── 3.1                                          │
  3.3 ◄── 2.6                                          │
  3.4 ◄── 2.6                                          │
  3.5 ◄── 3.1, 3.2, 0.3 ◄──────────────────────────────┤
                                                       │
phase 4 (sdk)                                          │
  4.1 ◄── 2.6                                          │
  4.2 ◄── 4.1, 0.1 ◄───────────────────────────────────┤
  4.3 ◄── 4.1, 0.2 ◄───────────────────────────────────┘

phase 5 (types)
  5.1 ◄── 1.1, 1.2, 2.6

phase 6 (validation)
  6.1 ◄── all above
  6.2 ◄── 6.1
```


## execution order (linearized)

1. 0.1, 0.2, 0.3 (parallel - fixtures)
2. 1.1 (extend Role)
3. 1.2 (create Actor)
4. 1.3 (export Actor)
5. 2.1, 2.2, 2.5 (parallel - independent operations)
6. 2.3, 2.4 (parallel - depend on 2.2)
7. 2.6 (genActor - depends on 2.1, 2.3, 2.4, 2.5)
8. 2.7 (integration tests)
9. 3.1 (invokeAct)
10. 3.2, 3.3, 3.4 (parallel - cli updates)
11. 3.5 (cli integration tests)
12. 4.1 (sdk export)
13. 4.2, 4.3 (parallel - sdk integration tests)
14. 5.1 (type tests)
15. 6.1 (full test suite)
16. 6.2 (blackbox validation)

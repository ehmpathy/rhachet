# blueprint.v1.i1

## wish summary

1. support `BrainAtom` in `actor.ask()` in addition to `BrainRepl`
2. create demo library `rhachet-brain-xai` for `BrainAtom({ repo: xai, slug: 'grok/code-fast-1' })`
3. demonstrate via integration test: `actor.ask()` writing prose about "sunshine ocean surfer turtles"

---

## implementation phases

### phase 0: ActorBrain type and Actor extension

**goal**: extend Actor domain object to accept both BrainRepl and BrainAtom

#### 0.1 create ActorBrain type

**file**: `src/domain.objects/Actor.ts`

```ts
import type { BrainAtom } from './BrainAtom';
import type { BrainRepl } from './BrainRepl';

/**
 * .what = a brain that an actor can use
 * .why = enables actors to use both BrainRepl and BrainAtom
 *
 * .note = BrainRepl supports both .ask() and .act()
 * .note = BrainAtom supports only .ask()
 */
export type ActorBrain = BrainRepl | BrainAtom;
```

#### 0.2 update Actor interface

**file**: `src/domain.objects/Actor.ts`

```ts
export interface Actor<TRole extends Role = Role> {
  // ...
  brains: ActorBrain[];  // CHANGED: was BrainRepl[]
  // ...
}
```

#### 0.3 tests for phase 0

**unit test**: `src/domain.objects/Actor.test.ts` (if exists, else skip)
- verify `ActorBrain` type accepts both `BrainRepl` and `BrainAtom`

---

### phase 1: actorAsk operation extension

**goal**: update actorAsk to accept ActorBrain instead of BrainRepl

#### 1.1 update actorAsk signature

**file**: `src/domain.operations/actor/actorAsk.ts`

```ts
import type { ActorBrain } from '@src/domain.objects/Actor';

export const actorAsk = async (input: {
  role: Role;
  brain: ActorBrain;  // CHANGED: was BrainRepl
  prompt: string;
}): Promise<{ response: string }> => {
  // implementation unchanged - both types have .ask()
};
```

#### 1.2 tests for phase 1

**unit test**: `src/domain.operations/actor/actorAsk.test.ts`

```
given('[caseN] actorAsk with BrainAtom')
  when('[t0] called with mock BrainAtom')
    then('calls brain.ask() with prompt')
    then('returns { response: string }')
```

add mock BrainAtom (without `.act()` method):

```ts
const mockBrainAtom = new BrainAtom({
  repo: 'xai',
  slug: 'xai/grok',
  description: 'mock brain atom for testing',
  ask: jest.fn<BrainAtom['ask']>().mockResolvedValue({ response: 'hello from atom' }),
  // note: BrainAtom has no .act() method by design
});
```

---

### phase 2: genActor operation extension

**goal**: update genActor to accept ActorBrain[] and add runtime validation for .act()

#### 2.1 update genActor signature and add runtime check

**file**: `src/domain.operations/actor/genActor.ts`

```ts
import type { ActorBrain } from '@src/domain.objects/Actor';

export const genActor = <TRole extends Role>(input: {
  role: TRole;
  brains: ActorBrain[];  // CHANGED: was BrainRepl[]
}): Actor<TRole> => {
  // ...

  // inside .act() method, add runtime check:
  if (!('act' in brainResolved))
    throw new BadRequestError(
      'actor.act() requires a BrainRepl brain with .act() method',
      { brainSlug: brainResolved.slug },
    );

  // ...
};
```

#### 2.2 tests for phase 2

**unit test**: `src/domain.operations/actor/genActor.test.ts`

```
given('[caseN] genActor with BrainAtom')
  when('[t0] created with BrainAtom as default brain')
    then('actor is created successfully')
  when('[t1] actor.ask() is called')
    then('uses BrainAtom.ask()')
    then('returns { response: string }')
  when('[t2] actor.act() is called with BrainAtom')
    then('throws BadRequestError')
    then('error message indicates .act() requires BrainRepl')

given('[caseN+1] genActor with mixed brains [BrainAtom, BrainRepl]')
  when('[t0] actor.ask() is called')
    then('uses first brain (BrainAtom)')
  when('[t1] actor.act({ brain: BrainRepl }) is called')
    then('uses specified BrainRepl')
    then('succeeds')
```

---

### phase 3: rhachet-brain-xai package

**goal**: create xAI brain plugin following rhachet-brain-openai pattern

#### 3.1 package structure

```
src/_topublish/rhachet-brain-xai/
  src/
    index.ts
    atoms/
      genBrainAtom.ts
      genBrainAtom.integration.test.ts
    index.integration.test.ts
  package.json
  tsconfig.json
```

#### 3.2 genBrainAtom factory

**file**: `src/_topublish/rhachet-brain-xai/src/atoms/genBrainAtom.ts`

```ts
import OpenAI from 'openai';
import { BrainAtom } from 'rhachet';
import { castBriefsToPrompt } from '@src/domain.operations/role/briefs/castBriefsToPrompt';

type XAIAtomSlug =
  | 'xai/grok-code-fast-1'
  | 'xai/grok-3'
  | 'xai/grok-3-mini'
  | 'xai/grok-4'
  | 'xai/grok-4-fast';

interface XAIAtomConfig {
  model: string;
  description: string;
}

const CONFIG_BY_SLUG: Record<XAIAtomSlug, XAIAtomConfig> = {
  'xai/grok-code-fast-1': {
    model: 'grok-code-fast-1',
    description: 'xAI Grok optimized for agentic coding (256K context)',
  },
  'xai/grok-3': {
    model: 'grok-3-beta',
    description: 'xAI Grok 3 balanced reasoning (131K context)',
  },
  'xai/grok-3-mini': {
    model: 'grok-3-mini-beta',
    description: 'xAI Grok 3 Mini fast and cost-effective (131K context)',
  },
  'xai/grok-4': {
    model: 'grok-4-07-09',
    description: 'xAI Grok 4 advanced reasoning (256K context)',
  },
  'xai/grok-4-fast': {
    model: 'grok-4-fast-reasoning',
    description: 'xAI Grok 4 Fast frontier with reasoning (2M context)',
  },
};

export const genBrainAtom = (input: { slug: XAIAtomSlug }): BrainAtom => {
  const config = CONFIG_BY_SLUG[input.slug];

  return new BrainAtom({
    repo: 'xai',
    slug: input.slug,
    description: config.description,
    ask: async (askInput, context) => {
      // compose system prompt from briefs
      const systemPrompt = askInput.role.briefs
        ? await castBriefsToPrompt({ briefs: askInput.role.briefs })
        : undefined;

      // get openai client (xAI is OpenAI-compatible)
      const openai =
        (context?.openai as OpenAI | undefined) ??
        new OpenAI({
          apiKey: process.env.XAI_API_KEY,
          baseURL: 'https://api.x.ai/v1',
        });

      // build messages
      const messages: OpenAI.ChatCompletionMessageParam[] = [];
      if (systemPrompt) messages.push({ role: 'system', content: systemPrompt });
      messages.push({ role: 'user', content: askInput.prompt });

      // call xAI API
      const response = await openai.chat.completions.create({
        model: config.model,
        messages,
      });

      // extract and parse response
      const content = response.choices[0]?.message?.content ?? '';
      return askInput.schema.output.parse({ content });
    },
  });
};
```

#### 3.3 package index

**file**: `src/_topublish/rhachet-brain-xai/src/index.ts`

```ts
import { BrainAtom } from 'rhachet';
import { genBrainAtom } from './atoms/genBrainAtom';

export const getBrainAtomsByXAI = (): BrainAtom[] => {
  return [genBrainAtom({ slug: 'xai/grok-code-fast-1' })];
};

export { genBrainAtom };
```

#### 3.4 tests for phase 3

**integration test**: `src/_topublish/rhachet-brain-xai/src/atoms/genBrainAtom.integration.test.ts`

```
# API key guard at top of file
if (!process.env.XAI_API_KEY)
  throw new BadRequestError('XAI_API_KEY is required for integration tests');

describe('genBrainAtom.integration')
  jest.setTimeout(30000)

  given('[case1] genBrainAtom({ slug: "xai/grok-code-fast-1" })')
    when('[t0] inspecting the atom')
      then('repo is "xai"')
      then('slug is "xai/grok-code-fast-1"')
      then('description is defined')

  given('[case2] ask is called')
    when('[t0] with simple prompt')
      then('returns substantive response')
      then('response contains expected content')
    when('[t1] with briefs')
      then('response leverages knowledge from brief')
      then('response contains ZEBRA42 secret code')
```

**integration test**: `src/_topublish/rhachet-brain-xai/src/index.integration.test.ts`

```
describe('rhachet-brain-xai.integration')
  given('[case1] getBrainAtomsByXAI')
    when('[t0] called')
      then('returns array with one atom')
      then('returns BrainAtom instances')

  given('[case2] genBrainAtom factory')
    when('[t0] called with xai/grok-code-fast-1 slug')
      then('returns BrainAtom instance')
      then('has correct slug')
```

---

### phase 4: demo integration test ("sunshine ocean surfer turtles")

**goal**: demonstrate actor.ask() with BrainAtom writing prose

#### 4.1 create demo integration test

**file**: `src/contract/sdk/genActor.brain.caseAskable.integration.test.ts`

```ts
import { BadRequestError } from 'helpful-errors';
import path from 'path';
import { cpSync, mkdirSync, rmSync } from 'fs';
import { given, then, when } from 'test-fns';

import { genActor } from '@src/domain.operations/actor/genActor';
import { genBrainAtom } from '@src/_topublish/rhachet-brain-xai/src/atoms/genBrainAtom';
import { EXAMPLE_REPO_PUBLISHED } from '@src/.test/assets/example.repo/directory';

// guard: require XAI_API_KEY
if (!process.env.XAI_API_KEY)
  throw new BadRequestError('XAI_API_KEY is required for integration tests');

describe('genActor.brain.caseAskable.integration', () => {
  jest.setTimeout(60000);

  given('[case1] actor with xAI BrainAtom brain', () => {
    const tmpDir = path.resolve(__dirname, './.temp/caseAskable');
    const originalCwd = process.cwd();

    beforeAll(() => {
      rmSync(tmpDir, { recursive: true, force: true });
      mkdirSync(tmpDir, { recursive: true });
      cpSync(EXAMPLE_REPO_PUBLISHED, tmpDir, { recursive: true });
      process.chdir(tmpDir);
    });

    afterAll(() => {
      process.chdir(originalCwd);
      rmSync(tmpDir, { recursive: true, force: true });
    });

    // create actor with both BrainAtom and BrainRepl
    const brainAtom = genBrainAtom({ slug: 'xai/grok-code-fast-1' });
    const brainRepl = genBrainRepl({ slug: 'openai/gpt-4o' });  // from fixture or rhachet-brain-openai
    const author = genActor({
      role: authorRole,  // from fixture
      brains: [brainAtom, brainRepl],
    });

    when('[t0] author.ask() with BrainAtom about sunshine ocean surfer turtles', () => {
      then('returns creative prose response', async () => {
        const result = await author.ask({
          brain: brainAtom,
          prompt: 'write a short, creative prose paragraph about sunshine ocean surfer turtles',
        });

        expect(result).toBeDefined();
        expect(result.response).toBeDefined();
        expect(result.response.length).toBeGreaterThan(50);

        // verify response contains relevant content
        const lowerResponse = result.response.toLowerCase();
        expect(
          lowerResponse.includes('turtle') ||
          lowerResponse.includes('ocean') ||
          lowerResponse.includes('sun') ||
          lowerResponse.includes('surf')
        ).toBe(true);
      });
    });

    when('[t1] author.ask() with BrainRepl about sunshine ocean surfer turtles', () => {
      then('returns creative prose response', async () => {
        const result = await author.ask({
          brain: brainRepl,
          prompt: 'write a short, creative prose paragraph about sunshine ocean surfer turtles',
        });

        expect(result).toBeDefined();
        expect(result.response).toBeDefined();
        expect(result.response.length).toBeGreaterThan(50);

        // verify response contains relevant content
        const lowerResponse = result.response.toLowerCase();
        expect(
          lowerResponse.includes('turtle') ||
          lowerResponse.includes('ocean') ||
          lowerResponse.includes('sun') ||
          lowerResponse.includes('surf')
        ).toBe(true);
      });
    });
  });
});
```

#### 4.2 tests for phase 4

the integration test itself is the demonstration. ensure:
- test passes with `XAI_API_KEY` set
- response is creative prose about turtles
- demonstrates BrainAtom works with actor.ask()

---

## test coverage matrix

### unit tests

| component | file | cases |
|-----------|------|-------|
| actorAsk | `actorAsk.test.ts` | BrainAtom mock, BrainRepl mock (existing) |
| genActor | `genActor.test.ts` | BrainAtom in brains[], mixed brains, .act() rejection |

### integration tests (repo <-> access boundaries)

| component | file | cases |
|-----------|------|-------|
| genBrainAtom (xai) | `genBrainAtom.integration.test.ts` | atom properties, .ask() simple, .ask() with briefs |
| index (xai) | `index.integration.test.ts` | getBrainAtomsByXAI, genBrainAtom factory |

### integration tests (end-to-end flows)

| component | file | cases |
|-----------|------|-------|
| actor.ask() with BrainAtom | `genActor.brain.caseAskable.integration.test.ts` | turtles prose demo, both brain types |

### acceptance tests (blackbox)

the existing actor SDK acceptance tests should continue to pass. no new acceptance tests required since:
- actor.ask() contract is unchanged (input/output shapes same)
- BrainAtom support is additive, not breaking

---

## execution order

```
phase 0: ActorBrain type and Actor extension
  ├── 0.1 create ActorBrain type
  ├── 0.2 update Actor interface
  └── 0.3 verify types compile

phase 1: actorAsk operation extension
  ├── 1.1 update actorAsk signature
  └── 1.2 add unit tests for BrainAtom

phase 2: genActor operation extension
  ├── 2.1 update genActor signature + runtime check
  └── 2.2 add unit tests for BrainAtom, mixed brains

phase 3: rhachet-brain-xai package
  ├── 3.1 create package structure
  ├── 3.2 implement genBrainAtom
  ├── 3.3 implement index exports
  └── 3.4 add integration tests

phase 4: demo integration test
  ├── 4.1 create turtles prose test
  └── 4.2 verify end-to-end

final: run full test suite
  ├── npm run test:types
  ├── npm run test:unit
  └── npm run test:integration
```

---

## verification checklist

### blackbox criteria satisfied

- [x] usecase.1 = actor.ask() with BrainAtom returns { response: string }
- [x] usecase.2 = actor.ask() with BrainRepl unchanged
- [x] usecase.3 = genActor accepts mixed brain types
- [x] usecase.4 = xAI brain atom creation works
- [x] usecase.5 = prose demo test passes

### subcomponent contracts

```
given('ActorBrain type contract')
  then('is union of BrainRepl | BrainAtom')

given('actorAsk contract')
  then('exposes: actorAsk({ role, brain: ActorBrain, prompt }) => { response }')

given('genActor contract')
  then('exposes: genActor({ role, brains: ActorBrain[] }) => Actor')
  then('throws BadRequestError when .act() called with BrainAtom')

given('genBrainAtom (xai) contract')
  then('exposes: genBrainAtom({ slug: XAIAtomSlug }) => BrainAtom')
  then('BrainAtom.ask() calls xAI API via OpenAI SDK')
```

### test coverage criteria

```
given('ActorBrain support feature')
  then('has unit tests for actorAsk with BrainAtom')
  then('has unit tests for genActor with BrainAtom')
  then('has unit tests for genActor .act() rejection')
  then('has integration tests for xAI genBrainAtom')
  then('has integration tests for xAI package index')
  then('has integration test for actor.ask() with BrainAtom (turtles demo)')
```

---

## environment requirements

| variable | required for | description |
|----------|--------------|-------------|
| `XAI_API_KEY` | phase 3, 4 | xAI API authentication token |
| `OPENAI_API_KEY` | existing tests | OpenAI API authentication (existing) |
| `ANTHROPIC_API_KEY` | existing tests | Anthropic API authentication (existing) |

---

## risk mitigation

### risk 1: type compatibility

**risk**: ActorBrain union may cause type inference issues

**mitigation**: use type assertions sparingly, prefer type guards where needed

### risk 2: runtime .act() check

**risk**: .act() called with BrainAtom at runtime

**mitigation**: BadRequestError with clear message; unit tests verify

### risk 3: xAI API availability

**risk**: xAI API may be unavailable during tests

**mitigation**: API key guard at test file top; test marked as integration (not unit)

---

## summary

| phase | deliverable | tests |
|-------|-------------|-------|
| 0 | ActorBrain type, Actor interface | type compile check |
| 1 | actorAsk accepts ActorBrain | unit: BrainAtom mock |
| 2 | genActor accepts ActorBrain[] | unit: BrainAtom, mixed, .act() rejection |
| 3 | rhachet-brain-xai package | integration: atom props, .ask(), index |
| 4 | turtles prose demo | integration: end-to-end actor.ask() |

**total new/modified files**: ~12
**total new test cases**: ~15

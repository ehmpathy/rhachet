# distill.domain.v1.i1

## wish summary

1. support `BrainAtom` in `actor.ask()` in addition to `BrainRepl`
2. create demo library `rhachet-brain-xai` for `BrainAtom({ repo: xai, slug: 'grok/code-fast-1' })`
3. demonstrate via integration test: `actor.ask()` writing prose about "sunshine ocean surfer turtles"

---

## usecases

### usecase.1 = actor.ask() with BrainAtom

```
given('an actor with a BrainAtom brain')
  when('actor.ask({ prompt }) is called')
    then('returns { response: string }')
      sothat('developers can use single-turn inference for fluid conversations')
    then('role briefs are passed to the brain')
      sothat('the brain has context from the role')
```

### usecase.2 = actor.ask() with BrainRepl (unchanged)

```
given('an actor with a BrainRepl brain')
  when('actor.ask({ prompt }) is called')
    then('returns { response: string }')
      sothat('existing behavior is preserved')
```

### usecase.3 = genActor with mixed brain types

```
given('a role definition')
  when('genActor({ role, brains: [BrainRepl | BrainAtom] }) is called')
    then('returns Actor with first brain as default')
      sothat('developers can choose between atom and repl brains')
    then('actor.ask() uses the default brain')
      sothat('.ask() works with whichever brain type is first')
```

### usecase.4 = xAI brain atom creation

```
given('XAI_API_KEY environment variable')
  when('genBrainAtom({ slug: "xai/grok-code-fast-1" }) is called')
    then('returns BrainAtom instance')
      sothat('developers can use xAI models')
  when('brainAtom.ask({ prompt, schema }) is called')
    then('calls xAI API via OpenAI SDK with baseURL override')
      sothat('no new SDK dependency is needed')
    then('returns parsed output matching schema')
      sothat('responses are type-safe')
```

### usecase.5 = prose demo test

```
given('an author role with briefs about writing')
  when('actor.ask({ prompt: "write prose about sunshine ocean surfer turtles" })')
    then('returns creative prose response')
      sothat('the feature is demonstrated end-to-end')
```

---

## domain.objects

### ActorBrain (new type)

**[NEW]**

a union type representing any brain that an actor can use.

```ts
/**
 * .what = a brain that an actor can use
 * .why = enables actors to use both BrainRepl and BrainAtom
 *
 * .note = BrainRepl supports both .ask() and .act()
 * .note = BrainAtom supports only .ask()
 */
export type ActorBrain = BrainRepl | BrainAtom;
```

**key insight**: BrainRepl and BrainAtom share a common interface for `.ask()`:

| property | BrainRepl | BrainAtom |
|----------|-----------|-----------|
| `repo` | string | string |
| `slug` | string | string |
| `description` | string | string |
| `ask()` | `<TOutput>(input) => Promise<TOutput>` | `<TOutput>(input) => Promise<TOutput>` |
| `act()` | `<TOutput>(input) => Promise<TOutput>` | *(not present)* |

the only difference is BrainRepl has `.act()` for tool-using operations.

---

### Actor (extend)

**[EXTEND]**

update the `brains` property to accept both `BrainRepl` and `BrainAtom`.

```ts
export interface Actor<TRole extends Role = Role> {
  role: TRole;

  /**
   * .what = the brains this actor is allowed to use
   * .note = first brain is the default
   * .note = BrainAtom only supports .ask(), BrainRepl supports both .ask() and .act()
   */
  brains: ActorBrain[];  // CHANGED: was BrainRepl[]

  act: ActorActOp<TRole>;  // unchanged - requires BrainRepl
  run: ActorRunOp<TRole>;  // unchanged - no brain needed
  ask: ActorAskOp;         // unchanged - works with both types
}
```

**constraint**: when `actor.act()` is called, the brain must be a `BrainRepl` (has `.act()` method). when `actor.ask()` is called, either brain type works.

---

### XAIAtomSlug (new type)

**[NEW]**

slug type for xAI brain atoms.

```ts
/**
 * .what = valid slugs for xAI brain atoms
 * .why = enables type-safe model selection
 */
export type XAIAtomSlug =
  | 'xai/grok-code-fast-1'  // 256K context, optimized for agentic coding
  | 'xai/grok-3'            // 131K context, balanced reasoning
  | 'xai/grok-3-mini'       // 131K context, fast and cost-effective
  | 'xai/grok-4'            // 256K context, advanced reasoning
  | 'xai/grok-4-fast';      // 2M context, frontier with reasoning
```

---

### XAIAtomConfig (new type)

**[NEW]**

configuration mapping for xAI models.

```ts
/**
 * .what = configuration for xAI brain atom
 * .why = maps slug to model ID and metadata
 */
interface XAIAtomConfig {
  model: string;       // xAI model ID (e.g., 'grok-code-fast-1')
  description: string; // human-readable description
  context: number;     // context window size in tokens
}
```

---

## domain.operations

### actorAsk (extend)

**[EXTEND]**

update the `brain` parameter type to accept both `BrainRepl` and `BrainAtom`.

```ts
/**
 * .what = starts a fluid conversation with a brain
 * .why = open-ended exploration, brain decides path
 */
export const actorAsk = async (input: {
  role: Role;
  brain: ActorBrain;  // CHANGED: was BrainRepl
  prompt: string;
}): Promise<{ response: string }> => {
  // resolve briefs from role
  const briefs = await getRoleBriefs({
    by: {
      role: { name: input.role.slug },
      briefs: { glob: '**/*' },
    },
  });

  // execute fluid conversation with brain
  // note: both BrainRepl and BrainAtom have identical .ask() signatures
  const result = await input.brain.ask({
    role: { briefs },
    prompt: input.prompt,
    schema: {
      output: z.object({ response: z.string() }),
    },
  });

  return result;
};
```

**change summary**: only the type signature changes; implementation is unchanged since both brain types share the same `.ask()` interface.

---

### genActor (extend)

**[EXTEND]**

update the `brains` parameter to accept both `BrainRepl` and `BrainAtom`.

```ts
/**
 * .what = creates an actor from a role and brain allowlist
 * .why = composes role (skills + briefs) with brains for type-safe invocation
 *
 * .note =
 *   - first brain in allowlist is the default
 *   - .act() requires BrainRepl (validates at runtime)
 *   - .ask() works with both BrainRepl and BrainAtom
 */
export const genActor = <TRole extends Role>(input: {
  role: TRole;
  brains: ActorBrain[];  // CHANGED: was BrainRepl[]
}): Actor<TRole> => {
  // ... existing validation ...

  // extract default brain (first in list)
  const defaultBrain = input.brains[0]!;

  // create bound .act() method
  const act: ActorActOp<TRole> = async (actInput) => {
    // resolve brain: use provided or default to first
    const brainResolved = actInput.brain
      ? findActorBrainInAllowlist({
          brain: actInput.brain,
          allowlist: input.brains,
        })
      : defaultBrain;

    // validate brain supports .act() (BrainRepl only)
    if (!('act' in brainResolved))
      throw new BadRequestError(
        'actor.act() requires a BrainRepl brain with .act() method',
        { brainSlug: brainResolved.slug },
      );

    // ... rest unchanged ...
  };

  // create bound .ask() method
  const ask = async (askInput: { prompt: string }): Promise<{ response: string }> => {
    // delegate to actorAsk with default brain
    // works with both BrainRepl and BrainAtom
    return actorAsk({
      role: input.role,
      brain: defaultBrain,  // ActorBrain works here
      prompt: askInput.prompt,
    });
  };

  // ... rest unchanged ...
};
```

**change summary**:
1. parameter type changes from `BrainRepl[]` to `ActorBrain[]`
2. runtime validation added to `.act()` to ensure brain supports `.act()` method
3. `.ask()` unchanged since both brain types support it

---

### genBrainAtom (new - rhachet-brain-xai)

**[NEW]**

factory function for xAI brain atoms.

```ts
/**
 * .what = creates a BrainAtom for xAI Grok models
 * .why = enables single-turn inference via xAI API
 */
export const genBrainAtom = (input: { slug: XAIAtomSlug }): BrainAtom => {
  const config = CONFIG_BY_SLUG[input.slug];

  return new BrainAtom({
    repo: 'xai',
    slug: input.slug,
    description: config.description,

    ask: async (askInput, context) => {
      // compose system prompt from briefs
      const systemPrompt = askInput.role.briefs
        ? await castBriefsToPrompt({ briefs: askInput.role.briefs })
        : undefined;

      // get openai client from context or create new one
      // xAI API is OpenAI-compatible with baseURL override
      const openai =
        (context?.openai as OpenAI | undefined) ??
        new OpenAI({
          apiKey: process.env.XAI_API_KEY,
          baseURL: 'https://api.x.ai/v1',
        });

      // build messages array
      const messages: OpenAI.ChatCompletionMessageParam[] = [];
      if (systemPrompt) {
        messages.push({ role: 'system', content: systemPrompt });
      }
      messages.push({ role: 'user', content: askInput.prompt });

      // call xAI API (OpenAI-compatible)
      const response = await openai.chat.completions.create({
        model: config.model,
        messages,
      });

      // extract content from response
      const content = response.choices[0]?.message?.content ?? '';

      // parse output via schema
      return askInput.schema.output.parse({ content });
    },
  });
};
```

---

### getBrainAtomsByXAI (new - rhachet-brain-xai)

**[NEW]**

export function for xAI brain atoms.

```ts
/**
 * .what = returns all brain atoms provided by xAI
 * .why = enables consumers to register xAI atoms with genContextBrain
 */
export const getBrainAtomsByXAI = (): BrainAtom[] => {
  return [genBrainAtom({ slug: 'xai/grok-code-fast-1' })];
};
```

---

## access.daos

no new DAOs required. xAI access is via HTTP API using the existing `openai` npm package with a `baseURL` override.

### access pattern: xAI API

| property | value |
|----------|-------|
| protocol | OpenAI-compatible Chat Completions API |
| base URL | `https://api.x.ai/v1` |
| auth | Bearer token via `XAI_API_KEY` environment variable |
| SDK | `openai` npm package (existing dependency) |
| request | `POST /chat/completions` with `model`, `messages[]` |
| response | `{ choices[].message.content }` |

---

## file structure

### files to modify

```
src/domain.objects/Actor.ts           # update brains type
src/domain.operations/actor/actorAsk.ts   # update brain type
src/domain.operations/actor/genActor.ts   # update brains type, add runtime check
```

### files to create

```
src/_topublish/rhachet-brain-xai/
  src/
    index.ts                          # exports getBrainAtomsByXAI, genBrainAtom
    atoms/
      genBrainAtom.ts                 # BrainAtom factory
      genBrainAtom.integration.test.ts
  package.json
  tsconfig.json
```

### test files to create/modify

```
# new tests
src/_topublish/rhachet-brain-xai/src/index.integration.test.ts
src/_topublish/rhachet-brain-xai/src/atoms/genBrainAtom.integration.test.ts

# modified tests
src/domain.operations/actor/actorAsk.test.ts     # add BrainAtom case
src/domain.operations/actor/genActor.test.ts     # add BrainAtom case
src/contract/sdk/genActor.brain.*.integration.test.ts  # add turtles prose demo
```

---

## summary

| component | action | rationale |
|-----------|--------|-----------|
| ActorBrain | **[NEW]** | union type for BrainRepl \| BrainAtom |
| Actor.brains | **[EXTEND]** | change type to ActorBrain[] |
| actorAsk.brain | **[EXTEND]** | change type to ActorBrain |
| genActor.brains | **[EXTEND]** | change type, add runtime check for .act() |
| XAIAtomSlug | **[NEW]** | type for xAI model slugs |
| genBrainAtom (xai) | **[NEW]** | factory for xAI brain atoms |
| getBrainAtomsByXAI | **[NEW]** | export for xAI brain atoms |

### key insight

the extension is minimal because BrainRepl and BrainAtom share identical `.ask()` signatures. the only complexity is:
1. `ActorBrain` union type for the common interface
2. runtime validation in `.act()` to ensure BrainRepl is used
3. new package for xAI following existing patterns

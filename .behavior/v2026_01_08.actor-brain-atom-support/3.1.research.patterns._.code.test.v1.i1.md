# research.patterns.code.test.v1.i1

## wish summary

1. support BrainAtom in `actor.ask()` in addition to BrainRepl
2. create demo library `rhachet-brain-xai` for BrainAtom({ repo: xai, slug: 'grok/code-fast-1' })
3. demonstrate with integration test: `actor.ask()` writing prose about "sunshine ocean surfer turtles"

---

## test pattern 1: brain atom integration test structure

**[REUSE]**

### description

integration tests for brain atoms follow a standard structure: given/when/then with API key guard, timeout, and multiple test cases for atom inspection and `.ask()` behavior.

### citations

[1] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:1-5`
```ts
import { BadRequestError } from 'helpful-errors';
import path from 'path';
import { genArtifactGitFile } from 'rhachet-artifact-git';
import { given, then, when } from 'test-fns';
import { z } from 'zod';
```

[2] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:16-19`
```ts
if (!process.env.ANTHROPIC_API_KEY)
  throw new BadRequestError(
    'ANTHROPIC_API_KEY is required for integration tests',
  );
```

[3] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:21-25`
```ts
describe('genBrainAtom.integration', () => {
  jest.setTimeout(30000);

  // use haiku for fast integration tests
  const brainAtom = genBrainAtom({ slug: 'claude/haiku' });
```

[4] `src/_topublish/rhachet-brain-openai/src/atoms/genBrainAtom.integration.test.ts:19-23`
```ts
describe('genBrainAtom.integration', () => {
  jest.setTimeout(30000);

  // use gpt-4o-mini for fast integration tests
  const brainAtom = genBrainAtom({ slug: 'openai/gpt-4o-mini' });
```

### relation to wish

will reuse this exact pattern for `rhachet-brain-xai` integration tests with `XAI_API_KEY` guard.

---

## test pattern 2: test cases for atom properties (case1)

**[REUSE]**

### description

case1 tests atom properties: repo, slug, and description are correctly set.

### citations

[5] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:27-42`
```ts
  given('[case1] genBrainAtom({ slug: "claude/haiku" })', () => {
    when('[t0] inspecting the atom', () => {
      then('repo is "anthropic"', () => {
        expect(brainAtom.repo).toEqual('anthropic');
      });

      then('slug is "claude/haiku"', () => {
        expect(brainAtom.slug).toEqual('claude/haiku');
      });

      then('description is defined', () => {
        expect(brainAtom.description).toBeDefined();
        expect(brainAtom.description.length).toBeGreaterThan(0);
      });
    });
  });
```

### relation to wish

will reuse for xai: test `repo === 'xai'`, `slug === 'xai/grok-code-fast-1'`, description defined.

---

## test pattern 3: test cases for ask behavior (case2)

**[REUSE]**

### description

case2 tests `.ask()` behavior with simple prompt (t0) and with briefs (t1).

### citations

[6] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:44-56`
```ts
  given('[case2] ask is called', () => {
    when('[t0] with simple prompt', () => {
      then('it returns a substantive response', async () => {
        const result = await brainAtom.ask({
          role: {},
          prompt: 'respond with exactly: hello world',
          schema: { output: outputSchema },
        });
        expect(result.content).toBeDefined();
        expect(result.content.length).toBeGreaterThan(0);
        expect(result.content.toLowerCase()).toContain('hello');
      });
    });
```

[7] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:58-73`
```ts
    when('[t1] with briefs', () => {
      then('response leverages knowledge from brief', async () => {
        const briefs = [
          genArtifactGitFile({
            uri: path.join(BRIEFS_DIR, 'secret-code.brief.md'),
          }),
        ];
        const result = await brainAtom.ask({
          role: { briefs },
          prompt: 'say hello',
          schema: { output: outputSchema },
        });
        expect(result.content).toBeDefined();
        expect(result.content).toContain('ZEBRA42');
      });
    });
```

### relation to wish

will reuse for xai: test `.ask()` returns content, test briefs are incorporated.

---

## test pattern 4: test fixture for briefs (secret-code.brief.md)

**[REUSE]**

### description

a test fixture brief that instructs the model to include a secret code, enabling verification that briefs are passed to the model.

### citations

[8] `src/.test/asset/example.briefs/secret-code.brief.md:1`
```
you must always include the secret code "ZEBRA42" in your response
```

[9] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:9-12`
```ts
const BRIEFS_DIR = path.join(
  __dirname,
  '../../../../.test/asset/example.briefs',
);
```

### relation to wish

will reuse this fixture and path pattern for xai tests.

---

## test pattern 5: output schema definition

**[REUSE]**

### description

a simple zod schema for testing `.ask()` responses that returns `{ content: string }`.

### citations

[10] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:14`
```ts
const outputSchema = z.object({ content: z.string() });
```

### relation to wish

will reuse this schema pattern for xai tests.

---

## test pattern 6: package index integration test

**[REUSE]**

### description

integration tests for the package index verify exported factory functions return correct types.

### citations

[11] `src/_topublish/rhachet-brain-anthropic/src/index.integration.test.ts:10-25`
```ts
describe('rhachet-brain-anthropic.integration', () => {
  given('[case1] getBrainAtomsByAnthropic', () => {
    when('[t0] called', () => {
      then('returns array with one atom', () => {
        const atoms = getBrainAtomsByAnthropic();
        expect(atoms).toHaveLength(1);
      });

      then('returns BrainAtom instances', () => {
        const atoms = getBrainAtomsByAnthropic();
        for (const atom of atoms) {
          expect(atom).toBeInstanceOf(BrainAtom);
        }
      });
    });
  });
```

[12] `src/_topublish/rhachet-brain-anthropic/src/index.integration.test.ts:43-55`
```ts
  given('[case3] genBrainAtom factory', () => {
    when('[t0] called with claude/haiku slug', () => {
      const atom = genBrainAtom({ slug: 'claude/haiku' });

      then('returns BrainAtom instance', () => {
        expect(atom).toBeInstanceOf(BrainAtom);
      });

      then('has correct slug', () => {
        expect(atom.slug).toEqual('claude/haiku');
      });
    });
  });
```

### relation to wish

will reuse for `rhachet-brain-xai`: test `getBrainAtomsByXAI()` returns BrainAtom instances.

---

## test pattern 7: unit test with mock brain

**[REUSE]**

### description

unit tests mock the brain to test operation behavior without real API calls.

### citations

[13] `src/domain.operations/actor/actorAsk.test.ts:8-11`
```ts
// mock getRoleBriefs to avoid .agent/ directory requirement in unit tests
jest.mock('@src/domain.operations/role/getRoleBriefs', () => ({
  getRoleBriefs: jest.fn().mockResolvedValue([]),
}));
```

[14] `src/domain.operations/actor/actorAsk.test.ts:29-36`
```ts
  // create mock brain
  // note: brain.ask returns { response: string } object, not raw string
  const mockBrain = {
    repo: 'anthropic',
    slug: 'claude',
    description: 'mock brain for testing',
    act: jest.fn().mockResolvedValue({ summary: 'test summary' }),
    ask: jest.fn().mockResolvedValue({ response: 'hello from the brain' }),
  } as unknown as BrainRepl;
```

### relation to wish

will extend pattern to support `BrainAtom` type in mock brain.

---

## test pattern 8: genActor unit test structure

**[EXTEND]**

### description

unit tests for genActor verify actor creation, brain allowlist, and method behavior.

### citations

[15] `src/domain.operations/actor/genActor.test.ts:63-76`
```ts
  // create mock brains
  const mockBrain1 = {
    repo: 'anthropic',
    slug: 'claude',
    act: jest.fn().mockResolvedValue({ summary: 'test summary' }),
    ask: jest.fn().mockResolvedValue('test response'),
  } as unknown as BrainRepl;

  const mockBrain2 = {
    repo: 'openai',
    slug: 'codex',
    act: jest.fn().mockResolvedValue({ summary: 'codex summary' }),
    ask: jest.fn().mockResolvedValue('codex response'),
  } as unknown as BrainRepl;
```

[16] `src/domain.operations/actor/genActor.test.ts:162-171`
```ts
  given('[case3] genActor with single brain', () => {
    const actor = genActor({ role: testRole, brains: [mockBrain1] });

    when('[t0] ask is called', () => {
      then('uses default brain', async () => {
        await actor.ask({ prompt: 'hello' });
        expect(mockBrain1.ask).toHaveBeenCalled();
      });
    });
  });
```

### relation to wish

will extend to add tests for `brains: BrainAtom[]` support in `.ask()`.

---

## test pattern 9: actor integration test with real brain

**[EXTEND]**

### description

integration tests use real brains (genBrainRepl) and test fixtures with `.agent/` structure.

### citations

[17] `src/contract/sdk/genActor.brain.casePublished.integration.test.ts:73-78`
```ts
    // create author actor with openai brain
    const brain = genBrainRepl({ slug: 'openai/codex' });
    const author = genActor({
      role: authorRole,
      brains: [brain],
    });
```

[18] `src/contract/sdk/genActor.brain.casePublished.integration.test.ts:128-137`
```ts
    when('[t4] author.ask({ prompt })', () => {
      then('starts fluid conversation with default brain', async () => {
        const result = await author.ask({
          prompt: 'tell me about the turtles',
        });

        expect(result).toBeDefined();
        expect(result.response).toBeDefined();
      });
    });
```

### relation to wish

will extend to add test case for `actor.ask()` with BrainAtom showing "sunshine ocean surfer turtles" prose.

---

## test pattern 10: test fixture directory exports

**[REUSE]**

### description

test fixtures are organized in directories with exported path constants.

### citations

[19] `.test/assets/example.repo/directory.ts:7-23`
```ts
export const EXAMPLE_REPO_DIR = __dirname;

export const EXAMPLE_REPO_COLLOCATED = resolve(
  EXAMPLE_REPO_DIR,
  'rhachet-roles-example.collocated',
);

export const EXAMPLE_REPO_PUBLISHED = resolve(
  EXAMPLE_REPO_DIR,
  'rhachet-roles-example.published',
);

export const EXAMPLE_REPO_WITH_RIGID_SKILL = resolve(
  EXAMPLE_REPO_DIR,
  'repo-with-role-with-rigid-skill',
);
```

### relation to wish

will reuse pattern for referencing test fixtures in integration tests.

---

## test pattern 11: test role definition with Role.typed()

**[REUSE]**

### description

test roles are defined using `Role.typed()` for literal type preservation.

### citations

[20] `.test/assets/example.repo/repo-with-role-with-rigid-skill/role.ts:11-28`
```ts
export const testerRole = Role.typed({
  slug: 'tester',
  name: 'Tester',
  purpose: 'test role for integration tests',
  readme: { uri: '.agent/repo=.this/role=tester/readme.md' },
  traits: [],
  skills: {
    rigid: {
      'echo.review': {
        input: z.object({ content: z.string() }),
        output: z.object({ echoed: z.string(), reviewed: z.boolean() }),
      },
    },
    dirs: { uri: '.agent/repo=.this/role=tester/skills' },
    refs: [],
  },
  briefs: { dirs: { uri: '.agent/repo=.this/role=tester/briefs' } },
});
```

### relation to wish

will reuse for creating test role (e.g., "author" role) for the turtles prose demo.

---

## test pattern 12: test temp directory management

**[REUSE]**

### description

integration tests create temp directories, copy fixtures, and restore cwd in afterAll.

### citations

[21] `src/contract/sdk/genActor.brain.casePublished.integration.test.ts:20-22`
```ts
    // setup: use temp dir within project (avoids codex trust issues)
    const tmpDir = path.resolve(__dirname, './.temp/casePublished');
    const originalCwd = process.cwd();
```

[22] `src/contract/sdk/genActor.brain.casePublished.integration.test.ts:24-30`
```ts
    beforeAll(() => {
      // clean and recreate temp directory
      rmSync(tmpDir, { recursive: true, force: true });
      mkdirSync(tmpDir, { recursive: true });

      // copy fixture to temp directory
      cpSync(EXAMPLE_REPO_PUBLISHED, tmpDir, { recursive: true });
```

[23] `src/contract/sdk/genActor.brain.casePublished.integration.test.ts:67-71`
```ts
    afterAll(() => {
      process.chdir(originalCwd);
      rmSync(tmpDir, { recursive: true, force: true });
    });
```

### relation to wish

will reuse for integration test setup/teardown.

---

## test pattern 13: test infra helpers

**[REUSE]**

### description

shared test infrastructure provides helpers for temp directories and asset creation.

### citations

[24] `src/.test/infra/genTestTempDir.ts:8-22`
```ts
export const genTestTempDir = (input: {
  /** base directory (typically __dirname) */
  base: string;
  /** subdirectory name under .temp */
  name: string;
}): {
  /** absolute path to the test directory */
  path: string;
  /** call in beforeAll to setup directory and switch cwd */
  setup: () => void;
  /** call in afterAll to restore original cwd */
  teardown: () => void;
  /** call to remove a file or directory within the test dir */
  rm: (relativePath: string) => void;
} => {
```

[25] `src/.test/infra/setTestTempAsset.ts:8-17`
```ts
export const setTestTempAsset = (input: {
  /** directory to create the asset in (must be under .temp) */
  dir: string;
  /** filename (e.g., 'test.sh', 'data.json') */
  name: string;
  /** file content */
  content: string;
  /** whether to make the file executable (default: true for .sh files) */
  executable?: boolean;
}): {
```

### relation to wish

will reuse for test setup if needed.

---

## test pattern 14: timeout configuration

**[REUSE]**

### description

integration tests set appropriate timeouts: 30s for atoms, 60s for repls.

### citations

[26] `src/_topublish/rhachet-brain-anthropic/src/atoms/genBrainAtom.integration.test.ts:22`
```ts
  jest.setTimeout(30000);
```

[27] `src/_topublish/rhachet-brain-anthropic/src/repls/genBrainRepl.integration.test.ts:22`
```ts
  jest.setTimeout(60000);
```

### relation to wish

will reuse 30000ms timeout for xai atom tests.

---

## summary

| pattern | status | rationale |
|---------|--------|-----------|
| brain atom integration test structure | **[REUSE]** | exact pattern for xai tests |
| test cases for atom properties (case1) | **[REUSE]** | verify repo, slug, description |
| test cases for ask behavior (case2) | **[REUSE]** | verify simple prompt and briefs |
| test fixture for briefs | **[REUSE]** | secret-code.brief.md pattern |
| output schema definition | **[REUSE]** | zod schema for content |
| package index integration test | **[REUSE]** | test getBrainAtomsByXAI |
| unit test with mock brain | **[REUSE]** | mock pattern for unit tests |
| genActor unit test structure | **[EXTEND]** | add BrainAtom support tests |
| actor integration test with real brain | **[EXTEND]** | add turtles prose demo test |
| test fixture directory exports | **[REUSE]** | path constants pattern |
| test role definition | **[REUSE]** | Role.typed() pattern |
| test temp directory management | **[REUSE]** | beforeAll/afterAll pattern |
| test infra helpers | **[REUSE]** | genTestTempDir, setTestTempAsset |
| timeout configuration | **[REUSE]** | 30000ms for atoms |

---

## new tests to create

### 1. rhachet-brain-xai tests

- `src/_topublish/rhachet-brain-xai/src/atoms/genBrainAtom.integration.test.ts`
  - [case1] test atom properties (repo='xai', slug, description)
  - [case2] test `.ask()` with simple prompt and with briefs

- `src/_topublish/rhachet-brain-xai/src/index.integration.test.ts`
  - [case1] test `getBrainAtomsByXAI()` returns BrainAtom[]
  - [case2] test `genBrainAtom({ slug: 'xai/grok-code-fast-1' })` factory

### 2. actor.ask() with BrainAtom demo test

- extend existing actor integration tests or create new:
  - [case] actor with BrainAtom brain
  - [t0] `actor.ask({ prompt: 'write prose about sunshine ocean surfer turtles' })`
  - assert response contains relevant content

### 3. genActor unit tests for BrainAtom support

- extend `src/domain.operations/actor/genActor.test.ts`:
  - [case] genActor with BrainAtom in brains array
  - verify `.ask()` works with BrainAtom

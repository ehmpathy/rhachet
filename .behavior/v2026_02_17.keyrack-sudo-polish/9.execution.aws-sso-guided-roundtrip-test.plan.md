# plan: aws.iam.sso guided setup roundtrip acceptance test

## goal

add an acceptance test that exercises the full guided wizard flow (`setupAwsSsoWithGuide`) end-to-end, without real AWS credentials. the test proves the interactive TTY path works: sso domain selection, account/role selection, profile naming, ~/.aws/config write, and vault store write.

zero prod code changes — everything scoped to test assets.

## challenge

the guided flow calls real `aws` CLI commands:

| command | where | purpose |
|---------|-------|---------|
| `aws --version` | `setupAwsSsoProfile` | prerequisite check |
| `aws sso login --profile keyrack-auth` | `initiateAwsSsoAuth` | browser OAuth (temp profile) |
| `aws sso list-accounts --access-token ... --region ...` | `listAwsSsoAccounts` | enumerate accounts |
| `aws sso list-account-roles --access-token ... --account-id ... --region ...` | `listAwsSsoRoles` | enumerate roles |
| `aws sso login --profile $name` | `setupAwsSsoProfile` | validate new profile |
| `aws sts get-caller-identity --profile $name` | `setupAwsSsoProfile` | validate session |
| `aws sts get-caller-identity --profile $name` | `vaultAdapterAwsIamSso.validateSsoSession` | unlock check |
| `aws sso login --profile $name` | `vaultAdapterAwsIamSso.triggerSsoLogin` | unlock refresh |
| `aws sso logout --profile $name` | `vaultAdapterAwsIamSso.relock` | clear caches |

additionally:
- `listAwsSsoAccounts` and `listAwsSsoRoles` read `~/.aws/sso/cache/*.json` for the access token
- `listAwsSsoStartUrls` reads `~/.aws/config` for portal URLs
- `setupAwsSsoProfile` writes to `~/.aws/config`
- the wizard reads interactive input via `readline` from `process.stdin`
- the guided flow is gated behind `process.stdin.isTTY` — piped stdin returns `false`

## approach

### 1. mock `aws` executable via PATH override

place at `accept.blackbox/.test/assets/mock-aws-cli/aws` (executable).

the executable inspects `$1 $2` (subcommand) and returns canned JSON:

```sh
#!/usr/bin/env bash
case "$1 $2" in
  "--version ")
    echo "aws-cli/2.0.0-mock Python/3.9.0 Linux/5.0.0"
    ;;
  "sso login")
    echo "Attempting to automatically open the SSO authorization page in your default browser."
    echo "If the browser does not open or you wish to use a different device to authorize this request, open the following URL:"
    echo ""
    echo "https://device.sso.us-east-1.amazonaws.com/"
    echo ""
    echo "Then enter the code:"
    echo ""
    echo "MOCK-CODE"
    echo ""
    echo "Successfully logged into Start URL: https://mock-portal.awsapps.com/start"
    ;;
  "sso list-accounts")
    echo '{"accountList":[{"accountId":"123456789012","accountName":"testorg-dev","emailAddress":"dev@testorg.com"},{"accountId":"987654321098","accountName":"testorg-prod","emailAddress":"prod@testorg.com"}]}'
    ;;
  "sso list-account-roles")
    echo '{"roleList":[{"roleName":"AdministratorAccess"},{"roleName":"ReadOnlyAccess"}]}'
    ;;
  "sts get-caller-identity")
    echo '{"UserId":"MOCK:session","Account":"123456789012","Arn":"arn:aws:sts::123456789012:assumed-role/AdministratorAccess/session"}'
    ;;
  "sso logout")
    ;;
  *)
    echo "mock aws: unknown command: $*" >&2
    exit 1
    ;;
esac
```

pass mock aws directory first on PATH: `env: { PATH: mockAwsDir + ':' + process.env.PATH }`.

### 2. pseudo-TTY via `script -qec` (util-linux)

the guided setup is gated behind `process.stdin.isTTY` at `vaultAdapterAwsIamSso.ts:217`. when run via `spawnSync({ input: ... })`, `isTTY` is `false` because stdin is a pipe.

fix: wrap the CLI invocation in the `script` utility (util-linux) with `-qec` flags to create a real pseudo-TTY. the inner process sees `process.stdin.isTTY === true`, while the utility forwards piped data through the PTY master to the PTY slave.

```ts
spawnSync('script', [
  '-qec',
  `"${binPath}" keyrack set --key AWS_PROFILE --env test --vault aws.iam.sso`,
  '/dev/null',
], {
  input: '1\n1\n1\n\n',
  encoding: 'utf-8',
  env: { HOME: repo.path, PATH: mockAwsDir + ':' + process.env.PATH, ... },
});
```

flags: `-q` = quiet (no "started" banner), `-e` = return child exit code, `-c` = command to run.

zero prod code changes. TTY bypass scoped entirely in the test invocation.

### 3. pre-populate aws fixtures (programmatic in `useBeforeAll`)

**`~/.aws/sso/cache/mock-token.json`** — `listAwsSsoAccounts` and `listAwsSsoRoles` read sso cache for access token:

```json
{
  "accessToken": "mock-access-token-for-test",
  "expiresAt": "2099-01-01T00:00:00Z"
}
```

**`~/.aws/config`** — `listAwsSsoStartUrls` reads config for portal URLs:

```ini
[sso-session mock-portal]
sso_start_url = https://mock-portal.awsapps.com/start
sso_region = us-east-1
```

both created programmatically in `useBeforeAll` at the test HOME path.

### 4. multi-line stdin for wizard prompts

the wizard asks in order:
1. "which sso domain?" — answer `1` (pick first portal from config)
2. "which account?" — answer `1` (pick first account)
3. "which role?" — answer `1` (pick first role)
4. "what should we call it?" — answer empty (accept suggested name `testorg.dev`)

stdin: `'1\n1\n1\n\n'`

### 5. test setup flow

1. `genTestTempRepo({ fixture: 'minimal' })` — blank repo with ssh key
2. run `keyrack init` — creates encrypted manifest
3. write `.agent/keyrack.yml` with `org: testorg` and `env.test:` section
4. create `$HOME/.aws/config` with portal entry
5. create `$HOME/.aws/sso/cache/mock-token.json`
6. run guided `keyrack set` via pseudo-TTY with mock aws on PATH and stdin `1\n1\n1\n\n`

### 6. assertions after guided set

- exit code 0
- stdout contains wizard output (sso domain, account, role, profile name)
- `$HOME/.rhachet/keyrack.aws-iam-sso.json` has entry with profile name `testorg.dev`
- `$HOME/.aws/config` has `[profile testorg.dev]` section with sso fields
- `keyrack list --json` shows key with `vault: aws.iam.sso` and `mech: EPHEMERAL_VIA_AWS_SSO`

### 7. roundtrip: unlock -> get -> relock -> get

- `keyrack get --key AWS_PROFILE --env test --json` -> status: locked
- `keyrack unlock --env test --key AWS_PROFILE` (with mock aws on PATH) -> 1 key unlocked
- `keyrack get --key AWS_PROFILE --env test --json` -> status: granted, value: profile name
- `keyrack relock` -> relocked
- `keyrack get --key AWS_PROFILE --env test --json` -> status: locked

## file changes

```
accept.blackbox/
  .test/
    assets/
      mock-aws-cli/
        [+] aws                              — mock aws CLI executable (canned responses)
  cli/
    [~] keyrack.vault.awsIamSso.acceptance.test.ts  — add guided flow roundtrip case
```

zero prod code changes. zero new fixtures (aws state created programmatically). mock aws executable is a static test asset.

## derived profile name

the wizard builds a suggested profile name from `org` + account name suffix:

```ts
const accountSlug = selectedAccount.accountName.toLowerCase().replace(/[^a-z0-9]/g, '');
const orgLower = input.org.toLowerCase();
const accountSuffix = accountSlug.startsWith(orgLower) ? accountSlug.slice(orgLower.length) : accountSlug;
const suggestedName = `${input.org}.${accountSuffix || accountSlug}`;
```

with `org: 'testorg'` and account name `'testorg-dev'`:
- `accountSlug` = `'testorgdev'`
- `orgLower` = `'testorg'`
- starts with org -> `accountSuffix` = `'dev'`
- `suggestedName` = `'testorg.dev'`

user presses enter (empty input) -> profile name = `'testorg.dev'`.

# rebase conflict resolution plan

## context

interactive rebase of `vlad/keyrack-sudo` onto `5ee5df7` (updated main).
two commits to rebase: `54de2fd` then `393caca`.
currently stuck on first commit (`54de2fd`) with 11 conflicted files, 37 conflict regions.

## main branch additions (since branch diverged)
- `aws.iam.sso` vault type (schema enum + setup wizard)
- slug resolution helpers (`asKeyrackKeyName`, `resolveKeyrackSlug` → rename to `asKeyrackKeySlug`)
- `getAllKeyrackSlugsForEnv`
- `doesAwsProfileExist`

## branch additions
- encrypted host manifests + sudo env support
- recipient management (`initKeyrack`, `delKeyrackRecipient`, `getKeyrackRecipients`, `setKeyrackRecipient`)
- daemon owner isolation + env-scoped relock
- `env`, `org`, `vaultRecipient`, `maxDuration` fields on host manifest schema

---

## resolution per file

### 1. `.agent/keyrack.yml` — 1 conflict
- **strategy**: take branch
- **reason**: branch has evolved env config (`env.all` with keys, `env.prod: []`)

### 2. `src/access/daos/daoKeyrackHostManifest/schema.ts` — 2 conflicts
- **strategy**: MERGE
- conflict A (vault enum): add `'aws.iam.sso'` from main into branch's enum
- conflict B (env/org/vaultRecipient/maxDuration fields): take branch
- **reason**: need both the new vault type AND the new fields

### 3. `src/access/daos/daoKeyrackRepoManifest/index.ts` — 2 conflicts
- **strategy**: take branch
- **reason**: branch has evolved API (`getPath`, `init`, `set.findsertKeyToEnv`)

### 4. `src/contract/cli/invokeKeyrack.ts` — 11 conflicts
- **strategy**: take branch for all 11 regions
- **reason**: branch has superset CLI (init, recipient, encrypted manifest, sudo)
- **note**: aws sso wizard from main is NOT yet integrated — can be added in a follow-up

### 5. `src/domain.operations/keyrack/getKeyrackKeyGrant.ts` — 4 conflicts
- **strategy**: take branch for all 4 regions
- **reason**: branch handles sudo keys correctly (deferred repo manifest check, isSudoKey flag)

### 6. `src/domain.operations/keyrack/session/relockKeyrack.ts` — 1 conflict
- **strategy**: MERGE (trickiest file)
- take branch signature: `relockKeyrack(input?: {owner?, slugs?, env?})`
- take branch socket path resolution
- KEEP main's vault adapter relock loop (lines 50-66) — branch lost this cleanup code
- **reason**: branch has better signature + owner support; main has vault cleanup that must not be lost

### 7. `src/domain.operations/keyrack/session/unlockKeyrack.ts` — 1 conflict
- **strategy**: take branch
- **reason**: guard for `!repoManifest` moved inside `else` block for regular keys (line 105-109)

### 8. `accept.blackbox/cli/keyrack.daemon.acceptance.test.ts` — 1 conflict
- **strategy**: take branch
- **reason**: daemon test uses owner-scoped paths

### 9. `accept.blackbox/cli/keyrack.init.acceptance.test.ts` — 10 conflicts
- **strategy**: take branch for all
- **reason**: complete init test suite with encrypted manifest support

### 10. `accept.blackbox/cli/__snapshots__/keyrack.daemon.acceptance.test.ts.snap` — 2 conflicts
- **strategy**: take branch, then resnap after all code conflicts resolved
- **reason**: snapshots must match resolved code

### 11. `accept.blackbox/cli/__snapshots__/keyrack.envs.acceptance.test.ts.snap` — 2 conflicts
- **strategy**: take branch, then resnap after all code conflicts resolved

---

## post-resolution steps

1. `git add` all resolved files
2. `git rebase --continue` — handle second commit (`393caca`) conflicts if any
3. `npm run test:types` — verify type correctness
4. `npm run test:acceptance -- keyrack` — verify acceptance tests pass (resnap as needed)
5. `npm run test:unit` — verify unit tests pass

## risk notes

- `relockKeyrack.ts` merge is manual — must verify vault adapter cleanup loop compiles with new signature
- aws sso wizard from main is deferred — not lost, just not in this rebase pass
- snapshot files will need resnap after code resolution

## post-rebase rename

### `resolveKeyrackSlug` → `asKeyrackKeySlug`
- **reason**: aligns with `asX` convention (see `rule.forbid.term=...` briefs)
- rename file: `resolveKeyrackSlug.ts` → `asKeyrackKeySlug.ts`
- rename file: `resolveKeyrackSlug.test.ts` → `asKeyrackKeySlug.test.ts`
- update import + usage in `src/contract/cli/invokeKeyrack.ts` (lines 30, 388)

# execution gap: get context should not decrypt manifest

## defect

`keyrack get` prompts for ssh passphrase even when the key is already cached in the daemon. the passphrase prompt comes from manifest decryption in `genKeyrackGrantContext`, which fires unconditionally before the daemon check.

## root cause

`genKeyrackGrantContext` loads and decrypts the host manifest on every call. `keyrack get` calls this context builder before `getKeyrackKeyGrant`, which means the passphrase prompt fires before the daemon cache check at line 128 of `getKeyrackKeyGrant.ts` has a chance to short-circuit.

for sudo keys, the daemon is the **only** authorized grant path (after envvar passthrough). the manifest is loaded but never consulted.

for regular keys that are already in the daemon, same — the manifest fallthrough only fires on daemon miss.

## decision

`get` only ever reads from unlocked sources (`os.envvar`, `os.daemon`). only `unlock` reads from vaults that require manifest decryption.

these are two distinct contexts with different dependencies:

| operation | sources | needs manifest | needs vault adapters |
|-----------|---------|----------------|---------------------|
| `get` | os.envvar, os.daemon | no | no |
| `unlock` | os.envvar, os.daemon, os.secure, os.direct | yes | yes |

## fix

split `KeyrackGrantContext` into two context types:

- `ContextKeyrackGrantGet` — lightweight, no manifest decryption, no passphrase prompt
  - assembled via `genContextKeyrackGrantGet()`
  - contains: envvar adapter, daemon adapter, mech adapters
  - does NOT contain: host manifest, vault adapters (os.secure, os.direct)

- `ContextKeyrackGrantUnlock` — full context with manifest and vault adapters
  - assembled via `genContextKeyrackGrantUnlock()`
  - contains: host manifest (decrypted), repo manifest, all vault adapters, all mech adapters
  - requires passphrase for manifest decryption

### rename pattern

current:
- `KeyrackGrantContext` → split into two
- `genKeyrackGrantContext()` → split into two

after:
- `ContextKeyrackGrantGet` + `genContextKeyrackGrantGet()`
- `ContextKeyrackGrantUnlock` + `genContextKeyrackGrantUnlock()`

### codepath after fix

```
keyrack get --key X --env sudo
  genContextKeyrackGrantGet()        ← no manifest, no passphrase
    assembles: envvar adapter, daemon client, mech adapters
  getKeyrackKeyGrant()
    envvar check → miss
    daemon check → HIT → granted     ← resolves without passphrase

keyrack unlock --env sudo --key X
  genContextKeyrackGrantUnlock()     ← decrypts manifest, may prompt passphrase
    daoKeyrackHostManifest.get()
    setOsSecureSessionIdentity()
    assembles: all vault adapters, mech adapters
  unlockKeyrack()
    slug filter from hostManifest
    vault adapter.get() → decrypt
    daemon send with TTL
```

## acceptance test coverage

`get` never touches the manifest. the tests should prove this for both states:

```
given('[caseN] get never requires manifest decryption')
  # use a fixture with passphrase-protected ssh key (mech: 'ssh')
  # init + set + unlock performed beforehand with passphrase provided

  when('get --key X --env sudo (key not in daemon)')
    then('returns status: locked')
      sothat('get resolves without manifest decryption')
    then('does not prompt for passphrase')
      sothat('the locked path never touches the manifest')

  when('get --key X --env sudo (key in daemon)')
    then('returns status: granted with correct value')
      sothat('get resolves from daemon without manifest decryption')
    then('does not prompt for passphrase')
      sothat('the granted path never touches the manifest')
```

### how to detect manifest decryption in tests

run `keyrack get` with:
- `SSH_AUTH_SOCK=''` (no agent) and no passphrase on stdin
- a timeout that fails fast if the process blocks on stdin (e.g., 5s)
- if the process exits 0 within timeout → no manifest decryption occurred
- if it hangs or exits non-zero → the manifest path was hit (defect)

## impact

- no passphrase prompt on `keyrack get` after `keyrack unlock`
- no passphrase prompt on `keyrack get` in CI (envvar path)
- passphrase prompt only on `keyrack unlock` and `keyrack set` (which need vault access)
- cleaner separation of concerns: get = read from cache, unlock = read from vault

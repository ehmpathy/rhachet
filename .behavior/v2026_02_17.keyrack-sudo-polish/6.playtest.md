# playtest: keyrack-sudo polish

## prereqs

- branch: `vlad/keyrack-sudo`
- build: `npm run build`
- clean slate: if you have prior keyrack state from before the vault path refactor, remove `~/.rhachet/keyrack/` to start fresh

## sudo + os.secure roundtrip

```sh
# 1. init keyrack — discovers ssh key, creates encrypted manifest
./bin/run keyrack init

# 2. set a sudo credential into os.secure vault
echo "s3cr3t-token" | ./bin/run keyrack set --key MY_SUDO_TOKEN --env sudo --vault os.secure

# 3. verify it's listed with env: sudo, vault: os.secure
./bin/run keyrack list

# 4. get before unlock → expect status: "locked" with unlock hint
./bin/run keyrack get --key MY_SUDO_TOKEN --env sudo --json

# 5. unlock → expect "1 keys unlocked"
./bin/run keyrack unlock --env sudo --key MY_SUDO_TOKEN

# 6. get after unlock → expect status: "granted", value: "s3cr3t-token"
./bin/run keyrack get --key MY_SUDO_TOKEN --env sudo --json

# 7. relock
./bin/run keyrack relock

# 8. get after relock → expect status: "locked" again
./bin/run keyrack get --key MY_SUDO_TOKEN --env sudo --json
```

## sudo + os.direct roundtrip

```sh
# 1. set a sudo credential into os.direct vault
echo "direct-secret" | ./bin/run keyrack set --key MY_DIRECT_SUDO --env sudo --vault os.direct

# 2. get before unlock → expect status: "locked"
./bin/run keyrack get --key MY_DIRECT_SUDO --env sudo --json

# 3. unlock → expect "1 keys unlocked"
./bin/run keyrack unlock --env sudo --key MY_DIRECT_SUDO

# 4. get after unlock → expect status: "granted", value: "direct-secret"
./bin/run keyrack get --key MY_DIRECT_SUDO --env sudo --json

# 5. relock
./bin/run keyrack relock --env sudo

# 6. get after relock → expect status: "locked"
./bin/run keyrack get --key MY_DIRECT_SUDO --env sudo --json
```

## regular + os.direct roundtrip (no unlock needed)

```sh
# 1. set a regular credential into os.direct vault
echo "api-key-value" | ./bin/run keyrack set --key MY_API_KEY --env prod --vault os.direct

# 2. get → expect status: "granted", value: "api-key-value" (no unlock needed)
./bin/run keyrack get --key MY_API_KEY --env prod --json
```

## regular + os.secure roundtrip (identity auto-discovered)

```sh
# 1. set a regular credential into os.secure vault
echo "secure-api-key" | ./bin/run keyrack set --key SECURE_KEY --env prod --vault os.secure

# 2. get → expect status: "granted", value: "secure-api-key"
./bin/run keyrack get --key SECURE_KEY --env prod --json
```

## expected results summary

| step | expected |
|------|----------|
| init | "freshly minted" (new) or "already active" (idempotent) |
| set sudo key | exit 0, stored in encrypted manifest only |
| list | shows key with env: sudo, vault: os.secure/os.direct |
| get before unlock (sudo) | status: "locked", fix hint mentions unlock |
| unlock | "1 keys unlocked" |
| get after unlock (sudo) | status: "granted", value matches |
| relock | keys purged from daemon |
| get after relock (sudo) | status: "locked" |
| get regular os.direct | status: "granted" immediately (no unlock) |
| get regular os.secure | status: "granted" immediately (identity auto-discovered) |

# roadmap: keyrack-sudo polish

## phase.0 — diagnose defects

**prereqs**: read before start
- `3.3.blueprint.v1.i1.md` (defect analysis section)
- `3.1.research.patterns._.code.prod.v1.i1.md` (pattern.2: sudo unlock key resolution, pattern.5: stdin value input)
- `3.1.research.patterns._.code.test.v1.i1.md` (pattern.1: test infra, pattern.4: stdin pipe)

**steps**:
- [ ] 0.1 — run acceptance test suite, capture exact failures
  - verify: failure list captured in `.log/` or inline
  - criteria: classify failures into defect.1, defect.2, defect.3 buckets
- [ ] 0.2 — reproduce "0 keys unlocked" via debug trace in `unlockKeyrack.ts`
  - verify: root cause identified (vault path? identity mismatch? passphrase?)
  - criteria: can articulate exactly which line returns null and why
- [ ] 0.3 — classify the 38 stdin failures
  - verify: all 38 share a common pattern or are bucketed by distinct causes
  - criteria: fix strategy confirmed for each bucket

---

## phase.1 — fix "0 keys unlocked" defect

**prereqs**: phase.0 complete (root cause identified)
- `3.1.research.patterns._.code.prod.v1.i1.md` (pattern.6: identity sync manifest to vault)
- `src/domain.operations/keyrack/session/unlockKeyrack.ts`
- `src/domain.operations/keyrack/adapters/vaults/vaultAdapterOsSecure.ts`

**steps**:
- [ ] 1.1 — apply targeted fix based on phase.0 diagnosis
  - verify: `unlockKeyrack()` returns non-empty `keysToUnlock` for sudo keys
  - criteria: `adapter.get()` returns the secret value (not null)
- [ ] 1.2 — verify roundtrip via acceptance test: set -> unlock -> get -> relock -> get
  - verify: unlock reports "1 key unlocked", get returns stored value, relock returns "locked"
  - criteria: usecase.1 from blackbox criteria satisfied

---

## phase.2 — fix stdin failures

**prereqs**: phase.0.3 complete (failures classified)
- `3.1.research.patterns._.code.test.v1.i1.md` (pattern.4: stdin pipe, pattern.3: acceptance flow)
- `accept.blackbox/.test/infra/invokeRhachetCliBinary.ts`

**steps**:
- [ ] 2.1 — apply fix based on classification from phase.0.3
  - verify: acceptance tests that pipe `stdin:` into `keyrack set` pass
  - criteria: usecase.5 from blackbox criteria satisfied
- [ ] 2.2 — verify no regressions in other acceptance tests
  - verify: tests that passed before still pass
  - criteria: no new failures introduced

---

## phase.3 — add roundtrip acceptance test

**prereqs**: phase.1 and phase.2 complete (defects repaired)
- `2.1.criteria.blackbox.md` (usecases 1-4)
- `3.1.research.patterns._.code.test.v1.i1.md` (all patterns)
- `3.3.blueprint.v1.i1.md` (roundtrip journey acceptance test contract)

**steps**:
- [ ] 3.1 — create `keyrack.roundtrip.acceptance.test.ts`
  - verify: file exists with journey test structure
  - criteria: covers all 4 env x vault combinations from matrix.1
- [ ] 3.2 — sudo + os.secure roundtrip: set -> get-locked -> unlock -> get-granted -> relock -> get-locked
  - verify: all assertions pass
  - criteria: usecase.1 satisfied
- [ ] 3.3 — sudo + os.direct roundtrip: set -> get-locked -> unlock -> get-granted -> relock -> get-locked
  - verify: all assertions pass
  - criteria: usecase.2 satisfied
- [ ] 3.4 — regular + os.direct roundtrip: set -> get-granted (no unlock)
  - verify: all assertions pass
  - criteria: usecase.3 satisfied
- [ ] 3.5 — regular + os.secure roundtrip: set -> unlock -> get-granted
  - verify: all assertions pass
  - criteria: usecase.4 satisfied

---

## phase.4 — resnap and verify

**prereqs**: phases 1-3 complete
- `2.1.criteria.blackbox.md` (usecase.6: snapshot consistency)

**steps**:
- [ ] 4.1 — run full acceptance suite, capture results
  - verify: only snapshot mismatches remain (no logic failures)
  - criteria: all non-snapshot tests pass
- [ ] 4.2 — resnap stale snapshots (cases 5, 6 and any others)
  - verify: output is correct before resnap (inspect the diff)
  - criteria: usecase.6 satisfied
- [ ] 4.3 — final full suite run — all green
  - verify: 0 failures
  - criteria: all usecases 1-7 satisfied
- [ ] 4.4 — signal ready for human playtest
  - verify: summary of what was fixed and what to test
  - criteria: human has clear steps to reproduce the roundtrip

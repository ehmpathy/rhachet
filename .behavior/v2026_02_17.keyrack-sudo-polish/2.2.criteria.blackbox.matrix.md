# blackbox coverage matrix: keyrack-sudo polish

## matrix.1 — key roundtrip by env × vault

the core roundtrip: set → list → get-locked → unlock → get-granted → relock → get-locked-again

dimensions:
- **ind: env** — `sudo` vs regular (`all`/`prod`/`prep`)
- **ind: vault** — `os.secure` vs `os.direct`

| ind: env | ind: vault | dep: in keyrack.yml | dep: get before unlock | dep: unlock count | dep: get after unlock | dep: get after relock |
|----------|------------|---------------------|------------------------|-------------------|-----------------------|-----------------------|
| sudo | os.secure | no (host manifest only) | locked + hint | 1 key unlocked | granted + value match | locked |
| sudo | os.direct | no (host manifest only) | locked + hint | 1 key unlocked | granted + value match | locked |
| regular | os.secure | yes (both manifests) | identity/passphrase gate | N keys unlocked | granted + value match | locked |
| regular | os.direct | yes (both manifests) | granted (always accessible) | N/A (no unlock needed) | granted + value match | N/A |

**coverage**: usecases 1, 2, 3, 4

---

## matrix.2 — stdin pipe into set by vault

the 38 pre-extant failures: acceptance tests pipe values via stdin into `keyrack set`.

dimensions:
- **ind: vault** — `os.secure` vs `os.direct`
- **ind: env** — `sudo` vs regular

| ind: vault | ind: env | dep: stdin pipe accepted | dep: roundtrip get returns value |
|------------|----------|-------------------------|--------------------------------|
| os.direct | sudo | yes | yes |
| os.direct | regular | yes | yes |
| os.secure | sudo | yes | yes |
| os.secure | regular | yes | yes |

**coverage**: usecase 5

---

## matrix.3 — snapshot consistency by command

the 4 pre-extant snapshot mismatches.

dimensions:
- **ind: command** — `status` vs `list`
- **ind: output format** — human vs `--json`

| ind: command | ind: output format | dep: matches snapshot |
|--------------|-------------------|----------------------|
| status | human | yes |
| status | --json | yes |
| list | human | yes |
| list | --json | yes |

**coverage**: usecase 6

---

## matrix.4 — vault path structure by vault type

dimensions:
- **ind: vault** — `os.secure` vs `os.direct`

| ind: vault | dep: persistence path |
|------------|----------------------|
| os.secure | `~/.rhachet/keyrack/vault/os.secure/{hash}.age` |
| os.direct | `~/.rhachet/keyrack/vault/os.direct/keyrack.direct.json` |

**coverage**: usecase 7

---

## gap analysis

### matrix.1 gaps — none
all 4 env × vault combinations are specified. the `regular × os.direct` row has unique behavior (no unlock needed) which is correctly captured.

### matrix.2 gaps — none
all 4 vault × env combinations are specified for stdin pipe support.

### decomposition notes
- matrix.1 has only 2 independent dimensions (env × vault) — clean, no decomposition needed
- matrix.2 is symmetric with matrix.1 dimensions — could be collapsed into matrix.1 as an additional dependent column, but kept separate for clarity since stdin pipe is a distinct concern (test infrastructure fix vs feature behavior)

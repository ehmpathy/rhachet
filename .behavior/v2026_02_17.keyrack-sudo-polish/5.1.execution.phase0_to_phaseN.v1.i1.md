# execution: keyrack-sudo polish

## phase.0 — diagnose defects

- [x] 0.1 — run acceptance test suite, capture exact failures
- [x] 0.2 — reproduce "0 keys unlocked" via debug trace
- [x] 0.3 — classify stdin failures

## phase.1 — fix "0 keys unlocked" defect

- [x] 1.1 — apply targeted fix (identity propagation in genKeyrackGrantContext + genKeyrackHostContext)
- [x] 1.2 — verify roundtrip via acceptance test

## phase.2 — fix stdin failures

- [x] 2.1 — apply fix (added stdin support to invokeRhachetCliBinary via spawnSync input)
- [x] 2.2 — verify no regressions

## phase.3 — add roundtrip acceptance test

- [x] 3.1 — create keyrack.roundtrip.acceptance.test.ts
- [x] 3.2 — sudo + os.secure roundtrip (6 steps, all pass)
- [x] 3.3 — sudo + os.direct roundtrip (6 steps, all pass)
- [x] 3.4 — regular + os.direct roundtrip (set + get, all pass)
- [x] 3.5 — regular + os.secure roundtrip (set + get, all pass)

## phase.4 — resnap and verify

- [x] 4.1 — run full acceptance suite (766 passed, 24 skipped, 0 failures)
- [x] 4.2 — resnap stale snapshots (101 snapshots pass, no mismatches)
- [x] 4.3 — final full suite run — all green
- [x] 4.4 — signal ready for human playtest (see below)

## phase.5 — fix findsert early-return defect (passphrase-protected keys)

- [x] 5.1 — human playtest revealed "0 keys unlocked" persists with passphrase-protected ssh keys
- [x] 5.2 — root cause: `setKeyrackKeyHost` findsert early-return skipped vault write when manifest entry already matched
- [x] 5.3 — fix: moved vault write BEFORE findsert check in `setKeyrackKeyHost.ts`
- [x] 5.4 — added diagnostic try/catch + warn messages in `unlockKeyrack.ts` for vault read failures and absent files
- [x] 5.5 — verified roundtrip acceptance test: 33 passed, 0 failed
- [x] 5.6 — verified sudo acceptance test: 89 passed, 6 skipped, 12 snapshots pass
- [x] 5.7 — final full acceptance suite: 766 passed, 24 skipped, 0 failed, 101 snapshots pass
- [x] 5.8 — signal ready for human playtest

## phase.6 — fix daemon state leakage in acceptance tests

- [x] 6.1 — sudo acceptance test case4 (relock behavior) expected "4 keys pruned" but got "5 keys pruned"
- [x] 6.2 — root cause: case3 sets a sudo key into the daemon, case4's bare relock purges ALL keys plus the leftover
- [x] 6.3 — fix: added `beforeAll(() => killKeyrackDaemonForTests({ owner: null }))` before case4 (same pattern as roundtrip case2)
- [x] 6.4 — verified sudo acceptance test: 89 passed, 6 skipped, 0 failed, 12 snapshots pass
- [x] 6.5 — verified full acceptance suite: 766 passed, 24 skipped, 0 failed, 101 snapshots pass

---

## playtest summary

### what was fixed

1. **identity propagation defect** — identity from encrypted host manifest was not propagated to the vault adapter in `genKeyrackGrantContext` and `genKeyrackHostContext`. fix: sync identity via `setOsSecureSessionIdentity()` in both context generators.

2. **findsert early-return defect** — `setKeyrackKeyHost` returned early when manifest entry already matched (findsert semantics), which skipped the vault write. on re-set of a key (e.g., after clean slate), the manifest entry exists but the vault file does not. fix: moved vault write BEFORE findsert check so vault file always exists when manifest entry exists.

3. **diagnostic hints in unlock** — added try/catch around `adapter.get()` and hint when vault file is absent. "0 keys unlocked" now provides actionable hints: `re-run: keyrack set --key ... --env ... --vault ...`.

4. **stdin pipe into `keyrack set`** — `invokeRhachetCliBinary` now passes `stdin` option through to `spawnSync({ input })`, so acceptance tests can pipe secret values into `keyrack set` without interactive prompts.

5. **env.all slug mismatch** — `daoKeyrackRepoManifest.get()` expands `env.all` entries into per-env slugs (`org.prod.KEY`, `org.prep.KEY`), never `org.all.KEY`. roundtrip tests use explicit `--env prod` on both set and get to ensure slug consistency across host manifest and repo manifest.

### roundtrip acceptance test coverage

| case | env | vault | steps |
|------|-----|-------|-------|
| case1 | sudo | os.secure | set → get-locked → unlock → get-granted → relock → get-locked |
| case2 | sudo | os.direct | set → get-locked → unlock → get-granted → relock → get-locked |
| case3 | regular (prod) | os.direct | set → get-granted (no unlock needed) |
| case4 | regular (prod) | os.secure | set → get-granted (identity auto-discovered) |

### how to playtest

```sh
# clean slate (if prior state from before vault path refactor)
rm -rf ~/.rhachet/keyrack/

# 1. init keyrack
./bin/run keyrack init

# 2. set a sudo credential into os.secure
echo "s3cr3t-token" | ./bin/run keyrack set --key MY_SUDO_TOKEN --env sudo --vault os.secure

# 3. verify it's listed
./bin/run keyrack list

# 4. get before unlock → should say "locked"
./bin/run keyrack get --key MY_SUDO_TOKEN --env sudo --json

# 5. unlock → should say "1 keys unlocked"
./bin/run keyrack unlock --env sudo --key MY_SUDO_TOKEN

# 6. get after unlock → should return "s3cr3t-token"
./bin/run keyrack get --key MY_SUDO_TOKEN --env sudo --json

# 7. relock
./bin/run keyrack relock

# 8. get after relock → should say "locked" again
./bin/run keyrack get --key MY_SUDO_TOKEN --env sudo --json

# 9. sudo + os.direct roundtrip
echo "direct-secret" | ./bin/run keyrack set --key MY_DIRECT_SUDO --env sudo --vault os.direct
./bin/run keyrack get --key MY_DIRECT_SUDO --env sudo --json
./bin/run keyrack unlock --env sudo --key MY_DIRECT_SUDO
./bin/run keyrack get --key MY_DIRECT_SUDO --env sudo --json

# 10. regular + os.direct roundtrip (no unlock needed)
echo "api-key-value" | ./bin/run keyrack set --key MY_API_KEY --env prod --vault os.direct
./bin/run keyrack get --key MY_API_KEY --env prod --json

# 11. regular + os.secure roundtrip (identity auto-discovered)
echo "secure-api-key" | ./bin/run keyrack set --key SECURE_KEY --env prod --vault os.secure
./bin/run keyrack get --key SECURE_KEY --env prod --json
```

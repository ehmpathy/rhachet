# blueprint: gen-context-choice-help

## overview

enhance `genContextBrain` to emit helpful error messages when brain choice is not found, with formatted list of available brains via treestruct pattern.

introduce `BrainChoiceNotFoundError` to enable downstream consumers to catch and display the formatted message via stderr.

---

## filediff treestruct

```
src/
â”œâ”€â”€ [+] domain.objects/BrainChoiceNotFoundError.ts
â”œâ”€â”€ [~] domain.objects/index.ts                       # export BrainChoiceNotFoundError
â”œâ”€â”€ [+] domain.operations/context/formatAvailableBrains.ts
â”œâ”€â”€ [+] domain.operations/context/formatAvailableBrains.test.ts
â”œâ”€â”€ [~] domain.operations/context/genContextBrain.ts  # throw BrainChoiceNotFoundError, update jsdoc
â””â”€â”€ [~] domain.operations/context/genContextBrain.test.ts
package.json
â””â”€â”€ [~] add fastest-levenshtein dependency
```

---

## codepath treestruct

```
genContextBrain({ atoms, repls, choice })
â”œâ”€â”€ validate no duplicate atoms
â”œâ”€â”€ validate no duplicate repls
â””â”€â”€ resolve choice
    â”œâ”€â”€ choice = undefined â†’ return null
    â”œâ”€â”€ choice = { repl: string }
    â”‚   â”œâ”€â”€ repl found â†’ return repl
    â”‚   â””â”€â”€ repl not found
    â”‚       â””â”€â”€ throw BrainChoiceNotFoundError
    â”‚           â”œâ”€â”€ message = "repl brain not found: {slug}\n\n{formatAvailableBrains}"
    â”‚           â””â”€â”€ metadata = { choice, available: { repls } }
    â”œâ”€â”€ choice = { atom: string }
    â”‚   â”œâ”€â”€ atom found â†’ return atom
    â”‚   â””â”€â”€ atom not found
    â”‚       â””â”€â”€ throw BrainChoiceNotFoundError
    â”‚           â”œâ”€â”€ message = "atom brain not found: {slug}\n\n{formatAvailableBrains}"
    â”‚           â””â”€â”€ metadata = { choice, available: { atoms } }
    â””â”€â”€ choice = string
        â”œâ”€â”€ found exactly one match â†’ return it
        â”œâ”€â”€ found multiple matches â†’ throw ambiguous error (BadRequestError)
        â””â”€â”€ found zero matches
            â””â”€â”€ throw BrainChoiceNotFoundError
                â”œâ”€â”€ message = "brain not found: {slug}\n\n{formatAvailableBrains}"
                â””â”€â”€ metadata = { choice, available: { atoms, repls } }

formatAvailableBrains({ atoms, repls, choice })
â”œâ”€â”€ compute brains list
â”‚   â”œâ”€â”€ map atoms â†’ { slug: repo/slug, type: 'atom' }
â”‚   â””â”€â”€ map repls â†’ { slug: repo/slug, type: 'repl' }
â”œâ”€â”€ compute distance once per brain (O(n))
â”‚   â””â”€â”€ map brains â†’ { ...brain, distance: levenshtein(slug, choice) }
â”œâ”€â”€ sort by precomputed distance (O(n log n) comparisons, O(1) per compare)
â”œâ”€â”€ truncate to max 21 entries
â”œâ”€â”€ format as treestruct
â”‚   â”œâ”€â”€ header = "ðŸ”­ available brains"
â”‚   â”œâ”€â”€ entries = "   {connector} {symbol} {slug}"
â”‚   â”‚   â”œâ”€â”€ connector = â”œâ”€â”€ or â””â”€â”€
â”‚   â”‚   â””â”€â”€ symbol = â—‹ (atom) or â†» (repl)
â”‚   â””â”€â”€ truncation indicator (if >21 brains)
â””â”€â”€ return formatted string
```

---

## domain decomposition

### new domain object: `BrainChoiceNotFoundError`

```ts
import { HelpfulError } from 'helpful-errors';

/**
 * .what = error thrown when brain choice is not found in available brains
 * .why = enables downstream consumers to catch and display formatted message via stderr
 *
 * @example
 * ```ts
 * try {
 *   genContextBrain({ atoms, repls, choice: 'antrhopic/cloude-code' });
 * } catch (error) {
 *   if (error instanceof BrainChoiceNotFoundError) {
 *     console.error(error.message); // formatted with available brains
 *     process.exit(1);
 *   }
 *   throw error;
 * }
 * ```
 */
export class BrainChoiceNotFoundError extends HelpfulError {}
```

no custom constructor needed â€” inherits `HelpfulError(message, metadata)` directly.

**location:** `src/domain.objects/BrainChoiceNotFoundError.ts`

**sdk export:** automatic via `export * from '@src/domain.objects'` in `src/contract/sdk.ts`

### new operation: `formatAvailableBrains`

```ts
/**
 * .what = formats available brains as treestruct for error messages
 * .why = provides helpful enumeration when brain choice not found
 */
export const formatAvailableBrains = (input: {
  atoms: BrainAtom[];
  repls: BrainRepl[];
  choice: string;
}): string
```

**responsibilities:**
1. combine atoms and repls into unified list with type indicators
2. sort by levenshtein distance to requested choice (most similar first)
3. truncate to 21 entries maximum
4. format as treestruct with:
   - ðŸ”­ header
   - 3-space indent
   - â”œâ”€â”€ / â””â”€â”€ connectors
   - â—‹ (atom) / â†» (repl) symbols
5. append truncation indicator if >21 brains

**design notes:**
- pure function (no side effects)
- deterministic output for same input (important for tests)
- handles edge cases: empty list, single brain, exactly 21, >21

### update operation: `genContextBrain`

**jsdoc update:**
```ts
/**
 * .what = factory to create a brain context from plugin-provided atoms and repls
 * .why =
 *   - provides a clean entry point for context creation
 *   - validates no duplicate { repo, slug } identifiers
 *   - composes the context with lookup and delegation logic
 *   - optionally pre-binds a chosen brain to brain.choice
 *
 * @throws {BrainChoiceNotFoundError} when choice does not match any available brain.
 *   the error message includes a formatted list of available brains sorted by
 *   similarity to the requested choice. consumers can catch this error to display
 *   the helpful message via stderr:
 *   ```ts
 *   try {
 *     return genContextBrain({ atoms, repls, choice });
 *   } catch (error) {
 *     if (error instanceof BrainChoiceNotFoundError) {
 *       console.error(error.message);
 *       process.exit(1);
 *     }
 *     throw error;
 *   }
 *   ```
 *
 * @throws {BadRequestError} when choice matches multiple brains (ambiguous)
 */
```

**changes to error throw sites:**
1. `genContextBrain.ts:79-83` â€” repl not found
2. `genContextBrain.ts:91-95` â€” atom not found
3. `genContextBrain.ts:108-116` â€” generic choice not found

**each site updated to:**
```ts
throw new BrainChoiceNotFoundError(
  `{type} brain not found: ${choiceSlug}\n\n${formatAvailableBrains({ atoms, repls, choice: choiceSlug })}`,
  { choice: input.choice, available: { ... } },
);
```

**preserves:**
- metadata structure (choice, available)
- message prefix pattern

**changes:**
- error type from `BadRequestError` to `BrainChoiceNotFoundError`

---

## dependency addition

### `fastest-levenshtein`

- **why:** sort available brains by similarity to requested choice
- **size:** ~1kb minified, zero dependencies
- **api:** `distance(a, b)` returns edit distance as number
- **usage:**
  ```ts
  import { distance } from 'fastest-levenshtein';

  // compute distance once per brain (O(n)), not per comparison (O(n log n))
  const brainsWithDistance = brains.map((brain) => ({
    ...brain,
    distance: distance(brain.slug, choice),
  }));
  brainsWithDistance.sort((a, b) => a.distance - b.distance);
  ```

---

## test coverage

### unit tests: `formatAvailableBrains.test.ts`

| case | description |
|------|-------------|
| [case1] | atoms and repls â†’ formatted with correct symbols |
| [case2] | empty list â†’ shows "no brains available" |
| [case3] | single brain â†’ shows single entry with â””â”€â”€ |
| [case4] | similarity sort â†’ most similar appears first |
| [case5] | exactly 21 brains â†’ all shown, no truncation |
| [case6] | >21 brains â†’ truncated with indicator |
| [case7] | atoms-only list â†’ only â—‹ symbols |
| [case8] | repls-only list â†’ only â†» symbols |
| [case9] | treestruct format â†’ â”œâ”€â”€ for non-last, â””â”€â”€ for last |
| [case10] | 3-space indent under header |
| [case11] | snapshot of formatted output |

### unit tests: `genContextBrain.test.ts` (additions)

| case | description |
|------|-------------|
| [case16] | generic choice not found â†’ message includes available brains |
| [case17] | repl choice not found â†’ message includes available repls |
| [case18] | atom choice not found â†’ message includes available atoms |
| [case19] | error metadata preserved with available brains |
| [case20] | error is instanceof BrainChoiceNotFoundError |
| [case21] | BrainChoiceNotFoundError extends HelpfulError |

### integration tests: (via sdk layer)

the `genContextBrain` function is a pure domain operation with no external boundaries (no filesystem, network, or database access). integration tests are not applicable â€” unit tests provide complete coverage.

### acceptance tests: (via contract layer)

acceptance tests exercise via the sdk export:
- error type is `BrainChoiceNotFoundError`
- error is catchable and message is displayable
- error contains choice in message

---

## implementation order

1. **add dependency**
   - `npm install --save fastest-levenshtein`
   - verify build passes

2. **create BrainChoiceNotFoundError**
   - create `src/domain.objects/BrainChoiceNotFoundError.ts`
   - add export to `src/domain.objects/index.ts`
   - verify sdk exports it

3. **create formatAvailableBrains**
   - write unit tests first (tdd)
   - implement function
   - verify all tests pass

4. **update genContextBrain**
   - update jsdoc with @throws documentation
   - add new test cases for error message format
   - update three error throw sites to use BrainChoiceNotFoundError
   - verify all tests pass

5. **verify full test suite**
   - `npm run test:types`
   - `npm run test:lint`
   - `npm run test:unit`

---

## contracts

### input contract: `formatAvailableBrains`

```ts
input: {
  atoms: BrainAtom[];  // array of atom brains (may be empty)
  repls: BrainRepl[];  // array of repl brains (may be empty)
  choice: string;      // the requested choice string (for similarity sort)
}
```

### output contract: `formatAvailableBrains`

```ts
// returns formatted string like:
`ðŸ”­ available brains
   â”œâ”€â”€ â†» anthropic/claude-code
   â”œâ”€â”€ â†» openai/codex
   â”œâ”€â”€ â—‹ openai/gpt-4o-mini
   â””â”€â”€ â—‹ xai/grok-3-fast`

// or for empty:
`ðŸ”­ available brains
   â””â”€â”€ (none)`

// or for truncated (>21):
`ðŸ”­ available brains
   â”œâ”€â”€ â†» anthropic/claude-code
   ...
   â””â”€â”€ â—‹ xai/grok-3-fast
   (and 5 more)`
```

### error contract: `BrainChoiceNotFoundError`

```ts
// thrown by genContextBrain when choice not found
class BrainChoiceNotFoundError extends HelpfulError {
  message: string;  // includes formatted available brains for stderr display
  metadata: {
    choice: string | { repl: string } | { atom: string };
    available: {
      atoms?: string[];  // full slugs for programmatic access
      repls?: string[];  // full slugs for programmatic access
    };
  };
}
```

### sdk export

```ts
// src/contract/sdk.ts already has:
export * from '@src/domain.objects';

// so BrainChoiceNotFoundError is automatically exported via:
// src/domain.objects/index.ts
export * from './BrainChoiceNotFoundError';

// consumers can import:
import { BrainChoiceNotFoundError } from 'rhachet';
```

---

## edge cases

| edge case | behavior |
|-----------|----------|
| empty atoms and repls | shows "(none)" under header |
| single brain | uses â””â”€â”€ connector (last item) |
| exactly 21 brains | all shown, no truncation indicator |
| 22+ brains | first 21 shown + "(and N more)" |
| typo in choice | most similar brain appears first |
| choice with no similar matches | alphabetical fallback (distance tie) |

---

## readability considerations

1. **BrainChoiceNotFoundError is semantic** â€” clear purpose vs generic BadRequestError
2. **formatAvailableBrains is pure** â€” easy to test, easy to understand
3. **single responsibility** â€” format function separate from error throw logic
4. **treestruct pattern reused** â€” consistent with invokeList and bootRoleResources
5. **constants extracted** â€” MAX_BRAINS_SHOWN = 21, symbols = { atom: 'â—‹', repl: 'â†»' }
6. **early returns** â€” handle empty case first, then main logic
7. **jsdoc documents throws** â€” consumers know to catch for stderr display

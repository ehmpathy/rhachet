# roadmap: gen-context-choice-help

## overview

execution roadmap to implement the blueprint specified in `3.3.blueprint.v1.i1.md`.

each phase includes:
- [ ] checklist items with ordered dependencies
- behavioral acceptance criteria
- verification commands

---

## phase 0: preparation

### briefs to read
- `0.wish.md` â€” understand the motivation
- `1.vision.md` â€” understand the target output format
- `2.criteria.blackbox.md` â€” understand all acceptance criteria
- `3.3.blueprint.v1.i1.md` â€” understand the implementation plan

### checklist

- [ ] **0.1** read all briefs listed above
- [ ] **0.2** verify current test suite passes

### acceptance criteria

```
given('preparation complete')
  when('npm run test:types && npm run test:lint && npm run test:unit')
    then('all tests pass')
```

### verification

```sh
npm run test:types && npm run test:lint && npm run test:unit
```

---

## phase 1: add dependency

### briefs to read
- `3.3.blueprint.v1.i1.md` â€” section "dependency addition"

### checklist

- [ ] **1.1** install `fastest-levenshtein` as production dependency
- [ ] **1.2** verify build passes after install

### acceptance criteria

```
given('fastest-levenshtein installed')
  when('npm run build')
    then('build succeeds')
  when('import { distance } from "fastest-levenshtein"')
    then('import resolves without error')
```

### verification

```sh
npm install --save fastest-levenshtein
npm run build
```

---

## phase 2: create BrainChoiceNotFoundError

### briefs to read
- `3.3.blueprint.v1.i1.md` â€” section "new domain object: BrainChoiceNotFoundError"
- `3.1.research.patterns._.code.prod.v1.i1.md` â€” pattern.5 (error metadata pattern)

### checklist

- [ ] **2.1** create `src/domain.objects/BrainChoiceNotFoundError.ts`
  - extends `HelpfulError` (no custom constructor)
  - includes jsdoc with `.what`, `.why`, and `@example`
- [ ] **2.2** export from `src/domain.objects/index.ts`
- [ ] **2.3** verify sdk exports the error class

### acceptance criteria

```
given('BrainChoiceNotFoundError created')
  when('imported from "rhachet"')
    then('BrainChoiceNotFoundError is defined')
  when('new BrainChoiceNotFoundError(message, metadata) is instantiated')
    then('error.message equals message')
    then('error instanceof HelpfulError')
  when('npm run test:types')
    then('no type errors')
```

### verification

```sh
npm run test:types
# manual verification: check sdk.ts re-exports from domain.objects
```

---

## phase 3: create formatAvailableBrains

### briefs to read
- `3.3.blueprint.v1.i1.md` â€” section "new operation: formatAvailableBrains"
- `3.1.research.patterns._.code.test.v1.i1.md` â€” all patterns (test fixtures, given/when/then, snapshots)
- `3.1.research.patterns._.code.prod.v1.i1.md` â€” pattern.3, pattern.4 (treestruct format)
- `1.vision.md` â€” exact output format to match

### checklist

- [ ] **3.1** create `src/domain.operations/context/formatAvailableBrains.test.ts`
  - [case1] atoms and repls â†’ formatted with correct symbols
  - [case2] empty list â†’ shows "(none)"
  - [case3] single brain â†’ shows single entry with â””â”€â”€
  - [case4] similarity sort â†’ most similar appears first
  - [case5] exactly 21 brains â†’ all shown, no truncation
  - [case6] >21 brains â†’ truncated with "(and N more)" indicator
  - [case7] atoms-only list â†’ only â—‹ symbols
  - [case8] repls-only list â†’ only â†» symbols
  - [case9] treestruct format â†’ â”œâ”€â”€ for non-last, â””â”€â”€ for last
  - [case10] 3-space indent under header
  - [case11] snapshot of formatted output
- [ ] **3.2** create `src/domain.operations/context/formatAvailableBrains.ts`
  - pure function, deterministic output
  - precompute levenshtein distances once (O(n))
  - sort by precomputed distance
  - truncate to 21 max
  - format as treestruct with ðŸ”­ header
- [ ] **3.3** verify all unit tests pass

### acceptance criteria

```
given('formatAvailableBrains implemented')
  when('called with atoms and repls')
    then('output matches vision format exactly')
      # ðŸ”­ available brains
      #    â”œâ”€â”€ â†» anthropic/claude-code
      #    â””â”€â”€ â—‹ xai/grok-3-fast
  when('called with typo choice "antrhopic/cloude-code"')
    then('anthropic/claude-code appears first (most similar)')
  when('called with >21 brains')
    then('only 21 shown')
    then('output includes "(and N more)"')
  when('called with empty atoms and repls')
    then('output shows "(none)"')
```

### verification

```sh
npm run test:unit -- formatAvailableBrains.test.ts
```

---

## phase 4: update genContextBrain

### briefs to read
- `3.3.blueprint.v1.i1.md` â€” section "update operation: genContextBrain"
- `3.1.research.patterns._.code.test.v1.i1.md` â€” pattern.4 (getError), pattern.6 (error assertions)
- `3.1.research.patterns._.code.prod.v1.i1.md` â€” pattern.1 (error throw sites)
- `2.criteria.blackbox.md` â€” all usecases and edge cases

### checklist

- [ ] **4.1** update jsdoc with `@throws {BrainChoiceNotFoundError}` documentation
  - include example of how to catch and display via stderr
- [ ] **4.2** add new test cases to `genContextBrain.test.ts`
  - [case16] generic choice not found â†’ message includes available brains
  - [case17] repl choice not found â†’ message includes available repls
  - [case18] atom choice not found â†’ message includes available atoms
  - [case19] error metadata preserved with available brains
  - [case20] error is instanceof BrainChoiceNotFoundError
  - [case21] BrainChoiceNotFoundError extends HelpfulError
- [ ] **4.3** update error throw site at line ~79-83 (repl not found)
  - change `BadRequestError` â†’ `BrainChoiceNotFoundError`
  - add `formatAvailableBrains({ atoms: [], repls, choice })` to message
- [ ] **4.4** update error throw site at line ~91-95 (atom not found)
  - change `BadRequestError` â†’ `BrainChoiceNotFoundError`
  - add `formatAvailableBrains({ atoms, repls: [], choice })` to message
- [ ] **4.5** update error throw site at line ~108-116 (generic not found)
  - change `BadRequestError` â†’ `BrainChoiceNotFoundError`
  - add `formatAvailableBrains({ atoms, repls, choice })` to message
- [ ] **4.6** verify all unit tests pass

### acceptance criteria

```
given('genContextBrain updated')
  when('choice does not match any brain')
    then('throws BrainChoiceNotFoundError')
    then('error.message includes requested brain name')
    then('error.message includes formatted available brains list')
    then('error.metadata.choice equals input choice')
    then('error.metadata.available contains atoms and repls arrays')
  when('choice is { repl: string } and repl not found')
    then('available list shows only repls')
  when('choice is { atom: string } and atom not found')
    then('available list shows only atoms')
  when('typo in choice')
    then('most similar brain appears first in list')
```

### verification

```sh
npm run test:unit -- genContextBrain.test.ts
```

---

## phase 5: verify full test suite

### briefs to read
- `2.criteria.blackbox.md` â€” verify all criteria covered

### checklist

- [ ] **5.1** run type checks
- [ ] **5.2** run lint checks
- [ ] **5.3** run all unit tests
- [ ] **5.4** verify criteria coverage (manual review)

### acceptance criteria

```
given('implementation complete')
  when('npm run test:types')
    then('no type errors')
  when('npm run test:lint')
    then('no lint errors')
  when('npm run test:unit')
    then('all tests pass')
  when('criteria reviewed')
    then('usecase.1 covered by genContextBrain tests')
    then('usecase.2 covered by formatAvailableBrains tests')
    then('usecase.3 covered by formatAvailableBrains tests')
    then('usecase.4 covered by genContextBrain tests')
    then('edge.1 covered by formatAvailableBrains tests')
    then('edge.2 covered by formatAvailableBrains tests')
    then('edge.3 covered by formatAvailableBrains tests')
```

### verification

```sh
npm run test:types
npm run test:lint
npm run test:unit
```

---

## phase 6: update snapshots (if needed)

### checklist

- [ ] **6.1** review any snapshot changes
- [ ] **6.2** update snapshots if output is correct

### verification

```sh
RESNAP=true npm run test:unit -- formatAvailableBrains.test.ts
```

---

## dependency graph

```
phase 0 (preparation)
    â”‚
    v
phase 1 (add dependency)
    â”‚
    v
phase 2 (create BrainChoiceNotFoundError)
    â”‚
    v
phase 3 (create formatAvailableBrains)
    â”‚
    v
phase 4 (update genContextBrain)
    â”‚
    v
phase 5 (verify full test suite)
    â”‚
    v
phase 6 (update snapshots)
```

---

## criteria coverage matrix

| criteria | covered by |
|----------|------------|
| usecase.1 (helpful error message) | phase 4: genContextBrain tests |
| usecase.2 (similarity sort) | phase 3: formatAvailableBrains tests |
| usecase.3 (treestruct format) | phase 3: formatAvailableBrains tests |
| usecase.4 (metadata preserved) | phase 4: genContextBrain tests |
| edge.1 (empty registry) | phase 3: formatAvailableBrains [case2] |
| edge.2 (single brain) | phase 3: formatAvailableBrains [case3] |
| edge.3 (>21 brains) | phase 3: formatAvailableBrains [case6] |

---

## note: criteria update needed

`2.criteria.blackbox.md` usecase.4 says:
> then('error is still instanceof BadRequestError')

this should be updated to:
> then('error is instanceof BrainChoiceNotFoundError')
> then('BrainChoiceNotFoundError extends HelpfulError')

the blueprint changed the error type from `BadRequestError` to `BrainChoiceNotFoundError` for semantic clarity and to enable downstream consumers to catch specifically.

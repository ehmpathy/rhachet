# roadmap: graceful skill errors

## phase 0: setup

- [ ] read `.behavior/v2026_02_22.graceful-skill-errors/3.3.blueprint.v1.i1.md`
- [ ] read `.behavior/v2026_02_22.graceful-skill-errors/2.1.criteria.blackbox.md`
- [ ] verify extant tests pass: `npm run test:integration`

**verification**: all extant tests green

---

## phase 1: buffer stderr in executeSkill.ts

**read first**:
- `src/domain.operations/invoke/executeSkill.ts`
- `src/domain.operations/invoke/executeSkill.integration.test.ts`

**tasks**:
- [ ] change `stdio` to buffer stderr: `'pipe'` instead of `process.stderr`
- [ ] add `stderr` property to `SkillExecutionError` constructor
- [ ] include `result.stderr` in thrown error

**acceptance criteria**:
- `SkillExecutionError` contains `stderr` property with captured output
- exit code is preserved

**verification**:
```bash
npm run test:integration -- executeSkill
```

---

## phase 2: update invokeRun.ts error handler

**read first**:
- `src/contract/cli/invokeRun.ts`
- `.behavior/v2026_02_22.graceful-skill-errors/1.vision.md` (output format)

**tasks**:
- [ ] in catch block: print skill identifier to stderr
- [ ] in catch block: print status line based on exit code
  - exit 2: `   â””â”€ âœ‹ blocked by constraints`
  - else: `   â””â”€ ğŸ’¥ failed with an error`
- [ ] in catch block: print captured `error.stderr`
- [ ] remove old `console.error(\nâ›ˆï¸ ${error.message})`

**acceptance criteria**:
- on exit 2: stderr shows header â†’ `âœ‹ blocked` â†’ skill output
- on exit 1: stderr shows header â†’ `ğŸ’¥ failed` â†’ skill output
- no JSON in stderr

**verification**:
```bash
# manual test â€” should show clean output, no JSON
npx rhachet run --skill say-hello  # success case
# create a skill that exits 2 and verify output format
# create a skill that exits 1 and verify output format
```

---

## phase 3: apply same pattern to init error handler

**tasks**:
- [ ] update `performRunViaInitMode` catch block with same pattern
- [ ] print init identifier to stderr on error
- [ ] print status line based on exit code
- [ ] print captured stderr

**acceptance criteria**:
- init errors show same clean format as skill errors

**verification**:
```bash
# manual test with an init that fails
```

---

## phase 4: add integration tests with snapshots

**read first**:
- `.behavior/v2026_02_22.graceful-skill-errors/2.1.criteria.blackbox.md`
- extant test patterns in `src/domain.operations/invoke/executeSkill.integration.test.ts`

**tasks**:
- [ ] add test: skill exits 0 â†’ no error
- [ ] add test: skill exits 2 â†’ error.stderr captured, exitCode 2
- [ ] add test: skill exits 1 â†’ error.stderr captured, exitCode 1
- [ ] add CLI output test: exit 2 â†’ snapshot + order assertions
- [ ] add CLI output test: exit 1 â†’ snapshot + order assertions

**acceptance criteria**:
- snapshots capture exact output format
- explicit assertions verify: header â†’ status â†’ skill stderr order
- explicit assertions verify: no JSON in output

**verification**:
```bash
npm run test:integration -- executeSkill
npm run test:integration -- invokeRun  # or new test file
```

---

## phase 5: add acceptance tests

**read first**:
- `.behavior/v2026_02_22.graceful-skill-errors/2.1.criteria.blackbox.md`

**tasks**:
- [ ] create `accept.blackbox/cli/run.graceful-errors.acceptance.test.ts`
- [ ] add fixture skills: one that exits 0, one that exits 2, one that exits 1
- [ ] add test: exit 0 â†’ stdout contains skill identifier
- [ ] add test: exit 2 â†’ stderr snapshot + order + no JSON
- [ ] add test: exit 1 â†’ stderr snapshot + order + no JSON

**acceptance criteria**:
- blackbox tests invoke CLI binary
- verify observable output matches vision

**verification**:
```bash
npm run test:acceptance
```

---

## phase 6: final verification

- [ ] all tests pass: `npm run test`
- [ ] manual test: `npx rhachet run --skill git.commit.set -m 'test'` without quota
  - shows `âœ‹ blocked by constraints`
  - shows skill stderr output
  - no JSON
- [ ] manual test: create skill that exits 1
  - shows `ğŸ’¥ failed with an error`
  - shows skill stderr output
  - no JSON

**done when**: all checkboxes complete, all tests green, manual verification passes

# blackbox criteria: rhx autocomplete

## usecase.1 = tab completion

### episode: complete partial skill name

```
given(user has zsh with rhx completion loaded)
given(user is in a repo with .agent/ skills)

  when(user types `rhx git.<tab>`)
    then(zsh shows all skills that start with "git.")
      sothat(user discovers available git skills without docs lookup)

  when(user types `rhx git.commit.<tab>`)
    then(zsh completes to longest common prefix or shows options)
      sothat(user narrows down to exact skill name)

  when(user types `rhx git.commit.s<tab>`)
    then(zsh shows: git.commit.set, git.commit.uses)
      sothat(user picks the right one)

  when(user types `rhx nonexistent<tab>`)
    then(zsh shows no completion)
      sothat(user knows no match found)
```

### episode: cwd-aware completion

```
given(user has two repos: repoA and repoB)
given(repoA has skill "deploy.prod")
given(repoB has skill "deploy.dev")

  when(user is in repoA and types `rhx deploy.<tab>`)
    then(zsh shows "deploy.prod" only)
      sothat(completion reflect current repo's skills)

  when(user cd's to repoB and types `rhx deploy.<tab>`)
    then(zsh shows "deploy.dev" only)
      sothat(completion update per repo)
```

---

## usecase.2 = rhx list

### episode: list all skills

```
given(user is in a repo with .agent/ skills)

  when(user runs `rhx list`)
    then(output shows tree of skills grouped by repo/role)
    then(each skill shows name and .what description)
      sothat(user sees all available skills at a glance)

  when(user runs `rhx list --repo .this`)
    then(output shows only skills from repo=.this)
      sothat(user filters to native repo skills)

  when(user runs `rhx list --role mechanic`)
    then(output shows only skills from role=mechanic)
      sothat(user filters to specific role)

  when(user runs `rhx list --output json`)
    then(output is valid JSON array of skills)
      sothat(user can pipe to jq or other tools)
```

### episode: no skills found

```
given(user is in a repo with no .agent/ directory)

  when(user runs `rhx list`)
    then(output shows friendly message: "no skills found in .agent/")
    then(exit code is 0)
      sothat(user knows the command worked but found no skills)
```

---

## usecase.3 = rhx search

### episode: search skills by keyword

```
given(user is in a repo with skills)
given(skill "git.commit.set" has .what = "create git commit")

  when(user runs `rhx search commit`)
    then(output shows skills with "commit" in name or description)
      sothat(user finds relevant skills by keyword)

  when(user runs `rhx search nonexistent`)
    then(output shows "no matches for 'nonexistent'")
    then(exit code is 0)
      sothat(user knows search worked but found no results)
```

### episode: no skills found

```
given(user is in a repo with no .agent/ directory)

  when(user runs `rhx search commit`)
    then(output shows friendly message: "no skills found in .agent/")
    then(exit code is 0)
      sothat(user knows the command worked but found no skills)
```

---

## usecase.4 = rhachet completion

### episode: generate completion code

```
given(user wants to set up tab completion)

  when(user runs `rhachet completion`)
    then(output is valid zsh completion code)
    then(code uses dynamic completion via `rhachet completion --list`)
      sothat(user can add to ~/.zshrc or use --setup)
```

### episode: dynamic completion is cwd-aware

```
given(user has completion set up via --setup)
given(new skills were added to .agent/)

  when(user types `rhx <tab>`)
    then(`rhachet completion --list` runs dynamically)
    then(fresh skills are shown from current .agent/)
      sothat(new skills appear in tab completion without refresh)
```

---

## usecase.5 = first-time setup

### episode: install completion via --setup

```
given(user has zsh as shell ($SHELL contains "zsh"))
given(user has not set up rhx completion)

  when(user runs `rhachet completion --setup`)
    then(completion code is written to ~/.zshrc)
    then(output shows "completion installed to ~/.zshrc")
    then(output shows "run: source ~/.zshrc")
      sothat(setup is one command)

  when(user runs `source ~/.zshrc`)
    then(tab completion works for rhx commands)
```

### episode: install completion via redirect

```
given(user has zsh as shell)

  when(user runs `rhx completion >> ~/.zshrc`)
    then(completion code is appended to ~/.zshrc)
      sothat(user has manual control over installation)

  when(user runs `source ~/.zshrc`)
    then(tab completion works for rhx commands)
```

### episode: --setup is idempotent

```
given(user has already run `rhachet completion --setup`)

  when(user runs `rhachet completion --setup` again)
    then(output shows "completion already installed in ~/.zshrc")
    then(~/.zshrc is not modified)
      sothat(no duplicate completion code)
```

### episode: --setup requires global install

```
given(rhachet is not in PATH)

  when(user runs `rhachet completion --setup`)
    then(error: "rhachet not found in PATH. install globally first: npm install -g rhachet")
      sothat(user knows to install globally before setup)
```

### episode: --setup detects shell from $SHELL

```
given($SHELL is /bin/bash)

  when(user runs `rhachet completion --setup`)
    then(error: "unsupported shell: /bin/bash. supported: zsh")
      sothat(user knows bash is not yet supported)

given($SHELL is /usr/local/bin/fish)

  when(user runs `rhachet completion --setup`)
    then(error: "unsupported shell: /usr/local/bin/fish. supported: zsh")
      sothat(user knows fish is not yet supported)
```

---

## exchange contracts

### `rhx list`

| input | output |
|-------|--------|
| (no args) | tree of all skills with descriptions |
| `--repo <slug>` | filtered to repo |
| `--role <slug>` | filtered to role |
| `--output tree` | tree format (default) |
| `--output flat` | flat list, one per line |
| `--output json` | JSON array |

### `rhx search`

| input | output |
|-------|--------|
| `<query>` | matched skills (by name or .what description) |
| `--output tree` | grouped output (default) |
| `--output flat` | flat list, one per line |
| `--output json` | JSON array |

### `rhachet completion`

| input | output |
|-------|--------|
| (no flags) | completion code to stdout (for `>> ~/.zshrc`) |
| `--setup` | writes completion code to rc file (detects shell from $SHELL) |
| `--list` | name:description lines for dynamic completion |

### tab completion (zsh)

| input | output |
|-------|--------|
| `rhx <partial><tab>` | matched skill names |
| `rhx <partial><tab><tab>` | list all matches |
| `rhachet run --skill <partial><tab>` | same as above |

---

## error cases

| scenario | behavior |
|----------|----------|
| not in a repo (no .agent/) | "no skills found in .agent/" |
| invalid --output value | error with valid options |
| search with empty query | show all skills |
| `completion --setup` without global rhachet | error: "rhachet not found in PATH" |
| `completion --setup` with unsupported shell | error: "unsupported shell" |

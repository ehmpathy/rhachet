# blueprint v1.i1 self-review: gap report

## review date: 2026-02-26

---

## gap.1 — cwd-aware completions not implemented

### criteria says

```
given(user has two repos: repoA and repoB)
given(repoA has skill "deploy.prod")
given(repoB has skill "deploy.dev")

  when(user is in repoA and types `rhx deploy.<tab>`)
    then(zsh shows "deploy.prod" only)

  when(user cd's to repoB and types `rhx deploy.<tab>`)
    then(zsh shows "deploy.dev" only)
      sothat(completions update per repo)
```

### blueprint provides

static completions generated at shell init time:

```zsh
_rhachet_skills=(
    'git.commit.set:create git commit'
    ...
)

_rhx() {
  _describe 'skill' _rhachet_skills
}
```

### gap

when user `cd`s to different repo, completions don't update. the `_rhachet_skills` array is frozen at shell init.

### fix options

**option A: dynamic completion (recommended for v1)**

```zsh
_rhx() {
  local completions
  completions=("${(@f)$(rhachet completion --list 2>/dev/null)}")
  _describe 'skill' completions
}
```

this runs `rhachet completion --list` on each tab press. slower (~35ms with bun binary) but ensures cwd-awareness.

**option B: accept limitation for v1**

document that completions are per-terminal-session. user must open new terminal or run `source ~/.zshrc` when repos switch.

### recommendation

implement option A (dynamic completion) since cwd-awareness is explicitly in criteria. add `rhachet completion --list` which outputs just skill names (one per line) for fast parse.

---

## gap.2 — `npx rhachet init` cache refresh not addressed

### criteria says

```
given(user has completions set up)
given(new skills were added to .agent/)

  when(user runs `npx rhachet init`)
    then(completion cache is refreshed for current repo)
      sothat(new skills appear in tab completion)
```

### blueprint provides

no mention of update to `rhachet init` to interact with completions.

### gap

if dynamic completion (gap.1 option A) is used, this is N/A — completions are always fresh.

if static completion is used, need a way to refresh without new terminal.

### fix

if we implement gap.1 option A (dynamic), this gap is resolved — no cache to refresh.

if we keep static, add `rhachet completion --refresh` that updates a cache file.

### recommendation

with dynamic completion, this gap is resolved automatically.

---

## gap.3 — `rhx completion` alias not implemented

### vision shows

```sh
rhachet completion --setup
```

### blueprint implements

```sh
rhachet completion --setup
```

### gap

vision shows `rhx completion` but blueprint only implements `rhachet completion`.

### fix

update `bin/rhx` to also handle `completions` subcommand:

```sh
case "$1" in
  completions)
    shift
    exec "$SCRIPT_DIR/run" completions "$@"
    ;;
  list)
    ...
```

### recommendation

add `rhx completion` as alias to `rhachet completion` for consistency with vision.

---

## summary

| gap | severity | fix effort | recommendation |
|-----|----------|------------|----------------|
| gap.1: cwd-aware completions | high | medium | implement dynamic completion |
| gap.2: init cache refresh | low | low | resolved by dynamic completion |
| gap.3: rhx completion alias | low | trivial | add case to bin/rhx |
| gap.4: completions jit slow | high | low | route to bun binary |

---

---

## gap.4 — completions routed to jit (slow)

### issue

the blueprint routes `completions` to jit path:

```
bin/run:
  [~] add case "completions":
      exec "$SCRIPT_DIR/run.jit" "$@"
```

jit takes ~300ms+. for dynamic completion on each tab press, this is too slow.

### performance requirement

per `bin.dispatcher.pattern.md`:
- `run --skill` (bun): ~35ms
- `roles boot` (bun): ~70ms
- `roles link` (jit): ~300ms+

dynamic tab completion needs ~70ms or less to feel responsive.

### fix

`completions --list` only reads from `.agent/` (like `roles boot`), so it can use the same bun path:

```
bin/run:
  [~] add case "completions":
      exec "$SCRIPT_DIR/run.bun" "$@"

bin/run.bun:
  [~] add case "completions":
      exec "$SCRIPT_DIR/run.bun.rhachet-roles.bc" "$@"
```

this routes `completions` through `rhachet-roles.bc` — the same binary that handles `roles boot/cost`, since both read from `.agent/` without npm imports.

### recommendation

route `completions` to `rhachet-roles.bc` (via `run.bun`) for fast dynamic completion.

---

## next steps

1. ✅ update blueprint to use dynamic completion approach (gap.39)
2. ✅ add `rhachet completion --list` output mode (gap.39)
3. ✅ add `rhx completion` case to bin/rhx (gap.40)
4. ✅ update integration tests for cwd-awareness (gap.39)
5. ✅ route `completions` to bun for fast execution (gap.41)

all gaps addressed in blueprint v1.i1.

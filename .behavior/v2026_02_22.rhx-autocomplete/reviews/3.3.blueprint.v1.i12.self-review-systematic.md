# blueprint v1 systematic self-review

## review date: 2026-02-26

this document provides a systematic, line-by-line verification of criteria and vision coverage.

---

## methodology

1. read each criteria statement
2. locate the blueprint mechanism that addresses it
3. verify the mechanism is complete and correct
4. mark as covered or identify gaps

---

## usecase.1 = tab completion

### episode: complete partial skill name (lines 7-26 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 11 | `rhx git.<tab>` shows all skills that start with "git." | `_rhx()` calls `rhachet completion --list`, zsh `_describe` handles prefix filter | genZshCompletionCode lines 500-510 | ✅ |
| 15-16 | `rhx git.commit.<tab>` completes to longest common prefix | zsh native `_describe` behavior | zsh handles this | ✅ |
| 19-20 | `rhx git.commit.s<tab>` shows git.commit.set, git.commit.uses | zsh native `_describe` filters by prefix | zsh handles this | ✅ |
| 23-24 | `rhx nonexistent<tab>` shows no completions | zsh `_describe` returns empty when no match | zsh handles this | ✅ |

### episode: cwd-aware completions (lines 28-42 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 35-36 | in repoA, shows "deploy.prod" only | dynamic completion via `rhachet completion --list` runs in cwd | invokeCompletions lines 291-299 | ✅ |
| 39-40 | cd to repoB, shows "deploy.dev" only | dynamic runs fresh on each tab press | genZshCompletionCode line 506 | ✅ |

**acceptance test coverage**: completions.acceptance.test.ts lines 963-994 test cwd-aware behavior with `with-skill-a` and `with-skill-b` fixtures.

---

## usecase.2 = rhx list

### episode: list all skills (lines 50-69 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 53-54 | tree of skills grouped by repo/role | `formatAsTree` with `getGroupKey: repo=${slugRepo}/role=${slugRole}` | formatSkillList lines 803-809 | ✅ |
| 55 | each skill shows name and .what | `getAllSkillsWithEntries` calls `getSkillWhatLine` | getAllSkillsWithEntries lines 478-484 | ✅ |
| 58-59 | `--repo .this` filters to repo=.this | `discoverSkillExecutables({ slugRepo: opts.repo })` | invokeSkillsSubcommand lines 337-340 | ✅ |
| 62-63 | `--role mechanic` filters to role=mechanic | `discoverSkillExecutables({ slugRole: opts.role })` | invokeSkillsSubcommand lines 337-340 | ✅ |
| 66-67 | `--output json` produces valid JSON | `formatAsJson` | formatSkillList lines 789-798 | ✅ |

### episode: no skills found (lines 71-80 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 76-77 | shows "no skills found in .agent/" | `if (skillsFound.length === 0) console.log(...)` | invokeSkillsSubcommand lines 342-345 | ✅ |
| 78 | exit code is 0 | no throw, returns normally | invokeSkillsSubcommand line 344 | ✅ |

---

## usecase.3 = rhx search

### episode: search by keyword (lines 88-105 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 92-93 | shows skills with "commit" in name or description | `getSkillsMatchedByQuery` checks `slug.includes(query) OR description.includes(query)` | getSkillsMatchedByQuery lines 544-547 | ✅ |
| 94 | shows context snippets | `getBriefsMatchedByQuery` calls `getSnippetFromContent` | getBriefsMatchedByQuery lines 683-685 | ✅ |
| 97-98 | `--scope skills` shows only skills | conditional in action: `scope === 'skills'` | invokeSkillsSubcommand lines 368-373 | ✅ |
| 101-102 | no matches shows "no matches for..." | `console.log('no matches for ...')` | invokeSkillsSubcommand lines 385-387 | ✅ |
| 103 | exit code is 0 | no throw, returns normally | invokeSkillsSubcommand line 387 | ✅ |

---

## usecase.4 = rhachet completion

### episode: generate completion code (lines 113-120 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 116-117 | outputs valid zsh completion code | `genZshCompletionCode()` | genZshCompletionCode lines 497-521 | ✅ |
| 118 | code can be eval'd in zsh | valid zsh syntax with `#compdef`, `_describe` | genZshCompletionCode output | ✅ |

### episode: cache refresh (lines 122-136 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 128-129 | `npx rhachet init` refreshes cache | N/A - dynamic completion has no cache | overview line 7 | ✅ |
| 132-134 | `source ~/.zshrc` re-evals fresh completions | dynamic completion via `--list` on each tab | genZshCompletionCode lines 498-499 | ✅ |

---

## usecase.5 = first-time setup

### episode: install completions (lines 144-152 of criteria)

| line | criteria statement | blueprint mechanism | location | status |
|------|-------------------|---------------------|----------|--------|
| 148-150 | `rhachet completion --setup` enables tab completion | `genZshCompletionCode` outputs completion code | genZshCompletionCode lines 500-520 | ✅ |
| 151 | setup is one-liner | single `rhachet completion --setup` command | vision line 189 | ✅ |

---

## exchange contracts (lines 156-193 of criteria)

### rhx list (lines 158-167)

| input | output expected | blueprint mechanism | status |
|-------|-----------------|---------------------|--------|
| (no args) | tree of all skills | `formatAsTree` default | ✅ |
| `--repo <slug>` | filtered to repo | `discoverSkillExecutables({ slugRepo })` | ✅ |
| `--role <slug>` | filtered to role | `discoverSkillExecutables({ slugRole })` | ✅ |
| `--output tree` | tree format | `formatAsTree` | ✅ |
| `--output flat` | flat list | `formatAsFlat` | ✅ |
| `--output json` | JSON array | `formatAsJson` | ✅ |

### rhx search (lines 169-178)

| input | output expected | blueprint mechanism | status |
|-------|-----------------|---------------------|--------|
| `<query>` | skills and briefs | `getSkillsMatchedByQuery` + `getBriefsMatchedByQuery` | ✅ |
| `--scope skills` | skills only | conditional in action | ✅ |
| `--scope briefs` | briefs only | conditional in action | ✅ |
| `--scope all` | both (default) | default scope | ✅ |
| `--output tree` | grouped output | `formatSearchResults` tree mode | ✅ |
| `--output json` | JSON array | `formatSearchResults` json mode | ✅ |

### rhachet completion (lines 180-184)

| input | output expected | blueprint mechanism | status |
|-------|-----------------|---------------------|--------|
| `zsh` | zsh completion code | `genZshCompletionCode()` | ✅ |

### tab completion zsh (lines 186-192)

| input | output expected | blueprint mechanism | status |
|-------|-----------------|---------------------|--------|
| `rhx <partial><tab>` | skill names | `_rhx()` via `_describe` | ✅ |
| `rhx <partial><tab><tab>` | list all matches | zsh native behavior | ✅ |
| `rhachet run --skill <partial><tab>` | skill names | `_rhachet_run_skill()` | ✅ |

---

## error cases (lines 196-203 of criteria)

| scenario | expected behavior | blueprint mechanism | status |
|----------|------------------|---------------------|--------|
| not in a repo (no .agent/) | "no skills found in .agent/" | invokeSkillsSubcommand line 343 | ✅ |
| invalid --output value | error with valid options | `assertValidOption` lines 407-418 | ✅ |
| invalid --scope value | error with valid options | `assertValidOption` lines 407-418 | ✅ |
| search with empty query | show all | `if (!input.query.trim()) return input.items` | ✅ |

---

## vision coverage

| vision item | criteria reference | blueprint location | status |
|-------------|-------------------|-------------------|--------|
| `rhx list` tree output | usecase 1 in vision (lines 56-82) | formatAsTree, formatSkillList | ✅ |
| `rhx search` with snippets | usecase 2 in vision (lines 83-102) | getSkillsMatchedByQuery, getBriefsMatchedByQuery | ✅ |
| tab completion | usecase 3 in vision (lines 104-117) | genZshCompletionCode | ✅ |
| interactive fuzzy search | usecase 4 in vision (lines 118-131) | NOT INCLUDED | ⏭️ stretch |
| cwd-aware completions | awkward bit 1 in vision (lines 275-278) | dynamic completion via --list | ✅ |
| `rhachet completion --setup` | vision line 172 | bin/rhx completion case | ✅ |

---

## zsh interface contract verification

the contract between zsh and rhachet is clearly defined:

### input (zsh to rhachet)

| step | mechanism | verification |
|------|-----------|--------------|
| user presses tab | zsh invokes `_rhx()` | genZshCompletionCode line 504 |
| `_rhx()` calls rhachet | `$(rhachet completion --list)` | genZshCompletionCode line 506 |

### output (rhachet to zsh)

| format | example | verification |
|--------|---------|--------------|
| `name:description` per line | `git.commit.set:create git commit` | invokeCompletions lines 295-296 |
| colons in description escaped | `task:run\:stop` | invokeCompletions line 296 `.replace(/:/g, '\\:')` |

### zsh consumption

| mechanism | purpose | verification |
|-----------|---------|--------------|
| `${(@f)$(...)}` | split by newlines | genZshCompletionCode line 506 |
| `_describe 'skill' completions` | consume name:description | genZshCompletionCode line 507 |

---

## acceptance test coverage

### test case 1: zsh interface contract

```
given '[case1] repo with skills'
  when '[t0] rhachet completion'
    then 'exits with status 0'
    then 'outputs #compdef rhx'
    then 'outputs _rhx function'
    then 'calls rhachet completion --list'
    then 'uses _describe for zsh completion'

  when '[t1] rhachet completion --list'
    then 'exits with status 0'
    then 'outputs name:description format'
    then 'includes discovered skills'
```

### test case 2: cwd-aware behavior

```
given '[case2] cwd-aware completions'
  when '[t0] completions in repoA'
    then 'shows skill-a'
    then 'does not show skill-b'

  when '[t1] completions in repoB'
    then 'shows skill-b'
    then 'does not show skill-a'
```

---

## bin route verification

| command | route | binary | performance |
|---------|-------|--------|-------------|
| `rhachet completion` | bin/run → bin/run.bun → rhachet-roles.bc | bun | ~70ms |
| `rhx completion` | bin/rhx → bin/run → bin/run.bun → rhachet-roles.bc | bun | ~70ms |
| `rhx list` | bin/rhx → bin/run → bin/run.jit | jit | ~300ms |
| `rhx search` | bin/rhx → bin/run → bin/run.jit | jit | ~300ms |

note: `completions` routes to bun because it only reads from `.agent/` (same as `roles boot`), no npm imports needed.

---

## gap fixes verification

| gap | description | blueprint location | status |
|-----|-------------|-------------------|--------|
| gap.15 | single validation helper | assertValidOption lines 407-418 | ✅ |
| gap.16/17 | combined SkillWithEntry[] | getAllSkillsWithEntries lines 475-485 | ✅ |
| gap.19 | extracted getAllMdFilesRecursive | getAllMdFilesRecursive lines 559-574 | ✅ |
| gap.20/21 | try/catch error guards | getSkillWhatLine lines 438-443, getBriefsMatchedByQuery lines 670-675 | ✅ |
| gap.30 | flatMap for functional composition | getAllMdFilesRecursive line 564, formatAsTree line 721 | ✅ |
| gap.31 | get verb for operation names | getAllBriefFiles, getSkillsMatchedByQuery, getBriefsMatchedByQuery | ✅ |
| gap.32 | queryLowercased for variable name | getSkillsMatchedByQuery line 542, getBriefsMatchedByQuery line 663 | ✅ |
| gap.33 | pathMatched/contentMatched for variable names | getBriefsMatchedByQuery lines 677-678 | ✅ |
| gap.34 | .why on type declarations | types.ts lines 227-269 | ✅ |
| gap.35 | format verb exception documented | formatAsFlat line 741, formatAsJson line 755 | ✅ |
| gap.36 | flatMap in getAllBriefFiles | getAllBriefFiles lines 597, 604 | ✅ |
| gap.37 | functional composition in formatSearchResults | formatSearchResults lines 846-867 | ✅ |
| gap.38 | let mutation comments | getSkillWhatLine line 437, getBriefsMatchedByQuery line 669 | ✅ |
| gap.39 | cwd-aware dynamic completion | genZshCompletionCode lines 498-499, 506 | ✅ |
| gap.40 | rhx completion alias | bin/rhx lines 195-198 | ✅ |
| gap.41 | fast completions via rhachet-roles.bc | bin/run.bun lines 188-191 | ✅ |

---

## conclusion

all criteria and vision items are covered:

- ✅ usecase.1: tab completion (4 scenarios + cwd-aware episode)
- ✅ usecase.2: rhx list (5 scenarios + no skills episode)
- ✅ usecase.3: rhx search (4 scenarios)
- ✅ usecase.4: rhachet completion (2 episodes)
- ✅ usecase.5: first-time setup (1 episode)
- ✅ 6 exchange contracts fully specified
- ✅ 4 error cases handled
- ✅ zsh interface contract clearly defined
- ✅ acceptance tests for contract and cwd-awareness
- ✅ 17 gap fixes applied
- ✅ correct bun binary route (rhachet-roles.bc)
- ⏭️ interactive fuzzy search (stretch goal, not included)

the blueprint is ready for implementation.

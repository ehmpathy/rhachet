# blueprint v1 detailed line-by-line review (iteration 15)

## review summary

| check | result |
|-------|--------|
| criteria coverage | complete |
| vision coverage | complete |
| exchange contracts | complete |
| error cases | complete |
| code practices | verified |

**gaps found**: none detected
**blockers**: none detected
**nitpicks**: none detected

---

## methodology

this review verifies the blueprint against criteria and vision by:
1. reading each criteria line number
2. locating the exact blueprint mechanism
3. verifying completeness and correctness

---

## criteria verification by line number

### usecase.1 = tab completion (criteria lines 1-42)

| criteria line | requirement | blueprint mechanism | location |
|---------------|-------------|---------------------|----------|
| 11-12 | `rhx git.<tab>` shows skills starting with "git." | `_rhx()` calls `rhachet completion --list`, zsh `_describe` handles prefix | genZshCompletionCode lines 500-510 |
| 15-16 | `rhx git.commit.<tab>` completes to longest common prefix | zsh native `_describe` behavior | zsh handles this |
| 19-20 | `rhx git.commit.s<tab>` shows options | zsh native `_describe` filters by prefix | zsh handles this |
| 23-24 | `rhx nonexistent<tab>` shows no completions | zsh `_describe` returns empty when no match | zsh handles this |
| 35-36 | cwd-aware: repoA shows "deploy.prod" only | dynamic completion via `rhachet completion --list` runs in cwd | invokeCompletions lines 291-299 |
| 39-40 | cwd-aware: repoB shows "deploy.dev" only | dynamic runs fresh on each tab press | genZshCompletionCode line 506 |

### usecase.2 = rhx list (criteria lines 44-80)

| criteria line | requirement | blueprint mechanism | location |
|---------------|-------------|---------------------|----------|
| 53-54 | tree of skills grouped by repo/role | `formatAsTree` with `getGroupKey: repo=${slugRepo}/role=${slugRole}` | formatSkillList lines 803-809 |
| 55 | each skill shows name and .what | `getAllSkillsWithEntries` calls `getSkillWhatLine` | getAllSkillsWithEntries lines 478-484 |
| 58-59 | `--repo .this` filters to repo | `discoverSkillExecutables({ slugRepo: opts.repo })` | invokeSkillsSubcommand lines 337-340 |
| 62-63 | `--role mechanic` filters to role | `discoverSkillExecutables({ slugRole: opts.role })` | invokeSkillsSubcommand lines 337-340 |
| 66-67 | `--output json` produces valid JSON | `formatAsJson` | formatSkillList lines 789-798 |
| 76-77 | no skills shows "no skills found in .agent/" | `if (skillsFound.length === 0) console.log(...)` | invokeSkillsSubcommand lines 342-345 |
| 78 | exit code is 0 | no throw, returns normally | invokeSkillsSubcommand line 344 |

### usecase.3 = rhx search (criteria lines 82-105)

| criteria line | requirement | blueprint mechanism | location |
|---------------|-------------|---------------------|----------|
| 92-93 | shows skills with "commit" in name or description | `getSkillsMatchedByQuery` checks slug and description | getSkillsMatchedByQuery lines 544-547 |
| 94 | shows context snippets | `getBriefsMatchedByQuery` calls `getSnippetFromContent` | getBriefsMatchedByQuery lines 683-685 |
| 97-98 | `--scope skills` shows only skills | conditional in action | invokeSkillsSubcommand lines 368-373 |
| 101-102 | no matches shows message | `console.log('no matches for ...')` | invokeSkillsSubcommand lines 385-387 |
| 103 | exit code is 0 | no throw, returns normally | invokeSkillsSubcommand line 387 |

### usecase.4 = rhachet completion (criteria lines 107-136)

| criteria line | requirement | blueprint mechanism | location |
|---------------|-------------|---------------------|----------|
| 116-117 | outputs valid zsh completion code | `genZshCompletionCode()` | genZshCompletionCode lines 497-521 |
| 118 | code can be eval'd in zsh | valid zsh syntax with `#compdef`, `_describe` | genZshCompletionCode output |
| 128-129 | `npx rhachet init` refreshes cache | N/A - dynamic completion has no cache | overview line 7 |
| 132-134 | `source ~/.zshrc` re-evals fresh completions | dynamic completion via `--list` on each tab | genZshCompletionCode lines 498-499 |

### usecase.5 = first-time setup (criteria lines 138-152)

| criteria line | requirement | blueprint mechanism | location |
|---------------|-------------|---------------------|----------|
| 148-150 | `rhachet completion --setup` enables completion | `genZshCompletionCode` outputs completion code | genZshCompletionCode lines 500-520 |
| 151 | setup is one-liner | single `rhachet completion --setup` command | vision line 189 |

---

## exchange contracts verification (criteria lines 156-193)

### rhx list (criteria lines 158-167)

| input | expected | blueprint mechanism | verified |
|-------|----------|---------------------|----------|
| (no args) | tree of all skills | `formatAsTree` default | yes |
| `--repo <slug>` | filtered to repo | `discoverSkillExecutables` | yes |
| `--role <slug>` | filtered to role | `discoverSkillExecutables` | yes |
| `--output tree` | tree format | `formatAsTree` | yes |
| `--output flat` | flat list | `formatAsFlat` | yes |
| `--output json` | JSON array | `formatAsJson` | yes |

### rhx search (criteria lines 169-178)

| input | expected | blueprint mechanism | verified |
|-------|----------|---------------------|----------|
| `<query>` | matched skills and briefs | query functions | yes |
| `--scope skills` | skills only | conditional | yes |
| `--scope briefs` | briefs only | conditional | yes |
| `--scope all` | both | default | yes |
| `--output tree` | grouped output | `formatSearchResults` | yes |
| `--output json` | JSON array | `formatSearchResults` | yes |

### rhachet completion (criteria lines 180-184)

| input | expected | blueprint mechanism | verified |
|-------|----------|---------------------|----------|
| `zsh` | zsh completion code | `genZshCompletionCode` | yes |

### tab completion zsh (criteria lines 186-192)

| input | expected | blueprint mechanism | verified |
|-------|----------|---------------------|----------|
| `rhx <partial><tab>` | matched skills | `_rhx` via `_describe` | yes |
| `rhx <partial><tab><tab>` | list all | zsh native | yes |
| `rhachet run --skill <partial><tab>` | matched skills | `_rhachet_run_skill` | yes |

---

## error cases verification (criteria lines 196-203)

| scenario | expected | blueprint mechanism | verified |
|----------|----------|---------------------|----------|
| no .agent/ | "no skills found" | console.log | yes |
| invalid --output | error with options | `assertValidOption` | yes |
| invalid --scope | error with options | `assertValidOption` | yes |
| empty query | show all | return all items | yes |

---

## vision coverage verification

| vision item | criteria reference | blueprint coverage | verified |
|-------------|-------------------|-------------------|----------|
| `rhx list` tree output | usecase 2 lines 53-55 | formatAsTree | yes |
| `rhx search` with snippets | usecase 3 lines 92-94 | getBriefsMatchedByQuery | yes |
| tab completion | usecase 1 lines 11-24 | genZshCompletionCode | yes |
| interactive fuzzy (stretch) | vision lines 118-131 | not included (stretch) | n/a |
| cwd-aware | usecase 1 lines 35-41 | dynamic completion | yes |
| `rhachet completion --setup` | vision line 172 | bin/rhx completion case | yes |
| fast completions | vision line 284 | rhachet-roles.bc route | yes |

---

## code quality verification

| practice | status | evidence |
|----------|--------|----------|
| get verb for operations | verified | getAllSkillsWithEntries, getSkillsMatchedByQuery, getBriefsMatchedByQuery |
| queryLowercased name | verified | line 542, 663 |
| pathMatched/contentMatched | verified | lines 677-678 |
| .why on types | verified | types.ts lines 227-269 |
| flatMap composition | verified | getAllMdFilesRecursive, getAllBriefFiles, formatAsTree |
| try/catch for file reads | verified | getSkillWhatLine, getBriefsMatchedByQuery |
| combined types | verified | SkillWithEntry avoids parallel arrays |
| let mutation documented | verified | gap.38 comments on try/catch patterns |

---

## acceptance test coverage

| test | behavior | verified |
|------|----------|----------|
| zsh interface contract | #compdef, _rhx(), _describe, --list call | yes |
| cwd-aware behavior | repoA vs repoB fixtures | yes |

---

## conclusion

the blueprint is complete and ready for implementation.

all criteria, vision items, exchange contracts, and error cases are covered by explicit mechanisms in the blueprint.

code follows all required practices.

no gaps detected in this review.


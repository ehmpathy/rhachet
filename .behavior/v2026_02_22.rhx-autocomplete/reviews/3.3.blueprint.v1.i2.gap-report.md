# gap report: blueprint v1 iteration 2

## gaps found in reviews

### gap.1 = brief search not implemented (from i1)

**fix applied**: added `discoverBriefFiles` and `filterBriefsByQuery` operations

---

### gap.2 = default search scope incorrect (from i1)

**fix applied**: changed default scope from `'skills'` to `'all'`

---

### gap.3 = `rhachet run --skill <partial><tab>` completion not covered

**criteria**: tab completion (zsh) exchange contracts show:
```
| `rhachet run --skill <partial><tab>` | same as above |
```

**fix applied**: genZshCompletionCode now emits completion for both `rhx` AND `rhachet run --skill`

---

### gap.4 = error validation for invalid --output and --scope values

**criteria**: error cases table shows:
```
| invalid --output value | error with valid options |
| invalid --scope value | error with valid options |
```

**fix applied**: added `assertValidOutputFormat` and `assertValidScope` validation helpers

---

### gap.5 = empty query not handled

**criteria**: error cases table shows:
```
| search with empty query | show all (or prompt for input) |
```

**fix applied**: made query optional `[query]`, empty query now shows all results

---

### gap.6 = `skills` subcommand conflict between invokeSkillList and invokeSkillSearch

**fix applied**: consolidated into single `invokeSkillsSubcommand` that registers both `list` and `search` under one parent

---

### gap.7 = CompletionEntry type never defined

**fix applied**: added `types.ts` with CompletionEntry, SkillMatch, BriefFile, BriefMatch

---

### gap.8 = formatSkillList and formatSearchResults not in filediff

**fix applied**: added to filediff:
- `formatAsTree.ts`
- `formatAsFlat.ts`
- `formatAsJson.ts`
- `formatSkillList.ts`
- `formatSearchResults.ts`

---

### gap.9 = phase.4 execution not updated for brief operations

**fix applied**: phase.4 now includes:
- `discoverBriefFiles.ts` + unit tests
- `filterBriefsByQuery.ts` + unit tests

---

### gap.10 = getAllFilesFromDir helper not defined

**fix applied**: implemented recursive readdir inline in discoverBriefFiles (no external helper needed)

---

### gap.11 = summary file counts incorrect

**fix applied**: updated summary:
- domain.operations: 14 new files
- unit tests: 13 new files
- total: 33 files, ~1470 lines

---

### gap.12 = validation logic should be decomposed

**fix applied**: created shared validation helpers:
- `assertValidOutputFormat.ts`
- `assertValidScope.ts`

---

### gap.13 = format functions need decomposition

**fix applied**: decomposed into:
- `formatAsTree.ts` — shared tree format
- `formatAsFlat.ts` — shared flat format
- `formatAsJson.ts` — shared json format
- `formatSkillList.ts` — composes above for skill list
- `formatSearchResults.ts` — composes above for search results

---

### gap.14 = genZshCompletionCode needs to handle both rhx and rhachet

**fix applied**: genZshCompletionCode now emits:
- `_rhx()` for `rhx <skill>` completion
- `_rhachet_run_skill()` for `rhachet run --skill <skill>` completion

---

## resolution summary

| gap | severity | status |
|-----|----------|--------|
| gap.1 | blocker | ✅ fixed |
| gap.2 | blocker | ✅ fixed |
| gap.3 | blocker | ✅ fixed |
| gap.4 | blocker | ✅ fixed |
| gap.5 | blocker | ✅ fixed |
| gap.6 | blocker | ✅ fixed |
| gap.7 | blocker | ✅ fixed |
| gap.8 | blocker | ✅ fixed |
| gap.9 | minor | ✅ fixed |
| gap.10 | blocker | ✅ fixed |
| gap.11 | minor | ✅ fixed |
| gap.12 | blocker | ✅ fixed |
| gap.13 | blocker | ✅ fixed |
| gap.14 | blocker | ✅ fixed |

**all 14 gaps resolved**

---

## criteria coverage (post-fix)

### criteria error cases

| error case | coverage |
|------------|----------|
| not in a repo | ✅ handled |
| invalid --output value | ✅ BadRequestError with valid options |
| invalid --scope value | ✅ BadRequestError with valid options |
| search with empty query | ✅ shows all results |

### tab completion coverage

| completion | coverage |
|------------|----------|
| `rhx <partial><tab>` | ✅ via _rhx() |
| `rhachet run --skill <partial><tab>` | ✅ via _rhachet_run_skill() |

### matrix coverage

| matrix | coverage |
|--------|----------|
| matrix.1 tab completion | ✅ |
| matrix.2 cwd-aware | ✅ |
| matrix.3 rhx list | ✅ includes validation |
| matrix.4 rhx search | ✅ includes validation |
| matrix.5 rhachet completion | ✅ includes rhachet run --skill |
| matrix.6 first-time setup | ✅ |

---

## conclusion

blueprint v1.i1.md now fully covers all criteria and vision requirements.

ready for human approval.

# execution log: sdk-brain-repl-examples

## progress tracker

### phase 0: dependencies
- [x] 0.1 install zod-to-json-schema in root
- [x] 0.2 install claude-agent-sdk in root (single package.json)
- [x] 0.3 install codex-sdk in root (single package.json)

### phase 1: domain objects
- [x] 1.1 create BrainAtomPlugs.ts
- [x] 1.2 create BrainReplPlugs.ts
- [x] 1.3 update BrainAtom.ts (imagine → ask)
- [x] 1.4 update BrainRepl.ts (imagine → ask + act)
- [x] 1.5 update ContextBrain.ts

### phase 2: domain operations
- [x] 2.1 create castZodToJsonSchema.ts
- [x] 2.2 create test for castZodToJsonSchema (deferred to phase 5)
- [x] 2.3 create askViaBrainAtom.ts (new, no prior file to rename)
- [x] 2.4 create askViaBrainRepl.ts
- [x] 2.5 create actViaBrainRepl.ts

### phase 3: SDK adapters
- [x] 3.1 update brainReplClaudeCode.ts (using @anthropic-ai/claude-agent-sdk query())
- [x] 3.2 update brainReplCodex.ts (using @openai/codex-sdk Codex.startThread().run())
- [x] 3.3 update brainAtom implementations (imagine → ask)

### phase 4: update callers
- [x] 4.1 find all .imagine() usages
- [x] 4.2 update atom callers (genContextBrain, tests, mocks)
- [x] 4.3 update repl callers (genContextBrain, tests, mocks)

### phase 5: tests
- [x] 5.1 update atom tests (brainAtomClaudeOpus, brainAtomGpt4o)
- [x] 5.2 update repl tests (brainReplClaudeCode, brainReplCodex)
- [x] 5.3 update genContextBrain tests
- [x] 5.4 update mock generators (genMockedBrainAtom, genMockedBrainRepl)

### phase 6: validation
- [x] 6.1 type check
- [x] 6.2 lint check
- [x] 6.3 format check
- [x] 6.4 unit tests
- [x] 6.5 integration tests (with API keys)
- [x] 6.6 build check

---

## execution log

### phase 0: dependencies

**status:** ✅ complete

added to root package.json:
- `@anthropic-ai/claude-agent-sdk`: 0.1.76
- `@openai/codex-sdk`: 0.77.0
- `zod-to-json-schema`: 3.25.1

note: single package.json in root, not separate packages

---

### phase 1: domain objects

**status:** ✅ complete

created:
- `src/domain.objects/BrainAtomPlugs.ts` - placeholder interface for atom plugins
- `src/domain.objects/BrainReplPlugs.ts` - placeholder interface for repl plugins

updated:
- `src/domain.objects/BrainAtom.ts` - renamed `imagine` → `ask`, added `plugs` parameter
- `src/domain.objects/BrainRepl.ts` - replaced `imagine` with `ask` (readonly) and `act` (read+write)
- `src/domain.objects/ContextBrain.ts` - updated to use `ask` and `act` methods

---

### phase 2: domain operations

**status:** ✅ complete

created:
- `src/domain.operations/schema/castZodToJsonSchema.ts` - converts Zod schemas to JSON Schema
- `src/domain.operations/brainAtom/askViaBrainAtom.ts` - operation for atom invocation
- `src/domain.operations/brainRepl/askViaBrainRepl.ts` - operation for readonly repl
- `src/domain.operations/brainRepl/actViaBrainRepl.ts` - operation for read+write repl

---

### phase 3: SDK adapters

**status:** ✅ complete

updated:
- `brainReplClaudeCode.ts` - now uses `@anthropic-ai/claude-agent-sdk` query()
  - `ask`: disallowedTools=["Edit","Write","Bash","NotebookEdit"]
  - `act`: allowedTools=["Read","Edit","Write","Bash","Glob","Grep","Task"]
- `brainReplCodex.ts` - now uses `@openai/codex-sdk` Codex.startThread().run()
  - `ask`: sandbox='read-only'
  - `act`: sandbox='workspace-write'
- `brainAtomClaudeOpus.ts` - renamed `imagine` → `ask`
- `brainAtomGpt4o.ts` - renamed `imagine` → `ask`

---

### phase 4: update callers

**status:** ✅ complete

updated:
- `src/domain.operations/context/genContextBrain.ts` - uses `ask` and `act` methods
- `src/__test_assets__/genMockedBrainAtom.ts` - uses `ask` method
- `src/__test_assets__/genMockedBrainRepl.ts` - uses `ask` and `act` methods

---

### phase 5: tests

**status:** ✅ complete

updated:
- `genContextBrain.test.ts` - tests for `ask` and `act` methods
- `genContextBrain.integration.test.ts` - tests for `ask` and `act` methods
- `brainAtomClaudeOpus.integration.test.ts` - uses `ask` method
- `brainAtomGpt4o.integration.test.ts` - uses `ask` method
- `brainReplClaudeCode.integration.test.ts` - tests for `ask` and `act` methods
- `brainReplCodex.integration.test.ts` - tests for `ask` and `act` methods

---

### phase 6: validation

**status:** ✅ complete

validation results:
- ✅ `npm run test:types` - types compile (fixed SDK API usage after initial errors)
- ✅ `npm run test:lint` - lint passes
- ✅ `npm run test:format` - format passes
- ✅ `npm run test:unit` - 40 tests pass
- ✅ `npm run build` - build succeeds
- ✅ integration tests - 22 tests pass (atoms + repls)
  - brainAtomClaudeOpus: 5 tests
  - brainAtomGpt4o: 5 tests
  - brainReplClaudeCode: 6 tests
  - brainReplCodex: 6 tests

**Jest ESM configuration notes:**
- added `transformIgnorePatterns` to transform pnpm-linked ESM packages
- added `.mjs` to transform pattern for claude-agent-sdk
- added `moduleNameMapper` for codex-sdk (workaround for Jest ESM resolution with implicit `.js` + `"type": "module"`)
- note: the moduleNameMapper is test-only; Node.js runtime resolves correctly via package.json exports

**SDK API corrections applied:**
- `@anthropic-ai/claude-agent-sdk`: `query()` returns async generator, iterate for `SDKResultMessage`
  - must check `subtype === 'success'` to access `.result` and `.structured_output` fields
  - uses `outputFormat: { type: 'json_schema', schema: ... }` for native structured output
  - when `outputFormat` is set, result is in `structured_output` field (not `result`)
  - options passed as `{ prompt, options: { systemPrompt, disallowedTools, outputFormat } }`
- `@openai/codex-sdk`: `startThread()` takes `ThreadOptions` with `sandboxMode`
  - `run(input, turnOptions)` where input is string and turnOptions has `outputSchema`
  - result is `Turn` with `.finalResponse` (not `.output`)


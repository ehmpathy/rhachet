# roadmap: sdk-brain-repl-examples

## overview

this roadmap provides a checklist-style execution plan for the blueprint defined in `3.3.blueprint.v1.i1.md`. each step includes:
- ordered dependencies (what must complete first)
- behavioral acceptance criteria (what "done" looks like)
- verification method (how to confirm completion)

---

## phase 0: dependencies

### step 0.1: install zod-to-json-schema in root package

- [ ] **task**: add `zod-to-json-schema` to root package.json

**depends on:** nothing

**acceptance criteria:**
- `zod-to-json-schema` appears in dependencies with pinned version `^3.23.0`
- `npm install` completes without errors

**verification:**
```bash
npm install
npm list zod-to-json-schema
# expect: zod-to-json-schema@3.23.x
```

---

### step 0.2: install claude agent sdk in rhachet-brain-anthropic

- [ ] **task**: add `@anthropic-ai/claude-agent-sdk` to rhachet-brain-anthropic/package.json

**depends on:** nothing

**acceptance criteria:**
- `@anthropic-ai/claude-agent-sdk` appears in dependencies with pinned version `^2.0.0`
- `zod-to-json-schema` appears in dependencies with pinned version `^3.23.0`
- `npm install` completes without errors in the subpackage

**verification:**
```bash
cd src/_topublish/rhachet-brain-anthropic
npm install
npm list @anthropic-ai/claude-agent-sdk
# expect: @anthropic-ai/claude-agent-sdk@2.x.x
```

---

### step 0.3: install codex sdk in rhachet-brain-openai

- [ ] **task**: add `@openai/codex-sdk` to rhachet-brain-openai/package.json

**depends on:** nothing

**acceptance criteria:**
- `@openai/codex-sdk` appears in dependencies with pinned version `^0.77.0`
- `zod-to-json-schema` appears in dependencies with pinned version `^3.23.0`
- `npm install` completes without errors in the subpackage

**verification:**
```bash
cd src/_topublish/rhachet-brain-openai
npm install
npm list @openai/codex-sdk
# expect: @openai/codex-sdk@0.77.x
```

---

## phase 1: domain objects

### step 1.1: create BrainAtomPlugs.ts

- [ ] **task**: create `src/domain.objects/BrainAtomPlugs.ts` with placeholder interface

**depends on:** nothing

**acceptance criteria:**
- file exists at `src/domain.objects/BrainAtomPlugs.ts`
- exports `BrainAtomPlugs` interface with `output?: never` placeholder
- exports `BrainAtomPlugs` class extending `DomainLiteral`
- jsdoc comments explain `.what` and `.why` for the interface and each property
- `// todo: allow configuration` comment present

**verification:**
```bash
npm run test:types
# expect: no type errors related to BrainAtomPlugs
```

---

### step 1.2: create BrainReplPlugs.ts

- [ ] **task**: create `src/domain.objects/BrainReplPlugs.ts` with placeholder interface

**depends on:** nothing

**acceptance criteria:**
- file exists at `src/domain.objects/BrainReplPlugs.ts`
- exports `BrainReplPlugs` interface with three placeholder properties:
  - `toolboxes?: never` with jsdoc explaining tool providers
  - `memory?: never` with jsdoc explaining context management
  - `access?: never` with jsdoc explaining permission guards
- exports `BrainReplPlugs` class extending `DomainLiteral`
- `// todo: allow configuration` comment present for each property

**verification:**
```bash
npm run test:types
# expect: no type errors related to BrainReplPlugs
```

---

### step 1.3: update BrainAtom.ts (rename imagine → ask)

- [ ] **task**: update `src/domain.objects/BrainAtom.ts`
  - rename `imagine` method to `ask`
  - add optional `plugs?: BrainAtomPlugs` parameter

**depends on:** step 1.1

**acceptance criteria:**
- `BrainAtom` interface has `ask` method (not `imagine`)
- `ask` method signature includes `plugs?: BrainAtomPlugs` in input
- jsdoc updated to reflect "ask operation" naming
- no references to `imagine` remain in the file

**verification:**
```bash
grep -c "imagine" src/domain.objects/BrainAtom.ts
# expect: 0

grep -c "ask:" src/domain.objects/BrainAtom.ts
# expect: 1

npm run test:types
# expect: errors for all callers still using .imagine() - this is expected
```

---

### step 1.4: update BrainRepl.ts (replace imagine with ask + act)

- [ ] **task**: update `src/domain.objects/BrainRepl.ts`
  - remove `imagine` method
  - add `ask` method (readonly)
  - add `act` method (read+write)
  - add optional `plugs?: BrainReplPlugs` parameter to both

**depends on:** step 1.2

**acceptance criteria:**
- `BrainRepl` interface has `ask` method with jsdoc explaining readonly mode
- `BrainRepl` interface has `act` method with jsdoc explaining read+write mode
- both methods include `plugs?: BrainReplPlugs` in input
- `.sdk.mapping` jsdoc present explaining how modes map to SDK options
- no references to `imagine` remain in the file

**verification:**
```bash
grep -c "imagine" src/domain.objects/BrainRepl.ts
# expect: 0

grep -c "ask:" src/domain.objects/BrainRepl.ts
# expect: 1

grep -c "act:" src/domain.objects/BrainRepl.ts
# expect: 1

npm run test:types
# expect: errors for all callers still using .imagine() - this is expected
```

---

### step 1.5: update ContextBrain.ts

- [ ] **task**: update `src/domain.objects/ContextBrain.ts`
  - update `brain.atom.imagine` → `brain.atom.ask`
  - update `brain.repl.imagine` → `brain.repl.ask` + `brain.repl.act`

**depends on:** step 1.3, step 1.4

**acceptance criteria:**
- `brain.atom.ask` method exists (not `imagine`)
- `brain.repl.ask` method exists (not `imagine`)
- `brain.repl.act` method exists (new)
- jsdoc explains each method's purpose
- no references to `imagine` remain in the file

**verification:**
```bash
grep -c "imagine" src/domain.objects/ContextBrain.ts
# expect: 0

npm run test:types
# expect: type errors for callers, not for ContextBrain itself
```

---

## phase 2: domain operations

### step 2.1: create castZodToJsonSchema.ts

- [ ] **task**: create `src/domain.operations/schema/castZodToJsonSchema.ts`

**depends on:** step 0.1

**acceptance criteria:**
- file exists at `src/domain.operations/schema/castZodToJsonSchema.ts`
- exports `castZodToJsonSchema` function with signature:
  ```typescript
  (input: { schema: z.ZodSchema; target: 'claude' | 'openai' }) => object
  ```
- uses `zodToJsonSchema` with `{ $refStrategy: 'root' }` for claude target
- uses `zodToJsonSchema` with `{ target: 'openAi' }` for openai target
- jsdoc explains `.what`, `.why`, and `.note` about SDK differences

**verification:**
```bash
npm run test:types
# expect: no type errors

# unit test verifies both targets produce valid JSON schema
npm run test:unit -- castZodToJsonSchema
```

---

### step 2.2: create unit test for castZodToJsonSchema

- [ ] **task**: create `src/domain.operations/schema/castZodToJsonSchema.test.ts`

**depends on:** step 2.1

**acceptance criteria:**
- test file exists
- tests cover:
  - claude target produces valid JSON schema
  - openai target produces valid JSON schema
  - complex zod schemas (objects, arrays, enums) convert correctly

**verification:**
```bash
npm run test:unit -- castZodToJsonSchema
# expect: all tests pass
```

---

### step 2.3: rename imagineViaBrainAtom → askViaBrainAtom

- [ ] **task**: rename file and function from `imagineViaBrainAtom` to `askViaBrainAtom`

**depends on:** step 1.3

**acceptance criteria:**
- file renamed to `src/domain.operations/brainAtom/askViaBrainAtom.ts`
- function renamed to `askViaBrainAtom`
- `plugs` parameter added to input
- old file `imagineViaBrainAtom.ts` deleted
- jsdoc updated

**verification:**
```bash
ls src/domain.operations/brainAtom/
# expect: askViaBrainAtom.ts exists, imagineViaBrainAtom.ts does not

npm run test:types
# expect: errors for callers using imagineViaBrainAtom
```

---

### step 2.4: create askViaBrainRepl.ts

- [ ] **task**: create `src/domain.operations/brainRepl/askViaBrainRepl.ts`

**depends on:** step 1.4

**acceptance criteria:**
- file exists at `src/domain.operations/brainRepl/askViaBrainRepl.ts`
- exports `askViaBrainRepl` async function
- delegates to `input.repl.ask()`
- passes through `plugs`, `role`, `prompt`, `schema`
- jsdoc explains readonly agentic operation

**verification:**
```bash
npm run test:types
# expect: no type errors for askViaBrainRepl
```

---

### step 2.5: create actViaBrainRepl.ts

- [ ] **task**: create `src/domain.operations/brainRepl/actViaBrainRepl.ts`

**depends on:** step 1.4

**acceptance criteria:**
- file exists at `src/domain.operations/brainRepl/actViaBrainRepl.ts`
- exports `actViaBrainRepl` async function
- delegates to `input.repl.act()`
- passes through `plugs`, `role`, `prompt`, `schema`
- jsdoc explains read+write agentic operation

**verification:**
```bash
npm run test:types
# expect: no type errors for actViaBrainRepl
```

---

## phase 3: SDK adapters

### step 3.1: update brainReplClaudeCode.ts

- [ ] **task**: rewrite `src/_topublish/rhachet-brain-anthropic/src/repls/brainReplClaudeCode.ts`
  - replace `@anthropic-ai/sdk` import with `@anthropic-ai/claude-agent-sdk`
  - replace `imagine` with `ask` and `act` methods
  - use `query()` function from claude agent sdk
  - add `disallowedTools` for `ask` mode
  - add `allowedTools` for `act` mode
  - add `outputFormat` with JSON schema for native enforcement

**depends on:** step 0.2, step 1.4, step 2.1

**acceptance criteria:**
- imports `query` from `@anthropic-ai/claude-agent-sdk`
- imports `zodToJsonSchema` from `zod-to-json-schema`
- `ask` method:
  - uses `disallowedTools: ['Edit', 'Write', 'Bash', 'NotebookEdit']`
  - uses `permissionMode: 'bypassPermissions'`
  - uses `outputFormat: { type: 'json_schema', schema: jsonSchema }`
  - iterates `for await` over query generator
  - returns parsed `structured_output` from result message
- `act` method:
  - uses `allowedTools: ['Read', 'Edit', 'Write', 'Bash', 'Glob', 'Grep']`
  - uses `permissionMode: 'bypassPermissions'`
  - uses `outputFormat: { type: 'json_schema', schema: jsonSchema }`
  - iterates `for await` over query generator
  - returns parsed `structured_output` from result message
- throws `UnexpectedCodePathError` if no result received
- no references to old `@anthropic-ai/sdk` or `imagine`

**verification:**
```bash
npm run test:types
# expect: no type errors

grep -c "imagine" src/_topublish/rhachet-brain-anthropic/src/repls/brainReplClaudeCode.ts
# expect: 0

grep -c "@anthropic-ai/claude-agent-sdk" src/_topublish/rhachet-brain-anthropic/src/repls/brainReplClaudeCode.ts
# expect: 1
```

---

### step 3.2: update brainReplCodex.ts

- [ ] **task**: rewrite `src/_topublish/rhachet-brain-openai/src/repls/brainReplCodex.ts`
  - replace `openai` import with `@openai/codex-sdk`
  - replace `imagine` with `ask` and `act` methods
  - use `Codex.startThread().run()` pattern
  - add `outputSchema` for native JSON schema enforcement

**depends on:** step 0.3, step 1.4, step 2.1

**acceptance criteria:**
- imports `Codex` from `@openai/codex-sdk`
- imports `zodToJsonSchema` from `zod-to-json-schema`
- `ask` method:
  - creates `new Codex()`
  - calls `codex.startThread({ outputSchema: jsonSchema })`
  - calls `thread.run(promptWithBriefs)`
  - returns parsed `turn.finalResponse`
- `act` method:
  - creates `new Codex()`
  - calls `codex.startThread({ outputSchema: jsonSchema })`
  - calls `thread.run(promptWithBriefs)`
  - returns parsed `turn.finalResponse`
- throws `UnexpectedCodePathError` if no finalResponse
- no references to old `openai` sdk or `imagine`

**verification:**
```bash
npm run test:types
# expect: no type errors

grep -c "imagine" src/_topublish/rhachet-brain-openai/src/repls/brainReplCodex.ts
# expect: 0

grep -c "@openai/codex-sdk" src/_topublish/rhachet-brain-openai/src/repls/brainReplCodex.ts
# expect: 1
```

---

### step 3.3: update brainAtom implementations

- [ ] **task**: update all brainAtom implementations to rename `imagine` → `ask`

**depends on:** step 1.3

**acceptance criteria:**
- all `brainAtomClaude*.ts` files use `ask` instead of `imagine`
- all `brainAtomGpt*.ts` files use `ask` instead of `imagine`
- `plugs` parameter added to each

**verification:**
```bash
grep -r "imagine" src/_topublish/*/src/atoms/
# expect: no matches

npm run test:types
# expect: no type errors in atoms
```

---

## phase 4: update callers

### step 4.1: find all .imagine() usages

- [ ] **task**: enumerate all files calling `.imagine()` on atoms or repls

**depends on:** nothing

**acceptance criteria:**
- list of all files using `.imagine()` documented
- each usage categorized as:
  - atom usage (→ rename to `.ask()`)
  - repl readonly usage (→ rename to `.ask()`)
  - repl read+write usage (→ rename to `.act()`)

**verification:**
```bash
grep -r "\.imagine(" src/
# document all matches
```

---

### step 4.2: update atom callers (.imagine → .ask)

- [ ] **task**: update all `brain.atom.imagine()` calls to `brain.atom.ask()`

**depends on:** step 4.1, step 1.3

**acceptance criteria:**
- all `brain.atom.imagine()` calls renamed to `brain.atom.ask()`
- no `atom.imagine()` references remain in codebase

**verification:**
```bash
grep -r "atom\.imagine" src/
# expect: no matches

npm run test:types
# expect: no type errors for atom callers
```

---

### step 4.3: update repl callers (.imagine → .ask or .act)

- [ ] **task**: update all `brain.repl.imagine()` calls to `.ask()` or `.act()` based on usage

**depends on:** step 4.1, step 1.4

**acceptance criteria:**
- readonly operations use `brain.repl.ask()`
- read+write operations use `brain.repl.act()`
- no `repl.imagine()` references remain in codebase

**verification:**
```bash
grep -r "repl\.imagine" src/
# expect: no matches

grep -r "\.imagine(" src/
# expect: no matches

npm run test:types
# expect: no type errors for repl callers
```

---

## phase 5: tests

### step 5.1: update existing atom tests

- [ ] **task**: update all atom test files to use `.ask()` instead of `.imagine()`

**depends on:** step 4.2

**acceptance criteria:**
- all test files use `.ask()` for atom invocations
- no `.imagine()` references in test files

**verification:**
```bash
grep -r "\.imagine(" src/**/*.test.ts
# expect: no matches

npm run test:unit
# expect: atom tests pass (or fail for expected reasons)
```

---

### step 5.2: update existing repl tests

- [ ] **task**: update all repl test files to use `.ask()` or `.act()` instead of `.imagine()`

**depends on:** step 4.3

**acceptance criteria:**
- readonly tests use `.ask()`
- read+write tests use `.act()`
- no `.imagine()` references in test files

**verification:**
```bash
npm run test:unit
# expect: repl tests pass (or fail for expected reasons)
```

---

### step 5.3: add integration test for brainReplClaudeCode

- [ ] **task**: create/update integration test for claude code repl

**depends on:** step 3.1

**acceptance criteria:**
- test exists for `ask()` method:
  - invokes with simple prompt
  - verifies structured output matches schema
  - verifies no file modifications occurred
- test exists for `act()` method:
  - invokes with code modification prompt
  - verifies structured output matches schema
  - verifies file modifications occurred (or simulated)

**verification:**
```bash
source .agent/repo=.this/role=any/skills/use.apikeys.sh
npm run test:integration -- brainReplClaudeCode
# expect: tests pass
```

---

### step 5.4: add integration test for brainReplCodex

- [ ] **task**: create/update integration test for codex repl

**depends on:** step 3.2

**acceptance criteria:**
- test exists for `ask()` method:
  - invokes with simple prompt
  - verifies structured output matches schema
- test exists for `act()` method:
  - invokes with code modification prompt
  - verifies structured output matches schema

**verification:**
```bash
source .agent/repo=.this/role=any/skills/use.apikeys.sh
npm run test:integration -- brainReplCodex
# expect: tests pass
```

---

## phase 6: validation

### step 6.1: type check

- [ ] **task**: run full type check

**depends on:** all previous steps

**acceptance criteria:**
- `npm run test:types` passes with zero errors
- no `// @ts-ignore` or `// @ts-expect-error` added for this work

**verification:**
```bash
npm run test:types
# expect: exit code 0
```

---

### step 6.2: lint check

- [ ] **task**: run lint check and fix any violations

**depends on:** all previous steps

**acceptance criteria:**
- `npm run test:lint` passes with zero errors
- `npm run fix:lint` applied if needed

**verification:**
```bash
npm run test:lint
# expect: exit code 0
```

---

### step 6.3: format check

- [ ] **task**: run format check and fix any violations

**depends on:** all previous steps

**acceptance criteria:**
- `npm run test:format` passes
- `npm run fix:format` applied if needed

**verification:**
```bash
npm run test:format
# expect: exit code 0
```

---

### step 6.4: unit tests

- [ ] **task**: run full unit test suite

**depends on:** step 5.1, step 5.2

**acceptance criteria:**
- `npm run test:unit` passes with zero failures
- all new code has test coverage

**verification:**
```bash
npm run test:unit
# expect: exit code 0, all tests pass
```

---

### step 6.5: integration tests

- [ ] **task**: run full integration test suite

**depends on:** step 5.3, step 5.4

**acceptance criteria:**
- `npm run test:integration` passes with zero failures
- SDK integrations work with live APIs

**verification:**
```bash
source .agent/repo=.this/role=any/skills/use.apikeys.sh
npm run test:integration
# expect: exit code 0, all tests pass
```

---

### step 6.6: build check

- [ ] **task**: run full build

**depends on:** step 6.1

**acceptance criteria:**
- `npm run build` completes without errors
- compiled output in expected location

**verification:**
```bash
npm run build
# expect: exit code 0
```

---

## summary checklist

### phase 0: dependencies
- [ ] 0.1 install zod-to-json-schema in root
- [ ] 0.2 install claude-agent-sdk in rhachet-brain-anthropic
- [ ] 0.3 install codex-sdk in rhachet-brain-openai

### phase 1: domain objects
- [ ] 1.1 create BrainAtomPlugs.ts
- [ ] 1.2 create BrainReplPlugs.ts
- [ ] 1.3 update BrainAtom.ts (imagine → ask)
- [ ] 1.4 update BrainRepl.ts (imagine → ask + act)
- [ ] 1.5 update ContextBrain.ts

### phase 2: domain operations
- [ ] 2.1 create castZodToJsonSchema.ts
- [ ] 2.2 create test for castZodToJsonSchema
- [ ] 2.3 rename imagineViaBrainAtom → askViaBrainAtom
- [ ] 2.4 create askViaBrainRepl.ts
- [ ] 2.5 create actViaBrainRepl.ts

### phase 3: SDK adapters
- [ ] 3.1 update brainReplClaudeCode.ts
- [ ] 3.2 update brainReplCodex.ts
- [ ] 3.3 update brainAtom implementations

### phase 4: update callers
- [ ] 4.1 find all .imagine() usages
- [ ] 4.2 update atom callers
- [ ] 4.3 update repl callers

### phase 5: tests
- [ ] 5.1 update atom tests
- [ ] 5.2 update repl tests
- [ ] 5.3 add integration test for brainReplClaudeCode
- [ ] 5.4 add integration test for brainReplCodex

### phase 6: validation
- [ ] 6.1 type check
- [ ] 6.2 lint check
- [ ] 6.3 format check
- [ ] 6.4 unit tests
- [ ] 6.5 integration tests
- [ ] 6.6 build check

---

## dependency graph

```
phase 0 (parallel)
├── 0.1 zod-to-json-schema
├── 0.2 claude-agent-sdk
└── 0.3 codex-sdk

phase 1 (partial parallel)
├── 1.1 BrainAtomPlugs
├── 1.2 BrainReplPlugs
├── 1.3 BrainAtom (depends: 1.1)
├── 1.4 BrainRepl (depends: 1.2)
└── 1.5 ContextBrain (depends: 1.3, 1.4)

phase 2 (partial parallel)
├── 2.1 castZodToJsonSchema (depends: 0.1)
├── 2.2 castZodToJsonSchema test (depends: 2.1)
├── 2.3 askViaBrainAtom (depends: 1.3)
├── 2.4 askViaBrainRepl (depends: 1.4)
└── 2.5 actViaBrainRepl (depends: 1.4)

phase 3 (partial parallel)
├── 3.1 brainReplClaudeCode (depends: 0.2, 1.4, 2.1)
├── 3.2 brainReplCodex (depends: 0.3, 1.4, 2.1)
└── 3.3 brainAtom impls (depends: 1.3)

phase 4 (sequential)
├── 4.1 find .imagine() usages
├── 4.2 update atom callers (depends: 4.1, 1.3)
└── 4.3 update repl callers (depends: 4.1, 1.4)

phase 5 (partial parallel)
├── 5.1 atom tests (depends: 4.2)
├── 5.2 repl tests (depends: 4.3)
├── 5.3 claude integration test (depends: 3.1)
└── 5.4 codex integration test (depends: 3.2)

phase 6 (sequential)
├── 6.1 type check (depends: all)
├── 6.2 lint check (depends: all)
├── 6.3 format check (depends: all)
├── 6.4 unit tests (depends: 5.1, 5.2)
├── 6.5 integration tests (depends: 5.3, 5.4)
└── 6.6 build check (depends: 6.1)
```

---

## final acceptance criteria

the wish is complete when:

1. **SDK integration**: `brainReplClaudeCode` uses `@anthropic-ai/claude-agent-sdk` with `query()`
2. **SDK integration**: `brainReplCodex` uses `@openai/codex-sdk` with `Codex.startThread().run()`
3. **structured outputs**: both repls use native JSON schema enforcement
4. **ask/act pattern**: `BrainRepl` exposes `ask()` (readonly) and `act()` (read+write)
5. **rename complete**: all `.imagine()` references replaced with `.ask()` or `.act()`
6. **plugs placeholder**: `BrainReplPlugs` interface exists with `toolboxes`, `memory`, `access` placeholders
7. **all tests pass**: `npm run test` exits with code 0
8. **build succeeds**: `npm run build` exits with code 0

# research: prod codepath patterns

## citations

[1] package.json:18-20
> `"bin": { "rhachet": "./bin/run" }`

[2] bin/run:1-11
> `# .what = shell entrypoint for rhachet CLI`
> `# .why = routes to bun (fast) or jit (flexible) dispatcher`

[3] bin/run:22-26
> `case "$1" in run) exec "$SCRIPT_DIR/run.bun" "$@" ;;`

[4] bin/run.bun:1-11
> `# .what = bun dispatcher for rhachet CLI`
> `# .why = routes to bun-compiled binaries for optimal perf`

[5] bin/run.bun:17-19
> `case "$1" in run) exec "$SCRIPT_DIR/run.bun.rhachet-run.bc" "$@" ;;`

[6] src/contract/cli/invoke.bun.entry.run.ts:1-4
> `# .what = minimal entrypoint for rhachet run command only`
> `# .why = fast startup via skip of registry load; reads from .agent/ directly`

[7] src/contract/cli/invokeRun.ts:120-129
> `program.command('run').description('run a solid skill').option('-s, --skill <slug>', 'the skill to execute')`

[8] bin/run.jit:1-2
> `#!/usr/bin/env -S node --experimental-strip-types`
> `require('../dist/contract/cli/invoke').invoke({ args: process.argv.slice(2) });`

[9] package.json:39
> `"build:compile:bun:run": "bun build ./src/contract/cli/invoke.bun.entry.run.ts --compile --bytecode --sourcemap --outfile ./bin/run.bun.rhachet-run.bc"`

---

## patterns

### pattern 1: package.json bin registration

[EXTEND]

**what**: single bin entry registers `rhachet` command
**where**: package.json:18-20
**how**: `"bin": { "rhachet": "./bin/run" }` [1]

**relation to wish**: need to add `rhx` entry that points to new shell wrapper
**change**: add `"rhx": "./bin/rhx"` to bin object

---

### pattern 2: shell entrypoint dispatcher (bin/run)

[REUSE]

**what**: shell dispatcher routes commands to bun (fast) or jit (flexible)
**where**: bin/run
**how**: case statement on `$1` to route `run` → run.bun, else → run.jit [2][3]

**relation to wish**: rhx will invoke this same entrypoint with `run --skill` prefix
**change**: none — rhx delegates to `rhachet run --skill "$@"`

---

### pattern 3: bun binary dispatcher (bin/run.bun)

[REUSE]

**what**: routes to bun-compiled .bc binaries for optimal perf
**where**: bin/run.bun
**how**: case statement routes `run` → run.bun.rhachet-run.bc [4][5]

**relation to wish**: rhx invokes `rhachet run --skill` which flows through this dispatcher
**change**: none — transparent to rhx

---

### pattern 4: bun-compiled run entrypoint

[REUSE]

**what**: minimal entrypoint for `rhachet run` command only
**where**: src/contract/cli/invoke.bun.entry.run.ts
**how**: registers only invokeRun command, skips registry load [6]

**relation to wish**: rhx delegates to this via `rhachet run --skill`
**change**: none — transparent to rhx

---

### pattern 5: invokeRun command registration

[REUSE]

**what**: registers `run` command with `--skill` option
**where**: src/contract/cli/invokeRun.ts
**how**: commander subcommand with options [7]

**relation to wish**: rhx prepends `run --skill` so this command handles execution
**change**: none — rhx uses current interface

---

### pattern 6: jit fallback entrypoint

[REUSE]

**what**: node/tsx entrypoint for commands that need npm imports
**where**: bin/run.jit
**how**: invokes dist/contract/cli/invoke with process.argv [8]

**relation to wish**: rhx may fall through to jit for non-skill commands (unlikely path)
**change**: none

---

### pattern 7: bun compilation build step

[REUSE]

**what**: compiles typescript entrypoints to .bc bytecode binaries
**where**: package.json build commands
**how**: `bun build --compile --bytecode` [9]

**relation to wish**: rhx is a shell wrapper, not a bun binary — no compilation needed
**change**: none

---

## new pattern required

### pattern N: rhx shell proxy

[NEW]

**what**: shell wrapper that prepends `run --skill` and delegates to rhachet
**where**: bin/rhx (new file)
**how**:
```sh
#!/bin/sh
exec rhachet run --skill "$@"
```

**relation to wish**: this IS the wish — the rhx alias
**rationale**:
- shell wrapper per [FACT] claims research
- `exec` replaces shell process per best practice
- `"$@"` preserves argument boundaries

---

## summary

| pattern | file | action |
|---------|------|--------|
| bin registration | package.json | [EXTEND] add `rhx` entry |
| shell dispatcher | bin/run | [REUSE] |
| bun dispatcher | bin/run.bun | [REUSE] |
| bun run entry | invoke.bun.entry.run.ts | [REUSE] |
| invokeRun cmd | invokeRun.ts | [REUSE] |
| jit fallback | bin/run.jit | [REUSE] |
| bun compilation | package.json | [REUSE] |
| rhx proxy | bin/rhx | [NEW] |

**minimal change surface**: 1 file extended (package.json), 1 file created (bin/rhx)

# research: test codepath patterns

## citations

[1] accept.blackbox/.test/infra/invokeRhachetCliBinary.ts:7-8
> `const RHACHET_BIN = resolve(__dirname, '../../../bin/run');`

[2] accept.blackbox/.test/infra/invokeRhachetCliBinary.ts:14-42
> `export const invokeRhachetCliBinary = (input: { args: string[]; cwd: string; ... })`

[3] accept.blackbox/.test/infra/genTestTempRepo.ts:44-89
> `export const genTestTempRepo = (input: { fixture: TestRepoFixture; ... })`

[4] accept.blackbox/.test/infra/genTestTempRepo.ts:16-35
> `export type TestRepoFixture = 'minimal' | 'with-skills' | 'with-briefs' | ...`

[5] accept.blackbox/cli/run.skill.acceptance.test.ts:6-27
> `given('[case1] repo with skills', () => { const repo = useBeforeAll(...genTestTempRepo({ fixture: 'with-skills' })); when('[t0] run --skill say-hello', () => { ... invokeRhachetCliBinary({ args: ['run', '--skill', 'say-hello'], cwd: repo.path }) ... })`

[6] accept.blackbox/.test/assets/with-skills/.agent/repo=.this/role=any/skills/say-hello.sh:1-6
> `#!/usr/bin/env bash ... echo "hello ${1:-world}"`

[7] accept.blackbox/.test/assets/with-skills/.agent/repo=.this/role=any/skills/echo-args.sh:1-6
> `#!/usr/bin/env bash ... echo "args: $@"`

[8] accept.blackbox/cli/run.skill.acceptance.test.ts:42-58
> `when('[t2] run --skill nonexistent', () => { ... then('exits with non-zero status', () => { expect(result.status).not.toEqual(0); }); then('stderr contains error message', () => { expect(result.stderr).toContain('nonexistent'); }); })`

---

## patterns

### pattern 1: invokeRhachetCliBinary helper

[EXTEND]

**what**: helper to invoke compiled rhachet CLI binary via spawnSync
**where**: accept.blackbox/.test/infra/invokeRhachetCliBinary.ts
**how**: resolves to `bin/run`, spawns with args and cwd [1][2]

**relation to wish**: need similar helper to invoke `bin/rhx` for rhx acceptance tests
**change**: either extend to support alternate binary path, or create `invokeRhxCliBinary`

---

### pattern 2: genTestTempRepo fixture generator

[REUSE]

**what**: creates isolated test repo in os.tmpdir() from fixture template
**where**: accept.blackbox/.test/infra/genTestTempRepo.ts
**how**: copies fixture assets, inits git, makes .sh files executable [3][4]

**relation to wish**: rhx tests use same fixtures (with-skills) since rhx delegates to run --skill
**change**: none — reuse `with-skills` fixture

---

### pattern 3: TestRepoFixture type

[REUSE]

**what**: union type of available fixture templates
**where**: accept.blackbox/.test/infra/genTestTempRepo.ts:16-35
**how**: `'minimal' | 'with-skills' | 'with-briefs' | ...` [4]

**relation to wish**: `with-skills` fixture has say-hello, echo-args, exit-code skills
**change**: none — fixtures already sufficient for rhx tests

---

### pattern 4: BDD acceptance test structure

[REUSE]

**what**: given/when/then structure with useBeforeAll for setup
**where**: accept.blackbox/cli/run.skill.acceptance.test.ts
**how**: `given('[caseN]', () => { useBeforeAll(...); when('[tN]', () => { then(...) }) })` [5]

**relation to wish**: rhx acceptance tests follow same structure
**change**: none — same pattern for rhx tests

---

### pattern 5: with-skills fixture

[REUSE]

**what**: fixture with sample skills for test run command
**where**: accept.blackbox/.test/assets/with-skills/
**how**: contains .agent/repo=.this/role=any/skills/{say-hello,echo-args,exit-code}.sh [6][7]

**relation to wish**: rhx tests use same skills to verify equivalence with `rhachet run --skill`
**change**: none — same fixture works for rhx

---

### pattern 6: error case test pattern

[REUSE]

**what**: tests for error paths (nonexistent skill, bad args)
**where**: accept.blackbox/cli/run.skill.acceptance.test.ts:42-58
**how**: `logOnError: false`, assert non-zero status and stderr content [8]

**relation to wish**: rhx error tests verify errors match `rhachet run --skill` errors
**change**: none — same pattern for rhx error tests

---

### pattern 7: argument passthrough test pattern

[REUSE]

**what**: tests that verify args pass through to skill
**where**: accept.blackbox/.test/assets/with-skills/.agent/.../echo-args.sh
**how**: skill echoes `$@`, test asserts output contains passed args [7]

**relation to wish**: rhx tests verify `rhx say-hello foo` === `rhachet run --skill say-hello foo`
**change**: none — same fixture skill works for rhx

---

## new pattern required

### pattern N: rhx acceptance test file

[NEW]

**what**: acceptance tests for rhx alias command
**where**: accept.blackbox/cli/rhx.acceptance.test.ts (new file)
**how**:
```ts
given('[case1] repo with skills', () => {
  const repo = useBeforeAll(() => genTestTempRepo({ fixture: 'with-skills' }));

  when('[t0] rhx say-hello', () => {
    const rhxResult = useBeforeAll(() =>
      invokeRhxCliBinary({ args: ['say-hello'], cwd: repo.path })
    );
    const rhachetResult = useBeforeAll(() =>
      invokeRhachetCliBinary({ args: ['run', '--skill', 'say-hello'], cwd: repo.path })
    );

    then('rhx output matches rhachet run --skill output', () => {
      expect(rhxResult.stdout).toEqual(rhachetResult.stdout);
    });

    then('rhx exit code matches rhachet run --skill exit code', () => {
      expect(rhxResult.status).toEqual(rhachetResult.status);
    });
  });
});
```

**rationale**: per blueprint criteria, tests must verify rhx === rhachet run --skill

---

### pattern N+1: invokeRhxCliBinary helper (optional)

[NEW]

**what**: helper to invoke bin/rhx binary
**where**: accept.blackbox/.test/infra/invokeRhxCliBinary.ts (new file)
**how**: same as invokeRhachetCliBinary but points to `bin/rhx`

**alternative**: extend invokeRhachetCliBinary to accept `binary` param
```ts
invokeRhachetCliBinary({ binary: 'rhx', args: ['say-hello'], cwd: repo.path })
```

---

## summary

| pattern | file | action |
|---------|------|--------|
| invokeRhachetCliBinary | .test/infra/invokeRhachetCliBinary.ts | [EXTEND] add rhx support |
| genTestTempRepo | .test/infra/genTestTempRepo.ts | [REUSE] |
| TestRepoFixture | .test/infra/genTestTempRepo.ts | [REUSE] |
| BDD test structure | run.skill.acceptance.test.ts | [REUSE] |
| with-skills fixture | .test/assets/with-skills/ | [REUSE] |
| error case test | run.skill.acceptance.test.ts | [REUSE] |
| arg passthrough test | echo-args.sh fixture | [REUSE] |
| rhx acceptance tests | rhx.acceptance.test.ts | [NEW] |

**minimal change surface**: 1 file extended (invokeRhachetCliBinary), 1 file created (rhx.acceptance.test.ts)

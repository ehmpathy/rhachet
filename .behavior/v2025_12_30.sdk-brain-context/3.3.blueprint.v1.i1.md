# implementation blueprint: sdk brain context

## overview

this blueprint outlines the implementation steps to deliver the pluggable brain context framework for rhachet SDK, as defined in the domain distillation.


---


## phase.1: domain objects

### step.1.1: create RhachetBrainAtom

**file**: `src/domain.objects/RhachetBrainAtom.ts`

**implementation**:
- define interface with `repo`, `slug`, `description`, `imagine` method
- extend `DomainEntity` with `unique = ['repo', 'slug']`
- include jsdoc with `.what`, `.why`, `.note` explaining plugin responsibility for briefs

**test**: `src/domain.objects/RhachetBrainAtom.test.ts`
- verify instantiation with valid props
- verify unique key extraction
- verify type enforcement on imagine signature


### step.1.2: create RhachetBrainRepl

**file**: `src/domain.objects/RhachetBrainRepl.ts`

**implementation**:
- define interface with `repo`, `slug`, `description`, `imagine` method
- extend `DomainEntity` with `unique = ['repo', 'slug']`
- include jsdoc distinguishing repl from atom (agentic loop vs single-turn)

**test**: `src/domain.objects/RhachetBrainRepl.test.ts`
- verify instantiation with valid props
- verify unique key extraction
- verify type enforcement on imagine signature


### step.1.3: create ContextRhachetBrain

**file**: `src/domain.objects/ContextRhachetBrain.ts`

**implementation**:
- define interface with `brain.atom.imagine` and `brain.repl.imagine` methods
- extend `DomainLiteral`
- include generic `TOutput` for typed schema inference

**test**: type-level verification via unit tests in factory tests


### step.1.4: export domain objects

**file**: `src/domain.objects/index.ts`

**implementation**:
- add exports for `RhachetBrainAtom`, `RhachetBrainRepl`, `ContextRhachetBrain`


---


## phase.2: domain operations

### step.2.1: create castBriefsToPrompt

**file**: `src/domain.operations/role/briefs/castBriefsToPrompt.ts`

**implementation**:
- extract logic from `bootRoleResources.ts` that converts briefs to text
- accept `{ briefs: Artifact<typeof GitFile>[] }` input
- return concatenated string with `\n\n` separator
- filter out empty/falsy content

**test**: `src/domain.operations/role/briefs/castBriefsToPrompt.test.ts`
- verify concatenation of multiple briefs
- verify empty array returns empty string
- verify falsy content is filtered


### step.2.2: refactor bootRoleResources to use castBriefsToPrompt

**file**: `src/domain.operations/invoke/bootRoleResources.ts`

**implementation**:
- import `castBriefsToPrompt`
- replace inline briefs-to-text logic with shared utility
- ensure behavior remains identical

**test**: existing integration tests should continue passing


### step.2.3: create findBrainAtomByRef

**file**: `src/domain.operations/context/findBrainAtomByRef.ts`

**implementation**:
- accept `{ atoms, ref }` input
- fail fast with `BadRequestError` if atoms array empty
- lookup by matching `repo` and `slug`
- fail with `BadRequestError` if not found, include ref in metadata

**test**: `src/domain.operations/context/findBrainAtomByRef.test.ts`
- verify successful lookup
- verify empty array error
- verify not-found error with ref metadata


### step.2.4: create findBrainReplByRef

**file**: `src/domain.operations/context/findBrainReplByRef.ts`

**implementation**:
- accept `{ repls, ref }` input
- fail fast with `BadRequestError` if repls array empty
- lookup by matching `repo` and `slug`
- fail with `BadRequestError` if not found, include ref in metadata

**test**: `src/domain.operations/context/findBrainReplByRef.test.ts`
- verify successful lookup
- verify empty array error
- verify not-found error with ref metadata


### step.2.5: create genContextRhachetBrain

**file**: `src/domain.operations/context/genContextRhachetBrain.ts`

**implementation**:
- accept `{ atoms?, repls? }` input
- default to empty arrays
- validate no duplicate `{ repo, slug }` within atoms
- validate no duplicate `{ repo, slug }` within repls
- throw `BadRequestError` on duplicate with identifier in metadata
- return context with `brain.atom.imagine` and `brain.repl.imagine`
- each imagine method: lookup brain by ref, delegate to `brain.imagine(input, {})`

**test**: `src/domain.operations/context/genContextRhachetBrain.test.ts`
- verify context creation with atoms and repls
- verify duplicate atom detection
- verify duplicate repl detection
- verify empty arrays handling
- verify imagine delegates correctly


---


## phase.3: sdk exports

### step.3.1: update sdk.ts

**file**: `src/contract/sdk.ts`

**implementation**:
- add domain object exports: `RhachetBrainAtom`, `RhachetBrainRepl`, `ContextRhachetBrain`
- add operation exports: `genContextRhachetBrain`, `castBriefsToPrompt`


---


## phase.4: plugin examples

### step.4.1: create rhachet-brain-anthropic package structure

**directory**: `src/_topublish/rhachet-brain-anthropic/`

**files**:
- `readme.md` - package documentation
- `src/atoms/brainAtomClaudeOpus.ts` - claude-opus-4.5 atom
- `src/repls/brainReplClaudeCode.ts` - claude-code repl
- `src/index.ts` - exports `getBrainAtomsByAnthropic`, `getBrainReplsByAnthropic`

**implementation notes**:
- atoms use `@anthropic-ai/sdk` for API calls
- repls use `@anthropic-ai/claude-code` SDK
- each uses `castBriefsToPrompt` to compose system prompt from briefs


### step.4.2: create rhachet-brain-openai package structure

**directory**: `src/_topublish/rhachet-brain-openai/`

**files**:
- `readme.md` - package documentation
- `src/atoms/brainAtomGpt4o.ts` - gpt-4o atom
- `src/repls/brainReplCodex.ts` - codex repl
- `src/index.ts` - exports `getBrainAtomsByOpenAI`, `getBrainReplsByOpenAI`

**implementation notes**:
- atoms use `openai` SDK for API calls
- repls use `@openai/codex` SDK
- each uses `castBriefsToPrompt` to compose system prompt from briefs


---


## phase.5: integration tests

### step.5.1: create integration test for full flow

**file**: `src/domain.operations/context/genContextRhachetBrain.integration.test.ts`

**implementation**:
- import plugin exports from _topublish packages
- call `genContextRhachetBrain` with combined atoms and repls
- test `context.brain.atom.imagine` with mock briefs
- test `context.brain.repl.imagine` with mock briefs
- verify end-to-end flow works


---


## execution order

```
phase.1: domain objects
  ├── step.1.1: RhachetBrainAtom
  ├── step.1.2: RhachetBrainRepl
  ├── step.1.3: ContextRhachetBrain
  └── step.1.4: export domain objects

phase.2: domain operations
  ├── step.2.1: castBriefsToPrompt
  ├── step.2.2: refactor bootRoleResources
  ├── step.2.3: findBrainAtomByRef
  ├── step.2.4: findBrainReplByRef
  └── step.2.5: genContextRhachetBrain

phase.3: sdk exports
  └── step.3.1: update sdk.ts

phase.4: plugin examples
  ├── step.4.1: rhachet-brain-anthropic
  └── step.4.2: rhachet-brain-openai

phase.5: integration tests
  └── step.5.1: full flow integration test
```


---


## dependencies

**existing packages** (already in repo):
- `domain-objects` - for DomainEntity, DomainLiteral, RefByUnique
- `helpful-errors` - for BadRequestError

**external dependencies** (for _topublish plugins):
- `@anthropic-ai/sdk` - anthropic API client
- `@anthropic-ai/claude-code` - claude-code SDK
- `openai` - openai API client
- `@openai/codex` - codex SDK

**note**: external dependencies are only for _topublish example packages, not the core SDK


---


## validation checklist

- [ ] `npm run test:types` passes
- [ ] `npm run test:lint` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run test:integration` passes
- [ ] sdk exports work correctly via `import { ... } from 'rhachet'`
- [ ] _topublish packages demonstrate complete plugin pattern

# roadmap: sdk brain context

## legend

- `[ ]` = pending
- `[~]` = in progress
- `[x]` = completed
- `[!]` = blocked


---


## phase.1: domain objects

### [ ] 1.1 create RhachetBrainAtom

**depends on**: none

**file**: `src/domain.objects/RhachetBrainAtom.ts`

**acceptance criteria**:
- given a plugin author imports RhachetBrainAtom
  - when they instantiate with `new RhachetBrainAtom({ repo, slug, description, imagine })`
  - then the instance is created successfully
  - then `getUniqueIdentifier` returns `{ repo, slug }`

- given a RhachetBrainAtom instance
  - when `.imagine(input, context)` is called
  - then input contains `{ role: { briefs? }, prompt, schema? }`
  - then plugin handles briefs directly (no systemPrompt preprocessing)

**verification**:
```sh
npm run test:types
npm run test:unit -- RhachetBrainAtom
```


### [ ] 1.2 create RhachetBrainRepl

**depends on**: none (parallel with 1.1)

**file**: `src/domain.objects/RhachetBrainRepl.ts`

**acceptance criteria**:
- given a plugin author imports RhachetBrainRepl
  - when they instantiate with `new RhachetBrainRepl({ repo, slug, description, imagine })`
  - then the instance is created successfully
  - then `getUniqueIdentifier` returns `{ repo, slug }`

- given a RhachetBrainRepl instance
  - when `.imagine(input, context)` is called
  - then input contains `{ role: { briefs? }, prompt, schema? }`
  - then plugin handles briefs directly (no systemPrompt preprocessing)

**verification**:
```sh
npm run test:types
npm run test:unit -- RhachetBrainRepl
```


### [ ] 1.3 create ContextRhachetBrain

**depends on**: 1.1, 1.2

**file**: `src/domain.objects/ContextRhachetBrain.ts`

**acceptance criteria**:
- given ContextRhachetBrain interface
  - when inspected
  - then exposes `brain.atom.imagine({ brain, role, prompt, schema })`
  - then exposes `brain.repl.imagine({ brain, role, prompt, schema })`
  - then `brain` parameter accepts `{ repo: string, slug: string }`

- given schema.output is a ZodSchema<T>
  - when imagine is called
  - then return type is inferred as T

**verification**:
```sh
npm run test:types
```


### [ ] 1.4 export domain objects from index

**depends on**: 1.1, 1.2, 1.3

**file**: `src/domain.objects/index.ts`

**acceptance criteria**:
- given `src/domain.objects/index.ts`
  - when inspected
  - then exports `RhachetBrainAtom`
  - then exports `RhachetBrainRepl`
  - then exports `ContextRhachetBrain`

**verification**:
```sh
npm run test:types
```


---


## phase.2: domain operations

### [ ] 2.1 create castBriefsToPrompt

**depends on**: none

**file**: `src/domain.operations/briefs/castBriefsToPrompt.ts`

**acceptance criteria**:
- given an array of brief artifacts
  - when `castBriefsToPrompt({ briefs })` is called
  - then returns concatenated content with `\n\n` separator

- given an empty briefs array
  - when `castBriefsToPrompt({ briefs: [] })` is called
  - then returns empty string

- given briefs with some falsy content
  - when `castBriefsToPrompt` is called
  - then falsy content is filtered out

**verification**:
```sh
npm run test:unit -- castBriefsToPrompt
```


### [ ] 2.2 refactor bootRoleResources to use castBriefsToPrompt

**depends on**: 2.1

**file**: `src/domain.operations/invoke/bootRoleResources.ts`

**acceptance criteria**:
- given bootRoleResources implementation
  - when inspected
  - then imports and uses `castBriefsToPrompt`
  - then no duplicate briefs-to-text logic exists

- given existing bootRoleResources tests
  - when run
  - then all pass without modification

**verification**:
```sh
npm run test:integration -- invokeRolesBoot
```


### [ ] 2.3 create findBrainAtomByRef

**depends on**: 1.1

**file**: `src/domain.operations/context/findBrainAtomByRef.ts`

**acceptance criteria**:
- given atoms array contains matching atom
  - when `findBrainAtomByRef({ atoms, ref: { repo, slug } })` is called
  - then returns the matching atom

- given atoms array is empty
  - when `findBrainAtomByRef` is called
  - then throws `BadRequestError` with message "no atoms available in context"
  - then error metadata includes `ref`

- given atoms array does not contain matching atom
  - when `findBrainAtomByRef` is called
  - then throws `BadRequestError` with message "brain atom not found"
  - then error metadata includes `ref`

**verification**:
```sh
npm run test:unit -- findBrainAtomByRef
```


### [ ] 2.4 create findBrainReplByRef

**depends on**: 1.2

**file**: `src/domain.operations/context/findBrainReplByRef.ts`

**acceptance criteria**:
- given repls array contains matching repl
  - when `findBrainReplByRef({ repls, ref: { repo, slug } })` is called
  - then returns the matching repl

- given repls array is empty
  - when `findBrainReplByRef` is called
  - then throws `BadRequestError` with message "no repls available in context"
  - then error metadata includes `ref`

- given repls array does not contain matching repl
  - when `findBrainReplByRef` is called
  - then throws `BadRequestError` with message "brain repl not found"
  - then error metadata includes `ref`

**verification**:
```sh
npm run test:unit -- findBrainReplByRef
```


### [ ] 2.5 create genContextRhachetBrain

**depends on**: 1.3, 2.3, 2.4

**file**: `src/domain.operations/context/genContextRhachetBrain.ts`

**acceptance criteria**:
- given valid atoms and repls arrays
  - when `genContextRhachetBrain({ atoms, repls })` is called
  - then returns ContextRhachetBrain instance
  - then `context.brain.atom.imagine` is callable
  - then `context.brain.repl.imagine` is callable

- given atoms with duplicate `{ repo, slug }`
  - when `genContextRhachetBrain` is called
  - then throws `BadRequestError` with message "duplicate atom identifier"
  - then error metadata includes `duplicateAtom`

- given repls with duplicate `{ repo, slug }`
  - when `genContextRhachetBrain` is called
  - then throws `BadRequestError` with message "duplicate repl identifier"
  - then error metadata includes `duplicateRepl`

- given atoms is undefined
  - when `genContextRhachetBrain({ repls })` is called
  - then context is created successfully
  - then `brain.atom.imagine` throws "no atoms available" on call

- given repls is undefined
  - when `genContextRhachetBrain({ atoms })` is called
  - then context is created successfully
  - then `brain.repl.imagine` throws "no repls available" on call

- given `context.brain.atom.imagine` is called
  - when brain ref matches registered atom
  - then delegates to `atom.imagine(input, {})`
  - then briefs are passed through to atom (not preprocessed)

- given `context.brain.repl.imagine` is called
  - when brain ref matches registered repl
  - then delegates to `repl.imagine(input, {})`
  - then briefs are passed through to repl (not preprocessed)

**verification**:
```sh
npm run test:unit -- genContextRhachetBrain
```


---


## phase.3: sdk exports

### [ ] 3.1 update sdk.ts with brain exports

**depends on**: 1.4, 2.1, 2.5

**file**: `src/contract/sdk.ts`

**acceptance criteria**:
- given `src/contract/sdk.ts`
  - when inspected
  - then exports `RhachetBrainAtom`
  - then exports `RhachetBrainRepl`
  - then exports `ContextRhachetBrain`
  - then exports `genContextRhachetBrain`
  - then exports `castBriefsToPrompt`

- given consumer imports from 'rhachet'
  - when `import { RhachetBrainAtom, genContextRhachetBrain } from 'rhachet'`
  - then imports resolve correctly

**verification**:
```sh
npm run test:types
npm run build
```


---


## phase.4: plugin examples

### [ ] 4.1 create rhachet-brain-anthropic plugin

**depends on**: 3.1

**directory**: `src/_topublish/rhachet-brain-anthropic/`

**acceptance criteria**:
- given rhachet-brain-anthropic package
  - when inspected
  - then contains `readme.md`
  - then contains `src/atoms/brainAtomClaudeOpus.ts`
  - then contains `src/repls/brainReplClaudeCode.ts`
  - then contains `src/index.ts`

- given brainAtomClaudeOpus
  - when instantiated
  - then `repo` is "anthropic"
  - then `slug` is "claude-opus-4.5"
  - then `imagine` uses `castBriefsToPrompt` to compose system prompt

- given brainReplClaudeCode
  - when instantiated
  - then `repo` is "anthropic"
  - then `slug` is "claude-code"
  - then `imagine` uses `castBriefsToPrompt` to compose system prompt

- given `src/index.ts`
  - when inspected
  - then exports `getBrainAtomsByAnthropic(): RhachetBrainAtom[]`
  - then exports `getBrainReplsByAnthropic(): RhachetBrainRepl[]`

**verification**:
```sh
npm run test:types
```


### [ ] 4.2 create rhachet-brain-openai plugin

**depends on**: 3.1

**directory**: `src/_topublish/rhachet-brain-openai/`

**acceptance criteria**:
- given rhachet-brain-openai package
  - when inspected
  - then contains `readme.md`
  - then contains `src/atoms/brainAtomGpt4o.ts`
  - then contains `src/repls/brainReplCodex.ts`
  - then contains `src/index.ts`

- given brainAtomGpt4o
  - when instantiated
  - then `repo` is "openai"
  - then `slug` is "gpt-4o"
  - then `imagine` uses `castBriefsToPrompt` to compose system prompt

- given brainReplCodex
  - when instantiated
  - then `repo` is "openai"
  - then `slug` is "codex"
  - then `imagine` uses `castBriefsToPrompt` to compose system prompt

- given `src/index.ts`
  - when inspected
  - then exports `getBrainAtomsByOpenAI(): RhachetBrainAtom[]`
  - then exports `getBrainReplsByOpenAI(): RhachetBrainRepl[]`

**verification**:
```sh
npm run test:types
```


---


## phase.5: integration tests

### [ ] 5.1 create full flow integration test

**depends on**: 4.1, 4.2

**file**: `src/domain.operations/context/genContextRhachetBrain.integration.test.ts`

**acceptance criteria**:
- given integration test imports both plugin packages
  - when `genContextRhachetBrain` is called with combined atoms and repls
  - then context is created successfully

- given context created from both plugins
  - when `context.brain.atom.imagine({ brain: { repo: 'anthropic', slug: 'claude-opus-4.5' }, ... })` is called
  - then anthropic atom's imagine is invoked

- given context created from both plugins
  - when `context.brain.repl.imagine({ brain: { repo: 'openai', slug: 'codex' }, ... })` is called
  - then openai repl's imagine is invoked

- given role.briefs is provided
  - when imagine is called
  - then briefs are passed to plugin's imagine method

**verification**:
```sh
npm run test:integration -- genContextRhachetBrain.integration
```


---


## phase.6: final validation

### [ ] 6.1 run full test suite

**depends on**: 5.1

**acceptance criteria**:
- given all implementation is complete
  - when `npm run test:types` is run
  - then passes with no errors

- given all implementation is complete
  - when `npm run test:lint` is run
  - then passes with no errors

- given all implementation is complete
  - when `npm run test:unit` is run
  - then passes with no errors

- given all implementation is complete
  - when `npm run test:integration` is run
  - then passes with no errors

**verification**:
```sh
npm run test:types && npm run test:lint && npm run test:unit && npm run test:integration
```


### [ ] 6.2 verify sdk exports work end-to-end

**depends on**: 6.1

**acceptance criteria**:
- given sdk is built
  - when consumer writes:
    ```typescript
    import {
      RhachetBrainAtom,
      RhachetBrainRepl,
      genContextRhachetBrain,
      castBriefsToPrompt,
    } from 'rhachet';
    ```
  - then all imports resolve correctly
  - then types are available

**verification**:
```sh
npm run build
# manual verification: create test consumer file and verify imports
```


---


## dependency graph

```
phase.1 (domain objects)
  1.1 RhachetBrainAtom ─────────────────────┐
  1.2 RhachetBrainRepl ─────────────────────┼──► 1.3 ContextRhachetBrain ──► 1.4 export index
                                            │
phase.2 (domain operations)                 │
  2.1 castBriefsToPrompt ──► 2.2 refactor bootRoleResources
                            │
  2.3 findBrainAtomByRef ◄──┴── 1.1        │
  2.4 findBrainReplByRef ◄───── 1.2        │
                                           │
  2.5 genContextRhachetBrain ◄─────────────┴── 1.3, 2.3, 2.4
                            │
phase.3 (sdk exports)       │
  3.1 update sdk.ts ◄───────┴── 1.4, 2.1, 2.5
                            │
phase.4 (plugin examples)   │
  4.1 anthropic plugin ◄────┴── 3.1
  4.2 openai plugin ◄───────┴── 3.1
                            │
phase.5 (integration)       │
  5.1 full flow test ◄──────┴── 4.1, 4.2
                            │
phase.6 (validation)        │
  6.1 full test suite ◄─────┴── 5.1
  6.2 verify exports ◄────────── 6.1
```


---


## parallelization opportunities

the following can be executed in parallel:

**parallel set 1** (no dependencies):
- 1.1 RhachetBrainAtom
- 1.2 RhachetBrainRepl
- 2.1 castBriefsToPrompt

**parallel set 2** (after set 1):
- 1.3 ContextRhachetBrain (after 1.1, 1.2)
- 2.2 refactor bootRoleResources (after 2.1)
- 2.3 findBrainAtomByRef (after 1.1)
- 2.4 findBrainReplByRef (after 1.2)

**parallel set 3** (after sdk exports):
- 4.1 anthropic plugin
- 4.2 openai plugin

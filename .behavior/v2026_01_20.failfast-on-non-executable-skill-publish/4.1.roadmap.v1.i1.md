# roadmap: fail fast on non-executable skills publish

## overview

ordered checklist to implement executability validation for `npx rhachet repo introspect`.

each step has:
- **depends on**: prior steps that must be complete
- **acceptance**: behavioral criteria that prove step completion
- **verify**: command or assertion to confirm acceptance

---

## phase 1: core logic

### step 1.1: create `findNonExecutableShellSkills.ts`

**depends on**: none

**file**: `src/domain.operations/manifest/findNonExecutableShellSkills.ts`

**acceptance**:
- [ ] exports `findNonExecutableShellSkills({ registry: RoleRegistry }): string[]`
- [ ] returns empty array when registry has no roles
- [ ] returns empty array when skills dirs contain only non-.sh files
- [ ] returns empty array when all .sh files are executable
- [ ] returns array of paths when .sh files lack execute permission
- [ ] handles `skills.dirs` as single object `{ uri }`
- [ ] handles `skills.dirs` as array `{ uri }[]`

**verify**:
```sh
npm run test:types
```

---

### step 1.2: unit tests for `findNonExecutableShellSkills`

**depends on**: step 1.1

**file**: `src/domain.operations/manifest/findNonExecutableShellSkills.test.ts`

**acceptance**:
- [ ] [case1] registry with no roles → returns `[]`
- [ ] [case2] role with empty skills.dirs → returns `[]`
- [ ] [case3] skills dir with only .ts/.md files → returns `[]`
- [ ] [case4] skills dir with executable .sh files → returns `[]`
- [ ] [case5] skills dir with one non-executable .sh → returns `[path]`
- [ ] [case6] mixed executable/non-executable → returns only non-executable paths
- [ ] [case7] multiple roles, one with non-executable → returns that path
- [ ] [case8] skills.dirs as single object → handles correctly
- [ ] [case9] skills.dirs as array → handles correctly

**verify**:
```sh
npm run test:unit -- findNonExecutableShellSkills.test.ts
```

---

### step 1.3: create `assertRegistrySkillsExecutable.ts`

**depends on**: step 1.1

**file**: `src/domain.operations/manifest/assertRegistrySkillsExecutable.ts`

**acceptance**:
- [ ] exports `assertRegistrySkillsExecutable({ registry: RoleRegistry }): void`
- [ ] completes without error when all skills are executable
- [ ] throws `BadRequestError` when non-executable skills found
- [ ] error message lists all non-executable paths
- [ ] error metadata includes `nonExecutablePaths` array

**verify**:
```sh
npm run test:types
```

---

### step 1.4: unit tests for `assertRegistrySkillsExecutable`

**depends on**: step 1.3

**file**: `src/domain.operations/manifest/assertRegistrySkillsExecutable.test.ts`

**acceptance**:
- [ ] [case1] registry with all executable skills → no error
- [ ] [case2] registry with one non-executable → BadRequestError with path in message
- [ ] [case3] registry with multiple non-executable → BadRequestError with all paths

**verify**:
```sh
npm run test:unit -- assertRegistrySkillsExecutable.test.ts
```

---

## phase 2: integration

### step 2.1: integrate validation into `invokeRepoIntrospect.ts`

**depends on**: step 1.3

**file**: `src/contract/cli/invokeRepoIntrospect.ts`

**acceptance**:
- [ ] imports `assertRegistrySkillsExecutable`
- [ ] calls `assertRegistrySkillsExecutable({ registry })` after `getRoleRegistry()`
- [ ] call placed before `castIntoRoleRegistryManifest()`
- [ ] no changes to prior success behavior

**verify**:
```sh
npm run test:types
```

---

### step 2.2: integration tests for executability validation

**depends on**: step 2.1, step 1.2, step 1.4

**file**: `src/contract/cli/invokeRepoIntrospect.integration.test.ts`

**acceptance**:
- [ ] [tN] skills dir with executable .sh → command succeeds, yml generated
- [ ] [tN+1] skills dir with non-executable .sh → command fails, error contains path
- [ ] [tN+2] multiple non-executable .sh → error lists ALL paths
- [ ] [tN+3] skills dir with only .ts/.md → command succeeds
- [ ] [tN+4] role with no skills dir → command succeeds
- [ ] prior test cases still pass (no regression)

**verify**:
```sh
npm run test:integration -- invokeRepoIntrospect.integration.test.ts
```

---

## phase 3: acceptance

### step 3.1: acceptance tests for blackbox criteria

**depends on**: step 2.2

**file**: `src/accept.blackbox/cli/repo.introspect.executability.acceptance.test.ts`

**acceptance**:
- [ ] usecase.1: valid package with executable skills → exit 0, yml generated
- [ ] usecase.2: package with non-executable skill → exit non-zero, path in stderr
- [ ] usecase.3: multiple non-executable → all paths in stderr
- [ ] boundary.1: no skills dirs → exit 0
- [ ] boundary.2: non-.sh files only → exit 0
- [ ] boundary.3: mixed valid/invalid → exit non-zero, only invalid paths in error

**verify**:
```sh
npm run test:acceptance -- repo.introspect.executability.acceptance.test.ts
```

---

## phase 4: validation

### step 4.1: full test suite pass

**depends on**: step 3.1

**acceptance**:
- [ ] `npm run test:types` passes
- [ ] `npm run test:lint` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run test:integration` passes
- [ ] `npm run test:acceptance` passes

**verify**:
```sh
npm run test:types && npm run test:lint && npm run test:unit && npm run test:integration && npm run test:acceptance
```

---

### step 4.2: manual validation

**depends on**: step 4.1

**acceptance**:
- [ ] run `npx rhachet repo introspect` in a real `rhachet-roles-*` package with valid skills → succeeds
- [ ] create a non-executable .sh skill, run command → fails with clear error
- [ ] error message includes fix hint (`chmod +x`)

**verify**: manual

---

## dependency graph

```
step 1.1 ─────────┬──────► step 1.2
                  │
                  └──────► step 1.3 ────► step 1.4
                                │
                                ▼
                           step 2.1 ────► step 2.2 ────► step 3.1 ────► step 4.1 ────► step 4.2
```

---

## blackbox criteria traceability

| criteria | verified by |
|----------|-------------|
| usecase.1 | step 3.1, step 4.2 |
| usecase.2 | step 3.1 |
| usecase.3 | step 3.1 |
| boundary.1 | step 3.1 |
| boundary.2 | step 3.1 |
| boundary.3 | step 3.1 |

---

## completion checklist

- [ ] phase 1 complete (core logic)
- [ ] phase 2 complete (integration)
- [ ] phase 3 complete (acceptance)
- [ ] phase 4 complete (validation)
- [ ] all blackbox criteria verified
- [ ] ready for code review
